webpackJsonp([0xe84bedced712],{1236:function(n,a){n.exports={data:{file:{childImageSharp:{sizes:{base64:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAACXBIWXMAAAsSAAALEgHS3X78AAAHlElEQVRIx12We2xT5xXAbcI2Vmn7o1I1uhVYRxL8tuPn9bXv0+/4/YgdOyYkkATCCEEYsqVNC2wCIYQWShmUBFh4hMAWECot0BUtlI4yAS1oKqJQXimsDBgTU8codnLO7r0uUPpJn87Rp+/8vvOdc75zr8xmZmTieI1NykU5yxOfxDncz3NUjAlyDXMjXGMhys+cG+FzGQ8VU4t7XuV8z8m+GUkrJclSqVReYJ0ZWQ8Tl2AdTPhnq9ns2QKd+crDZiHha8NsYCE21HZiXphpb3sxxTf99Tdsw51ldHqFaLOXXyzvYqOyZ0YPk5soylfouuUbvHOxh56JbiqJfi4/FnE1lxKetrGUZ954nbcdU/752ORpxWVsc6mZjPxctFtApeVtra1lmIPwTxClgeCqvGTsX/WWOEbtyTGWSoGbToOPzUHQ1QghVxOEhRniZ5U8XB4TzvTdgj1ZJdq2OOrkGhVRBnrYFum6TiK0l2fr0emMlVxcBhlnEniqDjlBuqg0CnD0MPWiDrwzhR4u+5B3x3WiLUNHJjxzZYvR8ZKTCP+Xo1JoM/nBYvSB1egHuyUIrCOBPj4LtD0KlD2K4h7SGip62aygxzaK9rHA3Aqt2vw0MRYjnyJtYaQdsXG9hgWFwgmVlXZUKUjUqmm0CgfwhA80Kgr1Wg40Sue4SuFEnZq+YjMbJ0kh0zmfemjQ0j2EJYh2a23RVOODIBvHmCsBUaoWLDoWKIsP50bTApxC5QwH1Ghp0Gk4MBk8aDLQEslooCc88VClsK+zGANI2mqLer0XFuea8PSuN+DM7o3QWyhAR7IBfj+vDbyOICS9aSjkZo8nvSlUKuxXLDUOKdN6LSl/AlRUE+vNAnD50l8XeTIEPiYEzXYG5mlNeGz7BvjPpY/g5snDcHxwE+zs7oCh1zvHCrNm48u/ML8j2muVQblBZ3t6ZY2KXKtQcDiwdk1xx9rV0BlqghEuD4fNUTy1Zwhw7Cbioxu461fdsOgFDa5pbh3zu6NifE9f+XCPlGHS5nuaFI3K8brJ4EUHES4WFiyEP2/dCPc2vYH/3NIHePcywP1LWLp3Ec4tWQa3FvbAu7294yqVA801rju5utYfiQyKDD4DnC8GWEhMafJPtBALxuHjo3+C8bufIn59DfHBFcDiDcQvzyF+/iEsbWuDadNMaDW5H7nY6Iyyh165zfLNtdUqIqLTsEJSQqBVUTD1JQPqdRT8sf9NuH7kMHy0fRg+O3EUzp96H/Zs2SBklxFKxwFmowtdTCIoPQx7oKLzl32PPTRPVSudDwQgCrUGL0+twdzsDjjSdwD2J1fh/q7N0N+1EtykB178qVY4lAahRktWkw95JrG4DAxPvHU3Wwb+rlcsHfK0WNxCoMdUCgdUaxnMBPKw7dVe2LyhDw4MboORA4NQOd2CaiUFaqWjZJGAyQGRUeubP8FqElqZspquEBeUM2zrnEQUa3R8USVcp2qGDZV6ErqXL4PfrlwFhSU9cPL4MejfshOsZq90sCg5KvHZ5MnPfa+cmFrxukRFuRZNcYqIoNngHheeFmiF11ClIDBdPwfqG9qhc1E3rF25GnrX90M204JqBfWItPrP8lTqa7vFpSw3GJ9cZjI4pW5TXaWezpKxh4Q5gEY9LwApVOtZMApxVWhd2DKvC7K5FjTUsFCj45Ah4yXaHuz1MBlgyHCb1HXISIXMTcekOJqN1h/72Mx92h5DwuwHjeChWseBQsNgJJ6H944eB5oNgaLajnaL/07E24wuKr7Cz+XuuenUsMioCxYmyHhnSPLQTYVVYVfjI46Mo80WBLMgLY4E1FhCOENBAsfHQG/0juuNPqGguU8ywXas5XNbg6783wJ8w781GtUPJc+irkap/Ufdje0JXytStnDJbA2D1Z4EKxEHsyUMRmsIdcZaNFpCYBYqwWQLPhD3Btn6t2Pe5uF0cD7Sdr/xmSab8racFaDooOvuk0wDEs40EFQGbVQGbEKXJoTPgZ3JoJGIgULvR6M1jE67rzvpae5ojC7GEJ9rfgILc7lC3NV0T6flTtjoPLK+VuD8rcD65gDtaQInPxOtzoxQRrXgD8/BdW/+YezYByfxvfdHvnxl+ZLKCDfzUMIze60Ey+brJukrqcjA1u3tBw8dfZiZuRQFaNFory/WEPUlE5kFK5WDQKRtbFPfUOnChUvFL27cwKuj/8CBHXv2iQw/k/KGuNwyCYiIkhw+sO/569eu7b1+ffR/H5z4BAcG38X1m/biyjX9ODR8GC9dHsXLV0fx5KlzePDIyFd7ht9ZJZhJrcvLhV/wMuUPljQWtC6Z+FjfuWPHlPMXLq64Onpz3d8/Pf9WX//OW2vWbITBof3n3tqya9fbh/7SvW1gZ9Xj/V1dr8kf614qIZONjBwrezi8Ty54K5d9ZzTmF+xe1LnioaD+4Nvrn4/ermif3yHp8UCDLMCky7Z+n192+/YdST9z5mPZ7t1D8ouXv6gQ4S9WTplks7mut8xZijxbKz2vvi2D39/cPyB/HC5xOm2czPvd35F8rkGCS0+I4WXV1QbJaMq06XqbNXCQJIILpH8hOic3GghZMpl62qG/Nf4PRzaQ862MzO4AAAAASUVORK5CYII=",aspectRatio:.6666666666666666,src:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-25c91.png",srcSet:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-8a97b.png 200w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-0fdf3.png 400w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-25c91.png 600w",srcWebp:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-216f6.webp",srcSetWebp:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-5d70e.webp 200w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-d1677.webp 400w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-216f6.webp 600w",sizes:"(max-width: 600px) 100vw, 600px"}}},site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}},mainPost:{html:'<h1 id="分布式系统、单体系统区别"><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E3%80%81%E5%8D%95%E4%BD%93%E7%B3%BB%E7%BB%9F%E5%8C%BA%E5%88%AB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分布式系统、单体系统区别</h1>\n<p>分布式系统是对单体系统的一种改进，但这种改进同样也带来了复杂度和实现难度。</p>\n<h2 id="背景"><a href="#%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景</h2>\n<p>单体系统是包含一个物理组件的系统，能够独立进行部署和运行。可以看到在单体系统内部可以采用分层的方式合理组织代码结构，但从物理上看就是一个能够独立运行的应用程序。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-11-17-35-01-308c2c05327bb9cd29e81867ac87924c-6de41.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 327px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 118.65443425076452%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAAAsSAAALEgHS3X78AAAEmUlEQVQ4y3VVW1NaVxTmH/WhmUnVxFZF21jtj2hfOtMm5qUvferkpZNpp5k0o2JiFBC5Q7gq14gRFBA4gAQVRUhQ4yVj8BILcvm6zj4ErE73zDdrr7XX/vZae62zjyjORaHTjsBuew6rZbwJm3UcM/YJsrfA6zxs13yfw2iQwO+fg0irHQXwmrBOWLuENKqVKFDnaJ4gcIJe4/WVK/7rzN/tmoSIj4w3lP4Jk4w3kETpPIQ571NEwtPwz0+Ai6qxHFLC45Zgu+BqBCH4Vy4ibE8yYYbIankmnFJP4OD9Enb3Fgh+7BCyuZfYyHqR2fRiLeNGPGlFImUn3YO9/QDe7fvJN4BqNc6ijkWNEJnNT0nJg4soYBnpx7z0W/gIfnk/AooBhsXpASwpB0l+xxBQDDIfn3QATkkv5mYesixjEQMRmiSkbMOqf4BjdxtlcgeVgBj7ji4UvV0484lx4OjBtrULHzzdZOvGobMLF34xXe3XdLVfwTzxPXGsIh67RGgzPECREX6DI08X5iXtmBu9DdtfHUx6ntzCqqoTaU0nElOdRNxD10eE0S9haRI2U84htjwFwyMx3GM9cI2J4RgVpEsihvVJN0yPuzAzIsYs2W3DYjZ3jfXC8rgTXuvvjZSNraLUawmcnkVxfBJhODkV5MdzDoVtH1KvrSiVE8x2eiqs8yiSXqslWkURCNep9FHWa/8B68EkTk+omttOof/qsWt+tWrsOmGtEmPNyd/FVWQ3ZykdLc1TjUa+6pNgB3OXCculCJKcGrHgJLiwjCEalCIdV2Ja9hse/TGEFW4asZC0uS74yHD8IcAaXehD0xgpb/DqpQS+0c+RNbZhVduGtPoLrOuE+RrJTWMH1rTtVOW2JjYMHYhMfAab5lfi2KAs9J8IC5gxP8T5ArVCehDV4B0i78SKuhcxRS9ylj5smggv+pAz99FBvSgt9tMNDFLbUEdo7rOr4FoREqHlT+T0N4AQNfPcbXCym4hM3kRK2Yb8C4pO044timjL2E62dhy5bgFBan7HDZinhogjI7SNzcrf4Rbe7XhhV/0Ch/JnOFV34dHcg5vg0Q7BJv8RxvEf4NXfh1N9Fy6CQ3WPzc2yn7CW0rI6JOP0OGg1ElyUgo0KUz8yKVRbmGdwVAwhl/ewea25nm7uYbK2DD44US6Xg8k0RQ/oNOxWBckpWuAhh80ix+yMEnrtM8ikf8Mxq6IHVd5Y58H7K0hOw2xWIJVKQkT0qNeBcrnKUKnUcXXs7u4hk9m4Zq/VWvuqVcEmqvFWtEhKpTK2snnkcm+xtZVHobALnc6I4WEJ8vkC2d+wtWw2h2LxpLGr3jigBlGdwuPBj3LpAna7BkuLKgSXtAiHdIhzJiwGVJifl4OLmRAK6pprZtMEDg7eC5QNHtEnhR87O/vwemSsSfmL5r/hzYwFh/s+vM07sbvjwcezpcbzv4HUihEcF29Gx1K+SujxyBuVSxGBG87ZEYSDSiy8kmIloUPhjbPxTa+SzhMm/p+wXK7Qb1JLKWmwHDYSkZ5S1MO/oKa0KU2yhUIG+lkZEKXn3mKexOFhK2V+/Ave+kePoR8JzQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 11 17 35 01" title="" data-src="/static/2024-10-11-17-35-01-308c2c05327bb9cd29e81867ac87924c-6de41.png" data-srcset="/static/2024-10-11-17-35-01-308c2c05327bb9cd29e81867ac87924c-e9163.png 200w,\n/static/2024-10-11-17-35-01-308c2c05327bb9cd29e81867ac87924c-6de41.png 327w" data-sizes="(max-width: 327px) 100vw, 327px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>存在以下情况不能应对：</p>\n<ol>\n<li>业务复杂度和产品迭代速度</li>\n<li>处理高并发、大数据量的用户请求</li>\n<li>代码维护和团队协作</li>\n</ol>\n<p>但是分布式系统引入了新问题</p>\n<ol>\n<li>网络传输的三态性</li>\n<li>数据的一致性</li>\n<li>可用性</li>\n</ol>\n<h2 id="技术体系"><a href="#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术体系</h2>\n<h3 id="单体系统的核心问题"><a href="#%E5%8D%95%E4%BD%93%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%A0%B8%E5%BF%83%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>单体系统的核心问题</h3>\n<p>单体系统的核心问题表现在三个方面</p>\n<ol>\n<li>\n<p>业务扩展性：任何业务的调整都需要发布整个系统，改一个地方就要重新构建、发布整个系统</p>\n</li>\n<li>\n<p>性能伸缩性：动态扩容对单体系统而言效率低下，如果通过简单扩容就能确保系统性能得到等比例提升，那么该系统就具备良好的伸缩性。对于单体系统来说，由于不同功能都在里面，即内存密集型和 CPU 密集型的代码都位于同一个服务器上，所以很难做到对资源的充分利用，如下图每个组件对资源利用率不同，无法针对组件级别进行资源利用率的提升</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-11-18-18-37-f7a87490d3be769cfd38e4fac0f7d51d-e2a73.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 728px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 36.26373626373626%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABvUlEQVQoz1WQW28SURRG59eY1MaW+KhV0wexP8OKiWnS+DvUpj5pqsYHExMuVgRrAy0QbEFa5sLMFGa4FAWKlUKVoGCjJuLyDDQxPqzsnX3W/rJzpJ1MmKK9hlUQWGvY1rjP7vqRd32osh9F9qFkfWjKeOa8FfL/XAfbeoOqvEJywqAiKJxSofclgRWc4yByjcKqGzvopijIea/SiMxRCrlpN8PCrQryAusUA8lJHwUN9THYHDXXOVy/Qjc+S957kWJghlrokuhn+BybpR29TKPiFW5Z7ORGQfwx+PVTRXJOHYqQ3jeN/vcc/ROdXl/DNF+iqV4MI0C1vDrC0H3kNDHTA3R7MgPhDsTOV+Gf/DAY/taRVPkFpeRtqvF5SpseKjFB3MP75AKHmUX24zfptjc4bkWoJT0cpBaovb0l/BuUN65TjM7TSIqaWOS4s4WU3n5GI3yBT6EpUg8msJ9PUfGdI/t4gmbQRSt4hg+Fp5SNJ/Sjk+z7p9lZOUs14BKei8yjSQax83wUX9SoR5E07TVF9SHm9h3M1D320v+jb92l00rQOUpipJbYe7eMKXBqPuNwHzO9hKWsUK/H+Qs93MOtqV1clwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 11 18 18 37" title="" data-src="/static/2024-10-11-18-18-37-f7a87490d3be769cfd38e4fac0f7d51d-e2a73.png" data-srcset="/static/2024-10-11-18-18-37-f7a87490d3be769cfd38e4fac0f7d51d-314ef.png 200w,\n/static/2024-10-11-18-18-37-f7a87490d3be769cfd38e4fac0f7d51d-704a2.png 400w,\n/static/2024-10-11-18-18-37-f7a87490d3be769cfd38e4fac0f7d51d-e2a73.png 728w" data-sizes="(max-width: 728px) 100vw, 728px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n</li>\n<li>\n<p>代码复杂度：修改一处代码容易引发连锁问题，不同组件间边界模糊，由于代码复杂度导致的系统缺陷会触发很多连锁问题</p>\n</li>\n</ol>\n<h3 id="分布式系统的本质特性"><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%9C%AC%E8%B4%A8%E7%89%B9%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分布式系统的本质特性</h3>\n<p>区别于单体系统，分布式系统会将整个系统拆分成多个能够独立运行的服务，这些服务在物理上是隔离的，相互之间基于网络进行通信和协调</p>\n<p>下图展示的就是现实场景中常见的一种分布式系统，可以看到这里有专门针对业务处理的业务服务 1 和业务服务 2 这两个独立的服务，也存在 Web 服务、消息中间件、缓存等提供技术能力的独立组件</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-11-18-24-39-aff9373768249719f1a557ca321d560f-8b86b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 725px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 45.37931034482759%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABi0lEQVQoz41RC0+CUBTm//+OHqbm2iq3amvL1pYpgihqggKiwMU0DS1R8etwLbPnOtu3C5zLOd9DwB9lGBVUlBTEwgGkUgrVShKmUea91SoirL5BYMyF53bBvB48rwunZ9PpIQimMM0GdP0aknROA8+gazkwZr4NXA/4WkJZTkNrZlAq7qJ5T6d4AMdx+OXFYonZbIHJ5BkPg0f+vFxGm4FRRCwJ0RYEp6fD7tRJTh6WqcJ1W9+2zudLzvg/Jdh2jSTWoSg5YqYifg+CgDcZ69ISkZZdoSxfomOJcB2DmKwwHo/RbknodCQY7SLdK8GyJAhKOUMMsyR1nxrHkKU0eWcitkdrijwIRU5SP4G6mkSjcYvp9AWa1kSxkEJNTeEuv0MLk2jpJxCGgwHiYHyf8XM4HGzoh2HIvzHmcei6jtHoadO37R6xMtHv+7zf930IP/nwW4KWVUXhLksKREr9ArXaDQ/uk4frn6MtfAx7TzKuOJRq5ZR8O4Jc2iOJCTTqhyRT5Z6G4YzCm+MV8O2g5XJOxs0AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 11 18 24 39" title="" data-src="/static/2024-10-11-18-24-39-aff9373768249719f1a557ca321d560f-8b86b.png" data-srcset="/static/2024-10-11-18-24-39-aff9373768249719f1a557ca321d560f-b07e9.png 200w,\n/static/2024-10-11-18-24-39-aff9373768249719f1a557ca321d560f-4ec81.png 400w,\n/static/2024-10-11-18-24-39-aff9373768249719f1a557ca321d560f-8b86b.png 725w" data-sizes="(max-width: 725px) 100vw, 725px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>想要实现分布式系统，首要的就是完成对系统中各个服务的合理拆分。通常，我们有两种主流的拆分方式，即纵向（Vertical）拆分和横向（Horizontal）拆分</p>\n<p>可以认为纵向拆分的目的就是更好地完成对系统中业务服务的合理组织。围绕一个完整而复杂的业务执行流程，我们通常可以根据不同的业务场景以及数据属性来完成对业务服务的拆分。例如，在常见的互联网医院系统中，具备最基本的医生、患者以及问诊等业务处理场景和数据，这时候我们就可以基于这些场景和数据来分别提取独立的业务服务，如下图所示</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-11-18-25-54-c04abd93b5815f873f8680f59fb2e668-3be6a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 726px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 30.165289256198346%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABLklEQVQY03VR207CQBTs//+CichDBTUi8UFQWhULVEuhtIBIBVqWkiA16QP0EoKMp/tACAknOdnNzM6cywo4iN1ux884TtDrVjBjEiyzCL15g3brFmbnDsytwDAesN3+7TWHKRwDaURRAntY5YZN7RpqI4d3NY8PNYep+4TPvsQNj7XcECfC93/BGCPziDqOEQQBkiTmWMqdCiHtZr0OSRjznM3mWCx+uEnaxWazhefN4ThTfk+xtMhy6ZO5t9eFYYTVKoRgmSVMxjIG/TKNUoLRLtDDIa82Hus0+iM6xj3tsQDXeca3rXGOMZt2WsTXgFbQKxMuUcoQ6jURuiaiplzgrZqB0brEZNLlon7vlfaXQV3JEndOHyPCsmTOjUYWTCMPhTQv8hka9Sw1c4V/9023bH6hwIkAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 11 18 25 54" title="" data-src="/static/2024-10-11-18-25-54-c04abd93b5815f873f8680f59fb2e668-3be6a.png" data-srcset="/static/2024-10-11-18-25-54-c04abd93b5815f873f8680f59fb2e668-0aa07.png 200w,\n/static/2024-10-11-18-25-54-c04abd93b5815f873f8680f59fb2e668-92365.png 400w,\n/static/2024-10-11-18-25-54-c04abd93b5815f873f8680f59fb2e668-3be6a.png 726w" data-sizes="(max-width: 726px) 100vw, 726px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>介绍完纵向拆分，我们再来看横向拆分。横向拆分的切入点在于复用，即我们在提取一系列独立服务的同时，还需要考虑通过一定的手段将它们高效地整合在一起。这样，整个系统就可以像是在搭积木一样对各个服务进行排列组合，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-11-18-27-12-1f59184611e036f2b4331e2dbfbb01b3-683dc.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 723px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 43.291839557399726%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAAB6ElEQVQoz11SYXOaQBTk//+Dfu+009jWNDZOjXbERkcskCCgBAFBUVEEHI02BsXt40zTaW+GuePesm/3LRxo2bYC27rCdFKFpn6CcncBf3SDkXdN9xJWqzX6/TJm0yq9lyGJH9DTLxHMaoQvYbNZ5zQ4nU7g8kMYTqgoI1x0CViHrtXheQKWS4VqYzw/Z9RMQRKr1LzJMEafxyrRqKmMND3+JQwCD5OJieGwD8O4xwM945EJRRHorMAfm5j457qqikQmwfcH0HURlqUxrO8biJZzRsrZVgOPGx6b9S115EkFz/bFvIZ+7yPU7gVk6R3En2+hqwVWi6M6wyVxHdvHFubBNxqFfCZ03SEpU9FqNTAa2QgCF7PZkOblsLPrGpCkJqm0z/cvz5xqnmeh3b7FYNAjfHAmnE07xP6DhluG54r4f223O8Rxgqen/T/3WXYiuzI5KMN8aJAjCTxfAKcqRbJTQL7rWoWAeBkwsFhEr0S73S8KKX6tp2lGI6mgq3xGu/UepnGN0tUbcIdDhsPhyIBhOMfAJAtmE/d3FQjCJdlzGEEeXEcokpMqU5SnHEVLlnCaHrDfp0w19yfufI3HFkm/gWOXKOEikug7HKfDmjl2m5KswR3Svzn4Qna/kuIp++54zAVlbP8NFwuMl69FAnYAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 11 18 27 12" title="" data-src="/static/2024-10-11-18-27-12-1f59184611e036f2b4331e2dbfbb01b3-683dc.png" data-srcset="/static/2024-10-11-18-27-12-1f59184611e036f2b4331e2dbfbb01b3-4115b.png 200w,\n/static/2024-10-11-18-27-12-1f59184611e036f2b4331e2dbfbb01b3-86845.png 400w,\n/static/2024-10-11-18-27-12-1f59184611e036f2b4331e2dbfbb01b3-683dc.png 723w" data-sizes="(max-width: 723px) 100vw, 723px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在上图中，我们注意到引入了一个分布式服务框架。通过该框架，系统中的医生服务、患者服务等一系列独立服务就可以进行合理地编排和整合，从而构建业务 A、业务 B 等不同的业务场景。显然，分布式服务框架在这里扮演了重要作用，而后续内容中所要介绍的 Dubbo 和 Spring Cloud 就是目前主流的分布式服务框架。</p>\n<p>请注意，分布式系统相较于单体系统而言具备优势的同时，也存在一些我们不得不考虑的特性，包括以下</p>\n<ul>\n<li>\n<p>网络传输的三态性</p>\n<p>我们知道对于单体系统中的函数式方法调用而言，只有“成功”或“失败”这两种状态。但是分布式系统则不同，因为远程请求是通过网络进行传输的，而网络在处理请求时还会出现”超时”这个状态，这样就相当于有三个状态。</p>\n<p>显然，网络传输的三态性为系统开发带来新的挑战。面对超时状态，我们不能简单把它处理成是一种成功或失败，而是要具体场景具体分析，避免出现请求丢失或请求重复发送现象。在分布式系统设计过程中，我们需要考虑这种由于网络通信所导致的用户体验问题。</p>\n</li>\n<li>\n<p>请求的容错性</p>\n<p>从错误发生的几率而言，分布式系统显然比单体系统更加容易出错，因为系统的调用链路变得更长、更复杂。每个分布式服务自身可能会发生异常，而这种异常在整个调用链路上会进行扩散，最终可能导致整个系统都不可用。</p>\n<p>在分布式系统设计过程中，一大挑战就是需要确保部分服务的异常情况不会影响到整个系统的可用性。</p>\n</li>\n<li>\n<p>系统的异构性</p>\n<p>分布式系统的异构性很好理解，原则上，每个服务都可以采用一套完全不同的技术体系来进行实现，只要它们对外暴露接口是统一的。但是，因为技术异构性的存在，会增加分布式系统的开发难度和维护成本。</p>\n</li>\n<li>\n<p>数据的一致性</p>\n<p>在分布式系统中，各个服务通常都会构建属于自身的数据库，这样就会导致业务数据无法进行集中管理，也就无法通过传统的事务机制确保它们之间的一致性。如何实现数据的一致性是分布式系统构建过程的一大难点。</p>\n</li>\n</ul>\n<p>以上几点是分布式系统的基本特性，我们无法避免，只能想办法进行利用和管理，这就给我们设计和实现分布式系统提出了挑战。</p>\n<h2 id="解题要点"><a href="#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解题要点</h2>\n<p>通过对单体系统的核心问题和分布式系统本质特性的分析，我们明确了一点，即从技术演进角度讲，分布式系统的诞生是单体系统发展的必然结果。因此，在回答这类问题时，对于技术演进的背景和需求的讨论是我们的第一点回答思路。这部分内容通常不用过多展开，我们可以结合日常开发场景，从业务需求和技术需求角度简要介绍即可。</p>\n<p>针对该类问题的第二点解答思路在于充分利用逻辑性和对比性。从面试题的考查方式而言，这是一道典型的对比类面试题。因此，针对如何介绍两个不同事物之间的差异，我们需要采用一定的逻辑性。一种比较容易掌握的技巧是：先抛出一个应用场景，然后分别对两种事物的正反面进行展开讨论。举例来说，如果我们想要阐述扩展性这一应用场景，那么对于单体系统而言，因为没有合理的业务边界和拆分策略，扩展性就很难保证；而对于分布式系统而言，通过引入合理的纵向/横向拆分机制就可以很好地解决这一问题。</p>\n<p>虽然这是一道概念类的面试题，但也不要忘记在回答过程中提及一定的实践内容。对于面试过程而言，不管是怎么样的面试题，面试官都希望从候选人身上看到相关的实践经验。因此，最后一个解题的要点，就是建议你可以从日常开发过程出发，基于分布式系统的拆分和集成、请求容错性的实现、数据一致性的不同应对策略等角度，谈谈自己对分布式系统构建的一些思考和总结，相信是很好的加分项。</p>\n<h2 id="总结"><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h2>\n<p>我们已经提到了分布式系统所具备的一组本质特性，也强调了我们需要对这些特性进行合理的应用和管理。为此，我们需要进一步梳理分布式系统开发过程中的技术组件。那么，实现分布式系统应该具备哪些核心技术组件呢？</p>\n<h1 id="实现分布式系统应该具备哪些核心技术组件？"><a href="#%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E5%BA%94%E8%AF%A5%E5%85%B7%E5%A4%87%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E7%BB%84%E4%BB%B6%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现分布式系统应该具备哪些核心技术组件？</h1>\n<h2 id="背景-1"><a href="#%E8%83%8C%E6%99%AF-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景</h2>\n<p>分布式服务是构建分布式系统的基础，可以认为，任何一个分布式系统都是有若干个独立的服务所构成，这些服务通过网络通信实现相互调用，从而完成复杂的业务处理流程。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-12-10-06-52-d6fa862105e1347544eb3a97588033d0-a3fce.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 515px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 73.98058252427184%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAACWElEQVQ4y4VTaW/aQBT0//8DVVWpn/qlSokaQKnSSAQoCTgOZyAYzE2CsbltDhtDpoM5Gi51pae38q5n5828J+DEen9/3+1fX1WUyzUUi2VMJtbJOx+XcA5sPB6jUkkyJIKJKJUeUa/HUa1mYNvzs6DCIdByuXRzs9GAUrxi9iLy5wvCwc9oq9fIv3ih673dP4egR4DbbNs2VLWKRkMmwzRemwqyz49otWpYXdmCHYIKp8rdkHSXqnawWGD3vd8fwHGcI4bb/RHDTqeNQiFG7eLI5e5xF7hESRHJVHHPHWcOTdNo0GTz39KVaRvCP9prWvm8BGf+AE29QSL+DcXCT16MQs6HYVmL3eOjkQHDnPzf5dlsgkxaRCoZpXYZsk27Gup6a8dotTStiVjsllWINEuhxnk0mzIEy7JhmmMCzTCzLLZHmbrpONef6wCSCT86+i+Isa8IBT+hrHhQq3ohJJPXbN47PGd8SKeuyO6Sez/F77ogCzqy1mex52YuF4csx1CQJbzkYtT4mX2aJWDCB70dgiR+x5P0g/RD1OuaGg1OsjQMg+XrrGg9NSZ1/NgVwnRqYTAYuWWPGSuxh0OTbg/IcsS9wXODjyh4e2txgsy9B0zTYBXOpq0Wx6asVr0uQ2tHUK8F6fItKuUA44aTk9iM5dSdFk3rQpLi7r7XH64Z7nf8mruipNDthFHI+ynDBXJZH0bDB/ZjnP1nM0fQ60Z57zfPPZTpniMapplvpydlPp+j3dbR6/VZdt/Nqqq54zib2WylIB0O02kPHsULggXQqAcoSRN/AdG4biqI+FjiAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 12 10 06 52" title="" data-src="/static/2024-10-12-10-06-52-d6fa862105e1347544eb3a97588033d0-a3fce.png" data-srcset="/static/2024-10-12-10-06-52-d6fa862105e1347544eb3a97588033d0-96d1c.png 200w,\n/static/2024-10-12-10-06-52-d6fa862105e1347544eb3a97588033d0-2b9d0.png 400w,\n/static/2024-10-12-10-06-52-d6fa862105e1347544eb3a97588033d0-a3fce.png 515w" data-sizes="(max-width: 515px) 100vw, 515px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>虽然，上图看起来并不复杂，但想要实现一套高性能、高可用、高扩展的分布式服务体系绝非易事。在日常开发过程中，我们在设计和实现分布式系统时需要系统梳理构建分布式服务的各个技术组件。而在实际的面试过程中这也是非常常见的一个面试问题，考查了候选人对分布式服务相关技术概念以及对应实现方案的理解程度。</p>\n<p>从面试角度讲，涉及分布式服务技术组件的知识体系非常广泛，所以可以认为这是一道发散型的面试题，面试官想要的并不是一个标准答案，而是看候选人对这一主题理解的深度和广度。针对面试不同岗位的候选者，面试官的要求是不一样的，判断的标准也或有所不同。</p>\n<h2 id="问题分析"><a href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题分析</h2>\n<p>相信只要你开发过分布式系统，基本上都能对构建分布式服务所需要的技术组件说出个一二三来，比方说网络通信、远程调用。你可能也会提到负载均衡、集群容错这些更为复杂的名词。事实上，分布式服务的技术组件之间是有一定的逻辑关系的，有些组件能够独立运行，而有些组件则是构建在另一些组件的基础之上。比较典型的例子就是：配置中心的运行往往需要注册中心的支持，而服务容错则依赖于负载均衡的实现。</p>\n<p>另一方面，对于分布式服务而言，组件与组件之间的定位也有所区别。有些是必备组件，缺少了它们系统就无法运行。有些则是扩展性组件，比较典型的就是前面提到的配置中心，原则上我们不使用配置中心也照样可以构建分布式系统。而还有一些则是通用型组件，这些组件并不局限于只能用于构建分布式服务，例如动态代理组件。</p>\n<p>在面试过程中，关于这道题的问法其实有很多种，常见的包括：</p>\n<ul>\n<li>如果想实现一套远程过程调用机制，你会重点设计哪几个技术组件？</li>\n<li>负载均衡机制是如何与集群容错机制整合在一起的？</li>\n<li>想要实现服务容错，有哪些技术手段？</li>\n<li>微服务架构中，配置中心是如何与注册中心进行交互的？</li>\n<li>为什么在分布式系统中，处处是代理？</li>\n<li>在分布式服务构建过程中，经常用到的架构模式有哪些？</li>\n</ul>\n<p>这些问题虽然问法各异，但考查的都是候选人对分布式服务中核心组件的理解程度。通过这样的分析，我们发现这一问题的难点在于我们要回答的概念有很多，而这些概念却又比较零散。当我们面对这种发散型面试题时，应对的方式绝对不能发散。单纯做零散的概念性阐述，往往很难得到面试官的认可，因为面试官会觉得你是刚接触分布式服务，没有自己的思考和体系。</p>\n<p>应对这一问题的基本思路是要具备完整的技术认知，然后能够用自己的语言对各个组件的组成结构和基本原理做一定的展开，这样的话这道题应对起来就会比较自如。</p>\n<p>因此，接下来我们就一起系统梳理该问题背后的技术体系。</p>\n<h2 id="技术体系-1"><a href="#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术体系</h2>\n<p>在分布式服务的开发过程中，开发人员需要应用到一批技术组件。按照这些技术组件的不同定位，我们把它们分成三大类，即远程过程调用组件、微服务构建组件和通用技术组件，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-12-10-11-57-f6ca55d404165996531c2e028b54a091-51685.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 550px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 63.81818181818182%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACsklEQVQ4y21Sa1PaUBTM//8HrXZKtRWrUxTwhahVy5u8gLxDgEAgASIgBludyvYk0NoP3pkz9yab3bt7Tpjlcom/9bJ8Qbgk20basnAgy9gTBOzy/GrnuGhPmSYyqorn5+fo+/81GLyxxvMHCK6LgtlEXjPA2V2UrVZUN7KCas+BNhy9RQUT/Fwg+BVEtXh6xPRhir7rIJjN8DCfkYtHBMEMjmPj98sTne+xuL+HPx7CHbvEeeXPF3MwCSGJbXYX25U4YsXPeHf9AZvFGHTbxFXrFhuFGDZzW3j/I4aN3Cfs60moHR1nWhYx9gu2Kjv4WNzGVjWOhJ4C0x31oNgyaqaAUr0Ajc5G38CCnLsTF3JHQr0poljLQ6Fz020ieAwwmAygOypEg0e5UYTWU2ARxkx8Dx3rAjX+AKVcHC3zlJ6rUT9m0xFM7RQNMQm++g3ddhZ2m40wfzyg77IRjy3vwzJOCRfA+CRo6NdQlEvUxAxUNYtWS4hIk+kQkpSNSpYvoWkX6NiN1eBIUNeuUK+fo147h6aGmBQKuvC8IlrWd6hKBn3nFr1ebe3QQ9e+RtO8JHI2wtyBshKkVg29AqxmiJ3Dc3Po92UwY5qUJGUg8EeoVpKo1Y5gGqvId3cuBCENtpoEx6XRaByRezHCPK+LRv2YOAmUSwlKlyJT4ipyKMiyaRQLBxAFEjTZf4I8n6L3CRJNR5e1Wyv3o6FDgmckdkhFRsRjwupgQpLvV+H0crA7txSlhEF/1afZjP61QR69bo5iX9EgSuRMXQ3Fd+i5TJybqF0R5qprh40MOHJYKafopjDy2qE/oFZQXDb5GmsdeTRyaCBnhIWtIvfiCdrtBpghWTf0E4q0j3xuB7J0SJGLaxd9ipVApfSVsDgNLUkkLsJct0086mF5j1oSp3OaLuPwB0pWmrUmRwsAAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 12 10 11 57" title="" data-src="/static/2024-10-12-10-11-57-f6ca55d404165996531c2e028b54a091-51685.png" data-srcset="/static/2024-10-12-10-11-57-f6ca55d404165996531c2e028b54a091-b4476.png 200w,\n/static/2024-10-12-10-11-57-f6ca55d404165996531c2e028b54a091-1367e.png 400w,\n/static/2024-10-12-10-11-57-f6ca55d404165996531c2e028b54a091-51685.png 550w" data-sizes="(max-width: 550px) 100vw, 550px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>接下来，我们将对上图中的每一个技术组件做展开，从而为本课程后续内容的学习打好基础。</p>\n<h3 id="远程过程调用组件"><a href="#%E8%BF%9C%E7%A8%8B%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8%E7%BB%84%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>远程过程调用组件</h3>\n<p>远程过程调用是分布式服务最基础的实现技术，开发人员需要从网络通信、远程调用、负载均衡、服务容错以及服务降级这五个维度来进行系统的理解。</p>\n<ol>\n<li>\n<p>网络通信：网络通信是一切分布式操作的基础。当客户端和服务器端建立网络连接之后就可以相互发送消息。但围绕网络通信整个过程，事情并没有那么简单。我们需要考虑网络通信的性能、可靠性以及在通信过程中实现数据传输的方式，这就涉及到 IO 模型、可靠性设计以及序列化方式等一系列技术主题。</p>\n</li>\n<li>\n<p>远程调用：远程调用解决的问题是如何发布远程服务以及如何引用远程服务。一旦服务发布成功，就相当于构建了一个有效的网络连接，并通过启动监听端口来对外暴露服务访问的入口；而服务引用则是一个向目标监听端点发起请求并获取响应结果的执行过程，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-12-10-13-23-67374f4de5a2d3ffcc840d3ba16f95dd-50124.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 545px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 27.88990825688073%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABK0lEQVQY021Ra2vCMBTt//8N+7DBGGxj85NTkFXtnLqJEwbDWk0fpsb04foaRZj1LE33YOiFww25OSc5JwqOVLEvsCt2ch0EAQzDgK7ryLJM7pWz8syxUlzXAmOOBKUmPtL0T/hzhyiKpGgYhthut//Inscg+auKv1rZUKJIA1+rYtjGe9hBd1RDz36GRnrQxg9I4+qCoiikcH8+xNAdoTlpYWbUBacLj6tC4x6+0FB8r4Wlcwe6bCDZtKG+XuHi7Ran43No095vBGVZloXLlxtcz2o46Z/Bpk0w2oAr4Nh1RJsOFJMMYJKhxGLxKLKawA8DcJ9Lu0mSyB7HMTjnYGuGIPRBXQp9OoBlVnzLfMJi3ocinGC/L19R2joMucyOECKR5/nhB/7wv/sXt/a9j3gep9YAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 12 10 13 23" title="" data-src="/static/2024-10-12-10-13-23-67374f4de5a2d3ffcc840d3ba16f95dd-50124.png" data-srcset="/static/2024-10-12-10-13-23-67374f4de5a2d3ffcc840d3ba16f95dd-805e3.png 200w,\n/static/2024-10-12-10-13-23-67374f4de5a2d3ffcc840d3ba16f95dd-95560.png 400w,\n/static/2024-10-12-10-13-23-67374f4de5a2d3ffcc840d3ba16f95dd-50124.png 545w" data-sizes="(max-width: 545px) 100vw, 545px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在服务调用过程中，远程调用本地化是基本要求，即远程调用过程的实现对于开发人员而言应该是透明的。同时，我们也需要考虑同步调用、异步调用以及同步转异步调用等一系列具体的调用实现策略。</p>\n</li>\n<li>\n<p>负载均衡：所谓负载均衡，简单讲就是将请求按照一定的策略分摊到多个服务实例上进行执行，基本结构如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-12-10-14-04-cb077cb9be8d474457da3cd9fa916135-d1477.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 536px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 67.3507462686567%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACtklEQVQ4y22TC1NaSRCF7///CdmtrbV2EYioZAXDwysJXuA+ALk8FQmCRBcVCwEJ8vzSc1m3kqp0Vdf0nO5zpme6RktWdTIri+zc3vrCJvNqkVk6JJ9S7LpBDr8c4SsFCLcjZAU/ezXJzK1trXByshpLk2RJRzuI+rAL4s4uhfMAluPDrYSI6e9IZ3c87Nx9T6EU9OJE6jdOPv1OSTCn4Cdf9GPZPqyij4NoAE3X/yFvByjmQ5RLYaxcAPf8gJS+w6fTHRxrDzPrx0j/LTX7JBN/cHryJ8bnvwQPUHBCwglimn4SegRttVoxGo0ZTya8TKf07/vkTJO7f/t8m73yOp9TrlS57nRYLFdMZzNuel+lwzKj8ZiZ1ChX3PV6jcYvbDgYMHt54WU0gs2G/u0tKxFWNnl+9vILEf6VaRshKGVlqsukI4O5vCRzcUFM4lS5TLpW43O1il4qEc/nyUneaDQ4cRzpbiusdJRrbxtl908DQtfXOBJnxQ05aK/d5qB7I3jHW03BM+KqJtRq8axu8YOG9qas7Gk4JOy6pB8eOLu/51gIh5UKH+o1wtKhiuNyYFpyZ4+PHJ4XmcjT/NThVmzzH7jm9uaGgQymK50VbItO+wu2DOlSrtjrdijKM3Sv217do9S9cd9EvSsvlxvPlfZwOOZxMGT6bfs2a8E6nZ5Me/U/UU2/0/3KYrH2ODJ8j+9d+aJR4Kpp0ry0ZLWpVtLk80m63SvqtRytK1tWw8ObUtdoWNzd9SgWdVw3xZXkm03Lq3NLZ2j12pHoVgUI02p+YDIyZF8kYxzx0D9ltbRo1ENc1PfZrB36gjlOisXcZDrJUK/ucduLCadCWb6pZhgJ4vEAx8d+otFdYvEgHz8GqNfLnOph4rEg0YifY/lWKk6ljmi3W8J5T0z2kciu5OSXJNR+n+/rnJ20JCZehAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 12 10 14 04" title="" data-src="/static/2024-10-12-10-14-04-cb077cb9be8d474457da3cd9fa916135-d1477.png" data-srcset="/static/2024-10-12-10-14-04-cb077cb9be8d474457da3cd9fa916135-bb263.png 200w,\n/static/2024-10-12-10-14-04-cb077cb9be8d474457da3cd9fa916135-9a78f.png 400w,\n/static/2024-10-12-10-14-04-cb077cb9be8d474457da3cd9fa916135-d1477.png 536w" data-sizes="(max-width: 536px) 100vw, 536px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>负载均衡在实现上可以使用硬件、软件或者两者兼有。而针对软件负载均衡，也可以分成服务器端负载均衡和客户端负载均衡两大类。在分布式服务构建过程中，我们主要的讨论对象是基于软件的客户端负载均衡机制。例如，目前主流的微服务架构实现框架 Spring Cloud、Dubbo 等都内置了完整的客户端负载均衡模块。</p>\n<p>另一方面，负载均衡算法决定了对请求进行分发的效果。负载均衡算法有很多，可以分成静态和动态两个大类，它们之间的区别在于动态算法依赖于当前服务的运行时状态，这些状态信息通常包括服务过去一段时间的平均调用时延和所承接的连接数等。</p>\n</li>\n<li>\n<p>服务容错：在分布式环境中，服务访问出错了该怎么办？这就涉及到服务可靠性问题。服务可靠性是分布式服务构建过程中的一项关键要素，我们需要引入容错思想和机制。常见的服务容错技术包括集群容错、服务熔断（Circuit Breaker）和服务回退（Fallback）等。下图展示的是添加了服务容错机制的系统架构演进过程：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-12-10-14-41-849ff2b076bd4a5c857d299bb7b72012-9e167.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 538px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 97.58364312267658%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAAD0ElEQVQ4y31UaVfiSBTl/3+cDz0z7a6gssi+KgIhoCjZE5JAEkC60eG0p8UFXBDvvIRuR+3TU+fc815V7rv1qurl+fBhvLy8eHYymaDZTEORU4Q0ZCkFSUqjpWVgGKdY0F48/lv4Por9FByPr6CpcRIIw9D3yA9D4LdxcZ6Hrlfx8DB7l8DP4ftdhu4YfunhrN9Bx1Qhi6f4OnDg2Dpur8f/cX/wf5uhO+7ouFKrBd12YJ0N0JQVZA6K6JBvOF0opom2bb8TehV8O5nP5x6pOxggNRyifH+PgKZ52NF1bIgisqMRWOLGRQnPj4+/iPreHpGWPHtBQUlJxIFjI0E2xvNIiAKJ8MiZBva7DgpckwLmH29sceTZ/QzPD29A8+n4DvfXd5hNH3F5PkJbM/BM/v31BNOrWzzcTon7/Brjasyf5vCxah2Mw6LWPQLbrXuo9RZ+sVVC1aohL+8jWI2Qz6JkVFA2GdT7xxRTf0W9f+St+6JaAiyayH4vo3DDIH/NIHdVRuXxGP5WGEvcFpaaW1jhA1gRA/hUX0HusoTipIYcxeSvKsQnjCs4vGXhi2lp1JwMJCuDZjsF3lr4jJWmO8xCMJOQ7AxEmgv0neukkSW4XIGsSFzXat0cCu0kfOuMHw1pF6YcBtfYgiLswNL2UKUiDlVX4OhRSNyOty41A+g5aSxl/oDVTkA49cNQI5D5HYwGeUTZNfgcKlZVF+F0W7AdFxocsqohQm0r4Pk6Oh0F/bM2ZPkEmi5ANmQYpvQjRvNg2RoUXfr1T3k7ZtMn3N1M362NL8f/F7IQ7A17OJDKKMoMihJDfgUlhcVychP73CGubxYi7UEHG9lt7DFJlNUacSse341rUMNwG4oPVJt5voAUt4F6i+5OC4Gl160oQTTMGHabm9D6OuYPc4TrYVTNCFgtAkYNETfsgVGD2KV77A/PFoLZkxx0IpliCMrpDkwpDLHhx+UZbXS8CZnuav44R7AYwOhLAcrJNoT6lsfVhRDO7TTitNa7GNCvR9VdMViEKKM4CcakEKJiEAk5gpgQRJA26gwtzCZPyGp5xGgeF8OIEy9OG7u8PeLFqLwG5yQIamsHSgmsHoH1tQi1m4U52Pdsf1RGoumHTK/oZpgS0+DtJAzK3P2uEVzbI17kJAB70HMFX1CQiuDo7tqtGERuF7q6B+50G9/Oi8g2NiBYiieY5EisHaOaDEGirHjiCFSjl/+UED3apPbmLF75UCjj0+GfWK+uYa26ilVmZWEJfx1+RoearDuiRwn8XfmMNWb19btrl5llrFbWqUtd4F8/7IIyTdTYlQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 12 10 14 41" title="" data-src="/static/2024-10-12-10-14-41-849ff2b076bd4a5c857d299bb7b72012-9e167.png" data-srcset="/static/2024-10-12-10-14-41-849ff2b076bd4a5c857d299bb7b72012-bd273.png 200w,\n/static/2024-10-12-10-14-41-849ff2b076bd4a5c857d299bb7b72012-7e34d.png 400w,\n/static/2024-10-12-10-14-41-849ff2b076bd4a5c857d299bb7b72012-9e167.png 538w" data-sizes="(max-width: 538px) 100vw, 538px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n</li>\n<li>\n<p>服务降级：从概念上讲，任何一个服务都是可以分等级的。具体的服务分级方法因业务场景和需求而定。一旦我们实现了对服务的针对性分级，那么就可以对那些处于业务链路最外围、等级最低的服务开始执行降级。至于如何对服务进行分级，可以按照需求采取一定的策略，例如常见的三级分类策略，如下图所示：</p>\n</li>\n</ol>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-12-10-15-16-2faa4d58d070168088565bc84667f3f7-50124.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 545px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 34.49541284403669%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABiklEQVQoz22RW0/bQBSE/f9/Ql8QNAhKSCS3QNuXohYS5UJiO8FOA7F3fb9EmDZtHohwvm4sWvWBI41mNaudPWeOtt1u+R/PVcWurudd3vsXHI1POJm2adpt3FBiGtcs7nXcxTn9XoPppIVlNAn8T0r7iMZrtYW+PaAje7Xx1V2Hvj+k/PlIEgvS1FJsMZt18NwhrjugyG/JMhttWZZkDw/kLyzCkNVqRVEUCCnJlzlpnhLHcf3XZrMhjiL1OGVZ5OR5ViNR9ztNe2eaHEynHBhGzS3HJvEj9OEZregDb3p77JuHNJxjvosFo+EXJtZbxqMGN4N9NfYet5NjFndtZk4LzVPu8yRhHiukKbYUlKrTIA0QhcRLBSITyFzytHlivV6pkT3yTHWvtN15Wfg1iiJ4PcPqueLGGdFT2Ri+xdg3GYmxyvAHaeITBiZBYCHlCwuDKJqoWFSGldrsP6gN/93ylejy+dclR84pp66OHl9wH3hY5jfWv78qkzM8Tyf0z3HsJo/lpdK7/AHeBffgRtcIhAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 12 10 15 16" title="" data-src="/static/2024-10-12-10-15-16-2faa4d58d070168088565bc84667f3f7-50124.png" data-srcset="/static/2024-10-12-10-15-16-2faa4d58d070168088565bc84667f3f7-805e3.png 200w,\n/static/2024-10-12-10-15-16-2faa4d58d070168088565bc84667f3f7-95560.png 400w,\n/static/2024-10-12-10-15-16-2faa4d58d070168088565bc84667f3f7-50124.png 545w" data-sizes="(max-width: 545px) 100vw, 545px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在上图中，一级服务属于核心服务，需要确保高可用，不能执行降级操作；二级服务通常采用的是异步交互方式，容忍暂时的数据不一致性；而三级服务则可以按需对整个服务实行降级操作。</p>\n<h3 id="微服务构建组件"><a href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%84%E5%BB%BA%E7%BB%84%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>微服务构建组件</h3>\n<p>在远程过程调用组件的基础上，我们继续讨论微服务构建组件，包括注册中心、服务网关、配置中心、消息通信和链路跟踪。这些组件扩展了分布式技术能力，为构建大规模分布式系统提供了技术保障。</p>\n<ol>\n<li>\n<p>注册中心：在分布式服务构建过程中，服务与服务之间通过远程调用完成业务链路的构建。而在服务调用之前，我们首先需要发现服务，即解决在分布式集群环境下如何找到目标服务实例这一问题。服务发现和调用构成了服务交互的基础，整体流程下图所示，其中实线部分代表服务调用流程，而虚线部分则包含了服务的注册（Registration）和发现（Discovery）过程。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-12-10-16-02-1cfcf5ef6d37e4de84cdb14153b42586-fee7b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 547px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 64.71663619744058%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACPUlEQVQ4y42Ti1LaUBCG8/7PUEXbsaggFkTQVgFDQuQmFwUSiIpi62UsrVACQpKvhyDOtGXabuabc5KT/LO7/0bit3Bd93VdhOM43nn9sk4os85uNuixk90kmosgsSDmon+Lk1aRgr5FvRmhJjCvYnwsbyE5rsMviAzmmfR7PX70+wwGA4++2Pf7PSbPE44qMjsnfuI5Qd7PXsFPuBhcnOE07r8+st9uExMEKhUC5TLxqytizSbdxy6pUoq8EeSsEeLU2EY3w0J0HSlTzyA3Eih6ClWQqH1C7xh0v30XLxRQhYDWapGoVsmYJqXra1zH5cvjLYelBMlyyiNRSpLT80hheY20uoSsLKOqPuT8Cnv5OOPRmMloiKgdZzwG26bX7YpnI8bifjKeLKxMild3US9jKOcx1Is4qYsomnnsHU79nNozFCL2i7t39/c8PT3Nzr2+26/9tx0b6YPiJ1t8h6KtomXfImd9HBT3Z0ruTMR+fp4hhIVjnjnWwFqc4bF+7PUw3Uh6JGsHGDeGcNUiaxhUOh1yoodJYcy0f4bI0LEdzLYpnhcwHlrU7wyBTkN857nsJfKCqMCL24cHtmo1gkaTZU3DL1yOCJc3KmVuOp+pmhX2M284UnwcykukNR+bqSWk2RC73jVf53NoWRbWcMhIlDvt43TfE+WOrBEnzRLJZhjFiCDrYdH3KNFqaCa4iH9FqVUmUwtSLAfQxFCXqgF2tbU/B/t//+XT8zM2xJiF0isEjpbZVld4n1zlJ1c2uvgh8KfTAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 12 10 16 02" title="" data-src="/static/2024-10-12-10-16-02-1cfcf5ef6d37e4de84cdb14153b42586-fee7b.png" data-srcset="/static/2024-10-12-10-16-02-1cfcf5ef6d37e4de84cdb14153b42586-9b56f.png 200w,\n/static/2024-10-12-10-16-02-1cfcf5ef6d37e4de84cdb14153b42586-18701.png 400w,\n/static/2024-10-12-10-16-02-1cfcf5ef6d37e4de84cdb14153b42586-fee7b.png 547w" data-sizes="(max-width: 547px) 100vw, 547px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可以看到，图中的这三个服务都需要注册到注册中心以确保负载均衡器能够从注册中心获取各个服务的定义信息。</p>\n</li>\n<li>\n<p>服务网关：在分布式系统中，API 网关（Gateway）或服务网关（Service Gateway）的出现有其必然性。我们可以根据需要在服务提供者和消费者之间架设这层服务网关。在注册中心和负载均衡的基础上，添加了服务网关之后的系统架构如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-12-10-16-32-c8b8eb700b3277f427c2a44e19d9a975-246ce.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 544px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 84.19117647058823%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAADgElEQVQ4y11UaXPaSBDl/3/bjZ1KpVKVxGAwh7kPYxtCwmGbSwcgifsQIAmEANtbji/eNmOzVFZUq1Xdb9709LzGNh4P0KjHIHAhZtWyH9VKALIUB89FYC7m2D26rqFei1E8AK4aQKXsY1YTaS0fhKapsHV7TYzVC4jCKREHUSq6KOmDOrpAp5OApk/+IxypQ4qnIDWCaNQCtLmbyH3oEq7XS1C+B9sWaM3nzORGA4Y2hbUwMZ1u/QL/f7YxjSo1CT83dLRkGTNNw9I0Wd7GyRKEbhclSUIolUKl2YSq6Sw5JmBVUcBTbGtcs4XWYMhy69s7cO02opkMcjwPsddDRZFh8wgC3P0+XLTApTQRoZ3OuSqmFLMnzhBfr3EsyfB0OkisVjjK5aDUaiiTeYjEQYU4GhLsW89xsBVEEVk6arZexxWR/iRfromsCplIc+0WslRlvtVEnkjL5J8fH9Ed9JHiObY2QxwZ2iBLnvUQLy/MPd7/A3OiYzIco620yVow1CnWpoXVfMG+W5LCcupgBHNq4PX301tzX1+BzQa2Db0Y59MLVXCNjJlHwSri16wAD+dHrJNEonOBZD+NsJKAlw8gZ17hallCyviFapdn6zfshz3h88MTUtIPJPRLXBoZRIdJ2ElCLs6LrwU7HOUTHFfccFY9ONfSb5hJElfKDVX3TrircEf6++EBC7qUpWUxu7+/Q596pZM81LGK4WjIYtY2v7QY9uX5rV07HttOXzPS1XRmYEYa1OnbXC7BiQIkktXukUlzPF3YYrUkzAwGTdHE0NiGm20Pt0fevqYU9BTdiIl+xGkCdj5IR/yePcJivcBqtcZJ4QT+kguJdwzDkblpYrqT/p6w1laQLjuh9+Jo8B50JJplwYu1noYz9Qmz2wUGIxWJayesCY0pYRXBh3rVjVvCRArfIPSkPWFn1ENI9OKMAJGbY8QrJ4gUnUjVTuG4PoJ5Z9Hg6wgLfiR5N0LXDoYJEzYl+uDlXGiO23vC/nTICPNUWUEJIS8HkSO7aUfgzH/DnCqcUc8idZKMHGD5LGFzZEXCnJYckNXWnrA97iNNhDpJpa2E0e9E0WmGsZpl4P/5Bcaa/ix0HRfUL3N6CbnuJ4GH0CTCu0UW50X7n0c2TAOfzj7jIPIBh5EDHEb3dhD9COt2SXK5x9fUd/wd/gsfo39iPsQO0X+/lH8ByW+rOcL/boIAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 12 10 16 32" title="" data-src="/static/2024-10-12-10-16-32-c8b8eb700b3277f427c2a44e19d9a975-246ce.png" data-srcset="/static/2024-10-12-10-16-32-c8b8eb700b3277f427c2a44e19d9a975-745f6.png 200w,\n/static/2024-10-12-10-16-32-c8b8eb700b3277f427c2a44e19d9a975-956e0.png 400w,\n/static/2024-10-12-10-16-32-c8b8eb700b3277f427c2a44e19d9a975-246ce.png 544w" data-sizes="(max-width: 544px) 100vw, 544px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>当然，并不是所有的服务调用链路上都需要添加这层网关，我们也可以根据具体场景直接通过负载均衡器进行服务访问。在实际应用过程中，这种混合式的服务调用管理方式也是一种常见的做法。</p>\n</li>\n<li>\n<p>配置中心：面对不断增长的服务实例数量，传统的配置信息管理方式就显得无能为力。为此，在分布式服务构建过程中，一般都需要引入配置中心（Configuration Center）的设计思想和相关工具。下图展示了在前面各个组件的基础上添加配置中心之后的系统架构图，分布式系统中的各个服务都可能会依赖配置中心，从而完成配置信息的统一管理。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-12-10-17-34-090bc4a4289a3d094c7af7b01b73d97e-fee7b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 547px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 58.31809872029251%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAACMklEQVQoz31TDXeSYBTm//+InXmWZautWu6s1nTLbUqZolNApwgKyjwuREDlQ3i6YJqrne459/DCy314nw+YKIqw6TAKEZdpGmg2PkLkT8BVjyB1s2i3brGp3Zm/m8EzZdsWJOkGonCByo8sFLmA+/Z3zOcLBEGA/xXjOA69OIdtWfBcd7thzWzo+hii2IJhmHDsORaLBabTadKTySSZWdCs49i0bydr5ojnkSmXcdLt4qhYxFjXoQ2HOOaqOLyr4+Abi7cCj4IobOnG1aC5NMvidZXDcbOJLM3vnZ2B+dLp4FwUkZNl5Go1eIsl5s4cl0ILF+0OPvMCct0eaj35CaBpzZCl9/fzeXyg65Wi4F2hACYMfESky8rz1lQdC4MHFaOxBkm5R6lcxFAfQKNnqq7C9/2tLAbRHmkaHogRVitEq/CPKSHWX84Jl0h3DpHi0kjVXyJVS2OvcoBX4hu8EDKQR8oazDAS7ZNDkJbJ6WNTdi2PS51oqMo1cFId13e3qEocSjxL6xLqCg/XDwjIpSSswWLXTdPcysFsgNag4ZZO6IewyelkL4ggEGBHLELpVdASC9BUgeivEIbhU8BdoTdFUkDVRtg8nZozaFqcxfe4ud6HPjqH3LuiuCx//wjPnNDzfMhyJQkxVz1Fo35KQyweH3/CpXwOh2SKKhNwH4N+jzI6xHK5JOp2kst/AGNd+gqLnvQJbClDlPIE+DUJdwzoul7y0aTJ6fg+NiXujfMx1i+xoX+LXwdWwgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 12 10 17 34" title="" data-src="/static/2024-10-12-10-17-34-090bc4a4289a3d094c7af7b01b73d97e-fee7b.png" data-srcset="/static/2024-10-12-10-17-34-090bc4a4289a3d094c7af7b01b73d97e-9b56f.png 200w,\n/static/2024-10-12-10-17-34-090bc4a4289a3d094c7af7b01b73d97e-18701.png 400w,\n/static/2024-10-12-10-17-34-090bc4a4289a3d094c7af7b01b73d97e-fee7b.png 547w" data-sizes="(max-width: 547px) 100vw, 547px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n</li>\n<li>\n<p>消息通信：降低服务与服务之间的耦合度是分布式系统设计的一大目标，为此，我们可以引入事件驱动架构，基本组成如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-12-10-18-20-3e04a97d7e88a7189aea5813dd39e412-94f8a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 546px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 40.476190476190474%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABm0lEQVQoz21RW3OaUBjk//+TPjRJjTVEm0nsDJ1pp7YgAqIBRU1ALl4AJ4rCdg8x7UP6zexwLrN7dlnJMhXYwwcMLYEuRqMunp9diCnLEmVVoTojWC5hmiYcZ4IgmJN3jyG5lnmP0bALY9CF1NeaFLrEQL/gwRW8aQu2/RPvhoLFfo+iOIglLOsX+toHmMYl9P5HjO0Gv58gpWmGOI6RJAlWqxV8P0AURTXGrgsvCLAIQ/zQNFjcBzzPswxhGGE6nZKzrrlxnGCz2UJ6b6TC4ukJEYWavR7afKTFvcz9HYXuGDlm9Igm/jcUrP4KidkzlkMn+XaLB8dBJ8/x2ffRWa+h8F7xPCz5wGw2e7OANw3xlU6nCofDsUZRnLDbvSDNcvjClaLgK8W/MdqNqkLWdXw3DCSMHRJpmuN4LMk91XyxlgZ6B+ORzMZuCRmu02ZzvX8Z2LSYw26HbLN5PaIhwxClXJHbZss3eBx3WKwsBL/wogFNvSaavGhjMbfPxPI10Pl3JMkKLh1PJh7m88daSP3dgEquOWix5Vv8Aa5QTaePiI4VAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 12 10 18 20" title="" data-src="/static/2024-10-12-10-18-20-3e04a97d7e88a7189aea5813dd39e412-94f8a.png" data-srcset="/static/2024-10-12-10-18-20-3e04a97d7e88a7189aea5813dd39e412-e2b97.png 200w,\n/static/2024-10-12-10-18-20-3e04a97d7e88a7189aea5813dd39e412-db056.png 400w,\n/static/2024-10-12-10-18-20-3e04a97d7e88a7189aea5813dd39e412-94f8a.png 546w" data-sizes="(max-width: 546px) 100vw, 546px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>基于事件驱动架构，每一个服务既可以作为事件的发布者也可以作为事件的消费者，或者两者兼之。而事件也可以在不同的服务之间进行传播，从而满足各种特定的应用场景。</p>\n</li>\n<li>\n<p>链路跟踪：服务之间的调用不可避免会出现各种问题，这时候就需要引入分布式链路跟踪体系来定位和解决这些问题。基于每一次分布式请求，我们都可以捕获该请求的一系列跟踪数据，下图展示了基于 TraceId 和 SpanId 所构建的一次服务调用的完整链路。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-12-10-21-32-c8d330e7ddb517090ebee37e37994e43-fee7b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 547px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 25.411334552102378%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAABLElEQVQY01WOXW/BcBSH+/2/wpJlkYgY9TKmHctSpVUsqGrRF4tdLZkLxjDMs79eLHHx5Jzk/M5zjpSzCihRjcfp0xUVv4oS1ig4ZeR+kdzggaJbQQlq8ew6r6IKR9bKIcl2EWPfxvhuYf10Ysxdm/pXk/ra4GWhkXEy3DtZqh/P6BsTbdX8z7YEl92LI2PnkaLoDV1PMfayWK1EjOfmMM07Go1bXFem203S7SRxhNiyEmjaDfYgHfeX/GQsC0eSIAiRTqczYdDCG5XRtRRGIy0CKmNXZTSsMLRL1LUkppEWRxUxqzLol+j3Cuj1FK+dPNOxgj/ROR5OSHDmePxls9kyn7+zXm8Iwxm93gDPm8T9crni83OBbQ8FDr4fEkUz8fEortvdnsPhyMX1B+c6VFXxPflUAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 12 10 21 32" title="" data-src="/static/2024-10-12-10-21-32-c8d330e7ddb517090ebee37e37994e43-fee7b.png" data-srcset="/static/2024-10-12-10-21-32-c8d330e7ddb517090ebee37e37994e43-9b56f.png 200w,\n/static/2024-10-12-10-21-32-c8d330e7ddb517090ebee37e37994e43-18701.png 400w,\n/static/2024-10-12-10-21-32-c8d330e7ddb517090ebee37e37994e43-fee7b.png 547w" data-sizes="(max-width: 547px) 100vw, 547px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>服务调用链路跟踪是分布式系统的基础需求之一，业界关于分布式链路跟踪也有统一的规范以及代表性的实现框架。</p>\n</li>\n</ol>\n<h3 id="通用技术组件"><a href="#%E9%80%9A%E7%94%A8%E6%8A%80%E6%9C%AF%E7%BB%84%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>通用技术组件</h3>\n<p>在分布式服务构建过程中，也需要引入一组通用型的技术组件，这些技术组件在多个场景中（不仅限于分布式系统）都能发挥作用。本课程梳理了五种通用技术组件，包括动态代理、应用缓存、资源管理、框架集成以及架构模式。这种技术组件有些关注于具体某一个技术实现要点，有些则关注于框架的应用以及架构设计的方法和实践。</p>\n<ol>\n<li>动态代理：在日常开发过程中，动态代理可以说是一种通用性非常高的实现机制，它是面向切面编程的基础，也在主流的分布式服务开源框架中得到了广泛的应用。通过代理机制，一个对象就可以在承接另一个对象功能的同时添加新的功能。相比直接在原有对象中嵌入代码，代理机制为我们提供了更为优雅的解决方案。</li>\n<li>应用缓存：对于分布式服务而言，缓存应用非常广泛，开发人员可以使用位于应用程序内部的本地缓存，也可以使用位于独立服务器上的分布式缓存。在日常开发中，缓存的应用通常都是分层级的，我们会综合使用多级缓存来提高目标对象访问的效率和性能。</li>\n<li>资源管理：相信你对线程池、数据库连接池等技术并不陌生。这里的池（Pool）是一种对资源的抽象方法，代表一组可以随时使用的资源，但这些资源的创建和释放过程则基于一定的管理策略。资源池的应用非常广泛，存在多种具体的池化组件。</li>\n<li>框架集成：这里所说的框架集成，指的是 Dubbo、MyBatis、Spring Cloud 等主流的分布式开发框架与 Spring 框架之间的集成。我们可以基于命名空间以及自定义 starter 等机制完成与 Spring 之间的有效集成。理解框架集成的实现过程有利于掌握主流的分布式服务框架的运行原理。</li>\n<li>架构模式：架构模式描述某一特定应用领域中系统组织和表现的惯用方式。对软件体系架构模式的研究和实践促进了对软件设计的重用。在分布式系统开发过程中，也大量应用了诸如微内核架构、管道过滤器架构等架构模式，这些模式能够为开发人员提供具有高度扩展性的技术组件。</li>\n</ol>\n<h2 id="解题要点-1"><a href="#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解题要点</h2>\n<p>通过对技术体系的系统分析，我们明白了构建一个分布式服务系统所需要的各个技术组件。这里涉及了一大批专用名词。但是，光列举这些名称就够了吗？答案显然是否定的。</p>\n<p>我们在解释这些名词时需要做一些扩展，多提及技术组件的关联关系，从而确保回答过程具备较好的逻辑性。这是解答这个问题的第一点思路。例如，我们在介绍注册中心时，需要提到该组件与负载均衡之间的集成关系。</p>\n<p>针对该问题的第二点解答思路在于回归现实中的实践。本讲中介绍的技术组件都是很常见和很通用的，一般的分布式系统构建过程中都会使用到。你完全可以基于自己在日常开发过程中的应用情况来对这些组件做一定的展开。因为这是一道偏概念阐述的问题，所以如果能够做到理论联系实际，相信肯定能为你加分不少。</p>\n<p>最后，我想强调的第三点是技术判断力，你需要对各个技术组件背后的实现复杂度有一定的认识。对于那些复杂度较高的技术组件，可以更为细化地进行阐述，并在一定程度上显现出自己所具备的设计思想和对实现原理的理解能力，这样就能达到一定的深度。</p>\n<h2 id="总结-1"><a href="#%E6%80%BB%E7%BB%93-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h2>\n<p>分布式服务的相关组件虽然比较多，但并不难梳理和串联。正如我们在前面所讨论到的，很多技术组件的出现是必然的，而有些组件之间具备一定的相互关联关系。在本讲内容中，我们从远程调用、微服务以及通用技术组件这三大维度出发来对这些组件进行了分类，并针对每个类别梳理了五大技术组件，以帮助你能够更好地理解和把握，从而形成自己的知识体系。</p>\n<p>在掌握了构建分布式服务的技术组件之后，下一讲我们将介绍基于这些组件所构建的分布式服务框架。实际上在本讲内容中，我们已经提到了 Dubbo、Spring Cloud 等框架，目前这些框架都非常主流。那么，这些框架都具备什么样的功能特性呢？</p>\n<h1 id="网络通信：如何完成客户端和服务端之间的高效通信？"><a href="#%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AE%8C%E6%88%90%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%B9%8B%E9%97%B4%E7%9A%84%E9%AB%98%E6%95%88%E9%80%9A%E4%BF%A1%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>网络通信：如何完成客户端和服务端之间的高效通信？</h1>\n<p>从本讲开始，我们将进入到远程过程调用类技术组件的讨论，首先要讨论的是网络通信。</p>\n<p>分布式系统的构建依赖网络通信。相比单块系统的函数式调用，分布式环境下的请求和响应过程涉及到客户端和服务器端之间跨网络的交互和协作。这个过程一方面要考虑到网络的三态性，另一方面也需要考虑资源的利用效率。</p>\n<p>那么，如何设计并实现高效的网络通信机制？这是分布式服务框架的核心功能之一，也是我们在面试过程中经常会碰到的一个面试题。本讲内容将围绕这一问题展开讨论。</p>\n<h2 id="背景-2"><a href="#%E8%83%8C%E6%99%AF-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景</h2>\n<p>在日常开发过程中，每一次分布式请求都会涉及到网络通信。网络通信表现为一个复杂且不可控的过程。然而，因为像 Dubbo、Spring Cloud 等主流的分布式服务框架都已经帮我们封装了网络通信过程，使得远程过程调用就像是在使用本地方法调用一样，导致了开发人员对网络通信过程的底层设计思想和实现原理往往不甚了解。</p>\n<p>另一方面，对于分布式服务构建过程而言，网络通信是一个基础性、通用性的技术主题，涉及广泛的技术体系，既有深度又有广度，非常适合考查候选人的知识面。因此。网络通信在面试过程中出现的频率可以说非常高。作为面试官，我也经常会对候选人提出关于该主题的一些问题。</p>\n<p>从面试角度讲，关于网络通信有很多种具体的问法，有些侧重于具体某一个知识点，有些则关注整个通信流程。当然，因为日常开发中大家都是使用一些开源框架来开发分布式系统，因此关于开源框架中网络通信具体实现过程和底层原理也是常见的考查方式。</p>\n<p>这里我梳理了比较有代表性的一些面试话题，如下所示：</p>\n<ul>\n<li>网络的长连接和短连接分别指什么？它们分别有什么特点和优势？</li>\n<li>常见网络 IO 模型有哪些？各有什么功能特性？</li>\n<li>如果确保网络通信过程的可靠性？</li>\n<li>你认为网络通信包含的核心技术组件有哪些？</li>\n<li>如果让你来设计网络传输协议，你有什么样的一些思考？</li>\n<li>你能描述 Dubbo 框架中客户端和服务器端的网络通信实现过程吗？</li>\n<li>Dubbo 框架对网络通信过程采用了什么样的分层设计思想？</li>\n</ul>\n<h2 id="分析"><a href="#%E5%88%86%E6%9E%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分析</h2>\n<p>网络通信的实现方式实际上有很多种，但因为网络通信过程复杂且不可控，因此如何使这个过程的代价降到用户可以接受的层次是分布式系统设计的重要目标。</p>\n<p>我们知道客户端和服务器端之间需要完成跨网络的交互过程，也就意味着两者之间需要建立网络连接。网络连接的创建和维护方式决定了通信过程的效率。同时，我们知道任何网络请求的处理过程都涉及到 IO 操作，而不同类似的 IO 操作方式对性能的影响巨大。在网络通信过程中，我们需要选择合适的 IO 模型。</p>\n<p>关于网络通信，可靠性是一个不得不提的话题。网络状态是不稳定的，网络之间的通信过程必须在发生问题时能够快速感知并修复。</p>\n<p>我们把上述分析点整理成一张图，如下所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-13-23-49-00-00f777f98faf517029466e8c0d70947d-4dc66.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 34.33476394849785%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABO0lEQVQY012NfU+CUBjF+f6fwrlms7QUnbNVZg6Quy5eXrp24cokQhBExXQOEzCmKzfPzp4/zn7nOczhT1mW5TeOfySppev1gVSB0i2EN2hQ1Y2mIt87jv2PncRclKNobRjtNAO6fqepZQleaVp5F/fDsEMpuSynaZplZ+eR43z2xS5C/dEIIyQOh4jnO4Ro+2R/7J7h8/JJ+aso+t7tcu6QJEkYLo5rh9VqHcfxBcz4vhcEzmzmLhZTw3gHgNtsNvN54PsOpZjjXsLQ9Tx7u90SggHgczJPgmDiuV8MLxQprcK3oqKUVOX6Y1iGUKD0YeI0gVgAoKCTimWxEHIYNzyvpcilHB7RmjVmGVluWNazqrKaxmLcNM02xrJti77fUxQWoZppPk6nPYwRpd3lUiCkpar18fjJdV9/ATkqc+nl7AiLAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 13 23 49 00" title="" data-src="/static/2024-10-13-23-49-00-00f777f98faf517029466e8c0d70947d-fee1c.png" data-srcset="/static/2024-10-13-23-49-00-00f777f98faf517029466e8c0d70947d-a67b7.png 200w,\n/static/2024-10-13-23-49-00-00f777f98faf517029466e8c0d70947d-0b187.png 400w,\n/static/2024-10-13-23-49-00-00f777f98faf517029466e8c0d70947d-fee1c.png 800w,\n/static/2024-10-13-23-49-00-00f777f98faf517029466e8c0d70947d-4dc66.png 932w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>上图构成了我们回答这类面试题的基本思路。</p>\n<h2 id="技术体系-2"><a href="#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术体系</h2>\n<p>在本节内容中，让我们来对上图中所展示的各项技术体系展开讨论。</p>\n<h3 id="网络连接"><a href="#%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>网络连接</h3>\n<p>关于网络连接，我们要讨论的主要是长连接和短连接的概念。当客户端在向服务端发送请求并获取响应结果之后，这两种连接方式的区别在于对连接本身的处理方式。</p>\n<p>所谓短连接，是指一旦请求响应过程结束，连接自动关闭。而长连接则不同，客户端可以利用这个连接持续地发送请求并获取响应结果。显然，采用何种连接方式没有统一的标准，而是要看具体的应用场景。有时候，考虑到性能和服务治理等因素，我们也会把短连接和长连接组合起来使用。</p>\n<h3 id="io-模型"><a href="#io-%E6%A8%A1%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>IO 模型</h3>\n<p>任何网络请求处理过程都涉及到 IO 操作。</p>\n<p>最基本的 IO 操作模型就是阻塞式 IO（Blocking IO，BIO），该模型要求服务器端针对每次客户端请求都生成一个处理线程，因此对服务器端的资源消耗要求很高。</p>\n<p>非阻塞 IO（Non-Blocking IO，NIO）和 IO 复用（IO Multiplexing）技术实际上也会在 IO 上形成阻塞，真正在 IO 上没有形成阻塞的是异步 IO（Asynchronous，AIO）。</p>\n<p>各个 IO 模型效果如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-13-23-50-30-87e48e4ba0882d82e7c47e4f3080e969-ba470.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 649px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.38212634822804%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABUUlEQVQoz12RyW4CMQyGef/n66mXUgFDmcls2cZrUicICZFDZNn+vPw+XZy/rwEJDwCzf8YtHkCIWzp+p2YDwm3ez+M6bsH85hmW3WcQldMSsvNJmAkpAc0hiwgiJsBh8URsNjID2WMAYBFrZvXVYIScw6Kl1qJzhK+Lq7USswrHzZVu19dDIvszsRaL1FPho+RFirGyZvz+W3uSATI+hoBWRVpiz34vVBpMB3jXYd0z2G4NZqlK0V1JK78B73B9wtfhwlpFi0JSCOY1YNrj+Xo7bEAVW6eLR/wJ83H0zpZWMTk3oRRTxSS0nbl3tkhaHg39HJtB8mZhUa2U13U2mGzsKo+/m2/qNmAZB+ezTdF3f8EKkf1Dax877xKeaksVzO4qbYWusLswy+fYq4/Tulu2ieRjGqbZqkC7OdzdbEexCwPxbTSbY867D+e7WzbLTf+8lEV53+SpVQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 13 23 50 30" title="" data-src="/static/2024-10-13-23-50-30-87e48e4ba0882d82e7c47e4f3080e969-ba470.png" data-srcset="/static/2024-10-13-23-50-30-87e48e4ba0882d82e7c47e4f3080e969-47540.png 200w,\n/static/2024-10-13-23-50-30-87e48e4ba0882d82e7c47e4f3080e969-ee316.png 400w,\n/static/2024-10-13-23-50-30-87e48e4ba0882d82e7c47e4f3080e969-ba470.png 649w" data-sizes="(max-width: 649px) 100vw, 649px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="可靠性"><a href="#%E5%8F%AF%E9%9D%A0%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>可靠性</h3>\n<p>因为网络状态是不稳定的，所以业界诞生了一系列手段来确保网络通信的可靠性。</p>\n<p>首先，我们需要对网络的通信链路进行有效性的检测，这方面最常见的实现机制就是心跳检测。我们可以在网络协议的 TCP 层发送心跳包，也可以在应用层协议上传递包含一定业务数据的心跳信息。</p>\n<p>另一方面，一旦检测到网络通信出现问题，那么就需要采取一定措施来恢复网络状态。这方面主流的做法就是断线重连。针对不同场景，我们可以采用不同的重连次数和频率，直到网络重连成功或者超时。</p>\n<p>讲到这里，我们需要注意，上述关于网络通信相关技术体系的讨论都是相对抽象的内容。在具体面试过程中，如果只是简单给出这些概念性的描述，显然无法满足面试官的要求。要想充分展示候选人对网络通信的掌握程度，就需要依托一定的开源框架。只有通过这些开源框架，我们才能了解网络通信的底层原理。</p>\n<p>在接下来的内容中，我们将基于目前主流的分布式服务框架 Dubbo 来分析该框架针对网络通信采用了什么样的设计思想和实现过程。</p>\n<h2 id="源码解析"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h2>\n<p>在 Dubbo 框架中，存在一个独立的 Remoting 模块，封装了对整个网络通信的实现过程，该模块的组成结构如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-13-23-51-30-b17503862f9908d341c25b33b73bc9a4-4a27d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 16.259298618490966%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAsElEQVQI1w3C3QqCMBgAUN//KRJDrOjHsmYRdJmjqZ9Lp5uBOiXMrryuaR2OptR3GJRSn3EciwIimEewyLJT0zzz/Px6XYTYU7ri3MnS3Z2u/hmz2/aS5ycNQhtgQ+laiOh6dcPA8InBEqcsqzi2k9jC3iQC0ydTQgyMdezpEJqCLxnbau9303V118m+7zn3AKwgsB6Pc1XVaYqkRGWJZIXIzSTEBJgVxUFKt26OnKMfAq6SautRgPEAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 13 23 51 30" title="" data-src="/static/2024-10-13-23-51-30-b17503862f9908d341c25b33b73bc9a4-fee1c.png" data-srcset="/static/2024-10-13-23-51-30-b17503862f9908d341c25b33b73bc9a4-a67b7.png 200w,\n/static/2024-10-13-23-51-30-b17503862f9908d341c25b33b73bc9a4-0b187.png 400w,\n/static/2024-10-13-23-51-30-b17503862f9908d341c25b33b73bc9a4-fee1c.png 800w,\n/static/2024-10-13-23-51-30-b17503862f9908d341c25b33b73bc9a4-4a27d.png 941w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>从组成结构上讲，Remoting 模块主要包含三个组件。</p>\n<ul>\n<li>Exchange 组件。信息交换层，用来封装请求-响应过程。</li>\n<li>Transport 组件。网络传输层，基于 Netty 等框架抽象统一的网络通信接口。</li>\n<li>Serialize 组件。序列化层，主要完成数据的序列化和反序列化过程。</li>\n</ul>\n<p>而从技术分层上讲，Remoting 模块处于整个 Dubbo 框架的底层，是我们后续要介绍的服务发布和服务消费的基础。显然，Remoting 模块的组件呈现的是一种对称结构，即 Dubbo 的生产者和消费者都依赖于底层的网络通信。所以，我们也将分别从服务器端和客户端两个角度出发分析 Dubbo 中具体的网络通信过程。</p>\n<p>然后，在 Dubbo 中，真正实现网络通信的过程委托给了第三方组件。Dubbo 通过 SPI 的方式提供了与 Netty、Mina 等多种通信框架的集成方式。这部分内容相当于是对上图中 Remoting 模块的补充，从层次上讲应该属于 Dubbo 框架的最底层。</p>\n<h3 id="dubbo-服务器端通信原理"><a href="#dubbo-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E9%80%9A%E4%BF%A1%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dubbo 服务器端通信原理</h3>\n<p>我们首先介绍 Dubbo 服务器端的网络通信过程。请记住，Dubbo 中服务器端通信的目的就是集成并绑定 Netty 服务从而启动服务监听。我们关注 Exchange 信息交换层和 Transport 网络传输层这两个核心层之间的交互和协作过程，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-13-23-52-48-78ae3ae6ed9ebc61e627bd5effa70be9-758d9.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 24.70960929250264%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA50lEQVQY03WNT2+CQBDF+f6fwIsee2rSNEratCQWmjSNFAouJewfQFmmddFl4aCcQJcevPkymbzfm7yMQelbHD8x9goQK9USYmv0/XkQLPSkmZVlHoBIkm+ETJ2HoRmEC72j6NkQIgFYVyJqm9/jsasELsuAUpfSFaFuJX6kLIbhvN/DZuOl6RdjLsafee5xHhrnG9KFW/n1ZAyj+uE/6Pteqb/Dge92+XabaCMlV01V16pp5Ih1WRQYgCkFGq+fx3LXdYy9+P7dcjl17Kltzwh9IOS9bU8IfZTcjNC9ZU0cZ5ayOcaPFzrgCtGDPkBuAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 13 23 52 48" title="" data-src="/static/2024-10-13-23-52-48-78ae3ae6ed9ebc61e627bd5effa70be9-fee1c.png" data-srcset="/static/2024-10-13-23-52-48-78ae3ae6ed9ebc61e627bd5effa70be9-a67b7.png 200w,\n/static/2024-10-13-23-52-48-78ae3ae6ed9ebc61e627bd5effa70be9-0b187.png 400w,\n/static/2024-10-13-23-52-48-78ae3ae6ed9ebc61e627bd5effa70be9-fee1c.png 800w,\n/static/2024-10-13-23-52-48-78ae3ae6ed9ebc61e627bd5effa70be9-758d9.png 947w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>上图中涉及了 ExchangeServer、HeaderExchange、NettyTransport 和 NettyServer 等一系列核心对象。显然，通过这些对象从命名上就可以很明确地将它们划分到 Exchange 和 Transport 这两个层。</p>\n<p>在 Dubbo 中存在一个 Protocol 接口，该接口是 Dubbo 中最基本的远程过程调用实现接口，完成了服务的发布和调用功能。而在 Protocol 接口中存在 export 和 refer 这两个核心方法，其中前者用于对外暴露服务，后者则用来对远程服务进行引用。针对 Protocol 接口，Dubbo 提供了一组实现类，其中最重要的就是 DubboProtocol。</p>\n<p>我们从 DubboProtocol 中的 export 方法进行切入，该方法会根据传入的 URL 对象创建一个 Exchange 服务器，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63414778960286710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`private void openServer(URL url) {\n        String key = url.getAddress();\n        boolean isServer = url.getParameter(Constants.IS_SERVER_KEY, true);\n        if (isServer) {\n            ExchangeServer server = serverMap.get(key);\n            if (server == null) {\n                serverMap.put(key, createServer(url));\n            } else {\n                server.reset(url);\n            }\n        }\n}`, `63414778960286710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">openServer</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">String</span> key <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">boolean</span> isServer <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>IS_SERVER_KEY<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>isServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token class-name">ExchangeServer</span> server <span class="token operator">=</span> serverMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                serverMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token function">createServer</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n                server<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们来看 Exchange 服务器的创建过程，对应的 createServer 方法如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72160975853265200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`private ExchangeServer createServer(URL url) {\n        // 省略其他代码\n        ExchangeServer server;\n        try {\n            server = Exchangers.bind(url, requestHandler);\n        }\n        return server;\n}`, `72160975853265200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">ExchangeServer</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 省略其他代码</span>\n        <span class="token class-name">ExchangeServer</span> server<span class="token punctuation">;</span>\n        <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            server <span class="token operator">=</span> <span class="token class-name">Exchangers</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> requestHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> server<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到这里的关键代码就是通过 Exchangers 的 bind 方法创建了 ExchangeServer，这个过程依赖于一个 Exchanger 接口。那么这个 Exchanger 接口是做什么用的呢？该接口定义如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3019441091598085000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@SPI(HeaderExchanger.NAME)\npublic interface Exchanger {\n    @Adaptive({Constants.EXCHANGER_KEY})\n    ExchangeServer bind(URL url, ExchangeHandler handler) throws RemotingException;\n\n    @Adaptive({Constants.EXCHANGER_KEY})\n    ExchangeClient connect(URL url, ExchangeHandler handler) throws RemotingException;\n}`, `3019441091598085000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@SPI</span><span class="token punctuation">(</span><span class="token class-name">HeaderExchanger</span><span class="token punctuation">.</span>NAME<span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Exchanger</span> <span class="token punctuation">{</span>\n    <span class="token annotation punctuation">@Adaptive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>EXCHANGER_KEY<span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token class-name">ExchangeServer</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">ExchangeHandler</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span><span class="token punctuation">;</span>\n\n    <span class="token annotation punctuation">@Adaptive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>EXCHANGER_KEY<span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token class-name">ExchangeClient</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">ExchangeHandler</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Exchanger 接口只有两个方法，一个是面向服务器端的 bind 方法，一个是面向客户端的 connect 方法。在 Dubbo 中，Exchanger 的实现类只有一个，即 HeaderExchanger，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45942248970831830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class HeaderExchanger implements Exchanger {\n    public static final String NAME = &quot;header&quot;;\n\n    public ExchangeClient connect(URL url, ExchangeHandler handler) throws RemotingException {\n        return new HeaderExchangeClient(Transporters.connect(url, new DecodeHandler(new HeaderExchangeHandler(handler))), true);\n    }\n\n    public ExchangeServer bind(URL url, ExchangeHandler handler) throws RemotingException {\n        return new HeaderExchangeServer(Transporters.bind(url, new DecodeHandler(new HeaderExchangeHandler(handler))));\n    }\n}`, `45942248970831830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HeaderExchanger</span> <span class="token keyword">implements</span> <span class="token class-name">Exchanger</span> <span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> NAME <span class="token operator">=</span> <span class="token string">"header"</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">ExchangeClient</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">ExchangeHandler</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HeaderExchangeClient</span><span class="token punctuation">(</span><span class="token class-name">Transporters</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DecodeHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HeaderExchangeHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">ExchangeServer</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">ExchangeHandler</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HeaderExchangeServer</span><span class="token punctuation">(</span><span class="token class-name">Transporters</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DecodeHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HeaderExchangeHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>请注意，上述 HeaderExchanger 在创建 HeaderExchangeServer 的同时也加入心跳检测功能，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16045119936321650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`private void startHeatbeatTimer() {\n        stopHeartbeatTimer();\n        if (heartbeat > 0) {\n            heatbeatTimer = scheduled.scheduleWithFixedDelay(\n                    new HeartBeatTask(new HeartBeatTask.ChannelProvider() {\n                        public Collection<Channel> getChannels() {\n                            return Collections.unmodifiableCollection(\n                                    HeaderExchangeServer.this.getChannels());\n                        }\n                    }, heartbeat, heartbeatTimeout),\n                    heartbeat, heartbeat, TimeUnit.MILLISECONDS);\n        }\n}`, `16045119936321650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startHeatbeatTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">stopHeartbeatTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>heartbeat <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            heatbeatTimer <span class="token operator">=</span> scheduled<span class="token punctuation">.</span><span class="token function">scheduleWithFixedDelay</span><span class="token punctuation">(</span>\n                    <span class="token keyword">new</span> <span class="token class-name">HeartBeatTask</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HeartBeatTask</span><span class="token punctuation">.</span><span class="token class-name">ChannelProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                        <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">></span></span> <span class="token function">getChannels</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                            <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableCollection</span><span class="token punctuation">(</span>\n                                    <span class="token class-name">HeaderExchangeServer</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getChannels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                        <span class="token punctuation">}</span>\n                    <span class="token punctuation">}</span><span class="token punctuation">,</span> heartbeat<span class="token punctuation">,</span> heartbeatTimeout<span class="token punctuation">)</span><span class="token punctuation">,</span>\n                    heartbeat<span class="token punctuation">,</span> heartbeat<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 HeartBeatTask 的 run 方法中，我们根据所配置的 heartbeat、heartbeatTimeout 等相关心跳属性，执行 channel.reconnect、channel.close 等方法。这也是心跳检测机制的一种常见实现方式。</p>\n<p>注意到，我们在 HeaderExchangeServer 中终于看到了属于 Transport 层的对象 Transporters，接下来我们来看服务器端 Transport 相关的组件。</p>\n<p>站在服务器的角度，网络通信过程的目的只有一个，就是装配服务并启动监听，从而接收来自服务消费者的访问。而对于服务消费者而言，通信过程的目的无非是对远程服务进行连接、发送请求并获取响应。因此，在 Dubbo 中存在一个 Transporter 接口，该接口提供了 bind 和 connect 方法分别对这两个基本操作进行封装，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38863780220489930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@SPI(&quot;netty&quot;)\npublic interface Transporter {\n    @Adaptive({Constants.SERVER_KEY, Constants.TRANSPORTER_KEY})\n    Server bind(URL url, ChannelHandler handler) throws RemotingException;\n\n    @Adaptive({Constants.CLIENT_KEY, Constants.TRANSPORTER_KEY})\n    Client connect(URL url, ChannelHandler handler) throws RemotingException;\n}`, `38863780220489930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@SPI</span><span class="token punctuation">(</span><span class="token string">"netty"</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Transporter</span> <span class="token punctuation">{</span>\n    <span class="token annotation punctuation">@Adaptive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>SERVER_KEY<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>TRANSPORTER_KEY<span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token class-name">Server</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span><span class="token punctuation">;</span>\n\n    <span class="token annotation punctuation">@Adaptive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>CLIENT_KEY<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>TRANSPORTER_KEY<span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token class-name">Client</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们发现 Transporter 接口的定义与 Exchanger 接口非常类似，两者同时提供了 bind 和 connect 这两个方法。区别在于 Exchanger 中用到的 ExchangeHandler，而 Transporter 中用到的是 ChannelHandler，显然 ChannelHandler 面向消息通信的通道，提供了比 ExchangeHandler 更底层的操作语义。</p>\n<p>与 HeaderExchanger 不同，Dubbo 中针对 Transporter 接口提供了一批实现类，包括 GrizzlyTransporter、MinaTransporter 以及两个 NettyTransporter。系统默认会加载 org.apache.dubbo.remoting.transport.netty 包下的 NettyTransporter，该类如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44120565238299255000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class NettyTransporter implements Transporter {\n    public static final String NAME = &quot;netty4&quot;;\n\n    public Server bind(URL url, ChannelHandler listener) throws RemotingException {\n        return new NettyServer(url, listener);\n    }\n\n    public Client connect(URL url, ChannelHandler listener) throws RemotingException {\n        return new NettyClient(url, listener);\n    }\n}`, `44120565238299255000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyTransporter</span> <span class="token keyword">implements</span> <span class="token class-name">Transporter</span> <span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> NAME <span class="token operator">=</span> <span class="token string">"netty4"</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> listener<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NettyServer</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">Client</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> listener<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NettyClient</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里看到了真正实现网络通信的 NettyServer 类，NettyServer 实现了 Server 接口并扩展了 AbstractServer 类。在 AbstractServer 中，Dubbo 提供了对网络服务端的通用抽象，即抽象出 open、close、send 等一组面向网络通信的通用方法。而 NettyServer 作为 AbstractServer 的子类，它的启动监听实现代码如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82172932890178950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`protected void doOpen() throws Throwable {\n        ...\n        bootstrap = new ServerBootstrap(channelFactory);\n\n        final NettyHandler nettyHandler = new NettyHandler(getUrl(), this);\n        channels = nettyHandler.getChannels();\n        bootstrap.setOption(&quot;child.tcpNoDelay&quot;, true);\n        bootstrap.setPipelineFactory(new ChannelPipelineFactory() {\n            public ChannelPipeline getPipeline() {\n                NettyCodecAdapter adapter = new NettyCodecAdapter(getCodec(), getUrl(), NettyServer.this);\n                ChannelPipeline pipeline = Channels.pipeline();\n                pipeline.addLast(&quot;decoder&quot;, adapter.getDecoder());\n                pipeline.addLast(&quot;encoder&quot;, adapter.getEncoder());\n                pipeline.addLast(&quot;handler&quot;, nettyHandler);\n                return pipeline;\n            }\n        });\n        channel = bootstrap.bind(getBindAddress());\n}`, `82172932890178950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>\n        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n        bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span>channelFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">final</span> <span class="token class-name">NettyHandler</span> nettyHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NettyHandler</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        channels <span class="token operator">=</span> nettyHandler<span class="token punctuation">.</span><span class="token function">getChannels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        bootstrap<span class="token punctuation">.</span><span class="token function">setOption</span><span class="token punctuation">(</span><span class="token string">"child.tcpNoDelay"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        bootstrap<span class="token punctuation">.</span><span class="token function">setPipelineFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelPipelineFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">public</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">getPipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token class-name">NettyCodecAdapter</span> adapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NettyCodecAdapter</span><span class="token punctuation">(</span><span class="token function">getCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">NettyServer</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> <span class="token class-name">Channels</span><span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">"decoder"</span><span class="token punctuation">,</span> adapter<span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">"encoder"</span><span class="token punctuation">,</span> adapter<span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">"handler"</span><span class="token punctuation">,</span> nettyHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token keyword">return</span> pipeline<span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        channel <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">getBindAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>熟悉 Netty 框架的开发人员对上述代码一定不会陌生，这里使用 Netty 的 ServerBootstrap 完成服务启动监听，同时构建了 NettyHandler 作为其网络事件的处理器。然后 NettyServer 的 doClose 方法基于 Netty 的 boostrap 和 channel 对象完成了网络资源释放。</p>\n<p>这样我们对 Dubbo 中与网络通信相关的服务监听启动和关闭，以及发送消息的过程就有了整体的了解。</p>\n<h3 id="dubbo-客户端通信原理"><a href="#dubbo-%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%80%9A%E4%BF%A1%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dubbo 客户端通信原理</h3>\n<p>有了对前面服务器端各个技术组件的介绍，理解 Dubbo 客户端通信原理就会容易很多。我们在介绍服务器端时所引入的 Transporter 接口同时包含了对客户端方法的定义，而 Transporter 的实现类 NettyTransporter 也同时提供了 NettyClient 类，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85466270189780700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class NettyTransporter implements Transporter {\n    public static final String NAME = &quot;netty&quot;;\n\n    public Server bind(URL url, ChannelHandler listener) throws RemotingException {\n        return new NettyServer(url, listener);\n    }\n\n    public Client connect(URL url, ChannelHandler listener) throws RemotingException {\n        return new NettyClient(url, listener);\n    }\n}`, `85466270189780700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyTransporter</span> <span class="token keyword">implements</span> <span class="token class-name">Transporter</span> <span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> NAME <span class="token operator">=</span> <span class="token string">"netty"</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> listener<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NettyServer</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">Client</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> listener<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NettyClient</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>与 NettyTransporter 相关的这些核心类之间的关系下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-13-23-56-50-01ae14865b684dc759f85006d2b7c9f8-8f73d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 46.409989594172735%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABkklEQVQoz22R227iMBCGef936NUWthRWotWu1PaiVbVSRY40qUMOjoGG4BpiYoemISEQ6oBEtauORpb+8Xz6Z+yGadxb4MG2H1/MO0pDQqCmdTW1Bz0hSZKssizz0V9dv3oxr4NApTRCvuS5TxBKDUW9cL2eY/dMsxUElu8rqnqmKj8cpxOGoyxbc84RurHAT8+7HI8fXHdoGO3BoNmXmg3GlpyLjOM4KooijgmeAUohxsM0Xe33++12i2fe6+uzyPl8nOe56OF8IeZq7P8NcccYSxKeJInAjvB7mry94eVyuVrxqqpOzUe41lW1EychQ9vuOvZVGN6FszGlMcZhENyKvRyn5/t/yrI4NNfx5XyEp9PngX4uy03L+jWfh6ISRcQwO5rWUpRzqd/abPL/nI9w7Z+m74vFDOMJY1Ge1yZluRWPQsg0ijBjdLfbfQMf1ishVBCSXbc/GsmEIEFCKI+QIioIKb4vTSbGae0TXOvNptC0CwAuh6Arfg6hp/W60PUOAG1QV9oWaJvm74+PrDzEJ1aS5QpZ25rGAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 13 23 56 50" title="" data-src="/static/2024-10-13-23-56-50-01ae14865b684dc759f85006d2b7c9f8-fee1c.png" data-srcset="/static/2024-10-13-23-56-50-01ae14865b684dc759f85006d2b7c9f8-a67b7.png 200w,\n/static/2024-10-13-23-56-50-01ae14865b684dc759f85006d2b7c9f8-0b187.png 400w,\n/static/2024-10-13-23-56-50-01ae14865b684dc759f85006d2b7c9f8-fee1c.png 800w,\n/static/2024-10-13-23-56-50-01ae14865b684dc759f85006d2b7c9f8-8f73d.png 961w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>上图中的很多类我们都已经明确了，因此在介绍 Dubbo 的客户端通信原理时，不会像服务端那样做全面展开，而是更多关注于客户端本身的特性，所以我们的思路先从底层的 NettyClient 类进行切入。</p>\n<p>与 NettyServer 类类似，NettyClient 也存在一个抽象的父类 AbstractClient。作为网络客户端的通用抽象，AbstractClient 这个模板类一共提供了 doOpen、doConnect、doDisconnect、doClose、getChannel 这 5 个模板方法。与服务器端所提供的 3 个方法相比，客户端还需要实现与 Connect 这一操作相关的两个方法。</p>\n<p>NettyClient 中的 doOpen 方法如下所示，这里创建了 ClientBootstrap 并完成初始化参数设置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75707044708606160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Override\nprotected void doOpen() throws Throwable {\n        ...\n        bootstrap = new ClientBootstrap(channelFactory);\n        final NettyHandler nettyHandler = new NettyHandler(getUrl(), this);\n        bootstrap.setPipelineFactory(new ChannelPipelineFactory() {\n            public ChannelPipeline getPipeline() {\n                NettyCodecAdapter adapter = new NettyCodecAdapter(getCodec(), getUrl(), NettyClient.this);\n                ChannelPipeline pipeline = Channels.pipeline();\n                pipeline.addLast(&quot;decoder&quot;, adapter.getDecoder());\n                pipeline.addLast(&quot;encoder&quot;, adapter.getEncoder());\n                pipeline.addLast(&quot;handler&quot;, nettyHandler);\n                return pipeline;\n            }\n        });\n}`, `75707044708606160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>\n        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n        bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClientBootstrap</span><span class="token punctuation">(</span>channelFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">final</span> <span class="token class-name">NettyHandler</span> nettyHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NettyHandler</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        bootstrap<span class="token punctuation">.</span><span class="token function">setPipelineFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelPipelineFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">public</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">getPipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token class-name">NettyCodecAdapter</span> adapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NettyCodecAdapter</span><span class="token punctuation">(</span><span class="token function">getCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">NettyClient</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> <span class="token class-name">Channels</span><span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">"decoder"</span><span class="token punctuation">,</span> adapter<span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">"encoder"</span><span class="token punctuation">,</span> adapter<span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">"handler"</span><span class="token punctuation">,</span> nettyHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token keyword">return</span> pipeline<span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>和 NettyServer 一样，NettyClient 同样完成了对 Netty 框架的封装。在 NettyClient 的 doConnect 方法中，同样使用 ClientBootstrap 完成与服务端的连接和事件监听。而 doDisconnect 方法则用于移除当前已经断开连接的 Channel。然后，和 HeaderExchangeServer 类类似，在 HeaderExchangeClient 类中也添加了定时心跳收发及心跳超时监测机制。</p>\n<h2 id="解题要点-2"><a href="#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解题要点</h2>\n<p>对于远程过程调用而言，网络通信还是一个偏向于概念的技术考点。因此，在回答这类问题时，第一步需要针对网络通信这个话题本身给出一些说明和描述，这属于理论知识体系，是需要死记硬背的基础内容。基于对这一话题的了解，通常我们就可以引出一些自己比较熟悉的点，围绕这些点来进行展开和引导即可。例如，对于网络传输协议，如果你了解 ISO/OSI 模型，那就可以基于这个模型来对类似“消息头”这种自己比较熟悉的点进行发散。</p>\n<p>第二个解题要点是对网络通信实现过程进行抽象化、系统化的阐述。在目前主流的分布式服务框架中，对于网络通信模块都会有自己的一些抽象和提炼，其内部结构往往比较复杂。以本讲中介绍的 Dubbo 框架为例，就采用了明确的分层架构。每一层中都包含了一些核心的接口，这些接口之间的继承关系以及所处于的层次如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-13-23-58-54-caa89dfe805e3b7c2581d16ab246c1b8-1dace.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 770px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 70%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACLUlEQVQoz4VRXVPaQBTN/3/tS6cPtiLakdEWRFskHadaNJZ8Jwhk2WSzWQTkoyQQCPmAdAF1tA/1zM7O3Xvu2b33LCNJedP8zvM5UTxqNM4ajQLGzTRNXXekaXnLLFerOVE4uqudOM55s8mla6w2e8rUal9hK8//3q9UPmpqDmNadEcJQpCuH1rmyS2Xua7sKMqhjQqgdfNKzLLvVTUry3t89ZOuHXDcBwBkSvR6hC2/oxlJzEjirixnRWFHEEqUijeIooipN24dR7YsHkIaKIbBdbuEVkynXr3BYUeBsEoXxjJCvI2b83nQ6XQIIe12m4njZZKkvh/2+y4N4jgNgmA6nfr+LIpWNON5wZaix8UipNR4PHZd1/M8ZjDomqZiNHlJunScGkL11epxpOGwZ9uaAURJ+uk4OkJrL2i3nQ16vR6DsUqcvKp+FoUsIUUASvP5YrlM6A0ACN3uGc0L/J5lHUNYCsN4bdfT7Yxtqw8PJVXL8Xx2OPhhGCXa8MaPhPYy6LOCsM/dZEyYN+H5YhGnL8C0WkqtdmzbZfrblvVNFItxnGw5CDVgFDFmbVRGqCRLp8/UoziJk/lsMRq5bdKhQRCEzxwdz1v7Mlkv1/N9P32NtWE2UiGUFOXq/r6O7PryaaQ3wRCiEVJQ5ANZ2se4YFns1pUtVq/xrxhjnZDTm+vdX1c7AHwBoPxS/MbL0JSxU/wzvuz3L0ajC10/jaL/icMwnEwmdP7ZbPYXY/zztQAnnwoAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 13 23 58 54" title="" data-src="/static/2024-10-13-23-58-54-caa89dfe805e3b7c2581d16ab246c1b8-1dace.png" data-srcset="/static/2024-10-13-23-58-54-caa89dfe805e3b7c2581d16ab246c1b8-f7e89.png 200w,\n/static/2024-10-13-23-58-54-caa89dfe805e3b7c2581d16ab246c1b8-20ec6.png 400w,\n/static/2024-10-13-23-58-54-caa89dfe805e3b7c2581d16ab246c1b8-1dace.png 770w" data-sizes="(max-width: 770px) 100vw, 770px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>针对网络通信，我们要明确 Dubbo 框架集成了很多第三方工具，这部分工具只关注于底层的具体网络通信过程。Dubbo 把这一过程抽象成一个 Transport 层，即网络传输层。而 Dubbo 又提供了一个 Exchange 层，用于封装请求和响应，称为信息交换层。从功能职责上讲，Exchange 偏向于 Dubbo 对自身通信过程的抽象和封装，跟具体的网络通信关系不大，具体的网络传输工作都是由 Transport 层负责完成。理解 Dubbo 框架的这种设计思想和实现方式，一方面有助于提升面试内容的丰富程度，另一方面对于更好地理解框架实现原理也很有帮助。</p>\n<p>在面试过程中，我们需要确保整个针对网络通信的分析过程是理论结合实践的，如果你能够把本讲内容结合起来进行讲解，相信这道面试题会成为你区别于其他候选人的一个亮点。</p>\n<h2 id="小结与预告"><a href="#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结与预告</h2>\n<p>本讲介绍了分布式系统远程过程调用部分的第一个技术组件，即网络通信。可以说网络通信是一切分布式系统的基础，我们从网络连接、IO 模型等角度讨论了与网络通信相关的一些基本概念。</p>\n<p>本讲的核心内容是对 Dubbo 中网络通信具体实现过程的深入分析，我们从源码级别对框架中的核心类进行了展开，并明确了 Dubbo 框架在实现网络通信模块时所采用的分层架构。Dubbo 在这一维度上的分层架构为我们如何合理规划底层模块的职责和边界提供了很好的参考价值。Dubbo 中关于服务器端和客户端通信的实现过程还是比较复杂的，涉及到更底层的 Channel 等相关的操作，大家可以自己通过阅读源码进行理解。</p>\n<p>在本讲内容中，我们还留着一个伏笔，那就是序列化。任何一次网络请求过程都涉及到对数据的序列化操作。而序列化的具体实现工具很多，但这些工具背后实际上还是有一些通用的功能特性值得进行分析和总结，从而方便我们做出技术选型。下一讲我们将针对这个话题展开详细讨论。</p>\n<h1 id="序列化：如何对序列化实现工具进行正确选型？"><a href="#%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AF%B9%E5%BA%8F%E5%88%97%E5%8C%96%E5%AE%9E%E7%8E%B0%E5%B7%A5%E5%85%B7%E8%BF%9B%E8%A1%8C%E6%AD%A3%E7%A1%AE%E9%80%89%E5%9E%8B%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>序列化：如何对序列化实现工具进行正确选型？</h1>\n<p>在上一讲中，我们对远程过程调用中客户端与服务器端的网络通信过程进行了详细的讨论。借助于分布式服务框架，我们可以实现不同服务之间跨网络的交互和协作。网络通信涉及到数据的有效传输，这就需要引入另一个技术组件，即序列化。而目前关于如何实现序列化和反序列化，业界也诞生了一大批工具和框架。</p>\n<p>那么，序列化是一种什么样的技术组件？我们又应该如何对种类繁多的序列化实现工具进行正确选型呢？这是面试官经常会抛出的一个面试话题。本讲内容将围绕这一话题展开讨论。</p>\n<h2 id="问题背景"><a href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题背景</h2>\n<p>在现实中，我们通常会使用 Dubbo、Spring Cloud 等开源框架，以及 TCP、HTTP 等网络传输协议来发起远程调用。对于这些框架和协议而言，客户端发起请求的方式，以及服务端返回响应结果的处理过程都是不一样的。但是这里存在一个共同点，即无论采用何种开发框架和网络传输协议，都涉及到业务数据在网络中的传输，这就需要应用到序列化技术。和上一讲介绍到的网络通信不同，序列化技术是直接面向开发人员的，我们可以对具体的序列化工具和框架进行选择，而不像网络通信过程那样只能依靠框架底层所封装的能力。对于序列化技术而言，这种差异性导致了面试过程不仅仅只会考查对技术本身的了解程度，而是更多会讨论如何对序列化工具进行合理选择。</p>\n<p>目前，序列化工具很多，据统计已经不下 100 种。在面试过程中显然无法对具体的实现工具进行一一罗列。因此，关于序列化技术的考查方式是比较灵活的，需要候选人有足够的知识面，了解目前业界主流的序列化技术。更为重要的，候选人还需要具备综合的抽象思维，能够将不同的工具按照一定的维度进行分类，从不同的功能特性角度出发进行分析。</p>\n<p>从面试角度讲，关于序列化技术的常见考查方式包括：</p>\n<ul>\n<li>你知道哪些序列化工具，它们各自有什么特性？</li>\n<li>你在选择序列化工具时，重点会考虑哪些方面的要素？</li>\n<li>为什么像 Protobuf、Thrift 这些序列化工具会采用中间语言技术？</li>\n<li>如果只考虑性能，你会选择哪款序列化工具？</li>\n<li>Google 的 Protobuf 为什么会那么快？</li>\n</ul>\n<p>可以看到，这些面试题既包括对序列化技术原理和实现方法的考查，也会涉及到具体某一个工具框架的细节。从我的面试经验而言，能够回答比较顺畅的候选人并不是很多，需要大家在平时的工作中不断积累。</p>\n<h2 id="问题分析-1"><a href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题分析</h2>\n<p>究竟什么是序列化？我们可以简单把它理解为是一种从内存对象到字节数据的转换过程。通过序列化，我们就可以把数据变成可以在网络上进行传输的一种媒介，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-16-11-52-42-d67df193e7a1c32d91679e56fb2affb3-f0556.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 596px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 37.41610738255034%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABS0lEQVQoz3VRXU/CQBDs//8fBjUaHo08KJJAAorQlhZogZ5AOUpbgWLTD2nH7YUmKHGTub3c3sztzkk4RZ7n+Buu62Axn8GyTJjmEIuFhY3DL+4V3JIv5XmGElmWIY4jpGlKyGAYTXibGoxxFd3XK6z5A0bDuiCmaYIoipAkCc41pMuuPDDGsN8HaLcbJNAiwTYUuQHToKx0RM22bTiOC86dX3zJdTmJLAk2fH+F1YoRbIRhSK+nKCaJohRB8CUIx2MmavP5ByYTHdvP9Ym/hOdxSN23W0zMKuR+BXKvQl3cYzodlO6INY5jHA4HsS9sKYKxMbTBDYbaHVT5GqpSwWz6CMkYd2mcF/R7dXQ6NehaE7udfzI7+1cwCLbQ9Zbg9d6fCU9glgIpDCPyZYDRyIRM2fd3Fz93LliclaK2zdGXVSiqRuPPyKJv/ACTHQ0Prv+kQgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 16 11 52 42" title="" data-src="/static/2024-10-16-11-52-42-d67df193e7a1c32d91679e56fb2affb3-f0556.png" data-srcset="/static/2024-10-16-11-52-42-d67df193e7a1c32d91679e56fb2affb3-ae33b.png 200w,\n/static/2024-10-16-11-52-42-d67df193e7a1c32d91679e56fb2affb3-daf23.png 400w,\n/static/2024-10-16-11-52-42-d67df193e7a1c32d91679e56fb2affb3-f0556.png 596w" data-sizes="(max-width: 596px) 100vw, 596px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在上图中，我们注意到还有一个反序列化的概念。所谓反序列化，实际上就是序列化的逆向过程，把从网络上获取的字节数据再次转化为可以供内存使用的业务对象。</p>\n<p>序列化的方式有很多，实现工具也非常丰富，常见的如下表所示：</p>\n<table>\n<thead>\n<tr>\n<th align="left">序列化工具</th>\n<th align="left">简要描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">Java Serializable</td>\n<td align="left">JDK 自带序列化工具</td>\n</tr>\n<tr>\n<td align="left">Hessian</td>\n<td align="left">Dubbo 框架默认序列化工具</td>\n</tr>\n<tr>\n<td align="left">Protobuf</td>\n<td align="left">gRPC 框架默认序列化工具</td>\n</tr>\n<tr>\n<td align="left">Thrift</td>\n<td align="left">Facebook 跨语言序列化工具</td>\n</tr>\n<tr>\n<td align="left">Jackson</td>\n<td align="left">Spring 框架默认序列化工具</td>\n</tr>\n<tr>\n<td align="left">FastJson</td>\n<td align="left">阿里巴巴高性能序列化工具</td>\n</tr>\n</tbody>\n</table>\n<p>上表罗列的也只是一些最主流的序列化工具，其他可供开发人员使用的工具和框架还有很多。虽然这些工具的定位和作用是类似的，但所具备的特性却不尽相同。这就涉及到日常开发过程中开发人员经常要面对的一个问题，即技术选型问题。</p>\n<p>关于技术选型，我们的思路首先是确定所需要考虑的技术维度。在序列化领域，我们可以抽象出三个技术维度。</p>\n<ul>\n<li>功能：包括支持的序列化数据表现形式、数据结构等。</li>\n<li>性能：包括空间复杂度和时间复杂度等。</li>\n<li>兼容性：包括版本号机制等。</li>\n</ul>\n<p>基于上述三个技术维度，我们回答这类面试题的思路就有了。而从这三个技术维度的描述出发，我们也不难看出每一个技术维度还可以继续进行细分，接下来，让我们来对具体的技术体系展开讨论。</p>\n<h2 id="技术体系-3"><a href="#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术体系</h2>\n<p>序列化工具和框架各有特色，但它们所采用的数据表现形式一般分成两大类，即具备可读性的文本类，以及不具备可读性的二进制类。对于前者，代表性的框架有 Jackson 和 FastJson，它们都采用了 JSON 作为数据表现形式。而后者则包括 Protobuf、Thrift 等。开发人员往往对序列化工具的数据表现形式比较在意，因为这直接决定了我们是否可以直接人为对数据的正确性进行判断。显然，数据的表现形式是序列化工具的一大功能特性，但并不是最重要的功能特性。接下来，就让我们先从序列化的核心功能开始展开讨论。</p>\n<h3 id="序列化的功能"><a href="#%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E5%8A%9F%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>序列化的功能</h3>\n<p>在选择序列化工具时，功能完整度是我们首先要考虑的一个技术维度，具体的关注点包括：</p>\n<ul>\n<li>数据结构的丰富程度；</li>\n<li>开发的友好性；</li>\n<li>对异构平台的支持性。</li>\n</ul>\n<p>我们首先来看数据结构，这方面的功能差异性主要体现在是否对一些复杂数据结构的支持。常见的复杂数据结构包括泛型结构以及 Map/List 等集合结构。我们来看如下所示的一个具体的示例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78533233785335740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class User {\n    public int id;\n    public String username;\n    public List<Link> links;\n    public Map result;\n}\n\npublic class Link {\n    public String name;\n    public String phone;\n}`, `78533233785335740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>\n    <span class="token keyword">public</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>\n    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Link</span><span class="token punctuation">></span></span> links<span class="token punctuation">;</span>\n    <span class="token keyword">public</span> <span class="token class-name">Map</span> result<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Link</span> <span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>\n    <span class="token keyword">public</span> <span class="token class-name">String</span> phone<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，这里定义了一个 User 对象，而这个 User 对象中又分别包含了一个 List 结构和一个 Map 结构，其中 List 结构所指向的还是一组自定义对象 Link。针对这种复杂数据结构，如果我们使用 FastJson 来进行序列化，那么如下所示的代码是可以正常运作的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21200742467164058000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`User user = new User();\n// 省略对 user 对象进行赋值\n// 将对象转化为 JSON 字符串\nString str = JSON.toJSONString(user);\n// 将 JSON 字符串转成对象\nUser myuser = JSON.parseObject(str, User.class);`, `21200742467164058000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 省略对 user 对象进行赋值</span>\n<span class="token comment">// 将对象转化为 JSON 字符串</span>\n<span class="token class-name">String</span> str <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 将 JSON 字符串转成对象</span>\n<span class="token class-name">User</span> myuser <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>而如果我们使用 Protobuf，那么这种复杂数据结构是无法支持的。如果想要使用 Protobuf，需要对这个数据结构进行调整，将 List 换成更为通用的数据结构。另一方面，针对 Protobuf 框架，我们也可以引出下一个我们要讨论的功能点，即开发的友好性。</p>\n<p>开发友好性用来衡量工具本身对于开发人员实现序列化的开发难易程度。就像前面示例所展示的，我们在使用 FastJson 时，通过几行代码就能实现对象的序列化和反序列化。而有些工具则不一定，以 Protobuf 为例，在使用该工具时，我们首先要做的是定义一种中间语言，示例如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89429479379383320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`syntax = &quot;proto3&quot;;\n\nmessage Student\n{\n    int32 id= 1;\n    string name = 2;\n    int32 sex = 3;\n    string hobby = 4;\n    string skill = 5;\n}`, `89429479379383320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="protobuf"\n              >\n                <span class="gatsby-code-button-language">protobuf</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="protobuf"><pre style="counter-reset: linenumber NaN" class="language-protobuf line-numbers"><code class="language-protobuf"><span class="token keyword">syntax</span> <span class="token operator">=</span> <span class="token string">"proto3"</span><span class="token punctuation">;</span>\n\n<span class="token keyword">message</span> <span class="token class-name">Student</span>\n<span class="token punctuation">{</span>\n    <span class="token builtin">int32</span> id<span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token builtin">string</span> name <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>\n    <span class="token builtin">int32</span> sex <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>\n    <span class="token builtin">string</span> hobby <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>\n    <span class="token builtin">string</span> skill <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里的 <code class="language-text">syntax=&quot;proto3&quot;</code> 表示运用 proto3 版本的语法，而 message 类似于 Java 中的 Class。在开发过程中，我们需要将这段中间语言保存为一个 student.proto 文件，然后再通过 Protobuf 的 protoc 命令将它转化为 Java 文件才能使用，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87364577628936010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`protoc --java_out=. student.proto`, `87364577628936010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">protoc --java_out<span class="token operator">=</span>. student.proto</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>可以看到，中间语言所带来的开发复杂度是显而易见的。使用中间语言的典型工具还包括 Thrift，它需要事先提供一个 .thrift 文件。</p>\n<p>讲到这里，你可能会问，为什么 Protobuf 和 Thrift 要使用中间语言呢？原因就在于它们基于中间语言提供了一项重要的技术特性，即跨语言的异构性。</p>\n<p>异构性的需求来自分布式系统中技术架构和实现方式的多样性。原则上，每个服务都可以基于不同的技术体系进行实现，这些技术体系所采用的开发语言可能都是不一样的，这时候就需要引入支持多语言的序列化工具，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-16-11-57-19-691b9053c54ee4b876e2d256040bec7c-94c27.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 616px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 47.07792207792208%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABX0lEQVQoz31S+0+CUBj1//8jyt+q2Vbz1cqGzWTgA13KK3nY2kJq6hIBE8TTvYimGX3scrh35zt85+xm8KvW63WMk8kHhFYO+qCMJn+OrnAJVSlioBYgS42EG9H3rodW5lgwinE8tiH2r2C9Magyp3ioZqHIBbKvQJb5HXdfLEVwQ4iiCPP5HK7rEnTgeS5838NsNkMQBAfcfyfcJywWSyKygGXZ0DQj3nuef8CjT+qEMSERc10fz2oNpnGH3lMeQptmeItu55rk+37E3wluc9hgFFul5TguFOUe2qBAhEqQxDzarQuyzjCd2kksq13fVuNPy4kmsalDVVWMRiNi28JwaEKS5DiGtMpIIkts8dA1LkbTaJBpGIgin9qkKG1yAxjyQ47EwsZo6Dw5Y5HpCDmswhaGZhH12gleX8pYfnEktxLC8CcGuug3Pev3buB7dTifj+DYLOxRBWHQBNX6Bi/zqBWKLxeEAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 16 11 57 19" title="" data-src="/static/2024-10-16-11-57-19-691b9053c54ee4b876e2d256040bec7c-94c27.png" data-srcset="/static/2024-10-16-11-57-19-691b9053c54ee4b876e2d256040bec7c-64932.png 200w,\n/static/2024-10-16-11-57-19-691b9053c54ee4b876e2d256040bec7c-2fd6e.png 400w,\n/static/2024-10-16-11-57-19-691b9053c54ee4b876e2d256040bec7c-94c27.png 616w" data-sizes="(max-width: 616px) 100vw, 616px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>实际上，很多场景下我们之所以不选择 JDK 自带的序列化机制，很重要的一个原因就在于它只能支持 Java 语言。而基于 Protobuf 等工具所提供的中间语言机制，我们可以生成面向不同语言的序列化数据，包括 C++、JAVA、Python、Objective C、C#、Ruby、PHP、JavaScript 等，我们也可以找到几乎涵盖所有其他语言的第三方拓展包。</p>\n<p>另一方面，无论是数据结构的丰富程度，还是开发友好性，这些功能特性与跨语言支持之间往往是存在一定矛盾的。举个例子，要想支持多语言，那么就必须采用那些非常通用的数据结构，确保所有语言都内置了对这些数据结构的支持。这样的话，诸如前面提到的 Map/List 等复杂数据结构显然就不合适了。</p>\n<h3 id="序列化的性能"><a href="#%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E6%80%A7%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>序列化的性能</h3>\n<p>在日常开发过程中，我们在选择序列化工具时往往会把性能作为一项重要的指标进行考虑。对于序列化的性能而言，我们关注两个指标，即：</p>\n<ul>\n<li>时间复杂度：表示序列化/反序列化执行过程的速度。</li>\n<li>空间复杂度：表示序列化数据所占有的字节大小。</li>\n</ul>\n<p>对于日常开发过程中经常使用的一些序列化工具，我们可以列举了它们在性能上的一些量化数据，如下表所示：</p>\n<table>\n<thead>\n<tr>\n<th align="left"></th>\n<th align="left">时间复杂度（序列化）</th>\n<th align="left">时间复杂度（反序列化）</th>\n<th align="left">空间复杂度</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">Java</td>\n<td align="left">8654</td>\n<td align="left">43787</td>\n<td align="left">889</td>\n</tr>\n<tr>\n<td align="left">Hessian</td>\n<td align="left">6725</td>\n<td align="left">10460</td>\n<td align="left">501</td>\n</tr>\n<tr>\n<td align="left">Protobuf</td>\n<td align="left">2964</td>\n<td align="left">1745</td>\n<td align="left">239</td>\n</tr>\n<tr>\n<td align="left">Thrift</td>\n<td align="left">3177</td>\n<td align="left">1949</td>\n<td align="left">349</td>\n</tr>\n<tr>\n<td align="left">Jackson</td>\n<td align="left">3052</td>\n<td align="left">4161</td>\n<td align="left">503</td>\n</tr>\n<tr>\n<td align="left">Fastjson</td>\n<td align="left">2595</td>\n<td align="left">1472</td>\n<td align="left">468</td>\n</tr>\n</tbody>\n</table>\n<p>通过对比，我们注意到在时间复杂度上可以优先选择阿里巴巴的 FastJson，而在空间复杂度上 Google 的 Protobuf 则具备较大的优势。</p>\n<h3 id="序列化的兼容性"><a href="#%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E5%85%BC%E5%AE%B9%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>序列化的兼容性</h3>\n<p>关于序列化技术最后需要讨论的一个话题是兼容性。</p>\n<p>我们知道随着业务系统的不断演进，服务中所定义的接口以及数据结构也不可避免会发生变化。通常，在分布式服务开发过程中，我们会引入版本概念来应对接口和数据结构的调整。在序列化工具中，我们同样需要考虑版本。这方面比较典型的例子就是 JDK 自带的序列化版本 Id。一旦我们在类定义中实现了 Serializable 接口，JDK 就提示你需要指定一个序列化版本 Id，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47970622822188870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class MyObject implements Serializable {\n    // 唯一的序列化版本号\n    private static final long serialVersionUID = -1127800498182345096L;\n}`, `47970622822188870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyObject</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 唯一的序列化版本号</span>\n    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1127800498182345096L</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>基于这种显式的版本号机制，在序列化时，如果对象之间的版本 Id 不一致，那么 JVM 就会抛出一个 InvalidCastException 的异常；反之则可以正常进行转换。</p>\n<p>有些序列化工具虽然没有明确指定版本号的概念，但也能实现前向兼容性，比较典型的就是 Protobuf。</p>\n<h2 id="源码解析-1"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h2>\n<p>介绍完序列化的相关技术体系，让我们再次回到具体的分布式开源框架，来看看业界主流的框架是如何实现序列化过程的。这里还是以阿里巴巴的 Dubbo 框架为例展开讨论。</p>\n<p>在上一讲中，我们介绍了 Dubbo 框架中的 Remoting 模块。作为回顾，我们给出该模块的组成结构图，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-16-14-34-22-12cc3b13f1db81a7e75dc3bf03a93527-b2673.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 620px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 16.451612903225808%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsSAAALEgHS3X78AAAA0ElEQVQI1yXNyU7CUACF4b7/W4gxIAE3MrVhoREELHQekJbetgpSh8jeW36vsjibc3LyaVJK6rpGyh9OJyjLNa7dxVp2iEKd3W7P5vmO6vBAujEI/FvSxCCOBoRBjyjos46HHN4mvL7cowX+GM/t/Y9p4jKdGHhOk6V5pU59tpnA99Tut5lNL7BXTSyVxazBYn7J/LGBY7WIwxsKMUD7+tzz8V5SVTnH4zdJYiugw8psKWCMEIXCRuRiSLYdUeQ65tMfeI3rdBHZucuFTlkY/AIIGM6+rMFaqwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 16 14 34 22" title="" data-src="/static/2024-10-16-14-34-22-12cc3b13f1db81a7e75dc3bf03a93527-b2673.png" data-srcset="/static/2024-10-16-14-34-22-12cc3b13f1db81a7e75dc3bf03a93527-fcc72.png 200w,\n/static/2024-10-16-14-34-22-12cc3b13f1db81a7e75dc3bf03a93527-3d8b3.png 400w,\n/static/2024-10-16-14-34-22-12cc3b13f1db81a7e75dc3bf03a93527-b2673.png 620w" data-sizes="(max-width: 620px) 100vw, 620px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可以看到，在 Remoting 模块中还剩下一个 Serialize 组件没有介绍，从命名上我们不难看出该组件与序列化相关。事实上，Dubbo 提供了 Serialization 接口（位于 dubbo-common 代码工程中）作为对序列化的抽象。而对应的序列化和反序列化操作的返回值分别是 ObjectOutput 和 ObjectInput，其中 ObjectInput 扩展自 DataInput，用于读取对象；而 ObjectOutput 扩展自 DataOutput，用于写入对象，这两个接口的定义如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96842782119057230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface ObjectInput extends DataInput {\n    Object readObject() throws IOException, ClassNotFoundException;\n    <T> T readObject(Class<T> cls) throws IOException, ClassNotFoundException;\n    <T> T readObject(Class<T> cls, Type type) throws IOException, ClassNotFoundException;\n}\n\npublic interface ObjectOutput extends DataOutput {\n    void writeObject(Object obj) throws IOException;\n}`, `96842782119057230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ObjectInput</span> <span class="token keyword">extends</span> <span class="token class-name">DataInput</span> <span class="token punctuation">{</span>\n    <span class="token class-name">Object</span> <span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">;</span>\n    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">readObject</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> cls<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">;</span>\n    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">readObject</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> cls<span class="token punctuation">,</span> <span class="token class-name">Type</span> type<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ObjectOutput</span> <span class="token keyword">extends</span> <span class="token class-name">DataOutput</span> <span class="token punctuation">{</span>\n    <span class="token keyword">void</span> <span class="token function">writeObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 Serialization 接口的定义上，可以看到 Dubbo 中默认使用的序列化实现方案基于 hessian2。Hessian 是一款优秀的序列化工具。在功能上，它支持基于二级制的数据表示形式，从而能够提供跨语言支持；在性能上，无论时间复杂度还是空间复杂度也比 Java 序列化高效很多，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-16-14-35-05-2f0d5723e482a336f1ed1567a7c3aa67-b2673.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 620px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 27.580645161290324%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABYUlEQVQY0yWRW0/CQBSE+/9/hxqjIom3IJr4gIC00FZa29oWCEGsUm4WULDi52F9mJzdTWbOzKwW+GW8p3/43g1m64wocgnDCM/zWK1W1Ot1fN9nOBxiWSZ5vsVpVwVXirPjPrllXOcaDSy+Nwb5Rmd3BhPbviNNZ0wmY8bjsRJKkkTuE5bLhcw5j/YFP3lDuDr5t8Hv1hSuixYGZ+iNA4VOfMX2pyku7hiNJry/v4nbiE6nw2AwII5jgiDAcTxqtWPi8JyH2h4t45Ao3C0w0Qb9Eq8vtzyL8HLxoFyWSodC7jGdTlXUbrerXPb7fSWeJCNxeMmzX1RCTrvAx7wq3PYusg2/EnttqAd4xDDKIpaRZR/MZjMVNU1TNReLjPU6l85KrL/qqq6vzwZKBw/Ntk5pGgX5jFNBker9vpTcwnU9gSuiGZVKhV6vJ93aErXKZpOj6zey+AjLLCq0mgXROeEPX1SrIg5U0bYAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 16 14 35 05" title="" data-src="/static/2024-10-16-14-35-05-2f0d5723e482a336f1ed1567a7c3aa67-b2673.png" data-srcset="/static/2024-10-16-14-35-05-2f0d5723e482a336f1ed1567a7c3aa67-fcc72.png 200w,\n/static/2024-10-16-14-35-05-2f0d5723e482a336f1ed1567a7c3aa67-3d8b3.png 400w,\n/static/2024-10-16-14-35-05-2f0d5723e482a336f1ed1567a7c3aa67-b2673.png 620w" data-sizes="(max-width: 620px) 100vw, 620px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在 Dubbo 中，Hessian2Serialization 类实现了 Serialization 接口，我们就以该类为例介绍 Dubbo 中具体的序列化/反序列化实现方法。Hessian2Serialization 类定义如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37269650397069574000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class Hessian2Serialization implements Serialization {\n    public static final byte ID = 2;\n    public byte getContentTypeId() {\n        return ID;\n    }\n\n    public String getContentType() {\n        return &quot;x-application/hessian2&quot;;\n    }\n\n    public ObjectOutput serialize(URL url, OutputStream out) throws IOException {\n        return new Hessian2ObjectOutput(out);\n    }\n\n    public ObjectInput deserialize(URL url, InputStream is) throws IOException {\n        return new Hessian2ObjectInput(is);\n    }\n}`, `37269650397069574000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hessian2Serialization</span> <span class="token keyword">implements</span> <span class="token class-name">Serialization</span> <span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span> ID <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>\n    <span class="token keyword">public</span> <span class="token keyword">byte</span> <span class="token function">getContentTypeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> ID<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token string">"x-application/hessian2"</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">ObjectOutput</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">OutputStream</span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Hessian2ObjectOutput</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">ObjectInput</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">InputStream</span> is<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Hessian2ObjectInput</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Hessian2Serialization 中的 serialize 和 deserialize 方法分别创建了 Hessian2ObjectOutput 和 Hessian2ObjectInput 类。以 Hessian2ObjectInput 为例，该类使用 Hessian2Input 完成具体的反序列化操作，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40229916625590720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class Hessian2ObjectInput implements ObjectInput {\n    private final Hessian2Input mH2i;\n\n    public Hessian2ObjectInput(InputStream is) {\n        mH2i = new Hessian2Input(is);\n        mH2i.setSerializerFactory(Hessian2SerializerFactory.SERIALIZER_FACTORY);\n    }\n\n    // 省略各种读取具体数据类型的工具方法\n\n    public Object readObject() throws IOException {\n        return mH2i.readObject();\n    }\n\n    public <T> T readObject(Class<T> cls) throws IOException,\n            ClassNotFoundException {\n        return (T) mH2i.readObject(cls);\n    }\n\n    public <T> T readObject(Class<T> cls, Type type) throws IOException, ClassNotFoundException {\n        return readObject(cls);\n    }\n}`, `40229916625590720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hessian2ObjectInput</span> <span class="token keyword">implements</span> <span class="token class-name">ObjectInput</span> <span class="token punctuation">{</span>\n    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Hessian2Input</span> mH2i<span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">Hessian2ObjectInput</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> is<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        mH2i <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hessian2Input</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        mH2i<span class="token punctuation">.</span><span class="token function">setSerializerFactory</span><span class="token punctuation">(</span><span class="token class-name">Hessian2SerializerFactory</span><span class="token punctuation">.</span>SERIALIZER_FACTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 省略各种读取具体数据类型的工具方法</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> mH2i<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">readObject</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> cls<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span>\n            <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> mH2i<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">readObject</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> cls<span class="token punctuation">,</span> <span class="token class-name">Type</span> type<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token function">readObject</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Hessian2Input 是 Hessian2 的实现库 com.caucho.hessian 中的工具类，初始化时需要设置一个 SerializerFactory，所以我们在这里还看到存在一个 Hessian2SerializerFactory 工厂类，专门用于设置 SerializerFactory。而在 Hessian2ObjectInput 中，各种以 read 为前缀的方法实际上都是对 Hessian2Input 中相应方法的封装。</p>\n<p>用于执行反序列化的 Hessian2ObjectOutput 与 Hessian2ObjectInput 类也比较简单，这里不再展开。</p>\n<p>关于 Dubbo 序列化的另一条代码支线是 Codec2 接口，该接口位于 dubbo-remoting-api 代码工程中，提供了对网络编解码的抽象，而编解码过程显然需要依赖 Serialization 接口作为其数据序列化的手段。我们可以通过如下所示的代码片段来回顾这一点，这段代码来自 DubboCodec 中的 decodeBody 方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77073243360634300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class DubboCodec extends ExchangeCodec implements Codec2 {\n\n    protected Object decodeBody(Channel channel, InputStream is, byte[] header) throws IOException {\n        // 获取序列化对象\n        Serialization s = CodecSupport.getSerialization(channel.getUrl(), proto);\n    }\n}`, `77073243360634300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DubboCodec</span> <span class="token keyword">extends</span> <span class="token class-name">ExchangeCodec</span> <span class="token keyword">implements</span> <span class="token class-name">Codec2</span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">decodeBody</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">InputStream</span> is<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> header<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 获取序列化对象</span>\n        <span class="token class-name">Serialization</span> s <span class="token operator">=</span> <span class="token class-name">CodecSupport</span><span class="token punctuation">.</span><span class="token function">getSerialization</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> proto<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>那么，这里的 Codec 和 Serialization 如何与上一讲中介绍的 Exchange 和 Transport 结合起来构成一个完整的链路呢？我们可以明确一点，序列化和编解码过程在网络传输层和信息交换层中都应该存在。因此，我们快速来到 <code class="language-text">dubbo-remoting-api</code> 代码工程的 <code class="language-text">META-INF/dubbo/internal</code> 文件夹，发现存在一个 org.apache.dubbo.remoting.Codec2 配置文件，内容如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36659729442755305000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`transport=org.apache.dubbo.remoting.transport.codec.TransportCodec\ntelnet=org.apache.dubbo.remoting.telnet.codec.TelnetCodec\nexchange=org.apache.dubbo.remoting.exchange.codec.ExchangeCodec`, `36659729442755305000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">transport=org.apache.dubbo.remoting.transport.codec.TransportCodec\ntelnet=org.apache.dubbo.remoting.telnet.codec.TelnetCodec\nexchange=org.apache.dubbo.remoting.exchange.codec.ExchangeCodec</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>org.apache.dubbo.remoting.Codec2 配置文件用来执行 SPI 机制，我们会在之后对这个主题进行专项介绍，这里只需要明白 Dubbo 采用这种配置方式来动态加载运行时的类对象。在这里，可以看到 Dubbo 针对 exchange 和 transport 都提供了 Codec 支持。</p>\n<h2 id="解题要点-3"><a href="#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解题要点</h2>\n<p>从解题思路上讲，序列化是一个相对比较容易把握的面试题。基于本讲关于序列化技术组件的讨论，我们发现有很多列表式的内容需要记忆。这部分内容需要大家平时多看一些资料，尽量扩展自己的知识面，这是针对这一主题的第一个解题要点。关于序列化相关工具之间的对比也有一个非常好的<a href="https://github.com/eishay/jvm-serializers/wiki" target="_blank" rel="nofollow noreferrer noopener">汇总资料</a></p>\n<p>但也正是因为序列化本身是一个内容比较固化的主题，所以在解题上就不能完全照本宣科。只讲概念，而不给出自己的一些思考和总结，往往体现不出你和其他候选人之间的差别，这也是日常面试过程中需要注意的一个点。因此，针对这类题的第二个解题要点在于要事先用自己的语言来梳理回答问题的内容体系，重点展示自己对于这一技术主题的抽象和分析能力。针对技术选型类面试题，更加需要明确给出自己的判断。</p>\n<h2 id="小结与预告-1"><a href="#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结与预告</h2>\n<p>但凡开发分布式和微服务应用，就一定会使用到序列化技术。可以说，序列化技术是我们开发互联网应用程序的基础设施类技术之一。序列化的实现工具有很多，本讲内容并不是介绍具体的某一个工具，而是从功能、性能以及兼容性等维度出发对这些工具进行分析，从而帮助你更好的进行选择。</p>\n<p>具备了网络通信和序列化技术，接下来我们就可以实现一个简单的远程调用过程了。那么，如果让你自己设计一个简单的 RPC 架构，你会怎么做呢？这就是我们下一讲要探讨的内容。</p>\n<h1 id="远程调用：如果让你自己设计一个简单的-rpc-架构，你会怎么做？"><a href="#%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%EF%BC%9A%E5%A6%82%E6%9E%9C%E8%AE%A9%E4%BD%A0%E8%87%AA%E5%B7%B1%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-rpc-%E6%9E%B6%E6%9E%84%EF%BC%8C%E4%BD%A0%E4%BC%9A%E6%80%8E%E4%B9%88%E5%81%9A%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>远程调用：如果让你自己设计一个简单的 RPC 架构，你会怎么做？</h1>\n<p>任何分布式系统的开发都涉及到跨进程之间的远程过程调用，也就是所谓的 RPC。前面两讲我们讨论的网络通信和序列化实际上也都属于是 RPC 架构的范畴，只是关注于不同的技术切入点。而 RPC 本身也构成一种架构体系，包含一系列相互协作的核心组件。在 Dubbo、Spring Cloud 等主流的分布式服务框架中，这些技术组件使用起来都非常简单，因为框架为开发人员屏蔽了底层的实现细节。</p>\n<p>那么，现在假如没有这些开源框架，而是需要你自己来设计并实现一套远程过程调用机制，你应该怎么做的？我认为这是一个很好的面试题，考查了候选人的综合技术能力。本讲内容将围绕这个话题展开详细讨论。</p>\n<h2 id="问题背景-1"><a href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题背景</h2>\n<p>在分布式系统中，服务与服务之间需要通过远程调用来完成一个个具体的业务操作。这是一个全流程的执行过程，涉及到前面介绍到的网络通信和序列化技术，也涉及到本讲内容要进一步阐述的远程调用中的不同技术组件。</p>\n<p>在使用 Dubbo、Spring Cloud 等框架时，你可能并没有感受到远程调用过程是如何执行的，因为这些框架都提供了“远程调用本地化”机制，开发人员调用远程方法感觉和调用本地方法并没有什么差别。这是框架所具备的能力，我们直接使用即可。但从面试角度讲，如果只考查框架的使用方式，显然无法真正判断候选人的技术能力。因此，在面试过程中，面试官通常都会暂时抛开框架的具体使用方式，而从远程调用的基本概念和执行流程出发来进行提问。</p>\n<p>针对这类面试题，如果候选人没有做精心的准备，往往很难回答到位，原因就在于我们平时不大会从这一角度入手考虑问题，也就不会重点关注相关的技术体系。从面试角度讲，这道题也存在一些灵活的提问方式，包括：</p>\n<ul>\n<li>想要实现远程调用，整个流程应该包含那些基本的技术组件？</li>\n<li>RPC 架构的组成结构是怎么样的？</li>\n<li>如果让你设计一个简单的 RPC 架构，你会怎么做？</li>\n<li>你认为 Dubbo 框架中最核心的组件有哪些？</li>\n</ul>\n<p>RPC 这个概念我们一直都在说，但面对这一概念，我们应该如何进行系统化的学习呢？我们接下来对这个问题进行分析。</p>\n<h2 id="问题分析-2"><a href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题分析</h2>\n<p>远程过程调用，英文即为 Remote Procedure Call，也就是我们通常所说的 RPC，这个名词第一次出现是在 1974 年。从诞生到今天，RPC 架构存在了 40 多年，已经演变成一切分布式系统的基础性架构。而围绕 RPC 架构的基本概念，这么多年以来实际上并没有发生大的变化。所以，关于 RPC 架构本身的学习内容和范围是相对固定的，这是我们首先需要明确的一点。</p>\n<p>从面试角度讲，RPC 架构最应该掌握的是它的基本组成结构。作为一种架构模式，业界已经对 RPC 架构的各个组成部分进行了抽象和提炼，从而形成一套完整的组件体系。正是基于这套 RPC 的组件体系，业界诞生了各种具体实现框架，Dubbo 就是其中的代表。而无论 Dubbo 等框架如何实现，其底层的组成结构是完全遵循 RPC 架构的。因此，只要掌握了 RPC 架构的组成结构，关于这类问题的大部分内容我们已经可以回答了。</p>\n<p>事实上，基于 RPC 的组成结构，任何人都可以自己实现一套 RPC 框架。我们可以采用最简单、最常见的技术体系实现一个最基础的 RPC 架构。通过这一过程，一方面可以确保具体的实现技术和纯粹的理论体系能够对应起来；另一方面，在面试过程中，这也是凸显出个人优势的一个加分项，能够提升面试官对候选人的认可程度。</p>\n<p>好了，讲到这里，相信你已经具备了针对这类问题的解答思路。接下来要讨论的就是具体的技术体系了，让我们从 RPC 架构的组成结构开始讲起。</p>\n<h2 id="技术体系-4"><a href="#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术体系</h2>\n<p>如果我们站在最高的层次来看 RPC 的执行流程，就是一个服务的消费者向服务的提供者发起远程调用并获取返回结果的过程，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-17-10-34-44-c63aaaa80662443f601466425b622445-f1382.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 533px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 19.69981238273921%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAA0ElEQVQY032P206DUBBF+f9fMdISrzH+gBKgHKsBirTSpp62CZTCE7flgLE+6SSTyc7sNReDf6Lve5qmIQgCwjCkKIqfzp+MEUUO63RGKjnUzdonXtgcj9nZVNc1VVWd9bAkSXzxeyPzzXsk7w7G2+sU/XkvwiKJp3wsrzjsHlDqidOpIssytNYCpOR5TlmWuK7HyG3vWAoXRybbzS07/YhhP1sof4LrXOK5Jv5swouyWK0W8vLvdcPgtm3puo79/iDeG/GaI+PYF8yFmatrvgBqlSYZbA+6IAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 17 10 34 44" title="" data-src="/static/2024-10-17-10-34-44-c63aaaa80662443f601466425b622445-f1382.png" data-srcset="/static/2024-10-17-10-34-44-c63aaaa80662443f601466425b622445-7cec2.png 200w,\n/static/2024-10-17-10-34-44-c63aaaa80662443f601466425b622445-dfa51.png 400w,\n/static/2024-10-17-10-34-44-c63aaaa80662443f601466425b622445-f1382.png 533w" data-sizes="(max-width: 533px) 100vw, 533px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>接下来，如果我们把上图做一些展开。通过之前的学习，我们知道服务提供者需要暴露服务访问的入口，而消费者则会向提供者所暴露的访问入口发起请求。如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-17-10-35-20-492d8de3aca701cb6350cbc666ab2535-e07da.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 611px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 15.548281505728315%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsSAAALEgHS3X78AAAAuElEQVQI1x2O3QqCQBCFff8X6S4ydVWKAhW6qyhy/df1f1fBRzjNejEw83HOxxhNHWBRIU0E0VyRpS6K3IOUIZSMMPRXbNuIZekwjXfIWfNwz+is7uickgH6/gEj4QxN5aCuGMrcoqCFNDGJEa9ddK2DdRUYh4Lk3s4ETVU4yLMzysJGXTLK6UcuMHjsEnDo0FIX83SjkkcFhiyx8X4eoFRDwhIv2r+fI/jvtItb4ZPUBo/NXZ5wH3/SAdDEWRMD0AAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 17 10 35 20" title="" data-src="/static/2024-10-17-10-35-20-492d8de3aca701cb6350cbc666ab2535-e07da.png" data-srcset="/static/2024-10-17-10-35-20-492d8de3aca701cb6350cbc666ab2535-20936.png 200w,\n/static/2024-10-17-10-35-20-492d8de3aca701cb6350cbc666ab2535-da2be.png 400w,\n/static/2024-10-17-10-35-20-492d8de3aca701cb6350cbc666ab2535-e07da.png 611w" data-sizes="(max-width: 611px) 100vw, 611px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可以看到，这里我们对服务消费者和提供者的组成结构做了细化，并提取了 RpcChannel、RpcProtocol、RpcConnector 和 RpcAcceptor 这四个技术组件。在这四个技术组件中，前两个属于公共组件，而后两个则面向服务的提供者和服务的消费者，分别用于发起请求和接收响应。</p>\n<p>有了底层的用于完成网络通信的技术组件之后，我们再来看如何从业务接口定义和使用的角度出发进一步对 RPC 架构的组成结构进行扩充，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-17-10-36-09-dbc50f807b3779a34d824c21dc685611-e07da.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 611px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 40.098199672667754%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABwUlEQVQoz11Sj2+aYBDl//8/ljW1tp2rxFnnFLG1S/0FIiIgoKCgFAETY3+sb0+TNdu+5HJ897179+4OIQqnsMwqtFEFnldHFDmwLA1jrQx9fIP12sWfE4YOY2WY0wocR4frGvD9JoaDMpxZDaulDmG3y7BcOjBNjaYiSZ6QpimBDsbjIbbb5IMwy1JoWp9kBvJdTlzCHAWGoWCzniPPEwjO7AG23cSgL7L6LQL/Hv7iDhO9zsoi1dSYGNE2VFGHrlfpJeLaiMLO6X7ELRYy5t5PCNqoBGNyRcJz2OZXgmqYuyKU4TnHcEnCIlYrm+26mNklqEqRbwV4jkjSb4yV0X38jKlxRZ4KhMCXEK1+kL2KJG7h9aWLl+cu0m2bxLdInhr8DjiKJfJMhneMxTKeD4/E9hBvJDh2BfG6ybYfIKjKF6hUowwKXESRCyqdvKpcsJUC45+oesZleRxJAUN2MlIvqLyE6eSaqq7R753B0C/ZvgjBtjqULcG2WvQtttFhRYnEDSY1OIobLiZElsYs9J0ETb7JnOMdFnPO35JpbeYe1fcg4L/z/v7v/e3tF4Ig4C/lccu7D8zfdjgcsN/vT/43tNc8NIXmReEAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 17 10 36 09" title="" data-src="/static/2024-10-17-10-36-09-dbc50f807b3779a34d824c21dc685611-e07da.png" data-srcset="/static/2024-10-17-10-36-09-dbc50f807b3779a34d824c21dc685611-20936.png 200w,\n/static/2024-10-17-10-36-09-dbc50f807b3779a34d824c21dc685611-da2be.png 400w,\n/static/2024-10-17-10-36-09-dbc50f807b3779a34d824c21dc685611-e07da.png 611w" data-sizes="(max-width: 611px) 100vw, 611px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>上图中出现了用于代表业务接口的 API 组件，同时，我们也看到了分别代表客户端和服务器的 RpcClient 和 RpcServer 组件。我们不难想象这些组件的定位和作用。而这里需要重点介绍的是 RpcCaller 组件和 RpcInvoker 组件。RpcCaller 组件位于服务消费者端，会根据 API 的定义信息发起请求。而 RpcInvoker 组件位于服务提供者端，负责对 RpcServer 执行具体的调用过程并返回结果。</p>\n<p>最后，为了对远程调用过程进行更好的控制，我们还会引入两个技术组件，分别是 RpcProxy 和 RpcProcessor。完整的 RPC 架构组成结构如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-17-10-36-47-ba5c9299ad5e1f569f670d2471258ec0-4c6f5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 607px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.764415156507404%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAACLElEQVQozzVSZ3PaUBDU//8X+ZSJQzWDDXiwA9hJKAIhQHREk2iidyGxWT0mmrl575127/aKZFkDjMc5jIYy5nMFljWCYfRRyD+hoYXQ62Zxu93hfYfDDvmcH3UtSH8Kk+kco1EJxljGcJjHdKpCWq9NmGaJoC8MBzksLQOrlYVO+xdM45P/NNwf8XC9XlGtJJk8zcQa1us9xVTR7WSJz2K9akPabJaYTgw0G3UoShGLuQFrYRLYR1HOUUkD5/OBQe9YLk00myo0TWEVOrbbKZV1Ua0q6PXamM9MSHLBh4r6A7+/vqHVCEHvRYVVVB/Kig8DPSIUnM9nFAtsQz1IlX60m2GWmmDCCFTlCSX5O/p6FFJff8NqmabKD54ZHA9/sd/94fudgV+x27K8RQ37/R6jwRuWixSriQjs6eiVmcHEfBf47foL0nz2ye5UaWWairtbwniUQLMepko/+xgTAzudTlDLAejdF/YrSjUxIQSoCN7DypCmk4y4eIFcp8RTEVk9glYLcUgfmM0qnPARrWYUg36cgf0cYFxUgrsiuB7P40vlEteg5mdffGi3wuh1IiSGOPUAFf6kmgAVyzgej6iUfexzALWqj7hnDPsvgqvRPJ/oYaOeZrBXkmN0xtm3FAMm6YvzneDeBVlyDbZtQ5ZjfD8TGxem6xkOKUnFnuqYuEuue4fjOHBdV5y3myPO/77L5cLVGHItetzPjdhJx3GF2baHf9w9nm3f8A+1Ws1ekaq63QAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 17 10 36 47" title="" data-src="/static/2024-10-17-10-36-47-ba5c9299ad5e1f569f670d2471258ec0-4c6f5.png" data-srcset="/static/2024-10-17-10-36-47-ba5c9299ad5e1f569f670d2471258ec0-3bd24.png 200w,\n/static/2024-10-17-10-36-47-ba5c9299ad5e1f569f670d2471258ec0-52f0c.png 400w,\n/static/2024-10-17-10-36-47-ba5c9299ad5e1f569f670d2471258ec0-4c6f5.png 607w" data-sizes="(max-width: 607px) 100vw, 607px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>从命名上看，位于服务消费者端的 RpcProxy 组件充当了一种代理机制，确保服务消费者能够像调用本地方法一样调用远程服务。而位于服务提供者端的 RpcProcessor 的作用则是为远程调用执行过程添加各种辅助性支持，包括线程管理、超时控制等。</p>\n<p>这样，我们对整个 RPC 架构的演进过程做了详细的描述。通过对上图中的技术组件做进一步梳理，我们会发现这些组件可以归为三大类，即客户端组件、服务端组件和公共组件。</p>\n<p>其中，客户端组件与职责包括：</p>\n<ul>\n<li>RpcClient，负责导入远程接口代理实现；</li>\n<li>RpcProxy，远程接口的代理实现；</li>\n<li>RpcCaller，负责执行远程调用；</li>\n<li>RpcConnector，负责连接服务器。</li>\n</ul>\n<p>服务端组件与职责包括：</p>\n<ul>\n<li>RpcServer，负责导出远程接口；</li>\n<li>RpcInvoker，负责调用服务端接口；</li>\n<li>RpcAcceptor，负责接收网络请求；</li>\n<li>RpcProcessor，负责处理调用过程。</li>\n</ul>\n<p>而客户端和服务器端所共有的组件包括：</p>\n<ul>\n<li>RpcProtocol，负责执行网络传输；</li>\n<li>RpcChannel，数据传输的通道。</li>\n</ul>\n<p>关于 RPC 架构的组成结构介绍到这里就结束了。在这一组成结构的基础上，如果采用合适的编程语言和实现技术，原则上我们就可以自己动手实现一个 RPC 架构。</p>\n<h2 id="源码解析-2"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h2>\n<p>接下来我们通过一个简单的示例来实现前面所介绍的的各个技术组件。该示例的主要目的是演示如何从零开始构建一个最基本的 RPC 架构。</p>\n<p>首先我们定义一个业务服务，称为 UserService，包含一个用于根据用户编码获取用户姓名的业务方法，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68144823749787740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface UserService {\n    // 根据用户编码获取用户姓名\n    public String getUserNameByCode(String userCode);\n}`, `68144823749787740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 根据用户编码获取用户姓名</span>\n    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUserNameByCode</span><span class="token punctuation">(</span><span class="token class-name">String</span> userCode<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>UserService 接口的实现类也非常简单，我们通过一个内存 Map 来模拟对数据的存储和查询操作，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20475148535382438000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class UserServiceImpl implements UserService {\n\n    private Map<String, String> users = new HashMap<String, String>();\n\n    public UserServiceImpl() {\n        users.put(&quot;user1&quot;, &quot;tianyalan1&quot;);\n        users.put(&quot;user2&quot;, &quot;tianyalan2&quot;);\n    }\n\n    @Override\n    public String getUserNameByCode(String userCode) {\n        return users.get(userCode);\n    }\n}`, `20475148535382438000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> users <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">UserServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        users<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"user1"</span><span class="token punctuation">,</span> <span class="token string">"tianyalan1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        users<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"user2"</span><span class="token punctuation">,</span> <span class="token string">"tianyalan2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token annotation punctuation">@Override</span>\n    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUserNameByCode</span><span class="token punctuation">(</span><span class="token class-name">String</span> userCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> users<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userCode<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对于 RPC 架构而言，有了服务定义之后，我们就需要分别构建一个服务端组件 RpcServer 和一个客户端组件 RpcClient。但在这之前，我们首先需要定义一种在客户端和服务器端之间进行通信的消息格式，这里命名为 Protocol，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86123242646945580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class Protocol implements Serializable {\n   // 包名 + 接口名称\n   private String interfaceName;\n   // 调用方法名\n   private String methodName;\n   // 参数类型：按照接口参数顺序\n   private Class[] paramsTypes;\n   // 参数：按照接口参数顺序\n   private Object[] parameters;\n\n   public Protocol (String interfaceName, String methodName, Class[] paramsTypes, Object[] parameters) {\n      super();\n      this.interfaceName = interfaceName;\n      this.methodName = methodName;\n      this.paramsTypes = paramsTypes;\n      this.parameters = parameters;\n   }\n   // 省略 getter/setter 方法\n}`, `86123242646945580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Protocol</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 包名 + 接口名称</span>\n   <span class="token keyword">private</span> <span class="token class-name">String</span> interfaceName<span class="token punctuation">;</span>\n   <span class="token comment">// 调用方法名</span>\n   <span class="token keyword">private</span> <span class="token class-name">String</span> methodName<span class="token punctuation">;</span>\n   <span class="token comment">// 参数类型：按照接口参数顺序</span>\n   <span class="token keyword">private</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> paramsTypes<span class="token punctuation">;</span>\n   <span class="token comment">// 参数：按照接口参数顺序</span>\n   <span class="token keyword">private</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parameters<span class="token punctuation">;</span>\n\n   <span class="token keyword">public</span> <span class="token class-name">Protocol</span> <span class="token punctuation">(</span><span class="token class-name">String</span> interfaceName<span class="token punctuation">,</span> <span class="token class-name">String</span> methodName<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> paramsTypes<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parameters<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>interfaceName <span class="token operator">=</span> interfaceName<span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>methodName <span class="token operator">=</span> methodName<span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>paramsTypes <span class="token operator">=</span> paramsTypes<span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>parameters <span class="token operator">=</span> parameters<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token comment">// 省略 getter/setter 方法</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到 Protocol 中定义了一次服务请求所需要的接口名、方法名以及方法调用所需要的参数。注意到该类同时实现了 Serializable 接口，这是 Java 中的序列化接口，实现该接口的类能够通过网络进行远程传输。在 RPC 基础架构图中，Protocol 类相当于是通过 RpcProtocol 进行传递的请求数据。</p>\n<p>接下来我们考虑构建 RpcServer 类，该类需要实现 RPC 基础架构图中的各个服务端组件。RpcServer 类完整代码如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71181928679532995000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class RpcServer {\n    // 线程池\n    private int threadSize = 10;\n    private ExecutorService threadPool;\n    // 自定义缓存\n    private Map<String, Object> servicePool;\n    // 服务端口\n    private int port = 9000;\n\n    public RpcServer() {\n        super();\n        synchronized (this) {\n            threadPool = Executors.newFixedThreadPool(this.threadSize);\n        }\n    }\n\n    public RpcServer(int threadSize, int port) {\n        this.threadSize = threadSize;\n        this.port = port;\n        synchronized (this) {\n            threadPool = Executors.newFixedThreadPool(this.threadSize);\n        }\n    }\n\n    public RpcServer(Map<String, Object> servicePool, int threadSize, int port) {\n        this.threadSize = threadSize;\n        this.port = port;\n        this.servicePool = servicePool;\n        synchronized (this) {\n            threadPool = Executors.newFixedThreadPool(this.threadSize);\n        }\n    }\n\n    // 1. 实现 Socket 监听：RpcAcceptor\n    public void service() throws IOException {\n        ServerSocket serverSocket = new ServerSocket(port);\n        while (true) {\n            Socket receiveSocket = serverSocket.accept();\n            final Socket socket = receiveSocket;\n\n            // 执行请求\n            threadPool.execute(new Runnable() {\n                @Override\n                public void run() {\n                    try {\n                        // 2. 处理请求\n                        process(socket);\n\n                        socket.close();\n                    } catch(IOException e) {\n                        // 篇幅关系，省略对各种异常信息的处理\n                    }\n                }\n            });\n        }\n    }\n\n    // 2.处理请求：RpcProcessor\n    private void process(Socket receiveSocket) throws IOException, ClassNotFoundException, InvocationTargetException, NoSuchMethodException, InstantiationException, IllegalAccessException {\n        ObjectInputStream objectInputStream = new ObjectInputStream(receiveSocket.getInputStream());\n\n        Protocol protocol = (Protocol)objectInputStream.readObject();\n\n        // 调用服务\n        Object result = call(protocol);\n\n        ObjectOutputStream objectOutputStream = new ObjectOutputStream(receiveSocket.getOutputStream());\n        objectOutputStream.writeObject(result);\n        objectOutputStream.close();\n    }\n\n    // 3.执行方法调用：RpcInvoker\n    private Object call(Protocol protocol) throws ClassNotFoundException, NoSuchMethodException,\n            IllegalAccessException, InstantiationException, InvocationTargetException {\n        if(servicePool == null) {\n            synchronized (this) {\n                servicePool = new HashMap<String, Object>();\n            }\n        }\n\n        // 通过接口名称构建实现类\n        String interfaceName = protocol.getInterfaceName();\n        Object service = servicePool.get(interfaceName);\n        Class<?> serviceClass = Class.forName(interfaceName);\n\n        // 判断 servicePool 对象是否存在，如果不存在，就创建新对象并放入池中\n        if(service == null) {\n            synchronized (this) {\n                service = serviceClass.newInstance();\n                servicePool.put(interfaceName, service);\n            }\n        }\n\n        // 通过实现类来构建方法\n        Method method = serviceClass.getMethod(protocol.getMethodName(), protocol.getParamsTypes());\n\n        // 通过反射来实现方法的执行\n        Object result = method.invoke(service, protocol.getParameters());\n        return result;\n    }\n}`, `71181928679532995000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RpcServer</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 线程池</span>\n    <span class="token keyword">private</span> <span class="token keyword">int</span> threadSize <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token class-name">ExecutorService</span> threadPool<span class="token punctuation">;</span>\n    <span class="token comment">// 自定义缓存</span>\n    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> servicePool<span class="token punctuation">;</span>\n    <span class="token comment">// 服务端口</span>\n    <span class="token keyword">private</span> <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token number">9000</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">RpcServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>threadSize<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">RpcServer</span><span class="token punctuation">(</span><span class="token keyword">int</span> threadSize<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>threadSize <span class="token operator">=</span> threadSize<span class="token punctuation">;</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token operator">=</span> port<span class="token punctuation">;</span>\n        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>threadSize<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">RpcServer</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> servicePool<span class="token punctuation">,</span> <span class="token keyword">int</span> threadSize<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>threadSize <span class="token operator">=</span> threadSize<span class="token punctuation">;</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token operator">=</span> port<span class="token punctuation">;</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>servicePool <span class="token operator">=</span> servicePool<span class="token punctuation">;</span>\n        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>threadSize<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 1. 实现 Socket 监听：RpcAcceptor</span>\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">service</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>\n        <span class="token class-name">ServerSocket</span> serverSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerSocket</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token class-name">Socket</span> receiveSocket <span class="token operator">=</span> serverSocket<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">final</span> <span class="token class-name">Socket</span> socket <span class="token operator">=</span> receiveSocket<span class="token punctuation">;</span>\n\n            <span class="token comment">// 执行请求</span>\n            threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token annotation punctuation">@Override</span>\n                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    <span class="token keyword">try</span> <span class="token punctuation">{</span>\n                        <span class="token comment">// 2. 处理请求</span>\n                        <span class="token function">process</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n                        socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                        <span class="token comment">// 篇幅关系，省略对各种异常信息的处理</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 2.处理请求：RpcProcessor</span>\n    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">Socket</span> receiveSocket<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span> <span class="token punctuation">{</span>\n        <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>receiveSocket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token class-name">Protocol</span> protocol <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Protocol</span><span class="token punctuation">)</span>objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// 调用服务</span>\n        <span class="token class-name">Object</span> result <span class="token operator">=</span> <span class="token function">call</span><span class="token punctuation">(</span>protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>receiveSocket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        objectOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 3.执行方法调用：RpcInvoker</span>\n    <span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token class-name">Protocol</span> protocol<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">,</span>\n            <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span><span class="token punctuation">(</span>servicePool <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                servicePool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token comment">// 通过接口名称构建实现类</span>\n        <span class="token class-name">String</span> interfaceName <span class="token operator">=</span> protocol<span class="token punctuation">.</span><span class="token function">getInterfaceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">Object</span> service <span class="token operator">=</span> servicePool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>interfaceName<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> serviceClass <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>interfaceName<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// 判断 servicePool 对象是否存在，如果不存在，就创建新对象并放入池中</span>\n        <span class="token keyword">if</span><span class="token punctuation">(</span>service <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                service <span class="token operator">=</span> serviceClass<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                servicePool<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>interfaceName<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token comment">// 通过实现类来构建方法</span>\n        <span class="token class-name">Method</span> method <span class="token operator">=</span> serviceClass<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span>protocol<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> protocol<span class="token punctuation">.</span><span class="token function">getParamsTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// 通过反射来实现方法的执行</span>\n        <span class="token class-name">Object</span> result <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> protocol<span class="token punctuation">.</span><span class="token function">getParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> result<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>RpcServer 类代码相对比较长，我们结合 RPC 基本架构对其进行分段解析。</p>\n<ul>\n<li>\n<p>service 方法</p>\n<p>service 方法接收请求并基于 Socket 启动端口监听，通过线程池为进入的每个请求启动一个线程进行处理。就 RPC 基础架构而言，该 service 方法相当于扮演 RpcAcceptor 的角色。</p>\n</li>\n<li>\n<p>process 方法</p>\n<p>service 方法启动了线程池，而每个线程负责执行 process 方法。这里的 process 方法从 Socket 中获取输入流，然后把输入流中的数据转化为 Protocol，从而获取远程方法调用的各项元数据。就 RPC 基础架构而言，该 process 方法充当了 RpcProcessor 的角色。</p>\n</li>\n<li>\n<p>call 方法 一旦获取 Protocol，process 方法就调用内部的 call 方法来执行真正的方法调用。这里通过反射机制获取位于服务器端的方法并进行执行。显然，该 call 方法对应于 RpcInvoker 角色。</p>\n</li>\n</ul>\n<p>介绍完 RpcServer 中的各个技术组件，我们再来看一下 RpcClient 的代码，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53337224775443720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class RpcClient {\n    private String serverAddress;\n    private int serverPort;\n\n    public RpcClient(String serverAddress, int serverPort) {\n         this.serverAddress = serverAddress;\n         this.serverPort = serverPort;\n    }\n\n    // RpcConnector + RpcCaller\n    public Object sendAndReceive(Protocol protocol) {\n         Object result = null;\n\n         try {\n            Socket socket = new Socket(serverAddress, serverPort);\n            ObjectOutputStream objectOutputStream = new ObjectOutputStream(socket.getOutputStream());\n            objectOutputStream.writeObject(protocol);\n\n            ObjectInputStream objectInputStream = new ObjectInputStream(socket.getInputStream());\n            result = objectInputStream.readObject();\n         } catch (Exception e) {\n            // 篇幅关系，省略对各种异常信息的处理\n         }\n\n         return result;\n    }\n    // 省略 getter/setter 方法\n}`, `53337224775443720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RpcClient</span> <span class="token punctuation">{</span>\n    <span class="token keyword">private</span> <span class="token class-name">String</span> serverAddress<span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token keyword">int</span> serverPort<span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">RpcClient</span><span class="token punctuation">(</span><span class="token class-name">String</span> serverAddress<span class="token punctuation">,</span> <span class="token keyword">int</span> serverPort<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">this</span><span class="token punctuation">.</span>serverAddress <span class="token operator">=</span> serverAddress<span class="token punctuation">;</span>\n         <span class="token keyword">this</span><span class="token punctuation">.</span>serverPort <span class="token operator">=</span> serverPort<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// RpcConnector + RpcCaller</span>\n    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">sendAndReceive</span><span class="token punctuation">(</span><span class="token class-name">Protocol</span> protocol<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token class-name">Object</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n\n         <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            <span class="token class-name">Socket</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span>serverAddress<span class="token punctuation">,</span> serverPort<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            result <span class="token operator">=</span> objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 篇幅关系，省略对各种异常信息的处理</span>\n         <span class="token punctuation">}</span>\n\n         <span class="token keyword">return</span> result<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// 省略 getter/setter 方法</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>RpcClient 类的代码相对比较简单，主要就是根据远程服务的地址通过 Socket 发起通信，传入一个 Protocol 对象并返回远程调用的结果。</p>\n<p>完成了 RpcServer 和 RpcClient 类之后，我们就可以编写一些测试用例来进行验证。验证方法就是启动 RpcServer，然后通过 RpcClient 执行远程调用。这里我们编写一个 ServerTest 来启动 RpcServer，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24424249800822186000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class ServerTest {\n    public static void main(String[] args) {\n        Map<String, Object> servicePool = new HashMap<String, Object>();\n        servicePool.put(&quot;com.juejin.rpc.service.UserService&quot;, new UserServiceImpl());\n\n        RpcServer server = new RpcServer(servicePool, 4, 9000);\n\n        try{\n            server.service();\n        } catch (IOException e) {\n            e.printStackTrace();\n        }\n    }\n}`, `24424249800822186000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServerTest</span> <span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> servicePool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        servicePool<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"com.juejin.rpc.service.UserService"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UserServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token class-name">RpcServer</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcServer</span><span class="token punctuation">(</span>servicePool<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">try</span><span class="token punctuation">{</span>\n            server<span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后我们再编写一个 ClientTest 对远程服务发起请求，整个过程如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35230598990284358000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class ClientTest {\n    public static void main(String[] args) {\n        String serverAddress = &quot;127.0.0.1&quot;;\n        int serverPort = 9000;\n\n        RpcClient client = new RpcClient(serverAddress, serverPort);\n        Protocol protocol = buildProtocol(&quot;user1&quot;);\n        Object result = client.sendAndReceive(protocol);\n        System.out.println(result);\n\n        protocol = buildProtocol(&quot;user2&quot;);\n        result = client.sendAndReceive(protocol);\n        System.out.println(result);\n    }\n\n    private static Protocol buildProtocol(String userCode) {\n        String interfaceName = &quot;com.juejin.rpc.service.UserService&quot;;\n        Class[] paramsTypes = {String.class};\n        Object[] parameters = {userCode};\n        String methodName = &quot;getUserNameByCode&quot;;\n\n        Protocol protocol = new Protocol(interfaceName, methodName, paramsTypes, parameters);\n        return protocol;\n    }\n}`, `35230598990284358000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClientTest</span> <span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">String</span> serverAddress <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">;</span>\n        <span class="token keyword">int</span> serverPort <span class="token operator">=</span> <span class="token number">9000</span><span class="token punctuation">;</span>\n\n        <span class="token class-name">RpcClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcClient</span><span class="token punctuation">(</span>serverAddress<span class="token punctuation">,</span> serverPort<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">Protocol</span> protocol <span class="token operator">=</span> <span class="token function">buildProtocol</span><span class="token punctuation">(</span><span class="token string">"user1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">Object</span> result <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">sendAndReceive</span><span class="token punctuation">(</span>protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        protocol <span class="token operator">=</span> <span class="token function">buildProtocol</span><span class="token punctuation">(</span><span class="token string">"user2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        result <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">sendAndReceive</span><span class="token punctuation">(</span>protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Protocol</span> <span class="token function">buildProtocol</span><span class="token punctuation">(</span><span class="token class-name">String</span> userCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">String</span> interfaceName <span class="token operator">=</span> <span class="token string">"com.juejin.rpc.service.UserService"</span><span class="token punctuation">;</span>\n        <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> paramsTypes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parameters <span class="token operator">=</span> <span class="token punctuation">{</span>userCode<span class="token punctuation">}</span><span class="token punctuation">;</span>\n        <span class="token class-name">String</span> methodName <span class="token operator">=</span> <span class="token string">"getUserNameByCode"</span><span class="token punctuation">;</span>\n\n        <span class="token class-name">Protocol</span> protocol <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Protocol</span><span class="token punctuation">(</span>interfaceName<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> paramsTypes<span class="token punctuation">,</span> parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> protocol<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>至此，我们构建了一个简洁但又完整的 RPC 架构。通过这个示例，我们可以对 RPC 的整体结构有一个清晰的认识。事实上，无论是多么复杂的 RPC 框架，都是从这样的基础架构开始逐步演进而来。</p>\n<h2 id="解题要点-4"><a href="#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解题要点</h2>\n<p>围绕 RPC 架构，我们首先要明确的第一个解题要点就是它的组成结构。RPC 架构的组成呈现一种非常标准的对称结构，围绕远程调用过程，我们可以提炼出一组分别针对服务消费者和服务提供者的技术组件。把各个技术组件进行分类梳理是一种有助于记忆的学习方法，你也可以尝试能不能对这一组成结构再做进一步的细化。</p>\n<p>RPC 架构的组成结构偏向理论描述，想要理解该架构中各个技术组件的具体实现过程，一种有效的方法就是自己动手做一些实践。而面试官实际上也非常看重候选人的这种实践能力，所以会以发散式的提问方式来考查候选人对 RPC 架构的掌握能力。基于本讲中给出的案例，你可以结合 RPC 架构的理论知识以及具体的代码实现过程来应对这种发散式的面试题。</p>\n<p>最后，从本讲开头罗列的一些面试题可以看出，面试官往往会把 RPC 架构的组成结构和具体的 RPC 开源框架组合在一起进行提问。而在本讲内容中，我们也发现组成 RPC 架构的这些技术组件具有演进性。我们可以从最基本的组件出发，逐步进行扩展和完善，直至形成一个完整的技术体系。也就是说，我们可以从一个基础架构出发来系统掌握大型开源框架的实现原理。</p>\n<h2 id="小结与预告-2"><a href="#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结与预告</h2>\n<p>想要掌握分布式服务框架，首先得掌握 RPC 架构。</p>\n<p>本讲内容对 RPC 架构的组成结构进行了详细的介绍。同时，我们也针对 RPC 架构所需要实现的各个技术组件，提供了一个简洁但又完整的示例，从而有助于你对该架构有一个感性的认识。可以说，RPC 是分布式系统中一项基础设施类的技术体系，但凡涉及到服务与服务之间的交互就需要使用到 RPC 架构。当你在使用一个分布式框架时，可以尝试使用今天介绍的 RPC 架构的基本结构进行分析，从而加深对这项技术体系的理解。</p>\n<p>在掌握了 RPC 架构的基本结构并动手实现了一个简易版的示例之后，让我们回到主流的开源框架，看看这些框架是如何实现远程调用的。远程调用涉及到服务发布和服务引用这两个方面。我们将先对前者展开讨论，并回答这样一个问题：如何合理设计服务发布机制？我们下一讲再聊。</p>\n<h1 id="远程调用：如何合理设计服务发布机制？"><a href="#%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%EF%BC%9A%E5%A6%82%E4%BD%95%E5%90%88%E7%90%86%E8%AE%BE%E8%AE%A1%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E6%9C%BA%E5%88%B6%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>远程调用：如何合理设计服务发布机制？</h1>\n<p>在上一讲中，我们通过一个简单但又完整的示例演示了如何实现一套自定义的 RPC 架构。在现实开发场景中，我们当然不建议大家重复造轮子，而是应该采用主流的 Dubbo、Spring Cloud 等开源框架来构建分布式系统。对于这些开源框架而言，RPC 架构的实现过程显然不会像上一讲中的示例那样简单，而是内置了各种强大的功能，从而为开发人员提供更好的开发体验。</p>\n<p>本质上，一次远程调用涉及两个角色，即服务提供者和服务消费者，分别用来实现服务的发布和引用。在本讲内容中，我们将讨论服务的发布过程，并引出一个常见的面试题，即：如何合理设计服务发布机制？</p>\n<h2 id="问题背景-2"><a href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题背景</h2>\n<p>在分布式系统中，系统的能力来自于服务与服务之间的交互和集成。为了实现这一过程，就需要服务提供者对外暴露可以访问的入口。假设我们沿用上一讲中所介绍的业务服务 UserService，那么对该服务进行发布的一种实现方式如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15298473314180305000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`UserService service = new UserServiceImpl(...)；\nRpcServer server = new RpcServer(…);\nserver.export(UserService.class, options);`, `15298473314180305000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">UserService</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>；\n<span class="token class-name">RpcServer</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcServer</span><span class="token punctuation">(</span>…<span class="token punctuation">)</span><span class="token punctuation">;</span>\nserver<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>上述代码看上去也很简单，和我们在上一讲中所实现的示例代码有点类似。但在这几行代码的背后，我们需要考虑的事情非常多，比方说：</p>\n<ul>\n<li>如果远程调用发生在同一个 JVM 中，服务发布应该如何实现？</li>\n<li>如果我们想要在服务发布过程中添加一些定制化的切面逻辑，应该怎么做？</li>\n<li>如果服务提供者具有多个服务实例，那么服务发布过程如何实现集群化？</li>\n<li>如果服务发布操作还没完成，服务消费者的请求就进来了应该怎么办？</li>\n</ul>\n<p>这些问题面向服务发布主流程中的特定场景，但正是这些特定场景才是面试过程中经常会出现的提问方式。同时，我们也应该注意到，远程调用是一个消耗大量资源的过程，资源的利用率也是框架必须要考虑的问题。如何合理地利用资源，避免远程通信所导致的性能消耗，也是服务发布机制设计上的一个重点。</p>\n<p>如果针对 Dubbo 等具体的实现框架，面试官也可以这样来进行提问：</p>\n<ul>\n<li>Dubbo 中所采用的服务发布流程是怎么样的？</li>\n<li>Dubbo 框架中提供了哪几种服务发布机制？</li>\n<li>为了提高资源利用的效率，Dubbo 在发布过程中做了哪些优化？</li>\n</ul>\n<p>这些问题看上去侧重点各有不同，但其实都是围绕着一套服务发布流程来展开的，让我们来对这些问题做进一步分析。</p>\n<h2 id="问题分析-3"><a href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题分析</h2>\n<p>和前面几讲介绍的网络通信、序列化等主题不同，服务的发布和引用更多关注的是应用层的设计方法，而不是面向底层网络的通信组件。因此，我们对服务发布的分析也需要从应用层的角度进行切入，梳理一套通用而又完整的服务发布流程。而为了实现这一目标，就需要对业界主流的一些开源框架做一定的提炼和抽象。这是我们在应对这类面试题要把握的第一个方向。</p>\n<p>然后，我们在这套流程中进一步提炼服务发布过程中所使用到的各个技术组件，这些技术组件能够与前面给出的特定场景下的面试问题相对应。这是我们要回答的第二个主要方向。</p>\n<p>最后，我们还是要回到具体的实现框架，从源码切入来详细分析开源框架中针对服务发布机制的实现原理。只有这样，才能做到理论联系实际，也有助于我们更好地掌握开源框架的使用方式和技巧。</p>\n<p>上述三个维度构成了我们回答这类问题的解答思路。接下来要讨论的就是具体的技术体系了，让我们给出对服务发布流程的统一描述。</p>\n<h2 id="技术体系-5"><a href="#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术体系</h2>\n<p>在现代的分布式架构中，服务的发布和引用过程往往与注册中心密切相关。服务注册中心是服务发布和引用的媒介，当我们把服务信息注册到注册中心，并能够从注册中心中获取服务调用地址时，需要考虑的问题就是如何进行有效的服务发布和引用。我们会在后面介绍注册中心，而在本讲接下来的内容中，我们重点关注的是服务发布所具备的流程和特性。</p>\n<p>我们知道服务发布的目的是将该服务的访问入口暴露给分布式系统中的其他服务。抛开具体的技术和框架，我们先可以简单抽象出如下图所示的服务发布的整体流程：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-23-11-11-30-d9399ba4e9a0faa71418135cb54500cd-5fd40.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 44.34389140271493%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABJUlEQVQoz21R2W7CQAzM//9RK14Q7R+gQgK0DyGBHJD7PqYZS45WtJYcx+uZ8dprOfYWtr3B9brHNANNU+F82sE+bhCFP7jdHBwP7zg5HxiGDvM8L/VPHL7e4Hl70LIsxuW8xfdlB2uaJtyDO6IoQlmW6PteQDxXG8dRnGJ01oZhWHO6YiwmnuchDMOlUyb+fD6XmzYCYAMlm8aaaSpq8VPXtRAp0nUd8jxHHMereBAEqKoKaZqKJ0kiOUXatpWG5DKKIJPXbgSqsSFzdYq5rivCXBPPGFdBk6yCvKlaURSyY8bH47FGCvwZmQtmJxb16joy10AQBfSWWZrJCnzfF55yiSdXBJX8nyDPKGa+Ov91An0sNl5HNsdTkDkO/01BHe8VT/8FHIa6Ijvw2goAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 23 11 11 30" title="" data-src="/static/2024-10-23-11-11-30-d9399ba4e9a0faa71418135cb54500cd-fee1c.png" data-srcset="/static/2024-10-23-11-11-30-d9399ba4e9a0faa71418135cb54500cd-a67b7.png 200w,\n/static/2024-10-23-11-11-30-d9399ba4e9a0faa71418135cb54500cd-0b187.png 400w,\n/static/2024-10-23-11-11-30-d9399ba4e9a0faa71418135cb54500cd-fee1c.png 800w,\n/static/2024-10-23-11-11-30-d9399ba4e9a0faa71418135cb54500cd-5fd40.png 884w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>上图包含了服务发布过程中的核心组件，我们来对这些核心组件做一一展开。</p>\n<ol>\n<li>\n<p>发布启动器</p>\n<p>发布启动器的核心作用有两点，一个是确定服务的发布形式，一个是启动服务发布过程。在目前主流的开发框架中，常见的服务发布形式包括：</p>\n<ul>\n<li>配置化：使用配置文件；</li>\n<li>使用注解：使用 Java 中的注解机制；</li>\n<li>API 调用：使用底层的代码接口。</li>\n</ul>\n<p>以上三种方式各有利弊。在日常开发过程中，配置和注解比较常用，而 API 调用则主要完成服务与服务之间的集成。</p>\n<p>讲完发布形式，我们来讨论如何启动服务发布过程，常见的策略如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-23-11-12-57-ea671c1b0957c2c513623988e7872a8b-b1313.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 488px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 46.72131147540984%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAAB0ElEQVQoz3VSDW+aUBTl//+IJV221S1NNUu6GZdmapFC1SpsCENFcCqypGJpwFmBs+MrW5olfcnLfR/n3nvuuVdCuYqiKG0u7GxmQderGNyew9Br0IdVYXvdDwhWnsDkeS78nm/pGOD5zvNMgH3fhqa+gdw+QfemwvM7dLVTKJ0ThKFfBszwv7+EF9Zms8E6CHF4zHB/H/Me4XDIsFoFiKLoJTdIvj+F61qYz8dY/JxgONCgaR2k6Q7LpU+mY/T7Cvo9RWCOb2maQlVlGEYPi4UrMK5r8+xDGpk17BIZ1ugME6eG/e8O3GkdQbDGlBboYe5fYDKusUYNq2ULjuOy7DZ+hQ3Y1jmcH1VEm0sSakGyLZXga4p/SZ0+Y2Q2me0WSZLAm+kwvzfxzWjTUWEiFRbxnucxiEZsi/rW+d/kv4yZO4TERmG/z5A/NZdlhdhuU3EOw4hMN4jjhLrFvG9pE/G32+WchCUeD09+xxgZ+8mmFGXHCpZmYjisk+lHMriCfHVGTRswTQMPDzFsW6ZemmBq6A0oSo13lRUZf4fvODZFmfFA2k0M+m/RuzmFqryGPqhQ2yru7tYi4Ni5wNz7hHbrFRO9J7ZCHb8w4dd/M/wHQcWSVJRbdk4AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 23 11 12 57" title="" data-src="/static/2024-10-23-11-12-57-ea671c1b0957c2c513623988e7872a8b-b1313.png" data-srcset="/static/2024-10-23-11-12-57-ea671c1b0957c2c513623988e7872a8b-152e1.png 200w,\n/static/2024-10-23-11-12-57-ea671c1b0957c2c513623988e7872a8b-4a935.png 400w,\n/static/2024-10-23-11-12-57-ea671c1b0957c2c513623988e7872a8b-b1313.png 488w" data-sizes="(max-width: 488px) 100vw, 488px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可以看到，我们可以使用 Spring 容器来完成基于配置化和注解形式下的服务启动过程。而对于 API 调用而言，由于不一定会借助于容器，所以也可以直接使用 main 函数来实现这一目标。</p>\n</li>\n<li>\n<p>动态代理</p>\n<p>动态代理是远程过程调用中非常核心的一个技术组件，在服务发布和服务引用过程中都会用到，其主要作用就是简化服务发布和引用的开发难度，以及确保能够对发布过程进行扩展和定制。</p>\n<p>关于动态代理的具体实现方式值得专门进行讨论，我们将在后面重点关注这一话题。</p>\n</li>\n<li>\n<p>发布管理器</p>\n<p>服务发布过程需要使用专门的组件来进行统一管理，这个组件就是发布管理器。该组件需要判断本次发布是否成功，然后在服务发布成功之后，把服务的地址信息注册到注册中心。而这里的服务地址信息则来自于协议服务器。</p>\n</li>\n<li>\n<p>协议服务器</p>\n<p>在服务发布过程中，在物理上真正建立网络连接，并对网络端口进行绑定的组件是协议服务器。协议服务器还会执行心跳检测以及在连接失败之后进行重连操作。用于发布服务的常见协议包括 HTTP、RMI、Hessian 等。我们也可以自己定义这样的协议，例如 Dubbo 框架就实现了一套自定义的 Dubbo 协议。实际上，关于网络通信方面的讨论就是针对这里的协议服务器。</p>\n</li>\n<li>\n<p>注册中心</p>\n<p>注册中心的作用是存储和管理服务定义的各类元数据，并能感知到这些元数据的变化。</p>\n</li>\n</ol>\n<p>以上所示的服务发布流程图有一定的共性，可以通过转化映射到具体的某个框架。事实上，基于 Dubbo 的服务发布流程与上述过程非常类似。让我们来一起看一下。</p>\n<h2 id="源码解析-3"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h2>\n<p>在具体介绍 Dubbo 服务发布流程之前，我们先来讨论 Dubbo 暴露服务的两种时效，一种是延迟暴露，一种是正常暴露，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-23-11-14-30-28a2a1fb63f26088d4209a9dd78a7b17-ced8c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 491px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.47250509164969%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAACFElEQVQoz12S627aQBCFef8H6M+qatWGS5OUaxKSiLahEkmJbWwuhoDBgCGAgdiGBAr49HhpaZWVVjs7O3M08+2EfN+H7+8QrE5HhyydolLOQC0locgJKEoCJSWw4+JerWR4JjEaD0XO7k+u0OEZCozdbu80DBVGi4lSFHeFj7gtfICqRCkYof0eZfUzjGYSZucMvV57L7jb7sV8X9xD+G+tVi8wzRZGIwu6XoaqSSKx2zWgaTJUVcJgYGI47B+6+rsOgoExteeYTudwHA+LxQuTq6yij9drybdKRYdlDeG6C8znjsh7enIPoiHDqMHqf0XXzKH5kCWjFFs8oX3GausicLvdcAPNZhGd9jn0WoZoLlGrptHv5dBqXmMyHu8r1HWFjiTui0fI37zDxfkbFH8eoaxF6NcOnALMmvoNbSMB6T6M/Pe3yDJWkcMsIo7hwPrH0HVdbDa/0GjU+TEtYQe+13y2LNN1HazXK8iyBNueYL1aEdPiEBuazWx4novn5yVhDzCZjLBcLhjkko9Nro4InM2mYnuewzePn9Ulu5nIdZw588ZCI2T1LzgOxyjJUbYdRkU7RvHuEyTaZidNTpdk10KjnsLj4IrtnXCUYpzXCGc1xvcv5H+O0eMV8vlkUGFBDGuJA3xbiJFdijtN4QzsyQ9+QoGfYxL+DVyniIdGliwD5qcUjaPduuaUFOC5Rd5z+A3TadbnwaLV0QAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 23 11 14 30" title="" data-src="/static/2024-10-23-11-14-30-28a2a1fb63f26088d4209a9dd78a7b17-ced8c.png" data-srcset="/static/2024-10-23-11-14-30-28a2a1fb63f26088d4209a9dd78a7b17-680fb.png 200w,\n/static/2024-10-23-11-14-30-28a2a1fb63f26088d4209a9dd78a7b17-eda79.png 400w,\n/static/2024-10-23-11-14-30-28a2a1fb63f26088d4209a9dd78a7b17-ced8c.png 491w" data-sizes="(max-width: 491px) 100vw, 491px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可以看到，如果这里的 delay 参数被设置成了 -1，代表不需要延迟暴露。反之，Dubbo 会根据该参数值的大小来执行对应的延迟策略。讲到这里，你可能会问，Dubbo 为什么要考虑发布时效这个问题呢？主要目的在于提供平滑发布机制。如果 Dubbo 服务本身还没有完全启动成功，那这时候对外暴露服务是没有意义的，我们可以通过设置延迟时间来确保服务在发布的时间点上就是可用的。</p>\n<p>在判断是否需要延迟暴露之后，ServiceBean 就会调用 export 方法执行服务暴露。而 export 方法又来自 ServiceBean 的父类 ServiceConfig，所以关于 Dubbo 服务发布的流程就从 ServiceConfig 类进行切入。</p>\n<p>那么，ServiceConfig 是如何实现延迟暴露的呢？实际上很简单，就是启动一个后台线程来延迟调用一个 doExport 方法，该方法负责执行具体的服务暴露逻辑。而如果没有采用延迟暴露策略，那么这个 doExport 方法就会被立即执行，具体的执行流程如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59349032506940740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 将 Bean 属性转化为 URL\nURL url = new URL(name, host, port, (contextPath == null || contextPath.length() == 0 ? &quot;&quot; : contextPath + &quot;/&quot;) + path, map);\n\nString scope = url.getParameter(Constants.SCOPE_KEY);\n// 如果 scope 配置为 none 则不暴露\nif (!Constants.SCOPE_NONE.toString().equalsIgnoreCase(scope)) {\n            // 如果 scope 没有被配置为远程暴露，则采用本地暴露\n            if (!Constants.SCOPE_REMOTE.toString().equalsIgnoreCase(scope)) {\n                exportLocal(url);\n            }\n            // 如果 scope 没有被配置为本地暴露，则采用远程暴露\n            if (!Constants.SCOPE_LOCAL.toString().equalsIgnoreCase(scope)) {\n                if (registryURLs != null && registryURLs.size() > 0) {\n                    for (URL registryURL : registryURLs) {\n                        // 将具体服务转化为 Invoker\n                        Invoker<?> invoker = proxyFactory.getInvoker(ref, (Class) interfaceClass, registryURL.addParameterAndEncoded(Constants.EXPORT_KEY, url.toFullString()));\n                        DelegateProviderMetaDataInvoker wrapperInvoker = new DelegateProviderMetaDataInvoker(invoker, this);\n\n                        // 将 Invoker转化为 Exporter\n                        Exporter<?> exporter = protocol.export(wrapperInvoker);\n                        exporters.add(exporter);\n                    }\n                } else {\n                    Invoker<?> invoker = proxyFactory.getInvoker(ref, (Class) interfaceClass, url);\n                    DelegateProviderMetaDataInvoker wrapperInvoker = new DelegateProviderMetaDataInvoker(invoker, this);\n\n                    Exporter<?> exporter = protocol.export(wrapperInvoker);\n                    exporters.add(exporter);\n                }\n            }\n}\nthis.urls.add(url);`, `59349032506940740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token comment">// 将 Bean 属性转化为 URL</span>\n<span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">URL</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> <span class="token punctuation">(</span>contextPath <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> contextPath<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">""</span> <span class="token operator">:</span> contextPath <span class="token operator">+</span> <span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token operator">+</span> path<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token class-name">String</span> scope <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>SCOPE_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 如果 scope 配置为 none 则不暴露</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>SCOPE_NONE<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 如果 scope 没有被配置为远程暴露，则采用本地暴露</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>SCOPE_REMOTE<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token function">exportLocal</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n            <span class="token comment">// 如果 scope 没有被配置为本地暴露，则采用远程暴露</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>SCOPE_LOCAL<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token keyword">if</span> <span class="token punctuation">(</span>registryURLs <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> registryURLs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    <span class="token keyword">for</span> <span class="token punctuation">(</span>URL registryURL <span class="token operator">:</span> registryURLs<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                        <span class="token comment">// 将具体服务转化为 Invoker</span>\n                        <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> invoker <span class="token operator">=</span> proxyFactory<span class="token punctuation">.</span><span class="token function">getInvoker</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> interfaceClass<span class="token punctuation">,</span> registryURL<span class="token punctuation">.</span><span class="token function">addParameterAndEncoded</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>EXPORT_KEY<span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">toFullString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                        <span class="token class-name">DelegateProviderMetaDataInvoker</span> wrapperInvoker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DelegateProviderMetaDataInvoker</span><span class="token punctuation">(</span>invoker<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n                        <span class="token comment">// 将 Invoker转化为 Exporter</span>\n                        <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> exporter <span class="token operator">=</span> protocol<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>wrapperInvoker<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                        exporters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>exporter<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n                    <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> invoker <span class="token operator">=</span> proxyFactory<span class="token punctuation">.</span><span class="token function">getInvoker</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> interfaceClass<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    <span class="token class-name">DelegateProviderMetaDataInvoker</span> wrapperInvoker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DelegateProviderMetaDataInvoker</span><span class="token punctuation">(</span>invoker<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n                    <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> exporter <span class="token operator">=</span> protocol<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>wrapperInvoker<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    exporters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>exporter<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>urls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这段代码值得仔细分析。在这里，我们可以看到首先会构建一个 URL 对象，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48203013140491000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`URL url = new URL(name, host, port, (contextPath == null || contextPath.length() == 0 ? &quot;&quot; : contextPath + &quot;/&quot;) + path, map);`, `48203013140491000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">URL</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> <span class="token punctuation">(</span>contextPath <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> contextPath<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">""</span> <span class="token operator">:</span> contextPath <span class="token operator">+</span> <span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token operator">+</span> path<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>请注意，在 Dubbo 中，URL 对象代表了统一数据模型，会贯穿服务暴露和调用的整个流程，绝对是一等公民。URL 格式如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55040566106500190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`protocol://username:password@host:port/path?key=value&key=value`, `55040566106500190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">protocol://username:password@host:port/path?key=value&amp;key=value</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>当不使用注册中心时，URL 表现形式比较简单，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29687085675163380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`dubbo://service-host/com.foo.FooService?version=1.0.0`, `29687085675163380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">dubbo://service-host/com.foo.FooService?version=1.0.0</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>而当使用注册中心时，URL 中会带有注册中心信息，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68050788956872200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`registry://registry-host/org.apache.dubbo.registry.RegistryService?export=URL.encode(&quot;dubbo://service-host/com.foo.FooService?version=1.0.0&quot;)`, `68050788956872200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">registry://registry-host/org.apache.dubbo.registry.RegistryService?export=URL.encode(&quot;dubbo://service-host/com.foo.FooService?version=1.0.0&quot;)</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>通过分析 Dubbo 源码，我们得到将配置信息通过一种统一的 URL 进行表示和传递的实现方法，这也是值得我们学习的一个设计技巧。</p>\n<p>接着，我们根据 scope 参数判断服务的发布范围，判断规则如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-23-11-16-33-0c6cef9736f26464b42ab0bb0f58c507-c6c9e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 606px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 36.303630363036305%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABeUlEQVQoz12RW0/CQBCF+/9/idEoETAqohgoKveLUtoutGy3tKU8l4Rbj6frC7HJNDu7s2e+OWvkeY48P+N8PgPIcTgcsRBNDPvX6HauMRrewvfqEELAshpQwQsC+Qp7XkXn6wrDwQ0U80DWdRj49xXCK38O1xlgvXYRrR0kyRJZlmG7DZHELjabJfcEzx3EkUCq84UOI01DRJGPOF6xWLI4pZiJufWIybiK7+kDQmXC85ak/MQmaWMdmrBmT+j3Suh17wjwzrsf1GnDkKsaBe6wcEsIgxq7hpDS0SRhaDO3dec/QsXGjqaLIkefFxGztthLYkFBOYBwWxRt0qsOlFLaq+mkjPGoQsoyvGWDhB5ct81LLRI3MZ1WSHerw/ffOLpJe1owTqccl7Hf7znaN2y7z9EcPsJce7nLdtimipYIjr3QZIG0EASWJit8LEgvHiXX/+PxCLn6okcP2ifXeeZ4H6Tw2cQk+T1mP4/0tsqzGmv+1sUkiuS/afX3ELJl4DkAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 23 11 16 33" title="" data-src="/static/2024-10-23-11-16-33-0c6cef9736f26464b42ab0bb0f58c507-c6c9e.png" data-srcset="/static/2024-10-23-11-16-33-0c6cef9736f26464b42ab0bb0f58c507-c7209.png 200w,\n/static/2024-10-23-11-16-33-0c6cef9736f26464b42ab0bb0f58c507-2eadc.png 400w,\n/static/2024-10-23-11-16-33-0c6cef9736f26464b42ab0bb0f58c507-c6c9e.png 606w" data-sizes="(max-width: 606px) 100vw, 606px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>关于本地服务的暴露我们后面再具体展开，这里先讨论远程服务暴露的场景。</p>\n<h3 id="远程服务暴露"><a href="#%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>远程服务暴露</h3>\n<p>在 Dubbo 中，远程服务暴露过程需要执行非常重要的一个步骤，即将具体服务对象转换到 Invoker，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12557861106226299000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Invoker<?> invoker = proxyFactory.getInvoker(ref, (Class) interfaceClass, registryURL.addParameterAndEncoded(Constants.EXPORT_KEY, url.toFullString()));`, `12557861106226299000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> invoker <span class="token operator">=</span> proxyFactory<span class="token punctuation">.</span><span class="token function">getInvoker</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> interfaceClass<span class="token punctuation">,</span> registryURL<span class="token punctuation">.</span><span class="token function">addParameterAndEncoded</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>EXPORT_KEY<span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">toFullString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这里看到了一个 proxyFactory 对象，从命名上不难看出它是一个代理工厂类，定义如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54947631628116820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@SPI(&quot;javassist&quot;)\npublic interface ProxyFactory {\n   @Adaptive({Constants.PROXY_KEY})\n   <T> T getProxy(Invoker<T> invoker) throws RpcException;\n\n   @Adaptive({Constants.PROXY_KEY})\n   <T> Invoker<T> getInvoker(T proxy, Class<T> type, URL url) throws RpcException;\n}`, `54947631628116820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@SPI</span><span class="token punctuation">(</span><span class="token string">"javassist"</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProxyFactory</span> <span class="token punctuation">{</span>\n   <span class="token annotation punctuation">@Adaptive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>PROXY_KEY<span class="token punctuation">}</span><span class="token punctuation">)</span>\n   <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> invoker<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span><span class="token punctuation">;</span>\n\n   <span class="token annotation punctuation">@Adaptive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>PROXY_KEY<span class="token punctuation">}</span><span class="token punctuation">)</span>\n   <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">getInvoker</span><span class="token punctuation">(</span><span class="token class-name">T</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> type<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 Dubbo 中，该接口有两个实现类，即 JdkProxyFactory 和 JavassistProxyFactory。我们来看 JdkProxyFactory 中的 getInvoker 方法实现，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66178214572999210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public <T> Invoker<T> getInvoker(T proxy, Class<T> type, URL url) {\n        return new AbstractProxyInvoker<T>(proxy, type, url) {\n            @Override\n            protected Object doInvoke(T proxy, String methodName, Class<?>[] parameterTypes, Object[] arguments) throws Throwable {\n                Method method = proxy.getClass().getMethod(methodName, parameterTypes);\n                return method.invoke(proxy, arguments);\n            }\n        };\n}`, `66178214572999210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">getInvoker</span><span class="token punctuation">(</span><span class="token class-name">T</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> type<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AbstractProxyInvoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> type<span class="token punctuation">,</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token annotation punctuation">@Override</span>\n            <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">doInvoke</span><span class="token punctuation">(</span><span class="token class-name">T</span> proxy<span class="token punctuation">,</span> <span class="token class-name">String</span> methodName<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> parameterTypes<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arguments<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>\n                <span class="token class-name">Method</span> method <span class="token operator">=</span> proxy<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span> parameterTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到这里返回了一个 AbstractProxyInvoker 对象，而 AbstractProxyInvoker 实现了 Invoker 接口。Invoker 接口定义如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60647815632625660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface Invoker<T> extends Node {\n   // 获取服务接口\n   Class<T> getInterface();\n   // 执行远程调用\n   Result invoke(Invocation invocation) throws RpcException;\n}`, `60647815632625660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 获取服务接口</span>\n   <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">getInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 执行远程调用</span>\n   <span class="token class-name">Result</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Dubbo 为我们提供了一组 Invoker 接口的实现类，其中包括前面看到的 AbstractProxyInvoker。</p>\n<p>我们已经在 JavaProxyFactory 中看到了构建一个 Invoker 对象的实现过程，背后使用的本质上就是反射机制。</p>\n<p>现在我们明白了，Invoker 就是 Dubbo 实现远程调用的实体类。对于服务发布和引用而言，这个 Invoker 贯穿始终，可以说也是一个一等公民。</p>\n<p>有了 Invoker 之后，我们再来关注 Exporter。我们看到 Exporter 是通过调用 Protocol 接口的 export 方法所生成的，这就需要我们对 Procotol 做一些回顾。Protocol 作为 Dubbo 中最基本的 RPC 组件，完成了服务的发布和调用功能，该接口定义如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79810529104546660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@SPI(&quot;dubbo&quot;)\npublic interface Protocol {\nint getDefaultPort();\n   @Adaptive\n   <T> Exporter<T> export(Invoker<T> invoker) throws RpcException;\n\n   @Adaptive\n   <T> Invoker<T> refer(Class<T> type, URL url) throws RpcException;\n\n   void destroy();\n}`, `79810529104546660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@SPI</span><span class="token punctuation">(</span><span class="token string">"dubbo"</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Protocol</span> <span class="token punctuation">{</span>\n<span class="token keyword">int</span> <span class="token function">getDefaultPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token annotation punctuation">@Adaptive</span>\n   <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> invoker<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span><span class="token punctuation">;</span>\n\n   <span class="token annotation punctuation">@Adaptive</span>\n   <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">refer</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> type<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从方法命名上不难看出，Protocol 接口中的核心方法就是 export 和 refer，前者用于对外暴露服务，而后者则用来对远程服务进行引用。当 Dubbo 获取 URL 之后会将 URL 传给 Protocol，Protocol 根据 URL 的协议头执行不同协议的服务暴露或引用。</p>\n<p>关于 URL 的格式我们在前面已经给出说明和示例。根据 URL 中是否包含注册中心信息，服务发布流程也会判断是否需要与注册中心进行交互。关于注册中心的讨论我们放在后面进行详细展开。这里给出不基于注册中心的服务暴露方式，即如下所示的 DubboProtocol 中 export 方法的实现过程。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98352263253628040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public <T> Exporter<T> export(Invoker<T> invoker) throws RpcException {\n   URL url = invoker.getUrl();\n\n   // 暴露服务\n   String key = serviceKey(url);\n   DubboExporter<T> exporter = new DubboExporter<T>(invoker, key, exporterMap);\n   exporterMap.put(key, exporter);\n\n   // 创建 Exchange 服务器\n   openServer(url);\n\n   return exporter;\n}`, `98352263253628040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> invoker<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>\n   <span class="token class-name">URL</span> url <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token comment">// 暴露服务</span>\n   <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token function">serviceKey</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token class-name">DubboExporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> exporter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DubboExporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>invoker<span class="token punctuation">,</span> key<span class="token punctuation">,</span> exporterMap<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   exporterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> exporter<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token comment">// 创建 Exchange 服务器</span>\n   <span class="token function">openServer</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">return</span> exporter<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里的 openServer 方法的目标是创建 Exchange 服务器，这是整个服务发布流程中的底层部分，我们已经在 <code class="language-text">网络通信：如何完成客户端和服务端之间的高效通信</code> 中做了详细介绍，你可以做相应的回顾。</p>\n<p>作为总结，我们把整个远程服务暴露流程做一个梳理，得到如下图所示的核心对象交互图：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-23-11-18-42-87bae7206359cc47845df0f71f52577d-53b00.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 608px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 58.7171052631579%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAABqklEQVQoz5WTW0/CQBCF+f+/g8QnH4w+GBQ1EhHBC9gLUCi03NpSir1KgbbH2SUhxFCMTSbTbjpnv50zW2h+XOG1cYbqU5FH/aWITucW398rsCfLMvznKSydKWxbw3jchabJsKwBXNdAkiRMjQsei7zNCuNRmwQVSFIVsvxM713MZgq22+1JkjzygvBZwnBwg0b9HM2PCwzUEtpyGYvFEmEYEq1POdqH5wVI0zSfMI+A1fSUJibjMtReCb3uNX1fw5g9UFv004JBEGA+t4hqwbNtzxFFEeI4woha0u8LaDVrULot6LpMpP5e8HdwwTiO4fs+F2bZ81xaW8NxLEwnLRiGiPe3MqZTAZYp0rqZ7/KpsTCMIR25QqJkmFQiugpM44mOLmCzSWi01pRTMjDDep0QxHZHmDcaaZpR0Yb/zIpY8Wq1c3846EDtlzHSH8lEttkj0dfyTTkkd10Xy6VDPbZ5+H6AMPiCPZfJJBGSWMFk8gln0TkueDi8bERYXx3H4cIsB0FIff7iF0HT2nTTKlBVkUSVfMK/rp1panyERvodJOGSen0Pz63jBxgqlI5VU+0pAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 23 11 18 42" title="" data-src="/static/2024-10-23-11-18-42-87bae7206359cc47845df0f71f52577d-53b00.png" data-srcset="/static/2024-10-23-11-18-42-87bae7206359cc47845df0f71f52577d-17576.png 200w,\n/static/2024-10-23-11-18-42-87bae7206359cc47845df0f71f52577d-52273.png 400w,\n/static/2024-10-23-11-18-42-87bae7206359cc47845df0f71f52577d-53b00.png 608w" data-sizes="(max-width: 608px) 100vw, 608px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>关于 Dubbo 中远程服务暴露的实现过程就介绍到这里，接下来我们讨论本地服务暴露过程。</p>\n<h3 id="本地服务暴露"><a href="#%E6%9C%AC%E5%9C%B0%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>本地服务暴露</h3>\n<p>我们回顾 ServiceConfig 中的服务暴露流程，存在如下所示的一个流程分支：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12805068993021184000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (!Constants.SCOPE_REMOTE.toString().equalsIgnoreCase(scope)) {\n   exportLocal(url);\n}`, `12805068993021184000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>SCOPE_REMOTE<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token function">exportLocal</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，如果 scope 没有被设置为远程暴露，则采用本地暴露模式暴露服务。那么，什么样的场景适合这种服务暴露模式呢？我们知道远程调用只会发生在跨 JVM 的场景，如果在同一个 JVM 中同时存在某一个服务的提供者和消费者，那么就可以将服务发布和引用过程控制在同一个 JVM 之内，从而避免远程网络通信所导致的性能消耗。</p>\n<p>Dubbo 中提供的 exportLocal 方法实现了这一过程，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92301129212252750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`private void exportLocal(URL url) {\n   if (!Constants.LOCAL_PROTOCOL.equalsIgnoreCase(url.getProtocol())) {\n      URL local = URL.valueOf(url.toFullString())\n               .setProtocol(Constants.LOCAL_PROTOCOL)\n               .setHost(LOCALHOST)\n               .setPort(0);\n      Exporter<?> exporter = protocol.export(proxyFactory.getInvoker(ref, (Class) interfaceClass, local));\n      exporters.add(exporter);\n   }\n}`, `92301129212252750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">exportLocal</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>LOCAL_PROTOCOL<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token class-name">URL</span> local <span class="token operator">=</span> URL<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">toFullString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n               <span class="token punctuation">.</span><span class="token function">setProtocol</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>LOCAL_PROTOCOL<span class="token punctuation">)</span>\n               <span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span>LOCALHOST<span class="token punctuation">)</span>\n               <span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> exporter <span class="token operator">=</span> protocol<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>proxyFactory<span class="token punctuation">.</span><span class="token function">getInvoker</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> interfaceClass<span class="token punctuation">,</span> local<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      exporters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>exporter<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里的特殊之处就在于当碰到场景为 local 的 URL 时，我们将它的协议设置为了 <code class="language-text">Constants.LOCAL_PROTOCOL</code>，即 <code class="language-text">injvm</code>。我们不难猜到 Protocol 接口应该存在一个名为 InjvmProtocol 的实现类。跟 DubboProtocol 相比，InjvmProtocol 的 export 方法就显得非常简单了，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18100506966673490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public <T> Exporter<T> export(Invoker<T> invoker) throws RpcException {\n   return new InjvmExporter<T>(invoker, invoker.getUrl().getServiceKey(), exporterMap);\n}`, `18100506966673490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> invoker<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InjvmExporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>invoker<span class="token punctuation">,</span> invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getServiceKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exporterMap<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，这里没有执行任何关于远程调用的操作，而是构建了一个 InjvmExporter 对象并直接返回，InjvmExporter 类的定义如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73373049403594236000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class InjvmExporter<T> extends AbstractExporter<T> {\n   private final String key;\n   private final Map<String, Exporter<?>> exporterMap;\n\n   InjvmExporter(Invoker<T> invoker, String key, Map<String, Exporter<?>> exporterMap) {\n      super(invoker);\n      this.key = key;\n      this.exporterMap = exporterMap;\n      exporterMap.put(key, this);\n   }\n\n   public void unexport() {\n      super.unexport();\n      exporterMap.remove(key);\n   }\n\n}`, `73373049403594236000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">InjvmExporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractExporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>\n   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> key<span class="token punctuation">;</span>\n   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Exporter</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span> exporterMap<span class="token punctuation">;</span>\n\n   <span class="token class-name">InjvmExporter</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> invoker<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Exporter</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span> exporterMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">super</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>exporterMap <span class="token operator">=</span> exporterMap<span class="token punctuation">;</span>\n      exporterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unexport</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">unexport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      exporterMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>看到这里，我们明白了所谓的本地暴露，Dubbo 只是将 InjvmExporter 对象放置到一个 Map 内存对象中。这样，我们就可以直接从 JVM 的内存中获取 InjvmExporter 对象来完成服务之间的调用。</p>\n<h2 id="解题要点-5"><a href="#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解题要点</h2>\n<p>本讲介绍的服务发布机制以及下一讲要介绍的服务引用过程都是属于技术实现流程类的面试题，这种面试题想要回答得很到位是有难度的，需要具备高度的抽象能力。本讲对这些流程进行了梳理，面试者只要对有一个基本的认识，就能从动态代理、协议、注册中心等关键技术组件出发，并对这些组件的作用和运行机制做一些展开。这样，面试官的主要考察目标基本就能满足了。</p>\n<p>请注意，考查技术实现流程性的面试题还有一个特点，就是它会关联到多个技术组件，相信你从本讲中所引用的其他各讲的数量就能感受到这一点。服务的发布需要注册中心，也需要底层的网络通信。在面试过程中，我们需要点到这些关联性的技术组件，并挑选自己比较熟悉的方向进行展开。</p>\n<p>最后，我们同样建议基于具体的开源框架来展开对技术实现流程的讨论。对于 Dubbo 框架，建议不用做过多展开，只需要点到最核心的几个概念即可，例如远程服务暴露和本地服务暴露这两种服务暴露类型。然后，我们也可以重点对 Dubbo 框架中的核心对象做一些分析，例如 URL 对象和 Invoker 对象。</p>\n<h2 id="小结与预告-3"><a href="#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结与预告</h2>\n<p>在远程过程调用的实现流程上，主要包括服务发布和服务引用两大维度。</p>\n<p>本讲内容围绕远程调用的发布流程展开了详细的讨论，这部分内容是我们构建分布式系统的基本前提。同时，基于这套服务发布流程，我们对 Dubbo 这款主流的分布式服务框架的内部实现原理，即如何完成远程/本地服务暴露的过程进行分析。</p>\n<p>介绍完服务发布流程和实现原理之后，下一讲我们继续讨论远程过程调用，我们要回答的一个核心问题是：服务引用有哪些实现方式？同样，我们也会基于 Dubbo 框架给出这个问题的答案。</p>\n<h1 id="远程调用：服务引用有哪些实现方式？"><a href="#%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%EF%BC%9A%E6%9C%8D%E5%8A%A1%E5%BC%95%E7%94%A8%E6%9C%89%E5%93%AA%E4%BA%9B%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>远程调用：服务引用有哪些实现方式？</h1>\n<p>在上一讲中，我们介绍了远程过程调用中的服务发布流程。我们知道服务发布的过程就是服务提供者对外暴露可访问入口的过程。基于所暴露的访问入口，服务消费者就可以成功发起远程调用。我们把这个过程称为服务引用。</p>\n<p>和服务发布类似，服务引用也具备一套完整的执行流程。那么，服务引用有哪些具体的实现方式呢？这就是本讲要介绍的内容。</p>\n<h2 id="问题背景-3"><a href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题背景</h2>\n<p>在分布式系统中，系统的能力来自于服务与服务之间的交互和集成。为了实现这一过程，就需要服务消费者对服务提供者所暴露的入口进行访问。假设我们继续使用 UserService 作为业务接口，那么服务引用的一种表现形式可以采用如下所示的代码风格：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27064964714045180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RpcClient client = new RpcClient(…);\nUserService service = client.refer(UserService.class);\nservice.getUserNameByCode(&quot;user1&quot;);`, `27064964714045180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">RpcClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcClient</span><span class="token punctuation">(</span>…<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token class-name">UserService</span> service <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">refer</span><span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nservice<span class="token punctuation">.</span><span class="token function">getUserNameByCode</span><span class="token punctuation">(</span><span class="token string">"user1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>和服务发布的过程类似，服务引用看上去并不复杂，但背后要考虑的事情也非常多，包括：</p>\n<ul>\n<li>如何实现远程调用过程的透明化？</li>\n<li>如何使用缓存机制提高远程调用的效率？</li>\n<li>除了缓存机制，你还有什么办法可以提高远程调用的性能？</li>\n<li>如何实现异步调用、泛化调用等多种调用形式？</li>\n</ul>\n<p>实际上，相较服务发布，服务引用是一个更为复杂的话题，涉及的技术组件众多。后续几讲要介绍的负载均衡、服务容错等机制都发生在服务引用阶段，这些机制对于服务发布而言是不需要考虑的。</p>\n<p>当然，如果针对 Dubbo 等具体的实现框架，面试官也可以这样来进行提问：</p>\n<ul>\n<li>Dubbo 中所采用的服务引用流程是怎么样的？</li>\n<li>Dubbo 框架中提供了哪几种服务调用方式？</li>\n</ul>\n<p>同样，这些问题看上去侧重点各有不同，但其实都是围绕着一套服务引用流程来展开的，让我们来对这些问题做进一步分析。</p>\n<h2 id="问题分析-4"><a href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题分析</h2>\n<p>对于远程过程调用而言，服务引用和服务发布是两个对应的技术组件。因此，上一讲中所有关于服务发布的问题分析方法同样适用于服务引用过程，这部分内容这里就不一一展开，你可以参考上一讲内容做一些回顾。</p>\n<p>然而，对于服务引用而言，也存在与服务发布不一样的地方。首要一点在于服务引用的类型可以是多样的，我们可以使用同步调用、异步调用等多种方式来完成远程调用过程。</p>\n<p>在日常开发过程中，开发人员倾向于使用同步调用模式来完成远程调用，因为这一模式对于编码过程而言非常友好。而从性能上讲，异步调用模式显然更具优势，但实现复杂度较高。这就诞生了一种新的实现机制，即 <code class="language-text">异步转同步</code>，诸如 Dubbo 等框架就内置了这种实现机制。</p>\n<p>在面试过程中，除了介绍通用的服务引用流程，候选人最好能够对服务的引用类型，以及异步转同步这一特定技术实现机制做一定的展开，这些都是提高面试成功率的加分项。</p>\n<h2 id="技术体系-6"><a href="#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术体系</h2>\n<h3 id="通用服务引用流程"><a href="#%E9%80%9A%E7%94%A8%E6%9C%8D%E5%8A%A1%E5%BC%95%E7%94%A8%E6%B5%81%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>通用服务引用流程</h3>\n<p>相较服务发布，服务的调用是一个导入（Import）的过程，整体流程如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-28-18-24-26-6262a7239637e37f87518d2ced6aa6b5-7f86d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.013245033112575%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABP0lEQVQoz41S206DQBTk/7/HS6NvPmuiVjSaIE0JCVDKpQXKfdw5eBTbaJxkwrI9nZ2ZxXpaXuLduUXXdRgGII59vNhXsJcLRJEH33/Fw/2Z4QJFkcvMdhvg2b7G8vEcnvcG170z6ws4zg2sqqqQ5xn2+z12ux3KskTf90IF1wOVZuA7TUwYzUyHcRxhhWFoXMUyQHJTRj6fulZB3Z8Lco9r/mRlWSaC5GazQZIkJoYnTg+HA5igKIof4qcOpxTikH/SiFOPg4gwfp7n8gyCwPS2lVqiKDK9+litVqY7V4xwjmYIETxG27ZCBQ+gIA/Vw5gsTVPUdS2zFP1yeNxb0zRCBSPTFUVYBd/J+cVR9E9BnqxgVEbSSyMppim+L+UXQQ6yG/bFqPolkHTJi1uv1+L234LzDvWTmoMOtZa54Af/NAdjn4yNWgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 28 18 24 26" title="" data-src="/static/2024-10-28-18-24-26-6262a7239637e37f87518d2ced6aa6b5-fee1c.png" data-srcset="/static/2024-10-28-18-24-26-6262a7239637e37f87518d2ced6aa6b5-a67b7.png 200w,\n/static/2024-10-28-18-24-26-6262a7239637e37f87518d2ced6aa6b5-0b187.png 400w,\n/static/2024-10-28-18-24-26-6262a7239637e37f87518d2ced6aa6b5-fee1c.png 800w,\n/static/2024-10-28-18-24-26-6262a7239637e37f87518d2ced6aa6b5-7f86d.png 906w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在上图中，我们可以看到服务调用流程与服务发布流程呈对称结构，所包含的组件包括以下。</p>\n<ol>\n<li>\n<p>调用启动器。调用启动器和上一讲介绍的发布启动器是对应的，这里不再重复介绍。</p>\n</li>\n<li>\n<p>动态代理。在服务引用过程中，动态代理的作用就是确保远程调用过程的透明化，即开发人员可以使用本地对象来完成对远程对象的处理，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-28-18-26-12-948b7a967f9bbdf96f4c41e95f1683af-72de5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 648px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 25.462962962962965%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAAA8klEQVQY032Q3U7CQBCF9/1fRaQgqV6oaSRR0mKhW6TQFr3CG0KFYuv+0R6njYkXIif5srOzm8mZw3y/j3hpgwc9TP0uFtEVksSDMTXq+i9VVaFRHLtYLgYIphY4EXILaeqAcW7Tgw3PvcB43MHLzKKBLsyxxjmF/IFMdOA/dzEhI8HkEm+vQzAhFYQQUEq1lOUXis+i7W02Gd0l1RpCahSFIEporbDdZtjt9lRrSClbhJBg/zk4HHKMnvpIYgfz+T1m4S3SxEEUefjZ+qTYqZwa5fkeq9U13tc3tMqAhvXwkd1Rdo+Ub/PjN1NDDWN0e34DuVx1rTEJGREAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 28 18 26 12" title="" data-src="/static/2024-10-28-18-26-12-948b7a967f9bbdf96f4c41e95f1683af-72de5.png" data-srcset="/static/2024-10-28-18-26-12-948b7a967f9bbdf96f4c41e95f1683af-bb436.png 200w,\n/static/2024-10-28-18-26-12-948b7a967f9bbdf96f4c41e95f1683af-c5634.png 400w,\n/static/2024-10-28-18-26-12-948b7a967f9bbdf96f4c41e95f1683af-72de5.png 648w" data-sizes="(max-width: 648px) 100vw, 648px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n</li>\n<li>\n<p>调用管理器。和发布管理器相比，调用管理器的核心功能是提供了一种缓存机制，从而根据保存在服务调用者本地的远程服务地址信息来发起调用。</p>\n</li>\n<li>\n<p>协议客户端。和协议服务器相对应，协议客户端会创建与服务端的网络连接，发起请求并获取结果。</p>\n</li>\n<li>\n<p>注册中心。注册中心在这里的作用是提供查询服务定义元数据的入口。</p>\n</li>\n</ol>\n<p>以上所示的服务引用流程图同样有一定的共性，可以通过转化映射到具体的某个框架。事实上，基于 Dubbo 的服务引用流程与上述过程也比较类似。</p>\n<p>另一方面，与服务发布相比，Dubbo 等分布式服务框架中的服务引用整体过程会更加复杂一点。在服务调用过程中，因为面对的服务一般都会部署成集群模式，势必涉及到负载均衡。而如果调用超时或失败，还会采用集群容错机制。关于负载均衡和集群容错等内容不在这里讨论，我们在介绍完本讲内容之后马上就会有专门的主题进行详细阐述。</p>\n<h3 id="服务调用的类型"><a href="#%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8%E7%9A%84%E7%B1%BB%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务调用的类型</h3>\n<p>服务调用存在两种基本方式，即同步调用模式和异步调用模式。其中，同步调用的示意图如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-28-18-27-34-3094819fb5c977b04140eb1a5fc680b9-ff6e4.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 479px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 47.39039665970772%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABPUlEQVQoz5WSW0vDQBCF8/9/TwUV8SWgfeqTtiXmatJkY5r7rbn1uDPY0FoqeGDYZWbny5khyvvbHcpiCcu8h2M94NN5Ql0uoWnPaNsOpOPx+BMTpgn40FRkqQpbvuc++xFF/opQvEAJggC+7yMMBWzbRhR9gXJxHOOW0jTFbrdDUeTw5el5LjNEIKD8ftg0DQ6Hg3TXIssyhuu6js1mg+12izzPuTYMIxzH4dq5lIlmkCKQ67ooy1IC2xmYJIl0HzKYQgjBUFrBer2GqqrzWoil0OUE3O/3WCwWcicOuq7jZhrFsiwYhsEnuSRwXdfcQ7lhGGboDKQxPc/jr/Z9z0B6SDGO4xzkgnJ913OPaZqcvwLSiASsqgr/kaZpbOAKSPajKGJnl7/K7SDRWs57LhyuVquL4l861cnd+cjfI06yip0BrwcAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 28 18 27 34" title="" data-src="/static/2024-10-28-18-27-34-3094819fb5c977b04140eb1a5fc680b9-ff6e4.png" data-srcset="/static/2024-10-28-18-27-34-3094819fb5c977b04140eb1a5fc680b9-d5807.png 200w,\n/static/2024-10-28-18-27-34-3094819fb5c977b04140eb1a5fc680b9-dba8d.png 400w,\n/static/2024-10-28-18-27-34-3094819fb5c977b04140eb1a5fc680b9-ff6e4.png 479w" data-sizes="(max-width: 479px) 100vw, 479px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可以看到，同步调用的执行流程比较简单。在同步调用中，服务消费者在获取来自服务提供者的响应结果之前一直处于等待状态。</p>\n<p>而异步调用则不同，服务消费者一旦发送完请求之后就可以继续执行其他操作，直到服务提供者异步返回结果并通知服务消费者进行接收，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-28-18-28-09-875b24a3310338fd19e7235601b15c93-96dff.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 494px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 105.46558704453442%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsSAAALEgHS3X78AAACWUlEQVQ4y51UiWrbQBD1//9IKYSGNIbQFkoxNgTqJvUhy64t+ZTk2/Ip36/71hlVShyDO7BotTvz5s2xk7AtA2UziXzuDr+fb5H9eYNK+QHFQhKe54ByOBxwPB7V7qj2QMl4hG19wdOvT3h+utVfq/YV6fQHJGzbQKf9TSk8KKB7mKXPcJ3vsJSB67Y14AnsJPs9UC4/YtD/gYpJ/Tv8KSfVf0qR+YjEZrPBZDLBfD7HeDzGaDTCYjHHdDoNme12O722260GXa/X8P0JgmClbEbanvr8JhARHvZ6fSyXK+1gNpuh2+2iVqvpZRiGuu8phwuls9TOLctSjv9FkCADMqG4rovBYBDmjayCINCOhsPhC/uFYn1ivlqtUK1WQ+Y8iwE2m03k8/mQHVPgeR7a7bZmYts2Op1OeO/7Pur1unYcAkZDdhxHs4hX9q3wXHLbarXiDOlVgPr9vs6ZJJgMeE6mXDzjP+9PFd9r9jHAXC6HQqGgc0dgglIYGs9fh0QQggvgG4Y0YMIJWCwWkUqldB7JgqASnghTQebvAjIMESpms1ldOSqz36J5E0CxOQsoRZAwqfAaIMryKkA2rYRzrrJXA/KCzUrhOfPLKkqfXg3IKrOBWWnuS6WSZvzfgNyn02lkMpmXAeDHGllALgJKT0kOOQQuCY0utg1fBhuXl8wZB4S0DEebjC7RobFEdRaQDS3PzFNgBGRT858Nz1yyMPzSmAOEE0gA2GoxwGg4DL9SqehZx0VAGjQajXDx7XPSyLQxTVNHcnZ80VjeMkN8b+IwVAmfTqIM/wLLqUdt7xdHBAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 28 18 28 09" title="" data-src="/static/2024-10-28-18-28-09-875b24a3310338fd19e7235601b15c93-96dff.png" data-srcset="/static/2024-10-28-18-28-09-875b24a3310338fd19e7235601b15c93-1a6e9.png 200w,\n/static/2024-10-28-18-28-09-875b24a3310338fd19e7235601b15c93-b9533.png 400w,\n/static/2024-10-28-18-28-09-875b24a3310338fd19e7235601b15c93-96dff.png 494w" data-sizes="(max-width: 494px) 100vw, 494px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>显然，使用异步调用的目的在于获取高性能。但是，异步调用的开发过程比较复杂，对开发人员的要求较高，所以很多 RPC 框架提供了专门的异步转同步机制，即面向开发人员提供的是同步调用的 API，而具体执行过程则使用的是异步机制。</p>\n<p>除了同步和异步调用之外，还存在并行（Parallel）调用和泛化（Generic）调用等调用方法，这些调用方式并不常见，我们不做具体展开。</p>\n<h2 id="源码解析-4"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h2>\n<p>与 ServiceConfig 中的 export 方法相对应，ReferenceConfig 中也存在一个 init 方法，该方法就是 Dubbo 服务引用流程的入口。</p>\n<h3 id="服务引用"><a href="#%E6%9C%8D%E5%8A%A1%E5%BC%95%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务引用</h3>\n<p>在 ReferenceConfig 的 init 方法中，Dubbo 做了非常多的准备和校验工作，最终来到了如下所示的这行代码中：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83606595547651010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ref = createProxy(map);`, `83606595547651010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java">ref <span class="token operator">=</span> <span class="token function">createProxy</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这个 createProxy 方法是理解服务引用的关键入口，我们梳理它的主体结构如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94217584994056450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`private T createProxy(Map<String, String> map) {\n       if (isJvmRefer) {\n            // 生成本地引用 URL，使用 injvm 协议进行本地调用\n            URL url = new URL(Constants.LOCAL_PROTOCOL, NetUtils.LOCALHOST, 0, interfaceClass.getName()).addParameters(map);\n            invoker = refprotocol.refer(interfaceClass, url);\n        } else {\n            if (url != null && url.length() > 0) {\n                // URL 不为空，执行点对点调用\n            } else {\n                // 加载注册中心 URL\n            }\n\n            if (urls.size() == 1) {\n                // 单个服务提供者，直接调用\n                invoker = refprotocol.refer(interfaceClass, urls.get(0));\n            } else {\n                // 多个服务提供者\n                List<Invoker<?>> invokers = new ArrayList<Invoker<?>>();\n                URL registryURL = null;\n                for (URL url: urls) {\n                    invokers.add(refprotocol.refer(interfaceClass, url));\n                    if (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) {\n                        registryURL = url;\n                    }\n                }\n                if (registryURL != null) {\n                    // 如果注册中心链接不为空，则将使用 AvailableCluster\n                    URL u = registryURL.addParameter(Constants.CLUSTER_KEY, AvailableCluster.NAME);\n                    invoker = cluster.join(new StaticDirectory(u, invokers));\n                } else {\n                    invoker = cluster.join(new StaticDirectory(invokers));\n                }\n           }\n\n           // 生成服务代理类\n           return (T) proxyFactory.getProxy(invoker);\n}`, `94217584994056450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">T</span> <span class="token function">createProxy</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n       <span class="token keyword">if</span> <span class="token punctuation">(</span>isJvmRefer<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 生成本地引用 URL，使用 injvm 协议进行本地调用</span>\n            <span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">URL</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>LOCAL_PROTOCOL<span class="token punctuation">,</span> <span class="token class-name">NetUtils</span><span class="token punctuation">.</span>LOCALHOST<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> interfaceClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addParameters</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            invoker <span class="token operator">=</span> refprotocol<span class="token punctuation">.</span><span class="token function">refer</span><span class="token punctuation">(</span>interfaceClass<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> url<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token comment">// URL 不为空，执行点对点调用</span>\n            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n                <span class="token comment">// 加载注册中心 URL</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>urls<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token comment">// 单个服务提供者，直接调用</span>\n                invoker <span class="token operator">=</span> refprotocol<span class="token punctuation">.</span><span class="token function">refer</span><span class="token punctuation">(</span>interfaceClass<span class="token punctuation">,</span> urls<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n                <span class="token comment">// 多个服务提供者</span>\n                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span> invokers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token class-name">URL</span> registryURL <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n                <span class="token keyword">for</span> <span class="token punctuation">(</span>URL url<span class="token operator">:</span> urls<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    invokers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>refprotocol<span class="token punctuation">.</span><span class="token function">refer</span><span class="token punctuation">(</span>interfaceClass<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>REGISTRY_PROTOCOL<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                        registryURL <span class="token operator">=</span> url<span class="token punctuation">;</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n                <span class="token keyword">if</span> <span class="token punctuation">(</span>registryURL <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    <span class="token comment">// 如果注册中心链接不为空，则将使用 AvailableCluster</span>\n                    <span class="token class-name">URL</span> u <span class="token operator">=</span> registryURL<span class="token punctuation">.</span><span class="token function">addParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>CLUSTER_KEY<span class="token punctuation">,</span> <span class="token class-name">AvailableCluster</span><span class="token punctuation">.</span>NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    invoker <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StaticDirectory</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> invokers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n                    invoker <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StaticDirectory</span><span class="token punctuation">(</span>invokers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span>\n           <span class="token punctuation">}</span>\n\n           <span class="token comment">// 生成服务代理类</span>\n           <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> proxyFactory<span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>虽然 createProxy 方法的代码比较长，但它的执行逻辑还是比较清晰的。首先我们根据配置检查是否为本地调用，如果是则调用 InjvmProtocol 的 refer 方法生成 InjvmInvoker 实例；如果不是，则读取 URL 配置项，包括用于直联的 URL 或基于注册中心的 URL。</p>\n<p>然后，我们对 URL 对象数量进行判断。如果 URL 数量为 1，则直接通过 Protocol 构建 Invoker 对象；如果 URL 数量大于 1，即存在多个服务地址，此时先根据每个 URL 构建 Invoker，然后再通过集群对象 Cluster 合并多个 Invoker，最后调用 ProxyFactory 生成代理类。</p>\n<p>这个过程实际上完成了两个步骤，首先是创建 Invoker 对象，然后才是生成服务代理类，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-28-18-29-25-29d805b6dae44431ade05392b8700431-73362.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 609px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 34.8111658456486%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABXElEQVQoz22R7U+CUBTG+f//haZba6u2PuSnasspKKKpSz9YiiIICILazBcQ5OXpeCmrzbM93HHvc38757lcmoKKfbDfh5jPlzCMKRzHxWazg+8HOFeZd8G8tu1gt/NpLwCXZkQ4Mwu6LmBqVjAaFjGUn2FbIjSVh2UZiOOYLuwRhgf0eh3mU8j3/vZIeoKh86QauCRJGNC2DdooY6KVINVuURWu2b+mlqCqI3iej/X6k7reotttElAg0AM6rwUmTS2SXwT3d4w4TrFYLKl9jwFcd44kSc+O7HlZt4dDxHQc9xgDFwQRtlsfx3VqzWg853TJdZcUg0k5hgzgeVmePzGdK04eVKFPRKhjEa1mATJlZ1kDmKaCscLjpXEPZSTQeYXikLBafXxDEwbO4L/i6tIN2q0r8OULVIQ86lIO8qCGfr+NhpSnPC8pzxwEOu927uj17X/A4xtEUXTSF5mrCEFtcS8+AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 28 18 29 25" title="" data-src="/static/2024-10-28-18-29-25-29d805b6dae44431ade05392b8700431-73362.png" data-srcset="/static/2024-10-28-18-29-25-29d805b6dae44431ade05392b8700431-06e0b.png 200w,\n/static/2024-10-28-18-29-25-29d805b6dae44431ade05392b8700431-70531.png 400w,\n/static/2024-10-28-18-29-25-29d805b6dae44431ade05392b8700431-73362.png 609w" data-sizes="(max-width: 609px) 100vw, 609px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>显然，上述流程中，我们需要重点关注服务引用过程中 Invoker 对象的构建过程。那么问题来了，这里的这个 Invoker 是从何而来呢？实际上，Invoker 的构建过程是在 Protocol 中。与服务暴露的讲解思路一样，我们将从 DubboProtocol 这个 Protocol 的 refer 方法入手，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50131901846045810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public <T> Invoker<T> refer(Class<T> serviceType, URL url) throws RpcException {\n        DubboInvoker<T> invoker = new DubboInvoker<T>(serviceType, url, getClients(url), invokers);\n        invokers.add(invoker);\n        return invoker;\n}`, `50131901846045810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">refer</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> serviceType<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>\n        <span class="token class-name">DubboInvoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> invoker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DubboInvoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>serviceType<span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token function">getClients</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">,</span> invokers<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        invokers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> invoker<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里出现了一个 getClients 方法，该方法用于获取客户端实例，实例类型为 ExchangeClient。我们已经在介绍 Dubbo 客户端通信原理时介绍过 ExchangeClient，可以参考前面做一些回顾。在理解了 getClients 方法之后，我们发现 DubboProtocol 的 refer 方法的作用就是返回一个新建的 DubboInvoker。</p>\n<p>DubboInvoker 继承了 AbstractInvoker，而 AbstractInvoker 实现了 Invoker 接口。AbstractInvoker 是一个抽象的模板方法类，提供了一个 doInvoke 模板方法。我们来看 DubboInvoker 中如何实现了这个模板方法，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62979649892711280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Override\nprotected Result doInvoke(final Invocation invocation) throws Throwable {\n        RpcInvocation inv = (RpcInvocation) invocation;\n        final String methodName = RpcUtils.getMethodName(invocation);\n        inv.setAttachment(Constants.PATH_KEY, getUrl().getPath());\n        inv.setAttachment(Constants.VERSION_KEY, version);\n\n        ExchangeClient currentClient;\n        if (clients.length == 1) {\n            currentClient = clients[0];\n        } else {\n            currentClient = clients[index.getAndIncrement() % clients.length];\n        }\n        try {\n            boolean isAsync = RpcUtils.isAsync(getUrl(), invocation);\n            boolean isOneway = RpcUtils.isOneway(getUrl(), invocation);\n            int timeout = getUrl().getMethodParameter(methodName, Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT);\n            if (isOneway) { // 单向调用\n                boolean isSent = getUrl().getMethodParameter(methodName, Constants.SENT_KEY, false);\n                currentClient.send(inv, isSent);\n                RpcContext.getContext().setFuture(null);\n                return new RpcResult();\n            } else if (isAsync) { // 异步调用\n                ResponseFuture future = currentClient.request(inv, timeout);\n                RpcContext.getContext().setFuture(new FutureAdapter<Object>(future));\n                return new RpcResult();\n            } else { // 同步调用\n                RpcContext.getContext().setFuture(null);\n                return (Result) currentClient.request(inv, timeout).get();\n            }\n        } catch (TimeoutException e) {\n}`, `62979649892711280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">protected</span> <span class="token class-name">Result</span> <span class="token function">doInvoke</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>\n        <span class="token class-name">RpcInvocation</span> inv <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RpcInvocation</span><span class="token punctuation">)</span> invocation<span class="token punctuation">;</span>\n        <span class="token keyword">final</span> <span class="token class-name">String</span> methodName <span class="token operator">=</span> <span class="token class-name">RpcUtils</span><span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        inv<span class="token punctuation">.</span><span class="token function">setAttachment</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>PATH_KEY<span class="token punctuation">,</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        inv<span class="token punctuation">.</span><span class="token function">setAttachment</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>VERSION_KEY<span class="token punctuation">,</span> version<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token class-name">ExchangeClient</span> currentClient<span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>clients<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            currentClient <span class="token operator">=</span> clients<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            currentClient <span class="token operator">=</span> clients<span class="token punctuation">[</span>index<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> clients<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            <span class="token keyword">boolean</span> isAsync <span class="token operator">=</span> <span class="token class-name">RpcUtils</span><span class="token punctuation">.</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">boolean</span> isOneway <span class="token operator">=</span> <span class="token class-name">RpcUtils</span><span class="token punctuation">.</span><span class="token function">isOneway</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">int</span> timeout <span class="token operator">=</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethodParameter</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>TIMEOUT_KEY<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>DEFAULT_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>isOneway<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 单向调用</span>\n                <span class="token keyword">boolean</span> isSent <span class="token operator">=</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethodParameter</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>SENT_KEY<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                currentClient<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>inv<span class="token punctuation">,</span> isSent<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFuture</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RpcResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isAsync<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 异步调用</span>\n                <span class="token class-name">ResponseFuture</span> future <span class="token operator">=</span> currentClient<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>inv<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFuture</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FutureAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>future<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RpcResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 同步调用</span>\n                <span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFuture</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token punctuation">)</span> currentClient<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>inv<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TimeoutException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，Dubbo 的远程调用存在三种调用方式，即单向调用、异步无返回以及异步转同步。上述方法就包含了这三种调用方式的实现过程，而这些远程调用最终都是通过 ExchangeClient 进行完成。</p>\n<p>在 Dubbo 提供的这三种远程调用方式中，异步转同步是默认的实现方式。接下来，我们重点对这一过程做具体展开。</p>\n<h3 id="服务调用异步转同步过程"><a href="#%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8%E5%BC%82%E6%AD%A5%E8%BD%AC%E5%90%8C%E6%AD%A5%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务调用异步转同步过程</h3>\n<p>在介绍 Dubbo 中异步转同步的服务调用方式之前，我们先围绕 JDK 中的 Future 模式讨论如何实现异步调用。</p>\n<p>Future 模式是对传统调用模式的一种改进，它们之间的对比可以参考下图：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-10-28-18-30-33-8ff8a8d88c968f72e7dc7b054c9606e1-037b2.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 499px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 102.00400801603206%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAACAUlEQVQ4y6VUa2/aQBD0//8n+VJURShNWrWJVAXST26Ki4FAEOZlwIB5g8HTmyXnHNStIFlpJfvudnZ29vasfO4DPO8bCr8u8dP+iJJ7hefaDRwnD1ocx4nvdjtZK5dtdS4rMfncBXL3F6hVb1D8/RnW4+MllvMfaHpfUK9dw+/eIRx/h+s+JIDa4ngP+PRkq3Nfld8qoE+oVq9UzD28xh2swWCAXq+nNn10u12MhkP5XywWCdBms8F6vU7AV8ulnBmNRuh0OgiCPUYwCGDpIJYzHoeIokgAVqsVlipwOp2i0WioMssYBoGs06NoK0mbzSZMs3QZPOQ4DmazWeLz+VycgXT9/7o/Q6FQUAyDhJSly2BJLP9cGyqJWInWOwFkqXRmoR49X+nq+6LRdrv9q+M6ztT6peRXhpVKRej3+320Wi1MJhNZ19flsOP7b0pg7h8wLBaLyGQyCMNQNWgszTGZmZYGeMCQZRFQC3xc4tkM2WUCmtnSGJ3MkOVpgXn36Cyb/iYNKb7neXIF2u026vW6NIfXwuzyyYBkyEuazWahx5FJ3tUU13XVoFflAP+P753ZnJMYcvTMbMfM0sA5gv/sMvVKM804zRhnJj242Bw1Tod+aaghnyi+NqVSSbTlGvfoPMc1xqZ22bZtmRLzZfmfE5CaM2lqyWR4rjGG4BrwDx7eDjmOA8KkAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 10 28 18 30 33" title="" data-src="/static/2024-10-28-18-30-33-8ff8a8d88c968f72e7dc7b054c9606e1-037b2.png" data-srcset="/static/2024-10-28-18-30-33-8ff8a8d88c968f72e7dc7b054c9606e1-fd89b.png 200w,\n/static/2024-10-28-18-30-33-8ff8a8d88c968f72e7dc7b054c9606e1-a94ea.png 400w,\n/static/2024-10-28-18-30-33-8ff8a8d88c968f72e7dc7b054c9606e1-037b2.png 499w" data-sizes="(max-width: 499px) 100vw, 499px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>本质上，Future 模式为我们提供了一种无需等待的服务调用机制。当我们发起一次服务调用时，Future 机制可以直接返回并继续执行其他任务，而不是像传统调用模式那样一直需要等到调用方法的返回。</p>\n<p>JDK 对 Future 模式提供了内置的实现，表现为如下所示的 Future 接口：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73486610219937680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface Future<V> {\n   // 取消执行\n   boolean cancel(boolean mayInterruptIfRunning);\n   // 判断是否已取消\n   boolean isCancelled();\n   // 判断是否已完成\n   boolean isDone();\n   // 等待任务执行完毕并获取结果\n   V get() throws InterruptedException, ExecutionException;\n   // 基于一定的超时时间等待任务执行完毕并获取结果\n   V get(long timeout, TimeUnit unit) throws InterruptedException, ExecutionException, TimeoutException;\n}`, `73486610219937680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>\n   <span class="token comment">// 取消执行</span>\n   <span class="token keyword">boolean</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> mayInterruptIfRunning<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 判断是否已取消</span>\n   <span class="token keyword">boolean</span> <span class="token function">isCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 判断是否已完成</span>\n   <span class="token keyword">boolean</span> <span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 等待任务执行完毕并获取结果</span>\n   <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">;</span>\n   <span class="token comment">// 基于一定的超时时间等待任务执行完毕并获取结果</span>\n   <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Dubbo 中大量使用了基于 Future 机制的异步调用过程，同时也提供了异步转同步的实现机制，这是 Dubbo 提供的这三种远程调用方式中默认的实现方式。这部分内容实际上已经超出了服务引用的范围，而是更多偏向于讨论底层的网络通信，所以需要你对网络通信相关的内容先进行学习和掌握。</p>\n<p>在 DubboInvoker 中 doInvoke 方法中，异步转同步过程的实现如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81454726833650830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RpcContext.getContext().setFuture(null);\nreturn (Result) currentClient.request(inv, timeout).get();`, `81454726833650830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFuture</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token punctuation">)</span> currentClient<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>inv<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>我们先来看这里的 request 方法定义（位于 HeaderExchangeChannel 类中），如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9836578440960442000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public ResponseFuture request(Object request, int timeout) throws RemotingException {\n   Request req = new Request();\n   req.setVersion(&quot;2.0.0&quot;);\n   req.setTwoWay(true);\n   req.setData(request);\n   DefaultFuture future = new DefaultFuture(channel, req, timeout);\n   try {\n      channel.send(req);\n   } catch (RemotingException e) {\n      future.cancel();\n      throw e;\n   }\n   return future;\n}`, `9836578440960442000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">ResponseFuture</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token class-name">Object</span> request<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>\n   <span class="token class-name">Request</span> req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   req<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token string">"2.0.0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   req<span class="token punctuation">.</span><span class="token function">setTwoWay</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   req<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token class-name">DefaultFuture</span> future <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultFuture</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> req<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      channel<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemotingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      future<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">throw</span> e<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">return</span> future<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>请注意，这里用于发送请求的 channel.send 方法是异步执行的，也就说该方法一旦调用就会直接返回。为了实现“异步转同步”，Dubbo 在这里使用了 DefaultFuture 这个辅助类。请记住这个类，我们在后续内容中还会再次提到该类。</p>\n<p>另一方面，我们在介绍网络通信时也提到，当请求到达服务器端时，在 NettyServer 中会使用一个 NettyHandler 作为网络事件的处理器，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87291821525463800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pipeline.addLast(&quot;handler&quot;, nettyHandler);`, `87291821525463800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java">pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">"handler"</span><span class="token punctuation">,</span> nettyHandler<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>NettyHandler 是一个接口，我们来看它的 messageReceived 方法实现，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76448011399086060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`private final ChannelHandler handler;\n\n@Override\npublic void messageReceived(ChannelHandlerContext ctx, MessageEvent e) throws Exception {\n        NettyChannel channel = NettyChannel.getOrAddChannel(ctx.getChannel(), url, handler);\n        try {\n            handler.received(channel, e.getMessage());\n        } finally {\n            NettyChannel.removeChannelIfDisconnected(ctx.getChannel());\n        }\n}`, `76448011399086060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">;</span>\n\n<span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">messageReceived</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">MessageEvent</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>\n        <span class="token class-name">NettyChannel</span> channel <span class="token operator">=</span> <span class="token class-name">NettyChannel</span><span class="token punctuation">.</span><span class="token function">getOrAddChannel</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            handler<span class="token punctuation">.</span><span class="token function">received</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>\n            <span class="token class-name">NettyChannel</span><span class="token punctuation">.</span><span class="token function">removeChannelIfDisconnected</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里把具体的处理逻辑转移到了 Dubbo 中自定义的 ChannelHandler 接口，这个接口有很多实现类，也包括 ChannelHandlerDelegate 这个代理类，而真正处理事件接收逻辑的 HeaderExchangeHandler 正是实现了这个代理类。HeaderExchangeHandler 中处理响应的实现过程如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63407227247045214000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`static void handleResponse(Channel channel, Response response) throws RemotingException {\n        if (response != null && !response.isHeartbeat()) {\n            DefaultFuture.received(channel, response);\n        }\n}`, `63407227247045214000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">handleResponse</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Response</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>response <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>response<span class="token punctuation">.</span><span class="token function">isHeartbeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token class-name">DefaultFuture</span><span class="token punctuation">.</span><span class="token function">received</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们在这里再次看到了 DefaultFuture，这里的 DefaultFuture 就是前面客户端发送请求时用到的 DefaultFuture。DefaultFuture 的 received 方法中有进一步调用了如下所示的 doReceived 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99578310401868890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`private void doReceived(Response res) {\n        lock.lock();\n        try {\n            // 设置响应 response 对象\n            response = res;\n            if (done != null) {\n               // 唤醒阻塞的线程\n               done.signal();\n            }\n        } finally {\n            lock.unlock();\n        }\n\n        if (callback != null) {\n            invokeCallback(callback);\n        }\n}`, `99578310401868890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doReceived</span><span class="token punctuation">(</span><span class="token class-name">Response</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 设置响应 response 对象</span>\n            response <span class="token operator">=</span> res<span class="token punctuation">;</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>done <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token comment">// 唤醒阻塞的线程</span>\n               done<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>\n            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token function">invokeCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意到这里的 done.signal 方法的执行效果会唤醒阻塞的线程，那么这个阻塞的线程在哪里的？显然，这时候我们应该回到客户端组件看看同步获取调用结果的入口。</p>\n<p>我们再次回到在 DubboInvoker 中 doInvoke 方法中，看到了如下所示的核心代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7217386673629856000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RpcContext.getContext().setFuture(null);\nreturn (Result) currentClient.request(inv, timeout).get();`, `7217386673629856000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">RpcContext</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFuture</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token punctuation">)</span> currentClient<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>inv<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>我们来具体看一下这个获取调用结果的 get 方法执行逻辑，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73874010973138420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public Object get(int timeout) throws RemotingException {\n        if (timeout <= 0) {\n            timeout = Constants.DEFAULT_TIMEOUT;\n        }\n        if (!isDone()) {\n            long start = System.currentTimeMillis();\n            lock.lock();\n            try {\n                while (!isDone()) { // 当响应 response 对象为空\n                    done.await(timeout, TimeUnit.MILLISECONDS);\n                    if (isDone() || System.currentTimeMillis() - start > timeout) {\n                        break;\n                    }\n                }\n            } catch (InterruptedException e) {\n                throw new RuntimeException(e);\n            } finally {\n                lock.unlock();\n            }\n            if (!isDone()) {\n                throw new TimeoutException(sent > 0, channel, getTimeoutMessage(false));\n            }\n        }\n        return returnFromResponse();\n}`, `73874010973138420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            timeout <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>DEFAULT_TIMEOUT<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">try</span> <span class="token punctuation">{</span>\n                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 当响应 response 对象为空</span>\n                    done<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start <span class="token operator">></span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                        <span class="token keyword">break</span><span class="token punctuation">;</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>\n                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">(</span>sent <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> channel<span class="token punctuation">,</span> <span class="token function">getTimeoutMessage</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> <span class="token function">returnFromResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，当响应 response 对象为空时，Condition 会执行 await 方法来阻塞当前线程，直到该线程被唤醒、被中断或超过阻塞时间。而在前面所述的 DefaultFuture 类的 doReceived 方法中，我们也看到会先为 response 赋上返回值，之后执行 Condition 的 signal 方法唤醒被阻塞的线程，这样 get 方法就会释放锁，进而执行 returnFromResponse 方法来返回值。</p>\n<p>这样，整个远程调用的异步转同步过程就介绍完毕。作为总结，我们明确 Dubbo 异步转同步的原理其实就是利用 Lock 和 Condition 实现了等待通知机制。当客户端发送请求时，将一个请求 Id 和一个 DefaultFuture 对象包装在请求对象中。而当客户端异步收到响应时，则根据这个请求 Id 从响应结果中获取对应的 DefaultFuture 对象，并调用该 DefaultFuture 对象的 get 方法获取最终的调用结果。</p>\n<h2 id="解题要点-6"><a href="#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解题要点</h2>\n<p>在涉及到远程调用的应用场景，很多开源框架都会基于 Future 或它的一些变种，例如 JDK 自身提供的改进版 CompleteFuture，或是 Google 的 guava 框架中提供的 ListenableFuture 等。类似的问题主要还是关注 Future 机制本身的一些特性，可以发散出一系列的问题，但基本的考点是一致的，回答的思路也类似。</p>\n<p>Future 机制本身提供的几个接口也并不复杂，需要理解它们的含义和作用，但也要理解它们存在的不足。普通 Future 机制的最大问题在于没有提供通知的机制，也就是说我们不知道 Future 什么时候能够完成。前面提到的 CompleteFuture 和 ListenableFuture 实际上都是为了改进普通 Future 存在的这一问题而诞生的。本讲内容对 Future 的概念做了类比介绍，同时给出了 JDK 中 Future 接口的各个核心方法。通过掌握这些核心方法，针对这个问题我们就能拿到 60 分。如果我们还能够进一步分析基本 Future 机制的不足，然后引出 CompleteFuture 或 ListenableFuture 等改进版本的 Future，那么拿到 80 分就不成问题。</p>\n<p>另一方面，对于 Dubbo 框架中的服务引用过程，我们需要重点掌握的是它的三种调用方式，即单向、同步和异步。其中前面两种比较好理解，而针对异步，我们在使用 Dubbo 的过程中实际上最终也是转换为同步操作。针对这一问题，如果只是回答这个问题中所提出的实现方式的种类，那么只要简单列举即可。但要说明具体的实现细节，尤其是 Dubbo 中 <code class="language-text">异步转同步</code> 的实现细节，那么需要对本讲内容做深入的理解，并尝试使用自己的语言来总结整个过程。</p>\n<h2 id="小结与预告-4"><a href="#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结与预告</h2>\n<p>承接上一讲内容，本讲围绕远程过程调用的服务引用过程展开了讨论。同样的，基于这套服务引用流程，我们也对 Dubbo 中服务引用的底层设计思想和实现过程进行了分析，尤其对服务调用异步转同步过程做了详细的阐述。</p>\n<p>事实上，关于服务引用的完整介绍还没有结束。相较服务发布，服务引用还涉及到负载均衡、服务容错等技术组件，这些技术组件都是构建分布式服务所必不可少的。在接下来的几讲内容中，我们将一一对这些技术组件展开讨论。下一讲内容将先从负载均衡进行切入，在服务发布和引用的基础上回答这样一个问题：负载均衡如何与远程调用过程进行整合？我们下一讲详聊。</p>\n<h1 id="负载均衡：负载均衡如何与远程调用过程进行整合？"><a href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%EF%BC%9A%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%A6%82%E4%BD%95%E4%B8%8E%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B%E8%BF%9B%E8%A1%8C%E6%95%B4%E5%90%88%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>负载均衡：负载均衡如何与远程调用过程进行整合？</h1>\n<p>在上一讲中，我们详细阐述了在远程调用过程中服务引用的流程和实现方式。请注意，在现实环境中，我们一般都会采用集群模式对服务进行多实例化的部署，以防止出现单点故障。</p>\n<p>那么，问题就来了，服务消费者的每一次远程调用就需要确定对这些服务实例中的具体哪一个发起请求，这就是负载均衡要解决的问题。</p>\n<p>负载均衡（Load Balance）是一个复杂的话题，要想在远程调用过程中引入负载均衡，我们首先需要回答一个基本的问题，即：负载均衡是如何与远程调用过程进行整合的呢？本讲内容将围绕这一问题展开讨论。</p>\n<h2 id="问题背景-4"><a href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题背景</h2>\n<p>相信你对集群这个概念并不陌生。在分布式系统开发过程中，集群的作用主要有两点，一方面通过服务的冗余为系统可用性提供了一种技术手段，另一方面也针对系统的性能问题提供了解决方案。通过集群，我们能够将业务请求分摊到多台单机性能不一定非常出众的服务器上。这部分内容作为负载均衡的基本概念，是每位面试候选人都应该掌握的。</p>\n<p>但是，如果问到“如何在远程调用中集成负载均衡机制”这个问题，就我的面试经验，相信很多候选人就不一定能回答出来了。从问题本身而言，你可能会觉得负载均衡和远程调用是天生整合在一起的，因为在日常开发过程中，开源框架以及运行时环境都已经帮你准备好了这部分工作，普通开发人员不需要参与，这也导致了我们对这部分内容不够重视。但是，就技术实现而言，两者之间的集成过程又非常重要。可以说，正是因为能够在远程调用过程中集成负载均衡机制，才会有我们后续要介绍的集群容错、服务熔断等一系列技术组件的应用。</p>\n<p>进一步，我们来梳理针对这一话题的常见面试提问方式，包括：</p>\n<ul>\n<li>负载均衡的基本结构是怎么样的，它有什么作用？</li>\n<li>如果想要在远程调用过程中嵌入负载均衡机制，你有什么设计思路？</li>\n<li>你能简要描述 Dubbo 框架的负载均衡组成结构吗？</li>\n<li>在 Spring Cloud 中，为什么在 RestTemplate 类上添加了 @LoadBalanced 注解，就能自动集成负载均衡功能？</li>\n</ul>\n<p>对于这类问题，我们注意到问题的要点并不在于负载均衡本身的概念和原理，而更多的是关于具体的实现过程和机制，所以是一种偏实战类的考查方式。</p>\n<h2 id="问题分析-5"><a href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题分析</h2>\n<p>在分布式系统构建过程中，势必需要引入负载均衡机制，而业界关于如何实现负载均衡存在一系列工具。在这些工具中，有些提供的是偏向于底层负载均衡算法实现的工具库，而有些则提供了整套负载均衡实现方案。无论是哪种类型，我们都需要获取想要访问的目标服务当前实例信息，这是实现远程调用和负载均衡进行整合的前提，也是我们在回答这类问题时的第一个要点。</p>\n<p>回答这类问题的第二个要点在于，我们以什么样的技术手段完成在远程调用链路中自动嵌入负载均衡机制。从系统架构设计角度，这个嵌入过程应该对开发人员透明，且应该是可扩展的。在这点上，不同的实现框架有不同的策略，常见的包括两大类。</p>\n<ul>\n<li>基于拦截机制：通过类似 AOP 的实现机制对请求进行拦截，再应用动态代理机制完成对负载均衡机制的嵌入。</li>\n<li>基于集群机制：在集群构建过程中完成对负载均衡机制的嵌入。</li>\n</ul>\n<p>最后，正如问题背景部分所阐述的，“如何在远程调用中集成负载均衡机制”这类话题考查的并不是概念，而是一种实践能力。我们通常不会自己去完成这个集成过程，但对于主流开源框架中的做法需要非常熟悉，否则很难从实现机制和过程上对这类问题进行解答。</p>\n<h2 id="技术体系-7"><a href="#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术体系</h2>\n<p>前面提到有两大类技术手段可以完成对远程调用和负载均衡的集成，事实上这也是 Spring Cloud 和 Dubbo 这两个主流分布式服务框架所采用的实现方式。本讲内容将讨论第一种，即拦截机制。关于集群机制的分析我们放在之后再展开。</p>\n<p>如果我们采用拦截机制，那么整体的设计思想可以用下图进行展示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-04-10-59-23-0064dc22aa6ba04b729c7ed093939108-9a912.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 481px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 63.20166320166321%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACIElEQVQ4y5VTiVLaUBTN//9GdVyoFcVBKQNUVkVBQMKSDYSEJISRLEDYktObTFu0lc54Z+7kJXnn3HveuY9ps5e4Kx2hfH+Cx/IpGvVvEAQWQXi+B9/3P5XMWMug9hQhojO02HNMjAw4rhES+kT42WAURYYoCUTSgaarGA4HWK/XvwjfV3/7jVZ//fPDBhhzOkWvJ6JarcCyTBjGGJvNZgeGv4f43ww7tMwCBO4K1coxVCWFkZJEt7uT/BHZYCCg2ylD4KuUlTC7nQdIPQ6MMc6DbcaQyx6gJyZpc4pMae09Q8uakZoYDD2OWvUAIn+GRu0Qjp3Bzc0Xkmw6GI00IpJh23O8vlrvCDzPC890sVhguVzSXhWVxzx1VCIzf+C5kSVDs6SqBJ5nA1N6aLdrKBQyUNUX9PscTNOE67qYz+fhc7VaYbvdhuRBTCYGNSBB02QqMCDckHAipuQHs3SL4LtRtJpfoatJ2NYtms2HELhaLQk4gCiKNAVcCCBeNJ8T0NRr6u4YkniBNhuBZWaQTB6BEYVb3N9dopA/p43fCZim0ZH+yHUcJ0zbtsMCgS88mdBpp+gyXJHsBB1BnIhzqDdKYFx3TWPiUWUfq/UWwfvvkdkXluVAUZRQuq7rNGoGZFnGbDYH8xFg37UKYrPxSWoKfSlG3Z2C60RRfzqBIieQTkfA/A/8tssdoUeOFjF4SRHhBUm/pvGJQtdyKBbj+An+wszvchaIjgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 04 10 59 23" title="" data-src="/static/2024-11-04-10-59-23-0064dc22aa6ba04b729c7ed093939108-9a912.png" data-srcset="/static/2024-11-04-10-59-23-0064dc22aa6ba04b729c7ed093939108-06486.png 200w,\n/static/2024-11-04-10-59-23-0064dc22aa6ba04b729c7ed093939108-fe61f.png 400w,\n/static/2024-11-04-10-59-23-0064dc22aa6ba04b729c7ed093939108-9a912.png 481w" data-sizes="(max-width: 481px) 100vw, 481px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>上图所展示的基本思想在于：当我们采用拦截机制对远程方法进行拦截时，并不是直接执行该方法中的业务逻辑，而是嵌入自定义的一套负载均衡机制。这套负载均衡机制能够获取当前所有可用的服务实例信息，并基于一定策略确定目标服务实例。这个过程对开发人员是透明的。</p>\n<p>现实中，采用这种实现机制的代表性框架就是 Spring Cloud。如果你使用过 Spring Cloud，那你应该知道想要在服务调用过程中嵌入负载均衡机制，要做的事情只有一件，就是在 RestTemplate 模板工具类上添加一个 @LoadBalanced 注解，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99981727497279650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@LoadBalanced\n@Bean\npublic RestTemplate getRestTemplate(){\n     return new RestTemplate();\n}`, `99981727497279650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@LoadBalanced</span>\n<span class="token annotation punctuation">@Bean</span>\n<span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">getRestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n     <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们知道 RestTemplate 是 Spring 自带的一个 HTTP 请求工具类，本身并不具备负载均衡能力。讲到这里，你可能会觉得奇怪，为什么在这个工具类上添加了 @LoadBalanced 注解就能自动嵌入负载均衡机制呢？这个 @LoadBalanced 注解背后的工作原理又是怎么样的呢？为了回答这些问题，我们需要深入分析 Spring Cloud 的相关源码。</p>\n<h2 id="源码解析-5"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h2>\n<p>让我们打开 Spring Cloud 源码，来到 spring-cloud-commons 这个代码工程，可以发现虽然这个工程的名称是 common，但内置了大量以 client 命名的代码包。这些代码包中就包含了与服务发现、负载均衡相关的所有基础类定义。我们要介绍的 @LoadBalanced 注解也位于这些代码包中。</p>\n<p>接下来，让我们先从这个注解开始讲起。</p>\n<h3 id="spring-cloud-中的-loadbalanced"><a href="#spring-cloud-%E4%B8%AD%E7%9A%84-loadbalanced" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Spring Cloud 中的 @LoadBalanced</h3>\n<p>事实上，在 Spring Cloud 中维护着一个 RestTemplate 模板工具类的列表，而在该列表上就嵌入了 @LoadBalanced 注解，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67433209209316460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@LoadBalanced\n@Autowired(required = false)\nprivate List<RestTemplate> restTemplates = Collections.emptyList();`, `67433209209316460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@LoadBalanced</span>\n<span class="token annotation punctuation">@Autowired</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>\n<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RestTemplate</span><span class="token punctuation">></span></span> restTemplates <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>上述代码位于自动配置类 LoadBalancerAutoConfiguration 中。针对这些被 @LoadBalanced 注解修饰的 RestTemplate，在 LoadBalancerAutoConfiguration 初始化的过程中会调用 RestTemplateCustomizer 的 customize 方法进行定制化，这个定制化的过程就是对目标 RestTemplate 增加拦截器 LoadBalancerInterceptor，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21294720925553110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Bean\n@ConditionalOnMissingBean\npublic RestTemplateCustomizer restTemplateCustomizer(final LoadBalancerInterceptor loadBalancerInterceptor) {\n       return restTemplate -> {\n                List<ClientHttpRequestInterceptor> list = new ArrayList<>(restTemplate.getInterceptors());\n                list.add(loadBalancerInterceptor);\n                // 为 RestTemplate 添加拦截器\n                restTemplate.setInterceptors(list);\n       };\n}`, `21294720925553110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Bean</span>\n<span class="token annotation punctuation">@ConditionalOnMissingBean</span>\n<span class="token keyword">public</span> <span class="token class-name">RestTemplateCustomizer</span> <span class="token function">restTemplateCustomizer</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">LoadBalancerInterceptor</span> loadBalancerInterceptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n       <span class="token keyword">return</span> restTemplate <span class="token operator">-></span> <span class="token punctuation">{</span>\n                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientHttpRequestInterceptor</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>restTemplate<span class="token punctuation">.</span><span class="token function">getInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>loadBalancerInterceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token comment">// 为 RestTemplate 添加拦截器</span>\n                restTemplate<span class="token punctuation">.</span><span class="token function">setInterceptors</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>\n       <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里就用到了 RestTemplate 的拦截器扩展机制。通过这种机制，我们可以在 RestTemplate 发送请求的过程中添加定制化的功能。从命名上看，这里的 LoadBalancerInterceptor 就是添加了负载均衡的拦截器，我们在它的构造函数中发现传入了一个 LoadBalancerClient，而在它的拦截方法中本质上就是使用这个 LoadBalanceClient 来执行真正的负载均衡，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59084642258361590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class LoadBalancerInterceptor implements ClientHttpRequestInterceptor {\n   // ...\n   public LoadBalancerInterceptor(LoadBalancerClient loadBalancer) {\n      this(loadBalancer, new LoadBalancerRequestFactory(loadBalancer));\n   }\n\n   @Override\n   public ClientHttpResponse intercept(final HttpRequest request, final byte[] body, final ClientHttpRequestExecution execution) throws IOException {\n      final URI originalUri = request.getURI();\n      String serviceName = originalUri.getHost();\n\n      // 通过 LoadBalancerClient 执行负载均衡\n      return this.loadBalancer.execute(serviceName, requestFactory.createRequest(request, body, execution));\n   }\n}`, `59084642258361590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoadBalancerInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">ClientHttpRequestInterceptor</span> <span class="token punctuation">{</span>\n   <span class="token comment">// ...</span>\n   <span class="token keyword">public</span> <span class="token class-name">LoadBalancerInterceptor</span><span class="token punctuation">(</span><span class="token class-name">LoadBalancerClient</span> loadBalancer<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">(</span>loadBalancer<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LoadBalancerRequestFactory</span><span class="token punctuation">(</span>loadBalancer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token annotation punctuation">@Override</span>\n   <span class="token keyword">public</span> <span class="token class-name">ClientHttpResponse</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">HttpRequest</span> request<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ClientHttpRequestExecution</span> execution<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>\n      <span class="token keyword">final</span> <span class="token class-name">URI</span> originalUri <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token class-name">String</span> serviceName <span class="token operator">=</span> originalUri<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 通过 LoadBalancerClient 执行负载均衡</span>\n      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>loadBalancer<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> requestFactory<span class="token punctuation">.</span><span class="token function">createRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> body<span class="token punctuation">,</span> execution<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里的拦截方法 intercept 直接调用了 LoadBalancerClient 接口的 execute 方法完成对请求的负载均衡执行。而该方法的输入参数有两个，一个是代表服务名称的 serviceName，另一个则是代表负载均衡请求对象的 LoadBalancerRequest。而具体的 LoadBalancerRequest 则是如下所示的一个 ServiceRequestWrapper 包装类，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62276622738310030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class ServiceRequestWrapper extends HttpRequestWrapper {\n   private final ServiceInstance instance;\n\n   private final LoadBalancerClient loadBalancer;\n\n   public ServiceRequestWrapper(HttpRequest request, ServiceInstance instance, LoadBalancerClient loadBalancer) {\n      super(request);\n      this.instance = instance;\n      this.loadBalancer = loadBalancer;\n   }\n\n   @Override\n   public URI getURI() {\n      URI uri = this.loadBalancer.reconstructURI(this.instance, getRequest().getURI());\n      return uri;\n   }\n}`, `62276622738310030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceRequestWrapper</span> <span class="token keyword">extends</span> <span class="token class-name">HttpRequestWrapper</span> <span class="token punctuation">{</span>\n   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ServiceInstance</span> instance<span class="token punctuation">;</span>\n\n   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">LoadBalancerClient</span> loadBalancer<span class="token punctuation">;</span>\n\n   <span class="token keyword">public</span> <span class="token class-name">ServiceRequestWrapper</span><span class="token punctuation">(</span><span class="token class-name">HttpRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServiceInstance</span> instance<span class="token punctuation">,</span> <span class="token class-name">LoadBalancerClient</span> loadBalancer<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">super</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>instance <span class="token operator">=</span> instance<span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>loadBalancer <span class="token operator">=</span> loadBalancer<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token annotation punctuation">@Override</span>\n   <span class="token keyword">public</span> <span class="token class-name">URI</span> <span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token class-name">URI</span> uri <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>loadBalancer<span class="token punctuation">.</span><span class="token function">reconstructURI</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>instance<span class="token punctuation">,</span> <span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> uri<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，这里同样出现了 LoadBalanceClient，并用它来完成了请求地址 URI 的构建。显然，LoadBalanceClient 是我们分析负载均衡机制的核心入口。接下来，我们就对该接口及其实现类进行详细的展开。</p>\n<h3 id="loadbalanceclient-接口与实现类"><a href="#loadbalanceclient-%E6%8E%A5%E5%8F%A3%E4%B8%8E%E5%AE%9E%E7%8E%B0%E7%B1%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>LoadBalanceClient 接口与实现类</h3>\n<p>LoadBalancerClient 是一个非常重要的接口，定义如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24325392138722290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface LoadBalancerClient extends ServiceInstanceChooser {\n   // 执行负载均衡调用\n   <T> T execute(String serviceId, LoadBalancerRequest<T> request) throws IOException;\n\n   // 执行负载均衡调用\n   <T> T execute(String serviceId, ServiceInstance serviceInstance, LoadBalancerRequest<T> request) throws IOException;\n\n   // 构建负载均衡调用 URI\n   URI reconstructURI(ServiceInstance instance, URI original);\n}`, `24325392138722290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">LoadBalancerClient</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceInstanceChooser</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 执行负载均衡调用</span>\n   <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceId<span class="token punctuation">,</span> <span class="token class-name">LoadBalancerRequest</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>\n\n   <span class="token comment">// 执行负载均衡调用</span>\n   <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceId<span class="token punctuation">,</span> <span class="token class-name">ServiceInstance</span> serviceInstance<span class="token punctuation">,</span> <span class="token class-name">LoadBalancerRequest</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>\n\n   <span class="token comment">// 构建负载均衡调用 URI</span>\n   <span class="token class-name">URI</span> <span class="token function">reconstructURI</span><span class="token punctuation">(</span><span class="token class-name">ServiceInstance</span> instance<span class="token punctuation">,</span> <span class="token class-name">URI</span> original<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意到这里有两个 execute 重载方法，用于根据负载均衡器所确定的服务实例来执行服务调用。而 reconstructURI 方法 则用于构建服务 URI，基于负载均衡所选择的 ServiceInstance 信息，并利用服务实例的 host、port 以及端点路径，我们就可以构造出一个真正可供访问的服务地址。</p>\n<p>同时，我们发现 LoadBalancerClient 有一个父接口 ServiceInstanceChooser，该接口定义如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17315059583296844000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface ServiceInstanceChooser {\n   // 根据 serviceId 选择目标服务实例\n   ServiceInstance choose(String serviceId);\n\n   // 根据 serviceId 和请求选择目标服务实例\n   <T> ServiceInstance choose(String serviceId, Request<T> request);\n}`, `17315059583296844000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ServiceInstanceChooser</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 根据 serviceId 选择目标服务实例</span>\n   <span class="token class-name">ServiceInstance</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token comment">// 根据 serviceId 和请求选择目标服务实例</span>\n   <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">ServiceInstance</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceId<span class="token punctuation">,</span> <span class="token class-name">Request</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>显然，从负载均衡角度讲，我们应该重点关注实际上是这两个 choose 方法的实现，因为它们完成了对目标服务实例的具体选择过程，而这个选择过程集成了各种负载均衡算法。</p>\n<p>在 Spring Cloud 中，LoadBalancerClient 接口有一组实现类。我们接下来要介绍的是 Spring Cloud Netflix 中的 RibbonLoadBalancerClient 类，该类基于 Netflix Ribbon 组件实现了负载均衡机制，是 Spring Cloud 中最早、也是最经典的一种负载均衡实现方式。</p>\n<p>这里有必要梳理一下 Netflix Ribbon 和 Spring Cloud 之间的关系。我们知道 Netflix Ribbon 是来自 Netflix 的一个外部组件，它提供的只是一个辅助工具，这个辅助工具的目的就是让你去集成它，而不是说它自己完成所有的工作。而 Spring Cloud 中的 Spring Cloud Netflix Ribbon 专门针对 Netflix Ribbon 提供了一个独立的集成实现。对于 Netflix Ribbon 而言，Spring Cloud Netflix Ribbon 相当于它的客户端，而对于 Spring Cloud Netflix Ribbon 而言，我们的应用服务相当于它的客户端。</p>\n<p>Netflix Ribbon、Spring Cloud Netflix Ribbon、应用服务这三者之间的关系以及核心入口如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-04-11-02-11-084e5c12e53da667b08c95bfcf82efe5-3e45f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 371px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 128.03234501347708%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAaCAYAAAC3g3x9AAAACXBIWXMAAAsSAAALEgHS3X78AAAEvElEQVRIx41VaXMaRxDdX5+qVCWVlCPFTtmRLSOEEPeNQEIIlmuXY2E5BLovdCJhLNuxHfvlTSMptj9pq171HD2z093vzWi6Hodp+GAY/jvrE2uyX6l4oetLyOddyOUWkc8toVL2fuenrFHxoVr1c34Zmml4AWwRPWLzG/SJBg72YtjdiWKwGcJWP4gv/1Y5PvjBvyd7jK6yakM/Oy1cnGdxdbnxgOtRXuzlRfbB3rdHVzmMLnMPvmrtx39MnJ1loFmNMA73Ezz+InrdADptP9q2D/WqC3bLK6iZLjStZbSaHrSUtTwy3u34BWrOKDv5w3VobTuOrUEYkzdFnrQreDspYSXxDNtbMW7mRiHvQKm4wJ8so9cJ07rx/p1x59+WCK2GR06u6Uz40WEUqZUZZNaeYT3zDOnULIKBX2hnkEpOx9OpP8VnNT175/tUsM451a+aDh4sCG0waKPbLTPcCkMtod0uMeyS9O+t1cihVsui1zOm852y2G/R75uw7Qo0POIbjSbY3T16jCs0266SW+SimeIp0mjUV2FZawwhJbBbWYbmRSj0kuMZ1Kpp+idQp6/VWEOd/qaxQiTpz6LoupP71nF6ssLkz3FDVrSxhM2ujwVRhXBiZysMs7zAfD6FxXnFgPzGHCv7mkXy4sP7Er58NlnEMLSq6RWifv1iCbdu35aFW5M3JbwZF6VyH94bbBdwc60LAz59rAlPx+xPq90WIZwcr0Jr1P24GeVQLMwzBDdPuMTieAWdtuKaj2F7BGrMVlxsTvvKt15zydrdnRhOh9yw1QqJ4/gmz7/Y+Pyphj1OdjsB5mSJG3Dzlh872zFKL0wJRtBtB7C/m6B/k7AYXZ2+izg+SkFrWkFRSp9aPR1mcLC/IhsVC1MyF/LzKOoOIXjVcDEKL8oct5s+bpDGkGGqNUpdw5M0Q24EmJsc3K6fEQr+hkjod8RjfyARmxGsJGYFyfi0H4s+ERuNPEGYvgHfr1hc+EkiOT+llu1WmBUNMLkVVjPOkKjtgySOD9Pi0Ge/xdMou7+XkBMdHqR4qiTTEJciqYJY9WWc8MSaaXoovRgF74ZRckDPzaHEJFfYrhRfI5d9gQ2F9Rco6C9lzqwskDIOzv3NfPqwPQgxFS7+KKFOaKJMYoeCCwzBiUhkEZGwU9oKsaiLcw4E/PPSfpijjdI3GHDA63mF3EZI5Pko6Y3HtxgOLx4nve3tHsVuEOZ36PfrGAwa1LDNJyDJQi2Tay0Z6yqftvENTNmjv9mEll2fZ0F0kjtLLm5QEepGzqBRczJvz0WOTeanqL+ijhflmro4X8VknBN/hZvrLN7d6kIdKsV396Y079ASq677PZJXcU21j49WSeYk35ikkP/eT/C1KfIdnqwpHvpxOyny5XJSSm5KSWFJngJF9gHVoZ4GZe+hrn/lo3zVGrX26DA51XLbnkrv/ydA/bnDsNZxRh4qrnXsAG/jqHBPnfial8L0QrDv0OT15RR+kjYBLkzLJXB8qEKKi1X5ymae83p/irX0X2JVP8u81pRule9+XLi3sx2R9ednDLmghxhagjxSD7mLxOZdx0e9VHCjXPKQwF5eqLSVqVUoFd3ic++/kXVSTRGmIIL/ANjD9XUK4zzrAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 04 11 02 11" title="" data-src="/static/2024-11-04-11-02-11-084e5c12e53da667b08c95bfcf82efe5-3e45f.png" data-srcset="/static/2024-11-04-11-02-11-084e5c12e53da667b08c95bfcf82efe5-84b18.png 200w,\n/static/2024-11-04-11-02-11-084e5c12e53da667b08c95bfcf82efe5-3e45f.png 371w" data-sizes="(max-width: 371px) 100vw, 371px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在 RibbonLoadBalancerClient 中，我们可以看到它的 choose 方法进一步调用了一个 getServer 方法来获取服务器信息，而这个 getServer 方法则是通过 ILoadBalancer 接口完成了对目标服务的选择，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79116188044571790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public ServiceInstance choose(String serviceId, Object hint) {\n   Server server = getServer(getLoadBalancer(serviceId), hint);\n   // ...\n}\n\nprotected Server getServer(ILoadBalancer loadBalancer, Object hint) {\n   // ...\n   return loadBalancer.chooseServer(hint != null ? hint : &quot;default&quot;);\n}`, `79116188044571790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">ServiceInstance</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceId<span class="token punctuation">,</span> <span class="token class-name">Object</span> hint<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token class-name">Server</span> server <span class="token operator">=</span> <span class="token function">getServer</span><span class="token punctuation">(</span><span class="token function">getLoadBalancer</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">)</span><span class="token punctuation">,</span> hint<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// ...</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">protected</span> <span class="token class-name">Server</span> <span class="token function">getServer</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> loadBalancer<span class="token punctuation">,</span> <span class="token class-name">Object</span> hint<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// ...</span>\n   <span class="token keyword">return</span> loadBalancer<span class="token punctuation">.</span><span class="token function">chooseServer</span><span class="token punctuation">(</span>hint <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> hint <span class="token operator">:</span> <span class="token string">"default"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个 ILoadBalancer 就来自于 Netflix Ribbon，该接口位于 com.netflix.loadbalancer 包下，定义如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12927156843683308000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface ILoadBalancer {\n   // 添加后端服务\n   public void addServers(List<Server> newServers);\n\n   // 选择一个后端服务\n   public Server chooseServer(Object key);\n\n   // 标记一个服务不可用\n   public void markServerDown(Server server);\n\n   // 获取当前可用的服务列表\n   public List<Server> getReachableServers();\n\n   // 获取所有后端服务列表\n   public List<Server> getAllServers();\n}`, `12927156843683308000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ILoadBalancer</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 添加后端服务</span>\n   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addServers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">></span></span> newServers<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token comment">// 选择一个后端服务</span>\n   <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">chooseServer</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token comment">// 标记一个服务不可用</span>\n   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">markServerDown</span><span class="token punctuation">(</span><span class="token class-name">Server</span> server<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token comment">// 获取当前可用的服务列表</span>\n   <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">></span></span> <span class="token function">getReachableServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token comment">// 获取所有后端服务列表</span>\n   <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">></span></span> <span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>针对负载均衡，我们应该重点应该关注的是 ILoadBalancer 接口中 chooseServer 方法的实现，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78437975839383760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public Server chooseServer(Object key) {\n        if (counter == null) {\n            counter = createCounter();\n        }\n        counter.increment();\n        if (rule == null) {\n            return null;\n        } else {\n            try {\n                return rule.choose(key);\n            } catch (Exception e) {\n                 return null;\n            }\n        }\n}`, `78437975839383760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">chooseServer</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>counter <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            counter <span class="token operator">=</span> <span class="token function">createCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        counter<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>rule <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            <span class="token keyword">try</span> <span class="token punctuation">{</span>\n                <span class="token keyword">return</span> rule<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                 <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到这里使用了一个 IRule 接口集成了具体负载均衡策略的实现。IRule 接口是对负载均衡策略的一种抽象，可以通过实现这个接口来提供各种负载均衡算法，该接口的类层结构如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-04-11-03-24-1a90a6a70112a57bf58d5ad6b75ea5ae-200d5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 474px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 51.89873417721519%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABx0lEQVQoz2WS6XKCMBSFef+nqtr6q506li1sFSyVHZRFReH03mDttM3MJZlkOPnuOVHWawuz+QNWqxWeX17wtHzCfDHHcrnEbPaAxeMCrueCxziOt3m4r/8OpahKGBsTuqFD01QIy8Lr6hWarlFNe2mWIUlTRHFE6xRFWSDPc1nn8xnX6xWXS091gTIOI+pjg10ewbYFPM+DRuJCGDCEwHYbwA82dGbDsi2EYYjD4YC8yFEUhVzv93uqCnVdQ5GcJPpZxbBdCzpRqZqGN3VNhKr8qW1bmnOiTJARVRTHSJIYXdf9b5k/jFx3DYJ4C9d1SFCVFjCl9+7B9zdIqWUm+RHOqOVMUh2PR+kplzKZOxmc1CmCwIcpzEmMwjAMg1r2722xMIuyIFOWlEHf9/eQJGHbdwh2ARzHlkLsVUnGcwifu90kQMHE1CpbwEFwACw0DMOvF6AwXNGWcAMXJtGo2ptsiUWqqiLhUorxHifcNM1d5O+QLfPhvj0gTEM4rg3TpHRNXc5MGEURJfuBDyqmZnF+Rk3bSMLT6SSJvy9Rxpt/OVO+O+SfoCdi0XsUJEzElLRBAbGvNdGxj+xfRrRMzD7yJWcS5/EFT1Ht1q4VkFAAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 04 11 03 24" title="" data-src="/static/2024-11-04-11-03-24-1a90a6a70112a57bf58d5ad6b75ea5ae-200d5.png" data-srcset="/static/2024-11-04-11-03-24-1a90a6a70112a57bf58d5ad6b75ea5ae-4fa1a.png 200w,\n/static/2024-11-04-11-03-24-1a90a6a70112a57bf58d5ad6b75ea5ae-57557.png 400w,\n/static/2024-11-04-11-03-24-1a90a6a70112a57bf58d5ad6b75ea5ae-200d5.png 474w" data-sizes="(max-width: 474px) 100vw, 474px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可以看到 Netflix Ribbon 中的负载均衡实现算法非常丰富，既提供了 RandomRule、RoundRobinRule 等无状态的静态算法，又实现了 AvailabilityFilteringRule、WeightedResponseTimeRule 等多种基于服务器运行状况进行实时路由的动态算法。关于这些负载均衡算法的讨论我们放在下一讲中。</p>\n<p>在上图中还看到了 RetryRule 这种重试策略，该策略会对选定的负载均衡策略执行重试机制。严格意义上讲，重试是一种服务容错而不是负载均衡机制，但 Ribbon 也内置了这方面的功能。</p>\n<p>事实上，我们也可以基于 IRule 接口实现任何定制化的负载均衡算法，然后通过配置的方式加载到 Spring Cloud 中，示例代码如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85511222148988270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Configuration\npublic class LoadBalanceConfig{\n\n    @Autowired\n    IClientConfig config;\n\n    @Bean\n    @ConditionalOnMissingBean\n    public IRule customRule(IClientConfig config) {\n\n        return new RandomRule();\n    }\n}`, `85511222148988270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoadBalanceConfig</span><span class="token punctuation">{</span>\n\n    <span class="token annotation punctuation">@Autowired</span>\n    <span class="token class-name">IClientConfig</span> config<span class="token punctuation">;</span>\n\n    <span class="token annotation punctuation">@Bean</span>\n    <span class="token annotation punctuation">@ConditionalOnMissingBean</span>\n    <span class="token keyword">public</span> <span class="token class-name">IRule</span> <span class="token function">customRule</span><span class="token punctuation">(</span><span class="token class-name">IClientConfig</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\n        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RandomRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>显然该配置类的作用是使用 RandomRule 替换 Ribbon 中的默认负载均衡策略 RoundRobin。</p>\n<h2 id="解题要点-7"><a href="#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解题要点</h2>\n<p>关于负载均衡和远程调用的整合过程是一道经典的面试题，理论知识和工程实践都有涉及，我经常拿这道题来考察候选人。就考查内容而言，这道题所涵盖的知识面要求很广，需要面试者对负载均衡、远程调用以及主流的分布式服务框架本身的功能特性都有一定的了解。</p>\n<p>而从提问方式上讲，这个面试主题往往会直接从具体的工具框架的特性进行切入，考查面试者对框架原理的理解，正如本讲中重点介绍的 Spring Cloud 和 @LoadBalanced 注解。乍一看，这类面试题感觉无从下手，因为 @LoadBalanced 注解在使用过程中并没有提供太多的配置项供开发人员进行设置，我们也就很难联想到其背后所具备的负载均衡机制。</p>\n<p>但事实上，在这个注解背后隐藏着一个很重要的技术组件，即拦截器。通过在某一个注解中添加拦截功能，然后把一些非功能性需求通过拦截器进行实现，这是 Spring 等优秀开源框架中所经常使用的一种开发技巧，也是面试官考查面试者对开源框架理解能力的一个常见维度。在回答这道面试题时，我们就需要从拦截器的角度出发，把 RestTemplate 和 Ribbon 组件结合起来进行分析。至于负载均衡算法本身，反而不是这道面试题考查的重点，我们只要点到即可。</p>\n<h2 id="小结与预告-5"><a href="#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结与预告</h2>\n<p>通过今天内容的介绍，我们明确作为一款负载均衡工具，要做的事情无非是从服务列表中选择一个服务进行调用。为了实现这个过程，我们需要提供入口供客户端请求进行使用。而 Spring Cloud 为我们提供了一种非常友好的实现方式，开发人员只需要通过一个简单的 @LoadBalanced 注解就能自动在调用过程中集成负载均衡机制。今天的内容对 @LoadBalanced 注解以及背后的整个负载均衡实现流程做了原理分析。通过这种方式，我们也加深了对“如何在远程调用中集成负载均衡机制”这个问题的理解程度。</p>\n<p>在前面的内容中，我们已经看到 Spring Cloud 内置了一组丰富的负载均衡算法，而这些负载均衡算法能够根据需要帮助我们自动找到最佳的目标服务。事实上，任何一款分布式服务框架都提供了各种不同类型的负载均衡算法供开发人员进行选择。那么，如何实现这些常见的负载均衡算法？这就是下一讲要讨论的内容。</p>\n<h1 id="负载均衡：如何实现常见的负载均衡算法？"><a href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%B8%B8%E8%A7%81%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>负载均衡：如何实现常见的负载均衡算法？</h1>\n<p>上一讲我们分析了在远程调用过程中整合负载均衡机制的实现过程。在这种场景下，我们将多个服务实例集中在一起，每一次请求都可以由集群中的某一个服务实例进行响应。</p>\n<p>那么，具体某一个请求到底应该是由哪个服务实例来响应最为合适呢？这个话题看上去很简单，实际上却有点复杂，涉及到服务请求的路由机制。</p>\n<p>而在分布式系统中，上一讲中引入的负载均衡就是最常见也是最具代表性的一种路由机制。为了对请求进行合理的分发，我们需要提供一组负载均衡算法，那么常见的负载均衡算法有哪些？它们又应该如何实现呢？这是一道非常典型的面试题，本讲内容将围绕这一主题展开讨论。</p>\n<h2 id="问题背景-5"><a href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题背景</h2>\n<p>我们先来看这个问题背后的示意图，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-05-10-38-28-f71a59bfc24e16a2d9f20422e520fc12-92ba0.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 636px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 41.35220125786164%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABgklEQVQoz3VRa0/CQBDs//8rahCEQkHiF1QwEGh5trSFFoSW2vKwUBPpjXtXo8aESyY3+7ydPUntyVi6dcxnNThzjnuBmV0Vd1+9hdbLodu5wWhQwMKp/8Sy/Awu2eZUgTQc5HH+bON0bCJJWjidmjjGzwBUJKcWFq5CyRXYVgkb/wEfyQvFelk+xbnN6zjf7xqQOu0rekHG1ChAH+eIl2GbRZpYpmYVukvUrChybPNO+KZ6nlQpsMjm3JjkBV+91iDpExqf5Bq6LGCZFeiTIvpaHnOSYlsKuIrJuEgNFSG1076mh6rCN9XLom5mVRFsHiGFYQjP8+D7PoIggOs4UFWVms2xWq0QRSEMQ0ev2yUeYb1ei5iqanAoNwg2otb3PYp5kHDhRNEWh0OMlAHnM8N2uxd+7tvt9pfKIDHGkKYpGMvAOT9xfMRgwPdUI2kKRkParU2/rpXxfjiInDQ9g9f/BU3Ivnv/Ovnh8qPwiVgXy4UiPon/bvjWoF35WcW/Zhxf44NHx650B/QAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 05 10 38 28" title="" data-src="/static/2024-11-05-10-38-28-f71a59bfc24e16a2d9f20422e520fc12-92ba0.png" data-srcset="/static/2024-11-05-10-38-28-f71a59bfc24e16a2d9f20422e520fc12-cf954.png 200w,\n/static/2024-11-05-10-38-28-f71a59bfc24e16a2d9f20422e520fc12-955d7.png 400w,\n/static/2024-11-05-10-38-28-f71a59bfc24e16a2d9f20422e520fc12-92ba0.png 636w" data-sizes="(max-width: 636px) 100vw, 636px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>显然，我们需要明确从服务 B 发出的请求最终会由服务 A 所提供的具体哪一个实例来进行处理，这是负载均衡算法的作用。上图所示的基本架构虽然简单，但围绕该图，我们可以延伸出一系列的扩展性话题，包括：</p>\n<ul>\n<li>负载均衡算法应该位于上图中的哪个位置？是在服务 B 中，还是应该有专门存储这些算法的其他组件？</li>\n<li>服务 A 的某个实例如果出现了问题，服务 B 还能对它进行访问吗？</li>\n<li>服务 A 各个实例的当前负载肯定不一样，服务 B 基于什么原则选择最合适的目标实例呢？</li>\n<li>如何防止对服务 A 实例的访问过程是不均衡的，从而导致服务 A 的某个实例压力太大？</li>\n</ul>\n<p>这些扩展性话题才是面试官想要真正考查的知识点，而对于这些知识点的掌握程度也体现了你和其他候选人之间的水平差异。</p>\n<p>我们可以沿着面试官的考查思路，梳理一组与负载均衡算法相关的一组常见面试题，包括：</p>\n<ul>\n<li>从你自己所理解的角度出发，你认为负载均衡算法可以分成哪些类型？</li>\n<li>如果想要在常见的静态负载均衡算法中嵌入动态特性，你有什么思路？</li>\n<li>你能列举常见的负载均衡算法以及它们的特性吗？</li>\n<li>Dubbo 包含了哪些负载均衡算法？</li>\n<li>Spring Cloud 内置了哪些负载均衡算法？</li>\n<li>Dubbo 框架在实现负载均衡机制时提供了哪些优化特性？</li>\n<li>一致性哈希算法的实现过程是怎么样的？</li>\n</ul>\n<p>可以看到，针对负载均衡算法的提问形式灵活多样。面试官既可以考查一些基本概念，也可以抛出一些发散性问题。同时，针对具体框架中负载均衡算法的实现方式也会经常出现在面试题中。</p>\n<h2 id="问题分析-6"><a href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题分析</h2>\n<p>对于上述问题而言，我认为回答的思路还是比较明确的，主要就是对主流负载均衡算法需要有全面的了解。这部分属于理论知识，考查方式比较固定，很难有创新和变化，应对策略上主要以记忆为主。相比到目前为止我们已经介绍的各讲内容，可以说，针对负载均衡算法的回答方式是最直接的。</p>\n<p>然后，无论你现在使用的是哪种分布式服务框架，都需要把它与常见的负载均衡算法结合起来进行掌握。在面试过程中，你可以基于自己擅长的框架来分析具体的算法实现过程。同时，很多时候我们也需要结合上一讲中讨论的话题，把负载均衡算法与远程调用过程结合起来一起讨论。</p>\n<h2 id="技术体系-8"><a href="#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术体系</h2>\n<p>在进行具体的工具介绍和源码分析之前，我们首先对负载均衡的类型以及相应的基本策略做简要介绍。</p>\n<h3 id="负载均衡的类型"><a href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E7%B1%BB%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>负载均衡的类型</h3>\n<p>负载均衡主要包括服务器端负载均衡和客户器端负载均衡两大类。我们先来看服务器端负载均衡，它的结构如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-05-10-40-18-5568a7c7247ebdbfb575acbe4b039c26-faa92.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 625px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 41.919999999999995%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABcElEQVQoz3VSW1OCYBDl//+PmslqmvFWONWLjWOOqXlBUUARJIlrIIxjwmk/0Icyd+Zw+Zbds+csXJqm+AsW/50nSZLlbNvEbFrFZFxE561AuIY0K0Oc1MClaXIoSE6angvXtdHrVjAcPGDQ59F/56GqL1iqLXD5NKdFjCAIPIShj80mRxAwBIiiCLYTIo73YEPv98B2m2L3DXCi2IC2bNLIdSzmDchyA57n0rOCbucGipRLm01LaL3ewjQtfBgrmqiJ5aFOkurQtCadtcGNhlWstEcIoyIlq1DkGnRdo/cBSbiHYz/B0Hl8mjXK8yTXhyAMIRORNC2Tf1dEXKCheBriGVwQhBmr47iwLJvuXiY5jiNMxTbURY8+7BJ7D+NxmxbiYLfbwfdCUhLA90PChoi+yJ449/DUv+OmkXl09OmY830PY6ELYyWTpyY1N6g5w5pt+fxvQ9dfYItiYVlrsqZEvt6R5AuSfAldq2Cu1PADPflV8qoNaxgAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 05 10 40 18" title="" data-src="/static/2024-11-05-10-40-18-5568a7c7247ebdbfb575acbe4b039c26-faa92.png" data-srcset="/static/2024-11-05-10-40-18-5568a7c7247ebdbfb575acbe4b039c26-630d2.png 200w,\n/static/2024-11-05-10-40-18-5568a7c7247ebdbfb575acbe4b039c26-34069.png 400w,\n/static/2024-11-05-10-40-18-5568a7c7247ebdbfb575acbe4b039c26-faa92.png 625w" data-sizes="(max-width: 625px) 100vw, 625px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可以看到，所谓的服务器端负载均衡指的就是在客户端和各个服务实例之间存在一个独立的负载均衡器，所有的请求都将通过这个负载均衡器进行转发并嵌入负载均衡算法。业界关于这种负载均衡器的实现工具也很多，最常见的就是 Nginx。</p>\n<p>我们换一种思路，把上图中负载均衡器所具备的功能放到客户端中，那么就诞生了另一种负载均衡机制，即客户端负载均衡。这时候，负载均衡算法的执行流程发生在客户端本地，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-05-10-40-53-945f2a6244dd0e6b28cd7e3c6e377a07-45fc4.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 522px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 50.191570881226056%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAAB4klEQVQoz5VSaVMaQRTc//8Xkg8pywMlEA8MqAGk5HBxwVW5j12IXEEpWWRnFhA6zVhSlW9mql69mdnZfq+7n7ZarfCZWC6XWC/LqqBRD6NUOIZx44d5G1S5ZV9Av96Hhv9chQcDxUIA5eIhUsktgvmQSW+j141yT0DHcTAcDjAaPeH5efhPfNwJIeC6Ls8j9Pt9NJsWpJTwPMks4HE/nU75RkDLGT/wZxBDvXYK2wozImw/onKtGsK9eYCbbJSPPdJ+U116nqcAZzNP7dd5XVQICa1tnxEwSioB5A0fstc7SF19w21+H3pmB71OhN8SGI9fMZm8IpE4h9U8RaV8hBzp3pl+RbvzeIGsvgfNap7h8XeE4h4oQCO7S6BtBbjWqNeNoFpJQ8gZO5lB168IeM4iJ/y+y+791NBHjBhyRhBao/aTJIqQIgvh6pg4aYxfUpvzyyjOYlE4jruhPJ8vCD7HYvHGWKiQ0lN32v3dIWbe+8+D/i9WD6FePcbTMM57g+CXqFQyFF1uTLEsmx0LZchaO7kxxYXW7bTpWlnNl21X0WrV0GbYPL/PXJHdjTdjUyqZ1O07TQyrGSxyHk0zSGkukc8FPj+HH3Tr9Qe6f0S99xCLfkGSBsZjX9FshJCk5n8B3mzXbNSD5HAAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 05 10 40 53" title="" data-src="/static/2024-11-05-10-40-53-945f2a6244dd0e6b28cd7e3c6e377a07-45fc4.png" data-srcset="/static/2024-11-05-10-40-53-945f2a6244dd0e6b28cd7e3c6e377a07-31b3a.png 200w,\n/static/2024-11-05-10-40-53-945f2a6244dd0e6b28cd7e3c6e377a07-60bb2.png 400w,\n/static/2024-11-05-10-40-53-945f2a6244dd0e6b28cd7e3c6e377a07-45fc4.png 522w" data-sizes="(max-width: 522px) 100vw, 522px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>客户端负载均衡应用广泛，例如目前主流的微服务架构实现框架 Spring Cloud、Dubbo 等都内置了完整的客户端负载均衡模块。而像老牌的分布式缓存 Memcache 同样也是这一负载均衡策略的典型应用。</p>\n<p>我们来对上述这两种负载均衡机制做一个对比，会发现客户端负载均衡不需要架设专门的服务器组件，负载均衡算法的执行过程被分摊到了每个客户端内部，不会造成明显的单点瓶颈。当然，因为每个客户端自己都需要维护一套服务实例信息，所以需要确保服务实例的变更能够及时通知到各个客户端。</p>\n<h3 id="负载均衡算法和策略"><a href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95%E5%92%8C%E7%AD%96%E7%95%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>负载均衡算法和策略</h3>\n<p>无论使用哪种负载均衡机制，负载均衡算法决定了最终的请求分发效果。常见的负载均衡算法也可以分成两大类，即静态负载均衡算法和动态负载均衡算法。</p>\n<h4 id="静态负载均衡"><a href="#%E9%9D%99%E6%80%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>静态负载均衡</h4>\n<p>对于静态负载均衡而言，经典的算法包括各种随机（Random）和轮询（Round Robin）算法。</p>\n<ol>\n<li>\n<p>随机算法</p>\n<p>随机算法是最简单也是最常用的负载均衡算法之一，该算法就是使用一个随机数来决定具体的目标服务实例。</p>\n<p>假设我们持有一个保存所有服务的 serverList 列表，那么只用 JDK 中自带的 Random 工具类就可以实现一个基本的随机算法，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58936089336913610000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`java.util.Random random = new java.util.Random();\nint randomPosition = random.nextInt(serverList.size());\nreturn serverList.get(randomPosition);`, `58936089336913610000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">int</span> randomPosition <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>serverList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">return</span> serverList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>randomPosition<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>随机算法足够简单，但有时候并不能满足我们的需求。例如，如果在集群中存在一些性能有差异的服务器，为了充分利用那些高性能的服务器，可以提升这些服务器的访问权重，这时候就可以引入用加权随机（Weight Random）算法。</p>\n<p>假设存在一个 serverWeightMap 保存着服务器地址与权重之间的对应关系，类似 <code class="language-text">(&quot;192.168.10.100&quot;, 1)</code>、<code class="language-text">(&quot;192.168.10.105&quot;, 3)</code> 这样的结构，那么实现加权随机的一种简单策略就是构建一个新的 serverList 列表，并根据服务权重的数量来添加重复数量的服务提供者地址（这样权重越高的服务被选中的概率就会越大），然后再使用随机算法进行选择，示例代码如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10206584619976677000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Set<String> keySet = serverWeightMap.keySet();\nIterator<String> iterator = keySet.iterator();\nList<String> serverList = new ArrayList<String>();\nwhile (iterator.hasNext()) {\n  String server = iterator.next();\n  int weight = serverWeightMap.get(server);\n  for (int i = 0; i < weight; i++) {\n     serverList.add(server);\n  }\n}\n\njava.util.Random random = new java.util.Random();\nint randomPosition = random.nextInt(serverList.size());\nreturn serverList.get(randomPosition);`, `10206584619976677000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> keySet <span class="token operator">=</span> serverWeightMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> iterator <span class="token operator">=</span> keySet<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> serverList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token class-name">String</span> server <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">int</span> weight <span class="token operator">=</span> serverWeightMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> weight<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n     serverList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\njava<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">int</span> randomPosition <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>serverList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">return</span> serverList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>randomPosition<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>轮询算法</p>\n<p>所谓轮询，就是一个循环访问所有服务器列表的过程。在循环过程中，如果发现某台服务器可用就把请求分发给它。如果一个循环下来还是没有找到合适的服务器，那么就继续进行新的一轮循环，直到找到目标服务器。</p>\n<p>轮询算法的一种简单的实现方法如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54625750312743770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`String server = null;\nsynchronized(position) {\n  if (position > serverList.size()) {\n     position = 0;\n  }\n\n  server = serverList.get(position);\n  position++;\n}\n\nreturn server;`, `54625750312743770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">String</span> server <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n<span class="token keyword">synchronized</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>position <span class="token operator">></span> serverList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n     position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  server <span class="token operator">=</span> serverList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  position<span class="token operator">++</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">return</span> server<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>类似加权随机算法，我们也可以实现加权轮循（Weighted Round Robin）算法。</p>\n</li>\n</ol>\n<h4 id="动态负载均衡算法"><a href="#%E5%8A%A8%E6%80%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>动态负载均衡算法</h4>\n<p>对于负载均衡算法而言，权重本质上也是一个可以动态变化的参数，所以也可以基于权重构建动态负载均衡算法。</p>\n<p>典型的动态负载均衡算法实现过程都没有那么简单，常见的包括最少连接数算法、源 IP 哈希算法、服务调用时延算法等。</p>\n<ol>\n<li>\n<p>最少连接数算法</p>\n<p>所谓最少连接数（Least Connection）算法，就是根据当前服务器的连接数量来决定目标服务器。在系统运行过程中，连接数显然是一个不断在变化的参数，我们可以选择那些连接数较少的服务来接收新的请求。</p>\n<p>因此，当执行分发策略时，我们会根据在某一个特定的时间点下服务实例的最新连接数来判断是否执行客户端请求。而在下一个时间点时，服务实例的连接数一般都会发生相应的变化，对应的请求处理也会做相应的调整。</p>\n</li>\n<li>\n<p>源 IP 哈希算法</p>\n<p>在日常开发过程中，有时候我们希望实现这样一种分发效果：来自同一个客户端的请求总是发送到某一个固定的服务器，这时候就可以引入源 IP 哈希（Source IP Hash）算法，该算法会根据请求的 IP 地址来决定目标服务器。只要源 IP 地址不变，那么负载均衡的结果也是固定的。</p>\n<p>源 IP 哈希算法一种实现方案如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24414035153555180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`String remoteIp = getRemoteIp();\nint hashCode = remoteIp.hashCode();\nint serverListSize = serverList.size();\nint serverPos = hashCode % serverListSize;\nreturn serverList.get(serverPos);`, `24414035153555180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">String</span> remoteIp <span class="token operator">=</span> <span class="token function">getRemoteIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">int</span> hashCode <span class="token operator">=</span> remoteIp<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">int</span> serverListSize <span class="token operator">=</span> serverList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">int</span> serverPos <span class="token operator">=</span> hashCode <span class="token operator">%</span> serverListSize<span class="token punctuation">;</span>\n<span class="token keyword">return</span> serverList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>serverPos<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>服务调用时延算法</p>\n<p>服务调用时延（Service Invoke Delay）算法的动态性来自于服务的调用延迟。针对每一台服务器，我们都可以计算一段时间内所有请求的服务调用时延。有了这个参数之后，就可以执行各种计算策略进一步决定选择哪一台服务器来对请求做出响应。</p>\n</li>\n</ol>\n<p>针对前面介绍的各个负载均衡算法，我们可以通过如下所示的一张思维导图来进行总结：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-05-10-48-23-d2a37837d46bbd01af255d3e5e164a68-a3ca3.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 642px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 76.16822429906543%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAACq0lEQVQ4y41Ta0/iQBTt//8Tm7jRD2t0xcciQTRZFYVSoKWU8irQ8igFK0JFQODsmYq7atzs3uSmk+nMueeee0Zar9cQ8fr9V/j+AKnbbWTkbcjpl8zIO8hmdnB78xXSarXCarUMDwfBGO12AR2mY6toOxrsVg6ua+Pxccp8hG23UK/JzPS7tOoymg0F0tvqrttBUd9D8voLbpJbm+pbKJVSeHiYwL/3eaYHyzJYsIxWs4RWq0QgI/yKfcmq57mh4vl5geVyGTJotx2yCTAePxBohPl8Fv4T0e06qJQjBIzCNPZQNg9R0PbQsKKoVY8hFfV9Lg5ZuYv7+xHB2lz30eu5YZtvY7F4JvgCLbtBOZrodW12kYAsx6FkzpBOxSGVzRP2H4V/N9xcWoQpGAlthcYihsMe5YihWrkgqwQZ6uh0emQWZ+sx6p5gpzFI1coPLk7heW446SAIOMk7DAYenp6m3HsBdJwy7OYRrFoE3c4xQeMol6vI51PIZC6hKFfIKklImip0iJCBR80m/PoEHOGOuZGNwDNoWhYl4wzFYhxmKY5mU0Wj0aRcUbI9hdOKoV49gSQqO7YJYcPRaAC9cMlDMvURk9R4+ZZs+yGw0E/oOJstKMU67Miq6xySwjs5Ms6+t43jGOHkNHUXCs2qqd/CiXpe51OTi+lb9Z+U7IKAiVCGjbFXmwNz9PsuPJFen2t6rl6jBD7lGHPqE7YfYDoNyHROeYYsesZBXcIoCtArMvyPpyfaU9U0/bbPixHkc99QKJzTzDY1vaaWmTDN0s0L4CvWer3+kKvfhnbdBtkewNB32eIBKpVzGIYJXT/isCJhFtTvfxjiA8O3wCJGI58ssgTLkVmWD6BCH3ZpmyTfco5tZ2Gayt8BP4J/FkEwCY3dtmP0ZiJ8fr8AFfhTMIFGKjoAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 05 10 48 23" title="" data-src="/static/2024-11-05-10-48-23-d2a37837d46bbd01af255d3e5e164a68-a3ca3.png" data-srcset="/static/2024-11-05-10-48-23-d2a37837d46bbd01af255d3e5e164a68-f8a33.png 200w,\n/static/2024-11-05-10-48-23-d2a37837d46bbd01af255d3e5e164a68-8ae0d.png 400w,\n/static/2024-11-05-10-48-23-d2a37837d46bbd01af255d3e5e164a68-a3ca3.png 642w" data-sizes="(max-width: 642px) 100vw, 642px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="源码解析-6"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h2>\n<p>有了理论知识，我们接下来讨论负载均衡的实际应用。诸如最少连接数算法、服务调用时延算法等动态负载均衡算法在设计和实现上都比较复杂，我们重点来看一下主流开源框架中对它们的实现机制。在接下来的内容，我们以 Dubbo 框架为例展开讨论。</p>\n<h3 id="dubbo-负载均衡整体结构"><a href="#dubbo-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dubbo 负载均衡整体结构</h3>\n<p>在 Dubbo 中，专门提供了一个 LoadBalance 接口来提供负载均衡能力，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12700635608578170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@SPI(RandomLoadBalance.NAME)\npublic interface LoadBalance {\n    @Adaptive(&quot;loadbalance&quot;)\n    <T> Invoker<T> select(List<Invoker<T>> invokers, URL url, Invocation invocation) throws RpcException;\n}`, `12700635608578170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@SPI</span><span class="token punctuation">(</span><span class="token class-name">RandomLoadBalance</span><span class="token punctuation">.</span>NAME<span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">LoadBalance</span> <span class="token punctuation">{</span>\n    <span class="token annotation punctuation">@Adaptive</span><span class="token punctuation">(</span><span class="token string">"loadbalance"</span><span class="token punctuation">)</span>\n    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span><span class="token punctuation">></span></span> invokers<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到 LoadBalance 接口只有一个方法，即在一批 Invoker 列表中选择其中一个 Invoker 进行返回。这里，我们可以从该接口上的 <code class="language-text">@SPI(RandomLoadBalance.NAME)</code> 注解中看到 Dubbo 默认加载的是 RandomLoadBalance 类，即随机负载均衡。除了 RandomLoadBalance 类之外，Dubbo 还提供了其他多种负载均衡策略，整体的类层结构如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-05-10-49-27-62c59b2b1f5646dd706f22c3812aec23-ba470.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 649px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 59.78428351309707%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAAB3klEQVQoz51SbU/aUBjt//+2ZF80823ZPsxFolGic+NFqiAvDtio7aWIFoggtOCkWKAvZ8+9TdlcmizxJk/ubc+5J+fc55EQs4IgELtp9tG+OUWlvAedJdHvM4RQsOL8u6R4QV/s/XsD3c4RqlcfSXiPzvXXCobkmT3Fw6CFXk8lcYbJZLTCXyc4m8Ky2iKqZbbw9GT+XzACX1YYeTAwUK9+wHHyDYqFd+gYNfh/RY6rWIfRsswhmJbCzx/HuFZO0Os2XySIdeg4NpZLB8vFMxaiZvA8V4COMxPYeDwC53Hc9z0hGH3ziu5yrpRJb+BC3kIhv4NcdhOpr2/BWJne7R7p1Bou8+8FdpbdgJxbJ8cVjEYPyKTXcC5v4uJ8m/YtZDPrKBU/QdJUGXe3l7htF+iNSmiyLIZDgxpiQ9POKGpKYHpTpuhfaDZ7wjljOeIXYdDd8H6eRqvEmwIxWz71Yb7wyLpP1j24ro/HR5tGZSpw/s+yfsG2nwnjPKqlj/mccwNEOlL0wK67QKPxDbVqUjip104oagKamiaRKbm+E82plA9xVTmC0jgVZ87vdpRo4P4I8hjV77u40Q/Qah5QRCq2D1VJYDK20O0qUK8/E34YYlRM26cnSkDXC6vu/wZDLYMHMErN6wAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 05 10 49 27" title="" data-src="/static/2024-11-05-10-49-27-62c59b2b1f5646dd706f22c3812aec23-ba470.png" data-srcset="/static/2024-11-05-10-49-27-62c59b2b1f5646dd706f22c3812aec23-47540.png 200w,\n/static/2024-11-05-10-49-27-62c59b2b1f5646dd706f22c3812aec23-ee316.png 400w,\n/static/2024-11-05-10-49-27-62c59b2b1f5646dd706f22c3812aec23-ba470.png 649w" data-sizes="(max-width: 649px) 100vw, 649px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>从上图中，我们看到存在一个 AbstractLoadBalance 抽象类，它实现了 LoadBalance 的 select 方法，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4299304351331901000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public <T> Invoker<T> select(List<Invoker<T>> invokers, URL url, Invocation invocation) {\n   if (invokers == null || invokers.size() == 0)\n      return null;\n   if (invokers.size() == 1)\n      return invokers.get(0);\n   return doSelect(invokers, url, invocation);\n}`, `4299304351331901000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span><span class="token punctuation">></span></span> invokers<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>invokers <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> invokers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>\n      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>invokers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>\n      <span class="token keyword">return</span> invokers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> <span class="token function">doSelect</span><span class="token punctuation">(</span>invokers<span class="token punctuation">,</span> url<span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>显然，从设计模式上讲，这里采用的是经典的模板方法。通过模板方法，具体负载均衡算法由 AbstractLoadBalance 子类中的 doSelect 方法进行实现。</p>\n<p>同时，我们在 AbstractLoadBalance 中还看到了如下所示的 getWeight 方法。从方法命名上看，该方法用来计算权重，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83389238376680690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`protected int getWeight(Invoker<?> invoker, Invocation invocation) {\n   // 从 URL 中获取权重\n   int weight = invoker.getUrl().getMethodParameter(invocation.getMethodName(), Constants.WEIGHT_KEY, Constants.DEFAULT_WEIGHT);\n   if (weight > 0) {\n      long timestamp = invoker.getUrl().getParameter(Constants.REMOTE_TIMESTAMP_KEY, 0L);\n      if (timestamp > 0L) {\n         int uptime = (int) (System.currentTimeMillis() - timestamp);\n         // 从 URL 中获取预热时间\n         int warmup = invoker.getUrl().getParameter(Constants.WARMUP_KEY, Constants.DEFAULT_WARMUP);\n         if (uptime > 0 && uptime < warmup) {\n            // 计算预热权重\n            weight = calculateWarmupWeight(uptime, warmup, weight);\n         }\n      }\n   }\n   return weight;\n}`, `83389238376680690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">getWeight</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> invoker<span class="token punctuation">,</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 从 URL 中获取权重</span>\n   <span class="token keyword">int</span> weight <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethodParameter</span><span class="token punctuation">(</span>invocation<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>WEIGHT_KEY<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>DEFAULT_WEIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>weight <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">long</span> timestamp <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>REMOTE_TIMESTAMP_KEY<span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>timestamp <span class="token operator">></span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">int</span> uptime <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token comment">// 从 URL 中获取预热时间</span>\n         <span class="token keyword">int</span> warmup <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>WARMUP_KEY<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>DEFAULT_WARMUP<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>uptime <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> uptime <span class="token operator">&lt;</span> warmup<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 计算预热权重</span>\n            weight <span class="token operator">=</span> <span class="token function">calculateWarmupWeight</span><span class="token punctuation">(</span>uptime<span class="token punctuation">,</span> warmup<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">return</span> weight<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到代表权重的 weight 参数是从 URL 中传入的。而基于上述代码，我们发现这里的处理逻辑显然并没有那么简单，而是用到了所谓的预热（Warmup）机制。我们看到 Dubbo 首先会获取服务启动时间，然后再与预热时间进行比较。如果启动时间小于预热时间，则会调用 calculateWarmupWeight 方法来重新计算预热权重。</p>\n<p>从代码逻辑上看，预热权重最小为 1，并在预热时间内随启动时间逐渐增加。这样设计的原因在于：JVM 从启动成功到处于最佳状态需要一段时间，在这段时间内虽然服务可以接收请求，但显然不应该接收过多请求。所以，Dubbo 通过预热机制确保在预热时间内该服务受到一定的保护，直到其处于最佳运行状态。</p>\n<p>预热机制在 Dubbo 的多个负载均衡算法中都得到了应用，是一种实现上的技巧，为我们设计类似的应用场景提供了一定的参考价值。</p>\n<h3 id="dubbo-负载均衡算法实现示例"><a href="#dubbo-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0%E7%A4%BA%E4%BE%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dubbo 负载均衡算法实现示例</h3>\n<p>接下来，就让我们看看 Dubbo 中使用预热机制的场景和方式。我们重点介绍 LeastActiveLoadBalance 类，这是一种典型的动态负载均衡算法。</p>\n<p>LeastActiveLoadBalance 继承自 AbstractLoadBalance 类，并实现了如下所示的 doSelect 方法。该方法比较长，我们对代码进行了部分裁剪。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49843724873490694000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Override\nprotected <T> Invoker<T> doSelect(List<Invoker<T>> invokers, URL url, Invocation invocation) {\n   // 获取所有的 invoker 并执行计算\n   for (int i = 0; i < length; i++) {\n      Invoker<T> invoker = invokers.get(i);\n      // 通过 RpcStatus 获取当前这个 invoker 并发数\n      int active = RpcStatus.getStatus(invoker.getUrl(), invocation.getMethodName()).getActive();\n      // 通过预热机制计算权重值\n      int afterWarmup = getWeight(invoker, invocation);\n\n      // 发现最小的活跃数，重新开始计算\n      if (leastActive == -1 || active < leastActive) {\n         // 记录 leastActive 为当前的活跃数，并重置最小计数，基于当前最小计数重新计数\n         // …\n      } else if (active == leastActive) {\n         // 当前 invoker 的活跃数与最小活跃数相等,则记录权重\n         // …\n      }\n   }\n\n   // 如果我们恰好有一个调用程序具有最少的活动值，那么直接返回这个调用程序\n   if (leastCount == 1) {\n      return invokers.get(leastIndexs[0]);\n   }\n\n   // 如果每个 invoker 有不同的权重\n   if (!sameWeight && totalWeight > 0) {\n      // 在总权重范围内随机一个值\n      int offsetWeight = random.nextInt(totalWeight) + 1;\n      for (int i = 0; i < leastCount; i++) {\n            // 获取 i 位置的那个最小活跃在 invokers 里面的位置信息\n            int leastIndex = leastIndexs[i];\n            offsetWeight -= getWeight(invokers.get(leastIndex), invocation);\n            if (offsetWeight <= 0) {\n               // 返回这个位置\n               return invokers.get(leastIndex);\n            }\n\n      }\n   }\n\n   // 具有相同权重或者是总权重 = 0 的话就均匀返回\n   return invokers.get(leastIndexs[random.nextInt(leastCount)]);\n}`, `49843724873490694000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">doSelect</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span><span class="token punctuation">></span></span> invokers<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 获取所有的 invoker 并执行计算</span>\n   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> invoker <span class="token operator">=</span> invokers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 通过 RpcStatus 获取当前这个 invoker 并发数</span>\n      <span class="token keyword">int</span> active <span class="token operator">=</span> <span class="token class-name">RpcStatus</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invocation<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 通过预热机制计算权重值</span>\n      <span class="token keyword">int</span> afterWarmup <span class="token operator">=</span> <span class="token function">getWeight</span><span class="token punctuation">(</span>invoker<span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 发现最小的活跃数，重新开始计算</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>leastActive <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> active <span class="token operator">&lt;</span> leastActive<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token comment">// 记录 leastActive 为当前的活跃数，并重置最小计数，基于当前最小计数重新计数</span>\n         <span class="token comment">// …</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>active <span class="token operator">==</span> leastActive<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token comment">// 当前 invoker 的活跃数与最小活跃数相等,则记录权重</span>\n         <span class="token comment">// …</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token comment">// 如果我们恰好有一个调用程序具有最少的活动值，那么直接返回这个调用程序</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>leastCount <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> invokers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>leastIndexs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token comment">// 如果每个 invoker 有不同的权重</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sameWeight <span class="token operator">&amp;&amp;</span> totalWeight <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 在总权重范围内随机一个值</span>\n      <span class="token keyword">int</span> offsetWeight <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>totalWeight<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> leastCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 获取 i 位置的那个最小活跃在 invokers 里面的位置信息</span>\n            <span class="token keyword">int</span> leastIndex <span class="token operator">=</span> leastIndexs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n            offsetWeight <span class="token operator">-=</span> <span class="token function">getWeight</span><span class="token punctuation">(</span>invokers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>leastIndex<span class="token punctuation">)</span><span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>offsetWeight <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token comment">// 返回这个位置</span>\n               <span class="token keyword">return</span> invokers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>leastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token comment">// 具有相同权重或者是总权重 = 0 的话就均匀返回</span>\n   <span class="token keyword">return</span> invokers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>leastIndexs<span class="token punctuation">[</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>leastCount<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在上述代码中，我们对关键流程添加了注释。该算法首先会对所有的 Invoker 进行轮询，找出所有活跃数最小的集合。如果这个集合的数量只有 1，那么就可以直接返回当前的 Invoker。如果集合中所有 Invoker 的权重相同，那么随机返回一个。而如果这些条件都不满足，那么就获取一个具有最小活跃数的 Invoker。</p>\n<p>为了实现扩展性，Dubbo 提供了 SPI 机制，允许开发人员自定义负载均衡算法，我们会在后面介绍微内核架构和 SPI 机制时给出一个简单的案例。你也可以根据自己的需要尝试实现新的负载均衡算法。</p>\n<h2 id="解题要点-8"><a href="#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解题要点</h2>\n<p>在分布式系统面试中，负载均衡是一道高频面试题。针对常见的负载均衡算法以及它们的特性，面试官考查的是候选人对分布式系统基本概念的理解。因为负载均衡的各种算法以及特性相对固定，所以这类题的考点是非常明确的。</p>\n<p>在回答这类面试题时，需要把握两点。首先，我们要介绍负载均衡算法的分类，即静态负载均衡和动态负载均衡。其次，我们需要列举常见负载均衡算法，并基于自己的理解分析这些算法的功能特性。针对随机、轮询等静态负载均衡算法，我们的回答思路是给出基本的设计策略和所能达到的效果，以及如何将这些静态负载均衡算法转换为动态负载均衡算法的实现方法。因为静态负载均衡算法相对都比较简单，所以这部分内容不是回答的重点。我们需要详细介绍的是一致性哈希、最少连接数等动态负载均衡的实现原理。</p>\n<p>另一方面，关于负载均衡算法的考查，基于具体开源框架内部的实现细节进行提问也是另一种比较常见的方式。例如，如果被问到类似 <code class="language-text">Dubbo 框架在实现负载均衡机制时提供了哪些优化特性？</code> 这样的问题，回答起来是有难度的，因为它考查的并不仅仅是对 Dubbo 中所提供的负载均衡算法的描述，而更多的是问到了框架的底层设计思想和实现原理，需要面试者对 Dubbo 的源码有较深程度的理解，并能抓住细节。在回答上，就需要提到 Dubbo 中的“预热”机制，该机制的目的是确保服务在刚启动的一段时间内得到保护，避免因为负载均衡导致出现不可用的情况。在回答这道题时，这些内容背后的设计思想都应该被介绍到。</p>\n<h2 id="小结与预告-6"><a href="#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结与预告</h2>\n<p>本讲内容梳理了分布式系统开发过程中所采用的负载均衡算法。在 Spring Cloud 中所实现的核心负载均衡算法包括随机、轮询、加权响应时间、并发量最小优先等，而 Dubbo 中则提供了随机、轮询、最少活跃调用数和一致性哈希等算法。可以看到，这两个框架在实现主流算法的同时，也根据框架自身的特点提供了一些比较有特色的策略。当然，这两个框架也都内置了扩展入口供开发人员实现自定义的负载均衡算法。</p>\n<p>在介绍完负载均衡之后，我们接下来要进入到“服务容错”这一技术组件的讨论。服务容错的实现方式有很多，其中集群的构建为容错机制提供了天然的基础。那么，什么是集群容错？现实中又有哪些常见的集群容错策略呢？下一讲将对这些问题展开详细的分析。</p>\n<h1 id="服务容错：什么是集群容错？有哪些集群容错策略？"><a href="#%E6%9C%8D%E5%8A%A1%E5%AE%B9%E9%94%99%EF%BC%9A%E4%BB%80%E4%B9%88%E6%98%AF%E9%9B%86%E7%BE%A4%E5%AE%B9%E9%94%99%EF%BC%9F%E6%9C%89%E5%93%AA%E4%BA%9B%E9%9B%86%E7%BE%A4%E5%AE%B9%E9%94%99%E7%AD%96%E7%95%A5%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务容错：什么是集群容错？有哪些集群容错策略？</h1>\n<p>在前面两讲内容中，我们对远程过程调用中的负载均衡机制进行了详细的讨论。而在介绍负载均衡的实现策略时，我们也提到了集群这一概念。集群的构建一方面能够为实现负载均衡提供基础，另一方面，它也能够有效应对服务访问出错的场景，这就是集群容错。</p>\n<p>在分布式系统运行过程中，远程调用发生失败的现象不可避免。为了应对服务访问失败，集群容错是一种简单高效的技术组件。</p>\n<p>那么，什么是集群容错？常见的又有哪些集群容错策略呢？这一话题也是分布式服务相关的一道高频面试题，本讲内容将对这一主题展开全面的讨论。</p>\n<h2 id="问题背景-6"><a href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题背景</h2>\n<p>在分布式系统中，对于服务提供者和消费者而言实际上存在一种依赖关系。一方面，每个服务自身可能会发生异常情况，更为重要的，这种依赖关系会导致系统中的其他服务也发生调用失败，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-06-11-05-17-df0dbd0dd42f326b8319da58761955e2-daebf.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 502px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 41.23505976095617%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABY0lEQVQoz42S6U7CUBCF+/7vocHI4oYiS6CCGCqtgNCCLC2lK6UsZSnEwHFoIjHBBCaZHzOZOfPl3MtwpRt02k8ov1/jQ4hC4CNUP6L+mYTnLbCP3W53djKNehyz6SuqlTBa0j3qtRjmXhGKwsJ1JwfBc4NxHAeqqsI0DYiiCF3Xgnrf/4/uFDHzq2xZFnRDhyzL8H0/6G232yOCU7SM728wGk2IyAXPV6BpJoZDF6vV+iCwF/5LuF5vMB7PMJ8vA58nE4/smQY7TLWSRF/J0oPc4a14BU3NQxu8oCmx2Gy+adANrOh2u5QdWvLRbBYg9zLk+wNq1Tjts9C1PMRGFkyvl6CbVbSaMVhmGst5kWoJipyiAyUimJG/JmzbDsRluY+BmqOZCqRGBO2vW3izQrBjGiwYgY9h5OToUhhiPQqOu4Shp4jwmUScI48WixUkMYWhnaGvFoJQDoErXZBYmvoJ/ADUzFSuodErFAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 06 11 05 17" title="" data-src="/static/2024-11-06-11-05-17-df0dbd0dd42f326b8319da58761955e2-daebf.png" data-srcset="/static/2024-11-06-11-05-17-df0dbd0dd42f326b8319da58761955e2-d8b35.png 200w,\n/static/2024-11-06-11-05-17-df0dbd0dd42f326b8319da58761955e2-df7a1.png 400w,\n/static/2024-11-06-11-05-17-df0dbd0dd42f326b8319da58761955e2-daebf.png 502w" data-sizes="(max-width: 502px) 100vw, 502px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>那么问题就来了，一旦出现上图中的失败场景，我们有什么应对策略呢？这是开发任何一个分布式系统必须要考虑的问题，也是面试官非常喜欢考查的一个问题。</p>\n<p>就技术体系而言，我们可以把应对远程调用失败场景的各种手段和方法统称为服务容错（Fault Tolerance），而集群容错是服务容错的其中一种实现方式。我们知道，所谓集群，就是同时存在一个服务的多个实例。一旦我们访问其中一个实例出现问题，原则上可以访问其他实例来获取结果。</p>\n<p>围绕这个过程，技术上有很多值得面试官考查的点，包括：</p>\n<ul>\n<li>如何判断集群中当前有哪些服务实例是不可用的？</li>\n<li>如果某一个服务实例不可用，选择下一个服务实例的策略有哪些？</li>\n<li>如果访问所选择的下一个服务实例仍然失败，我们应该怎么做？</li>\n<li>为了快速判断集群中某个服务是否存在可用的示例，有什么办法？</li>\n</ul>\n<p>当然，和负载均衡一样，主流的分布式服务框架也都内置了集群容错机制。例如 Dubbo 框架就包含一组非常常用的集群容错实现策略。在面试过程中，针对具体框架中集群容错的底层实现原理进行讨论的场景并不少见。</p>\n<h2 id="问题分析-7"><a href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题分析</h2>\n<p>对于集群容错，我们首先还是有必要分析远程调用发生依赖失败的影响，或者说我们需要引入集群容错机制的原因，这里就引出一个非常适合作为面试话题来展开的概念，即 <code class="language-text">雪崩效应（Avalanche Effect）</code>。雪崩效应是我们引入容错思想和模式的根本需求。以我的面试经历而言，雪崩效应在分布式系统相关面试场景中出现的频次比较高，在介绍具体容错机制之前，先来对这个概念进行展开有助于提升候选人给到面试官的第一印象。</p>\n<p>回答这一问题的第二个要点是对集群容错的各种实现策略的详细分析。这部分内容属于理论知识体系，需要进行记忆。幸好常见的集群容错实现策略并不是很多，因此掌握起来并不困难。</p>\n<p>最后，我们还是需要理论联系实际。集群容错的几种代表性实现策略在 Dubbo 等主流的开源框架都有体现。在面对面试官时，基于具体的框架底层实现原理来展示自己对集群容错机制的掌握程度无疑是一种加分项。</p>\n<h2 id="技术体系-9"><a href="#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术体系</h2>\n<p>正如前面提到的，服务依赖失败是我们在设计分布式系统时所需要重点考虑的服务可用性问题，因为服务依赖失败会造成失败扩散，从而形成服务访问的雪崩效应。让我们先从这个过程开始讲起。</p>\n<h3 id="雪崩效应"><a href="#%E9%9B%AA%E5%B4%A9%E6%95%88%E5%BA%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>雪崩效应</h3>\n<p>下图展示了雪崩效应的示意图，可以看到 A、B、C、D、E 这 5 个服务存在依赖关系，服务 A 为服务提供者，服务 B 为服务 A 的消费者，服务 C、D 和 E 则是服务 B 的消费者。现在，假如服务 A 变成不可用，就会引起服务 B 的不可用，并将这种不可用性逐渐扩散到服务 C、D 和 E 时, 从而造成了整个服务体系发生雪崩。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-06-11-08-28-e7c9b4f01d8d83685a9e97d7a659af46-d80b6.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 492px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 51.016260162601625%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABgUlEQVQoz41SiWrCQBDN/39ESw8oiKigxTNqadW2HtFEk3iVGo/ihdpWE03M62TVgGLBgWFn3868mX27HE7Mtm22mrSKiQTUQACC1wvR74NCXkkld3nbLcs9de4/wrVloRaPo/sYQub6Cvn7e2ihICRqciA8Z9w58EC6Wq2wXP5CVRU0mw0W67ru5lw04dGUa5NIdIxGEwyHYxZvNtblhAeQaWhuUVez6GppKHKUudZJQ1Ve97nbo+bulc912RHaVJxEvxdB4f0BpaIHvW4Y1WrSJbz4yo4ZhgFJFIlURrFYQKUsQKFYlmuujmcfxbJs0sYggg0lbjCf/2A8nmKxmONwGwebzb73kzn7GSaTKcMNw2R1DocjEydWeHQ+nyDXYmi30qQb6aXkWbFKGrZbPE0apvMoPtpJ0jLHzlpNifAQvX6KMPpe2gvKQsQhDKLfjSHzfIOq5Mdsmkaj/kYdTdTrKUoMI5u5hVDy4GsQgyTxO8KWwPZlwnPZOwz6PMniwx8eUvAnm4YREAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 06 11 08 28" title="" data-src="/static/2024-11-06-11-08-28-e7c9b4f01d8d83685a9e97d7a659af46-d80b6.png" data-srcset="/static/2024-11-06-11-08-28-e7c9b4f01d8d83685a9e97d7a659af46-3e95a.png 200w,\n/static/2024-11-06-11-08-28-e7c9b4f01d8d83685a9e97d7a659af46-11c87.png 400w,\n/static/2024-11-06-11-08-28-e7c9b4f01d8d83685a9e97d7a659af46-d80b6.png 492w" data-sizes="(max-width: 492px) 100vw, 492px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>服务雪崩的产生是一种扩散效应，我们可以对上图中的现象进行剥离，先从服务 A 和服务 B 这两个服务之间的交互进行切入。下图展示了雪崩效应产生的三个阶段，即首先服务提供者 A 发生不可用，然后服务消费者 B 不断进行重试加大了访问流量，最后导致服务 B 自身也不可用。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-06-11-09-11-8871c8a88a751876bbf16c18a2e9d0fe-19a4b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 435px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 68.50574712643677%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAACfUlEQVQ4y4VTa0/iQBTt//8L+2GNikpWEFATUVytRKnyqAFaSqGlpYAUpBTKq3Xx7J0msrqb1UlupvM4Z+6555aTpVMUCwmIpSQq5RM8ikmIooDlysdqtaRYbcL3V1gslsjdHaNKdxmuVEwSJhXiyuUiuJfgDkLuOxHuwtBTWMxvcHi4hV7PhuOMMBr9ifHYof0+Hu4PMJ/xuM1+I9JtKPIPLBdZnKcT4BpqCTU5j0pFQEMVodQKmEwcfDY0TUa9XoRKWLVeQqMhoka44dAGxy68vgJB8GsD8LwZHQ4pozFl6WA6ndIjE7iuG86fjZBw/bqGH/ibTcMwIMsyWq0WdF2HbdsYDAbodDrodrsshf8TMnBNknB9dYWOZZEcDV8Nlr2ua/SABctqw2qb4cNBEICbZm8gH8WhJOLoXpxjeJnBZSqFwfPzRvLb7LpjynaIQj4BZ5Sl2ifRbJzCaBFuyJP7P8HNeB75nR2IkQi0JF3MZHAWi8Glus1nM8zexWIxJ2IX+YcYxg4P4W6bviOkkD3AI5u9AKcqCkxNh0FSW80mmqr6peTBwCZnFSqPCkWRYJo6rethr3J/X16v13TYCIPVxTTN0CRmTK/XC/eZ22/d8RK8/OvyB0KK3tMTFdsKXe33+yEZa2xmBnN5SZmwsSITplSKD4SaLKGt1sMw6ySD1oHvfyq5S1m3lBqkYgF8Og2LKapWMaUe5ZbXV6juUWEP9tFOJeGep3FEJtmUjfvOZRZMap/6USADvcwFypFdyITT4jFMqEMuj1PgOtQmuf09PESjkGjDJEKBenJCLnsU7C/xPG8zj4m0cHIMI32GWyK+jx7gkQgZThRy+A2e8AEG5lRZ5gAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 06 11 09 11" title="" data-src="/static/2024-11-06-11-09-11-8871c8a88a751876bbf16c18a2e9d0fe-19a4b.png" data-srcset="/static/2024-11-06-11-09-11-8871c8a88a751876bbf16c18a2e9d0fe-5fb9b.png 200w,\n/static/2024-11-06-11-09-11-8871c8a88a751876bbf16c18a2e9d0fe-56ca1.png 400w,\n/static/2024-11-06-11-09-11-8871c8a88a751876bbf16c18a2e9d0fe-19a4b.png 435w" data-sizes="(max-width: 435px) 100vw, 435px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在上图中，通过用户不断提交服务请求或代码逻辑自动重试等手段，服务 B 会进一步加大对服务 A 的访问流量。因为服务 B 使用同步调用，会产生大量的等待线程占用系统资源。一旦线程资源被耗尽，服务 B 本身也将处于不可用状态。这一过程在整个服务访问链路上进行扩散，就形成了雪崩效应。</p>\n<p>显然，应对雪崩效应的切入点不在于服务提供者，而在于服务消费者。我们不能保证所有服务提供者都不会失败，但是我们要想办法确保服务消费者不受已失败的服务提供者的影响，或者说需要将服务消费者所受到的这种影响降到最低，这就是服务容错的本质需求。而集群容错可以很好地应对这一需求。</p>\n<h3 id="集群容错的策略"><a href="#%E9%9B%86%E7%BE%A4%E5%AE%B9%E9%94%99%E7%9A%84%E7%AD%96%E7%95%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>集群容错的策略</h3>\n<p>在上一讲中，我们已经介绍了集群和客户端负载均衡，从服务容错的角度讲，负载均衡不失为是一种可行的容错策略。而我们今天要介绍的集群容错则是在负载均衡的基础上添加了各种容错策略，包括常见的 Failover（失效转移）、Failback（失败通知）、Failsafe（失败安全）和 Failfast（快速失败） 以及不大常见的 Forking（分支）和 Broadcast（广播） 等。我们一一来看一下。</p>\n<p>Failover 是最常见、最实用的集群容错策略。Failover 即失效转移，当发生服务调用异常时，重新在集群中查找下一个可用的服务实例。为了防止无限重试，通常对失败重试最大次数进行限制，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-06-11-11-24-4d624260adf74e3a893e5c6a74d4c84d-1093f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 553px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 40.86799276672694%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABhklEQVQoz31SaU/CQBTs//8LGhP1CzHEIoYjJoiaQOWoUKAUy1GwtEBLGwimhUYY3y4ag9dLJt036c7bnVlht9vhEFv+3W63WCwWWC6X8H0PrLy5g2IhBqWWgFy9RO1JxJMsolKOE8fWKQj4p1zXhW3bMAyD981mHc+dOFqNGMqPp5Ar5xzFwgnM0TWGxg0E3/cxndrwPOcDLu9XqxU/ZRRFCIKA94pSh6rK6HYVdHWFBpSgaTJ6vQb05xr6/TaERymO2fQWSp1NFqGpSbyMsqhWcyQIhGHIhRm+VxS9/eAEqRiD6+Rwnz9G/vYIUuEMtpWFJGXw+hrSps2vYqzYMOb3gaDjTGBZQ8xmFhxnj/F4yIMIghDMkvl8TlZ40HWd/BxgNDJoj4mHhzvIcgWTiUV8nw5i/R3Ker2mHyckPuZgoqVSEa2miEE/Q56l0FavoLWTxCWIS6PXzUHYP5MvfF6PhcASNk2Tp7yhcJwZJT5IUZppqK1LdDSRwkmS/xewzCzMlzzeAQL1TObK/JgHAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 06 11 11 24" title="" data-src="/static/2024-11-06-11-11-24-4d624260adf74e3a893e5c6a74d4c84d-1093f.png" data-srcset="/static/2024-11-06-11-11-24-4d624260adf74e3a893e5c6a74d4c84d-7baba.png 200w,\n/static/2024-11-06-11-11-24-4d624260adf74e3a893e5c6a74d4c84d-2a76e.png 400w,\n/static/2024-11-06-11-11-24-4d624260adf74e3a893e5c6a74d4c84d-1093f.png 553w" data-sizes="(max-width: 553px) 100vw, 553px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>相较 Failover，Failback 则采用了不同的实现方式，它会记录每一次失败的请求，然后再基于一定的策略执行重试操作。显然，这种容错策略适合于那种时效性不高的操作，常见的包括发送短信等消息通知类业务。</p>\n<p>Failsafe 的意思是失败安全，该策略并不会对所发生的异常做直接的干预，而是将它们记录下来，确保后续可以根据日志记录找到引起异常的原因并解决。</p>\n<p>还有一种比较容易混淆的策略称为 Failfast，该策略在获取服务调用异常时立即报错。显然，Failfast 已经彻底放弃了重试机制，等同于没有容错，一般用于非幂等性的写入操作。另一方面，在特定场景中可以使用该策略确保非核心业务服务只调用一次，为重要的核心服务节约宝贵时间。</p>\n<p>以上三种集群容错策略之间的区别可以参考下图：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-06-11-12-01-9453c179c4b6c3b7950c6b8634532e47-53b00.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 608px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.848684210526315%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABvklEQVQoz3VSa0/bQBD0//8VFVQUJPoFpAbafqnUljSEgIgTgrHxA2L7msZx4lf8OE/3zqljVe1Iez6tblYzs1ZAWCx+YaJe4mb4DqPhMabTHpIkBuc1JpOPuLs9wfXgCLOHHsJwJSjQ9Wuo96fUP8b4/j08z5J9Jc9zBMEKi58Gno0hzOcbMF9DURSo6xqM6bCsEQx9SHcN2yyTxNXKgzr+QkK+wZ2riKKwGcgYQ7Z7VHGQKnRQNyd9yrLG3wjDCGQCeV61PcV1XbKXSHJZFnAcG5r2iPV6LR9wXslizG/7cRzjxXGw3TZCiiKn2BYUg94MTNN0R94rEXa76PZFlWVFQra7gVy6qKoKirC7XAbYbBjm8xleXx9IhU+EUhLD0Jd9x5lS35PZCkRRQIvQKF+VODOy3ahVxGGaFm3yDD/6B7S1t5hOPsgY5JbVC/Sv3mDQP4T22KNlBLstD3A3OsL3rwdyy65r7gcKiDyyLKYtJnRPW8vChojEsW1SG7YRiNzSNCZOIku8kwP/ZPIvCIXBck62xlDVK/ieIaP4H8QcpRt0twTyvMCT9gmWeQ7TOIdtf5b/bMPh7VvO9/ffgUT25m7UxKEAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 06 11 12 01" title="" data-src="/static/2024-11-06-11-12-01-9453c179c4b6c3b7950c6b8634532e47-53b00.png" data-srcset="/static/2024-11-06-11-12-01-9453c179c4b6c3b7950c6b8634532e47-17576.png 200w,\n/static/2024-11-06-11-12-01-9453c179c4b6c3b7950c6b8634532e47-52273.png 400w,\n/static/2024-11-06-11-12-01-9453c179c4b6c3b7950c6b8634532e47-53b00.png 608w" data-sizes="(max-width: 608px) 100vw, 608px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>除了这些常见的集群容错机制之外，在一些分布式服务框架中，还实现了一些特殊的策略，例如提供分支调用机制的 Forking 策略和提供广播机制的 Broadcast 策略。这些策略的使用场景比较少，这里不做具体展开。</p>\n<h2 id="源码解析-7"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h2>\n<h3 id="dubbo-中的集群"><a href="#dubbo-%E4%B8%AD%E7%9A%84%E9%9B%86%E7%BE%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dubbo 中的集群</h3>\n<p>服务容错的实现方法和策略有很多，我们接下来重点讨论 Dubbo 中主要采用的集群容错实现策略和底层原理。</p>\n<p>Dubbo 中的整个集群结构如下图所示。这张图比较复杂，涉及到 Dubbo 中关于集群管理和服务调用的诸多概念。为了讨论集群容错，我们必须首先理解这种图中的相关概念，进而把握 Dubbo 对集群的抽象。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-06-11-12-46-fecfd0f98972553e0a67a7bf23252835-69f72.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 464px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 72.19827586206897%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAAClklEQVQ4y4VTi1LaQBTN//+F1To4WsW32LEqEN4BDJF3AgkPAwRMeBjAwulJWi1tx+nO3CS7e/fcc8+eCMnEOeq1SxTkEzzkg4xjVMuXeFSO8fiYxNtYrVb+u1aVUS6dQSmcIp8LQn448c+q9RDC9wEISuGKaQ9oNi6RSe1CSgfg2CLGThilUgwezmw2fQfO50WMhrdoaMxnbjazB0X+grmb4nwPQr1eQzabZlUF1WqJIAqaTZWsy3h5mcFxHKiqCtd1Yds2KpUKmUl4emqj3dbJrIpO24BhNLjWgdDvWwSpod8fYji0MRqN39ksl6+cj9Dtdv1YLpf++mhks9AEnY4JWVZYaALLemYnLltWYmRzj2oljETsCFLmjPMIWVxAkkSydMmqzFbzPDREOh0hozu0W3fU+ZQaBqE3v8EaxJFMHECQMoesKXHxlAn71HAbzvMdXpcxpFNXmExeMJ1OsVgs+D3D9XUQPfMGLSOEuLiNaHgLpWKQmouIRj5BaDZrKJYklMt5FItZtp8jC7JN3Pr6OM7Y16/X63GvRK10ymNiMDApUZ9tG2Te4/4T3wMI+GCMx1MeGJHVhNrMCGRA0zRGgwUWfo7HuNHQf9kKWK8BYc3nz1htxNpPms/nZNMn+O+Lisdvkc8eolK+Qjq5j0Q8QE+e0Z8hRCJ7m4Drd6DNb294GlqW5TNQVRlG88L3rBjd4kV8JugOfXmOVHL335b/Bvfa9cBarZZvHdM0CVrjXIeua6jRr54HNa1OPVsfa/gG6LHzwHRd92/adeewnSnttPR1syz7j3MfAm6Cbo5uV0cuF6JFDunBr4iJR9QvSk3D9PDN/xm+tb9afffnBTnG/1bEZCyiqBwgK+1CU0+8v5wa7uAHNVkFxcmqg0wAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 06 11 12 46" title="" data-src="/static/2024-11-06-11-12-46-fecfd0f98972553e0a67a7bf23252835-69f72.png" data-srcset="/static/2024-11-06-11-12-46-fecfd0f98972553e0a67a7bf23252835-c0897.png 200w,\n/static/2024-11-06-11-12-46-fecfd0f98972553e0a67a7bf23252835-d12a6.png 400w,\n/static/2024-11-06-11-12-46-fecfd0f98972553e0a67a7bf23252835-69f72.png 464w" data-sizes="(max-width: 464px) 100vw, 464px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>上图展现了 Dubbo 中的几个重要技术组件，我们一一来展开。</p>\n<ul>\n<li>Invoker：在 Dubbo 中，Invoker 是一个核心概念，代表的就是一个具体的可执行对象。</li>\n<li>Directory：即目录，代表一个集合，内部包含了一组 Invoker 对象。</li>\n<li>Router：即路由器，根据路由规则在一组 Invoker 中选出符合规则的一部分 Invoker。</li>\n<li>LoadBalance：即负载均衡，对经过 Router 过滤之后的一部分 Invoker 执行各种负载均衡算法，从而确定一个具体的 Invoker。</li>\n<li>Cluster：即集群，从 Directory 中获取一组 Invoker，并对外伪装成一个 Invoker。这样，我们在使用 Cluster 时就像是在使用一个 Invoker 一样，而在这背后则隐藏了容错机制。</li>\n</ul>\n<p>基于上述分析，今天内容所要介绍的重点是 Cluster。我们首先来看看 Dubbo 中 Cluster 接口的定义，该接口只包含一个 join 方法，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1865751765445300500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@SPI(FailoverCluster.NAME)\npublic interface Cluster {\n    @Adaptive\n    <T> Invoker<T> join(Directory<T> directory) throws RpcException;\n}`, `1865751765445300500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@SPI</span><span class="token punctuation">(</span><span class="token class-name">FailoverCluster</span><span class="token punctuation">.</span>NAME<span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Cluster</span> <span class="token punctuation">{</span>\n    <span class="token annotation punctuation">@Adaptive</span>\n    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token class-name">Directory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> directory<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Cluster 接口中包含另一个与集群相关的重要概念，即前面提到的 Directory。Directory 本质上代表多个 Invoker，我们需要知道可以通过它获取一个有效 Invoker 的列表。</p>\n<p>换一个角度，Dubbo 中的 Cluster 也相当于是一种代理对象，它在 Directory 的基础上向开发人员暴露一个具体的 Invoker，而在暴露这个 Invoker 的过程中，万一发生了异常情况，Cluster 就会自动嵌入集群容错机制。那么，Cluster 是如何做到这一点的呢？</p>\n<p>在 Dubbo 中，实际上提供了一组不同类型的 Cluster 对象，而每一个 Cluster 对象就代表着一种具体的集群容错机制，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-06-11-15-16-4cc43907c09cc2dcfaece887014fa6ae-8afa6.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 29.810901001112345%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABVElEQVQY0z1R207CUBDs/3+JMUYEQa5KqyKXAqUtLb1zRwo8QHiQUGWcHownmXS7u2dmd47UbNxA6+eILAZaDqvVDJYlo9+9h9q+w243R3oulx/x9dwm1M4t+r0MlssxTKMqerV+BoZeguT7KhxHJhQ4IwXb7Rph0MPIfoE1VHA47JEkCXHGOflGFBms1eE6r9hsPhGFXcYyPE/BOFIhTcY6G6rEM2yrhjheIQg6jEvMvVFgw7hIsRwmE5NiBqcqYmhWsV4vSNagcJmowPc+IM1mFvTBExNVgTheirUG2iMbWoIwDFtYzNuYTl3MZ64gNI3yP6GhFwW8lDBdwTTS6WRCoWcxAr/LXI0C7/g6nf48vCLwdZh6WpOFPZ6nctq6sMd125Bsq0KiHFfKc8UCH2XKyRQ2PPC/iONxj+u54HxOhF82a7aVF48ysmuMs7xf4J08fgHiX6YtVoMm0wAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 06 11 15 16" title="" data-src="/static/2024-11-06-11-15-16-4cc43907c09cc2dcfaece887014fa6ae-fee1c.png" data-srcset="/static/2024-11-06-11-15-16-4cc43907c09cc2dcfaece887014fa6ae-a67b7.png 200w,\n/static/2024-11-06-11-15-16-4cc43907c09cc2dcfaece887014fa6ae-0b187.png 400w,\n/static/2024-11-06-11-15-16-4cc43907c09cc2dcfaece887014fa6ae-fee1c.png 800w,\n/static/2024-11-06-11-15-16-4cc43907c09cc2dcfaece887014fa6ae-8afa6.png 899w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>上述方案中，Dubbo 默认使用的是 FailoverCluster。我们来看一下这个默认实现，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24749853858988270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class FailoverCluster implements Cluster {\n    public final static String NAME = &quot;failover&quot;;\n\n    public <T> Invoker<T> join(Directory<T> directory) throws RpcException {\n        return new FailoverClusterInvoker<T>(directory);\n    }\n}`, `24749853858988270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FailoverCluster</span> <span class="token keyword">implements</span> <span class="token class-name">Cluster</span> <span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> NAME <span class="token operator">=</span> <span class="token string">"failover"</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token class-name">Directory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> directory<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FailoverClusterInvoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>directory<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到该类非常简单，join 方法只是根据传入的 Directory 构建一个新的 FailoverClusterInvoker 实例。而查看其他的 Cluster 接口实现，可以发现它们的处理方式与 FailoverCluster 类似，都是返回一个新的 Invoker。</p>\n<h3 id="dubbo-中的集群容错机制"><a href="#dubbo-%E4%B8%AD%E7%9A%84%E9%9B%86%E7%BE%A4%E5%AE%B9%E9%94%99%E6%9C%BA%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dubbo 中的集群容错机制</h3>\n<p>显然，想要理解 Dubbo 中的集群容错机制，重点是要分析上图中所示的各种 ClusterInvoker 对象。</p>\n<p>这里，我们同样选择默认的 FailoverClusterInvoker 作为分析入口。在深入 FailoverClusterInvoker 之前，我们发现该类存在一个基类，即 AbstractClusterInvoker，而 AbstractClusterInvoker 又实现了 Invoker 接口，它们之间的关系如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-06-11-16-27-2c8d08276ffc25d296cc6f9d7dfdebea-960c5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 229px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 145.85152838427945%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAdCAYAAACqhkzFAAAACXBIWXMAAAsSAAALEgHS3X78AAAFRklEQVRIx41VaVdaSRB9f33OTM6ZzGTGD1ld4grKoiwCD0HWxwMSVHZcQBDECIhgjDHREL1zu1/MxDOTmcC5p6qr61V3V9XtVsDf7e2tELi8/ACbdQ6qaoJfXcSan1gzZDBgod1Mu1nKwNoSTKZnaLVa8tubmxuIMMq3AY+PewiFZqnlcHoSwUkvjG4nhP5JGM2GF+dnGoaDGAb9KH2yKBasROHvgPzfC9jpnEBPWHB9lUEhZ0MqaYZ39SlCwUl43I+lFCjk7Xj/Lo3dnVWUS+WvAcUW/xEwGjVR2yFKeHuWxuA0gQ+XGe44jtN+DBfvUpzLE7sM5rgX8PbfAsajZmrbRBmZ14uYm3kA1fsE01M/YX7mFwT845wrEhVUyg6USqXvBzzpncLpeC7zdlD34/BgDa3mGpr1NRw0/MwjxwdCV9E7DmM9OMEd/kfAbrcPr3cS7y+SOOlGeUwBUYQ4jx6XuoCYu7xIMd/z3GHx+zkcDM6wsDCGrcwSC2JCOrmAVykzkvo8dG0Wr9NmaUvpC8huWmFZeoRKpXJ/h0L5Fu12G7VqDfX9OvZr+zzeAcKhMFSfKm0G9rFP1Ot1XF19lIHuvpc7/L+fWKTRaPyIK5Rmq4lCISdzUSoWqefvoVQqIJfLYnNzg/MF5PM5Y07IL3qR9iJltVqFYjI9p8HGY6io7nkofV+knw6r2Ntd5dhr2Go+1Gpe7FHfp6xVKfcNubPtIG2fQFlft+LTdQaLC7+yB6dlK8Rjs0z+PFkxDrv1EYswj1dpE1TPUxZrgTmdkIVLp+bhco7R1ySpuJFxQnG7ZtlrPn48IQOG1sdZWROCHItAAtHwJGKRl3IBLfaSwblAaoH+M9zAuJTDQZwXyBwUi2WCDaui34ujy2btdaLovDHkMeWdfofusTHf7UQkTnox2iJ40w5g1TUOxW6fQq8bxpCcHQ40nA10wtDP3ybJZ13yWDTz8FT7OifGvW7EAAOLW8ivzjCHQSuZkaKzLvMWDU8ju2VDddeDCHVdm5OUu77apPTLhhbH/TzKyQtCcNrALnNqh7Jsn+RqAXSO1+lsYmLNsmLbZTsyr0wswgwr7MLboYbanhO57BLbxYKzobh5dLw7T/AkCXz8oPMinoISDQeZ2BVW1ktuqtB1FQnNC03zkXIqCxCA17MIq2WKYz/nfBKRsJvVJiiFHlp3IBBY/TGm5PJFvM5sQPD/f5kiif35lpz8hKvrEeUI19cGhD4a3aLZamN3t0r9Bh+F353PlQHDz1hNETy12aaYKzeP7eBxnFLGYyvQ4k4e041oxM7j2ZgSl7QlKGNRY/7Ox+mYZm6zUMrlEvlpYeLdpBDfCN7CR0cB9mAQjfqqLFKr6adNXKyCcm5ZNPGA1esefueUerW6gmQyAmVnZ0e+DZsbFiyZfuNV/0A+SM7lMVgXH8Jifgjr0h+wLP6O+dkHkqLLtj8R9L+AzfKI/j9jxTom+ZzJ6CLgNo80hYvzJFsnzBYSjUp29KJ8PmMS3Y7BjL68rSNfm7pPH8GUs6GO3NYSUxKFsr1TIQdfkD4h2bhHh0EckUaHfEvazQDah9Rbxlsi5oUubC3ONeo+NHjbHLWDbOo55jZi7DDPd3b0aUu+GzJQK2Dshjs4aq9LKWh4+T4t7WJ+QBp+HmVZ5Q35CraaKtJpjTvcrvDOc8v3VkjV+5j0e8kj2JCIz8DneYxEbJqBIjhnWnRtGgH1ORcOfKGeeKSq6PfDDBiHUq3uweV6xmAqaeWQKBbchAv5nIOt4MTW5jL57eDYKW0GDF34V8oeso2tl9LwFxq/4fxGUFpdAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 06 11 16 27" title="" data-src="/static/2024-11-06-11-16-27-2c8d08276ffc25d296cc6f9d7dfdebea-960c5.png" data-srcset="/static/2024-11-06-11-16-27-2c8d08276ffc25d296cc6f9d7dfdebea-6f066.png 200w,\n/static/2024-11-06-11-16-27-2c8d08276ffc25d296cc6f9d7dfdebea-960c5.png 229w" data-sizes="(max-width: 229px) 100vw, 229px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>从设计模式角度讲，AbstractClusterInvoker 采用的是很典型的模板方法设计模式。模板方法设计模式的一般实现过程就是为整个操作流程提供一种框架代码，然后再提取抽象方法供子类进行实现。上图中就展示了模板方法的设计思想。</p>\n<p>AbstractClusterInvoker 的实现逻辑也是类似，它的主要步骤包括从 Directory 获得 Invoker 列表、基于 LoadBalance 实现负载均衡，并基于 doInvoke 方法完成在远程调用中嵌入容错机制。</p>\n<p>这里的 doInvoke 就是模板方法，需要 FailoverClusterInvoker 等子类分别实现，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25842773623673156000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public abstract class AbstractClusterInvoker<T> implements ClusterInvoker<T> {\n    protected abstract Result doInvoke(Invocation invocation, List<Invoker<T>> invokers,  LoadBalance loadbalance) throws RpcException;\n}`, `25842773623673156000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractClusterInvoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">ClusterInvoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>\n    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">Result</span> <span class="token function">doInvoke</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span><span class="token punctuation">></span></span> invokers<span class="token punctuation">,</span>  <span class="token class-name">LoadBalance</span> loadbalance<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>AbstractClusterInvoker 类的代码有点长，但理解起来并不是很复杂。通过观察该类中的代码实现，可以看到存在一批以 select 结尾的方法，包括 select、doselect、reselect 以及 LoadBalance 本身的 select 方法。我们基于这些 select 方法梳理整体的处理流程，并给出如下所示的伪代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67059592335255265000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`select() {\n   checkSticky(); // 粘滞连接\n\n   doselect() {\n      loadbalance.select();\n\n      reselect() {\n         loadbalance.select();\n      }\n   }\n}`, `67059592335255265000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token function">checkSticky</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 粘滞连接</span>\n\n   <span class="token function">doselect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      loadbalance<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token function">reselect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         loadbalance<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上述伪代码清晰展示了这些 select 方法的嵌套过程，从而能够更好地帮助你梳理代码执行流程。</p>\n<p>首先，select 方法的第一部分内容提供了 <code class="language-text">粘滞连接</code> 机制。所谓粘滞连接（Sticky Connection），就是为每一次请求维护一个状态，确保始终由同一个服务提供者对来自同一客户端的请求进行响应。这点和我们在上一讲中提到的源 IP 哈希负载均衡算法比较类似，你可以做一些回顾。在 Dubbo 中，使用粘滞连接的目的是减少重复创建连接的成本，提高远程调用的效率。我们可以通过 URL 传入的 sticky 参数对该行为进行控制。</p>\n<p>处理完粘滞连接之后，select 方法就借助于 doselect 方法执行下一步操作。doselect 方法执行了一系列的判断来最终明确目标 Invoker 对象。首先，我们需要判断当前是否存在可用的 Invoker 对象，如果没有则直接返回。如果有，那么就分如下几种情况：</p>\n<ul>\n<li>如果只有一个 Invoker 对象，那么该 Invoker 对象就是目标 Invoker 对象；</li>\n<li>如果有两个 Invoker 对象，则使用轮询机制选择其中一个进行返回；</li>\n<li>如果有两个以上的 Invoker 对象，这时候就会借助于 LoadBalance 的 select 方法，通过负载均衡算法来最终确定一个目标 Invoker 对象。</li>\n</ul>\n<p>下图展示了这个执行过程：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-06-11-18-19-da847399d231ab5a15cef86a603cf718-a40ca.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 647px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 24.884080370942815%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAABHklEQVQY012Q206DQBRF+f9PURoVitSYiEafpJQOtAVKuV+qvaS3WGn6sN3ig8ZJVs5kMueclS3hz2maIwK/B9/TWHWYrzJc5xphaMDz+oiiO9iDqxbXUTAeqXCEgr4p895FVT1BapoPnM+fOJ2O2O93iKMxGWGxyDCvY9TVDMtlie12jbqeIc8DFKQspr+UIYeFeH+LIYmhQpMLblAwtF9o8Uije27uwrYU2upc8Azft+BNbkkPk7GOkavx/QFpYrBPZb+GNDUgHQ57rNcr7HZbssE0cDlEIMumSJIAOet8nmGzWdEubN+z9IeimLUkic9hAS0jSP8zFOKGBkprbJmXEMMO7z1maNJebzN1xHeOcvvPHnRg9WWaq4zHwBc4i2IMdWVp9gAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 06 11 18 19" title="" data-src="/static/2024-11-06-11-18-19-da847399d231ab5a15cef86a603cf718-a40ca.png" data-srcset="/static/2024-11-06-11-18-19-da847399d231ab5a15cef86a603cf718-3426a.png 200w,\n/static/2024-11-06-11-18-19-da847399d231ab5a15cef86a603cf718-f3a4f.png 400w,\n/static/2024-11-06-11-18-19-da847399d231ab5a15cef86a603cf718-a40ca.png 647w" data-sizes="(max-width: 647px) 100vw, 647px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在获取了目标 Invoker 对象之后，Dubbo 并不会直接就使用这个对象，因为我们需要考虑该对象的可用性。如果该 Invoker 对象不可用或者已经使用过，那么就需要通过 reselect 方法重新进行选择。而如果在 Invoker 列表中已经没有可用的 Invoker 对象了，那么也就只能直接使用当前选中的这个 Invoker 对象。下图进一步展示了 Invoker 对象的可用性判断逻辑：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-06-11-18-55-9e26dc5bd030d8ea83e627c27f79d33f-ab2ac.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 531px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 50.470809792843696%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABuklEQVQoz3VSa1PaUBDN//8dnSl8aKuOtVUpUqe1owQNCPLKq3QgNBRTY96v08MFRDN2Mzs3e3fvuWfPXgm0oiiwtTjOcNf7AuWmgpZcRfPqDXrdBp7brr5A2aQ8z1mQI0kSBIEv1tlsKEAMXUanU8d0OhIgnucxH4v69bkCZULS9idNcziOiyhKEYYZsmy9z3MijqIEi8WSl8b/YbsB1PU2dK2J8bgJTZXZ6hkUpY7J5FYUz+caWZ6x9RMYxjVZt2AaLZ5p8SL/CXTrUvd2D/27KrqdKtTRB8ytE9jzY5j6Z8FMU79i0K9AHe+j066grbzF9NcRZtNP+OvYmy7yHWCve0rAQxhaDc79JRb2Bf4svhOgQRkKqOolRsOPBDjHeHQMufmO8RFMsw7XvS+NhICrIcRRTDYRRffh+4FYoyjeaJuJXBCE3IuQZimWS0foHYYJbHsJy/pNcI8vJN0N5TUrC75tz7I0at3gS7jAYHCFId00FEx+9iE9F7TsLwRfjZvmOA9s95SSvOdgDihRDe7DOTNtWLPGimGx+XYPdR0Vr7L1vIBsvqHfOyRgDYF/g0dXRhhcc1g/8A/BBPL6l8QrXAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 06 11 18 55" title="" data-src="/static/2024-11-06-11-18-55-9e26dc5bd030d8ea83e627c27f79d33f-ab2ac.png" data-srcset="/static/2024-11-06-11-18-55-9e26dc5bd030d8ea83e627c27f79d33f-a8ddc.png 200w,\n/static/2024-11-06-11-18-55-9e26dc5bd030d8ea83e627c27f79d33f-0d4eb.png 400w,\n/static/2024-11-06-11-18-55-9e26dc5bd030d8ea83e627c27f79d33f-ab2ac.png 531w" data-sizes="(max-width: 531px) 100vw, 531px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>至于 reselect 方法，它的主要实现过程同样也是借助于 LoadBalance 的 select 方法完成对 Invoker 的重新选择。Dubbo 会使用一个标志位对传递给 LoadBalance 的 Invoker 对象的可用性进行过滤，然后将过滤之后且未被选择的 Invoker 对象列表交给 LoadBalance 执行负载均衡。</p>\n<p>以上几个方法中，只有 select 方法的修饰符是 protected 的，可以被 AbstractClusterInvoker 的各个子类根据需要进行直接调用。显然，因为 AbstractClusterInvoker 提供了模板方法，因此它的子类势必是在 doInvoke 方法中调用这些 select 方法。</p>\n<p>我们来看一下 FailoverClusterInvoker 的 doInvoke 方法，这个方法的执行逻辑同样不是很复杂。Failover 的意思很简单，就是失败重试，所以可以想象 doInvoke 方法中应该包括一个重试的循环操作。通过翻阅代码，我们确实发现了这样一个 for 循环，裁剪后的代码结构如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60471852831619375000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for (int i = 0; i < len; i++) {\n      // 由于 Invoker 对象列表可能已经发生变化，所以在执行重试操作前需要进行重新选择\n      if (i > 0) {\n            // 验证当前 Invoker 对象是否可用\n            checkWhetherDestroyed();\n            // 重新获取所有服务提供者\n            copyinvokers = list(invocation);\n            // 重新检查这些 Invoker 对象\n            checkInvokers(copyinvokers, invocation);\n       }\n\n       // 通过父类的 select 方法获取 invoker\n       Invoker<T> invoker = select(loadbalance, invocation, copyinvokers, invoked);\n       // …\n       try {\n            // 发起远程调用\n            Result result = invoker.invoke(invocation);\n            return result;\n       } catch (RpcException e) {\n             // 如果是业务异常，直接抛出\n }\n // …\n}\n\n// 如果 for 循环执行完毕还是没有找到一个合适的 invoker，则直接抛出异常\nthrow new RpcException();`, `60471852831619375000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 由于 Invoker 对象列表可能已经发生变化，所以在执行重试操作前需要进行重新选择</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 验证当前 Invoker 对象是否可用</span>\n            <span class="token function">checkWhetherDestroyed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">// 重新获取所有服务提供者</span>\n            copyinvokers <span class="token operator">=</span> <span class="token function">list</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">// 重新检查这些 Invoker 对象</span>\n            <span class="token function">checkInvokers</span><span class="token punctuation">(</span>copyinvokers<span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n       <span class="token punctuation">}</span>\n\n       <span class="token comment">// 通过父类的 select 方法获取 invoker</span>\n       <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> invoker <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>loadbalance<span class="token punctuation">,</span> invocation<span class="token punctuation">,</span> copyinvokers<span class="token punctuation">,</span> invoked<span class="token punctuation">)</span><span class="token punctuation">;</span>\n       <span class="token comment">// …</span>\n       <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 发起远程调用</span>\n            <span class="token class-name">Result</span> result <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">return</span> result<span class="token punctuation">;</span>\n       <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RpcException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n             <span class="token comment">// 如果是业务异常，直接抛出</span>\n <span class="token punctuation">}</span>\n <span class="token comment">// …</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 如果 for 循环执行完毕还是没有找到一个合适的 invoker，则直接抛出异常</span>\n<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RpcException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上述代码中的循环次数来自于 URL 传入的重试次数，默认重试次数是 2。在重试之前，由于 Invoker 对象列表可能已经发生变化，所以需要对当前 Invoker 对象是否可用进行验证，并根据需要进行重新选择。注意到在每一次循环中，我们首先调用父类 AbstractClusterInvoker 中的 select 方法，并将该方法返回的 Invoker 对象保存到一个 invoked 集合中，表示该 Invoker 对象已经被选择和使用。</p>\n<p>一旦确定了目标 Invoker 对象，我们就可以通过该对象所提供的 invoke 方法执行远程调用。调用过程可能成功、也可能失败，而失败的结果也分两种情况，如果是业务失败则直接抛出异常，反之我们就继续执行循环。如果整个循环都结束了还是没有成功地完成调用过程，那么最终也会抛出异常。</p>\n<p>至此，基于 FailoverClusterInvoker 的集群容错机制讲解完毕。Dubbo 中的其他集群容错实现方案交由你自行进行理解和分析。</p>\n<h2 id="解题要点-9"><a href="#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解题要点</h2>\n<p>服务容错在当下的分布式系统开发过程中已经属于是一种标准组件，所以在面试过程中也经常出现。关于服务容错的概念和实现策略，需要面试者具备针对性的知识体系。</p>\n<p>从解决思路上讲，回答这类问题可以分成两个阶段。</p>\n<p>第一个阶段是先解释什么是服务容错。我们需要明确由于存在服务自身失败以及网络瞬态等因素，为了确保服务访问过程的可靠性，服务容错是必不可少的。然后重点是要提到服务的雪崩效应，即在分布式环境下，由于服务依赖失败导致整个服务访问链路不可用。那么雪崩效应究竟是怎么形成的呢？就是因为服务没有做到容错而导致的。</p>\n<p>第二阶段，我们需要进一步掌握服务容错实现层面的知识点。对于开发人员而言，相对于原理部分的内容，具体的实现过程反而更加容易把握，多少都能回答一些。但这道题想要回答得有体系化有一定难度，能够体现出不同面试者之间的水平差异。针对集群容错的实现，包括 Failover（失效转移）、Failback（失败通知）、Failsafe（失败安全）和 Failfast（快速失败）等多种实现策略。这些策略本身都并不是很复杂，也没有太多的难点，唯一需要注意的地方在于知识点比较细而多。回答过程中需要按照一定的逻辑进行展开，避免概念之间产生混淆。</p>\n<h2 id="小结与预告-7"><a href="#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结与预告</h2>\n<p>本讲内容对集群容错的设计思想和实现策略进行了详细的展开。集群容错的实现策略有很多，我们基于 Dubbo 给出了该框架中内置的几种实现方案的底层原理。</p>\n<p>请注意，集群容错只是服务容错的其中一种实现方式。主流的实现方式还包括服务熔断。服务熔断的实现需要引入熔断器的概念。那么，什么是熔断器？它又是如何实现服务容错的呢？在下一讲中，我们将基于 Spring Cloud 框架讨论熔断器的实现过程。</p>\n<h1 id="服务容错：熔断器的基本结构是怎么样的？如何实现？"><a href="#%E6%9C%8D%E5%8A%A1%E5%AE%B9%E9%94%99%EF%BC%9A%E7%86%94%E6%96%AD%E5%99%A8%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84%E6%98%AF%E6%80%8E%E4%B9%88%E6%A0%B7%E7%9A%84%EF%BC%9F%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务容错：熔断器的基本结构是怎么样的？如何实现？</h1>\n<p>在上一讲中，我们详细介绍了集群容错的概念以及实施策略。通过构建集群机制来实现服务容错是分布式服务构建过程中的一种常见技术手段，但并不是唯一的技术手段。围绕服务容错，还存在一个面试过程中经常会出现的话题，这就是本讲内容要介绍的服务熔断。</p>\n<p>服务熔断的具体表现形式是熔断器。那么，熔断器的基本结构是怎么样的？它又是如何实现的呢？本讲内容将围绕这一问题展开讨论。</p>\n<h2 id="问题背景-7"><a href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题背景</h2>\n<p>除了上一讲介绍的集群容错，熔断（Circuit Breaker）也是很实用的一种容错机制。在日常开发过程中，如果你使用的是像 Spring Cloud 这样的主流分布式服务框架，那么系统所产生的每一次远程调用的背后都内置了熔断机制，只是你自己可能并没有注意到，或者甚至都没有认识到有这样一个概念。</p>\n<p>正是因为服务熔断的实现是一个自动化的过程，而使用方式上也不需要开发人员有太多参与，所以熔断机制往往是一个面试过程中经常被考查的问题。一方面在于熔断机制非常重要，另一方面也可以通过这个问题很好地区分候选人的知识广度和深度。 我作为面试官，经常会对候选人提出这个问题，而得到的回答往往不尽如人意。</p>\n<p>从面试角度讲，关于熔断机制有很多种具体的问法，面试官往往会采用这样的方式来考查候选人：</p>\n<ul>\n<li>熔断器的状态有哪些？相互之间是如何转换的？</li>\n<li>在系统运行时，如何有效地收集和统计运行时数据？</li>\n<li>你使用过的熔断器有哪些？它的基本原理是怎么样的？</li>\n<li>如果让你来设计并实现一个简单的熔断机制，你会怎么做？</li>\n</ul>\n<p>上述问题虽然各有侧重点，但对于熔断机制而言，考查的重点还是候选人在工程实践的基础上所掌握的技术原理。</p>\n<h2 id="问题分析-8"><a href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题分析</h2>\n<p>熔断这个概念实际上并不难理解，类似于日常生活中经常会碰到的电路自动切断机制。我们知道在电路系统中，当电流过大时保险丝就会被融化从而隔断了整个电路回路。类比分布式服务，当系统产生大量异常时，我们也应该隔断整个服务调用链路，避免服务的不断重试触发雪崩效应。</p>\n<p>那么服务熔断是如何做到的呢？我们需要明确，对于服务消费者发起的每一次远程调用请求，熔断器都需要进行监控和记录。如果调用的响应时间过长，服务熔断器就应该中断本次调用并直接返回。请注意服务熔断器判断本次调用是否应该快速失败是有状态的，也就是说它会对一段时间的调用结果进行统计，如果统计的结果触发了事先设置好的阈值（类似电路系统中保险丝的过载等级），那么服务熔断机制就会被触发，反之将继续执行后续的远程调用。</p>\n<p>通过上述分析，我们可以梳理出如下技术上的要点。</p>\n<ul>\n<li>状态性：通过合理的状态切换来控制是否对请求进行熔断。</li>\n<li>运行时数据：收集服务运行时数据并进行统计分析，为阈值判断提供依据。</li>\n<li>阈值控制：各个状态切换的控制开关。</li>\n</ul>\n<p>通过对上述要点的分析，这道题的回答思路就有了，而回答好这道题的关键就是要对上述要点背后的技术原理进行系统的阐述。接下来，让我们来对具体的技术体系展开讨论。</p>\n<h2 id="技术体系-10"><a href="#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-10" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术体系</h2>\n<p>基于熔断器的设计理念，我们对熔断过程进行进行抽象和提炼，可以得到如下图所示的熔断器基本结构。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-08-10-28-55-e85bc7a48ba2758e768acf8ee737382f-4b0e9.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 571px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 55.86690017513135%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAAB9ElEQVQoz21Ta1PaQBTN//8L7Tdn2umM2lZth8ERQhVU5KH4gAKRxCxJIBFJSMIjj9O7q8TCeGfu7Ca55+y5524kUKRpupE8fH+G+7scun9zOC19Qb22D6WfQ6d9hjUGoh4bOGmbMEkS8WE2c9G6+Q6ld4CL8x006t/Q7/0gQhkficgI15vtCAIPupaHpv4C03MI/AoW8zIs8wrJm6rt4O+EwjiOYVkWTNPEaDQSH1erJVqtIrVdwGBwiZF1A027QL/fzAh4PcdxDOf4r+UEjOkEfCSQiihawXVdeJ6P5TKi55TWGItFRFYE9N4V1pimQfUaFEXJrJLm8xUNYI4wXIi0LBu2/Zyd+FFEUSRqhkOLyAOB4yvnkvSnKvlSRa8rk+klKqpQvrfleZ5oyXEcoXodQ3ZN3p4SRiafy3iZNOm5BqlR38X97S7k4mfIhU9oP+zhunmA6dSlk0PhEWMMhmEI4jB8VXLb+k1C8ni420ej9pX2x+T3EaRO+xCPyiEp/AnHLsJ9KdF9yxPROPNlu13HmUAdFGGPj2GwPJxxAdOJTKR/IHW7Z+h0TkjZCUyjStO8pOFc0bUJRbu+zwezFMn3PB3nme5jGfpThYjLIpl+DlWtvk55HXHCr1D6/idQ8Lb5JHVdp0OCDbW8geQNE0WJWP8BNoc6m+1TqdMAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 08 10 28 55" title="" data-src="/static/2024-11-08-10-28-55-e85bc7a48ba2758e768acf8ee737382f-4b0e9.png" data-srcset="/static/2024-11-08-10-28-55-e85bc7a48ba2758e768acf8ee737382f-b8aee.png 200w,\n/static/2024-11-08-10-28-55-e85bc7a48ba2758e768acf8ee737382f-fe23d.png 400w,\n/static/2024-11-08-10-28-55-e85bc7a48ba2758e768acf8ee737382f-4b0e9.png 571w" data-sizes="(max-width: 571px) 100vw, 571px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可以看到，上图所展示的结构简明扼要地给出了熔断器内部所具备的状态机，该状态机包含三个状态，即 Closed（关闭）、Open（打开）和 Half-Open（半开）。</p>\n<ul>\n<li>Closed: 这是熔断器的默认状态。在该状态下，相当于熔断器没有发挥任何效果，所有的请求可以得到正常的响应。但是，在熔断器内部还是会对所有的调用过程进行监控，如果有异常发生则会进行不断累加。</li>\n<li>Open: 这是熔断器的打开状态。在该状态下，相当于熔断器对所有的请求进行了隔断，来自服务消费者的请求不会触达到服务的提供者。同时，在熔断器内部也会启动一个计时器，当处于该状态达到一定时间时，熔断器会进入到半开状态。</li>\n<li>Half-Open: 这是熔断器的半开状态。所谓半开，指的是熔断器会允许一部分请求通过，然后再对这些请求的响应结果进行统计。如果这些请求的成功比例达到一定的阈值，则会把熔断器设回到关闭状态，反之则进入打开状态。</li>\n</ul>\n<p>关于熔断器的组成和状态我们已经明确了，但显然还有很多细节是缺失的。如果你只是用这些内容来回答面试问题，应该可以拿到 60 分，但剩下的 40 分才是更好地拉开你和其他候选人之间差距的关键。为了让你更好地理解熔断器的实现原理，接下来，我们讨论如何自己实现一个包含这三个状态的熔断器。</p>\n<p>首先，我们需要定义一个枚举类 State，代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71317865306996000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public enum State {\n   CLOSED,\n   OPEN,\n   HALF_OPEN\n}`, `71317865306996000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">State</span> <span class="token punctuation">{</span>\n   CLOSED<span class="token punctuation">,</span>\n   OPEN<span class="token punctuation">,</span>\n   HALF_OPEN\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后，我们定义代表熔断器的 CircuitBreaker 接口，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69287162045361870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface CircuitBreaker {\n   // 成功的响应，会对熔断器状态进行重置\n   void recordSuccess();\n   // 失败的响应，根据需要对状态进行设置\n   void recordFailure(String response);\n   // 获取熔断器的当前状态\n   String getState();\n   // 设置熔断器状态\n   void setState(State state);\n   // 对远程服务发起请求\n   String attemptRequest() throws RemoteServiceException;\n}`, `69287162045361870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CircuitBreaker</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 成功的响应，会对熔断器状态进行重置</span>\n   <span class="token keyword">void</span> <span class="token function">recordSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 失败的响应，根据需要对状态进行设置</span>\n   <span class="token keyword">void</span> <span class="token function">recordFailure</span><span class="token punctuation">(</span><span class="token class-name">String</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 获取熔断器的当前状态</span>\n   <span class="token class-name">String</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 设置熔断器状态</span>\n   <span class="token keyword">void</span> <span class="token function">setState</span><span class="token punctuation">(</span><span class="token class-name">State</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 对远程服务发起请求</span>\n   <span class="token class-name">String</span> <span class="token function">attemptRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteServiceException</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对于 CircuitBreaker 接口的实现过程是我们讨论的重点。为了实现对熔断器状态的合理控制，我们首先需要定义一系列的中间变量，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88038777702460670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 远程调用的超时时间\nprivate final long timeout;\n// 重试时间间隔\nprivate final long retryTimePeriod;\n// 最近一次的调用失败时间\nlong lastFailureTime;\n// 最近一次的失败响应结果\nprivate String lastFailureResponse;\n// 累计失败次数\nint failureCount;\n// 失败率阈值\nprivate final int failureThreshold;\n// 熔断器状态\nprivate State state;\n// 类似无限大的一个未来时间\nprivate final long futureTime = 1000000000000;`, `88038777702460670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token comment">// 远程调用的超时时间</span>\n<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timeout<span class="token punctuation">;</span>\n<span class="token comment">// 重试时间间隔</span>\n<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> retryTimePeriod<span class="token punctuation">;</span>\n<span class="token comment">// 最近一次的调用失败时间</span>\n<span class="token keyword">long</span> lastFailureTime<span class="token punctuation">;</span>\n<span class="token comment">// 最近一次的失败响应结果</span>\n<span class="token keyword">private</span> <span class="token class-name">String</span> lastFailureResponse<span class="token punctuation">;</span>\n<span class="token comment">// 累计失败次数</span>\n<span class="token keyword">int</span> failureCount<span class="token punctuation">;</span>\n<span class="token comment">// 失败率阈值</span>\n<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> failureThreshold<span class="token punctuation">;</span>\n<span class="token comment">// 熔断器状态</span>\n<span class="token keyword">private</span> <span class="token class-name">State</span> state<span class="token punctuation">;</span>\n<span class="token comment">// 类似无限大的一个未来时间</span>\n<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> futureTime <span class="token operator">=</span> <span class="token number">1000000000000</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当我们发起一个远程调用时，我们需要基于调用结果合理设置熔断器的状态，代码如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5211924038462623000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public String attemptRequest() throws RemoteServiceException {\n    evaluateState();\n    if (state == State.OPEN) {\n      // 如果熔断式处于打开状态，就直接返回失败结果\n      return this.lastFailureResponse;\n    } else {\n       try {\n        // 执行远程调用\n        var response = service.call();\n        // 远程调用成功\n        recordSuccess();\n        return response;\n      } catch (RemoteServiceException ex) {\n        // 远程调用失败\n        recordFailure(ex.getMessage());\n        throw ex;\n      }\n    }\n}`, `5211924038462623000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">attemptRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteServiceException</span> <span class="token punctuation">{</span>\n    <span class="token function">evaluateState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token class-name">State</span><span class="token punctuation">.</span>OPEN<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 如果熔断式处于打开状态，就直接返回失败结果</span>\n      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastFailureResponse<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n       <span class="token keyword">try</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 执行远程调用</span>\n        <span class="token keyword">var</span> response <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// 远程调用成功</span>\n        <span class="token function">recordSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> response<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteServiceException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 远程调用失败</span>\n        <span class="token function">recordFailure</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们继续来实现当调用成功和失败时，对应的 recordSuccess 和 recordFailure 方法的执行逻辑，代码如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30812050657269420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 调用成功，失败次数清零，最近失败时间设置成无限大，并把熔断器状态设置成关闭\npublic void recordSuccess() {\n    this.failureCount = 0;\n    this.lastFailureTime = System.nanoTime() + futureTime;\n    this.state = State.CLOSED;\n}\n\n// 调用失败，失败次数加 1，最近失败时间设置成当前时间，并把失败结果设置成最近一次调用失败的响应\npublic void recordFailure(String response) {\n    failureCount = failureCount + 1;\n    this.lastFailureTime = System.nanoTime();\n    this.lastFailureResponse = response;\n}`, `30812050657269420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token comment">// 调用成功，失败次数清零，最近失败时间设置成无限大，并把熔断器状态设置成关闭</span>\n<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recordSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>failureCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>lastFailureTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> futureTime<span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token class-name">State</span><span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 调用失败，失败次数加 1，最近失败时间设置成当前时间，并把失败结果设置成最近一次调用失败的响应</span>\n<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recordFailure</span><span class="token punctuation">(</span><span class="token class-name">String</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    failureCount <span class="token operator">=</span> failureCount <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>lastFailureTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>lastFailureResponse <span class="token operator">=</span> response<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当系统运行一段时间之后，我们如何来获取熔断器的当前状态呢？可以实现如下所示的 getState 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54049412732521350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public String getState() {\n    // 如果失败次数大于阈值\n    if (failureCount >= failureThreshold) {\n      if ((System.nanoTime() - lastFailureTime) > retryTimePeriod) {\n        // 如果失败的累计时间已经超过了所允许的重试时间间隔，状态即为半熔断（相当于此时已经过了重试时间，需要打开半开状态）\n        state = State.HALF_OPEN;\n      } else {\n        // 反之，熔断器应该为开启状态\n        state = State.OPEN;\n      }\n    } else {\n      // 熔断器为打开状态\n      state = State.CLOSED;\n    }\n    return state.name();\n}`, `54049412732521350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 如果失败次数大于阈值</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>failureCount <span class="token operator">>=</span> failureThreshold<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> lastFailureTime<span class="token punctuation">)</span> <span class="token operator">></span> retryTimePeriod<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 如果失败的累计时间已经超过了所允许的重试时间间隔，状态即为半熔断（相当于此时已经过了重试时间，需要打开半开状态）</span>\n        state <span class="token operator">=</span> <span class="token class-name">State</span><span class="token punctuation">.</span>HALF_OPEN<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 反之，熔断器应该为开启状态</span>\n        state <span class="token operator">=</span> <span class="token class-name">State</span><span class="token punctuation">.</span>OPEN<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 熔断器为打开状态</span>\n      state <span class="token operator">=</span> <span class="token class-name">State</span><span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">return</span> state<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对应的，如果我们想要直接对熔断器状态进行设置，可以使用如下所示的 setState 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29181147565931000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public void setState(State state) {\n    this.state = state;\n    switch (state) {\n      case OPEN: // 设置开启状态\n        this.failureCount = failureThreshold;\n        this.lastFailureTime = System.nanoTime();\n        break;\n      case HALF_OPEN: // 设置半开状态\n        this.failureCount = failureThreshold;\n        this.lastFailureTime = System.nanoTime() - retryTimePeriod;\n        break;\n      default: // 默认为关闭状态\n        this.failureCount = 0;\n    }\n}`, `29181147565931000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setState</span><span class="token punctuation">(</span><span class="token class-name">State</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span>\n    <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">case</span> OPEN<span class="token operator">:</span> <span class="token comment">// 设置开启状态</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>failureCount <span class="token operator">=</span> failureThreshold<span class="token punctuation">;</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>lastFailureTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token keyword">case</span> HALF_OPEN<span class="token operator">:</span> <span class="token comment">// 设置半开状态</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>failureCount <span class="token operator">=</span> failureThreshold<span class="token punctuation">;</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>lastFailureTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> retryTimePeriod<span class="token punctuation">;</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">// 默认为关闭状态</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>failureCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，这里我们也只是通过对熔断器的几个核心变量设置合适的值来更新熔断器的最新状态。</p>\n<p>以上代码示例可以帮助你更好地理解一个熔断器的内部实现原理，也可以帮助你回答类似“如果让你来实现一个简单的熔断机制，你会怎么做？”这种开放式问题。但是，这个毕竟只是一个示例。要想完整理解熔断器的实现过程，还是需要我们来对主流分布式服务框架中的原理展开解析。</p>\n<h2 id="源码解析-8"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h2>\n<p>在 Spring Cloud 中，专门为开发人员提供了具备服务熔断功能的 Spring Cloud Circuit Breaker 组件。从命名上看，Spring Cloud Circuit Breaker 是对熔断器的一种抽象，支持不同的熔断器实现方案。在 Spring Cloud Circuit Breaker 中，内置了四种熔断器，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-08-11-09-46-3e59fa0318752c16d4262fbebc485074-0e173.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 646px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.76160990712074%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAACJklEQVQoz3WSi07iYBSE+/7vsK4xa1RkRa0irCAqIJQKAoVyr+V+kchNKLAL3/6t0cRkd5pJ27SZ/5yZkTbbDV+42WCjVstRLJxTKnpREy4SyhHZjIfUo5ts+hSjdoWW9fP2tnD+3263DiX+g1o1y8vglmYjyE1wF1U5Jq/JRML7QvicyTguRMMsFutPQRtSo9PA7JrUew1qLYNWr+18WK/XmGZdCNwRDgepVnWKxSzlco5SSUPTUuI9R7NpMJtNP0WlA9WFq3DCkfYTue3jInfFYrbgdfTKdPqGrvtZWg+USx6x6iFF/aewwuYJ0/E9o9cA+VzUEbTtkk71C06qMm79lNAsylX5mn6nz3JpYRgm8fgvWi2VTPqG8L2MovhQ4u+sVGJi4giNhvFpleTJy1w0fbgLZ9zNH7gs+Om2OgxeBoxGI8f0StUQkz5QNx+FtwrViiLuCRGYECzFeDYSYuIIY7GV5MmdI9d9eMoyN5MwvtI1rXqTdqdNt9tlPB6jqrbAGZvfCWaTex4TeyixXZH4DyajW1bLGL2OX/j5jHSYcrOfc7ET3+Og6Oay6H83WFyWZTGfzxkOhxT0DNFoSIQUEp49OaFoWpJ8/slhJpOk1+sjJUspUmaap+c0ai1Jtqp9qcEHVqs/ooteMbVdpVuxrk+sGhAHeZ3n4UuMQT/y7x5+lPSDNixrhZ4P0WkHSarHBAM7IqQ90dHvBK6/USl7xQF+/gLv18pc1TAXFAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 08 11 09 46" title="" data-src="/static/2024-11-08-11-09-46-3e59fa0318752c16d4262fbebc485074-0e173.png" data-srcset="/static/2024-11-08-11-09-46-3e59fa0318752c16d4262fbebc485074-2fb9f.png 200w,\n/static/2024-11-08-11-09-46-3e59fa0318752c16d4262fbebc485074-f1e72.png 400w,\n/static/2024-11-08-11-09-46-3e59fa0318752c16d4262fbebc485074-0e173.png 646w" data-sizes="(max-width: 646px) 100vw, 646px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>上图中的 Netflix Hystrix 显然来自于 Netflix OSS，Resilience4j 是受 Hystrix 项目启发所诞生的一款新型的容错库，Sentinel 从定位上讲是一款包含了熔断降级功能的高可用流量防护组件，而最后的 Spring Retry 是 Spring 自研的重试和熔断框架。针对以上四种熔断器，Spring Cloud Circuit Breaker 提供了统一的 API。</p>\n<h3 id="spring-cloud-circuit-breaker-组成结构"><a href="#spring-cloud-circuit-breaker-%E7%BB%84%E6%88%90%E7%BB%93%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Spring Cloud Circuit Breaker 组成结构</h3>\n<p>为了在应用程序中创建一个熔断器，我们可以使用 Spring Cloud Circuit Breaker 中的工厂类 CircuitBreakerFactory，该工厂类的定义如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76844507895881650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public abstract class CircuitBreakerFactory<CONF, CONFB extends ConfigBuilder<CONF>> extends AbstractCircuitBreakerFactory<CONF, CONFB> {\n   public abstract CircuitBreaker create(String id);\n}`, `76844507895881650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">CircuitBreakerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span>CONF<span class="token punctuation">,</span> CONFB <span class="token keyword">extends</span> <span class="token class-name">ConfigBuilder</span><span class="token punctuation">&lt;</span>CONF<span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractCircuitBreakerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span>CONF<span class="token punctuation">,</span> CONFB<span class="token punctuation">></span></span> <span class="token punctuation">{</span>\n   <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">CircuitBreaker</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>可以看到这是一个抽象类，只有一个 create 方法用来创建 CircuitBreaker。CircuitBreaker 是一个接口，约定了熔断器应该具有的功能，该接口定义如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44138883958575060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface CircuitBreaker {\n   default <T> T run(Supplier<T> toRun) {\n      return run(toRun, throwable -> {\n         throw new NoFallbackAvailableException(&quot;No fallback available.&quot;, throwable);\n      });\n   };\n\n   <T> T run(Supplier<T> toRun, Function<Throwable, T> fallback);\n}`, `44138883958575060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CircuitBreaker</span> <span class="token punctuation">{</span>\n   <span class="token keyword">default</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> toRun<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token function">run</span><span class="token punctuation">(</span>toRun<span class="token punctuation">,</span> throwable <span class="token operator">-></span> <span class="token punctuation">{</span>\n         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoFallbackAvailableException</span><span class="token punctuation">(</span><span class="token string">"No fallback available."</span><span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n   <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> toRun<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Throwable</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">></span></span> fallback<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里用到了函数式编程的一些语法，但我们从方法定义上还是可以明显看出包含了 run 和 fallback 这两个方法。其中的 Supplier 包含了你希望运行在熔断器中的业务代码，而 Function 则代表着回退（Fallback）方法。如果你熟悉 Netflix Hystrix 中的 HystrixCommand，你会发现两者之间存在明显的对应关系。</p>\n<p>在 Spring Cloud Circuit Breaker 中，分别针对 Hystrix、Resilience4j、Sentinel 和 Spring Retry 这四款框架提供了 CircuitBreakerFactory 抽象类的子类。一旦在代码工程的类路径中添加了相关的 starter，系统就会自动创建 CircuitBreaker。也就是说 CircuitBreakerFactory.create 方法会实例化对应框架的一个 CircuitBreaker 实例。</p>\n<p>在引入具体的开发框架之后，下一步工作就是对它们进行配置。在 CircuitBreakerFactory 的父类 AbstractCircuitBreakerFactory 中，我们发现了如下所示的两个抽象方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72696124534971515000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 针对某一个 id 创建配置构造器\nprotected abstract CONFB configBuilder(String id);\n\n// 为熔断器配置默认属性\npublic abstract void configureDefault(Function<String, CONF> defaultConfiguration);`, `72696124534971515000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token comment">// 针对某一个 id 创建配置构造器</span>\n<span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">CONFB</span> <span class="token function">configBuilder</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 为熔断器配置默认属性</span>\n<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">configureDefault</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> CONF<span class="token punctuation">></span></span> defaultConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里用到了大量的泛型定义，我们可以猜想，在这两个抽象方法的背后，Spring Cloud Circuit Breaker 会针对不同的第三方框架提供不同的配置实现过程。我们在接下来的内容中会基于具体的框架对这一过程做展开讨论。</p>\n<p>让我们来到 Hystrix 框架，来看看在 Spring Cloud Circuit Breaker 中是如何使用统一编程模式完成对该框架的集成。我们首先关注实现了 CircuitBreaker 接口的 HystrixCircuitBreaker 类，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30995064453181673000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class HystrixCircuitBreaker implements CircuitBreaker {\n   private HystrixCommand.Setter setter;\n\n   public HystrixCircuitBreaker(HystrixCommand.Setter setter) {\n      this.setter = setter;\n   }\n\n   @Override\n   public <T> T run(Supplier<T> toRun, Function<Throwable, T> fallback) {\n      HystrixCommand<T> command = new HystrixCommand<T>(setter) {\n         @Override\n         protected T run() throws Exception {\n            return toRun.get();\n         }\n\n         @Override\n         protected T getFallback() {\n            return fallback.apply(getExecutionException());\n         }\n      };\n\n      return command.execute();\n   }\n}`, `30995064453181673000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HystrixCircuitBreaker</span> <span class="token keyword">implements</span> <span class="token class-name">CircuitBreaker</span> <span class="token punctuation">{</span>\n   <span class="token keyword">private</span> <span class="token class-name">HystrixCommand</span><span class="token punctuation">.</span><span class="token class-name">Setter</span> setter<span class="token punctuation">;</span>\n\n   <span class="token keyword">public</span> <span class="token class-name">HystrixCircuitBreaker</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommand</span><span class="token punctuation">.</span><span class="token class-name">Setter</span> setter<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>setter <span class="token operator">=</span> setter<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token annotation punctuation">@Override</span>\n   <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> toRun<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Throwable</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">></span></span> fallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token class-name">HystrixCommand</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> command <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HystrixCommand</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>setter<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token annotation punctuation">@Override</span>\n         <span class="token keyword">protected</span> <span class="token class-name">T</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> toRun<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n\n         <span class="token annotation punctuation">@Override</span>\n         <span class="token keyword">protected</span> <span class="token class-name">T</span> <span class="token function">getFallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> fallback<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token function">getExecutionException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> command<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>不难想象，这里应该构建了一个 HystrixCommand 对象，并在该对象原有的 run 和 getFallback 方法中封装了 CircuitBreaker 中的统一方法调用，而最终实现熔断操作的还是 Hystrix 原生的 HystrixCommand。</p>\n<p>然后，我们接着来看 HystrixCircuitBreakerFactory，这个类的实现过程也简洁明了，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2902347035586872000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class HystrixCircuitBreakerFactory extends CircuitBreakerFactory<HystrixCommand.Setter, HystrixCircuitBreakerFactory.HystrixConfigBuilder> {\n   // 实现默认配置\n   private Function<String, HystrixCommand.Setter> defaultConfiguration = id -> HystrixCommand.Setter.withGroupKey(\n      HystrixCommandGroupKey.Factory.asKey(getClass().getSimpleName())).andCommandKey(HystrixCommandKey.Factory.asKey(id));\n\n   public void configureDefault(Function<String, HystrixCommand.Setter> defaultConfiguration) {\n      this.defaultConfiguration = defaultConfiguration;\n   }\n\n   public HystrixConfigBuilder configBuilder(String id) {\n      return new HystrixConfigBuilder(id);\n   }\n\n   // 创建熔断器\n   public HystrixCircuitBreaker create(String id) {\n      Assert.hasText(id, &quot;A CircuitBreaker must have an id.&quot;);\n      HystrixCommand.Setter setter = getConfigurations().computeIfAbsent(id, defaultConfiguration);\n      return new HystrixCircuitBreaker(setter);\n   }\n\n   // 创建配置构造器\n   public static class HystrixConfigBuilder extends AbstractHystrixConfigBuilder<HystrixCommand.Setter> {\n      public HystrixConfigBuilder(String id) {\n         super(id);\n      }\n\n      @Override\n      public HystrixCommand.Setter build() {\n         return HystrixCommand.Setter.withGroupKey(getGroupKey()).andCommandKey(getCommandKey()).andCommandPropertiesDefaults(getCommandPropertiesSetter());\n      }\n   }\n}`, `2902347035586872000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HystrixCircuitBreakerFactory</span> <span class="token keyword">extends</span> <span class="token class-name">CircuitBreakerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HystrixCommand</span><span class="token punctuation">.</span><span class="token class-name">Setter</span><span class="token punctuation">,</span> <span class="token class-name">HystrixCircuitBreakerFactory</span><span class="token punctuation">.</span><span class="token class-name">HystrixConfigBuilder</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>\n   <span class="token comment">// 实现默认配置</span>\n   <span class="token keyword">private</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">HystrixCommand</span><span class="token punctuation">.</span><span class="token class-name">Setter</span><span class="token punctuation">></span></span> defaultConfiguration <span class="token operator">=</span> id <span class="token operator">-></span> <span class="token class-name">HystrixCommand</span><span class="token punctuation">.</span><span class="token class-name">Setter</span><span class="token punctuation">.</span><span class="token function">withGroupKey</span><span class="token punctuation">(</span>\n      <span class="token class-name">HystrixCommandGroupKey</span><span class="token punctuation">.</span><span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">andCommandKey</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandKey</span><span class="token punctuation">.</span><span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configureDefault</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">HystrixCommand</span><span class="token punctuation">.</span><span class="token class-name">Setter</span><span class="token punctuation">></span></span> defaultConfiguration<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>defaultConfiguration <span class="token operator">=</span> defaultConfiguration<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">public</span> <span class="token class-name">HystrixConfigBuilder</span> <span class="token function">configBuilder</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HystrixConfigBuilder</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token comment">// 创建熔断器</span>\n   <span class="token keyword">public</span> <span class="token class-name">HystrixCircuitBreaker</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token string">"A CircuitBreaker must have an id."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token class-name">HystrixCommand</span><span class="token punctuation">.</span><span class="token class-name">Setter</span> setter <span class="token operator">=</span> <span class="token function">getConfigurations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> defaultConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HystrixCircuitBreaker</span><span class="token punctuation">(</span>setter<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token comment">// 创建配置构造器</span>\n   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">HystrixConfigBuilder</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractHystrixConfigBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HystrixCommand</span><span class="token punctuation">.</span><span class="token class-name">Setter</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>\n      <span class="token keyword">public</span> <span class="token class-name">HystrixConfigBuilder</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">super</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token annotation punctuation">@Override</span>\n      <span class="token keyword">public</span> <span class="token class-name">HystrixCommand</span><span class="token punctuation">.</span><span class="token class-name">Setter</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span> <span class="token class-name">HystrixCommand</span><span class="token punctuation">.</span><span class="token class-name">Setter</span><span class="token punctuation">.</span><span class="token function">withGroupKey</span><span class="token punctuation">(</span><span class="token function">getGroupKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">andCommandKey</span><span class="token punctuation">(</span><span class="token function">getCommandKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">andCommandPropertiesDefaults</span><span class="token punctuation">(</span><span class="token function">getCommandPropertiesSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上述代码基本就是对原有 HystrixCommand 中关于服务分组等属性的简单封装，你可以结合接下来要介绍的 Hystrix 框架熔断机制内容做进一步理解。</p>\n<h3 id="hystrix-熔断机制"><a href="#hystrix-%E7%86%94%E6%96%AD%E6%9C%BA%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Hystrix 熔断机制</h3>\n<p>在 Hystrix 中，最核心的就是 HystrixCircuitBreaker 接口，该接口代表了对熔断器的抽象过程，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34183032526423605000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface HystrixCircuitBreaker {\n   public boolean allowRequest();\n   public boolean isOpen();\n   void markSuccess();\n}`, `34183032526423605000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">HystrixCircuitBreaker</span> <span class="token punctuation">{</span>\n   <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">allowRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">void</span> <span class="token function">markSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到 HystrixCircuitBreaker 接口只有三个方法。在 Hystrix 中，该接口的实现类是 HystrixCircuitBreakerImpl。</p>\n<p>我们首先来看最重要的 allowRequest 方法，该方法用来判断每个请求是否可被执行。allowRequest 实际上是对 isOpen 方法做了一层封装，在通过调用 isOpen 来触发熔断器的计算逻辑之前，先根据 HystrixCommandProperties 中的配置信息来判断是否强制开启熔断器，具体实现如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46431777240203040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public boolean allowRequest() {\n   if (properties.circuitBreakerForceOpen().get()) {\n      return false;\n   }\n\n   if (properties.circuitBreakerForceClosed().get()) {\n      isOpen();\n      return true;\n   }\n\n   return !isOpen() || allowSingleTest();\n}`, `46431777240203040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">allowRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">circuitBreakerForceOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">circuitBreakerForceClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">allowSingleTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接下来的 isOpen 方法用来获取熔断器的当前状态。请注意，熔断器中关于阈值判断的一系列处理逻辑都位于该方法中，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25841722323448260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public boolean isOpen() {\n   if (circuitOpen.get()) {\n      return true;\n   }\n\n   HealthCounts health = metrics.getHealthCounts();\n   // 检查是否达到最小请求数，如果未达到的话即使请求全部失败也不会熔断\n   if (health.getTotalRequests() < properties.circuitBreakerRequestVolumeThreshold().get()) {\n      return false;\n   }\n\n   // 检查错误百分比是否达到设定的阀值，如果未达到的话也不会熔断\n   if (health.getErrorPercentage() < properties.circuitBreakerErrorThresholdPercentage().get()) {\n      return false;\n   } else {\n      // 如果错误率过高, 进行熔断，并记录下熔断时间\n      if (circuitOpen.compareAndSet(false, true)) {\n         circuitOpenedOrLastTestedTime.set(System.currentTimeMillis());\n         return true;\n      } else {\n         return true;\n      }\n   }\n}`, `25841722323448260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>circuitOpen<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token class-name">HealthCounts</span> health <span class="token operator">=</span> metrics<span class="token punctuation">.</span><span class="token function">getHealthCounts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 检查是否达到最小请求数，如果未达到的话即使请求全部失败也不会熔断</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>health<span class="token punctuation">.</span><span class="token function">getTotalRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> properties<span class="token punctuation">.</span><span class="token function">circuitBreakerRequestVolumeThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token comment">// 检查错误百分比是否达到设定的阀值，如果未达到的话也不会熔断</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>health<span class="token punctuation">.</span><span class="token function">getErrorPercentage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> properties<span class="token punctuation">.</span><span class="token function">circuitBreakerErrorThresholdPercentage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 如果错误率过高, 进行熔断，并记录下熔断时间</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>circuitOpen<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         circuitOpenedOrLastTestedTime<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最后，我们来到用来关闭熔断器的 markSuccess 方法。显然，该方法在熔断器处于半开状态下进行使用，我们可以通过该方法将熔断器设置为关闭状态。这时候，熔断器要做的一件事情就是重置对请求的统计指标，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77306442321903450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public void markSuccess() {\n   if (circuitOpen.get()) {\n      if (circuitOpen.compareAndSet(true, false)) {\n         metrics.resetStream();\n      }\n   }\n}`, `77306442321903450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">markSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>circuitOpen<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>circuitOpen<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         metrics<span class="token punctuation">.</span><span class="token function">resetStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>HystrixCircuitBreaker 接口的这三个方法的执行逻辑实际上都不复杂，HystrixCircuitBreaker 通过一个 circuitOpen 状态位控制着整个熔断判断流程，而这个状态位本身的状态值则取决于系统目前的运行时数据。</p>\n<h2 id="解题要点-10"><a href="#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-10" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解题要点</h2>\n<p>在分布式系统开发过程中，服务熔断的实现需要引入熔断器的概念，事实上像 Spring Cloud 等很多开源框架都内置了熔断器的实现组件。我在面试中发现很多开发人员已经在使用这些组件了，但并不清楚其背后的设计思想和原理。所以，这道题也是比较典型的从应用到原理的反向考查类的面试题。</p>\n<p>从解题思路上讲，目前业界主流的熔断器实现模型基本都是类似的。就知识体系而言，要注意的是在熔断器内部实现过程中，并不是只有熔断和非熔断这两个简单状态，而是会引入一个半熔断的状态，通过对当前服务所处理请求的情况进行统计分析，熔断器会基于一定的阈值动态完成这些状态之间的自动切换。</p>\n<p>另一方面，面试官在考查候选人能力的一大关注点还是实践能力，所以可以结合具体工具的使用过程来阐述熔断器的核心概念。在日常开发过程中，熔断器的使用方式主要是依赖于一系列的配置项。例如基于 Resilience4j 来使用 Spring Cloud Circuit Breaker 时，典型的配置项如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59952201005906080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`resilience4j:\n   circuitbreaker:\n      configs:\n         default:\n            ringBufferSizeInClosedState: 10 # 熔断器关闭时的缓冲区大小\n            ringBufferSizeInHalfOpenState: 4 # 熔断器半开时的缓冲区大小\n            waitDurationInOpenState: 20000 # 熔断器从打开到半开需要的时间\n            failureRateThreshold: 80 # 熔断器打开的失败阈值\n            recordExceptions: # 记录的异常\n               - com.example.resilience4j.exceptions.BusinessBException\n               - com.example.resilience4j.exceptions.BusinessAException\n            ignoreExceptions: # 忽略的异常\n               - com.example.resilience4j.exceptions.BusinessAException\n      instances:\n         aServiceCircuitBreaker:\n            baseConfig: default\n         bServiceCircuitBreaker:\n            baseConfig: default\n            waitDurationInOpenState: 5000\n            failureRateThreshold: 20`, `59952201005906080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yaml"\n              >\n                <span class="gatsby-code-button-language">yaml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yaml"><pre style="counter-reset: linenumber NaN" class="language-yaml line-numbers"><code class="language-yaml"><span class="token key atrule">resilience4j</span><span class="token punctuation">:</span>\n   <span class="token key atrule">circuitbreaker</span><span class="token punctuation">:</span>\n      <span class="token key atrule">configs</span><span class="token punctuation">:</span>\n         <span class="token key atrule">default</span><span class="token punctuation">:</span>\n            <span class="token key atrule">ringBufferSizeInClosedState</span><span class="token punctuation">:</span> <span class="token number">10 </span><span class="token comment"># 熔断器关闭时的缓冲区大小</span>\n            <span class="token key atrule">ringBufferSizeInHalfOpenState</span><span class="token punctuation">:</span> <span class="token number">4 </span><span class="token comment"># 熔断器半开时的缓冲区大小</span>\n            <span class="token key atrule">waitDurationInOpenState</span><span class="token punctuation">:</span> <span class="token number">20000 </span><span class="token comment"># 熔断器从打开到半开需要的时间</span>\n            <span class="token key atrule">failureRateThreshold</span><span class="token punctuation">:</span> <span class="token number">80 </span><span class="token comment"># 熔断器打开的失败阈值</span>\n            <span class="token key atrule">recordExceptions</span><span class="token punctuation">:</span> <span class="token comment"># 记录的异常</span>\n               <span class="token punctuation">-</span> com.example.resilience4j.exceptions.BusinessBException\n               <span class="token punctuation">-</span> com.example.resilience4j.exceptions.BusinessAException\n            <span class="token key atrule">ignoreExceptions</span><span class="token punctuation">:</span> <span class="token comment"># 忽略的异常</span>\n               <span class="token punctuation">-</span> com.example.resilience4j.exceptions.BusinessAException\n      <span class="token key atrule">instances</span><span class="token punctuation">:</span>\n         <span class="token key atrule">aServiceCircuitBreaker</span><span class="token punctuation">:</span>\n            <span class="token key atrule">baseConfig</span><span class="token punctuation">:</span> default\n         <span class="token key atrule">bServiceCircuitBreaker</span><span class="token punctuation">:</span>\n            <span class="token key atrule">baseConfig</span><span class="token punctuation">:</span> default\n            <span class="token key atrule">waitDurationInOpenState</span><span class="token punctuation">:</span> <span class="token number">5000</span>\n            <span class="token key atrule">failureRateThreshold</span><span class="token punctuation">:</span> <span class="token number">20</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这些配置信息可以分为两部分，一部分是默认配置，一部分是专属于某一个服务的特定配置。这里也展示了用来打开熔断器的失败阈值 failureRateThreshold、熔断器从打开到半开需要的时间 waitDurationInOpenState 等配置参数，以及针对异常类型的精细化控制过程。</p>\n<p>最后，在回答这道题时，一种比较好的解题思路是结合某个熔断器开源框架来分析它的内部实现原理，这是一个很大的加分项。</p>\n<h2 id="小结与预告-8"><a href="#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结与预告</h2>\n<p>服务熔断在分布式服务构建过程中是一种标配组件，例如在 Spring Cloud 中专门提供了一个 SpringCloudApplication 注解（如下所示），而在该注解中就把用来启用熔断器的 @EnableCircuitBreaker 和用来启用服务发现机制的 @EnableDiscoveryClient 以及 Spring Boot 的基础注解 @SpringBootApplication 放在一起，确保所有分布式服务都内置了服务熔断机制。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52853033629852720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@SpringBootApplication\n@EnableDiscoveryClient\n@EnableCircuitBreaker\npublic @interface SpringCloudApplication`, `52853033629852720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>\n<span class="token annotation punctuation">@EnableDiscoveryClient</span>\n<span class="token annotation punctuation">@EnableCircuitBreaker</span>\n<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">SpringCloudApplication</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>服务熔断的概念和原理理解起来都有一定的复杂度。在本讲内容中，我们从熔断器的基本结构开始讲起，详细分析了它在 Spring Cloud 的实现过程。同时，我们还自己实现了一个简单而又完整的熔断器示例，帮助你对服务熔断的实现过程有更为感性的认识。就算你平时没有专门针对熔断器做过系统学习，相信通过本讲内容的介绍也能帮助你顺利应对技术面试。</p>\n<p>掌握了服务熔断机制之后，下一讲我们将讨论另一个确保服务高可用的技术组件，即服务降级。和服务熔断一样，我们也可以采用不同的技术手段来对服务进行降级。那么，服务降级的常见实现策略有哪些呢？我们下一讲再聊。</p>\n<h1 id="服务降级：服务降级的常见实现策略有哪些？"><a href="#%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%EF%BC%9A%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%E7%9A%84%E5%B8%B8%E8%A7%81%E5%AE%9E%E7%8E%B0%E7%AD%96%E7%95%A5%E6%9C%89%E5%93%AA%E4%BA%9B%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务降级：服务降级的常见实现策略有哪些？</h1>\n<p>在上一讲中，我们介绍了基于熔断器的设计思想和实现方式。和集群容错一样，服务熔断也是一种常见的服务容错机制，也可以用来确保服务的可用性。而为了确保核心服务的可用性，有时候我们就会故意对那些不重要的服务执行下线操作，从而确保系统中有限的资源都应用到核心服务上。这就引出了在分布式系统构建过程中非常重要的一个技术组件，即服务降级。</p>\n<p>那么，什么是服务降级？又有那些常见的服务降级实现策略呢？这是面试过程中的一个常见考点，也是本讲内容的重点。</p>\n<h2 id="问题背景-8"><a href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题背景</h2>\n<p>我们先来看这个问题的背景。举个例子，在下图中存在服务 A 和服务 B 这两个服务。其中服务 B 是核心服务，而服务 A 是可以降级的非核心服务，服务 B 会依赖服务 A。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-12-10-52-03-724d798084079b600e15956555628fee-1ae11.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 485px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 16.49484536082474%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsSAAALEgHS3X78AAAAzUlEQVQI1x2N207CUBRE+/8fwoMvYtFSWhMNFyPCg+Ipl94lWEvh2DbURJvYxaGTTDI7mdlLm051NmuDyajDy/OVyn18b8Di7RYpj5RliRCCKIqI45iqOjGf3eC7pupZRME9gW/hqp0j7tDCwAQE7qZLGPQoi5G6HarTE7ZlUhQFSZKQpqkCSMLQ43Nnq46HPDzyERvk38N2c7G2WvX5+52zXuqKZCDer8nlGHkcs3QEF9V13bppIMv2Cjyg+X9l//XAbmtzyIbtj59qxhl2utaq6jY/5AAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 12 10 52 03" title="" data-src="/static/2024-11-12-10-52-03-724d798084079b600e15956555628fee-1ae11.png" data-srcset="/static/2024-11-12-10-52-03-724d798084079b600e15956555628fee-c8342.png 200w,\n/static/2024-11-12-10-52-03-724d798084079b600e15956555628fee-f73ef.png 400w,\n/static/2024-11-12-10-52-03-724d798084079b600e15956555628fee-1ae11.png 485w" data-sizes="(max-width: 485px) 100vw, 485px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>现在，当访问服务 B 的流量迎来高峰时，系统中的资源即将被耗尽，服务 B 的可用性即将出现问题。这时候，我们可以对服务 A 执行降级操作，也就说把服务 A 下线。通过这种方式，原本被服务 A 所占用的资源就可以用来处理面向服务 B 的请求。但是，问题就来了，服务 A 一旦下线，服务 B 在访问服务 A 时应该如何处理呢？基本的策略就是“快速失败”，即在服务 B 向服务 A 执行调用的链路中直接获取一个返回值，而不执行真正的远程调用。</p>\n<p>显然，想要实现上述效果并不容易，我们需要考虑如何在服务 A 已经下线的情况下，确保服务 B 能够得到一个快速失败的结果。由此，我们可以引出与服务降级相关的一系列问题，包括：</p>\n<ul>\n<li>系统中存在很多服务，你怎么判断哪些服务是可以降级的呢？</li>\n<li>快速失败的表现形式有哪些？</li>\n<li>想要实现服务降级，你有哪些设计思路？</li>\n<li>什么是服务回退？如何实现服务回退？</li>\n<li>Dubbo 框架是如何实现服务降级的？</li>\n<li>Spring Cloud 框架是如何实现服务降级的？</li>\n</ul>\n<p>上述问题都是面试官在面试过程中经常会提出的考查点，我们需要对这些考查点进行系统分析。</p>\n<h2 id="问题分析-9"><a href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题分析</h2>\n<p>所谓服务降级，是指在某些系统核心服务的访问压力剧增的情况下，根据当前业务情况及流量对一些服务进行有策略的快速失败处理，以此避免服务之间的调用依赖影响到其他核心服务。</p>\n<p>在面试过程中，首先需要用自己的语言对服务降级的基本概念和设计理念进行阐述，我们可以结合问题背景部分所举的例子进行展开。</p>\n<p>应对这类问题的第二点思路是对服务分级机制的讨论。既然服务可以降级，那么势必需要对服务进行分级。通常，等级越低的服务越应该被降级。我们可以结合日常的场景对服务等级进行分析。</p>\n<p>第三点，也是最重要的一点，是服务降级的实现策略。目前，在主流的开源框架中，关于如何实现服务降级有两大类策略，即：</p>\n<ul>\n<li>模拟（Mock）机制</li>\n<li>回退（Fallback）机制</li>\n</ul>\n<p>明确了服务降级的实现策略，最后的一点就是围绕具体的开源框架，给出这些实现策略的底层实现机制。</p>\n<p>通过上述分析，我们发现服务降级是一套独立而又完整的技术组件，既包含了分布式系统设计上的一些方法论，也和具体的工程实践紧密相关。</p>\n<p>接下来，让我们先从方法论开始讲起，梳理服务降级相关的技术体系。</p>\n<h2 id="技术体系-11"><a href="#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-11" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术体系</h2>\n<p>通过前面内容的介绍，我们已经理解了服务降级的基本概念和设计思想。从技术体系而言，关于服务降级我们要明确两个维度的内容。第一个维度是如何对服务进行分级管理，另一个维度就是具体的降级实现策略。</p>\n<p>我们先来讨论第一个维度。服务降级在实现上一般需要对业务的重要性进行区分，也就是需要明确服务分级，具体的服务分级方法因业务场景和需求而定。对每个服务进行等级管理之后，降级操作一般是从等级最低的的服务开始。</p>\n<p>关于服务分级，业界并没有统一的标准。在本讲中，我们介绍一种三级分类方法，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-12-10-54-08-68452dbd5e5f99c40f69fed06b80b64f-3e989.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 605px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 45.123966942148755%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABs0lEQVQoz4VSa2/aQBD0//8fUSuFoJAn5UsVkqpV04DB+AGGxO/zC1xwaCERTMdHUBUpUU5aza1udz07YwUvZ7vdvsK3ThAYULs1aP0GundH6Hbq6Pw6wt1tDWO7CSHaUKoB+9hsNrJxuXxEmgwRhTpjgCgaYbFYYqBdYWIfM05hDxtwHi5QzNooF9/w988PPD/dQnmLie/dYzRsoqeeoEMmtn2D1eoJ8/lvZFmMPE+IicTZLENR5JhOU6RpDKW6ZJngY4wkCVGWJYtmCENfFldN83khP1QUCVxXhef1uf5AbhD4GlynJ7HaSjH0M1hmgxqcwzROEMcx7JGBWHyVuWVyxfEVhz1SsxY8t868Dq13AFP/xNUPKUENlvEZ69UNlDQNqZHDAS5ZOWwsSD2F49gy97wJslRIhnkeQEQaa3UOVimNyhqN7+YOM+t9DYdWE/rggkacYjz+jvX6WcoRRRHdFBwqJFZ5GIYSYxFXLm+wj/8ul2RpvujVZePOZU1rU45jynNG3S5RTK+5Pu8Pl7ifnNPpnzuG+9/mo//QcVS6foB+75AmfEEYtOATA78l8wr/AcL5llKFF1KeAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 12 10 54 08" title="" data-src="/static/2024-11-12-10-54-08-68452dbd5e5f99c40f69fed06b80b64f-3e989.png" data-srcset="/static/2024-11-12-10-54-08-68452dbd5e5f99c40f69fed06b80b64f-4bd12.png 200w,\n/static/2024-11-12-10-54-08-68452dbd5e5f99c40f69fed06b80b64f-7acd9.png 400w,\n/static/2024-11-12-10-54-08-68452dbd5e5f99c40f69fed06b80b64f-3e989.png 605w" data-sizes="(max-width: 605px) 100vw, 605px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>围绕服务分级，我们给出一个案例。下图展示了在移动医疗系统中基于服务分级思想所构建的无线网关业务，无线网关用于上传来自无线网络的数据并进行相应的处理。对于这样一个网关系统而言，网关的连接管理和数据上报是优先级最高的业务功能，因为缺少这些功能，网关也就不能正常工作。数据上报之后，对数据进行分析是收集网关数据的目的所在，但数据分析服务可以离线处理，并不一定需要保证服务 100% 的在线率。其他的诸如服务监控、反垃圾和后台配置则属于辅助性功能，相应的优先级也就最低。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-12-10-54-44-4befbce4cd39f6ea0cea89d1b42c3188-4c6f5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 607px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 47.61120263591433%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABrUlEQVQoz31SXXOaUBTk//+P9MHRfNS0yUNf7INNaxU0KB8iQVFBBPlQo8kEt8ulydg045nZOWe4e/eePQcJR3E4HASKsG0Vun6BTrsiMOifw3G0v7z8jfseEt7Fq2CaRAiXOh7sjkAQaMiy+B/ORyF9JJZlCXxvgjBcwDQHhCbq4ltxduzmZIeFldJuC6ZRQ1+t0e4n5irs0TVzBc5DW3Dy/OW04PH81uuUFl1EkYfx2MKEKOpgMcVmk+FUSOWAX4dcdhivfMxnKjxP42LuYFm/sVyamLo9rFae4Dw+biieYLtN3/J6nfy/lCIM4w66doGuXIXSqWJk3dDyLQYcwchqwfcj/GheQm6fofXzDP37KnpKBep9DZJhNGDoDV5ocvgNKMp3dsMNhxGSJIPrzgTiOKXtGPv9TjwaRQHm8xF63V90oHJhDha+DUnuXKGr1GGZ36DIV2IhRYShg2Vg8jFeGLY5P4MPjctfKg1pf0CRIc9k1hpmUx273Q7S09MLnp9zFHlPlEvZwp00Sf4CrX/NfEvhOhfUJC+nkMWRfGYj5zyvY2h+pd1Ldj3DH4aZ6/PyNmHdAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 12 10 54 44" title="" data-src="/static/2024-11-12-10-54-44-4befbce4cd39f6ea0cea89d1b42c3188-4c6f5.png" data-srcset="/static/2024-11-12-10-54-44-4befbce4cd39f6ea0cea89d1b42c3188-3bd24.png 200w,\n/static/2024-11-12-10-54-44-4befbce4cd39f6ea0cea89d1b42c3188-52f0c.png 400w,\n/static/2024-11-12-10-54-44-4befbce4cd39f6ea0cea89d1b42c3188-4c6f5.png 607w" data-sizes="(max-width: 607px) 100vw, 607px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>显然，这里我们以对用户的影响程度为标准对服务等级进行了划分。</p>\n<p>介绍完服务等级的划分方式，我们来讨论第二个维度，即服务降级的实现策略。在问题分析部分，我们已经提到了两种主流的降级机制，即模拟和回退。</p>\n<p>Mock 并不是一个新概念，通常用于测试领域。首先，非常明确的一点，Mock 机制的作用就是完成对系统中组件与组件之间的有效隔离。在服务访问过程中，我们通常关注的是目标服务本身的功能和行为，对于该服务涉及到的一些依赖，我们仅仅关注它们在整个服务访问中的交互过程，比如是否调用、何时调用、调用的参数和返回值、调用过程中出现的各种异常等。至于调用过程中具体执行的业务逻辑，对于调用结果而言并不重要。</p>\n<p>基于这种设计思想，我们就可以通过 Mock 对象来模拟真实对象的调用结果，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-12-10-55-25-d9062a55a2fe7b64a1c8fef7eebaa436-8d56d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 465px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 41.72043010752689%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABcUlEQVQoz41RaWvCQBDN//8VBWtBi2I19UDbgFbrgdbbaGpMFRNNNCZaj3jkdXdFof1QHHjMzLLz5u1bDjfEbreDbdsM6fQbmo0wNDWJ/Ps9inkPyqUHGLoAZRAFt1x+Yz43sVhYMM0FyQvWm6YFy7Ixm81ItrDZbOC6LlswnWro93uQZQmCkIQkiayW+xK4ajVGmFMQO1FIvTi6YhxD5QW1Kk8Gp1iv14xU13WyxIRhGGzpJRxn/+s13EclhGb9EdnMHUpFL/I5D8R2EK1mmBCdh0ejERRFwWAwgKZpGA6/cDjscTqdiPI1U+66JwbOMHSo6giTyfgK2muaiu12y0A9PB6PjIBmGqQkpC5WK2rFuaZn3C2fQhU4jsPIOm0RuSxP7BHQqCeINTHUawli1Ssq5Rg4epluvkhmuPbuFZeYTAyo4zQO+wLkzwi6nSDarQCcXYG8LPm/wgvRX+JMJoWnkBd8xI9I2EeyD8+8nyCAH+UVVJ3GViZbAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 12 10 55 25" title="" data-src="/static/2024-11-12-10-55-25-d9062a55a2fe7b64a1c8fef7eebaa436-8d56d.png" data-srcset="/static/2024-11-12-10-55-25-d9062a55a2fe7b64a1c8fef7eebaa436-afa68.png 200w,\n/static/2024-11-12-10-55-25-d9062a55a2fe7b64a1c8fef7eebaa436-5df89.png 400w,\n/static/2024-11-12-10-55-25-d9062a55a2fe7b64a1c8fef7eebaa436-8d56d.png 465w" data-sizes="(max-width: 465px) 100vw, 465px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>服务降级的另一种主流实现策略是服务回退。为了实现对服务的降级，服务端会准备一个本地的 Fallback 函数，该函数会在每次调用时返回一个缺省值，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-12-10-55-54-fa5021862418e70a83c318795695a04e-3e688.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 589px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 36.33276740237691%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABRUlEQVQoz4VRa0/CMBTd//8bhmDExFfAL4p+ANlkIKAOl4jL3ltZ2yUbhNd2bGti4he5yeltb9tz77lXq+sa/6EsSxRFgTzPla+qCtKiKIJpmhiPRjAMA3Ecq7iGI5amKWzbhmVZ8H3/z11RlPA8H1lGf2MaYxRLkoDzDJwtwQQIiYVnCoQQccfVnlKqSIPAR86p8B6cr08MnnrIlql4x6D1ew2Q5A7mc0OU38Tb6zkCvwN9cI39vsbhsFeZpXyxCpIID90mPLeN2eQMQ/HP0E/gOm3oegvaeHQjsumYvFxgKmB/3ILRPvq9K1ERV2Syb5JQku92B1jvjwiDe8ymlzAGpzCHLYR+F9NJR0rmQkaoepUkqWhugjCMFKTU7XaL9XqN1WqFzWajQClT0uUgkuQH8izjR4cyn8/hui4WiwUcxzn2HN9gnAq1W4gaOAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 12 10 55 54" title="" data-src="/static/2024-11-12-10-55-54-fa5021862418e70a83c318795695a04e-3e688.png" data-srcset="/static/2024-11-12-10-55-54-fa5021862418e70a83c318795695a04e-c6c0d.png 200w,\n/static/2024-11-12-10-55-54-fa5021862418e70a83c318795695a04e-69d2c.png 400w,\n/static/2024-11-12-10-55-54-fa5021862418e70a83c318795695a04e-3e688.png 589w" data-sizes="(max-width: 589px) 100vw, 589px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="源码解析-9"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h2>\n<p>接下来，我们就将基于 Dubbo 和 Spring Cloud 这两款开源框架分别给出服务降级的实现方式。虽然这两种框架采用不同的实现方式，但其设计思想本质上是类似的。</p>\n<h3 id="dubbo-中的服务降级"><a href="#dubbo-%E4%B8%AD%E7%9A%84%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dubbo 中的服务降级</h3>\n<h4 id="dubbo-中的-mock-机制"><a href="#dubbo-%E4%B8%AD%E7%9A%84-mock-%E6%9C%BA%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dubbo 中的 Mock 机制</h4>\n<p>Dubbo 通过 Mock 来实现服务降级的过程和测试领域的 Mock 有异曲同工之处。在 Dubbo 中，可以在配置服务引用时提供 Mock 机制，存在几种配置方法，这里参考 Dubbo 官网中的示例。</p>\n<p>首先，我们可以在配置文件中添加如下所示的配置项：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95906567752718420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<dubbo:reference interface=&quot;com.foo.BarService&quot; mock=&quot;true&quot; />`, `95906567752718420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="xml"\n              >\n                <span class="gatsby-code-button-language">xml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="xml"><pre style="counter-reset: linenumber NaN" class="language-xml line-numbers"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>reference</span> <span class="token attr-name">interface</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.foo.BarService<span class="token punctuation">"</span></span> <span class="token attr-name">mock</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果采用这种配置，那么该 Mock 类的命名必须是接口名 + Mock，在这个示例中，即 BarServiceMock。我们可以提供如下所示的实现：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87572414283976050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class BarServiceMock implements BarService {\n   public String sayHello(String name) {\n      return &quot;降级数据&quot;;\n   }\n}`, `87572414283976050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BarServiceMock</span> <span class="token keyword">implements</span> <span class="token class-name">BarService</span> <span class="token punctuation">{</span>\n   <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token string">"降级数据"</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同时，我们也可以提供如下所示的配置项，指定 Mock 的实现类。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33253152330790870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<dubbo:reference interface=&quot;com.foo.BarService&quot; mock=&quot;com.foo.BarServiceMock&quot; />`, `33253152330790870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="xml"\n              >\n                <span class="gatsby-code-button-language">xml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="xml"><pre style="counter-reset: linenumber NaN" class="language-xml line-numbers"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>reference</span> <span class="token attr-name">interface</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.foo.BarService<span class="token punctuation">"</span></span> <span class="token attr-name">mock</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.foo.BarServiceMock<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>当然，如果 Mock 方法的逻辑非常简单，我们也可以直接将实现写在配置项中。例如，如下所示的配置标明 Mock 方法直接返回 null。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66694739969297555000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<dubbo:reference interface=&quot;com.foo.BarService&quot; mock=&quot;return null&quot; />`, `66694739969297555000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="xml"\n              >\n                <span class="gatsby-code-button-language">xml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="xml"><pre style="counter-reset: linenumber NaN" class="language-xml line-numbers"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>reference</span> <span class="token attr-name">interface</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.foo.BarService<span class="token punctuation">"</span></span> <span class="token attr-name">mock</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>return null<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>通过上述配置方法，在服务调用过程中，返回的就是一个事先提供的 Mock 对象，而不会对服务提供者发起真实请求。</p>\n<p>Mock 还存在一些高级用法，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-12-10-58-14-d99cff89f273ccc6dbdb64db5c1b4c47-73362.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 609px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 27.914614121510674%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABWUlEQVQY0zVRa0/CQBDs//8TJkTBRNQPajDxgxpeBaSFFmmh1LZ3fdAWCIgmkBbG7TVeMrd3s5PNzq4Ecc7iznPAXnQw6Fcx0eswzR407Q2fkzsY0wcoHzdoNa8gd2tQhnWohE67ClW5xZBytvUEKcuAAodDTjggCBjC0MNyyfH7s8dut6a/gyThxHnwfYf+LqKo0DDx/o9xzCAxrwfGSkRhREkLaTLGKtVI4FIBE7vtlArqlB9hGY1FjJcaAl+BzxXBbdZT0hmQJvor5rMmXEemopxEBr7sDjxXRhjYcBydiqnwvD4sqy1GYs1bpOliTlFVXjAzW+RsSLoRpNOpnN3xmBOO4JzshExY3u+/sd1uyB4jcYg0DYn3qSNOHCcHPlariNxESOJA8FK5kHIpWXbGYtHGoFeBPr4WSyk6YN4j4Zm6btDwa+jLl2i+X9ByKjCNe5ErwFkDf1lgr9diZ/2uAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 12 10 58 14" title="" data-src="/static/2024-11-12-10-58-14-d99cff89f273ccc6dbdb64db5c1b4c47-73362.png" data-srcset="/static/2024-11-12-10-58-14-d99cff89f273ccc6dbdb64db5c1b4c47-06e0b.png 200w,\n/static/2024-11-12-10-58-14-d99cff89f273ccc6dbdb64db5c1b4c47-70531.png 400w,\n/static/2024-11-12-10-58-14-d99cff89f273ccc6dbdb64db5c1b4c47-73362.png 609w" data-sizes="(max-width: 609px) 100vw, 609px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在执行 Mock 的过程中，如果我们希望抛出一个异常而不是返回正常的 Mock 值，那么可以使用 throw 配置项。而上图中的 fail 配置项用于指定当远程调用过程中发生错误时才会返回 Mock 对象。对应的，force 配置项用于指定在任何情况下都将返回 Mock 对象。</p>\n<p>现在，让我们回到 Dubbo 中的 Cluster 接口。我们知道该接口存在一批实现类。在这些实现类中，存在一个命名上比较特殊的 MockClusterWrapper 类，该类恰恰就是用于实现 Mock 机制，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27177297346024810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class MockClusterWrapper implements Cluster {\n   private Cluster cluster;\n\n   public MockClusterWrapper(Cluster cluster) {\n      this.cluster = cluster;\n   }\n\n   public <T> Invoker<T> join(Directory<T> directory) throws RpcException {\n      return new MockClusterInvoker<T>(directory, this.cluster.join(directory));\n   }\n}`, `27177297346024810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MockClusterWrapper</span> <span class="token keyword">implements</span> <span class="token class-name">Cluster</span> <span class="token punctuation">{</span>\n   <span class="token keyword">private</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">;</span>\n\n   <span class="token keyword">public</span> <span class="token class-name">MockClusterWrapper</span><span class="token punctuation">(</span><span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>cluster <span class="token operator">=</span> cluster<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token class-name">Directory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> directory<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MockClusterInvoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>directory<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cluster<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>directory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>与其他 Cluster 接口的实现类不同，MockClusterWrapper 内部同时持有一个 Cluster 接口，相当于是对 Cluster 接口的一种包装（Wrapper），所以该类取名为 MockClusterWrapper。而该类的 join 方法中即根据传入的 Directory 构建一个 MockClusterInvoker 类。显然，Mock 的核心逻辑应该位于 MockClusterInvoker 类中，让我们来一起看一下。</p>\n<h4 id="mockinvoker-和-mockclusterinvoker"><a href="#mockinvoker-%E5%92%8C-mockclusterinvoker" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>MockInvoker 和 MockClusterInvoker</h4>\n<p>同样，我们也知道在 Dubbo 中存在一批 ClusterInvoker 实现类。在这些实现类中，构造函数只传入一个 Directory 对象。而 MockClusterInvoker 的构造函数则包含两个参数，除了 Directory 对象还有一个 Invoker 对象。因此，MockClusterInvoker 天生就包含了 Invoker 对象。</p>\n<p>MockClusterInvoker 的 invoke 方法执行流程如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24374075286858887000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public Result invoke(Invocation invocation) throws RpcException {\n   Result result = null;\n   // 获取输入参数\n   String value = directory.getUrl().getMethodParameter(invocation.getMethodName(), Constants.MOCK_KEY, Boolean.FALSE.toString()).trim();\n   if (value.length() == 0 || value.equalsIgnoreCase(&quot;false&quot;)) {\n      // 如果没有 Mock 键，则不执行 Mock\n      result = this.invoker.invoke(invocation);\n   } else if (value.startsWith(&quot;force&quot;)) {\n      // …\n      // 如果以 force 开头，直接 Mock，不发起远程调用请求\n      result = doMockInvoke(invocation, null);\n   } else {\n      // 如果以 fail 开头，进入失败 Mock，即正常发起远程调用请求，如果失败则抛出了非业务异常\n      try {\n         result = this.invoker.invoke(invocation);\n      } catch (RpcException e) {\n         if (e.isBiz()) {\n            // 如果是业务异常，直接抛出\n            throw e;\n         } else {\n            //…\n            // 如果捕获到非业务异常，则调用 doMockInvoke 方法返回结果\n            result = doMockInvoke(invocation, e);\n         }\n      }\n   }\n   return result;\n}`, `24374075286858887000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>\n   <span class="token class-name">Result</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n   <span class="token comment">// 获取输入参数</span>\n   <span class="token class-name">String</span> value <span class="token operator">=</span> directory<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethodParameter</span><span class="token punctuation">(</span>invocation<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>MOCK_KEY<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span>FALSE<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> value<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">"false"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 如果没有 Mock 键，则不执行 Mock</span>\n      result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"force"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// …</span>\n      <span class="token comment">// 如果以 force 开头，直接 Mock，不发起远程调用请求</span>\n      result <span class="token operator">=</span> <span class="token function">doMockInvoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 如果以 fail 开头，进入失败 Mock，即正常发起远程调用请求，如果失败则抛出了非业务异常</span>\n      <span class="token keyword">try</span> <span class="token punctuation">{</span>\n         result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RpcException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">isBiz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 如果是业务异常，直接抛出</span>\n            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>\n         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            <span class="token comment">//…</span>\n            <span class="token comment">// 如果捕获到非业务异常，则调用 doMockInvoke 方法返回结果</span>\n            result <span class="token operator">=</span> <span class="token function">doMockInvoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">return</span> result<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上述代码实际上就是三个分支流程，分别对应没有 Mock 配置、以 force 开头的配置和以 fail 开头的配置这三种场景。</p>\n<ul>\n<li>如果没有 Mock 配置，就不执行 Mock；</li>\n<li>如果是以 force 开头，那么就直接返回 Mock 对象而不发起远程调用请求；</li>\n<li>如果以 fail 开头，意味着进入失败 Mock 处理流程，即正常发起远程调用请求，如果失败则抛出了非业务异常。</li>\n</ul>\n<p>因为 MockClusterInvoker 中自身包含有一个 Invoker 对象，因此直接就可以通过该 Invoker 对象执行远程调用。如果这个异常是业务异常，就直接抛出交由上游代码进行处理。而如果捕获到非业务异常，则会调用 doMockInvoke 方法返回结果。</p>\n<p>接下来就需要看一下这个 doMockInvoke 方法的执行逻辑。该方法核心逻辑之一是获取 MockInvoker 并执行它的 invoke 方法，这部分实现如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89873755690243780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`List<Invoker<T>> mockInvokers = selectMockInvoker(invocation);\n\nif (mockInvokers == null || mockInvokers.size() == 0) {\n   minvoker = (Invoker<T>) new MockInvoker(directory.getUrl());\n} else {\n   minvoker = mockInvokers.get(0);\n}\n\nresult = minvoker.invoke(invocation);`, `89873755690243780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span><span class="token punctuation">></span></span> mockInvokers <span class="token operator">=</span> <span class="token function">selectMockInvoker</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>mockInvokers <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> mockInvokers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   minvoker <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">MockInvoker</span><span class="token punctuation">(</span>directory<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n   minvoker <span class="token operator">=</span> mockInvokers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nresult <span class="token operator">=</span> minvoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们看到，这里会通过 selectMockInvoker 方法获取 Mock 类型的 Invoker。而如果没有找到想要的 Invoker，则会自己创建一个 MockInvoker。</p>\n<p>MockInvoker 中最重要的就是 invoke 方法，该方法包含了一系列判断，核心逻辑如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66296734294974070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public Result invoke2(Invocation invocation) throws RpcException {\n   // 如果是空的 return 配置\n   if (Constants.RETURN_PREFIX.trim().equalsIgnoreCase(mock.trim())) {\n      // 直接返回空的 RpcResult\n   } else if (mock.startsWith(Constants.RETURN_PREFIX)) { // 如果是包含返回值的 return 配置\n      // 解析 Mock 对象，构建 RpcResult 并返回\n   } else if (mock.startsWith(Constants.THROW_PREFIX)) { // 如果是 throw 配置\n      if (condition) {\n         // 抛出 Mock 异常\n      } else {\n         // 抛出业务异常\n      }\n   } else { // 如果是自定义 Mock 类\n      // 调用 Mock 类的 invoke 方法并返回\n      Invoker<T> invoker = getInvoker(mock);\n      return invoker.invoke(invocation);\n   }\n}`, `66296734294974070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">invoke2</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 如果是空的 return 配置</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>RETURN_PREFIX<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>mock<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 直接返回空的 RpcResult</span>\n   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mock<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>RETURN_PREFIX<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果是包含返回值的 return 配置</span>\n      <span class="token comment">// 解析 Mock 对象，构建 RpcResult 并返回</span>\n   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mock<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>THROW_PREFIX<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果是 throw 配置</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>condition<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token comment">// 抛出 Mock 异常</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         <span class="token comment">// 抛出业务异常</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 如果是自定义 Mock 类</span>\n      <span class="token comment">// 调用 Mock 类的 invoke 方法并返回</span>\n      <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> invoker <span class="token operator">=</span> <span class="token function">getInvoker</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这段方法针对 return 配置和 throw 配置的处理都比较简单，而如果是业务异常我们也是采用直接抛向上游代码。这里的关键是如何获取自定义 Mock 类的实例，这里用到了 getInvoker 方法，该方法的核心就是如下所示的这两行代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28326564999455980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`T mockObject = (T) mockClass.newInstance();\ninvoker = proxyFactory.getInvoker(mockObject, (Class<T>) serviceType, url);`, `28326564999455980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">T</span> mockObject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> mockClass<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ninvoker <span class="token operator">=</span> proxyFactory<span class="token punctuation">.</span><span class="token function">getInvoker</span><span class="token punctuation">(</span>mockObject<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> serviceType<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这里看到了熟悉的 ProxyFactory 接口，这是 Dubbo 中实现动态代理的核心接口。现在我们明确了，上述代码基于反射机制获取自定义 Mock 类实例，然后通过动态代理创建 Invoker。</p>\n<h3 id="spring-cloud-中的服务降级"><a href="#spring-cloud-%E4%B8%AD%E7%9A%84%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Spring Cloud 中的服务降级</h3>\n<p>和 Dubbo 相比，Spring Cloud 采用了另一种完全不同的机制来实现服务降级，这就是回退机制。在接下里的内容中，我们将对回退机制的使用方式和设计理念做一定分析。</p>\n<h4 id="spring-cloud-中的回退机制"><a href="#spring-cloud-%E4%B8%AD%E7%9A%84%E5%9B%9E%E9%80%80%E6%9C%BA%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Spring Cloud 中的回退机制</h4>\n<p>在 Spring Cloud 中，我们可以基于 Spring Cloud Circuit Breaker 提供的回退机制来实现服务降级。在开发过程上，我们只需要提供一个回退方法实现并进行配置即可。这里同样也给出对应的实现方式。</p>\n<p>我们举个例子，假设系统中存在一个代表用户业务的用户服务，那么当访问这个服务时，我们就可以实现回退方法。在回退方法的实现过程中，唯一需要注意的就是该回退方法的参数和返回值必须与真实的方法完全一致。</p>\n<p>如下所示的就是回退方法的一个示例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9464854046035298000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`private UserMapper getUserFallback(String userName) {\n   UserMapper fallbackUser = new UserMapper(0L,&quot;no_user&quot;,&quot;not_existed_user&quot;);\n   return fallbackUser;\n}`, `9464854046035298000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">UserMapper</span> <span class="token function">getUserFallback</span><span class="token punctuation">(</span><span class="token class-name">String</span> userName<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token class-name">UserMapper</span> fallbackUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserMapper</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">,</span><span class="token string">"no_user"</span><span class="token punctuation">,</span><span class="token string">"not_existed_user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> fallbackUser<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以基于 Spring Cloud Circuit Breaker 实现服务回退，开发流程也比较固化。首先，我们需要创建一个 CircuitBreaker 实例，然后实现具体的业务逻辑并提供一个回退方法，最后执行 CircuitBreaker 的 run 方法，示例代码如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14287499894586642000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建 CircuitBreaker\nCircuitBreaker circuitBreaker = circuitBreakerFactory.create(&quot;user&quot;);\n\n// 封装业务逻辑\nSupplier<UserMapper> supplier = () -> {\n   return userClient.getUserByUserName(userName);\n};\n\n// 初始化回退函数\nFunction<Throwable, UserMapper> fallback = t -> {\n   UserMapper fallbackUser = new UserMapper(0L,&quot;no_user&quot;,&quot;not_existed_user&quot;);\n   return fallbackUser;\n};\n\n// 执行业务逻辑\ncircuitBreaker.run(supplier, fallback);`, `14287499894586642000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token comment">// 创建 CircuitBreaker</span>\n<span class="token class-name">CircuitBreaker</span> circuitBreaker <span class="token operator">=</span> circuitBreakerFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 封装业务逻辑</span>\n<span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserMapper</span><span class="token punctuation">></span></span> supplier <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> userClient<span class="token punctuation">.</span><span class="token function">getUserByUserName</span><span class="token punctuation">(</span>userName<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 初始化回退函数</span>\n<span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Throwable</span><span class="token punctuation">,</span> <span class="token class-name">UserMapper</span><span class="token punctuation">></span></span> fallback <span class="token operator">=</span> t <span class="token operator">-></span> <span class="token punctuation">{</span>\n   <span class="token class-name">UserMapper</span> fallbackUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserMapper</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">,</span><span class="token string">"no_user"</span><span class="token punctuation">,</span><span class="token string">"not_existed_user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> fallbackUser<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 执行业务逻辑</span>\ncircuitBreaker<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>supplier<span class="token punctuation">,</span> fallback<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上述示例代码可以根据具体需求进行调整并嵌入到各种业务场景中。</p>\n<h4 id="基于拦截器实现回退"><a href="#%E5%9F%BA%E4%BA%8E%E6%8B%A6%E6%88%AA%E5%99%A8%E5%AE%9E%E7%8E%B0%E5%9B%9E%E9%80%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基于拦截器实现回退</h4>\n<p>限于篇幅关系，我们在这里主要探讨如何实现一个降级体系的设计思路。服务降级的目标就是一旦出现异常确保能够正确回退，这让我们首先想到了可以通过引入 AOP 机制来对异常进行拦截。一旦拦截成功，那么就可以嵌入自定义的回退方法并执行该方法中的回退逻辑。整个设计思路下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-12-11-01-32-3e46af2da04cb4bab0992d6313b314c3-04139.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 414px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 58.212560386473434%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAAB30lEQVQoz41T2W7aUBD1/7/3KXml1KKhJUSVa1Bp2criBYNtYoKNTbAhbGkoLYtjTieOIKRx1Yw0Gs1dzpy5cy6T/5aA2kpBqJ9BkT9CFpNoKinUqiyMTgsPFgQBdrvdq5wR6iwWd18JKAbLPIeuJtCjOB3zaLUqB8DXGqNpEl0sQ9fqKJczkOUiVLWCRqOEyeTmALhn+WCPbIJIZ47Rb28XLyruQf6Vv2A4n88xGnmYzSbIZnlcXuoEPA3XtttteMh1XViWhdVqFebj8Q3lXThOD4OBQ96HbVuhM4VCHH2bg9J4T4OJ04CSoesaRVUIARzHRrfbxXq9Rr/vIZdjMZ3kMLjOQBLfQZJYeG42zBlJPMOMNkUhjrb2AW09ScAxDD2e3vE7sbwPgTabDXx/C00zkPvyFsF9DXc/CrC65zTMNH79LNFwi2B6PZPabKJjqOh0NBgUDaMFXW9iuVxGvtPVlU7SqtAZkRgWqRuBCgk03NrzoURZlNaObTicEPsnWTF7SUT5c5k8gZlmG5KcJ6YyOC6BfOETfQIRilICc6i4v4QjNo8bYdyfWyx+U4s8Ar8Ks5OCbV1g5GXgXnNYryr/b/lv/fl+QN+SQ7UaA//5BOn0G2Qyp+D5E9RrLP4A5lp/Mrv4CdEAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 12 11 01 32" title="" data-src="/static/2024-11-12-11-01-32-3e46af2da04cb4bab0992d6313b314c3-04139.png" data-srcset="/static/2024-11-12-11-01-32-3e46af2da04cb4bab0992d6313b314c3-53fb7.png 200w,\n/static/2024-11-12-11-01-32-3e46af2da04cb4bab0992d6313b314c3-e3470.png 400w,\n/static/2024-11-12-11-01-32-3e46af2da04cb4bab0992d6313b314c3-04139.png 414w" data-sizes="(max-width: 414px) 100vw, 414px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>事实上， Spring Cloud Circuit Breaker 中的 Fallback 概念和 Dubbo 中 Mock 的概念异曲同工。两者都是实现服务降级的常用技术手段。</p>\n<h2 id="解题要点-11"><a href="#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-11" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解题要点</h2>\n<p>针对服务降级，在面试过程中，相比 Mock 机制，我认为回退机制被问题的频率会更高，是我们重点需要掌握的知识点。事实上，服务回退在分布式系统构建过程中并不能算是一个非常独立的知识点，而是属于服务降级体系下的一个具体实现策略。所以，需要面试者具有比较广的知识面，并能从概念到实现过程上对服务回退有一定的了解。</p>\n<p>事实上，服务回退的概念并不难理解。在传统开发模式下，我们在系统发生异常时通常都会返回一个默认的提示信息。服务回退与这种处理方式是类似的，本质上就是一个回调处理机制，能够针对某个方法提供缺省的返回值。在实施过程中，常见的做法是对业务方法提供一个对应的回退方法，回退方法的参数和返回值必须与真实的方法完全一致，这样确保系统获取到缺省的返回值之后还能够正常运行。</p>\n<p>关于服务降级的相关问题，还有一种开放式的提问方式，比方说 <code class="language-text">如果让你来实现一个服务回退机制，你会怎么做？</code>。有时候，面试官很难从那些概念类的标准答案中看出不同面试者的水平差异，这时候就可以通过类似本题的方式进行考查。</p>\n<p>从考查难度而言，这种开放式的面试题对面试者而言有利有弊。一方面，这种面试题没有标准答案，面试者可以自由发挥，只要做到自圆其说就行。另一方面，这种面试题可以会让面试者感到无从下手，从而导致没有很好的回答思路。</p>\n<p>从设计思想上讲，我们可以基于拦截器来实现服务回退机制。在这套自定义的实现机制中，通过引入 AOP 对异常进行拦截。一旦拦截成功，那么就可以嵌入自定义的回退方法并执行该方法中的回退逻辑。事实上，在 Spring Cloud 等主流开源框架中，也正是基于类似的机制提供了服务回退功能。在回答这道面试题时，我们可以首先阐述自己的设计思想，然后结合开源框架给出具体的实现原理。</p>\n<h2 id="小结与预告-9"><a href="#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结与预告</h2>\n<p>本讲是远程过程调用中所要介绍的最后一个技术组件，我们对服务降级展开了讨论。</p>\n<p>服务降级的常见实现模式包括模拟和回退两种。这两种实现模式体现的都是一种自动化的处理策略，当服务响应出现问题时能够返回一个处理结果，从而避免对目标服务执行真正的远程调用。</p>\n<p>从下一讲开始，我们将进入到与微服务架构相关技术组件的讨论。我们首先要讨论的是注册中心，而注册中心也有多种实现方式。下一讲的主题是：如何设计一款具备实时通知能力的注册中心模型？我们下一讲再聊。</p>\n<h1 id="注册中心：如何设计一款具备实时通知能力的注册中心模型？"><a href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%EF%BC%9A%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E6%AC%BE%E5%85%B7%E5%A4%87%E5%AE%9E%E6%97%B6%E9%80%9A%E7%9F%A5%E8%83%BD%E5%8A%9B%E7%9A%84%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%A8%A1%E5%9E%8B%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>注册中心：如何设计一款具备实时通知能力的注册中心模型？</h1>\n<p>通过前面几讲内容的介绍，我们已经掌握了与远程过程调用相关的各个技术组件。在分布式系统中，远程过程调用解决的就是两个服务之间的点对点调用过程。显然，想要完成这个调用过程，服务消费者首先得知道目标服务提供者的地址信息。这个地址信息是服务实例信息中的一个元数据，其他的元数据还包括服务的上线时间、可用状态等。</p>\n<p>如何对这些元数据进行有效管理是分布式系统构建过程中不得不考虑的一个问题，特别是在服务实例数量非常庞大的场景下。这就引出了本讲将要介绍的一个新的技术组件，即注册中心。</p>\n<p>注册中心的实现模型有多种，今天我们介绍其中的一种，即：如何设计一款具备实时通知能力的注册中心模型？围绕这个问题的讨论也经常出现在面试过程中，让我们一起来看一下。</p>\n<h2 id="问题背景-9"><a href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题背景</h2>\n<p>在分布式系统中，通常会存在几十个甚至上百个服务，开发人员可能甚至都无法明确系统中到底有哪些服务正在运行。另一方面，我们很难同时确保所有服务都不出现问题，也很难保证当前的服务部署方式不做调整和优化。由于自动扩容、服务重启等因素，服务实例的运行时状态也会经常变化。通常，我们把这些服务实例的运行时状态信息统称为服务的元数据（Metadata）。关于元数据这个词，我们已经在介绍服务发布流程时提到过，你可以做一些回顾。</p>\n<p>既然服务数量的增加以及服务实例的变化都不可避免，那么，有什么好的办法能够做到对这些服务实例进行有效的管理呢？这实际上就是一个服务治理的问题。</p>\n<p>我们需要管理系统中所有服务实例的运行时状态，并能够把这些状态的变化同步到各个服务中。就技术组件而言，我们可以通过引入注册中心轻松实现对大规模服务的高效治理。在日常开发过程中，注册中心的应用方式都是非常简单的。但从面试角度讲，这些应用方式显然不是考查的目标。面试官更多地会从设计原理和底层实现机制的角度来考查候选人对注册中心实现模型的理解程度。</p>\n<p>我们来梳理一下关于注册中心的一些常见问题：</p>\n<ul>\n<li>为什么我们需要在分布式系统中引入注册中心？它有什么好处？</li>\n<li>你能描述注册中心的基本组成结构吗？</li>\n<li>如果让你设计一个注册中心，你会选择什么框架来进行实现？</li>\n<li>一旦服务提供者的状态发生变化，我们希望这些状态信息能够在服务消费者中得到实时更新，你可以采用什么样的实现机制？</li>\n</ul>\n<p>上面这些问题都比较经典，我经常会拿这些问题来考查候选人。另一方面，你可能会觉得这些问题比较难以回答，但它们背后的知识体系却是每个开发人员都应该掌握的。</p>\n<p>让我们先对这些问题做一些分析和展开。</p>\n<h2 id="问题分析-10"><a href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-10" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题分析</h2>\n<p>注册中心是我们引入的第一个微服务架构技术组件。为什么我们需要专门提取微服务架构技术组件，就是为了应对大规模分布式系统的构建需求。</p>\n<p>如果一个分布式系统的服务数量达到一定的规模，就需要引入专门的组件来对这些服务的元数据进行管理。而这种管理过程显然应该具备一定的机制和策略，所以我们需要设计一个模型，这就是注册中心模型。关于注册中心模型的讨论是我们应对这类面试题的第一个要点。</p>\n<p>应对这类面试题的第二个要点是深入注册中心的实现原理，其中最核心的一个问题就是：如果服务提供者的元数据发生了变化，如何实时地通知到各个服务消费者呢？这是我们要回答的第二个要点。</p>\n<p>最后，我们明确注册中心本身是一种架构设计上的模型和机制，需要依托于具体的框架才能得以实现。因此，我们需要基于具体的开源框架来对前面提出的核心问题进行分析，并阐述底层的实现原理。</p>\n<p>业界可以用来实现注册中心的框架有很多，一方面我们可以选择自己比较擅长的框架展开讨论。另一方面，我也建议你直接从 Dubbo 等主流的开源框架入手，来看看它们具体是如何设计和实现的。</p>\n<h2 id="技术体系-12"><a href="#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-12" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术体系</h2>\n<p>在分布式系统中，我们引入注册中心的目的是实现服务的自动注册和发现机制。围绕这两个操作，我们可以先来探讨注册中心所应该具备的模型结构。</p>\n<h3 id="注册中心模型"><a href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%A8%A1%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>注册中心模型</h3>\n<p>注册中心保存着各个服务实例的元数据，涉及的角色包括如下三种。</p>\n<ul>\n<li>注册中心：提供服务注册和发现能力。</li>\n<li>服务提供者：将自身注册到注册中心，供服务消费者进行调用。</li>\n<li>服务消费者：从注册中心获取服务提供者的元数据，并发起远程调用。</li>\n</ul>\n<p>上述三个角色比较简单，但注册中心的具体组成结构还是有一些额外的特性。首先，注册中心本身可以认为是一种服务器，它也提供了对应的客户端组件。各个服务需要嵌入客户端组件才能完成与注册中心服务器之间的交互。然后，为了提高访问效率，服务的消费者一般都会构建一个本地缓存，用来保存那些已经访问过的服务实例元数据。</p>\n<p>下图展示了服务与注册中心的交互过程：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-13-10-08-06-174fe4ff32b47785a1229471829b5e92-efa6e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 603px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 52.57048092868989%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAACE0lEQVQoz4WS2W7TUBCG/T6Fq3KLuEBCRSD1hneAC3gMKlqJV0BcVaUVAlWBbkASaJFKoEmTKl7ipdlMFZLYWUgcm+Tj2ElKFFVi5N9zPGf+8WwSExmNRhFC6fZ8zI9PqB3cwYrdx9i+i72/TCV2C+Pr88hnOAwuOVNeKNKs8V/AgIvDx3iHt6nsLFF6v0Qzfo9O/Cbl47UJdcg8N4QkchPPcAxx7vd7tNstXKeBXpC5sEviXKNcMjF0lX6vi+f1cMT9PDcKOBqbmSYd/IF218MPuFIGPvwWFfS94bhVc3zJKnxCl3cxlL0I6tk7lFwMU9grFXna4ehdrcqRXcnG0PO7Y56Ant8hjKNpRyLg7jLFresoG4sU39xAeyX01gJ64iFWKYXXHxAEPp12F1U/wvr8iPLrBfLri5Qm/tbmNcy9B8jKNpJTfEE584zC8VP0byFWsHNrOJV1kWGKZtPFskxqtTqG8YXWzw2qp6vCfwUztRJxqtlVnOJLLHMHqdM9o9bIiL8nyatxNKEbbo5G8zul4slkRcb9KpfTNN0fkb+sJVC0JEohSa2eodXOoioHSKqioqm6gIEsa2KyFudWUUzRxZ9MZrpOAzERx2nRcluiBZ0xOp3o2xX+vZ6HFDrZtiECpUifJDg/T1P/ZTO78LP6fyL5/lBMLy3K2+c0/ZZq5QN2VSGscj7YVYsctiMIgkv8BUnkIvUB/esSAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 13 10 08 06" title="" data-src="/static/2024-11-13-10-08-06-174fe4ff32b47785a1229471829b5e92-efa6e.png" data-srcset="/static/2024-11-13-10-08-06-174fe4ff32b47785a1229471829b5e92-b4d75.png 200w,\n/static/2024-11-13-10-08-06-174fe4ff32b47785a1229471829b5e92-f2144.png 400w,\n/static/2024-11-13-10-08-06-174fe4ff32b47785a1229471829b5e92-efa6e.png 603w" data-sizes="(max-width: 603px) 100vw, 603px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在上图中，基本的工作流程通过操作语义即可理解。但有一个问题需要解决，即一旦服务的运行时状态发生了变更，我们如何有效获取这些变更信息呢？这就需要在注册中心中进一步引入变更通知机制，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-13-10-08-48-81107f40cdb4ffe04d3ffbd613d40e54-3e989.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 605px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 52.396694214876035%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAACGElEQVQoz1VSTW/aQBD172qlNOmpbQ5V0t6i/qAoH8eqUjmk6qU95YukQGhpkqpqlDgqxijYUMCAMbHBBgPxB9ivswYUWGk0u7Nv3pvdGQ7TFYYh5le7KUNNrkJLraJ09BKV+CvoZy9QT2/AsqwF7Hwuxw6zwHg8xmDQj/YVmYd2tgY98xbS4WtUTtdhnq+hmnqHdrsdYYbDQZQzI2XGTTWmhCN0uxYc5yECu65Hfgjfd6M713Vh23145F3CWJYZxec5OM/z4ZOIHxAhxR68AK4fRnvH8WCaJnTdgDGtajQOJneEc6Y4lss4HMcBJ0sZ5K8+QLjYgnC5g+z5Nm7Sm+C/b+JO3CciFT4T9X2qSEdJOoH4axe5y138/blFfge5i22If95DVX+Dq1aS0DJvoB4/QS2+jObpCtky7hNLaEgxtPQa7J5NT7UhySLU4idY6SVUD59BSzxH89sKtJOn0H6s05fw4BQlib6ZQKP8FeJtDDn+I8p3n9FW99ExUvTcKjodk/62B0WRYHczdHeAgrAHkY+hkN1DvfQFndYxveSKEQrQNFJWRRRLN5Dla0rMwjCkKN63H0dk0O+hpeXpX0toNEQoNQH1eo5EJRItQmuK4IZDl8juUVNUIvuHQkFGuaxQUg+z8ZofrYAaMBqFkWehkDWTGsKazc7cBBRQVdfIi3Hc8geolDPUAGNCxjIXBnjRHsWYD/Af9HvZaVEeP+UAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 13 10 08 48" title="" data-src="/static/2024-11-13-10-08-48-81107f40cdb4ffe04d3ffbd613d40e54-3e989.png" data-srcset="/static/2024-11-13-10-08-48-81107f40cdb4ffe04d3ffbd613d40e54-4bd12.png 200w,\n/static/2024-11-13-10-08-48-81107f40cdb4ffe04d3ffbd613d40e54-7acd9.png 400w,\n/static/2024-11-13-10-08-48-81107f40cdb4ffe04d3ffbd613d40e54-3e989.png 605w" data-sizes="(max-width: 605px) 100vw, 605px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>从设计理念上讲，我们希望这种来自注册中心的变更通知能够实时地同步到服务消费者，这时候就可以引入推送思想。那么，如何具体实现推送呢？我们可以采用监听机制。所谓监听机制，指的就是服务消费者对位于注册中心的元数据添加监听器，一旦元数据发生变化，就可以触发监听器中的回调函数。</p>\n<p>我们可以在回调函数中对已变更的元数据执行任何操作，如下所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-13-10-09-24-b4ea07ca06d5f84e094962f7a0c2d28d-73362.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 609px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 46.14121510673235%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABpUlEQVQoz4WS6W7TUBBG/f7vwA9ALIoQokGACqqEQDR70ya2E+LUNRGJ42yO4yzeD2O3VBVEMNKn0ZU93505d5Th8JyefoYx+Mx0+pPB9ybdzmt0tYyuvaXfO2EwqHI4RERRSJZl5JHnY1Icx8CeaDhOj9Vyga5XqdeeiV7SbJRoNV8wNOokSUYU56YR2Z3hMWOFPyJJEjYb/17rtcdutyOOY1L5lqXp/b+/TR+GEgRbwnBLEPjF7a7rMJsZzOfXLOam5CGeNyOvncoElm0zWS7x5ZKZ4wiKvdSJwlwHFF075eryDWq3zA/LoNP5Qr36iEbtsYz8lMv2Ey7aH1k4CypTm/JoxHsxbZomG3ctqEbC+R3dqxOp/4ay222lAxff92TcVB7GkgeqiGoFO/O6Jl2OinFm7gpzPL7tcL+/QxSz8daCZkXu9RfDPKIoE2a3CsJUzknBMBHxgNtRhrbdZzJWsW1N+C25uVHR1A+ySp/o988kn8ooXdJULpBu/vvKltWQ8b5iWefCYyxrU+Gi9Zx2qyT8XqF2SgWCIIiLPcy3gH8Y/gIcwqPudF11uAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 13 10 09 24" title="" data-src="/static/2024-11-13-10-09-24-b4ea07ca06d5f84e094962f7a0c2d28d-73362.png" data-srcset="/static/2024-11-13-10-09-24-b4ea07ca06d5f84e094962f7a0c2d28d-06e0b.png 200w,\n/static/2024-11-13-10-09-24-b4ea07ca06d5f84e094962f7a0c2d28d-70531.png 400w,\n/static/2024-11-13-10-09-24-b4ea07ca06d5f84e094962f7a0c2d28d-73362.png 609w" data-sizes="(max-width: 609px) 100vw, 609px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可以看到，服务消费者可以对具体的服务实例节点添加监听器，当这些节点发生变化时，注册中心就能触发监听器中的回调函数确保更新通知到每一个服务消费者。显然，使用监听和通知机制具备实时的数据同步效果。</p>\n<h3 id="注册中心实现工具"><a href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0%E5%B7%A5%E5%85%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>注册中心实现工具</h3>\n<p>以上关于注册中心的讨论为我们提供了理论基础。根据这些理论基础，业界也诞生了很多具体的实现工具，常见的包括 Consul 、Zookeeper、Eureka 和 Nacos 等。我们无意对这些工具做一一展开。在本讲中，我们将基于 Zookeeper 来具体分析注册中心的实现模型。Zookeeper 是基于监听和通知机制的典型框架。</p>\n<p>从物理结构上讲，Zookeeper 就是一个目录树，包含了一组被称为 ZNode 的节点，它的基本结构如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-13-10-10-11-f004736745103b97175701e54327d3ea-3e989.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 605px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 39.83471074380166%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABhklEQVQoz2VS2U7DQAzM/38JvCEeigRShRCoVIGmJYI2R3Mn3UKT3leuYbJ9KKgrWYntHc/YXgWo8d/O53jMYdvPCPwH+N4DRsN7xg64PGe80rhlCVTVKVUUNbbbI9brPbJsjjj2ISYhgmDMf0/GVqsdNpuDvFtVJxENvjHFc1UksUoVr3BdG76v8/sCY9RGkjhYLIRUaZlPLBZIAsN4pOIOLKtLP4Iz7iAKVUySHhQhhoijPsJQYzEXUWQw2SPJgCoyqvmBEDpmsy+kaYD1aoHp9FNi0tTFfr8jtkdfw/e3DiVNI5imRtAYy+WCRU24jk5VAwJjxiMy2ySwWHwmC8SxKTFZllxMU2la0T9alP1IxinBQ7yrt/gYtOiHbNvC+9sNtN4tC30inQmYRpv5O7atcv6VXEZdV9KUsqzlMIuiCYBtruC5FgsFOBz254Ez1+SLIseES3Ickx3NLxX+dfK8ZMtd9LVraNoVgaPTo5Dsp20K4WFst0h6x8Xd80WsSViRqJD2C5T/VyY4RWxTAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 13 10 10 11" title="" data-src="/static/2024-11-13-10-10-11-f004736745103b97175701e54327d3ea-3e989.png" data-srcset="/static/2024-11-13-10-10-11-f004736745103b97175701e54327d3ea-4bd12.png 200w,\n/static/2024-11-13-10-10-11-f004736745103b97175701e54327d3ea-7acd9.png 400w,\n/static/2024-11-13-10-10-11-f004736745103b97175701e54327d3ea-3e989.png 605w" data-sizes="(max-width: 605px) 100vw, 605px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在上图中，size 节点位于 <code class="language-text">/business/product/size</code> 路径，节点 C 可以存储数据 350，而节点 <code class="language-text">/D/order/1</code> 可能存储着类似 <code class="language-text">{&quot;id&quot;:&quot;1&quot;,&quot;itemName&quot;:&quot;Notebook&quot;,&quot;price&quot;:&quot;4000&quot;,createTime=&quot;2022-06-16 22:39:15&quot;}</code> 等复杂数据结构和信息。Zookeeper 中所有数据通过 ZNode 的路径被引用。</p>\n<p>Zookeeper 特性很多，我们可以从注册中心的基本实现需求出发，结合模型及其操作来把握用于构建注册中心的相关技术。</p>\n<p>首先，Zookeeper 专门设计并实现了一个监听器组件。我们可以在任何一个 ZNode 上添加监听器，并实现对应的回调函数，从而确保服务器端的变化能够通过回调机制通知到客户端。</p>\n<p>另一方面，Zookeeper 中也提供了临时节点的概念。所谓临时节点，指的是只要客户端与 Zookeeper 的连接发生中断，那么这个节点就会自动消失。显然，临时节点的这种特性可以用于控制该节点所包含的服务定义元数据的时效性。</p>\n<p>ZNode 是 Zookeeper 中可以用代码进行控制的主要实体。对 ZNode 的基本操作包括节点创建 create、删除 delete、获取子节点 getChildren 以及获取和设置节点数据的 getData/setData 方法。操作 Zookeeper 的客户端组件包括自带的 ZooKeeper API 和第三方 zkClient、Curator 等，这些客户端都对 Zookeeper 连接资源管理和对 ZNode 节点的各项操作做了不同程度的封装。</p>\n<p>Zookeeper 中涉及的主要操作如下表所示，在源码解读过程中，我们会发现对 Zookeeper 的控制基本都是对这些操作的封装和应用。</p>\n<table>\n<thead>\n<tr>\n<th align="left">操作</th>\n<th align="left">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">create</td>\n<td align="left">在 ZooKeeper 命名空间的指定路径中创建一个 ZNode</td>\n</tr>\n<tr>\n<td align="left">delete</td>\n<td align="left">从 ZooKeeper 命名空间的指定路径中删除一个 ZNode</td>\n</tr>\n<tr>\n<td align="left">exists</td>\n<td align="left">检查路径中是否存在 ZNode</td>\n</tr>\n<tr>\n<td align="left">getChildren</td>\n<td align="left">获取 ZNode 的子节点列表</td>\n</tr>\n<tr>\n<td align="left">getData</td>\n<td align="left">获取与 ZNode 相关的数据</td>\n</tr>\n<tr>\n<td align="left">setData</td>\n<td align="left">将数据设置/写入 ZNode 的数据字段</td>\n</tr>\n<tr>\n<td align="left">getACL</td>\n<td align="left">获取 ZNode 的访问控制列表（ACL）策略</td>\n</tr>\n<tr>\n<td align="left">setACL</td>\n<td align="left">在 ZNode 中设置访问控制列表（ACL）策略</td>\n</tr>\n<tr>\n<td align="left">sync</td>\n<td align="left">将客户端的 ZNode 视图与 ZooKeeper 同步</td>\n</tr>\n</tbody>\n</table>\n<p>介绍完注册中心模型以及 Zookeeper 框架，让我们回到 Dubbo。作为一款主流的分布式服务框架，Dubbo 也内置了一整完整的注册中心实现方案，默认采用的就是 Zookeeper。</p>\n<h2 id="源码解析-10"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-10" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h2>\n<p>在 Dubbo 内部，提供了 Multicas、Zookeeper、Redis、Nacos、Consul、Etcd3 等一大批注册中心实现方式。我们先从它的注册中心模型开始讲起。</p>\n<h3 id="dubbo-注册中心模型"><a href="#dubbo-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%A8%A1%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dubbo 注册中心模型</h3>\n<p>Dubbo 中的注册中心代码位于 dubbo-registry 工程中，其中包含了一个 dubbo-registry-api 工程，该工程包含了 Dubbo 注册中心的抽象 API，而剩下的 dubbo-registry-default、dubbo-registry-zookeeper、dubbo-registry-nacos 等工程则是这些 API 的具体实现，分别对应前面提到的各种注册中心实现方式。我们同样无意对所有这些注册中心实现方式做详细展开，而是重点关注抽象 API 以及基于 Zookeeper 的实现方式。</p>\n<p>我们首先来看一下 dubbo-registry-api 工程，这里面最核心的就是如下所示的 RegistryService 接口：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43174283222073660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface RegistryService {\n   // 注册\n   void register(URL url);\n   // 取消注册\n   void unregister(URL url);\n   // 订阅\n   void subscribe(URL url, NotifyListener listener);\n   // 取消订阅\n   void unsubscribe(URL url, NotifyListener listener);\n   // 根据 URL 查询对应的注册信息\n   List<URL> lookup(URL url);\n}`, `43174283222073660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RegistryService</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 注册</span>\n   <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 取消注册</span>\n   <span class="token keyword">void</span> <span class="token function">unregister</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 订阅</span>\n   <span class="token keyword">void</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">NotifyListener</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 取消订阅</span>\n   <span class="token keyword">void</span> <span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">NotifyListener</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 根据 URL 查询对应的注册信息</span>\n   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">></span></span> <span class="token function">lookup</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>请注意，RegistryService 所有操作的对象都是 URL，而订阅相关的操作中还附加了监听器 NotifyListener，确保变更信息的推送。从命名上我们已经可以初步猜想 Dubbo 在注册信息变更时采用的就是监听和通知机制。通过确认 NotifyListener 接口的定义更加明确了我们的猜想，因为该接口中只有一个 notify 方法，用于将发生变更的注册信息以 URL 的形式进行通知，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5480985156544382000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface NotifyListener {\n   void notify(List<URL> urls);\n}`, `5480985156544382000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">NotifyListener</span> <span class="token punctuation">{</span>\n   <span class="token keyword">void</span> <span class="token function">notify</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">></span></span> urls<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>我们再来看 RegistryFactory 接口，如下所示。这里的 <code class="language-text">@SPI(&quot;dubbo&quot;)</code> 注解我们会在后面介绍微内核模式时进行介绍，代表默认情况下使用 Dubbo 自身的注册中心。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11112672131836620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@SPI(&quot;dubbo&quot;)\npublic interface RegistryFactory {\n   Registry getRegistry(URL url);\n}`, `11112672131836620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@SPI</span><span class="token punctuation">(</span><span class="token string">"dubbo"</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RegistryFactory</span> <span class="token punctuation">{</span>\n   <span class="token class-name">Registry</span> <span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从接口的命名上可以看出 RegistryFactory 是 Dubbo 中创建注册中心的工厂类，通过对 RegistryFactory 的实现，Dubbo 提供了 Zookeeper、Redis 等几种不同的注册中心实现方案。</p>\n<p>可以说 Dubbo 中关于注册中心 API 层的抽象简单而清晰，比较适合先用来做对全局代码结构的把握。在这层 API 抽象之下，我们重点介绍 ZookeeperRegistry 和 ZookeeperRegistryFactory。</p>\n<h3 id="zookeeper-注册中心实现过程"><a href="#zookeeper-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Zookeeper 注册中心实现过程</h3>\n<p>让我们来到 Dubbo 源码，来看一下 ZookeeperRegistry 的实现过程，而 ZookeeperRegistry 中最重要的就是它的构造函数，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73948526852661250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public ZookeeperRegistry(URL url, ZookeeperTransporter zookeeperTransporter) {\n   // ...\n   // 建立与 Zookeeper 的连接\n   zkClient = zookeeperTransporter.connect(url);\n   // 添加状态监听器\n   zkClient.addStateListener(new StateListener() {\n      public void stateChanged(int state) {\n         if (state == RECONNECTED) {\n            try {\n               recover();\n            } catch (Exception e) {\n               logger.error(e.getMessage(), e);\n            }\n         }\n      }\n   });\n}`, `73948526852661250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">ZookeeperRegistry</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">ZookeeperTransporter</span> zookeeperTransporter<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// ...</span>\n   <span class="token comment">// 建立与 Zookeeper 的连接</span>\n   zkClient <span class="token operator">=</span> zookeeperTransporter<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 添加状态监听器</span>\n   zkClient<span class="token punctuation">.</span><span class="token function">addStateListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StateListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stateChanged</span><span class="token punctuation">(</span><span class="token keyword">int</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> RECONNECTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">try</span> <span class="token punctuation">{</span>\n               <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，这里执行了两个操作，一个是与 Zookeeper 建立连接，另一个就是添加了用于断线重连的状态监听器。根据对 Zookeeper 基本操作的了解和掌握，上述实现过程都是使用 Zookeeper 时的常规步骤。</p>\n<p>为了理解这段代码，我们需要明确另外两个核心对象的创建过程，这两个核心对象分别是 ZookeeperTransporter 和 ZookeeperClient。我们发现 ZookeeperTransporter 是在 ZookeeperRegistryFactory 工厂类创建 ZookeeperRegistry 时带进来的，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34498712744823390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class ZookeeperRegistryFactory extends AbstractRegistryFactory {\n   private ZookeeperTransporter zookeeperTransporter;\n\n   public void setZookeeperTransporter(ZookeeperTransporter zookeeperTransporter) {\n      this.zookeeperTransporter = zookeeperTransporter;\n   }\n\n   public Registry createRegistry(URL url) {\n      return new ZookeeperRegistry(url, zookeeperTransporter);\n   }\n}`, `34498712744823390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZookeeperRegistryFactory</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractRegistryFactory</span> <span class="token punctuation">{</span>\n   <span class="token keyword">private</span> <span class="token class-name">ZookeeperTransporter</span> zookeeperTransporter<span class="token punctuation">;</span>\n\n   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setZookeeperTransporter</span><span class="token punctuation">(</span><span class="token class-name">ZookeeperTransporter</span> zookeeperTransporter<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>zookeeperTransporter <span class="token operator">=</span> zookeeperTransporter<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">public</span> <span class="token class-name">Registry</span> <span class="token function">createRegistry</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ZookeeperRegistry</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> zookeeperTransporter<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>ZookeeperTransporter 本身是一个接口，定义也比较简单，就是根据传入的 URL 创建与 Zookeeper 服务器的连接并获取一个 ZookeeperClient 对象，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33529606719118488000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@SPI(&quot;zkclient&quot;)\npublic interface ZookeeperTransporter {\n   @Adaptive({ Constants.CLIENT_KEY, Constants.TRANSPORTER_KEY })\n   ZookeeperClient connect(URL url);\n}`, `33529606719118488000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@SPI</span><span class="token punctuation">(</span><span class="token string">"zkclient"</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ZookeeperTransporter</span> <span class="token punctuation">{</span>\n   <span class="token annotation punctuation">@Adaptive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>CLIENT_KEY<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>TRANSPORTER_KEY <span class="token punctuation">}</span><span class="token punctuation">)</span>\n   <span class="token class-name">ZookeeperClient</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>另一方面，在 ZookeeperClient 接口的定义中包含了注册中心运行过程中所有的数据操作，如创建和删除路径、获取子节点、添加和删除 Listener、获取 URL 等实现发布订阅模式的入口。这些方法名与 Zookeeper 原生操作基本一致，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50477475178778450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface ZookeeperClient {\n   void create(String path, boolean ephemeral);\n   void delete(String path);\n   List<String> getChildren(String path);\n   List<String> addChildListener(String path, ChildListener listener);\n   void removeChildListener(String path, ChildListener listener);\n   void addStateListener(StateListener listener);\n   void removeStateListener(StateListener listener);\n   boolean isConnected();\n   void close();\n   URL getUrl();\n}`, `50477475178778450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ZookeeperClient</span> <span class="token punctuation">{</span>\n   <span class="token keyword">void</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ephemeral<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">addChildListener</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">ChildListener</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">void</span> <span class="token function">removeChildListener</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">ChildListener</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">void</span> <span class="token function">addStateListener</span><span class="token punctuation">(</span><span class="token class-name">StateListener</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">void</span> <span class="token function">removeStateListener</span><span class="token punctuation">(</span><span class="token class-name">StateListener</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">boolean</span> <span class="token function">isConnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token class-name">URL</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>目前可以与 Zookeeper 服务器进行交互的客户端有很多，Dubbo 中提供了对 Zkclient 和 Curator 这两个客户端工具的集成，对应的 Transporter 和 ZookeeperClient 实现类见下图。Dubbo 使用 Zkclient 作为其默认实现。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-13-11-14-06-2363ab524e92ddda83af9677cc604ece-e9054.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 585px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 88.03418803418805%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsSAAALEgHS3X78AAAC0klEQVQ4y4VUaVMaQRTk//+CVBlNPFBirCQGjNEP8QCXa3c5FkGO5VgQ5RCEBcVwdHpn5UoRM1Wv5qCn971+PTjw15hMxmLO5WSkb9yQwwcIBfeRSR8hr1/CNHuvuMnKcMyJpoc2YT4fQjKxj4jiYnxCPOaCUTpHtzsnXDWWCK0xHtuEyWuJ2e0hoh6Q8ABR9TNU9QhPT4MF/BsZLpIOh2Nm0md5fdRqDZRKZbHudEwMBsOliv6b4Wg0QbEYo34XyGUlpJIXyGa8XF9RRy/XEvr9f5ftWNZuIjJIaD+hKh8YO4xtKPIWlPAWtJiT8y5areZMnsVylzJcHJWKjnSaXU6HYRgJEfl8FMlkAHpOw8vL75UNERre3xmo18uzeGjekrCAQj5DzToz8HA44bmBUjGLeq2MRr2CZqMi5lrNYNYNO0NVdiEU2EY45GR5e6KkIPfx2C6bEcNr09Fut6nrEbvuhByiFPIuXeBEPLrPu5vU99Im1OIeCn2CbPoEWvwQN6lj7k/ZDA+NrM0y7HS6uE6cEncssAnNTWt5kCM2ef2d9ySb0Ow+EdxHz3xmmVbqXVhnj489UeZiN3u9ATo8t2bDqKJ23xRrC/v8bNvJoecU6LpCMpWCy8xKRaEQEeVmMyF+rCWApdINf5OJi4iwcNbztLDFYhRFztmsBkdAWofvcg2S7z183jWEgx8RkDZE+K/WUL3NCUJFcRPzDn5xvo4r4gP+Der9QdyNqjs4++WCo1QM8mv+15DEbBm4bIRpGy/arbog1PUYOxxgJiFh8vkdO/Scnw3zrfah1dm7u7rQyOya1OiRWvVpm3tUqzW8NRzTVzINa5hmh9mco/UgiS4mNA/07Al95+P52UxX+6UshwPTZ7PwfCzChPYV6dQXarmJoJ9Pj76z9pm0e0b45p/DIqDb7dCs33CT/EE/HgufWv5Mca8qh5RgnqEVo9Fotv4D/LIzd/MTeK0AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 13 11 14 06" title="" data-src="/static/2024-11-13-11-14-06-2363ab524e92ddda83af9677cc604ece-e9054.png" data-srcset="/static/2024-11-13-11-14-06-2363ab524e92ddda83af9677cc604ece-5fafc.png 200w,\n/static/2024-11-13-11-14-06-2363ab524e92ddda83af9677cc604ece-0bfa6.png 400w,\n/static/2024-11-13-11-14-06-2363ab524e92ddda83af9677cc604ece-e9054.png 585w" data-sizes="(max-width: 585px) 100vw, 585px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>接下来终于到了分析注册中心具体操作的时候了，ZookeeperRegistry 提供了 doRegister、doUnregister、doSubscribe 和 doUnsubscribe 方法分别对应注册/取消注册、订阅/取消订阅这四个具体操作。</p>\n<p>我们首先来看一下注册方法 doRegister，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81186727814593310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`protected void doRegister(URL url) {\n   try {\n      zkClient.create(toUrlPath(url),\n      url.getParameter(Constants.DYNAMIC_KEY, true));\n   } catch (Throwable e) {\n      // ...\n   }\n}`, `81186727814593310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doRegister</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      zkClient<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token function">toUrlPath</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">,</span>\n      url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>DYNAMIC_KEY<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// ...</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>不难看出，注册操作的实现方式就是在 Zookeeper 中创建一个节点。请注意，默认创建的节点都是临时节点，当连接断开之后会自动删除。对应的，我们也不难想象取消注册的实现方式就是删除这个临时节点，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75357240584035800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`protected void doUnregister(URL url) {\n   try {\n      zkClient.delete(toUrlPath(url));\n   } catch (Throwable e) {\n      // ...\n   }\n}`, `75357240584035800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doUnregister</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      zkClient<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token function">toUrlPath</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// ...</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们再来看订阅过程。在订阅 URL 过程中，Dubbo 将传入的回调接口 NotifyListener 转换成 Zookeeper 中的 ChildListener，并主动根据服务提供者 URL 调用 NotifyListener。</p>\n<p>doSubscribe 方法比较长，我们提取其中的核心代码，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73756847118301100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ChildListener zkListener = listeners.get(listener);\nif (zkListener == null) {\n   // 添加子节点监听器\n   listeners.putIfAbsent(listener, new ChildListener() {\n      public void childChanged(String parentPath, List<String>  currentChilds) {\n         for (String child : currentChilds) {\n            child = URL.decode(child);\n            if (!anyServices.contains(child)) {\n               anyServices.add(child);\n               subscribe(url.setPath(child).addParameters(Constants.INTERFACE_KEY, child, Constants.CHECK_KEY, String.valueOf(false)), listener);\n            }\n         }\n      }\n   });\n   zkListener = listeners.get(listener);\n}`, `73756847118301100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">ChildListener</span> zkListener <span class="token operator">=</span> listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>zkListener <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 添加子节点监听器</span>\n   listeners<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ChildListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">childChanged</span><span class="token punctuation">(</span><span class="token class-name">String</span> parentPath<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span>  currentChilds<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> child <span class="token operator">:</span> currentChilds<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            child <span class="token operator">=</span> URL<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>anyServices<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               anyServices<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>\n               <span class="token function">subscribe</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addParameters</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>INTERFACE_KEY<span class="token punctuation">,</span> child<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>CHECK_KEY<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   zkListener <span class="token operator">=</span> listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，Dubbo 会订阅父级目录, 而当有子节点发生变化时就会触发 ChildListener 中的回调函数，该回调函数会对该路径下的所有子节点执行 subscribe 操作。</p>\n<p>而取消订阅 URL 的过程实际上只是去掉 URL 上已经注册的监听器，doUnsubscribe 方法如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44520587366634955000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`protected void doUnsubscribe(URL url, NotifyListener listener) {\n   ConcurrentMap<NotifyListener, ChildListener> listeners = zkListeners.get(url);\n   if (listeners != null) {\n      ChildListener zkListener = listeners.get(listener);\n      if (zkListener != null) {\n         // 取消子节点监听器\n         zkClient.removeChildListener(toUrlPath(url), zkListener);\n      }\n   }\n}`, `44520587366634955000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doUnsubscribe</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">NotifyListener</span> listener<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NotifyListener</span><span class="token punctuation">,</span> <span class="token class-name">ChildListener</span><span class="token punctuation">></span></span> listeners <span class="token operator">=</span> zkListeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>listeners <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token class-name">ChildListener</span> zkListener <span class="token operator">=</span> listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>zkListener <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token comment">// 取消子节点监听器</span>\n         zkClient<span class="token punctuation">.</span><span class="token function">removeChildListener</span><span class="token punctuation">(</span><span class="token function">toUrlPath</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">,</span> zkListener<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>到此为止，ZookeeperRegistry 类中的构造函数和核心方法已经分析完毕。你看到这里可能会好奇，doRegister、doUnregister、doSubscribe 和 doUnsubscribe 这四个方法是在哪里被调用的呢？毕竟 ZookeeperRegistry 本来应该实现的是 RegistryService 接口中的 register、unregister、subscribe 和 unsubscribe 方法才对。</p>\n<p>通过阅读代码，我们发现 ZookeeperRegistry 并不是 RegistryService 的直接实现类，从类层结构上，ZookeeperRegistry 扩展了 FailbackRegistry，而 FailbackRegistry 又扩展了 AbstractRegistry，注意 FailbackRegistry 和 AbstractRegistry 都是抽象类。而前面提到的这些方法在 RegistryService 不同层级的实现类中被调用，这里面涉及到的类层结构如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-13-11-18-20-51c590fdd7d32310c9ba0e0de8076037-ad3a8.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 396px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 74.74747474747474%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAACWklEQVQ4y41Ti1LaUBTM//9AHbXKtNUiSG1xVOT9jhAxCRDAEEC0kUcr0hFQq2S7CcXa2hk5MztncnPu3nPu7hUkKQpZ9iGf20Ym7UaWyB15US75mT+h1+vBDsuaEng1BKMu4uZHEoa+C+XEQ2yhWtnBZCRi8D2NS/NyRjglIRYgLBXjEDMuHOy/QTrpQjy6ipy4gZOCG4r8p8PpdMEOc7kAGsYO2mcHxD4uzgM4a+7BvAiQ1AvTNJ8IFwmh3TZQqRyj0SjxLjNIJA5gGEXouoxaTcF4PP59h5aDWacvMV8XnrPbIw2H4xenzoqtxTpUFZEjy+zqxMmnNcnJzaZCpbO4uvr2VGya5xQsj2ZD5UQK97COudVUoZ/aU9YgiNkNZFJrtIwLaebQ4RJSibdIxFZR1bzQNAk3NyPc3f1ERRNRkN4hFFxCNmMLuIJoZBlx1ko5F//HIYSDq7TMZ5SLXlTK29AIVXaTzEdR3vNOA7i+HuL+/oFejbBrNzf6nDpD96OobqGkelBUNunbfQippJ9jxlkUdVC1UYlxLQEpv0sftp9G1vUSD9lz/mvlCKfy8YAwatU4VCVAm2Vnojw+WgReYO6UucL/Rr3ewu3tw9+i2FLDeQP/x5xoOrXQ73coUgeDqy7d0KdIZ1wzMbzuYzDootv5ahNaeA12jMe3EEUfUklbsDUkE+uI8VWFQyuIhJe5vo78kWdG6HTj7Jt39tybs+/RaILC8RdoJQ+V3qSqH5wsFz46T9cW5jhPQixIOJnc4Uj003eHMOpBejXIfOigwe9WK0QrbeMX6oJMCSG86K8AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 13 11 18 20" title="" data-src="/static/2024-11-13-11-18-20-51c590fdd7d32310c9ba0e0de8076037-ad3a8.png" data-srcset="/static/2024-11-13-11-18-20-51c590fdd7d32310c9ba0e0de8076037-2a85e.png 200w,\n/static/2024-11-13-11-18-20-51c590fdd7d32310c9ba0e0de8076037-ad3a8.png 396w" data-sizes="(max-width: 396px) 100vw, 396px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>我们继续往下看，发现真正调用 doRegister、doUnregister、doSubscribe 和 doUnsubscribe 这四个方法的地方分别是在 FailbackRegistry 对应的 register、unregister、subscribe 和 unsubscribe 方法中，这点自然比较好理解。但我们发现这四个方法还同时出现在 FailbackRegistry 的 retry 方法中。事实上，在 FailbackRegistry 构造函数中会创建一个定时任务，每隔一段时间执行该 retry 方法。</p>\n<p>在这个 retry 方法，以注册场景为例（其他场景也类似），我们从注册失败的集合中获取 URL，然后对每个 URL 执行 doRegister 操作从而实现重新注册，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93527171245538120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (!failedRegistered.isEmpty()) {\n   Set<URL> failed = new HashSet<URL>(failedRegistered);\n   if (failed.size() > 0) {\n      try {\n         for (URL url : failed) {\n            try {\n               // 重新注册\n               doRegister(url);\n               failedRegistered.remove(url);\n            } catch (Throwable t) {\n               // ...\n            }\n         }\n      } catch (Throwable t) {\n         // ...\n      }\n   }\n}`, `93527171245538120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>failedRegistered<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">></span></span> failed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">></span></span><span class="token punctuation">(</span>failedRegistered<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">try</span> <span class="token punctuation">{</span>\n         <span class="token keyword">for</span> <span class="token punctuation">(</span>URL url <span class="token operator">:</span> failed<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">try</span> <span class="token punctuation">{</span>\n               <span class="token comment">// 重新注册</span>\n               <span class="token function">doRegister</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n               failedRegistered<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token comment">// ...</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token comment">// ...</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 RegistryService 还有最后一个 lookup 方法，其作用是根据 URL 查询对应的注册信息。基于 Zookeeper，这个方法的实现也比较简单，我们只需要通过 Zookeeper 提供的 getChildren 方法获取某个 ZNode 的子节点即可，这里不做展开，你可以参加 Dubbo 源码进行学习。</p>\n<h2 id="解题要点-12"><a href="#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-12" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解题要点</h2>\n<p>关于注册中心的基本模型是回答任何与这一主题相关面试题的基本要点。这部分内容属于理论知识，内容也比较固定。我们可以从注册中心的诞生背景、作用、组成结构等方面进行展开，并重点提及数据变更通知特性，这一特性体现了不同注册中心之间在设计理念和运行机制上的差别。</p>\n<p>然后，关于注册中心的实现，我们需要结合具体场景和诉求来讨论。本讲中我们讨论的是 <code class="language-text">具备实时通知能力的注册中心模型</code>，因此关注的是那些具有实时数据监听和推送功能的开源框架，例如 Zookeeper。Zookeeper 是一款非常经典的分布式协调框架，也是 Dubbo 框架的默认注册中心实现工具，所以在讨论过程中实际上也需要对 Dubbo 框架有足够的掌握。</p>\n<p>从注册中心的实现类型而言，Zookeeper 是基于推送机制完成注册信息变更通知的代表性框架。Zookeeper 能够做到这一点是因为它内置了功能强大的监听器。当 Zookeeper 客户端通过会话机制与服务器建立连接并维持心跳检测之后，任何对 Zookeeper 节点的新增、更新和删除操作都会触发监听器上的回调函数，从而完成服务定义的动态更新。这是基于 Zookeeper 实现一款注册中心的核心流程。当然，我们在回答这道题时，也可以从 Zookeeper 中对服务注册信息的定义、存储等方面做进一步展开。</p>\n<h2 id="小结与预告-10"><a href="#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-10" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结与预告</h2>\n<p>作为总结，我们明确注册中心就是这样一种服务治理工具：管理系统中所有服务实例的运行时状态，并能够把这些状态的变化同步到各个服务中。注册中心的实现有不同的策略，业界也诞生了一批不同类型的注册中心实现工具。本讲所阐述的 Zookeeper 是其中的代表性框架之一，具备实时通知能力。</p>\n<p>请注意，并不是所有的注册中心都采用的是和 Zookeeper 一样的监听和推送机制，我们也可以采用定时更新策略来获取注册中心中最新的元数据。那么，如果采用定时更新策略来设计注册中心，这个过程有哪些注意点呢？这就是下一讲要讨论的内容。</p>\n<h1 id="注册中心：如果采用定时更新策略来设计注册中心，有哪些注意点？"><a href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%EF%BC%9A%E5%A6%82%E6%9E%9C%E9%87%87%E7%94%A8%E5%AE%9A%E6%97%B6%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5%E6%9D%A5%E8%AE%BE%E8%AE%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%EF%BC%8C%E6%9C%89%E5%93%AA%E4%BA%9B%E6%B3%A8%E6%84%8F%E7%82%B9%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>注册中心：如果采用定时更新策略来设计注册中心，有哪些注意点？</h1>\n<p>上一讲我们进入到了注册中心这一技术组件的讨论，我们给出了注册中心的基本模型，并基于 Zookeeper 框架分析了 <code class="language-text">具备实时通知能力的注册中心</code> 的实现方式。</p>\n<p>本讲继续讨论注册中心，并关注另一种实现方式，即采用定时更新策略的注册中心。可以说，这两种注册中心的设计思想和实现方式完全不同。</p>\n<p>那么，如果我们采用的是定时更新策略，应该如何获取最新的服务实例元数据呢？本讲内容将围绕这个话题进行展开。在日常开发过程中，关于定时更新策略的应用场景实际上非常多，也是面试过程中经常会出现的考查点。因此，本讲内容中所介绍的实现过程中也有很多值得深入分析和学习的开发和面试技巧。</p>\n<h2 id="问题背景-10"><a href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-10" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题背景</h2>\n<p>与注册中心相关的问题背景，我们在上一讲中已经介绍了很多，这里不再重复展开。在本讲中，因为我们是围绕 <code class="language-text">如果采用定时更新策略来设计注册中心</code> 这一话题进行展开，所以这里也列举在面试过程中与这个话题相关的一些常见面试题：</p>\n<ul>\n<li>如果采用轮询机制来获取注册中心中的数据，你会选择什么样的实现技术？</li>\n<li>在定时更新过程中，客户端如何判断位于注册中心中的数据已经发生了变化？</li>\n<li>注册中心中的服务实例信息怎么存储才合理？</li>\n<li>如果想要提高定时获取注册中心中数据的效率，你有什么策略？</li>\n</ul>\n<p>可以看到，虽然我们讨论的都是注册中心，但是从面试角度讲，不同的注册中心实现方式，对应的面试题也会采用不同的切入点。</p>\n<h2 id="问题分析-11"><a href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-11" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题分析</h2>\n<p>关于这类面试题的回答思路和上一讲中介绍的内容是类似的，你可以回顾上一讲中问题分析部分，这里不做重复展开。但是，因为本讲关注的是采用定时更新策略的注册中心实现方式，所以需要基于这点进行具体分析。和推送机制不同，定时策略在设计和实现上需要考虑以下几点。</p>\n<ul>\n<li>定时策略：基于什么样的时机触发轮询操作？</li>\n<li>同步数据：同步什么样的数据？同步多少数据？</li>\n<li>同步效率：如何降低轮询过程中不必要的性能损耗？</li>\n</ul>\n<p>请注意，在基于推送机制构建注册中心的实现过程中，上述问题都是不需要考虑的。根本原因在于推送是一种被动式的处理机制，注册中心的客户端不需要关注什么时候会推送，而只需要在合适的时机触发回调函数即可。而定制更新策略则不同，体现的一种主动式的处理机制，注册中心的客户端在与服务器进行交互的过程中不得不考虑上述问题。而这些问题的背后，也包含了对应的技术实现方式，让我们一起来看一下。</p>\n<h2 id="技术体系-13"><a href="#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-13" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术体系</h2>\n<p>如果我们采用定时更新策略，那么从架构设计上讲，比较容易想到的方式是采用轮询机制。轮询机制是一种主动拉取策略，即服务的消费者定期调用注册中心提供的元数据获取接口获取最新的服务实例列表并更新本地缓存，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-14-11-49-11-aaf03d4f17d22638ad5a115a9b39db34-3e989.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 605px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 46.44628099173554%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABtklEQVQoz21Sa2/aQBD0//8N/dBIfVCpKorUVFXaNF8SWh7G4RFsaMGYgCGAiW0wZ3yHJ2OnQU3FSiP7du9md2dXu59ZWMwzmFitlvjdM9C4+YhW6xRt4rZdxGBQQRQJYoNnS9P0gOdzZlq//xOdziX6f64wn09hWTVUym+I96hWCtBr75ikBClTbLdbxHH8guBf4gxa5s+w3z9lllLC94McQRCw6of8K4SAkgpyJ19U+b9pSRKTRCBJtjlZ4C+xXPThefZfDBCGc8YUnMkIzV4LE89FsAkY8yCV5FtxgGaZFzCMT2g2ihgOu9TuGuVfr1Atn6BWOUFdfw3TvMRoMMY33j11vuBsco6aU8fy3oNt9xj/DKNehDO8gCZEhHXoY8OMSinMZg51vIJlltC1Suh1r6mtnbdzN72D3tYxXoxZYZj7kiRhBz78hxXW6wAajhjvsMUn7HYpz4oDiRCLGIr/Bw1xRMOp24E7MeC6BjWZwXEsrspXmJ3vrPAHKz3n2hhQ+5QJEkQkPgwkPTLl0aiRt2XbZbbmkqDKVXkLvVqgfh/QvCmQsExJBFsKuQ37o2uT+TM8AliMoZNFnHulAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 14 11 49 11" title="" data-src="/static/2024-11-14-11-49-11-aaf03d4f17d22638ad5a115a9b39db34-3e989.png" data-srcset="/static/2024-11-14-11-49-11-aaf03d4f17d22638ad5a115a9b39db34-4bd12.png 200w,\n/static/2024-11-14-11-49-11-aaf03d4f17d22638ad5a115a9b39db34-7acd9.png 400w,\n/static/2024-11-14-11-49-11-aaf03d4f17d22638ad5a115a9b39db34-3e989.png 605w" data-sizes="(max-width: 605px) 100vw, 605px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在上图中，我们看到轮询机制实现上就是一个定时器，需要考虑定时的频率以确保数据同步的时效性。</p>\n<p>针对上图中的执行流程，我们要引出的一款注册中心实现工具是 Netflix 的 Eureka。Eureka 的基本架构由 Eureka 服务器、服务提供者和服务消费者这 3 个逻辑角色所组成，并与上一讲中介绍的服务注册中心模型具有高度一致性。虽然 Eureka 2.0 经历了诸多变故之后目前处于停止更新状态，但作为一款经典的基于轮询机制来实现服务实例状态同步的开源框架，其内部的设计思想和底层原理还是值得我们深入分析，尤其是在缓存设计和增量获取更新内容等方面的实现技巧对于日常开发过程而言也非常具有参考价值，我们可以基于这些技巧来应对类似场景下的实现需求。</p>\n<p>我们在对 Eureka 进行进一步展开，可以得到如下图所示的注册中心模型图：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-14-11-49-56-f1e2c186fcc9851831ee5522b37409a7-3e989.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 605px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 47.93388429752066%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAACBElEQVQoz3VSi24SURDd36X4io0xxv6A9jeMH1AVLQJreVUohaUtCizse/cusLwqTwscz27TxLQ6ycl9zZyZO3Mkx87CNDKEDNf5BkM/h/B78AnHLsMy07zLcC9D13NYrZYIbbfbRbhvki+yUNsJNH9+JGEK7VYes9kc4/GESXLodm7fHCsF285jvV5FgdvthoTbByBhH8PhmJl/P8gWFhBiNl9gNJrAdX0MghHPS/zPJMOsoa2W0GgU4DiXEKKBnn+Ffq8B17uCaSq4uGCl3Qp0o0rSOjxC+A2EsZatwLQUrnUYRo0VnrxA51McraM92MdxdE4PSfyV/UqgKx/A+LyH5lEMdvIxtMwruFYCFlujFg5h8s1IPoN5/ARW6jl+KO8gDbL7DHoEK/kUXnIP3eIb9vA7guEJdPk1HCZpf4hFq55+iaCXwq95mX5v4X6JsZAY4+MQ8j5al+8h6UYZml4iyuhoJX6pin5f4ZSr/NIZ1E4R1Rorpp9pVaK3ARH6GTwr9TSaHGTIoapFSP9q7GKxhuMKft2Hplns55DT3Ua4s80GWC5vMJnM4Hl99tjEnMOS7vT0N0Jbr2/giwpCWYU67fk52FYR19dTBq44gHPeZSP9+iIP4RUwnQ5vK4zkcU+soYyEOCNJGrqWpkZD4Z8iCAaRfEJCz6XYtRQ1KnOfI2GAP6n00ZP5fFL4AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 14 11 49 56" title="" data-src="/static/2024-11-14-11-49-56-f1e2c186fcc9851831ee5522b37409a7-3e989.png" data-srcset="/static/2024-11-14-11-49-56-f1e2c186fcc9851831ee5522b37409a7-4bd12.png 200w,\n/static/2024-11-14-11-49-56-f1e2c186fcc9851831ee5522b37409a7-7acd9.png 400w,\n/static/2024-11-14-11-49-56-f1e2c186fcc9851831ee5522b37409a7-3e989.png 605w" data-sizes="(max-width: 605px) 100vw, 605px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在上图中，Eureka 有以下几个操作与服务治理直接相关。</p>\n<ul>\n<li>服务注册（Register）：将各种元数据注册到注册中心。</li>\n<li>服务续约（Renew）：发送定时心跳进行续约。</li>\n<li>服务下线（Cancel）：客户端主动下线。</li>\n<li>服务剔除（Eviction）：客户端在长时间没有续约的情况下被动下线。</li>\n</ul>\n<p>另外，遵循上一讲中给出的注册中心的基本模型，Eureka 客户端也具备本地缓存机制。Eureka 在实现这一过程中使用了非常巧妙的实现方法，我们在后续内容中会具体展开。</p>\n<p>在介绍 Eureka 时，我们采用的思路与上一节中介绍 Zookeeper 不同。在介绍 Zookeeper 时，我们更多的是从 Zookeeper 这一特定工具本身出发进行展开，而这里我们的切入点是注册中心各个角色本身的特点以及它们之间的交互流程。我们首先来看 Eureka 服务器端的工作原理。</p>\n<h2 id="源码解析-11"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-11" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h2>\n<h3 id="eureka-服务器端基本原理"><a href="#eureka-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Eureka 服务器端基本原理</h3>\n<p>对于 Eureka 服务器端，我们关注两个方面，即服务实例元数据的存储和缓存。</p>\n<p>如同讨论 Zookeeper 一样，对于一个注册中心而言，我们首先需要关注它的数据存储方法。在 Eureka 中，用于保存服务实例信息的数据结构实际上是一个双层的 HashMap，采用的是 JDK 中线程安全的 ConcurrentHashMap，如果用图形化的表达方式来展示这种数据结构，可以参考下图：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-14-11-50-55-369276a2968fc2952d566cd110ade6a0-53b00.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 608px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 39.80263157894737%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABiElEQVQoz5VRaU/CUBDs//8PGhLjEUAFNUhBMXIooJH7LnehLdIWAZEmLeO0fuGLMW4y2bdv305m9gmOA/R6Lyi8XRBhIoRK+Qal4gVUpQ03djuH2O3B+RWCQ8b1+gPzuQZVnaDfl6DrM6/ebNZw+/tkf4UgdTJo1GOoVWOo12IolyKs48QdutIdVTawz2PbNgxDhmkMmIeYzbowzaFXm6YMQdNk9HstDAcddLtNqhxR3RSKMuJjGavVwiO0bcfLlrXFeJQgwQNzlKvxQx5Hoc8T0NQkhNVqw+EWFca5vxtMJk3WtN5LU2WCqu85FPVUDwc5qjB4jmAiu64uUSwE6CpIUpEzcQjv7zoHRGRSB3jKHKLReES9XubDU2TSPt75kHw8xEv+iOTXkKQOCcLs+5F9Pub5HLnnE3IEfghdK8ulwX0oMPQpPvlB2+0XFguNtlQPbs80FdrXvV6reYtqOYhc9hippA+v+TNUK0HuXISAf4ZlWbQsotO+ouIw8rlTWg+h3boiRHwDGkFHtZEcHIcAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 14 11 50 55" title="" data-src="/static/2024-11-14-11-50-55-369276a2968fc2952d566cd110ade6a0-53b00.png" data-srcset="/static/2024-11-14-11-50-55-369276a2968fc2952d566cd110ade6a0-17576.png 200w,\n/static/2024-11-14-11-50-55-369276a2968fc2952d566cd110ade6a0-52273.png 400w,\n/static/2024-11-14-11-50-55-369276a2968fc2952d566cd110ade6a0-53b00.png 608w" data-sizes="(max-width: 608px) 100vw, 608px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可以看到，Eureka 按照应用名称（spring.application.name）和服务实例 Id（instanceId）来构建两层结构。然后，Eureka 使用了 Lease（租约）这个概念来对服务的元数据进行抽象。围绕 Lease，Eureka 提供了如下所示的 LeaseManager 接口来对其进行管理，该接口的方法与前面介绍的几个核心操作是一一对应的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50612425501767565000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface LeaseManager<T> {\n   // 服务注册\n   void register(T r, int leaseDuration, boolean isReplication);\n   // 服务下线\n   boolean cancel(String appName, String id, boolean isReplication);\n   // 服务续约\n   boolean renew(String appName, String id, boolean isReplication);\n   // 服务剔除\n   void evict();\n}`, `50612425501767565000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">LeaseManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>\n   <span class="token comment">// 服务注册</span>\n   <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">T</span> r<span class="token punctuation">,</span> <span class="token keyword">int</span> leaseDuration<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isReplication<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 服务下线</span>\n   <span class="token keyword">boolean</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token class-name">String</span> appName<span class="token punctuation">,</span> <span class="token class-name">String</span> id<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isReplication<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 服务续约</span>\n   <span class="token keyword">boolean</span> <span class="token function">renew</span><span class="token punctuation">(</span><span class="token class-name">String</span> appName<span class="token punctuation">,</span> <span class="token class-name">String</span> id<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isReplication<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 服务剔除</span>\n   <span class="token keyword">void</span> <span class="token function">evict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>本质上，LeaseManager 中的各个方法的执行流程都只是围绕双层的存储结构展开操作而已，比较类似。我们这里选择用于执行服务注册操作的 register 方法进行展开，register 方法非常长，我们对源码进行裁剪，得出如下所示的重点处理流程：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90582629458162710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public void register(InstanceInfo registrant, int leaseDuration, boolean isReplication) {\n   try {\n      read.lock();\n\n      // 从已存储的 registry 获取一个服务定义\n      Map<String, Lease<InstanceInfo>> gMap = registry.get(registrant.getAppName());\n      REGISTER.increment(isReplication);\n      if (gMap == null) {\n         // 初始化一个 Map<String, Lease<InstanceInfo>>，并放入 registry 中\n      }\n\n      // 根据当前注册的 ID 能找到对应的 Lease\n      Lease<InstanceInfo> existingLease = gMap.get(registrant.getId());\n\n      if (existingLease != null && (existingLease.getHolder() != null)) {\n         // 如果能找到，根据时间确定以哪个实例为准\n      } else {\n         // 如果找不到，设置续约数量及其阈值参数\n      }\n\n      // 创建一个新 Lease 并放入 Map 中\n      Lease<InstanceInfo> lease = new Lease<InstanceInfo>(registrant, leaseDuration);\n      if (existingLease != null) {\n         lease.setServiceUpTimestamp(existingLease.getServiceUpTimestamp());\n      }\n      gMap.put(registrant.getId(), lease);\n\n      synchronized (recentRegisteredQueue) {\n         // 同步更新 recentRegisteredQueue\n      }\n\n      // 处理服务的 InstanceStatus\n      registrant.setActionType(ActionType.ADDED);\n\n      // 更新服务最新更新时间\n      registrant.setLastUpdatedTimestamp();\n\n      // 刷新缓存\n      invalidateCache(registrant.getAppName(), registrant.getVIPAddress(), registrant.getSecureVipAddress());\n   } finally {\n      read.unlock();\n   }\n}`, `90582629458162710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">InstanceInfo</span> registrant<span class="token punctuation">,</span> <span class="token keyword">int</span> leaseDuration<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isReplication<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      read<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 从已存储的 registry 获取一个服务定义</span>\n      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Lease</span><span class="token punctuation">&lt;</span><span class="token class-name">InstanceInfo</span><span class="token punctuation">></span><span class="token punctuation">></span></span> gMap <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>registrant<span class="token punctuation">.</span><span class="token function">getAppName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      REGISTER<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>isReplication<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>gMap <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token comment">// 初始化一个 Map&lt;String, Lease&lt;InstanceInfo>>，并放入 registry 中</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// 根据当前注册的 ID 能找到对应的 Lease</span>\n      <span class="token class-name">Lease</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InstanceInfo</span><span class="token punctuation">></span></span> existingLease <span class="token operator">=</span> gMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>registrant<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>existingLease <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>existingLease<span class="token punctuation">.</span><span class="token function">getHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token comment">// 如果能找到，根据时间确定以哪个实例为准</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         <span class="token comment">// 如果找不到，设置续约数量及其阈值参数</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// 创建一个新 Lease 并放入 Map 中</span>\n      <span class="token class-name">Lease</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InstanceInfo</span><span class="token punctuation">></span></span> lease <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lease</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InstanceInfo</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>registrant<span class="token punctuation">,</span> leaseDuration<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>existingLease <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         lease<span class="token punctuation">.</span><span class="token function">setServiceUpTimestamp</span><span class="token punctuation">(</span>existingLease<span class="token punctuation">.</span><span class="token function">getServiceUpTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      gMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>registrant<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lease<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>recentRegisteredQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token comment">// 同步更新 recentRegisteredQueue</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// 处理服务的 InstanceStatus</span>\n      registrant<span class="token punctuation">.</span><span class="token function">setActionType</span><span class="token punctuation">(</span><span class="token class-name">ActionType</span><span class="token punctuation">.</span>ADDED<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 更新服务最新更新时间</span>\n      registrant<span class="token punctuation">.</span><span class="token function">setLastUpdatedTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 刷新缓存</span>\n      <span class="token function">invalidateCache</span><span class="token punctuation">(</span>registrant<span class="token punctuation">.</span><span class="token function">getAppName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> registrant<span class="token punctuation">.</span><span class="token function">getVIPAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> registrant<span class="token punctuation">.</span><span class="token function">getSecureVipAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>\n      read<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，整个 register 方法完成的就是对 Map 中数据的更新过程，这里我们针对服务注册的各个核心操作添加了注释。需要注意的是，在更新完 Map 中数据之后，Eureka 还会通过 invalidateCache 执行刷新缓存操作，这就引出我们接下来要讨论的话题，即 Eureka 服务缓存机制。</p>\n<p>Eureka 服务器端组件的另一个核心功能是提供服务列表，为了提高性能，服务列表在 Eureka 服务器会缓存一份，并通过一定的定时机制进行更新。</p>\n<p>在 Eureka 中，ApplicationResource 类提供了根据应用获取注册信息的入口。我们来看该类的 getApplication 方法，核心代码如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69917299694298680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Key cacheKey = new Key(\n   Key.EntityType.Application,\n   appName,\n   keyType,\n   CurrentRequestVersion.get(),\n   EurekaAccept.fromString(eurekaAccept)\n);\n\nString payLoad = responseCache.get(cacheKey);\n// ....`, `69917299694298680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">Key</span> cacheKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Key</span><span class="token punctuation">(</span>\n   <span class="token class-name">Key</span><span class="token punctuation">.</span><span class="token class-name">EntityType</span><span class="token punctuation">.</span><span class="token class-name">Application</span><span class="token punctuation">,</span>\n   appName<span class="token punctuation">,</span>\n   keyType<span class="token punctuation">,</span>\n   <span class="token class-name">CurrentRequestVersion</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n   <span class="token class-name">EurekaAccept</span><span class="token punctuation">.</span><span class="token function">fromString</span><span class="token punctuation">(</span>eurekaAccept<span class="token punctuation">)</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token class-name">String</span> payLoad <span class="token operator">=</span> responseCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// ....</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到这里是构建了一个 cacheKey，并直接调用了 responseCache.get(cacheKey) 方法来返回一个字符串并构建响应。从命名上看，不难想象这里使用了缓存机制。在 ResponseCache 的 get 方法中，我们发现它使用了如下所示的处理策略：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45504298034222020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Value getValue(final Key key, boolean useReadOnlyCache) {\n   Value payload = null;\n   try {\n      if (useReadOnlyCache) {\n         final Value currentPayload = readOnlyCacheMap.get(key);\n         if (currentPayload != null) {\n            payload = currentPayload;\n         } else {\n            payload = readWriteCacheMap.get(key);\n            readOnlyCacheMap.put(key, payload);\n         }\n      } else {\n         payload = readWriteCacheMap.get(key);\n      }\n   } catch (Throwable t) {\n      logger.error(&quot;Cannot get value for key : {}&quot;, key, t);\n   }\n   return payload;\n}`, `45504298034222020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">Value</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Key</span> key<span class="token punctuation">,</span> <span class="token keyword">boolean</span> useReadOnlyCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token class-name">Value</span> payload <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n   <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>useReadOnlyCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">final</span> <span class="token class-name">Value</span> currentPayload <span class="token operator">=</span> readOnlyCacheMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>currentPayload <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            payload <span class="token operator">=</span> currentPayload<span class="token punctuation">;</span>\n         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            payload <span class="token operator">=</span> readWriteCacheMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            readOnlyCacheMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         payload <span class="token operator">=</span> readWriteCacheMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Cannot get value for key : {}"</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">return</span> payload<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到上述代码中有两个缓存，一个是 readOnlyCacheMap，一个是 readWriteCacheMap。其中 readOnlyCacheMap 就是一个 JDK 中的 ConcurrentMap，而 readWriteCacheMap 则是 Guava Cache 库中的 LoadingCache 类型。</p>\n<p>把缓存设计为一个只读的 readOnlyCacheMap 以及一个可读写的 readWriteCacheMap，这是一种设计上的技巧，可以更好地分离职责。但因为两个缓存中保存的实际上是同一份数据，所以，我们在不断更新 readWriteCacheMap 的同时，也需要确保 readOnlyCacheMap 中的数据得到同步。为此 ResponseCacheImpl 提供了一个定时任务 CacheUpdateTask，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13697595861655000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`private TimerTask getCacheUpdateTask() {\n   return new TimerTask() {\n      @Override\n      public void run() {\n         for (Key key : readOnlyCacheMap.keySet()) {\n            try {\n               CurrentRequestVersion.set(key.getVersion());\n               Value cacheValue = readWriteCacheMap.get(key);\n               Value currentCacheValue = readOnlyCacheMap.get(key);\n               if (cacheValue != currentCacheValue) {\n                  // 更新 readOnlyCacheMap\n                  readOnlyCacheMap.put(key, cacheValue);\n               }\n            } catch (Throwable th) {\n               // ...\n            }\n         }\n      }\n   };\n}`, `13697595861655000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">TimerTask</span> <span class="token function">getCacheUpdateTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TimerTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token annotation punctuation">@Override</span>\n      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Key</span> key <span class="token operator">:</span> readOnlyCacheMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">try</span> <span class="token punctuation">{</span>\n               <span class="token class-name">CurrentRequestVersion</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n               <span class="token class-name">Value</span> cacheValue <span class="token operator">=</span> readWriteCacheMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n               <span class="token class-name">Value</span> currentCacheValue <span class="token operator">=</span> readOnlyCacheMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n               <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheValue <span class="token operator">!=</span> currentCacheValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                  <span class="token comment">// 更新 readOnlyCacheMap</span>\n                  readOnlyCacheMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> cacheValue<span class="token punctuation">)</span><span class="token punctuation">;</span>\n               <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> th<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token comment">// ...</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>显然，这个定时任务主要是从 readWriteCacheMap 更新数据到 readOnlyCacheMap。</p>\n<h3 id="eureka-客户端基本原理"><a href="#eureka-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Eureka 客户端基本原理</h3>\n<p>介绍完服务器端基本原理，我们来看 Eureka 客户端组件的实现方式。服务的提供者和消费者都是注册中心的客户端，其中服务的提供者主要完成服务注册等操作，这部分的内容主要依赖于前面介绍的服务端能力，我们不再具体展开。在接下来的内容中，我们重点关注的是服务的消费者如何定时获取位于服务器上的服务实例信息，以及如何构建属于它自身的本地缓存。</p>\n<p>对于 Eureka 而言，作为客户端核心组件的 DiscoveryClient 类具备缓存功能。DiscoveryClient 中的 initScheduledTasks 方法用于初始化各种调度任务，对于缓存刷新而言，调度器的初始化过程如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52773983461444020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (clientConfig.shouldFetchRegistry()) {\n   int registryFetchIntervalSeconds = clientConfig.getRegistryFetchIntervalSeconds();\n   int expBackOffBound = clientConfig.getCacheRefreshExecutorExponentialBackOffBound();\n   scheduler.schedule(\n      new TimedSupervisorTask(\n         &quot;cacheRefresh&quot;,\n         scheduler,\n         cacheRefreshExecutor,\n         registryFetchIntervalSeconds,\n         TimeUnit.SECONDS,\n         expBackOffBound,\n         new CacheRefreshThread()\n      ),\n      registryFetchIntervalSeconds,\n      TimeUnit.SECONDS\n   );\n}`, `52773983461444020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>clientConfig<span class="token punctuation">.</span><span class="token function">shouldFetchRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">int</span> registryFetchIntervalSeconds <span class="token operator">=</span> clientConfig<span class="token punctuation">.</span><span class="token function">getRegistryFetchIntervalSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">int</span> expBackOffBound <span class="token operator">=</span> clientConfig<span class="token punctuation">.</span><span class="token function">getCacheRefreshExecutorExponentialBackOffBound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   scheduler<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span>\n      <span class="token keyword">new</span> <span class="token class-name">TimedSupervisorTask</span><span class="token punctuation">(</span>\n         <span class="token string">"cacheRefresh"</span><span class="token punctuation">,</span>\n         scheduler<span class="token punctuation">,</span>\n         cacheRefreshExecutor<span class="token punctuation">,</span>\n         registryFetchIntervalSeconds<span class="token punctuation">,</span>\n         <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span>\n         expBackOffBound<span class="token punctuation">,</span>\n         <span class="token keyword">new</span> <span class="token class-name">CacheRefreshThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">,</span>\n      registryFetchIntervalSeconds<span class="token punctuation">,</span>\n      <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>显然，这里启动了一个调度任务并通过一个 CacheRefreshThread 线程完成具体操作，系统默认是每隔 30 秒刷新本地存储的服务实例数据。在这个线程中，我们发现在进行一系列的校验之后，最终调用了 DiscoveryClient 中的 fetchRegistry 方法完成对服务注册信息的获取。该方法如下所示（为了简单起见，对代码进行了部分裁剪，只保留主流程）：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55675252824642960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`private boolean fetchRegistry(boolean forceFullRegistryFetch) {\n   try {\n      // 获取应用\n      Applications applications = getApplications();\n      if (condition) { // 如果满足全量拉取条件\n         // 全量拉取服务实例数据\n         getAndStoreFullRegistry();\n      } else {\n         // 增量拉取服务实例数据\n         getAndUpdateDelta(applications);\n      }\n\n      // 重新计算和设置一致性 hashcode\n      applications.setAppsHashCode(applications.getReconcileHashCode());\n   }\n\n   // 刷新本地缓存\n   onCacheRefreshed();\n   // 基于缓存中的实例数据更新远程实例状态\n   updateInstanceRemoteStatus();\n   // 注册表拉取成功后返回 true\n   return true;\n}`, `55675252824642960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">fetchRegistry</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> forceFullRegistryFetch<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 获取应用</span>\n      <span class="token class-name">Applications</span> applications <span class="token operator">=</span> <span class="token function">getApplications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>condition<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果满足全量拉取条件</span>\n         <span class="token comment">// 全量拉取服务实例数据</span>\n         <span class="token function">getAndStoreFullRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         <span class="token comment">// 增量拉取服务实例数据</span>\n         <span class="token function">getAndUpdateDelta</span><span class="token punctuation">(</span>applications<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// 重新计算和设置一致性 hashcode</span>\n      applications<span class="token punctuation">.</span><span class="token function">setAppsHashCode</span><span class="token punctuation">(</span>applications<span class="token punctuation">.</span><span class="token function">getReconcileHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token comment">// 刷新本地缓存</span>\n   <span class="token function">onCacheRefreshed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 基于缓存中的实例数据更新远程实例状态</span>\n   <span class="token function">updateInstanceRemoteStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 注册表拉取成功后返回 true</span>\n   <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上述代码中带注释的几个方法都非常有用，因为 getAndStoreFullRegistry 方法的逻辑相对比较简单，我们将重点介绍 getAndUpdateDelta 方法，以便学习在 Eureka 中如何实现增量数据更新的设计技巧。裁剪之后的 getAndUpdateDelta 方法代码下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13339425662009608000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`private void getAndUpdateDelta(Applications applications) throws Throwable {\n   long currentUpdateGeneration = fetchRegistryGeneration.get();\n\n   Applications delta = null;\n   // 通过 eurekaTransport.queryClient 获取增量信息\n   EurekaHttpResponse<Applications> httpResponse = eurekaTransport.queryClient.getDelta(remoteRegionsRef.get());\n   if (httpResponse.getStatusCode() == Status.OK.getStatusCode()) {\n      delta = httpResponse.getEntity();\n   }\n\n   if (delta == null) {\n      // 如果增量信息为空，就直接发起一次全量更新\n      getAndStoreFullRegistry();\n   } else if (fetchRegistryGeneration.compareAndSet(currentUpdateGeneration, currentUpdateGeneration + 1)) { // 通过 CAS 来确保请求的线程安全性\n      String reconcileHashCode = &quot;&quot;;\n      if (fetchRegistryUpdateLock.tryLock()) {\n         try {\n            // 用 Eureka 返回的增量数据和本地数据做合并操作\n            updateDelta(delta);\n\n            // 用合并了增量数据之后的本地数据来生成一致性 hashcode\n            reconcileHashCode = getReconcileHashCode(applications);\n         } finally {\n            fetchRegistryUpdateLock.unlock();\n         }\n      } else {\n         // ...\n      }\n\n      // 比较本地数据中的 hashcode 和来自服务器端的 hashcode\n      if (!reconcileHashCode.equals(delta.getAppsHashCode()) || clientConfig.shouldLogDeltaDiff()) {\n         // 如果 hashcode 不一致，就触发远程调用进行全量更新\n         reconcileAndLogDifference(delta, reconcileHashCode);\n      }\n   } else {\n      // ...\n   }\n}`, `13339425662009608000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">getAndUpdateDelta</span><span class="token punctuation">(</span><span class="token class-name">Applications</span> applications<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>\n   <span class="token keyword">long</span> currentUpdateGeneration <span class="token operator">=</span> fetchRegistryGeneration<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token class-name">Applications</span> delta <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n   <span class="token comment">// 通过 eurekaTransport.queryClient 获取增量信息</span>\n   <span class="token class-name">EurekaHttpResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Applications</span><span class="token punctuation">></span></span> httpResponse <span class="token operator">=</span> eurekaTransport<span class="token punctuation">.</span>queryClient<span class="token punctuation">.</span><span class="token function">getDelta</span><span class="token punctuation">(</span>remoteRegionsRef<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>httpResponse<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Status</span><span class="token punctuation">.</span>OK<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      delta <span class="token operator">=</span> httpResponse<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>delta <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 如果增量信息为空，就直接发起一次全量更新</span>\n      <span class="token function">getAndStoreFullRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fetchRegistryGeneration<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>currentUpdateGeneration<span class="token punctuation">,</span> currentUpdateGeneration <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 通过 CAS 来确保请求的线程安全性</span>\n      <span class="token class-name">String</span> reconcileHashCode <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>fetchRegistryUpdateLock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 用 Eureka 返回的增量数据和本地数据做合并操作</span>\n            <span class="token function">updateDelta</span><span class="token punctuation">(</span>delta<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            <span class="token comment">// 用合并了增量数据之后的本地数据来生成一致性 hashcode</span>\n            reconcileHashCode <span class="token operator">=</span> <span class="token function">getReconcileHashCode</span><span class="token punctuation">(</span>applications<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>\n            fetchRegistryUpdateLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         <span class="token comment">// ...</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// 比较本地数据中的 hashcode 和来自服务器端的 hashcode</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reconcileHashCode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>delta<span class="token punctuation">.</span><span class="token function">getAppsHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> clientConfig<span class="token punctuation">.</span><span class="token function">shouldLogDeltaDiff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token comment">// 如果 hashcode 不一致，就触发远程调用进行全量更新</span>\n         <span class="token function">reconcileAndLogDifference</span><span class="token punctuation">(</span>delta<span class="token punctuation">,</span> reconcileHashCode<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// ...</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>结合 Eureka 服务器端基本原理，我们知道 Eureka 服务器端会保存一个服务注册列表的缓存。在 Eureka 官方文档中提到 Eureka 服务器会把更新数据保留 3 分钟，而 Eureka 客户端通过前面介绍的定时机制会每隔 30 秒刷新本地缓存。原则上，只要 Eureka 客户端不停地获取服务器端的更新数据，就能保证自己的数据和 Eureka 服务器端的保持一致。但如果客户端在 3 分钟之内没有获取更新数据，就会导致自身与服务器端的数据不一致。</p>\n<p>为了解决这个问题，Eureka 采用了一种叫做一致性 HashCode（ReconcileHashCode） 的实现机制。Eureka 服务器端每次返回的增量更新数据中都会带有一个 HashCode，Eureka 客户端用本地服务实例信息算出的 HashCode 应该和 Eureka 服务器返回的一致，若不一致就证明增量更新出现了问题，导致客户端和服务器端上的服务实例信息不一致了，此时需要全量更新。</p>\n<p>在 Eureka 中，计算一致性 HashCode 的方法如下所示，可以看到这一方法基于服务实例信息完成一个 String 类型的 HashCode 计算过程。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61783220307930554000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public static String getReconcileHashCode(Map<String, AtomicInteger> instanceCountMap) {\n   StringBuilder reconcileHashCode = new StringBuilder(75);\n   for (Map.Entry<String, AtomicInteger> mapEntry : instanceCountMap.entrySet()) {\n      reconcileHashCode.append(mapEntry.getKey()).append(STATUS_DELIMITER).append(mapEntry.getValue().get())append(STATUS_DELIMITER);\n   }\n   return reconcileHashCode.toString();\n}`, `61783220307930554000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getReconcileHashCode</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">></span></span> instanceCountMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token class-name">StringBuilder</span> reconcileHashCode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token number">75</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">></span></span> mapEntry <span class="token operator">:</span> instanceCountMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      reconcileHashCode<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>mapEntry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>STATUS_DELIMITER<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>mapEntry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token function">append</span><span class="token punctuation">(</span>STATUS_DELIMITER<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">return</span> reconcileHashCode<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>作为总结，Eureka 客户端缓存定时更新的流程下所示，可以看到它与服务注册的流程基本一致。也就是说在 Eureka 中，服务提供者和服务消费者作为 Eureka 服务器的客户端采用了同一套体系完成与服务器端的交互。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-14-11-51-36-75aeeb503563a485f1db74a49fb314b2-4c6f5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 607px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 71.16968698517299%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAAB0UlEQVQ4y4VTiW7aQBDl/3+kSlSl6pH+QltyFOKiWEiADZg4+ADbGGMMfp030XLmWGk16903b94cblgPP/DQvkLr72fYjz/heQ5+/7rA3e0lmn8+yds1plMPdzeXaLeuYLW/CO4bOv+uMZk4aN1/xe3NhW778TsaUTRBEIzg+w6yNEBVrTGb+Xj2XUy8PqLoCUWxRBiOEUee4iKxccz7XO302ZWgQ/F7QgOyilWJLMsFGGM0GsljgCRJhXyD01VV27O7uga221rPSjifz0RBgEWWSZQZ0jSVdDy5nyPPc/2mrcVztVqJ81bP3EKH9Xotu9SzEiZJIgqzo6gk6Pf7GA6HUpJASbno/EKEnd1sNqK82iskoXFgdK7lcolOpyM1ipWE30VRqMJTQpIR8yqhAS0WCziOg16vp9bzPFVqCPcpvxC+qdCAjELa46ZUO4xZzOpDhfxmumySbdtwXVcaF2I8Hu/eoyjSMrD+ZVm+T0iQSc80go3qdrtKSttsNtValrXL5E1COg8GA60bZ5N1JI53PFMZx4p+YRBq8A8JOTaMbDpM1b7vnw22mdODwZZIyXkNTdT9H1FrTV/r8lFTGPlUIckM4aHz4WCbNxISywH/D0/bM2SPuh2qAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 14 11 51 36" title="" data-src="/static/2024-11-14-11-51-36-75aeeb503563a485f1db74a49fb314b2-4c6f5.png" data-srcset="/static/2024-11-14-11-51-36-75aeeb503563a485f1db74a49fb314b2-3bd24.png 200w,\n/static/2024-11-14-11-51-36-75aeeb503563a485f1db74a49fb314b2-52f0c.png 400w,\n/static/2024-11-14-11-51-36-75aeeb503563a485f1db74a49fb314b2-4c6f5.png 607w" data-sizes="(max-width: 607px) 100vw, 607px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>Eureka 客户端和服务器端的差异化信息计算和获取过程，是这种更新机制所必须要考虑的问题，也是我们自己在设计类似场景时的注意点。我们可以从上述实现原理中掌握优秀开源框架底层的开发技巧。</p>\n<h2 id="解题要点-13"><a href="#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-13" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解题要点</h2>\n<p>对于本讲中所讨论的话题，面试过程中第一个需要明确的要点就是基于定时更新机制的注册中心实现机制。相较上一讲介绍的推送机制，定时更新机制的概念容易理解，基本的实现策略也比较简单。通常，我们采用一些定时器实现工具和框架对位于服务器上的服务实例信息进行轮询即可。</p>\n<p>但是需要注意，定时更新机制有它自身的复杂度，我们需要综合考虑定时策略、同步数据、同步效率等问题，这些问题是这种机制所特有的，在面试过程中需要重点对这些机制展开讨论。这是面试官的考查重点，也能很好展现候选人的竞争力。对于这些机制的讨论，我们可以分成两个步骤，首先阐述这些机制背后的设计思想，然后再来结合具体框架给出底层的实现原理分析。</p>\n<p>至于具体的开源框架，和上一讲中所提到的 Zookeeper 相比，定时更新机制类框架采用的是另一套完全不同的实现策略。我们在回答过程中需要基于特定的技术要点来进行分析。</p>\n<p>举例来说，针对 <code class="language-text">Eureka 客户端从服务器端获取注册信息</code> 这一特定的细节，回答难度实际上很大。而至于为什么要问这一特定细节，在于 Eureka 在实现这一细节上提供了一种处理增量数据的开发技巧和工程实践，值得我们深入学习和应用。我们知道，当执行轮询操作时，需要考虑的一大问题就是如何高效地从服务端获取最新的服务实例信息。为了提高效率、降低网络通信的开销，一般都会考虑引入 <code class="language-text">增量</code> 数据获取的设计思想，Eureka 也采用了这种机制。具体来讲，Eureka 采用了一种叫做一致性 HashCode 的实现机制。</p>\n<p>如果我们能够结合本讲中介绍的这种增量式数据获取方式，那么相信能够获得面试官的更多认同。这也是我在具体面试过程中的一条经验，即对于那些普通的知识点，建议不用过多展开，但我们可以多围绕框架本身所具备的一些特有的设计和开发技巧给出自己的分析和总结。</p>\n<h2 id="小结与预告-11"><a href="#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-11" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结与预告</h2>\n<p>本讲介绍了实现注册中心的另一种常见的策略，即基于定时更新策略来实现客户端与服务端之间元数据的有效同步。这是很多注册中心所采用的实现策略，设计思想简单，应用也很广泛。我们结合老牌的注册中心开源框架 Eureka 对这一主题进行了详细展开，并分析了该框架在实现这一主题过程中所具备的开发技巧。一方面，这些开发技巧是面试过程中的回答要点，另一方面，我们也可以结合具体的场景把这些开发技巧应用到日常开发过程中。</p>\n<p>在分布式系统中，当服务的数量达到一定规模时，我们就不建议客户端对这些服务直接发起远程请求了。这时候，我们可以引入服务网关这一技术组件。那么，如何实现一款高性能服务网关？下一讲将围绕这个话题展开讨论。</p>\n<h1 id="服务网关：如何实现一款高性能服务网关？"><a href="#%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E6%AC%BE%E9%AB%98%E6%80%A7%E8%83%BD%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务网关：如何实现一款高性能服务网关？</h1>\n<p>在上一讲中，我们引入了注册中心这一技术组件来构建分布式系统。通过注册中心，我们可以对系统中存在的服务进行有效治理。一旦服务得到了治理，下一步就可以对这些服务发起访问了。</p>\n<p>这个过程并不复杂，但也没有我们想象的那么简单，因为客户端请求和服务端所提供的访问入口之间需要进行粒度匹配、路由、安全等一系列控制。为了实现这些控制，服务网关（Gateway） 也就应运而生了。</p>\n<p>那么，什么是服务网关？如何构建一款高性能服务网关？这是面试过程中的常见话题。本讲内容将给出这些问题的具体答案。</p>\n<h2 id="问题背景-11"><a href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-11" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题背景</h2>\n<p>在分布式架构中，如果客户端和各个服务直接进行交互，可能会出现很多问题。通常，每个服务的职责在于提供某一个业务领域的访问入口，而客户端则一般都需要整合多项业务数据。这就会导致客户端的请求和服务提供的访问入口在粒度上是不一致，导致客户端不得不发送多个请求才能获取所想要的数据。另一方面，在这种场景下，如果某个服务发生了调整，很可能会导致客户端需要做相应的调整，这显然是不合理的。</p>\n<p>下图展示了服务版本升级的一种演进结构：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-15-11-49-42-ab87944809955116971430f08842bc63-e49e6.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 639px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 51.79968701095462%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAAB7klEQVQoz52Sa1PaYBCF8/9/RKfTUSuodarTOlqrbe0IRi5KCCSSEAIVEA0h0CYkEJ4umfqp9UvPzJnd95LN7nmPslqteIlrNHsmmzc5Nkrb7NT32dJ2UO+u8R89cldXbN3eslWpkNcbvNd1FF5AskiIozmFapFT45zj2iln5lfOrW9YA5tw9osL0+Ck0eCTVuezaVJoOyieN8LzhozHD8Ihj48DfN8nCAJmsxlRGJEmKavlinSRsoyXsPrz1+VS9hZyJjFJsly5qe7idg7RtTxtax/bOqLX+8H/Qum6Bo5TE2oYTRXDqGSdTadTgsmEmqFRbKsUbRXVKVF0VLqjLos4oWRZsnbkzEbtdKi6Lspae+mYVGKaIoVCJhOfMAoJf4YcfT9mU8vx6vINm5Uc2809VKuE9/BE7lplo3rD60KBtzWNQ8NE0WpH2PYJev0Dd6bk1hdct0u/3xdNx1mn48DHnwoler5HNI+y8aYyyVi0nmR3AgKJSrNxLkXOaOgnNBvHkl8wGo0y26yLRVH0T62ebfWXhnG8IAxj5vNEPo6FYpc4zl55zbpe57JcoNVt4Qw6tHpW1u0a3eEA6/6etkxj9+9xB4OXffiMcqvKjrmfmfvd3QF79gHX7TJPwxH5com8+G9bfLjbavFRHuc3ESTiNCYOongAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 15 11 49 42" title="" data-src="/static/2024-11-15-11-49-42-ab87944809955116971430f08842bc63-e49e6.png" data-srcset="/static/2024-11-15-11-49-42-ab87944809955116971430f08842bc63-12809.png 200w,\n/static/2024-11-15-11-49-42-ab87944809955116971430f08842bc63-55d6b.png 400w,\n/static/2024-11-15-11-49-42-ab87944809955116971430f08842bc63-e49e6.png 639w" data-sizes="(max-width: 639px) 100vw, 639px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在这样的背景下，我们可以根据需要在客户端和服务端之间架设一层服务网关，从而满足前面提到的各种需求。而在分布式系统的构建过程中，一个核心要点就是需要确保所有来自客户端的请求都通过服务网关再路由和转发到后端服务，这样我们就可以在网关层对请求本身进行统一的处理。</p>\n<p>从架构设计角度讲，服务网关的出现有其必然性。而围绕服务网关的构建过程，也存在一些我们不得不去思考的问题。这些问题是面试过程中考查的重点，常见的包括：</p>\n<ul>\n<li>服务网关存在的必要性和作用是什么？</li>\n<li>服务网关的基本结构是怎么样的？</li>\n<li>服务网关如何实现请求的路由和转发？</li>\n<li>你熟悉的服务网关工具有哪些？各自有什么功能上的特性？</li>\n<li>如果让你在服务网关中添加安全性控制机制，你会怎么做？</li>\n<li>如果想要在网关层对请求进行限流，可以采用怎么样的实现方式？</li>\n</ul>\n<p>上述问题都很经典，是面试过程中的常考题，需要你引起重视。接下来，我们从面试角度出发对这些问题做进一步分析。</p>\n<h2 id="问题分析-12"><a href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-12" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题分析</h2>\n<p>在当下的分布式系统开发过程中，服务网关已经成为必不可少的一个技术组件。关于服务网关的相关工具和框架也层出不穷。虽然，每个网关工具在部署和使用方式上各有不同，但它们的架构本质上是非常类似的。和前面介绍的注册中心相比，服务网关在定位上更偏向是一种底层的中间件，通用性很强，所以我们可以比较容易地对它的作用、组成结构以及功能特性进行抽象和提炼。这部分内容更多的是理论知识，需要候选人熟练掌握。</p>\n<p>掌握了概念之后，接下来就是具体的开源框架。</p>\n<p>对于服务网关而言，实际上它所具备的核心功能还是请求转发机制，所以，很多请求响应类的框架所要面临的技术难点服务网关同样也需要面对。典型的就是性能问题，如何构建高性能的请求转发机制是我们在分析具体网关框架时的一个切入点，也是面试过程中的常见考点。</p>\n<p>最后，服务网关类的面试题经常会考查候选人对某一个特定功能特性的掌握程度，比方说网关的路由机制、安全性机制、限流机制等。候选人在回答这些问题时，需要结合自己擅长的框架做深入的研究，并能够从原理出发给出自己的总结和思考。</p>\n<p>在本讲中，我们将要深入分析的是 Spring Cloud 家族的 Spring Cloud Gateway 框架。而在此之前，让我们先从服务网关的基本概念开始讲起。</p>\n<h2 id="技术体系-14"><a href="#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-14" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术体系</h2>\n<p>服务网关的概念本质上不难理解，从设计模式上讲，我们也可以把服务网关看作是门面（Facade）模式的一种具体表现形式。门面模式的作用就是把复杂度屏蔽在系统内部，从而降低耦合度，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-15-11-52-03-d61e53ea6581c728102aa4655dfce2e6-cd472.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 557px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 56.01436265709155%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAAChklEQVQoz3WTeVPaUBTF8/0/Qeu002nHuhQEpIWALCFhD5vsSgja6VDFREEBBQL99bZj/+ybufNu7jvn3POWKKWin4v+Ked1HxXziH43QK+rs9lAq5mQPCBrfszSIZ32Cc2mymK5xrIq8u3nvOGnVjkWrJ9G/RTlvBFhcKlK4ZSqecJl/xvtVobdDkYjE9uO0++pQjzFGqhSK7Be77i8LItgUHhhEQrRaYUFd4ay2XisVmvWMm+3W+m+xHFdHOeOq6HNg3PPRbdHt9Vm6t5zbY+4m0xwJZ/PF3jelo3nCX8jjTYo/Bu/XuN19CybYKdF8d4lPrJRhxYF1yF80acqDf7HU1arFam2RtrWydgGmqVjXBn4zDhZ2VpNQMbzmm/jCVXJTYljM4k+0klbrzGU6GZYLBYo08cZ4e8qReqkngtoqxKFXYXAUOWwlSNk1zju5DkZmASHVT6UUnyxYuhemaxXofirSoUmkXGcG+cW5WnxJMAIuasonesY5X6I/dI+uZUpjhoYyzzao44pTf5Ujuqfycntdn+ckRZsYVMVK23iP1NM3AnKYjnnsBOgKYJ4dW5/JtFuU+ReyoStMG+Te6RcQ6SaIt9Du9MYjxNsX0ReBPNeTVZ6xIT3V3D2NCP6I0F6anDQOMbXOSH+YJCS9/cyy7N7Nkn3gujSwHjKExiE2cu85+u1ypv0O5JOhuyyhDr+JyhnGBX1zG2SscwP0yxqeR/f+Rdq32NUr6PojkZGiD1xdDdJU7wIkVkWKYsB909dducTA87MQZnP54TlwYbEWalyRE3+mEjpM4n7LLGJRvQmLWdYIDL4imZ8pNUNESsfyGVFSeQ+0ewE0cwDjqo+Hh6n/AYFYP7gR5T9jgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 15 11 52 03" title="" data-src="/static/2024-11-15-11-52-03-d61e53ea6581c728102aa4655dfce2e6-cd472.png" data-srcset="/static/2024-11-15-11-52-03-d61e53ea6581c728102aa4655dfce2e6-8e829.png 200w,\n/static/2024-11-15-11-52-03-d61e53ea6581c728102aa4655dfce2e6-2b773.png 400w,\n/static/2024-11-15-11-52-03-d61e53ea6581c728102aa4655dfce2e6-cd472.png 557w" data-sizes="(max-width: 557px) 100vw, 557px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>既然是一种门面，那么网关中显然不应该包含任何与业务相关的处理逻辑。那么，服务网关的核心作用究竟有哪些呢？主要包括三部分，即解耦、适配和数据聚合。</p>\n<ol>\n<li>\n<p>解耦：从技术架构而言，任何组件之间的交互都应该具备较低的耦合度。正如我们在问题背景部分所讨论的，客户端请求和服务端访问入口之间的依赖关系需要确保独立，即服务端背后的功能演进和版本升级过程对于客户端而言应该是透明的。考虑到分布式系统中往往存在大量服务，解耦也是我们在服务体系过程中的一项核心目标。</p>\n</li>\n<li>\n<p>适配：在分布式系统中，客户端的类型也是多样的。当我们面对多个不同类型的客户端时，考虑到页面展示上的差异性，往往需要针对特定的客户端请求提供特定的响应结果，哪怕这些请求属于同一业务场景。</p>\n<p>举个例子，分页是一种常见的数据返回效果，但不同客户端对分页数量的要求可能就是不一样的，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-15-11-53-01-eddd488b6b1fd716e06f1e2f7fe922e1-0e173.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 646px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 26.31578947368421%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAABEElEQVQY032Q22rCUBBF8/9/UQpShPrQO20VWlqkoEhsqTGYEM3NmMs5iQUbb6tDnqUDm2EeZu81YwwHl5ijNv33c8bmBc5shNZr0nTFcrkkSRJ836fUGl/mjm3zMrXgsOdUGUHwRRR94jpD6WPieE5RKDFMG8MsyyjLkt/NhnkccyMBfQngeGS725LrHFWpRoUuMPinjrJU1zVVVaGV4r7b5VpMX12HH1XSHfRoWx1aZpuzQYvb4BEjjjwhcwlDhzCYoVQmBmuhzOV03UiJaiG0PY87IX+TftjuWBUpVmQzDW0mgcUscTBc50mMnpl8XxH4D3ieSZ4rCQhZLBbND6MobgjDVUpPzv8IAtif/uEf+odyFEPBQfAAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 15 11 53 01" title="" data-src="/static/2024-11-15-11-53-01-eddd488b6b1fd716e06f1e2f7fe922e1-0e173.png" data-srcset="/static/2024-11-15-11-53-01-eddd488b6b1fd716e06f1e2f7fe922e1-2fb9f.png 200w,\n/static/2024-11-15-11-53-01-eddd488b6b1fd716e06f1e2f7fe922e1-f1e72.png 400w,\n/static/2024-11-15-11-53-01-eddd488b6b1fd716e06f1e2f7fe922e1-0e173.png 646w" data-sizes="(max-width: 646px) 100vw, 646px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n</li>\n<li>\n<p>数据聚合：对来自不同服务的数据进行聚合并统一返回给客户端，这种聚合过程视场景而定，可以在一次请求中返回一组业务数据，从而降低客户端访问服务端的次数，提升系统的性能。</p>\n</li>\n</ol>\n<p>介绍完网关的作用，我们接下来看它所具备的基本结构和功能，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-15-11-53-33-9b00b78294f4eceb0d6e3de2e32e7b22-da4b5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 456px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 79.60526315789474%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsSAAALEgHS3X78AAADiUlEQVQ4yz2UeVfiWBDF8/2/Qs/0MtIuzVFQWQKEJBAksoZNCMgeUNuxlU1bu53zmyKO88c9qXfr1kulct9TTCNINhPAyu6+IbOLoe/QbJySPzvAlHjLZcyAj5y1R6N+IjVf32B+xTQCvu7cDqJY2b+YeTG8SYzxMEL/8pjJOMri3hQ+TqUUoHi+Q6vxjXYryGwa97V3f+uii1Cv7VMuBvz1aHCCUi6nKJwfy+5vsO0wdj4sG5vUanHp6FA6CUq3Ic4ElXKEQT9DsXAi+jfte229nkD59fwi3TywWixZPixYr9Zs1o8sHlYsl2uef74wnXgMByM/Xq02LBYr1qLZrDd+3Xvt9qlkXJfM9TXmbEbm6opEr0us1UDtXBBvt0h220SaNU7qVT/ecm+5JqrbwZzPyWwhtcZ4jBIdjmgAjsD6B2pTW7o84/tdlh8PFuOJSrtzjNs9xZul+HGf4+bWlO5zNHpx7Nfffm1VUBQoseGQtHym/vBA4u4etW6RdeKUhzblcRG1kuDUjhIrxkk6Kex+nsa8Qr5rEa3qJO6XGI/PpJaP2L9fUXZzJtPrLK32CbVmGKd1Sq8fRx330Lpl3JGB09MpuxrdaZbzYYHDsUd9lMOdWnRGJq2BzsAzSV9WUYKlAs60SLaeRK+qWC2NSs9Av/HIjxy6wzSFZgy7FqE3Mah5JSIyb3dmy2YGlU6ScjvB5TSD3q+jHDoVSrM6xVGJgsAeCC7zZO5vSQ6aGLUUetNAq2no9RRpt0haxqO3LDQZgeZopAR6LUly5KLsZHXmt1k67gmNVohaIyQGP8W8GWHLC+bTmM9XnW9MRlHp7IyQ/E3vRmo6IRrNI4rlfW6u5Au7RRStfUG02yG2tYLbRpU4ctFE9zzpsE/sokG8I1Zx/7NK18UUi8S2nM+3SEhuq0tITnl9+cVKDLxePf6PzWpr2JWPn08veNOZHLMpTxKvlhuWYuCt5l2/Nftm/cSj5BTDMUmV4hhij3RJRasImmk0ifVqQvgkx7kQR9aRr9EFmlhIk9mmtuuy6vPJQlRmraMcmJ+YX6kyo105o2FG1ynCpR2u5irlSoCpXBQduTx0yXuTqM99v05yfinnuL7PUC4Tx9njeqaSlctC2dd3Ocp8Zi/xgaD2kVAuwJ4VIGx8YV/9QCj9iUNrhz3jMyH9M/uiC0scFN2BLjntTw6Sf0juI8HCAf8CX9lEQ1W8+b8AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 15 11 53 33" title="" data-src="/static/2024-11-15-11-53-33-9b00b78294f4eceb0d6e3de2e32e7b22-da4b5.png" data-srcset="/static/2024-11-15-11-53-33-9b00b78294f4eceb0d6e3de2e32e7b22-e9143.png 200w,\n/static/2024-11-15-11-53-33-9b00b78294f4eceb0d6e3de2e32e7b22-e55e7.png 400w,\n/static/2024-11-15-11-53-33-9b00b78294f4eceb0d6e3de2e32e7b22-da4b5.png 456w" data-sizes="(max-width: 456px) 100vw, 456px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>总体而言，服务网关为分布式环境下的请求处理过程提供了强大的定制化技术能力，常见的扩展性、伸缩性、安全性和可用性等架构设计上的技术点在网关中都能得到体现。</p>\n<p>从扩展性和伸缩性角度讲，网关提供了服务路由支持，我们可以在网关层添加各种路由规则，确保来自客户端的请求能够以合适的方式发送到目标服务。在这个过程中，我们可以很轻松地实现请求转发、系统扩容等操作。</p>\n<p>一般而言，对于来自客户端的任何请求都需要考虑安全性，而服务网关最适合来完成这部分操作。实现访问安全性的前提是用户认证，我们可以在网关层添加各种身份认证、黑白名单、Token 校验等常见的安全性控制手段。</p>\n<p>最后，我们需要强调一下服务网关所具备的访问控制功能。在高并发系统中，我们通常会采用限流和降级等手段来防止服务出现不可用。这时候，我们就可以在服务网关上设置对应阈值或规则，从而确保来自客户端的请求不会流转到后台服务。</p>\n<h2 id="源码解析-12"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-12" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h2>\n<p>介绍完服务网关的作用和结构之后，我们接下来讨论具体的实现工具。这里，我们来到 Spring 家族中的 Spring Cloud Gateway 框架，这是目前最主流的服务网关之一。</p>\n<h3 id="spring-cloud-gateway-架构"><a href="#spring-cloud-gateway-%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Spring Cloud Gateway 架构</h3>\n<p>Spring Cloud Gateway 的核心功能是对 Web 请求进行路由和过滤，其内部大量依赖于 Spring 中的响应式 Web 框架 WebFlux。</p>\n<p>在接下来的内容中，我们先来分析 Spring WebFlux 技术栈，然后在此基础上引出 Spring Cloud Gateway 的整体架构。针对 Spring Cloud Gateway 这款框架，我建议你把它和 WebFlux 对比起来一起分析，这是一种非常有效的学习方法。</p>\n<p>虽然 WebFlux 和 WebMVC 是两个时代的技术体系，但事实上，Spring 也为传统 WebMVC 中的 HandlerMapping、HandlerAdapter 等组件提供了对应的响应式版本。这也体现了 Spring 所采用的一种设计理念，即充分利用现有组件进行增强，而不是轻易地替换。</p>\n<p>我们知道传统的 Servlet API 是阻塞式的，所以我们需要引入 ServerHttpRequest 和 ServerHttpResponse 这两个对象。在 WebFlux 中，它们分别代表着请求和响应本身。类似的，作为请求处理的核心组件，我们也需要引入一个新的过滤器链 WebFilterChain，定义如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50988232844988015000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface WebFilterChain {\n   Mono<Void> filter(ServerWebExchange exchange);\n}`, `50988232844988015000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">WebFilterChain</span> <span class="token punctuation">{</span>\n   <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>请注意，我们在这里并没有看到 ServerHttpRequest 和 ServerHttpResponse 这两个对象。实际上，上述代码中的 ServerWebExchange 内置了这两个对象，相当于是一个请求上下文。另一方面，我们发现 filter 方法返回的是一个 Mono 对象，也就意味着整个调用链路使用了响应式编程的开发模式。</p>\n<p>前面提到，HandlerMapping、HandlerAdapter 等核心对象在 WebFlux 中都能找到对应的实现，我们接下来看一下它们的定义，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62200942634210520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface HandlerMapping {\n   Mono<Object> getHandler(ServerWebExchange exchange);\n}\n\npublic interface HandlerAdapter {\n   Mono<HandlerResult> handle(ServerWebExchange exchange, Object handler);\n}`, `62200942634210520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">HandlerMapping</span> <span class="token punctuation">{</span>\n   <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">HandlerAdapter</span> <span class="token punctuation">{</span>\n   <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HandlerResult</span><span class="token punctuation">></span></span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>类似的，WebMVC 中的 RequestMappingHandlerMapping 和 RequestMappingHandlerAdapter 等对象也同样存在响应式版本。但是请注意，WebFlux 还专门提供了一套新的技术组件用来提供函数式编程的开发模式，这套组件就是 RouterFunctionMapping 和 HandlerFunctionAdapter。</p>\n<p>整个 WebFlux 的架构如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-15-14-23-43-fc69bd1637b6a85d3491d2a1529a1615-0e173.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 646px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 36.53250773993808%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABQUlEQVQoz31QDW+CMBDt//9DSzY3MycuJsvGiICC0PI1KB8CaoxT8Xl2Jssy4yXXa3vv3b07hit2PB5VbOoMgejDtu7gzO7B/Qc0TXzBdHSo2x8uO5P/e6eS2+0GWSbgexbm7gQy49hsVirXdR2ucRluWNsWiKMhpnYPs2mP1D5j2aa3KGBNk6KqIuR5gKIISYVAXSdYLgus1y39ewgCk1QayOUcq1VN+Zz+heKU5S+3pWYslxaSWKeRxqRCo1290pifKHKXgDEEPyt8Iu+D84EihtTAdTTCj2BOBiqeeTIzwJLYgBBvRNBgmS8EHFODD0jpYL8/YLc70L6g/Hv3844ik4oMMaMiuv54ETJCkuhgVSVIkUO7spGmDsLQojE8LBYJ0q8AVamDexpNMERZvBOGk/KQilqIQlvhfd9QLqWLE6ceCvPn8y+FAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 15 14 23 43" title="" data-src="/static/2024-11-15-14-23-43-fc69bd1637b6a85d3491d2a1529a1615-0e173.png" data-srcset="/static/2024-11-15-14-23-43-fc69bd1637b6a85d3491d2a1529a1615-2fb9f.png 200w,\n/static/2024-11-15-14-23-43-fc69bd1637b6a85d3491d2a1529a1615-f1e72.png 400w,\n/static/2024-11-15-14-23-43-fc69bd1637b6a85d3491d2a1529a1615-0e173.png 646w" data-sizes="(max-width: 646px) 100vw, 646px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>对 WebFlux 有了基本认识之后，我们来讨论 Spring Cloud Gateway。就请求响应模式而言，可以说 Spring Cloud Gateway 和 WebFlux 采用的是完全一样的处理方式。但 Spring Cloud Gateway 内部也提出了两个核心概念，一个是过滤器（Filter），一个是谓词（Predicate），它的整体架构如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-15-14-24-14-97ff936687558c377839126f177a3d9e-8fcec.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 645px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 38.29457364341086%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAAB0ElEQVQoz12SWW/aQBSF+f8/olKXPJCqREEgKHZYkiiErWG3McbGNmCMwZiyVVD4ajt9aY/0aeZqrkZz7pnY9Xol5BIQSppOycxs4l2Zj9UGN2/tgA4fyjW+NFrB2YKMprHZ7aL+0+nE+Xzm/Psc7WPX64WQS0ColrPgyXfoOW06AQ3rBxW9RnPWjOqWKyGulqz3e46HA8lOmnjzG7etBIlmkhj/qbv0EOUK3jTNevGAbaRRul/x5gLbVZ6hlCBr6tgrj7Xnodk6+sJg7BqYrkVsOqliGmUMo8HpeKRiWDxNeiwXRSQ5jbcuU63HUYYZ+v0ksppFsCc4a5/9dkvdfKM6aURUxjViilJClgqoaoVD0FDRdQrrJc9Wj0fzHWHYpGT0KOodHicDBHfBzHX56fu8qK/k5RL5fpHn4Us4Qwjj+JtJZFnQu1hGFtspIg9S1Bu3mJbIPKhVLUtaVyLLfmBZMYeo8xGjucZoOgpnGF0XJf0eikt+3GbnFZhZObb+E4aWYj4VcGYi6uCeO6mDf/zFMQhG1Aqk1AzZsUhmmAtf+O+36dgOwkSl3svw8Jqg1vtOUvhMUrzhPveJOyFYFZnN/hD1+xsf2Rgg6TKjmcYfr/I+fNDktqEAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 15 14 24 14" title="" data-src="/static/2024-11-15-14-24-14-97ff936687558c377839126f177a3d9e-8fcec.png" data-srcset="/static/2024-11-15-14-24-14-97ff936687558c377839126f177a3d9e-ba1e2.png 200w,\n/static/2024-11-15-14-24-14-97ff936687558c377839126f177a3d9e-72011.png 400w,\n/static/2024-11-15-14-24-14-97ff936687558c377839126f177a3d9e-8fcec.png 645w" data-sizes="(max-width: 645px) 100vw, 645px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>Spring Cloud Gateway 中的过滤器和 WebFlux、WebMVC 中的过滤器是同一个概念，都可以用于在响应 HTTP 请求之前或之后修改请求本身及对应的响应结果，区别在于两者的类型和实现方式。</p>\n<p>而所谓谓词，本质上是一种判断条件，用于将 HTTP 请求与路由进行匹配。Spring Cloud Gateway 内置了大量的谓词组件，可以分别基于 HTTP 请求的消息头、请求路径等常见的路由媒介进行自动匹配以便决定路由结果。</p>\n<h3 id="spring-cloud-gateway-工作流程"><a href="#spring-cloud-gateway-%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Spring Cloud Gateway 工作流程</h3>\n<p>Spring Cloud Gateway 中的核心概念就是路由和过滤，我们通过谓词判断获取 Web 请求的路由，然后基于一组过滤器执行过滤，并最终输出结果。在讨论具体的过滤器实现过程之前，我们先来关注整个请求处理流程。</p>\n<p>我们知道 Spring MVC 中有一个核心类 DispatcherServlet，而 WebFlux 中对应的核心类是 DispatcherHandler，该类充当着所有请求的入口，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-15-14-24-47-3f55173bc46d819a3a1fd9affd65c62f-04139.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 414px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 129.95169082125605%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAaCAYAAAC3g3x9AAAACXBIWXMAAAsSAAALEgHS3X78AAAE9ElEQVRIx3VVaXPaSBDl/3/dD1tbSVWOdbyJndjGNrcASYCQAHGDhUCAOMVpwGADNn7bGrDjTWWn6tXMaLqfumdezzien5/xK+x2d7dCqRSErrtRyF8il3VCr7hQLovYbB6Zze43vo4Xgl/bfLFEsyliNORR0WyiS4xHAoy6hPXm6bc+jNAerOZzLAn3iwXu7wiLOR6Wdxj0uui2TNQqGppGDR2zifHAwprWVmRj29r98uBvN0fWMBA2TYi9PnyNFnx1E15CoNkG1+pC6A9xksrgPF8CT+OA2YHX2NvYvZ/sxF4PfLuNSLEIx0W5jAwxc4MOcm0ZJUtFmaA2JCSNGNRmHHzWAyHnY/OkEUWxl0Kxn2J2KVNBcHaLNHH4x2M4XFWdTTyVLEb9AGbTCBazKPLZE3D+vxDhP0CWjqDEjxAKvENU+IDpWMBsEqE0Y2i3ArhuGlCJI77dwnF9IBTulviWz+KsXMAPwrlWYmOnfoP3YQ6fpAguaxp9L7LvNr7lMzgpFpAg/yQh9rAmQr2yD7epodUNo6x7GQo3btbfVH1I55zIFa+QL7uQK12jVPEwDMYSml0RH6UY5N0zpM3mDaFZgWZwEOKnCMdOIMrfqf/GINBYVL4jIHwBJx7DGzoCF/mKou5DtRPBl7QKnjKU9ylX9/k/7eCdzMDNFgjM5giRsIPLNbjVBu/kBI6KNwg9PCJ8v0aQNMqRjX86xzmdum8wRGR1/7KHe0Jlt2N9iqCy/bhHuNdARFdQ0P1IlrwQamnwpAbb0bax1SFtN/BZA4jL1X8JZSKUd0+Qnwik+B9F0p7nAyLcnyilj6EXTuB3/QFn6JROtc4OQSH76MMDAiQX4VfCxCG61NsoqcL4QReyIYO/ieOC9tt/u0CIUk4cIuQpVXe39zblvWzE5RLuhg5P00YVgY6BkGVCmFj4rEg4Tsm4rBRxXlRxrETgMjR4zRqcJCM/7aG4eonwcMpuLY27MYftvUS1LaJAaarSRxTUI2SVT8jIn9hYlT9jNgphu4rhkTC0OHzNphHdbBHfy2YfYdDqIFFXoLbTVE4pSjEGb1ZkuJA8uFL8COSj8GQEKPUk0i0VmbaKuJFAYDTcC3u9/u8eCtsd+PUjRLrurunCCOgZhBolfBG8+K7wCDfK8GkZuHoWImTDk4wij89sz21/6S2hLZskO5Bn1l+lBUz7HlhtL6L8e6jK31hMeHQbV3CWMiyr5MFWIVX8ltBeUJ6pp/llJoKu6YZp+qCmqCoKP2D1gzCqVzgv51hUP33+hzBhL9gGNHflJcwnAoZDEUnlK0rFC3oWZFg9Ds6b/E9C/CRke+iqHYRNgmZ/I7HahBfJMAbmFVr1a4jBd0jFP9P15kdDP8NZXt0Tvvrsg2G17NQ0JtCXK+ild9dKUGsiu2j9iWtwqge5lgy5wsPdMV8PMnmA/YMg1bdDqVQQoitcHAwQpRKKvWA6RXg4hji5ha/VAdfpQRhPwY8mbI3ZTMbkM4JgWVRRFgK5PD1SFOqUFifDIQytipqm73FTYWgZdUgCRaokYNYM+qbt1w42jaqBW/Kfjkb0ru7g2NGp2k1v1yiiKKRFEtGZckAC/DAGJ73HTnpK+ZGE6Fx5XY+Rbagnoj+0Xt/pV0KtWYHPDCLcjzIjG+F+BNcVL07VM/yTOIWLbu+w9Wadxv56EJ1eZ09IEf4LOfQ7kbMKyYEAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 15 14 24 47" title="" data-src="/static/2024-11-15-14-24-47-3f55173bc46d819a3a1fd9affd65c62f-04139.png" data-srcset="/static/2024-11-15-14-24-47-3f55173bc46d819a3a1fd9affd65c62f-53fb7.png 200w,\n/static/2024-11-15-14-24-47-3f55173bc46d819a3a1fd9affd65c62f-e3470.png 400w,\n/static/2024-11-15-14-24-47-3f55173bc46d819a3a1fd9affd65c62f-04139.png 414w" data-sizes="(max-width: 414px) 100vw, 414px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>上图中，DispatcherHander 的 handler 方法用来匹配不同的 HandlerMapping 并处理请求，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21107568148817690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Override\npublic Mono<Void> handle(ServerWebExchange exchange) {\n   if (this.handlerMappings == null) {\n      return createNotFoundError();\n   }\n\n   return Flux.fromIterable(this.handlerMappings)\n      .concatMap(mapping -> mapping.getHandler(exchange))\n      .next()\n      .switchIfEmpty(createNotFoundError())\n      // 这里根据获取到的 handler 进行处理\n      .flatMap(handler -> invokeHandler(exchange, handler))\n      .flatMap(result -> handleResult(exchange, result));\n}`, `21107568148817690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>handlerMappings <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token function">createNotFoundError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">return</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">fromIterable</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>handlerMappings<span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">concatMap</span><span class="token punctuation">(</span>mapping <span class="token operator">-></span> mapping<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">switchIfEmpty</span><span class="token punctuation">(</span><span class="token function">createNotFoundError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token comment">// 这里根据获取到的 handler 进行处理</span>\n      <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>handler <span class="token operator">-></span> <span class="token function">invokeHandler</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>result <span class="token operator">-></span> <span class="token function">handleResult</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这时候，DispatcherHander 就能在一组 handlerMappings 找到 RoutePredicateHandlerMapping，而这个 RoutePredicateHandlerMapping 也是在自动配置类 GatewayAutoConfiguration 中进行装配的，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1713961852087630800"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class GatewayAutoConfiguration {\n   @Bean\n   public RoutePredicateHandlerMapping routePredicateHandlerMapping(FilteringWebHandler webHandler, RouteLocator routeLocator, GlobalCorsProperties globalCorsProperties, Environment environment) {\n      return new RoutePredicateHandlerMapping(webHandler, routeLocator, globalCorsProperties, environment);\n   }\n}`, `1713961852087630800`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayAutoConfiguration</span> <span class="token punctuation">{</span>\n   <span class="token annotation punctuation">@Bean</span>\n   <span class="token keyword">public</span> <span class="token class-name">RoutePredicateHandlerMapping</span> <span class="token function">routePredicateHandlerMapping</span><span class="token punctuation">(</span><span class="token class-name">FilteringWebHandler</span> webHandler<span class="token punctuation">,</span> <span class="token class-name">RouteLocator</span> routeLocator<span class="token punctuation">,</span> <span class="token class-name">GlobalCorsProperties</span> globalCorsProperties<span class="token punctuation">,</span> <span class="token class-name">Environment</span> environment<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RoutePredicateHandlerMapping</span><span class="token punctuation">(</span>webHandler<span class="token punctuation">,</span> routeLocator<span class="token punctuation">,</span> globalCorsProperties<span class="token punctuation">,</span> environment<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>虽然在 DispatcherHander 的 handler 方法中，使用的是响应式编程的代码语法，但整个流程和 Spring MVC 中的处理机制非常类似。而在 RoutePredicateHandlerMapping 中，通过 getHandlerInternal 方法获取了当前请求的路由信息并放入了上下文中。注意到在这个方法中存在一个 lookupRoute 方法，该方法用来查找真正的路由信息，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79251360843369410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`protected Mono<Route> lookupRoute(ServerWebExchange exchange) {\n   return this.routeLocator.getRoutes()\n      .concatMap(\n         route -> Mono.just(route).filterWhen(r -> {\n            exchange.getAttributes().put(GATEWAY_PREDICATE_ROUTE_ATTR, r.getId());\n            // 根据断言获取到真正的 Route\n            return r.getPredicate().apply(exchange);\n         })\n         .doOnError()\n         .onErrorResume(e -> Mono.empty())\n      )\n      .next()\n      .map(route -> {\n         // ...\n         // 自定义的路由校验方法入口\n         validateRoute(route, exchange);\n         return route;\n      });\n}`, `79251360843369410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span><span class="token punctuation">></span></span> <span class="token function">lookupRoute</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>routeLocator<span class="token punctuation">.</span><span class="token function">getRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">concatMap</span><span class="token punctuation">(</span>\n         route <span class="token operator">-></span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filterWhen</span><span class="token punctuation">(</span>r <span class="token operator">-></span> <span class="token punctuation">{</span>\n            exchange<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>GATEWAY_PREDICATE_ROUTE_ATTR<span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">// 根据断言获取到真正的 Route</span>\n            <span class="token keyword">return</span> r<span class="token punctuation">.</span><span class="token function">getPredicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span>\n         <span class="token punctuation">.</span><span class="token function">doOnError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n         <span class="token punctuation">.</span><span class="token function">onErrorResume</span><span class="token punctuation">(</span>e <span class="token operator">-></span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>route <span class="token operator">-></span> <span class="token punctuation">{</span>\n         <span class="token comment">// ...</span>\n         <span class="token comment">// 自定义的路由校验方法入口</span>\n         <span class="token function">validateRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">return</span> route<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>显然，这里通过断言来获取路由信息。一旦获取路由信息之后，下一步就是加载各种过滤器了，这时候就来到了 FilteringWebHandler。该类实现了 WebHandler 接口，并在它的构造函数中通过一个 loadFilters 方法加载过滤器，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34161729617595314000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class FilteringWebHandler implements WebHandler {\n   protected static final Log logger = LogFactory.getLog(FilteringWebHandler.class);\n   private final List<GatewayFilter> globalFilters;\n\n   public FilteringWebHandler(List<GlobalFilter> globalFilters) {\n      this.globalFilters = loadFilters(globalFilters);\n   }\n\n   // 将传入的 GlobalFilter 转化为 GatewayFilter\n   private static List<GatewayFilter> loadFilters(List<GlobalFilter> filters) {\n      return filters.stream().map(filter -> {\n         GatewayFilterAdapter gatewayFilter = new GatewayFilterAdapter(filter);\n         if (filter instanceof Ordered) {\n            int order = ((Ordered) filter).getOrder();\n            return new OrderedGatewayFilter(gatewayFilter, order);\n         }\n         return gatewayFilter;\n      }).collect(Collectors.toList());\n   }\n\n   // …\n}`, `34161729617595314000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FilteringWebHandler</span> <span class="token keyword">implements</span> <span class="token class-name">WebHandler</span> <span class="token punctuation">{</span>\n   <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Log</span> logger <span class="token operator">=</span> <span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token class-name">FilteringWebHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GatewayFilter</span><span class="token punctuation">></span></span> globalFilters<span class="token punctuation">;</span>\n\n   <span class="token keyword">public</span> <span class="token class-name">FilteringWebHandler</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GlobalFilter</span><span class="token punctuation">></span></span> globalFilters<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>globalFilters <span class="token operator">=</span> <span class="token function">loadFilters</span><span class="token punctuation">(</span>globalFilters<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token comment">// 将传入的 GlobalFilter 转化为 GatewayFilter</span>\n   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GatewayFilter</span><span class="token punctuation">></span></span> <span class="token function">loadFilters</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GlobalFilter</span><span class="token punctuation">></span></span> filters<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> filters<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>filter <span class="token operator">-></span> <span class="token punctuation">{</span>\n         <span class="token class-name">GatewayFilterAdapter</span> gatewayFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GatewayFilterAdapter</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>filter <span class="token keyword">instanceof</span> <span class="token class-name">Ordered</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">int</span> order <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Ordered</span><span class="token punctuation">)</span> filter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OrderedGatewayFilter</span><span class="token punctuation">(</span>gatewayFilter<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         <span class="token keyword">return</span> gatewayFilter<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token comment">// …</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，上述 loadFilters 方法的作用就是将传入的 GlobalFilter 转化为 GatewayFilter，关于这两类过滤器我们后面还会介绍。</p>\n<p>我们接着来看 FilteringWebHandler 的 handle 方法，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20702898033606676000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Override\npublic Mono<Void> handle(ServerWebExchange exchange) {\n   // 从 ServerWebExchange 获取 Route\n   Route route = exchange.getRequiredAttribute(GATEWAY_ROUTE_ATTR);\n   // 从 Route 获取到 Filter\n   List<GatewayFilter> gatewayFilters = route.getFilters();\n\n   // 将 GlobalFilter 和路由的 Filter 合并\n   List<GatewayFilter> combined = new ArrayList<>(this.globalFilters);\n   combined.addAll(gatewayFilters);\n   // 对 Filter 排序\n   AnnotationAwareOrderComparator.sort(combined);\n\n   // 创建 FilterChain 并执行过滤\n   return new DefaultGatewayFilterChain(combined).filter(exchange);\n}`, `20702898033606676000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 从 ServerWebExchange 获取 Route</span>\n   <span class="token class-name">Route</span> route <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequiredAttribute</span><span class="token punctuation">(</span>GATEWAY_ROUTE_ATTR<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 从 Route 获取到 Filter</span>\n   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GatewayFilter</span><span class="token punctuation">></span></span> gatewayFilters <span class="token operator">=</span> route<span class="token punctuation">.</span><span class="token function">getFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token comment">// 将 GlobalFilter 和路由的 Filter 合并</span>\n   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GatewayFilter</span><span class="token punctuation">></span></span> combined <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>globalFilters<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   combined<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>gatewayFilters<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 对 Filter 排序</span>\n   <span class="token class-name">AnnotationAwareOrderComparator</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>combined<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token comment">// 创建 FilterChain 并执行过滤</span>\n   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultGatewayFilterChain</span><span class="token punctuation">(</span>combined<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上述方法中的几个步骤都很明确，而这里出现的 DefaultGatewayFilterChain 就是一种过滤器链，用来基于该链中的各个过滤器执行过滤操作，具体如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43955929366557550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Override\npublic Mono<Void> filter(ServerWebExchange exchange) {\n   return Mono.defer(() -> {\n      if (this.index < filters.size()) {\n         GatewayFilter filter = filters.get(this.index);\n         DefaultGatewayFilterChain chain = new DefaultGatewayFilterChain(this, this.index + 1);\n         return filter.filter(exchange, chain);\n      } else {\n         return Mono.empty();\n      }\n   });\n}`, `43955929366557550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">defer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">&lt;</span> filters<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token class-name">GatewayFilter</span> filter <span class="token operator">=</span> filters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token class-name">DefaultGatewayFilterChain</span> chain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultGatewayFilterChain</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">return</span> filter<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>显然，DefaultGatewayFilterChain 是一种典型的管道过滤器架构模式的应用方式，关于这一架构模式我们在后面还会有详细的讨论。</p>\n<p>在 Spring Cloud Gateway 中内置了许多过滤器，这些过滤器可以分成两大类，即 GatewayFilter 和 GlobalFilter，正如我们在前面的 FilteringWebHandler 中所看到的。其中，GatewayFilter 通过配置作用于每次路由，而 GlobalFilter 则作用于所有的请求。当一个请求被匹配到对应路由时，会将 GlobalFilter 和已绑定路由的 GatewayFilter 合并到一起。所有的过滤器都实现了 <code class="language-text">org.springframework.core.Ordered</code> 接口，因此会根据过滤器的 Order 值进行排序。</p>\n<p>在这里，我们无意对所有的过滤器做一一展开，而是挑选其中具有代表性的一个过滤器，并对它的实现过程进行分析，从而帮助你更好地理解过滤器的具体运行原理。</p>\n<p>这里我们以 RouteToRequestUrlFilter 为例来分析过滤器的实现机制，该过滤器用于根据 RouteUri 生成请求的真正 URL，并放入请求上下文中供后续 Filter 使用。RouteToRequestUrlFilter 的 filter 方法如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96173074439483880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Override\npublic Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {\n   Route route = exchange.getAttribute(GATEWAY_ROUTE_ATTR);\n   if (route == null) {\n      return chain.filter(exchange);\n   }\n\n   // 获取请求的 URI\n   URI uri = exchange.getRequest().getURI();\n   // 判断是否包含诸如 % 等的编码部分内容\n   boolean encoded = containsEncodedParts(uri);\n   // 获取 Route 的 uri\n   URI routeUri = route.getUri();\n   // 判断是否为其他类型的协议，如果是则根据特定协议生成 URI\n   if (hasAnotherScheme(routeUri)) {\n      // 将当前请求的 schema 放入上下文中\n      exchange.getAttributes().put(GATEWAY_SCHEME_PREFIX_ATTR, routeUri.getScheme());\n      routeUri = URI.create(routeUri.getSchemeSpecificPart());\n   }\n\n   // 如果 RouteUri 以 lb 开头，则请求中必须带有 host，否则直接抛出异常\n   if (&quot;lb&quot;.equalsIgnoreCase(routeUri.getScheme()) && routeUri.getHost() == null) {\n      throw new IllegalStateException(&quot;Invalid host: &quot; + routeUri.toString());\n   }\n\n   // 生成请求 URL，并放入上下文中\n   URI mergedUrl = UriComponentsBuilder\n      .fromUri(uri)\n      .scheme(routeUri.getScheme())\n      .host(routeUri.getHost())\n      .port(routeUri.getPort())\n      .build(encoded)\n      .toUri();\n   exchange.getAttributes().put(GATEWAY_REQUEST_URL_ATTR, mergedUrl);\n   return chain.filter(exchange);\n}`, `96173074439483880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token class-name">Route</span> route <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>GATEWAY_ROUTE_ATTR<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>route <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token comment">// 获取请求的 URI</span>\n   <span class="token class-name">URI</span> uri <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 判断是否包含诸如 % 等的编码部分内容</span>\n   <span class="token keyword">boolean</span> encoded <span class="token operator">=</span> <span class="token function">containsEncodedParts</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 获取 Route 的 uri</span>\n   <span class="token class-name">URI</span> routeUri <span class="token operator">=</span> route<span class="token punctuation">.</span><span class="token function">getUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 判断是否为其他类型的协议，如果是则根据特定协议生成 URI</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasAnotherScheme</span><span class="token punctuation">(</span>routeUri<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 将当前请求的 schema 放入上下文中</span>\n      exchange<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>GATEWAY_SCHEME_PREFIX_ATTR<span class="token punctuation">,</span> routeUri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      routeUri <span class="token operator">=</span> URI<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>routeUri<span class="token punctuation">.</span><span class="token function">getSchemeSpecificPart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token comment">// 如果 RouteUri 以 lb 开头，则请求中必须带有 host，否则直接抛出异常</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"lb"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>routeUri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> routeUri<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Invalid host: "</span> <span class="token operator">+</span> routeUri<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token comment">// 生成请求 URL，并放入上下文中</span>\n   <span class="token class-name">URI</span> mergedUrl <span class="token operator">=</span> <span class="token class-name">UriComponentsBuilder</span>\n      <span class="token punctuation">.</span><span class="token function">fromUri</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">scheme</span><span class="token punctuation">(</span>routeUri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">host</span><span class="token punctuation">(</span>routeUri<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">port</span><span class="token punctuation">(</span>routeUri<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>encoded<span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">toUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   exchange<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>GATEWAY_REQUEST_URL_ATTR<span class="token punctuation">,</span> mergedUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们在上述方法的关键代码语句中添加了注释。可以看到，一个典型的过滤器的实现过程基本就是从 ServerWebExchange 上下文中获取路由，然后根据路由中的详细信息来执行对应的操作。</p>\n<h2 id="解题要点-14"><a href="#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-14" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解题要点</h2>\n<p>对于服务网关而言，面试过程中关于网关基本概念的考查相对比较简单，我们不做展开。</p>\n<p>在准备面试的过程中，建议你熟练掌握至少一种服务网关的具体实现工具，例如本讲中介绍的 Spring Cloud Gateway 就是 Spring 家族自研的网关，内置了 Spring 框架自带的功能特性，非常适合进行系统的学习。和其他服务网关的实现机制类似，Spring Cloud Gateway 也是管道过滤器架构模式的一种典型应用，因此它的整体处理流程势必涉及到过滤器、过滤器链等组件。另一方面，因为 Spring Cloud Gateway 是 Spring 家族中的一员，其处理流程也依赖于 Spring 框架对 Web 请求和响应过程的抽象，这就需要引出 DispatcherHandler、RoutePredicateHandlerMapping 和 FilteringWebHandler 等一系列核心组件。</p>\n<p>从回答思路上讲，我们也可以基于这些组件从两个维度来阐述请求处理流程，一个是 Spring MVC 以及 WebFlux 中对 Web 请求的通用处理流程，另一个就是 Spring Cloud Gateway 内置的路由和过滤器维度。</p>\n<p>在本讲中，限于篇幅，我们没有对 Spring Cloud Gateway 所提供的限流等功能进行展开。但从面试点角度讲，对于这些具体功能特性的考查会比较综合，难度也比较大。</p>\n<p>一方面需要面试者对 Spring Cloud Gateway 作为服务网关的一些基本功能进行阐述，另一方面也需要面试者理解分布式环境下限流的概念和常见实现机制，以及 Spring Cloud Gateway 中的具体做法。以限流为例，因为考查的知识点比较多，所以我们重点把握几点。</p>\n<ol>\n<li>我们明确 Spring Cloud Gateway 中实现限流的工具是过滤器，而且是一种 GatewayFilter。</li>\n<li>我们明确这个过滤器实现限流时采用的是令牌桶算法。</li>\n<li>Spring Cloud Gateway 实现令牌桶算法借助的工具是 Redis。</li>\n<li>Redis 是通过一系列 Rua 脚本来完成令牌的申请和释放。</li>\n<li>我们需要明确通过 Spring Cloud Gateway 实现限流的做法是使用配置项，可以把重点的配置项做展开。</li>\n</ol>\n<p>这样，面试过程中涉及到的知识点就都已经介绍到了。关于这些特定的功能特性，你需要在本讲内容的基础上自己做进一步的学习和提升。</p>\n<p>作为扩展类话题，我们也可以对响应式编程做一些展开。响应式编程虽然已经出来有几年了，但在业务系统开发过程中应用并不广泛，目前主要还是为了满足高性能等技术需求，像 Spring Cloud Gateway 这种网关类消息中间件就是其最好的应用场景之一。虽然是一种新技术，但响应式编程也不是一种完全颠覆式的技术体系，而是在现有的异步调用、观察者模式、发布-订阅模式等的基础上发展起来的一种编程模式，能够为系统带来即时响应性。</p>\n<p>虽然，在本讲内容中，我们没有对响应式编程进行过多的展开，但对于技术原理型面试而言，对核心的新技术进行阐述无疑也是面试过程中的一个亮点。</p>\n<h2 id="小结与预告-12"><a href="#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-12" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结与预告</h2>\n<p>本章内容围绕服务网关展开讨论。在分布式架构中，服务网关的出现有其必然性。而以 Spring Cloud Gateway 为代表的实现技术在提供高性能的同时也丰富了作为服务网关的核心功能。我们重点对 Spring Cloud Gateway 中的基本架构、服务路由以及过滤器机制进行了详细的探讨。</p>\n<p>介绍完服务网关，我们下一个要引入的技术组件是配置中心。作为一个独立的服务端组件，配置中心需要完成与各个服务之间的交互，并统一管理这些服务中所有的配置信息。那么，配置中心和各个服务之间的这种交互过程是如何实现的呢？下一讲我们将围绕这个话题展开讨论。</p>\n<h1 id="配置中心：配置中心和各个服务之间是如何交互的？"><a href="#%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%EF%BC%9A%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%92%8C%E5%90%84%E4%B8%AA%E6%9C%8D%E5%8A%A1%E4%B9%8B%E9%97%B4%E6%98%AF%E5%A6%82%E4%BD%95%E4%BA%A4%E4%BA%92%E7%9A%84%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配置中心：配置中心和各个服务之间是如何交互的？</h1>\n<p>在上一讲中，我们详细讨论了服务网关这一分布式系统构建过程中必不可少的技术组件。我们知道随着服务数量的增多，在客户端和服务端之间应该架设一层网关来确保对请求进行路由和转发。事实上，针对配置信息的有效管理也是系统开发过程中的基本要求，这点对于分布式系统而言尤为明显。</p>\n<p>为了更好地管理系统中的各种配置信息，我们需要引入一个新的技术组件，即配置中心。和服务网关一样，配置中心同样也是一个独立的服务器组件。</p>\n<p>那么，问题就来了，原本分散在各个服务中的配置信息如何集中到配置中心进行统一管理呢？配置中心和各个服务之间又是如何交互的呢？在本讲内容中，我们将围绕这些问题展开讨论，并提供对应的面试题和开源框架原理分析。</p>\n<h2 id="问题背景-12"><a href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-12" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题背景</h2>\n<p>试想一下，在一个分布式系统中，势必存在多个服务，而这些服务一般都会构建开发、测试和生产等多套环境，每套环境都是一个集群。而针对不同的环境，我们都会采用一套不同的配置体系。那么如何保证多个环境中的这些配置信息都能在各个服务实例中进行实时的同步更新呢？</p>\n<p>显然，把配置信息分散在各个服务中交由它们自己管理是不合适的，我们需要引入一个集中式管理的工具。这个工具就是分布式系统中所必备的一个技术组件，即配置中心。有了配置中心之后，所有分散在各个服务、各个环境中的配置信息都将被收拢到配置中心进行统一管理，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-18-10-25-59-5020406204eef1d0f9c0fc346c71f0e2-0e173.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 646px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 46.749226006191954%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAAB7ElEQVQoz22Sa08aURCG9///iH5qopRIEVCuIqhRqCKXBffCHXe5GQR2Fygs8PTs1ia16SRPJmfeM5Mzc0aKv6S5GubJGHlSg2sy5g2xZpJg+TsRNU7ayAk8PUfW07opFFPDs8PxwPF4/IR0WwpQaAS4q55QaZ+TLX3ltnZCTvh7OUBRPfNjxUZQ3DnlhxpAVgtsf7ofRY+fkGbjLuO+wkjwPmozaMnMRi3mk47Pm6kzaMtMXjVGPYU3Q2Ntz3FWaxzH4V+TOjODztLDpDV/pWcP0d56vIjinm8vDLqW+eGFNuszX1l+8sKyeNR1Wu/vaNMp6niMFC1/I/saI90R7Q5iJLsRwqLl04cvRMUoMv0oSaFd9SJcCS3VDfGkFXE3OzqmQdgwiE0mpBYLblwXSW2kqVciVEvndJsZivdBlPqlj64kUBqXPNwFfP2xcEajeo5p/P6UzqBPXNe4FkXzwyG30wmSs16xdCwswfIDa2Vjbxzste3HF/YfzWZuLXD3ezabDcvlEne3Yy9e5ro7dtst0uVLgutpnuwoJ9ZHrI3goh0nJIeJ6hf+2cPTc+MbEkaK51aZ7XrL/0x6lqNUlDBPcohmP8lDJcijfEbhOUCpHqKqRymIWE2N8FQLUW+K0QxkP/nv/TscDj6/AEiTg9tWhOlLAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 18 10 25 59" title="" data-src="/static/2024-11-18-10-25-59-5020406204eef1d0f9c0fc346c71f0e2-0e173.png" data-srcset="/static/2024-11-18-10-25-59-5020406204eef1d0f9c0fc346c71f0e2-2fb9f.png 200w,\n/static/2024-11-18-10-25-59-5020406204eef1d0f9c0fc346c71f0e2-f1e72.png 400w,\n/static/2024-11-18-10-25-59-5020406204eef1d0f9c0fc346c71f0e2-0e173.png 646w" data-sizes="(max-width: 646px) 100vw, 646px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>针对上图，实际上我们已经可以梳理一组在日常面试过程中经常出现的话题，包括：</p>\n<ul>\n<li>配置中心如何区分来自不同环境的配置信息，并自动进行隔离？</li>\n<li>配置中心采用什么样的存储方式来保存配置信息？</li>\n<li>配置中心的基本组成结构是怎么样的？</li>\n<li>各个服务如何从配置中心中获取最新的配置信息？</li>\n<li>如果让你来设计一款配置中心，你会怎么做？</li>\n<li>你知道 Spring Cloud Config 中客户端和服务端之前的交互流程是怎么样的吗？</li>\n</ul>\n<p>上述问题体现的都是与配置中心相关的、比较常见的一些考查方式。就考查内容上而言，也主要包括两个维度，一个是理论知识，一个是具体工具框架的应用实践。</p>\n<h2 id="问题分析-13"><a href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-13" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题分析</h2>\n<p>关于系统中配置信息的管理，常见的做法是把它们存放在配置文件中。在单块系统中，普通的配置文件能够满足需求，围绕配置文件展开的配置管理工作通常不会有太大挑战。但在分布式系统中，配置文件的管理就会暴露出一些问题。针对这类问题，我们首先需要梳理配置中心的概念、在分布式系统中的定位，以及配置信息的分类和配置管理的需求等。</p>\n<p>基于配置中心的实现需求，业界存在一批典型的分布式配置中心实现工具，常见的包括 Etcd、Consul、Disconf、Diamond、Nacos 以及 Spring Cloud Config。显然，不同的工具具有不同的设计原理和实现机制。在面试过程中，候选人可以挑选自己最擅长的一个工具展开具体的讨论。</p>\n<p>最后，也是最重要的，就是配置中心与服务之间的交互关系。以我的经验，但凡涉及到配置中心的考查，这个问题是大概率要碰到的。任何一款配置中心实现框架都提供了一整套完善的集成机制，确保分布式系统中的各个服务能够快速高效地访问配置中心中的配置信息。而且，这个过程对于开发者而言通常是透明的，这就导致我们对这部分工作机制缺乏必要的认知，面试结果上也往往回答得不理想。</p>\n<p>讲到这里，你可能会问，配置中心到底长得怎么样呢？在接下来的内容中，我们先来梳理配置中心的基本模型。</p>\n<h2 id="技术体系-15"><a href="#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-15" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术体系</h2>\n<p>每一个分布式系统都应该有一个配置中心，下图展示了配置中心的定位以及它所应具备的基本结构：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-18-15-00-22-d57137a41b3e185718aa5ad5d02b063f-2b2cd.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 513px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 84.40545808966861%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAACmUlEQVQ4y5WU21PaUBCH+f8f2j50OtMne3no0FLrDRAooBISLnIJISSBgBhANEFEEkQk4ddNsF5KtfXM7Oyey37Zs3s2vsXCwaos4DiAKLKo1TaRzwc8qQobKBZ24Q73nOOs+vrwxJjNbNQVFuaYQbn0DXwpAP0sAVn6CdtePOUGn6pKqNcraDZFNNUqJKmI83PD2xyNRjhqNWm9QZGKaLePoOtn3p5lmgQvk1/Vk3qdh6qK8FX4AC5HSbqOH8ftHcymDKpVlsK//+p8bsO0rEeRuJCBHkO7tUXgAIaDOAx9Dz6ePyBYEtlMmPITI70NTVMfOdvzOSYU0cMxHBrg2C3KbRiH+QiEShyKzK7mcDqdodc7Qb3VQkc3SHQ0NA2iqqJjGNBortL8mMSyrlZz6FZ0KQ5sx/YWG90uXofDeBvawVeBx7tIGK9+fIdfKON9PIY34RAytZp39r7SS44HxO3E3XSH2OkhwO1iMmYxmRZgTnIYm1lcXRdhXaaRqsbAiPISeJvsO+DvUB8C+ZaGTS7oWmg1Q550O1GqeAiLmxzKrT0kivyDCO8r+Fdg5UjDOrNJVgkXgySGegLmcN/TmGdRUGJIlIT/BypUFH8pC07lwMgM0gpDOgWumfHsoHSIjFK/u/K/gZ0Odi9GSE6usVYW8UFQ8KVxjHXtFAlrihR1Sk5RXggcGCiQHVUKiOSCCHPbiMt5sLMZWNtGVpZfBowMz5GmDskLQXSpG/ReBJ2TPQT7p8jQmT+Bz1Z5GeEAzPUNyvUY+t0o+j3SBocdyi+HxcuAMgHj5hh5NxIpjv4J9alxAKlNz8W0cEjrGfnxO3z2yioBP+Wy2KJ2+8ymsZaIevIxtY8NKoZfEFCQlkDbWf4Xbcqrq38BFcXyFmRmkf0AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 18 15 00 22" title="" data-src="/static/2024-11-18-15-00-22-d57137a41b3e185718aa5ad5d02b063f-2b2cd.png" data-srcset="/static/2024-11-18-15-00-22-d57137a41b3e185718aa5ad5d02b063f-2a6c9.png 200w,\n/static/2024-11-18-15-00-22-d57137a41b3e185718aa5ad5d02b063f-aed38.png 400w,\n/static/2024-11-18-15-00-22-d57137a41b3e185718aa5ad5d02b063f-2b2cd.png 513w" data-sizes="(max-width: 513px) 100vw, 513px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在上图中，我们看到配置中心由两个核心组件构成，分别是配置仓库和配置服务器。</p>\n<ul>\n<li>\n<p>配置仓库</p>\n<p>配置中心中的所有配置信息都存放在一个配置仓库（Repository）中。配置仓库的实现方式有很多，我们可以采用 SVN 和 Gitlab 等具备版本控制功能的第三方工具，也可以自建一个具有持久化或内存存储功能的存储媒介。通常，开发人员通过配置管理和持续交付的各项模式和实践，并借助于特定工具完成配置仓库中配置信息的更新。</p>\n</li>\n<li>\n<p>配置服务器</p>\n<p>配置服务器封装对配置仓库的相关操作，充当配置仓库的管理者角色。和系统中的其他服务一样，它在物理上也是一个能够独立运行的服务，提供了对外的访问入口。当需要使用配置信息的服务启动时，这些服务就会使用这些访问入口获取存储在配置仓库中的各种配置信息。</p>\n</li>\n</ul>\n<p>显然，配置服务器需要屏蔽不同配置仓库实现在技术上的差异；另一方面，配置服务器也需要提供一种通知机制，确保配置仓库中的配置信息变化之后能够告知各个服务。关于这个问题实现起来比较复杂，我们放在下一讲中做专题讲解。</p>\n<p>介绍完配置中心的基本结构之后，我们接下来讨论作为一个配置中心所应具备的核心功能，包括隔离性、一致性和安全性。</p>\n<p>针对配置信息的管理，做到隔离性是最基本的要求。所谓隔离性，指的就是特定配置项只能用于特定环境中，不同环境中的配置项不应该相互混淆，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-18-15-01-18-6a929c4f9e87438e58e1106a5ae7bbc7-8d399.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 516px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 42.44186046511628%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABxklEQVQoz1VRaW/aUBD0//8LyQdyEHO5QAKNKtooKkEQ4+v5wNglxm5jICEhNodIAmK6NkJq39Nodp5Ga+8OV+5courWkZNLyMsCclIJFaeGq/s6nifP+Nx8YvPxgWtFhmBZKKoqCopCPgm5bjety70emNPHbrsFV2FXuF3coWRXUCTkTQE3cRNfpCpc28ViuUD0+oqarqPx9gbBccjbR4Gan0kycQ8/4hhtxjAOQ3CzlxkCP8CIRPgYEo/gez7m8Rz/nnkUkc8nz2OKgz+pA2+494zH4Nr2PVrDNn66LTQJCSdadCSslivs6GK3gzIYoEloJey6aDrungl39ObTB16ensDxShHX8Q2OxAyy/SIyLIvG6hbnbR5MYYjiCNPJBALtrjqdIqNpuKCxT00Tx7KMrG2jsV4jV6vtRw7CAIZrwnQtWL96KXTHQDgJ/xv5z2gExTCgUiOWhEA4aI32uVguUx9nDi1ovxm0gOAzsEBPte3beF+/U8obbAkG7UkcDiHRHkXPQ5fqAxI9pr9PG/LdAr7OvuPczIOnkY/Fk1SftXjoqo45pTwjc5lGrlPapQcPxcEDTlQNR50OTindbxSgSGkn5y+hGzEmMiIGHwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 18 15 01 18" title="" data-src="/static/2024-11-18-15-01-18-6a929c4f9e87438e58e1106a5ae7bbc7-8d399.png" data-srcset="/static/2024-11-18-15-01-18-6a929c4f9e87438e58e1106a5ae7bbc7-8ba40.png 200w,\n/static/2024-11-18-15-01-18-6a929c4f9e87438e58e1106a5ae7bbc7-7e253.png 400w,\n/static/2024-11-18-15-01-18-6a929c4f9e87438e58e1106a5ae7bbc7-8d399.png 516w" data-sizes="(max-width: 516px) 100vw, 516px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>一致性的讨论对象是集群环境，即在一个集群环境中的所有服务都应该使用同一份完全相同的配置信息，针对配置信息的操作结果对于这些服务而言应该是完全一致的，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-18-15-01-44-d61ee364ea5398bbb23523be3056a5cd-ab538.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 564px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 38.297872340425535%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABnElEQVQoz3WOa3PSUBRF8/9/gx/saOsIBVugNuGRUl4DCHRsEyAtMRAEJdCKthaB5C5vYutjxp6ZNWf23ufce5SUo3I4OP6DfUzaVsk4GrvtOM9Od3he2+VlK0ZK+ukHUg/zv7v0DnpHKKXPeU7GWYqTXITuamRdlexY49BIEG+9InH2mpSRRP+YlZmGNlIpyFwP56V3InuoVectyt3ylO5FDPdDRvY4wbrJWXuP1rsX/Phew+olmE1z9M197m8rNOo7mHJueV3EMhMM7TQ9Y5/bZSnKlfP3Oo2GRqdToFJOUy4fUJI99Kx+hWZDJZ+P0W7lIl2vq1QrGQrSq1Yz0s/TbGpcnBfp92oo63WA7xOx3vgsFks8b8FqtSEsIbGsAV+/3UX6frVmNlvIuS9styLC9wWbTSARKPynAn/L4NJicHXJYu7Jy3qMRyNsqUPfl/lTpQgheCQQIjK7jkPBm6G5LknTJHM14Mi2yU2nZCcTzOHw18dBwN/7If9cKB4flAv6fE7R84h1OrwxTJKGQeXmhtynKV157VMP/gS9qjrAKzmGuwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 18 15 01 44" title="" data-src="/static/2024-11-18-15-01-44-d61ee364ea5398bbb23523be3056a5cd-ab538.png" data-srcset="/static/2024-11-18-15-01-44-d61ee364ea5398bbb23523be3056a5cd-4fcfe.png 200w,\n/static/2024-11-18-15-01-44-d61ee364ea5398bbb23523be3056a5cd-9c055.png 400w,\n/static/2024-11-18-15-01-44-d61ee364ea5398bbb23523be3056a5cd-ab538.png 564w" data-sizes="(max-width: 564px) 100vw, 564px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>最后的安全性比较容易理解，即只有在通过合法的授权之后，开发人员才能访问配置中心中的关键配置内容，从而避免敏感信息的泄露。我们需要讨论两个维度，一个维度是从配置服务器的角度出发确保位于服务器上的配置信息不被随意访问，另一个维度则是从数据传输的角度出发确保敏感配置信息得到应有的保护。</p>\n<p>在接下来的内容中，我们继续介绍 Spring Cloud 框架，并选择 Spring 家族自研的 Spring Cloud Config 配置中心展开讨论。Spring Cloud Config 使用起来非常简洁，也便于管理，对于所有的配置数据都开放了一套完整的 RESTful API，任何系统都可以基于 HTTP 协议来访问配置仓库中的配置数据，从而构建满足多样化需求的管理界面。</p>\n<h2 id="源码解析-13"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-13" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h2>\n<p>在 Spring Cloud Config 中，整体结构分成非常清晰的两部分，即代表服务器端组件的 Spring Cloud Config Server 和代表客户端组件的 Spring Cloud Config Client，我们先从服务器端开始讲起。</p>\n<h3 id="spring-cloud-config-server-工作机制"><a href="#spring-cloud-config-server-%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Spring Cloud Config Server 工作机制</h3>\n<p>对于 Spring Cloud Config 而言，它把所有的配置信息抽象为一种 Environment（环境），而存储这些配置信息的地方就称为 EnvironmentRepository。</p>\n<p>EnvironmentRepository 就是最常用的基于配置仓库的配置中心实现方案的具体体现。EnvironmentRepository 接口定义如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55313587601029980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface EnvironmentRepository {\n   Environment findOne(String application, String profile, String label);\n}`, `55313587601029980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">EnvironmentRepository</span> <span class="token punctuation">{</span>\n   <span class="token class-name">Environment</span> <span class="token function">findOne</span><span class="token punctuation">(</span><span class="token class-name">String</span> application<span class="token punctuation">,</span> <span class="token class-name">String</span> profile<span class="token punctuation">,</span> <span class="token class-name">String</span> label<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>可以看到这个接口非常简单，基于上述 findOne 方法定义以及对配置中心基本模型的了解，我们发现 Spring Cloud Config 中把配置信息抽象为如下三个维度进行管理</p>\n<ul>\n<li>应用 (application)</li>\n<li>环境 (profile)</li>\n<li>版本 (label)</li>\n</ul>\n<p>通过这三个维度，我们就可以确定一份唯一的配置数据。</p>\n<p>EnvironmentRepository 的实现类非常多，那么我们选择哪一个 EnvironmentRepository 来作为切入点呢？这个问题实际上不难回答，因为 Spring Cloud Config 为我们提供了一个默认的 EnvironmentRepositoryConfiguration，即 DefaultRepositoryConfiguration，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11674827980696945000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Configuration\n@ConditionalOnMissingBean(value = EnvironmentRepository.class, search = SearchStrategy.CURRENT)\nclass DefaultRepositoryConfiguration {\n   @Autowired\n   private ConfigurableEnvironment environment;\n\n   @Autowired\n   private ConfigServerProperties server;\n\n   @Autowired(required = false)\n   private TransportConfigCallback customTransportConfigCallback;\n\n   @Bean\n   public MultipleJGitEnvironmentRepository defaultEnvironmentRepository(MultipleJGitEnvironmentRepositoryFactory gitEnvironmentRepositoryFactory,  MultipleJGitEnvironmentProperties environmentProperties) throws Exception {\n      return gitEnvironmentRepositoryFactory.build(environmentProperties);\n   }\n}`, `11674827980696945000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>\n<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">EnvironmentRepository</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> search <span class="token operator">=</span> <span class="token class-name">SearchStrategy</span><span class="token punctuation">.</span>CURRENT<span class="token punctuation">)</span>\n<span class="token keyword">class</span> <span class="token class-name">DefaultRepositoryConfiguration</span> <span class="token punctuation">{</span>\n   <span class="token annotation punctuation">@Autowired</span>\n   <span class="token keyword">private</span> <span class="token class-name">ConfigurableEnvironment</span> environment<span class="token punctuation">;</span>\n\n   <span class="token annotation punctuation">@Autowired</span>\n   <span class="token keyword">private</span> <span class="token class-name">ConfigServerProperties</span> server<span class="token punctuation">;</span>\n\n   <span class="token annotation punctuation">@Autowired</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>\n   <span class="token keyword">private</span> <span class="token class-name">TransportConfigCallback</span> customTransportConfigCallback<span class="token punctuation">;</span>\n\n   <span class="token annotation punctuation">@Bean</span>\n   <span class="token keyword">public</span> <span class="token class-name">MultipleJGitEnvironmentRepository</span> <span class="token function">defaultEnvironmentRepository</span><span class="token punctuation">(</span><span class="token class-name">MultipleJGitEnvironmentRepositoryFactory</span> gitEnvironmentRepositoryFactory<span class="token punctuation">,</span>  <span class="token class-name">MultipleJGitEnvironmentProperties</span> environmentProperties<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> gitEnvironmentRepositoryFactory<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>environmentProperties<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，这里出现了一个 MultipleJGitEnvironmentRepository，而 MultipleJGitEnvironmentRepository 则继承了抽象类 JGitEnvironmentRepository。不难看出，Spring Cloud Config 底层默认使用的 EnvironmentRepository 就是我们所熟悉的 Git。</p>\n<p>在 JGitEnvironmentRepository 抽象类中，提供了大量针对第三方 Git 仓库的操作代码，这些都不是理解配置中心的重点内容，这里不做展开。我们只需要明白，无论采用 Git、SVN 等具体哪一种配置仓库的实现方式，最终我们处理的对象都是位于本地文件系统中的配置文件。为了理解这点，我们需要围绕 MultipleJGitEnvironmentRepository 类从底向上回顾整个类层结构，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-18-15-03-26-3fdf77af5f02641eaabf0eb1c9b966e2-a40ca.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 647px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 46.21329211746522%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABmElEQVQoz3VSa0/CQBDs///sB2KMGk1AG0384jNieIo8W1paUKRQaIEIFQoaAu0xbg+NinjJZHfvdrYzmwrYcDyPoarHUMxHUMiLKOSOIUsnKBZEZB/oLhdBWb7YRIXgeT4CMLbkCPLZbIH6Uw5a5Qq1ahRPtTuoyiXPq/otv9e1BBYLBt9nWC6XXMR87kEwW1l07SyU8g01RfHSz8NsSZhM3qnZ5wTGGBznlUgerwMMhw715WA0kpBK1zw6QwmCVDoiNaeoqEdkI0xqRBp8Q1/3f1lZr8fjMXHO8FgVocgR1HQRtnUOoWnIpLCCblfj0bYUNI0KptN3DAcdmKYK266RAhltU0Ono6HXMzAajWAYZfS6K65tqbAIAv455JKv4S66hfvULlLJHcRj20jEQ8jcn/xHgxAs9CfAI+OPb28uXLdP+3whZXW4Y8qD2nX4e9C3zv8zkA+lMxhYaDwX0G6rtPwyWS6RZYXXbVNGv9/6HPrN4Qr/Wl2pe64XEb0NIZs5RDq5T/9jGA+UZ9IHZHkPup7+NfALHxPKmvtOuzbBAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 18 15 03 26" title="" data-src="/static/2024-11-18-15-03-26-3fdf77af5f02641eaabf0eb1c9b966e2-a40ca.png" data-srcset="/static/2024-11-18-15-03-26-3fdf77af5f02641eaabf0eb1c9b966e2-3426a.png 200w,\n/static/2024-11-18-15-03-26-3fdf77af5f02641eaabf0eb1c9b966e2-f3a4f.png 400w,\n/static/2024-11-18-15-03-26-3fdf77af5f02641eaabf0eb1c9b966e2-a40ca.png 647w" data-sizes="(max-width: 647px) 100vw, 647px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>从类的命名和职责上讲，AbstractScmEnvironmentRepository 是 JGitEnvironmentRepository 的父类，其主要目的是建立能够在本地进行配置信息管理所需要的文件环境，它的 findOne 方法如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30730953774823930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public synchronized Environment findOne(String application, String profile, String label) {\n   NativeEnvironmentRepository delegate = new NativeEnvironmentRepository(getEnvironment(), new NativeEnvironmentProperties());\n   Locations locations = getLocations(application, profile, label);\n   delegate.setSearchLocations(locations.getLocations());\n   Environment result = delegate.findOne(application, profile, &quot;&quot;);\n   result.setVersion(locations.getVersion());\n   result.setLabel(label);\n   return this.cleaner.clean(result, getWorkingDirectory().toURI().toString(),getUri());\n}`, `30730953774823930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">Environment</span> <span class="token function">findOne</span><span class="token punctuation">(</span><span class="token class-name">String</span> application<span class="token punctuation">,</span> <span class="token class-name">String</span> profile<span class="token punctuation">,</span> <span class="token class-name">String</span> label<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token class-name">NativeEnvironmentRepository</span> delegate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeEnvironmentRepository</span><span class="token punctuation">(</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">NativeEnvironmentProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token class-name">Locations</span> locations <span class="token operator">=</span> <span class="token function">getLocations</span><span class="token punctuation">(</span>application<span class="token punctuation">,</span> profile<span class="token punctuation">,</span> label<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   delegate<span class="token punctuation">.</span><span class="token function">setSearchLocations</span><span class="token punctuation">(</span>locations<span class="token punctuation">.</span><span class="token function">getLocations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token class-name">Environment</span> result <span class="token operator">=</span> delegate<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>application<span class="token punctuation">,</span> profile<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   result<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span>locations<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   result<span class="token punctuation">.</span><span class="token function">setLabel</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cleaner<span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token function">getWorkingDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">getUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里出现了一个 NativeEnvironmentRepository，从命名上我们不难看出这个 EnvironmentRepository 操作的对象是本地文件。我们同样关注它的 findOne 方法，如下所示（简单起见做了裁剪）：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19375860601552806000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Override\npublic Environment findOne(String config, String profile, String label) {\n   SpringApplicationBuilder builder = new SpringApplicationBuilder(PropertyPlaceholderAutoConfiguration.class);\n   ConfigurableEnvironment environment = getEnvironment(profile);\n   builder.environment(environment);\n   builder.web(WebApplicationType.NONE).bannerMode(Mode.OFF);\n\n   // 获取配置信息的参数\n   String[] args = getArgs(config, profile, label);\n\n   // 设置监听器用于监听配置文件的变化\n   builder.application().setListeners(Arrays.asList(new ConfigFileApplicationListener()));\n   ConfigurableApplicationContext context = builder.run(args);\n   environment.getPropertySources().remove(&quot;profiles&quot;);\n\n   try {\n      return clean(new PassthruEnvironmentRepository(environment).findOne(config, profile, label));\n   } finally {\n      context.close();\n   }\n}`, `19375860601552806000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token class-name">Environment</span> <span class="token function">findOne</span><span class="token punctuation">(</span><span class="token class-name">String</span> config<span class="token punctuation">,</span> <span class="token class-name">String</span> profile<span class="token punctuation">,</span> <span class="token class-name">String</span> label<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token class-name">SpringApplicationBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpringApplicationBuilder</span><span class="token punctuation">(</span><span class="token class-name">PropertyPlaceholderAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token class-name">ConfigurableEnvironment</span> environment <span class="token operator">=</span> <span class="token function">getEnvironment</span><span class="token punctuation">(</span>profile<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   builder<span class="token punctuation">.</span><span class="token function">environment</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   builder<span class="token punctuation">.</span><span class="token function">web</span><span class="token punctuation">(</span><span class="token class-name">WebApplicationType</span><span class="token punctuation">.</span>NONE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bannerMode</span><span class="token punctuation">(</span><span class="token class-name">Mode</span><span class="token punctuation">.</span>OFF<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token comment">// 获取配置信息的参数</span>\n   <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> <span class="token function">getArgs</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> profile<span class="token punctuation">,</span> label<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token comment">// 设置监听器用于监听配置文件的变化</span>\n   builder<span class="token punctuation">.</span><span class="token function">application</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setListeners</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConfigFileApplicationListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token class-name">ConfigurableApplicationContext</span> context <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   environment<span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">"profiles"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token function">clean</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PassthruEnvironmentRepository</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> profile<span class="token punctuation">,</span> label<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>\n      context<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从代码结构上，我们看到 NativeEnvironmentRepository 最终委托 PassthruEnvironmentRepository 完成了配置文件的读取，然后通过 clean 方法完成本地文件地址与远程仓库之间地址的转换。同时，这里用到了 Spring Boot 自带的 ConfigFileApplicationListener 来监听配置文件的变化。</p>\n<p>讲到这里，我们已经明确了 EnvironmentRepository 的设计和实现过程，接下来我们要讨论如何将配置信息的访问入口暴露给各个服务。</p>\n<p>在 Spring Cloud Config 中，通过 EnvironmentRepository 获取的配置信息最终通过 EnvironmentController 暴露给客户端应用程序进行调用，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42694586908042990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@RestController\n@RequestMapping(method = RequestMethod.GET, path = &quot;\\${spring.cloud.config.server.prefix:}&quot;)\npublic class EnvironmentController {\n   private EnvironmentRepository repository;\n   private ObjectMapper objectMapper;\n}`, `42694586908042990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@RestController</span>\n<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">,</span> path <span class="token operator">=</span> <span class="token string">"${spring.cloud.config.server.prefix:}"</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EnvironmentController</span> <span class="token punctuation">{</span>\n   <span class="token keyword">private</span> <span class="token class-name">EnvironmentRepository</span> repository<span class="token punctuation">;</span>\n   <span class="token keyword">private</span> <span class="token class-name">ObjectMapper</span> objectMapper<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到它的关键成员变量有两个，即 EnvironmentRepository 和 ObjectMapper。前者是具体某一个 EnvironmentRepository 的实例，而 ObjectMapper 则用于序列化。</p>\n<p>EnvironmentController 提供了多种获取配置信息的方法，这些方法主要就是前面介绍的 application、profile、label 这三个（或者更少）参数，其中最重要的方法就是如下所示的 defaultLabel 方法和 labelled 方法，这些方法暴露了获取配置的最常用的一组 HTTP 端点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24767197071298910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@RequestMapping(&quot;/{name}/{profiles:.*[^-].*}&quot;)\npublic Environment defaultLabel(@PathVariable String name, @PathVariable String profiles) {\n   return labelled(name, profiles, null);\n}\n\n@RequestMapping(&quot;/{name}/{profiles}/{label:.*}&quot;)\npublic Environment labelled(@PathVariable String name, @PathVariable String profiles, @PathVariable String label) {\n   Environment environment = this.repository.findOne(name, profiles, label);\n   if (!acceptEmpty && (environment == null || environment.getPropertySources().isEmpty())) {\n      throw new EnvironmentNotFoundException(&quot;Profile Not found&quot;);\n   }\n   return environment;\n}`, `24767197071298910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/{name}/{profiles:.*[^-].*}"</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token class-name">Environment</span> <span class="token function">defaultLabel</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> profiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> <span class="token function">labelled</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> profiles<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/{name}/{profiles}/{label:.*}"</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token class-name">Environment</span> <span class="token function">labelled</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> profiles<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> label<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token class-name">Environment</span> environment <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>repository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> profiles<span class="token punctuation">,</span> label<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>acceptEmpty <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>environment <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> environment<span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EnvironmentNotFoundException</span><span class="token punctuation">(</span><span class="token string">"Profile Not found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">return</span> environment<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，在 labelled 方法中，会调用 EnvironmentRepository 的 findOne 方法来加载配置，然后返回给配置的消费者，即 Spring Cloud Config 的客户端服务。</p>\n<h3 id="spring-cloud-config-client-工作机制"><a href="#spring-cloud-config-client-%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Spring Cloud Config Client 工作机制</h3>\n<p>使用过 Spring Cloud Config 的同学也都知道，想要在一个服务中集成配置中心，只需在 Spring Boot 的配置文件中添加对服务器地址的引用即可。当然，前提是在类路径中添加对 Spring Cloud Config 的引用。那么，为什么只要添加了引用，就会在服务启动时自动获取远程的配置信息呢？这就是我们接下来需要回答的问题。</p>\n<p>在介绍 Spring Cloud Config 时，我们将采用反推的方法，即从获取服务器端配置信息的入口开始，逐步引出这个问题的答案。</p>\n<p>我们首先找到的是 ConfigServicePropertySourceLocator 类，因为我们在这个类中发现了一个 getRemoteEnvironment 方法。显然，作为客户端组件，Spring Cloud Config Client 的主要职责就是获取服务器端提供的配置项信息。我们已经知道在 Spring Cloud Config Server 中提供了一个 EnvironmentController 来暴露配置信息，那么在客户端中势必存在一个入口来获取这些配置信息。</p>\n<p>这个入口就是 getRemoteEnvironment 方法，如下所示（简单起见做了裁剪）：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66950525165959250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`private Environment getRemoteEnvironment(RestTemplate restTemplate, ConfigClientProperties properties, String label, String state) {\n   // 根据服务器端点的 URL 准备参数\n   String path = &quot;/{name}/{profile}&quot;;\n   String name = properties.getName();\n   String profile = properties.getProfile();\n   String token = properties.getToken();\n   int noOfUrls = properties.getUri().length;\n\n   // 处理 URL 中的 label\n   Object[] args = new String[] { name, profile };\n   if (StringUtils.hasText(label)) {\n      if (label.contains(&quot;/&quot;)) {\n         label = label.replace(&quot;/&quot;, &quot;(_)&quot;);\n      }\n      args = new String[] { name, profile, label };\n      path = path + &quot;/{label}&quot;;\n   }\n   ResponseEntity<Environment> response = null;\n\n   for (int i = 0; i < noOfUrls; i++) {\n      // 准备用于安全访问的 Credentials 信息\n      Credentials credentials = properties.getCredentials(i);\n      String uri = credentials.getUri();\n      String username = credentials.getUsername();\n      String password = credentials.getPassword();\n      try {\n         HttpHeaders headers = new HttpHeaders();\n         addAuthorizationToken(properties, headers, username, password);\n         if (StringUtils.hasText(token)) {\n            headers.add(TOKEN_HEADER, token);\n         }\n         if (StringUtils.hasText(state) && properties.isSendState()) {\n            headers.add(STATE_HEADER, state);\n         }\n         headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));\n\n         // 通过 RestTemplate 执行远程访问\n         final HttpEntity<Void> entity = new HttpEntity<>((Void) null, headers);\n         response = restTemplate.exchange(uri + path, HttpMethod.GET, entity, Environment.class, args);\n      }\n      // 省略 catch 处理和空值校验\n\n      Environment result = response.getBody();\n      return result;\n   }\n\n   return null;\n}`, `66950525165959250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Environment</span> <span class="token function">getRemoteEnvironment</span><span class="token punctuation">(</span><span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">,</span> <span class="token class-name">ConfigClientProperties</span> properties<span class="token punctuation">,</span> <span class="token class-name">String</span> label<span class="token punctuation">,</span> <span class="token class-name">String</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 根据服务器端点的 URL 准备参数</span>\n   <span class="token class-name">String</span> path <span class="token operator">=</span> <span class="token string">"/{name}/{profile}"</span><span class="token punctuation">;</span>\n   <span class="token class-name">String</span> name <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token class-name">String</span> profile <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">getProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token class-name">String</span> token <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">int</span> noOfUrls <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">getUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>\n\n   <span class="token comment">// 处理 URL 中的 label</span>\n   <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> profile <span class="token punctuation">}</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>label<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         label <span class="token operator">=</span> label<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token string">"(_)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> profile<span class="token punctuation">,</span> label <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      path <span class="token operator">=</span> path <span class="token operator">+</span> <span class="token string">"/{label}"</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Environment</span><span class="token punctuation">></span></span> response <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> noOfUrls<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 准备用于安全访问的 Credentials 信息</span>\n      <span class="token class-name">Credentials</span> credentials <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token class-name">String</span> uri <span class="token operator">=</span> credentials<span class="token punctuation">.</span><span class="token function">getUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token class-name">String</span> username <span class="token operator">=</span> credentials<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token class-name">String</span> password <span class="token operator">=</span> credentials<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">try</span> <span class="token punctuation">{</span>\n         <span class="token class-name">HttpHeaders</span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token function">addAuthorizationToken</span><span class="token punctuation">(</span>properties<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            headers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>TOKEN_HEADER<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> properties<span class="token punctuation">.</span><span class="token function">isSendState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            headers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>STATE_HEADER<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         headers<span class="token punctuation">.</span><span class="token function">setAccept</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span>APPLICATION_JSON<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n         <span class="token comment">// 通过 RestTemplate 执行远程访问</span>\n         <span class="token keyword">final</span> <span class="token class-name">HttpEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Void</span><span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         response <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span>uri <span class="token operator">+</span> path<span class="token punctuation">,</span> <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">,</span> entity<span class="token punctuation">,</span> <span class="token class-name">Environment</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// 省略 catch 处理和空值校验</span>\n\n      <span class="token class-name">Environment</span> result <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> result<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上述代码虽然有点长，但我们对照 EnvironmentController 端点的实现方法，很容易理解它的执行流程就是通过 RestTemplate 发起一个 HTTP 请求。请求对象的构建需要获取 application、profile、label 等参数，而请求结果则通过 JSON 反序列化为一个 Environment 对象。我们通过这个 Environment 对象就能获取所有相关的配置数据。</p>\n<p>明白了获取远程配置信息的处理方式，我们来反推 getRemoteEnvironment 方法的触发过程。我们通过代码的调用路径，发现在一个 locate 方法中使用到了这个方法。而讲到这个方法就必须介绍 Spring Cloud 中的一个重要的工具类 PropertySourceLocator。</p>\n<p>在 Spring Cloud 中，PropertySourceLocator 接口定义如下，只包含前面提到的一个 locate 方法，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50975132383083510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface PropertySourceLocator {\n   PropertySource<?> locate(Environment environment);\n}`, `50975132383083510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PropertySourceLocator</span> <span class="token punctuation">{</span>\n   <span class="token class-name">PropertySource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">locate</span><span class="token punctuation">(</span><span class="token class-name">Environment</span> environment<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>PropertySourceLocator 接口位于 spring-cloud-context 代码工程中的 org.springframework.cloud.bootstrap.config 包下。当我们看到类的命名以及结合服务启动时自动获取配置信息这一主题应该能够联想到，PropertySourceLocator 肯定被内嵌在一个配置类中，我们在 PropertySourceLocator 接口所在的包结构中找到了 PropertySourceBootstrapConfiguration。这个类实际上非常好找，因为在同一个包结构中一共也只有三个类。</p>\n<p>PropertySourceBootstrapConfiguration 中的实现过程如下所示（代码做了裁剪）：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12707551216201640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Configuration\n@EnableConfigurationProperties(PropertySourceBootstrapProperties.class)\npublic class PropertySourceBootstrapConfiguration implements ApplicationContextInitializer<ConfigurableApplicationContext>, Ordered {\n   private List<PropertySourceLocator> propertySourceLocators = new ArrayList<>();\n\n   public void setPropertySourceLocators(Collection<PropertySourceLocator> propertySourceLocators) {\n      this.propertySourceLocators = new ArrayList<>(propertySourceLocators);\n   }\n\n   @Override\n   public void initialize(ConfigurableApplicationContext applicationContext) {\n      // ...\n      ConfigurableEnvironment environment = applicationContext.getEnvironment();\n      for (PropertySourceLocator locator : this.propertySourceLocators) {\n         PropertySource<?> source = null;\n\n         // 调用各个 PropertySourceLocator 的 locate 方法\n         source = locator.locate(environment);\n         // ...\n      }\n      // ...\n   }\n   // 省略了其他变量和方法\n}`, `12707551216201640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>\n<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">PropertySourceBootstrapProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PropertySourceBootstrapConfiguration</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationContextInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigurableApplicationContext</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>\n   <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PropertySourceLocator</span><span class="token punctuation">></span></span> propertySourceLocators <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPropertySourceLocators</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PropertySourceLocator</span><span class="token punctuation">></span></span> propertySourceLocators<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>propertySourceLocators <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>propertySourceLocators<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token annotation punctuation">@Override</span>\n   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableApplicationContext</span> applicationContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// ...</span>\n      <span class="token class-name">ConfigurableEnvironment</span> environment <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">PropertySourceLocator</span> locator <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>propertySourceLocators<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token class-name">PropertySource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> source <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n\n         <span class="token comment">// 调用各个 PropertySourceLocator 的 locate 方法</span>\n         source <span class="token operator">=</span> locator<span class="token punctuation">.</span><span class="token function">locate</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token comment">// ...</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// ...</span>\n   <span class="token punctuation">}</span>\n   <span class="token comment">// 省略了其他变量和方法</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>显然，PropertySourceBootstrapConfiguration 实现了 ApplicationContextInitializer 接口的 initialize 方法。请注意，在 Spring Boot 中，所有 ApplicationContextInitializer 接口的实现类都会在应用程序启动时自动加载。所以上述代码会随着应用启动而运行，通过遍历 propertySourceLocators 的 locate 方法来读取远程服务配置信息。</p>\n<p>在 PropertySourceBootstrapConfiguration 类中，注意到 propertySourceLocators 数组是通过 setPropertySourceLocators 方法直接进行注入的，显然我们需要找到注入 ConfigServicePropertySourceLocator 的入口。正如前文中我们通过 PropertySourceLocator 找到 PropertySourceBootstrapConfiguration 一样，在 ConfigServicePropertySourceLocator 类的同一个包结构中，我们也找到了 ConfigServiceBootstrapConfiguration 配置类，并在该类中发现了如下所示的 configServicePropertySource 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69085867877089526000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Bean\n@ConditionalOnMissingBean(ConfigServicePropertySourceLocator.class)\n@ConditionalOnProperty(value = &quot;spring.cloud.config.enabled&quot;, matchIfMissing = true)\npublic ConfigServicePropertySourceLocator configServicePropertySource(ConfigClientProperties properties) {\n   ConfigServicePropertySourceLocator locator = new ConfigServicePropertySourceLocator(properties);\n   return locator;\n}`, `69085867877089526000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Bean</span>\n<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token class-name">ConfigServicePropertySourceLocator</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>\n<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"spring.cloud.config.enabled"</span><span class="token punctuation">,</span> matchIfMissing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token class-name">ConfigServicePropertySourceLocator</span> <span class="token function">configServicePropertySource</span><span class="token punctuation">(</span><span class="token class-name">ConfigClientProperties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token class-name">ConfigServicePropertySourceLocator</span> locator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigServicePropertySourceLocator</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> locator<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>不难看出，上述方法创建了一个新的 ConfigServicePropertySourceLocator 实例。也就是说当类路径中包含 ConfigServiceBootstrapConfiguration 类时，就会自动实例化一个 ConfigServicePropertySourceLocator。这里就充分应用了 Spring Boot 的自动配置机制，可以通过查看 <code class="language-text">META-INF/spring.factories</code> 中的配置类进行确认，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29374775182761790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# Bootstrap components\norg.springframework.cloud.bootstrap.BootstrapConfiguration=\\\norg.springframework.cloud.config.client.ConfigServiceBootstrapConfiguration,\\\norg.springframework.cloud.config.client.DiscoveryClientConfigServiceBootstrapConfiguration`, `29374775182761790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text"># Bootstrap components\norg.springframework.cloud.bootstrap.BootstrapConfiguration=\\\norg.springframework.cloud.config.client.ConfigServiceBootstrapConfiguration,\\\norg.springframework.cloud.config.client.DiscoveryClientConfigServiceBootstrapConfiguration</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，这里的 BootstrapConfiguration 配置项中包含了 <code class="language-text">org.springframework.cloud.config.client.ConfigServiceBootstrapConfiguration</code> 类的定义。</p>\n<p>至此，围绕 Spring Cloud Config Client 如何在启动时自动获取 Server 所提供的配置信息的整体流程已经介绍完毕，我们可以通过下图所示的全局蓝图进行梳理和总结：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-18-15-04-05-362804dc3a192baf9f7b9296825c6535-a3ca3.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 642px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 56.85358255451713%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAACLUlEQVQoz12Re3eaQBDF/f5fpKdt/khK4yPHNjkxMSrGFyAKwgq+EBsTH8dGIt7e3dM0xy7nwrAzO/Ob2cyV6+LHdIqbKILW6+FTpYLPuo6zZhNf6nWlr9RVEOCacUUZ6/tI0xRyHY/HE2XilxdEqxWmyyWCaI7hbMZvhFEcoz8cKkl7+vyMGWNnLyvMae/3exwOh5NkcmXkSzpuebDMg5emicuOgVy3i2+kPKvVkOWeRjtnWbh4fESRXZUYWw1D4D/SjHzJhJJwwsreZAJ3NII3nUCQdDiPYLOY6Xm058ofMNmYsZEkTRIkb2+nCd9xZbUGZ1Rm8ptwhPNGE1mrC80wcKbXoZG80O+zC4t2BwVJuljgdjzGZrv9aFkhq3wpFpznhAlDUggmlzMVVEi6nhCweSEBbbkX/J2t7C4hqexUEb4R+f3W3te1JCFZgbOUylPyX2u3UbBtZGnnDBNZkuY5W41zvmPBzJzVHMfBhLPZ7XbYEn292aDrC7T6LtrOAMbAh+H56IoADbuHluPCot/0hPJ3XE/JDcfIbHhYJl2v1wo5PaZ43b/iIaygttBRi+soBXfIGwWlc/0CWuM7su0cCuaV8lfnOlVDRVQ/ZvhvsfPk9x5e5MP/JSCWAQaxD2c2QNvroCNMZVuBDXvUg7cQ8Bg3XIUInsKPW5ZPekhhzCzoiwaMpYXHaRP37gPunLL6Fo2fKDn3KA8qaMUGzOcu2k8mOrGJ5DVRPH8A96Uh3H3qooMAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 18 15 04 05" title="" data-src="/static/2024-11-18-15-04-05-362804dc3a192baf9f7b9296825c6535-a3ca3.png" data-srcset="/static/2024-11-18-15-04-05-362804dc3a192baf9f7b9296825c6535-f8a33.png 200w,\n/static/2024-11-18-15-04-05-362804dc3a192baf9f7b9296825c6535-8ae0d.png 400w,\n/static/2024-11-18-15-04-05-362804dc3a192baf9f7b9296825c6535-a3ca3.png 642w" data-sizes="(max-width: 642px) 100vw, 642px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="解题要点-15"><a href="#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-15" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解题要点</h2>\n<p>关于配置中心相关的面试题，首要的一个解题要点就是要明确配置中心应该具备哪些核心的功能，或者说配置中心在设计上应该有哪些需求。表面上，这是一道开放式的面试题，让面试者自己来给出配置中心的需求。但事实上，这道题的考查点还是相对固化的，需要面试者把平时在使用过程中关于配置中心的几点核心述求说明清楚。面试者可以基于自己的理解做一些发挥，但发挥的点应该也是围绕这些核心述求进行展开。</p>\n<p>对于一个配置中心而言，考虑到它的定位和作用，我们势必需要保证各种配置信息在各个环境中是相互隔离的，而这种隔离性则会导致数据的不一致，所以配置信息的一致性也是基本需求。对于面向生产环境的配置信息而言，我们还需要考虑安全性。这样，我们就梳理出了隔离性、一致性和安全性这几个核心诉求。当然，对于分布式环境下的配置信息管理，易管理性也是一项可以提到的诉求。</p>\n<p>对配置中心常见实现工具的介绍是面试过程中的另一个要点。面试官不会要求候选人对所有的配置中心工具都了如指掌，但我们需要熟练掌握至少一款开源框架。如果你比较擅长 Spring，那么本讲所介绍的 Spring Cloud Config 就是一个不错的选择。无论你选择哪一款工具来进入深入学习，都需要围绕整个配置信息流转的工作流程来系统把握配置中心的客户端和服务端组件之间的交互过程，明确配置信息的存储媒介和方式，以及前面提到的各种需求的实现方式。</p>\n<p>本质上，不同配置中心工具的设计思想是基本一致的。只要掌握了一款工具的底层实现原理，针对其他工具的使用方式以及实现机制的学习过程也会变得比较容易。这也可以说是技术类内容在学习上的一条客观规律。</p>\n<h2 id="小结与预告-13"><a href="#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-13" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结与预告</h2>\n<p>配置中心是分布式架构中的一个基础组件，而业界关于如何实现配置中心也有一些基本的模型和工具。在本讲内容中，我们针对配置中心实现需求梳理了配置中心所必须要考虑的组成结构和功能特性，并重点对 Spring 家族中的 Spring Cloud Config 展开了详细分析。</p>\n<p>在今天的内容中，我们也留下了一个伏笔：如果位于服务器端的配置信息发生了变更，如何确保这种变更能够实时的通知到客户端服务？这是一个比较复杂的话题，也是一个热门的面试题，让我们在下一讲中对它进行系统分析和讨论。</p>\n<h1 id="配置中心：配置信息有变更时，如何实现热更新？"><a href="#%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%EF%BC%9A%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E6%9C%89%E5%8F%98%E6%9B%B4%E6%97%B6%EF%BC%8C%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%83%AD%E6%9B%B4%E6%96%B0%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配置中心：配置信息有变更时，如何实现热更新？</h1>\n<p>在上一讲中，我们详细介绍了配置中心的设计思想和组成结构，并基于 Spring 家族的 Spring Cloud Config 框架阐述了配置中心与各个服务之间的交互过程，理解了配置中心存储配置信息的方式，以及各个服务从配置中心中读取这些配置信息的工作原理。</p>\n<p>事实上，围绕配置中心，配置信息的传递有两个方向，一个是服务从配置中心进行拉取，另一个则是配置中心主动推送给各个服务，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-19-16-04-45-fd172740d73c6648d2008df70e798abb-3b971.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 379px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 73.35092348284961%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAACsUlEQVQ4y3VT/VPaQBDN/98Z+2s7TlX8CIX6QykIIoEkBIzFpqK2iIwfM4CgfIMkkBDyuncSHGV6mZ3s3u2+u3d7T/A8D2xMpzYOYkEk4us4TGwgdbQFObMDKRVAOr3N/5IUQCq1heThBo6Sm4hFP1EcAYPw2EeO4APWag2c6CHy7sjKcOxT3N3E0GxI9D/AcJBDv6vCMnVaLy2sgqwaRrc74BhvAOv1JnLaHnlXZJcEoCEjfUbl+geO8wE0HpJoPqRwU4li5pxSzgXPy2SC6PWGr4Dz+ZwHtu3QYoyo7SEtBaHIYfJFRL6vc19VvmF3Z43sI1+X0yGivo18Tnqh7M3BsAS8G6ORhfF4AsuyYRhFNJstmOYUk4kDXS8gGo1TjknUbTw/W+/LITQaDXQ6HTw+PtIpp8uF+/s7otJbKej3e7i9vXkzV61WaeMm9aEGQZIkaJqGeDzOgf2Eer3OfUaD3Y1vbLRaLQK9XQLquo5cLkcdT0EYDAa0ax9PT09wXZf7pVKJJ7LYB/Evnc29MLjnJ2KDMWm322BYgmEYOD8/p7eWpjt5ZlUol8t0T6MliA/qN9A0TZ7jOA6PVVWFoigoFAoQGE1/B9u2l4WsgBW+Dl8AE87AdWfLDcfjMTd+wveXPp3OwA7COhiJxHB1VeHPwrZdDIdjFIuXvOuMOZtb6fILHQ+zmQtZTpD0tklWQXpje9jc+ICdwBpJMExvcZ/e5BfED0iKUohyRJLqFjVEXZx0vqqUbJYp5S9xNjB3f6HbUTCxTjDoq6hVExTLaLcy8GgdOCMr0t0HqZGjVenVag/4eRJeaJnk553BOBVRryYJUCNlrOPPxT6Mgkib/eZ651rO/kfLljVBIhEiKYnI57+SrkV6n8yCPFbkXZLfLrSsyNeOaU5VGP0IFs3ngP8AJ7ZGYDmUCmEAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 19 16 04 45" title="" data-src="/static/2024-11-19-16-04-45-fd172740d73c6648d2008df70e798abb-3b971.png" data-srcset="/static/2024-11-19-16-04-45-fd172740d73c6648d2008df70e798abb-2c2c2.png 200w,\n/static/2024-11-19-16-04-45-fd172740d73c6648d2008df70e798abb-3b971.png 379w" data-sizes="(max-width: 379px) 100vw, 379px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>上图中，数据推送主要发生在配置信息发生变更的场景，这也是面试过程中的一个高频问题，即位于配置中心的配置信息一旦有变更，应该如何确保各个服务实现热更新。本讲内容将围绕这一问题展开讨论。</p>\n<h2 id="问题背景-13"><a href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-13" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题背景</h2>\n<p>在日常开发过程中，配置信息的热更新是一个实战性很强的问题。对于任何一个分布式服务系统而言，避免不了需要对配置信息做一些调整，例如根据业务需要添加一些新的配置项等。如果配置信息一有更新，就需要重启服务器，这显然是不可取的。所以，如何确保在服务不重启的前提下实现配置信息的热更新是开发人员都需要掌握的基本技能，自然也是面试官重点会考查的一个话题。</p>\n<p>针对这一话题，常见的面试问题包括：</p>\n<ul>\n<li>Spring Cloud Config 是如何实现配置信息热更新的？</li>\n<li>如果让你设计一款通用的配置信息动态更新机制，你有什么思路？</li>\n<li>什么是 WebHook 机制？你能描述它的常见应用场景吗？</li>\n<li>基于推模式和拉模式，你应该如何分别设计配置信息的更新机制？</li>\n<li>客户端想要知道服务器端的数据是否发生变化，有哪些实现方法？</li>\n<li>配置中心如何从注册中心中获取最新的服务实例信息？</li>\n</ul>\n<p>虽然提问方式有所不同，但上述这些面试题本质上都是围绕 <code class="language-text">数据热更新</code> 这一技术主题所延伸出来的话题。然而，我在面试过程中发现，开发人员普遍对配置信息的热更新机制缺乏必要的了解，甚至不够重视。导致这一现象的部分原因是配置中心的构建和维护工作往往是由运维人员在负责，普通开发人员没有机会去深入理解配置中心的工作原理。另一方面，因为目前市面上主流的配置中心实现工具（例如 Spring Cloud Config、Nacos 等）都内置了完善的热更新机制，该机制对开发人员是透明的，也会导致我们对这部分功能缺乏对应的认知。</p>\n<p>如果你是一名中级开发人员，想要往高级开发甚至架构师方向发展，那么我认为不能只停留在使用工具的层次，而是应该深入框架的原理，做到触类旁通。而这一问题考查的正是开发人员对框架底层原理的掌握程度。回答好这一问题有助于拉开你和其他候选人之间的差距。</p>\n<h2 id="问题分析-14"><a href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-14" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题分析</h2>\n<p>通过上一讲内容的介绍，我们已经知道各个服务会在启动时从配置中心获取配置，然后缓存到本地。而一旦服务启动成功，无论配置中心中的配置信息如何变更，作为配置中心客户端的各个服务都不会再次主动获取配置信息，而是会利用位于本地的缓存配置。那么问题就来了，这些服务如何能够实时获取更改后的配置呢？</p>\n<p>在前面的讨论中，我们提到了一个词叫触类旁通。实际上，作为分布式服务系统的重要组成部分，配置中心的结构和原理与注册中心比较类似。像分布式协调框架 ZooKeeper 即可以构建注册中心，也可以用来实现配置中心。因此，我们在分析配置中心的热更新机制时，可以把它和注册中心做一些类比。</p>\n<p>在介绍注册中心的服务实例更新机制时，我们提到了有两种方案可以做到注册中心与各个服务之间的信息同步，分别是基于拉模式的定时更新策略，以及基于推模式的监听器机制。类似地，我们可以把这两种思路也应用到配置中心中，来具体分析它们的可行性。</p>\n<p>现在，针对这一问题我们已经具备基本的思路了。当然，不同的工具有不同的实现方式。针对配置中心，我们将继续基于 Spring Cloud Config 来讨论热更新机制。Spring Cloud Config 作为 Spring 家族的一员，很多功能特性与 Spring 框架息息相关，值得我们对它的技术体系做深入理解。</p>\n<h2 id="技术体系-16"><a href="#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-16" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术体系</h2>\n<p>基于以上分析，针对配置中心热更新问题，从技术体系上讲，我们有如下三种处理方法。</p>\n<ol>\n<li>\n<p>重启服务。 因为各个服务在启动时会重新获取服务器端配置，所以重启服务能实现配置信息的及时更新，但正如前面所提到的，这显然不是一种合理的方法。</p>\n</li>\n<li>\n<p>使用 Spring Boot Actuato 组件。 这是 Spring Boot 提供的一个专门用来监测和管理系统运行时状态的组件。Actuator 是一种集成化组件，可以获取应用系统的运行时数据和配置信息并进行统计分析。</p>\n<p>当在代码类路径中引入 spring-boot-starter-actuator 依赖并启动 Spring Boot 应用程序时，我们会在启动日志里发现自动添加了 info、health、refresh 等众多 HTTP 端点。通过调用 <code class="language-text">/actuator/refresh</code> 端点就可以刷新服务的配置信息，从而实现不重启 Spring Boot 应用的配置热更新。</p>\n<p>这种方案采用的就是典型的拉模式。这是一种简单有效的处理方式，但并不是最好的处理方式。因为针对每个微服务一般都会存在多个运行时实例，这样就需要把客户端的 <code class="language-text">/actuator/refresh</code> 端点逐个进行调用，这点显然也不是很合理。而且，这种方案属于客户端自身行为，跟配置服务器端没有关系。</p>\n</li>\n<li>\n<p>集成 Spring Cloud Bus 组件。 当我们在 Spring Cloud Config 服务器端代码工程的类路径中添加 Spring Cloud Bus 的引用并启动应用程序之后，Spring Boot Actuator 就为我们提供了 <code class="language-text">/actuator/bus-refresh</code> 端点，通过访问该端点就可以达到对客户端所有服务实例的配置信息进行自动更新的效果。在这种方案中，服务端会主动通知所有客户端进行配置信息的更新，这样我们就无需关注各个客户端，而只对服务端进行操作即可。显然，这里用到的是基于推模式的动态监听机制。</p>\n</li>\n</ol>\n<p>通过对上述实现方案的分析，我们可以明确第三种方案是我们需要回答的重点。在这种方案中，整个实现过程我们至少要搞清楚三大问题，即：</p>\n<ul>\n<li>如何自动调用服务器端所暴露的 <code class="language-text">/actuator/bus-refresh</code> 端点？</li>\n<li>客户端如何得知服务器端的配置信息已经更新？</li>\n<li>客户端如何实时获取服务器端所更新的配置信息？</li>\n</ul>\n<h2 id="源码解析-14"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-14" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h2>\n<p>针对以上这三个问题，接下来我们将结合 Spring Cloud Config 源码逐一展开讨论。</p>\n<h3 id="如何自动调用服务器端所暴露的-actuatorbus-refresh-端点？"><a href="#%E5%A6%82%E4%BD%95%E8%87%AA%E5%8A%A8%E8%B0%83%E7%94%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E6%89%80%E6%9A%B4%E9%9C%B2%E7%9A%84-actuatorbus-refresh-%E7%AB%AF%E7%82%B9%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何自动调用服务器端所暴露的 <code class="language-text">/actuator/bus-refresh</code> 端点？</h3>\n<p>在现代软件开发过程中，开放式平台是一种常见的软件服务形态。我们可以把 Spring Cloud Config Server 所提供的 HTTP 端点视为一种开放式的接口，以供 Git 等第三方工具进行访问和集成。这样，我们把服务器端 <code class="language-text">/actuator/bus-refresh</code> 端点对外进行暴露，然后第三方工具通过这个暴露的端点进行集成。</p>\n<p>例如，在 GitHub 中就设计了一种 Webhook 机制，并提供了用户界面供我们配置所需要集成的端点以及对应的操作，操作方法如下图所示（该图来自 GitHub 官方网站）：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-19-16-05-43-cc4c6bcbc4fdf8cb40d42a5d9e23d476-28558.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 514px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 91.24513618677042%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsSAAALEgHS3X78AAACAElEQVQ4y5VUTW/UMBDdn84P4MAf4ISE6IErBw5w51AhtRInLrBqtxsncZzYjuMkj3nOx+6W0oZITxM7M+OZN8/ZVXWNB1UgLzX29wf82t/JewUfIlzbwc9wZ3i8PiFg11iLvChRVRW01sjzPNlGDjLGQMt+KWvDtaCa92jruhGfOoHr0HXY1eJ0ODzgoErcZQXuaY859sciVW7MFJxQmZRcVzodShRlmfZY2DiO2Hnv08K4gNIGVD7CCPKmg5W2gTE5bsEwDNJy0+CYqXTa0Me02fe9OAzJqed6WOwg36fgy2daTxW2LQotPLEd4UILL5q8NBaxH9BJ8i6eENNhpwQL1oTWOakwg1IKIQTEGBM6IZhgxamCJfAs+DzpmrCXNpXKoebpliRZkMsBnDyTP36e4m9N2EhrxMLEuDIy2WHlbsZf/F0etOukgsAWF576MztzGIfJtkIBfZ+dMnkjj07k48RakZCdLTXKdwqa3zfJhnxlwtciUAqYwUxESTnnUYulXl96Zg7l+tQmBXMITPRcwL+wJmSbvItsj1USTErJjE9o7cUK2Yr1wmErHIr1M5e86FuruxyK9QhG2pzllkQdJ1FzYEQroPOmhLfZT7y7+YQPt5/x8ccXKFOmKjnlpVrqdLoxG1r++vsar769xevr93jz/Qp15/5rIMvPZMEfkW59F2URsekAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 19 16 05 43" title="" data-src="/static/2024-11-19-16-05-43-cc4c6bcbc4fdf8cb40d42a5d9e23d476-28558.png" data-srcset="/static/2024-11-19-16-05-43-cc4c6bcbc4fdf8cb40d42a5d9e23d476-843f4.png 200w,\n/static/2024-11-19-16-05-43-cc4c6bcbc4fdf8cb40d42a5d9e23d476-8216e.png 400w,\n/static/2024-11-19-16-05-43-cc4c6bcbc4fdf8cb40d42a5d9e23d476-28558.png 514w" data-sizes="(max-width: 514px) 100vw, 514px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>我们可以在上图的 Payload URL 中设置 <code class="language-text">/actuator/bus-refresh</code> 端点地址。所谓的 Webhook，实际上就是一种回调。通过 Webhook，当我们提交代码时，GitHub 就会自动调用所配置的 HTTP 端点。也就是说，可以根据配置项信息的更新情况自动实现对 <code class="language-text">/actuator/bus-refresh</code> 端点的访问。基于 GitHub 的配置仓库实现方案，我们可以得到如下图所示的系统结构：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-19-16-06-08-5c1a0e74728195a13c8a09cc85fd01f3-a40ca.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 647px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 35.394126738794434%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABSElEQVQoz4VQa0+DQBDk//8YP5EKbdqa2qZaa6PhEYpAnzysQAEhtBAYl4uQGE2cZHJ3u3uzs8vxsgxht0PPMMBvNni2LFRFge12i9VqhfV6DZlqNE2DrutQFAWSJCGOYzSo65qxBcfTRzEMcWOaEJMED/SOfB8BxUJiEATs9CnW0HVdXC6XTuiXoEkFGlE9HvFC7l5VtUtWVYWC3JZl2X3K8xzh+dzlq/onufJ6RUIFnm0jJYdZmsInV57nQSXxZjxDf0MSJ12jKIxoVvwJznEcthuNdqWQQDtOO27gBzAPFgzbhOVusDvtsZCesJSX2H8cYDkWi5uUNw4GOPyDKIowdu5xl87QswcQTyOI70MIxJ4zgOAN6T3CJJtjdl2Aa9ywXXyzXXJzb5ClGcY2CX7OwO9FCO6QsX8aU4M+a3JLwpN0jmn+iC8t5wlT0B+XHAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 19 16 06 08" title="" data-src="/static/2024-11-19-16-06-08-5c1a0e74728195a13c8a09cc85fd01f3-a40ca.png" data-srcset="/static/2024-11-19-16-06-08-5c1a0e74728195a13c8a09cc85fd01f3-3426a.png 200w,\n/static/2024-11-19-16-06-08-5c1a0e74728195a13c8a09cc85fd01f3-f3a4f.png 400w,\n/static/2024-11-19-16-06-08-5c1a0e74728195a13c8a09cc85fd01f3-a40ca.png 647w" data-sizes="(max-width: 647px) 100vw, 647px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="客户端如何得知服务器端的配置信息已经更新？"><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%A6%82%E4%BD%95%E5%BE%97%E7%9F%A5%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E7%9A%84%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E5%B7%B2%E7%BB%8F%E6%9B%B4%E6%96%B0%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>客户端如何得知服务器端的配置信息已经更新？</h3>\n<p>接下来我们关注第二个问题，即客户端如何得知服务器端的配置信息已经更新？</p>\n<p>我们首先需要明确，在调用了 <code class="language-text">/actuator/bus-refresh</code> 端点之后，系统内部发生了什么事情。这里我们需要快速浏览 Spring Cloud Bus 中的代码工程，发现在 <code class="language-text">org.springframework.cloud.bus.endpoint</code> 包下存在一个 RefreshBusEndpoint 端点类，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19265123290481890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Endpoint(id = &quot;bus-refresh&quot;)\npublic class RefreshBusEndpoint extends AbstractBusEndpoint {\n   public RefreshBusEndpoint(ApplicationEventPublisher context, String id) {\n      super(context, id);\n   }\n\n   @WriteOperation\n   public void busRefreshWithDestination(@Selector String destination) {\n      publish(new RefreshRemoteApplicationEvent(this, getInstanceId(), destination));\n   }\n\n   @WriteOperation\n   public void busRefresh() {\n      publish(new RefreshRemoteApplicationEvent(this, getInstanceId(), null));\n   }\n}`, `19265123290481890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Endpoint</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token string">"bus-refresh"</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RefreshBusEndpoint</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBusEndpoint</span> <span class="token punctuation">{</span>\n   <span class="token keyword">public</span> <span class="token class-name">RefreshBusEndpoint</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEventPublisher</span> context<span class="token punctuation">,</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token annotation punctuation">@WriteOperation</span>\n   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">busRefreshWithDestination</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Selector</span> <span class="token class-name">String</span> destination<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">publish</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RefreshRemoteApplicationEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> destination<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token annotation punctuation">@WriteOperation</span>\n   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">busRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">publish</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RefreshRemoteApplicationEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>显然，RefreshBusEndpoint 类对应于我们前面访问的 <code class="language-text">/bus-refresh</code> 端点。可以看到，Spring Cloud Bus 在这里做的事情仅仅只是发布了一个新的 RefreshRemoteApplicationEvent 事件。</p>\n<p>既然发送了事件，我们就需要寻找该事件的监听者。我们在 Spring Cloud Bus 的 <code class="language-text">org.springframework.cloud.bus.event</code> 包下找到了 RefreshRemoteApplicationEvent 事件的监听器 RefreshListener，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1644747187008266500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class RefreshListener implements ApplicationListener<RefreshRemoteApplicationEvent> {\n   private static Log log = LogFactory.getLog(RefreshListener.class);\n\n   private ContextRefresher contextRefresher;\n\n   public RefreshListener(ContextRefresher contextRefresher) {\n      this.contextRefresher = contextRefresher;\n   }\n\n   @Override\n   public void onApplicationEvent(RefreshRemoteApplicationEvent event) {\n      Set<String> keys = contextRefresher.refresh();\n      log.info(&quot;Received remote refresh request. Keys refreshed &quot; + keys);\n   }\n}`, `1644747187008266500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RefreshListener</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RefreshRemoteApplicationEvent</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>\n   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Log</span> log <span class="token operator">=</span> <span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token class-name">RefreshListener</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">private</span> <span class="token class-name">ContextRefresher</span> contextRefresher<span class="token punctuation">;</span>\n\n   <span class="token keyword">public</span> <span class="token class-name">RefreshListener</span><span class="token punctuation">(</span><span class="token class-name">ContextRefresher</span> contextRefresher<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>contextRefresher <span class="token operator">=</span> contextRefresher<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token annotation punctuation">@Override</span>\n   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApplicationEvent</span><span class="token punctuation">(</span><span class="token class-name">RefreshRemoteApplicationEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> keys <span class="token operator">=</span> contextRefresher<span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Received remote refresh request. Keys refreshed "</span> <span class="token operator">+</span> keys<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从类的定义中，我们可以看到该监听器就是用来处理 RefreshRemoteApplicationEvent 事件，其在 onApplicationEvent 方法中同样也是调用了 ContextRefresher 中的 refresh 方法进行配置属性的刷新。</p>\n<p>请注意，RefreshRemoteApplicationEvent 是一个远程事件，将通过消息中间件进行发送，并被 Spring Cloud Config 客户端所监听，处理流程如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-19-16-06-40-e772897121850a89c3478b4b652bbb1f-58f3c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 627px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 61.56299840510366%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAAB10lEQVQoz41T/XOaQBDl//8/Ov3JdJo0fmHoNEk7rYmpWtIJoHyIcGgiJiMcAsLrHlY77eg0O/PY2zt4897uIXGeQP3RwMPPd+h+ewt1eIKRcQrD6EFEWRaE8tWQ0jSF4/RgmdfoyG+gqh1MnM+YTvXfhCUOxbF9STwWi+cKrutjvc6RJNn+haIosVol4DytINZpmu9Jy13eKRQHz+ECy6cn5Ov1nmi5XBJ5BsZGcCeX0DUFuq7AsS+pJdfI881BpZLl+7Dnc2iui+F4jDHVMefwPI9s++h2FfhTBbc3NfRuazD0JjTtAlmaHSY8ub9HO1yi9fgIOQzx3plAs21s8hxxHJP9BFEkLK+REKKIV8qP9VGqqSrOSNU5oR4EqJFK3XHwv/hD9q9lsjZiDNZsBousG94UpmUhjiKIG7D7sCiKv1EeRjWUIstoMCFWLy/gRBQRfFIcLkLwmJP9DV4bFSEXQyACgRmpDMj6nBSzeYAHR8PAGOK7NsCYmTADa5uZVa1FFrXhjWAzB9KxCyrizuxDia7QniuoM5n63K5yI+hsa29bt+j8E/+ChiVvFR76hUAu+/YAX8seWv4FTs06GlMZZ3YTLabg3G1Xex+cZrV/gz4+siv8AvCriUjvG8GrAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 19 16 06 40" title="" data-src="/static/2024-11-19-16-06-40-e772897121850a89c3478b4b652bbb1f-58f3c.png" data-srcset="/static/2024-11-19-16-06-40-e772897121850a89c3478b4b652bbb1f-a8bea.png 200w,\n/static/2024-11-19-16-06-40-e772897121850a89c3478b4b652bbb1f-f4947.png 400w,\n/static/2024-11-19-16-06-40-e772897121850a89c3478b4b652bbb1f-58f3c.png 627w" data-sizes="(max-width: 627px) 100vw, 627px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="客户端如何实时获取服务器端所更新的配置信息？"><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E6%97%B6%E8%8E%B7%E5%8F%96%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E6%89%80%E6%9B%B4%E6%96%B0%E7%9A%84%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>客户端如何实时获取服务器端所更新的配置信息？</h3>\n<p>最后需要明确的第三个问题是，客户端如何获取服务器端所更新的配置信息？这就需要梳理 Spring Cloud Config Server 与注册中心之间的关系。</p>\n<p>我们在上一讲分析配置中心的基本模型时提到，配置中心作为整个微服务架构运行所需的基础服务，需要确保其可用性。因为配置服务本身也是一个独立的微服务，所以 Spring Cloud Config 实现高可用的方式很简单。跟其他微服务一样，也可以把自己注册到注册中心上，让其他服务提供者或消费者通过注册中心进行服务发现和获取。</p>\n<p>显然，在这种方式下，基于注册中心的服务治理机制同时提供了服务器端的负载均衡和客户端的配置功能，从而也就间接实现了高可用性。从另一个角度，我们也可以理解为可以通过注册中心获取所有 Spring Cloud Config 服务的实例，从而在分布式环境下为获取配置信息提供了一种简便的手段。</p>\n<p>Spring Cloud Config 提供了一个工具类 ConfigServerInstanceProvider 来完成与注册中心之间的交互，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24332337872811127000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class ConfigServerInstanceProvider {\n   private static Log logger = LogFactory.getLog(ConfigServerInstanceProvider.class);\n   private final DiscoveryClient client;\n\n   public ConfigServerInstanceProvider(DiscoveryClient client) {\n      this.client = client;\n   }\n\n   @Retryable(interceptor = &quot;configServerRetryInterceptor&quot;)\n   public List<ServiceInstance> getConfigServerInstances(String serviceId) {\n      logger.debug(&quot;Locating configserver (&quot; + serviceId + &quot;) via discovery&quot;);\n\n      // 根据 serviceId 获取服务实例列表\n      List<ServiceInstance> instances = this.client.getInstances(serviceId);\n      if (instances.isEmpty()) {\n         // 如果服务实例列表为空则抛出异常\n      }\n\n      return instances;\n   }\n}`, `24332337872811127000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigServerInstanceProvider</span> <span class="token punctuation">{</span>\n   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Log</span> logger <span class="token operator">=</span> <span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token class-name">ConfigServerInstanceProvider</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DiscoveryClient</span> client<span class="token punctuation">;</span>\n\n   <span class="token keyword">public</span> <span class="token class-name">ConfigServerInstanceProvider</span><span class="token punctuation">(</span><span class="token class-name">DiscoveryClient</span> client<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>client <span class="token operator">=</span> client<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token annotation punctuation">@Retryable</span><span class="token punctuation">(</span>interceptor <span class="token operator">=</span> <span class="token string">"configServerRetryInterceptor"</span><span class="token punctuation">)</span>\n   <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">></span></span> <span class="token function">getConfigServerInstances</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Locating configserver ("</span> <span class="token operator">+</span> serviceId <span class="token operator">+</span> <span class="token string">") via discovery"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 根据 serviceId 获取服务实例列表</span>\n      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">></span></span> instances <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>instances<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token comment">// 如果服务实例列表为空则抛出异常</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">return</span> instances<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在这里，我们看到了熟悉的 DiscoveryClient，DiscoveryClient 通过同样熟悉的 getInstances 方法从注册中心中获取 Spring Cloud Config 服务实例，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35127995699044570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`List<ServiceInstance> instances = this.client.getInstances(serviceId);`, `35127995699044570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">></span></span> instances <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>ConfigServerInstanceProvider 的调用者是 DiscoveryClientConfigServiceBootstrapConfiguration。如果系统中生成了 ContextRefreshedEvent 事件就会触发如下所示的 refresh 方法（部分代码做了裁剪）：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57348208962227030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`private void refresh() {\n   try {\n      String serviceId = this.config.getDiscovery().getServiceId();\n      List<String> listOfUrls = new ArrayList<>();\n      // 根据 serviceId 获取配置服务实例列表\n      List<ServiceInstance> serviceInstances = this.instanceProvider.getConfigServerInstances(serviceId);\n\n      for (int i = 0; i < serviceInstances.size(); i++) {\n         ServiceInstance server = serviceInstances.get(i);\n         String url = getHomePage(server);\n         // 处理安全机制\n         if (server.getMetadata().containsKey(&quot;password&quot;)) {\n            String user = server.getMetadata().get(&quot;user&quot;);\n            user = user == null ? &quot;user&quot; : user;\n            this.config.setUsername(user);\n            String password = server.getMetadata().get(&quot;password&quot;);\n            this.config.setPassword(password);\n         }\n\n         // 构建配置文件的访问地址列表\n         if (server.getMetadata().containsKey(&quot;configPath&quot;)) {\n            String path = server.getMetadata().get(&quot;configPath&quot;);\n            if (url.endsWith(&quot;/&quot;) && path.startsWith(&quot;/&quot;)) {\n               url = url.substring(0, url.length() - 1);\n            }\n            url = url + path;\n         }\n\n         listOfUrls.add(url);\n      }\n\n      // 设置配置文件地址列表\n      String[] uri = new String[listOfUrls.size()];\n      uri = listOfUrls.toArray(uri);\n      this.config.setUri(uri);\n   }\n}`, `57348208962227030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      <span class="token class-name">String</span> serviceId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function">getDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getServiceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> listOfUrls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 根据 serviceId 获取配置服务实例列表</span>\n      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">></span></span> serviceInstances <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>instanceProvider<span class="token punctuation">.</span><span class="token function">getConfigServerInstances</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> serviceInstances<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token class-name">ServiceInstance</span> server <span class="token operator">=</span> serviceInstances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token function">getHomePage</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token comment">// 处理安全机制</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token class-name">String</span> user <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            user <span class="token operator">=</span> user <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">"user"</span> <span class="token operator">:</span> user<span class="token punctuation">;</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token class-name">String</span> password <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n\n         <span class="token comment">// 构建配置文件的访问地址列表</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"configPath"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token class-name">String</span> path <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"configPath"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               url <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n            url <span class="token operator">=</span> url <span class="token operator">+</span> path<span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n\n         listOfUrls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// 设置配置文件地址列表</span>\n      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> uri <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>listOfUrls<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      uri <span class="token operator">=</span> listOfUrls<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function">setUri</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在上述 refresh 方法中可以看到，Spring Cloud Config 首先会获取配置文件中的 spring.cloud.config.discovery.serviceId 配置项所指定的服务实例 id，然后根据 serviceId 从 ConfigServerInstanceProvider 中获取注册服务的实例对象集合 serviceInstances，最后循环遍历 serviceInstances 来更新存储在内存中的配置属性值。通过上述流程，我们确保位于客户端中的配置信息得到了实时的更新。</p>\n<h2 id="解题要点-16"><a href="#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-16" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解题要点</h2>\n<p>关于配置中心的热更新机制是一道比较典型的技术原理类面试题。同样，这道题之所以典型也是因为很多开发人员只停留在对具体工具的使用上，而并不清楚其背后的设计思想和原理。我在面试过程中，能够碰到让我满意的回答并不多。</p>\n<p>从解题思路上讲，如果你对配置中心本身并没有太多概念，那么这道题有一定的难度。没有一些基础知识，光靠凭空想象是很难梳理热更新背后的实现原理的。所以在日常开发过程中，对于那些构成分布式服务系统的基础技术组件，就算不需要自己动手进行开发或维护，还是需要专门做一些了解。这也是你和普通开发人员的一个重要区别。</p>\n<p>另一方面，配置中心的热更新是一个相对复杂的过程，考查的知识点也比较多。例如，以本讲介绍的 Spring Cloud Config 为例，就涉及到 Spring 内置的事件通知和上下文刷新机制、Spring Boot Actuator、Spring Cloud Bus 等工具框架。同时，Spring Cloud Config 还会基于注册中心获取各个配置服务实例并动态更新其位于内存中的配置信息。我们在回答过程中，对这些组件都应该有所提及，从而向面试官展示自己的知识广度。</p>\n<p>在本讲的问题分析部分，我们实际上也提到了可以类比注册中心来学习配置中心。对于配置中心而言，具体的实现工具和框架是比较丰富的，常见的就包括 Etcd、Consul、Disconf、Diamond、Nacos 以及 Spring 家族的 Spring Cloud Config。而这些工具在实现过程中可能各有差别，但在设计思想上基本都是一致的。技术体系之间的相通性也是我们回答技术原理类面试题的一个有效抓手。如果你掌握了某一种配置中心实现工具的基本原理，那么即使没有使用过其他工具，面对类似本讲中提出的问题也能够做到触类旁通。至于如何基于技术体系相通性来应对技术原理类面试，本课程后面还会有专题进行讨论。</p>\n<h2 id="小结与预告-14"><a href="#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-14" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结与预告</h2>\n<p>作为一个典型的技术原理类问题，本讲内容基于 Spring Cloud Config 框架剖析了实现配置信息热更新的工作原理。我们抛出了三个与这个主题相关的核心问题，然后基于源码对这些问题都做了一一解答。</p>\n<p>事实上，Spring Cloud Config 作为 Spring 自研的配置中心框架，其内部大量使用了 Spring 框架现有的功能特性，这点与我们学习其他配置中心的实现工具不同。我们需要首先对 Spring 容器相关的知识体系有足够的了解，才能更好地理解 Spring Cloud Config 的设计和实现方式。</p>\n<p>讨论完配置中心之后，下一讲我们将面对一个新的问题，即链路跟踪。在分布式服务系统构建过程中，链路跟踪同样是一个基础技术组件。那么，如何对服务链路进行有效监控呢？我们下一讲再聊。</p>\n<h1 id="链路跟踪：如何对服务链路进行有效监控？"><a href="#%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AF%B9%E6%9C%8D%E5%8A%A1%E9%93%BE%E8%B7%AF%E8%BF%9B%E8%A1%8C%E6%9C%89%E6%95%88%E7%9B%91%E6%8E%A7%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>链路跟踪：如何对服务链路进行有效监控？​</h1>\n<p>通过前面几讲内容的介绍，我们已经掌握了注册中心、服务网关、配置中心等一系列技术组件。基于这些组件，我们可以构建完整而强大的分布式系统。</p>\n<p>在分布式系统中，一组独立的服务相互协作完成特定的业务功能。而服务之间的调用不可避免会出现各种问题，这时候就需要引入分布式链路跟踪机制来定位和解决这些问题。</p>\n<p>那么，如何对服务链路进行有效监控呢？业界关于分布式链路跟踪也有统一的规范以及代表性的实现框架。本讲内容将围绕这些规范和框架展开详细的讨论。</p>\n<h2 id="问题背景-14"><a href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-14" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题背景</h2>\n<p>在分布式系统中，我们基于业务划分服务，并对外暴露服务访问接口。试想这样一个场景，如果我们发现某一个业务接口在访问过程中发生了错误，一般的处理过程就是快速定位到问题所发生的服务并进行解决。但在现实的中大型系统中，一个业务接口背后可能会调用一批其他业务体系中的业务接口或基础设施类的底层接口，这时候我们如何能够做到快速定位问题呢？</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-20-11-50-41-64ef2320b287fe6003c55bfb7b16d314-0e173.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 646px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 66.40866873065015%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACS0lEQVQ4y42T61LaUBSF85LtC/TB2plapkprVQqCogI1EQEDEkEGCyTcw51UoDgkXw+BOlJbp3tmzflx1qy99k3iH+HYC/etakck375G9bwR7yuK8jucFQHHcZ5Beib05HMZP3o12rkg5dQ+jayfUavwm/jIeRrS37IsYdu2SxhbfcxeiZv8Ja1OkcGwzUrH+T+Hf0a5lEVNeYkrO1woW5S+J92SbWchYD+DNL63MEc9OsJJxxpgDnvCSQu9pruYTKbC7aq02ewn47H1ogHJp/mJ3fmI5PeI3e5zkPAQqB0TtWROzBjdQdclLrMvY2gNkQsKajWD1r0la+bRBLLtHNc1DelA20e93UVJfuD8couzzA4JslyRQ5knaZgNV2ixnnq5VSEykznQv/I55yXUDBKo+jkdR4lMZKRwPULcUbmwVU7rxwTUbeRqCMUIctoI0+qbK4frIelt3eWqeohCdpdCwUcxt0eiF3ONSCfNKGk0kgJLkWTqI3LSw6Uo/ey7n+bA3HBYEYLR+QWBRhB/xYc3t4NX28ZXOyQyVZBClRO+zeKcjc7ZFb30FvY4bIYJCIQ7Udrd9kYPzZ6JUoy7fbtu33AleplpaqR0lUxNODRFSYZZpWrWMNpVAYNat06lWeHOKG1M0LIsptMpi7nNfPJAXa9zP5rgPIgtsN3VfHkP+8Jdr9cSQn1arTrz+Xw1mHIKTftCPL5NPu+j0SyyXvXVpWws57pXpnCcTn9CPn9PIu4RAkePp9bpGGLhU0I4jWGoImnDvZ7l4H4BSwDBaqk/uYMAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 20 11 50 41" title="" data-src="/static/2024-11-20-11-50-41-64ef2320b287fe6003c55bfb7b16d314-0e173.png" data-srcset="/static/2024-11-20-11-50-41-64ef2320b287fe6003c55bfb7b16d314-2fb9f.png 200w,\n/static/2024-11-20-11-50-41-64ef2320b287fe6003c55bfb7b16d314-f1e72.png 400w,\n/static/2024-11-20-11-50-41-64ef2320b287fe6003c55bfb7b16d314-0e173.png 646w" data-sizes="(max-width: 646px) 100vw, 646px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>传统的做法是通过查阅服务器的日志来定位问题，但在中大型系统中，这种做法可操作性并不强，主要原因在于我们很难找到包含错误日志的那台服务器。一方面，开发人员可能都不知道整个服务调用链路中具体有几个服务，也就无法找到是哪个服务发生了错误。就算找到了目标服务，在分布式集群的环境下，我们也不建议直接通过访问某台服务器来定位问题。服务监控的需求就应运而生。</p>\n<p>从上述描述中，我们不难看出服务监控是分布式系统的基础需求之一。可以说，链路跟踪是构建分布式系统过程中必不可少的一个技术组件。因此，在面试过程中，面试官也会经常对这一主题进行考查，常见的提问方式包括：</p>\n<ul>\n<li>在服务监控领域，Trace 和 Span 分别代表什么含义？</li>\n<li>你能描述分布式服务链路跟踪的基本原理吗？</li>\n<li>针对一个完整的远程调用请求和响应过程，应该如何计算所消耗的时间？</li>\n<li>如果想要获取可视化的链路跟踪数据，可以采用什么工具和框架？</li>\n<li>如果你想在服务调用链路中添加自定义的性能指标，有什么实现方案？</li>\n</ul>\n<p>服务监控相关的面试题提问方式实际上还是比较固定的，让我们对这类问题做进一步分析。</p>\n<h2 id="问题分析-15"><a href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-15" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题分析</h2>\n<p>对于服务监控类的面试题而言，我们的切入点主要在于两个方面，一方面是分布式服务跟踪的基本原理，另一方面则是目前主流的实现工具和框架。</p>\n<p>关于分布式服务跟踪和监控的运行原理，实际上并不是特别复杂，我们首先需要引入两个基本概念，即 Trace 和 Span。</p>\n<p>其中，Trace 代表一次请求和响应过程中的整个调用链路，而 Span 则代表这个链路中的一段跨度。显然，Trace 和 Span 是一对多的关系。通过将一个个具体的 Span 聚合起来，我们就可以构建出一条完整的链路并进行有效的跟踪。围绕这两个概念，我们可以进一步引出链路跟踪过程中的 4 种关键事件并开展性能分析。这是回答这类面试题的第一点思路。</p>\n<p>回答这类面试题的第二点思路是将这些原理应用到具体的框架中。这里可以选择一些主流的开源框架展开讨论，例如本讲中要介绍的 Spring Cloud Sleuth。对于这些工具，一方面我们需要对调用链路中所生成的监控数据进行收集和分析，另一方面也需要介绍一些可视化的工具来展示这些数据分析的结果。在面试过程中，面试官一般都会考查候选人对工具框架的具体掌握程度，需要我们对它们的功能特性有全面的了解。</p>\n<p>最后，我们再次回到实践。一旦掌握分布式服务跟踪原理和相关的工具，我们就可以按照自身的需要来定制化链路构建过程。这在我经历的面试过程中也是经常会被考查的一个问题点。面试官喜欢基于这种面试主题中对候选人的工程实践能力进行充分的考查，这就需要开发人员能够结合具体的场景给出工具应用的方式，最好能够总结一定的最佳实践。</p>\n<h2 id="技术体系-17"><a href="#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-17" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术体系</h2>\n<h3 id="分布式服务跟踪基本原理"><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E6%9C%8D%E5%8A%A1%E8%B7%9F%E8%B8%AA%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分布式服务跟踪基本原理</h3>\n<p>我们先来分析一下分布式服务跟踪的基本原理，这里需要引入两个 Id，即 TraceId 和 SpanId，它们分别代表一个全局唯一的 Trace 和 Span。</p>\n<p>TraceId 即跟踪 Id。在分布式架构中，每个请求会生成一个全局的唯一性 Id，通过这个 Id 可以串联起整个调用链。也就是说，当请求在分布式系统内部流转时，系统需要始终保持传递该唯一性 Id，直到请求返回。这个唯一性 Id 就是 TraceId。</p>\n<p>除了 TraceId 外，我们还需要 SpanId，SpanId 一般被称为跨度 Id。所谓跨度，就是调用链路中的其中一段时间，具有明确的开始和结束这两个节点，这样通过计算开始时间和结束时间之间的时间差，我们就能明确调用过程在这个 Span 上所产生的时间延迟。</p>\n<p>通过前面的介绍，我们不难理解 TraceId 和 SpanId 之间是一对多的关系，即在一个调用链路中只会存在一个 TraceId，但会存在多个 SpanId。这样多个 SpanId 之间就会有父子关系，即链路中的前一个 SpanId 是后一个 SpanId 的父 SpanId，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-20-11-54-41-573c4af0e6c5cc793143fa10d23940b0-b03fa.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 24.76923076923077%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAABN0lEQVQY00WQ2U7CYBCF+/6vYLxQTFSQTQqtXVRcKpSlpQShrVYiRYKNkqBXgn7+VI0XJzOZ+U7mZKSjZpHaWKMSKr9SU8l3KrVI46hf5qCb59DJk3ULVO9PUv3zPx45EhqpSNl2AW1uos0MzOQM4/kUY36KEmvUYmEeK2Sae2ydb7PvHKA+6VQnasr98fqGn+koYx1pNpvT7R4zjVU8L8doWOQhqhJFMo3GLtOpxu1tgbt7mcdHFd8vcWPtMBG918syGORTNooU+n0Pab3+JPAt+l4F09jDusrhiANhYIoq03Mq6CcZri+zdFol/JFBu1XGFYypZ7DFyzZMGJyxeF0gwRcfHyve3t4JwpDlcikSDanXL0RyF8dxSZKEl5dXXLcn5pd0Og7D4QjbtrGsG+J4mu5XqxXfhb5R4dgd4GQAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 20 11 54 41" title="" data-src="/static/2024-11-20-11-54-41-573c4af0e6c5cc793143fa10d23940b0-b03fa.png" data-srcset="/static/2024-11-20-11-54-41-573c4af0e6c5cc793143fa10d23940b0-6fb5f.png 200w,\n/static/2024-11-20-11-54-41-573c4af0e6c5cc793143fa10d23940b0-d11a1.png 400w,\n/static/2024-11-20-11-54-41-573c4af0e6c5cc793143fa10d23940b0-b03fa.png 650w" data-sizes="(max-width: 650px) 100vw, 650px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>理解了 TraceId 和 SpanId 的概念之后，我们就需要对整个分布式调用链路进行进一步拆分，从而细化控制的粒度。业界一般通过四种不同的注解（Annotation）记录每个服务的客户端请求和服务器响应过程。这里的注解实际上代表的就是链路中所发生的关键事件。</p>\n<ul>\n<li>cs 注解: cs 代表 Client Send，即客户端发送请求，启动整个调用链路。</li>\n<li>sr 注解: sr 代表 Server Receive，即服务端接收请求。显然 <code class="language-text">(sr - cs)</code> 值代表请求从客户端到服务器端所需要的网络传输时间。</li>\n<li>ss 注解: ss 代表 Server Send，即服务端把请求处理结果返回给客户端，<code class="language-text">(ss - sr)</code> 值代表服务器端处理该请求所需要的时间。</li>\n<li>cr 注解: cr 代表 Client Receive，即客户端接收到服务端响应，结束调用链路。<code class="language-text">(cr - sr)</code> 值代表响应结果从服务器端传输到客户端所需要的时间。</li>\n</ul>\n<p>下面结合一张示意图来进一步解释这四种注解之间的关联关系：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-20-11-55-27-62df4dfff108a29947160475f68488ea-0e173.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 646px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 43.65325077399381%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAAB6UlEQVQoz12Se3PSUBTE8/2/hNV/tNXRFgs6tFooBRLeL9tqoSmQEBISHgnkIYWfNxnttN6ZnTvZszl75tyVeHZmM5vlconruglWqxW2baOqKo7jJN//arHO8zz+P1JMuq6XFKemyXqzYRPD99nv9+x2OyzLSsTb7fZvLcAV+rt+P7ldb53wURgind6m6d9+wTYKyb20inSuM7z/cUJ71Hly/h2F5O9V0r9uuLtOYenfue0d49oFGp0Mh40WJ7UakvxYRVbTNPUspcFnOsY5spYlF5WpaLWk2V7AFxPkxaTl3Rb5vkLLaKE81IS+SVnvcb5yOVBkpAZdLoIKp7MLUpMzjvUzyvsWxW0FZVR7mjAQK8jpGjHzbRPxaWwKrUVqOkcW3KUwPCiVkOq0KVg5rgTyk/ME5VWJ4mOFqlZ/0fDSnFKNf7bG5A2V/PRBcEPK3pyc2OMbRUFKaxl6nSP08Vd+3nzEmmSpdj9wNEyJVSjPGm7IPgxJ6yO6rbdowzTd9iGOmSUvv+NVvcnrUhFpoA8whctUuLXbCovFBMMcMZjc4/le8spxRJJYidiohiFefcR8PmEwuMaxNXRjSF/XMUTEpOcZcpwF67VPGEREAmEQCoMF4/E4iUcYBIIPCETN90PRdCkMX+bwDyLLk56/pFSMAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 20 11 55 27" title="" data-src="/static/2024-11-20-11-55-27-62df4dfff108a29947160475f68488ea-0e173.png" data-srcset="/static/2024-11-20-11-55-27-62df4dfff108a29947160475f68488ea-2fb9f.png 200w,\n/static/2024-11-20-11-55-27-62df4dfff108a29947160475f68488ea-f1e72.png 400w,\n/static/2024-11-20-11-55-27-62df4dfff108a29947160475f68488ea-0e173.png 646w" data-sizes="(max-width: 646px) 100vw, 646px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>有了这四个注解之后，我们就可以使用它们来量化整个服务调用链路，从而找出潜在的问题。这里同样给出一个示意图：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-20-14-05-46-2b55dd75f048c84c437d4a5a89850b82-0e173.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 646px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 50.46439628482972%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAAB/UlEQVQoz42S227aQBRF+f/P6ENbqQqp2pQkSkMChIKdEgh3c/MFO4AxGGwHczFeHYLaSK0q5UhbM5qHNfvscxJxHPO33lrraE++VyXfuEFq3ZLTmyTgAHjVb6gbuDiec5TvMPWOsr0pc99lv9sxC0IqqkS/dcLESKHMBfBgaL9/1aE2uw05T+ZHXKYQPVAQpzy5pd5L0dIuKJtZgiDA30TI6j199YLZPEfd7ZCwzDRDI42hX2NZN2w3Ia6/pDC6oenneZxlkLb3PE5vaZU/YakpenaeieMQrje0xyZVrUVdb9Ocjkjo6js67SST8RWW+YFVsMB9Dqh0vtFtfGYoXNVWEpIAtpUzrEma+viO+WL5J8t4FxGLPEVWAqh9pKucM7XvGI+SLFybZbii0k0xaH9lpF9SD2WK86x4O6MmHJaeskegAGwEaC1YLxL3hKae0O8m0QbCjXHKOhTZCGDRztJ4LlJd5pF3JapOhkHzC7b5HWWcY+Yu8FchhX6NR1WmpolPzc5hKHsRsIfvL8RQouM67Nakl3dkIpnMViIX/6Q4uqTRSoqWr8RQrrGnU7z1loeBRLX0HlU5pek0Dmvzb0UCPPRMdN9gGJi07Y5wpTCYdOmOFIyZ8dLuYcoPeole7wxHZNx0lYPDNyz2f3Z9G0XULI2yWhdt16k86fwCmNPkiFCpzOoAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 20 14 05 46" title="" data-src="/static/2024-11-20-14-05-46-2b55dd75f048c84c437d4a5a89850b82-0e173.png" data-srcset="/static/2024-11-20-14-05-46-2b55dd75f048c84c437d4a5a89850b82-2fb9f.png 200w,\n/static/2024-11-20-14-05-46-2b55dd75f048c84c437d4a5a89850b82-f1e72.png 400w,\n/static/2024-11-20-14-05-46-2b55dd75f048c84c437d4a5a89850b82-0e173.png 646w" data-sizes="(max-width: 646px) 100vw, 646px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在上图中，我们看到这次请求的 TraceId 是 trace1，而 SpanId 根据不同的服务会发生变化。这里的四种注解构成了客户端和服务器对一次请求处理的闭环。对于服务 A 而言，cs 是 11:10:44，cr 是 11:10:55，也就说该次服务请求经由服务 A 的整个调用链路时间是 11s(11:10:44~11:10:55)，显然这个响应时间非常长。</p>\n<p>显然，通过这些注解我们就可以发现服务调用链路中存在的问题，目前主流的服务监控实现工具都对这些注解做了支持和封装。</p>\n<h3 id="spring-cloud-中的服务监控"><a href="#spring-cloud-%E4%B8%AD%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Spring Cloud 中的服务监控</h3>\n<p>通过前面所介绍的服务监控基本原理，我们明确了分布式环境下服务跟踪的载体，即 TraceId 和 SpanId。而在 Spring Cloud 中也存在一个组件能够帮忙我们自动生成 TraceId 和 SpanId，这个组件就是 Spring Cloud Sleuth。</p>\n<p>接下来，我们来看一下 Spring Cloud Sleuth 中链路跟踪的表现形式，如下所示的是一个具体的示例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18205569968970404000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`INFO [userservice,81d66b6e43e71faa,6df220755223fb6e,true] 18100 --- [nio-8082-exec-8] c.s.user.controller.UserController: Get user by UserName from userservice instance`, `18205569968970404000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">INFO [userservice,81d66b6e43e71faa,6df220755223fb6e,true] 18100 --- [nio-8082-exec-8] c.s.user.controller.UserController: Get user by UserName from userservice instance</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>我们关注于上述日志信息中的斜体部分内容，可以看到包括了四段内容，即服务名称、TraceId、SpanId 和 Zipkin 标志位，它是格式如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87556055383168480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[服务名称, TraceId, SpanId, Zipkin 标志位]`, `87556055383168480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">[服务名称, TraceId, SpanId, Zipkin 标志位]</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>显然，第一段中的 userservice 代表着该服务的名称，使用的就是在 Spring Boot 应用中 spring.application.name 配置项所指定的服务名称。考虑到服务跟踪的需求，为服务指定一个统一而友好的名称是一项最佳实践。</p>\n<p>第二段中的 TraceId 代表一次完整请求的唯一编号，上例中的 81d66b6e43e71faa 就是该次请求的唯一编号。在诸如 Zipkin 等可视化工具中，可以通过 TraceId 查看完整的服务调用链路。</p>\n<p>在一个完整的服务调用链路中，每一个服务之间的调用过程都可以通过 SpanId 进行唯一标识，例如上例中位于第三段的 6df220755223fb6e。所以 TraceId 和 SpanId 是一对多的关系，即一个 TraceId 一般都会包含多个 SpanId，每一个 SpanId 都从属于特定的 TraceId。当然，也可以通过 SpanId 查看某一个服务调用过程的详细信息。</p>\n<p>最后的第四段代表 Zipkin 标志位，该标志位用于识别是否将服务跟踪信息同步到 Zipkin。Zipkin 是一个可视化工具，可以将服务跟踪信息通过一定的图形化形式展示出来。</p>\n<h2 id="源码解析-15"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-15" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h2>\n<p>在本讲的源码解析部分，我们一方面分析 Spring Cloud Sleuth 生成和传递 Span 的实现原理。另一方面，我们也将基于更为底层的 Brave 框架给出创建自定义 Span 的实现方法。</p>\n<h3 id="基于-spring-cloud-sleuth-生成和传递-span"><a href="#%E5%9F%BA%E4%BA%8E-spring-cloud-sleuth-%E7%94%9F%E6%88%90%E5%92%8C%E4%BC%A0%E9%80%92-span" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基于 Spring Cloud Sleuth 生成和传递 Span</h3>\n<p>在一次远程调用中，对于服务提供者而言，服务的消费者相当于是它的客户端。而对于调用过程中的其他服务，这个服务消费者也可能是它们的服务提供者。因此，取决于在链路中的具体位置，不同服务可能会扮演不同的角色，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-20-14-07-48-394925941b22c1fdef88c20d5973368e-9cb4a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 510px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.23529411764706%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAACGElEQVQoz2WSCW/aQBCF/f9/R6tyk5SGpIUAEkrLYbAxmCNgbgeTcB/mNK/PS1ql6kijWXt33858M1KrGYWc86GQ96OqR6AU/Wg+a3DNcS6o18rIZbwwWt/Ffp5ni3JAxFzWi7J2g0Y9yv0oEgk/pPNJRqUc5OEQxlYS00mC6xwOhxN2uz3y+Sd0O1FcHBXLxRO0kh/Pja/QK2Fxz72z3+X5vIJUygOp0zGYUR26XsZg0IVhNClk4485joN+v4d220Cn00av27l6ryu8222L/4bRwmw2hWTbO1iWhXJZw36/x3q1FiIfbbPZwrZtPrT7J17X1+/1eo3j8QTJHD6SnxeZX5+ZaZTMyKSh4HIBzuczNK2IkhpATb9lDLLkEAqyjzFMfmGoSpD/QzAHMSSTPkjbTUY0QqX3ezFYozhqNRmn05kZH6AoObSNe3K7EyI6hV2RWjVChjdirVdusd1kkU4HmKFpkkOPWTVE6cOhKVL/aJY1xmhk/R/f164PBibRbCCtVnOK9FAs5slvgen0jYLHv2IX1j6fTwl8IqJ7frmci+j6YjETe+697XYL6dV65Fx5yOULBv0f5BhmOTLcvriZFgsZlurD5C1FJA/E44Gm+sX4qIoXrWYEL2ac45ZELPYJ0nolE26EIlG8jn+yjBSaTY0NcTiLR1SrJTKMs6MqRTPvZ+/J7Y4NfKBYGqtlATtbQTbzDb8BdIjNwJF+0gkAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 20 14 07 48" title="" data-src="/static/2024-11-20-14-07-48-394925941b22c1fdef88c20d5973368e-9cb4a.png" data-srcset="/static/2024-11-20-14-07-48-394925941b22c1fdef88c20d5973368e-931d4.png 200w,\n/static/2024-11-20-14-07-48-394925941b22c1fdef88c20d5973368e-3a665.png 400w,\n/static/2024-11-20-14-07-48-394925941b22c1fdef88c20d5973368e-9cb4a.png 510w" data-sizes="(max-width: 510px) 100vw, 510px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>针对上图，我们第一步需要讨论的是在服务调用过程中如何生成 Span。在 Spring Cloud Sleuth 中，生成 Span 的过程发生在对请求进行拦截的过程中，这个拦截器就是 LazyTracingFilter。</p>\n<p>我们来看位于该拦截器中与创建 Span 相关的实现方式，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37053577960774420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Override\npublic void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {\n   HttpServletRequest req = (HttpServletRequest) request;\n   HttpServletResponse res = servlet.httpServletResponse(response);\n\n   // 从请求中获取现有 Span 或创建新的 Span\n   Span span = handler.handleReceive(new HttpServletRequestWrapper(req));\n\n   // 为 Span 添加额外属性\n   request.setAttribute(SpanCustomizer.class.getName(), span);\n   request.setAttribute(TraceContext.class.getName(), span.context());\n\n   // 保存当前的 Span 信息，用于将这些信息通过过滤器链继续向下传递\n   CurrentTraceContext.Scope scope = currentTraceContext.newScope(span.context());\n   try {\n      chain.doFilter(req, res);\n   } catch (Throwable e) {\n      //...\n   } finally {\n      // ...\n      // scope.close();\n   }\n}`, `37053577960774420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>\n   <span class="token class-name">HttpServletRequest</span> req <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">;</span>\n   <span class="token class-name">HttpServletResponse</span> res <span class="token operator">=</span> servlet<span class="token punctuation">.</span><span class="token function">httpServletResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token comment">// 从请求中获取现有 Span 或创建新的 Span</span>\n   <span class="token class-name">Span</span> span <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">handleReceive</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpServletRequestWrapper</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token comment">// 为 Span 添加额外属性</span>\n   request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name">SpanCustomizer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> span<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name">TraceContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> span<span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token comment">// 保存当前的 Span 信息，用于将这些信息通过过滤器链继续向下传递</span>\n   <span class="token class-name">CurrentTraceContext</span><span class="token punctuation">.</span><span class="token class-name">Scope</span> scope <span class="token operator">=</span> currentTraceContext<span class="token punctuation">.</span><span class="token function">newScope</span><span class="token punctuation">(</span>span<span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">//...</span>\n   <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>\n      <span class="token comment">// ...</span>\n      <span class="token comment">// scope.close();</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>请注意，Spring Cloud Sleuth 在底层实际上是借助于 Brave 这个框架来实现 Span 的创建和传递，所以这里出现了很多与这个框架相关的代码。</p>\n<p>考虑到在一个服务调用链路中，当前的服务消费者对于其他服务而言也可能是服务的提供者。所以，我们会首先判断 Brave 框架中当前的跟踪上下文 TraceContext 是否为空，如果不为空就说明这个服务消费者是其他服务的提供者，我们可以通过 Tracer 的 joinSpan 方法把当前已经存在的 Span 加入到该上下文中。反之则说明这个服务消费者是整个调用链路的第一个服务，我们会通过 Tracer 的 nextSpan 方法创建一个新的 Span，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85881751140950250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Span nextSpan(TraceContextOrSamplingFlags extracted, HttpServerRequest request) {\n   Boolean sampled = extracted.sampled();\n   if (sampled == null && (sampled = sampler.trySample(request)) != null) {\n      extracted = extracted.sampled(sampled.booleanValue());\n   }\n   // 判断是否新建一个 Span\n   return extracted.context() != null\n         ? tracer.joinSpan(extracted.context())\n         : tracer.nextSpan(extracted);\n}`, `85881751140950250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">Span</span> <span class="token function">nextSpan</span><span class="token punctuation">(</span><span class="token class-name">TraceContextOrSamplingFlags</span> extracted<span class="token punctuation">,</span> <span class="token class-name">HttpServerRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token class-name">Boolean</span> sampled <span class="token operator">=</span> extracted<span class="token punctuation">.</span><span class="token function">sampled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>sampled <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>sampled <span class="token operator">=</span> sampler<span class="token punctuation">.</span><span class="token function">trySample</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      extracted <span class="token operator">=</span> extracted<span class="token punctuation">.</span><span class="token function">sampled</span><span class="token punctuation">(</span>sampled<span class="token punctuation">.</span><span class="token function">booleanValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token comment">// 判断是否新建一个 Span</span>\n   <span class="token keyword">return</span> extracted<span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span>\n         <span class="token operator">?</span> tracer<span class="token punctuation">.</span><span class="token function">joinSpan</span><span class="token punctuation">(</span>extracted<span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n         <span class="token operator">:</span> tracer<span class="token punctuation">.</span><span class="token function">nextSpan</span><span class="token punctuation">(</span>extracted<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里的 Tracer 是 Brave 框架所提供的一个工具类，具备一组用于完成与 Span 相关的各种属性和操作的方法，我们在本讲后续内容中还会对该类做进一步展开讨论。</p>\n<p>当我们已经获取一个有效的 Span 对象之后，就可以对它做一些必要的赋值操作，然后保存这个 Span。这样，这个 Span 中的信息就可以通过过滤器链继续在调用链路中向下传递。这个过程也是通过一个拦截器来完成的，这个拦截器就是 TracingClientHttpRequestInterceptor，我们来看它的拦截实现方式，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80602611104842240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Override\npublic ClientHttpResponse intercept(HttpRequest req, byte[] body, ClientHttpRequestExecution execution) throws IOException {\n   HttpRequestWrapper request = new HttpRequestWrapper(req);\n   // 将 Span 信息注入到 HTTP 请求中\n   Span span = handler.handleSend(request);\n\n   ClientHttpResponse response = null;\n   Throwable error = null;\n   try (CurrentTraceContext.Scope ws = currentTraceContext.newScope(span.context())) {\n      // 发送请求、获取响应\n      response = execution.execute(req, body);\n      return response;\n   } catch (Throwable e) {\n      // ...\n   } finally {\n      // 创建事件\n      handler.handleReceive(new ClientHttpResponseWrapper(request, response, error), span);\n   }\n}`, `80602611104842240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token class-name">ClientHttpResponse</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">HttpRequest</span> req<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">,</span> <span class="token class-name">ClientHttpRequestExecution</span> execution<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>\n   <span class="token class-name">HttpRequestWrapper</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpRequestWrapper</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 将 Span 信息注入到 HTTP 请求中</span>\n   <span class="token class-name">Span</span> span <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">handleSend</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token class-name">ClientHttpResponse</span> response <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n   <span class="token class-name">Throwable</span> error <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n   <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">CurrentTraceContext</span><span class="token punctuation">.</span><span class="token class-name">Scope</span> ws <span class="token operator">=</span> currentTraceContext<span class="token punctuation">.</span><span class="token function">newScope</span><span class="token punctuation">(</span>span<span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 发送请求、获取响应</span>\n      response <span class="token operator">=</span> execution<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> response<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// ...</span>\n   <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 创建事件</span>\n      handler<span class="token punctuation">.</span><span class="token function">handleReceive</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClientHttpResponseWrapper</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">,</span> span<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>你可能会问，Span 信息是如何传递给下一个服务的呢？答案就在这个 <code class="language-text">HttpClientHandler.handleSend</code> 方法中，该方法如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97953319150012890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public Span handleSend(HttpClientRequest request, Span span) {\n   // ...\n   // 将 Span 信息注入到 HTTP 消息头\n   defaultInjector.inject(span.context(), request);\n\n   // 创建事件\n   return handleStart(new HttpClientRequest.ToHttpAdapter(request), request.unwrap(), span);\n}`, `97953319150012890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Span</span> <span class="token function">handleSend</span><span class="token punctuation">(</span><span class="token class-name">HttpClientRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">Span</span> span<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// ...</span>\n   <span class="token comment">// 将 Span 信息注入到 HTTP 消息头</span>\n   defaultInjector<span class="token punctuation">.</span><span class="token function">inject</span><span class="token punctuation">(</span>span<span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token comment">// 创建事件</span>\n   <span class="token keyword">return</span> <span class="token function">handleStart</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpClientRequest</span><span class="token punctuation">.</span><span class="token class-name">ToHttpAdapter</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> span<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，这里出现了一个注入器组件 Injector，该组件会将一个 Span 中相关的 SpanId、TraceId、ParentId 等信息注入到 HTTP 请求的消息头中，从而确保这些信息能够随着 HTTP 请求的发送传递到下一个服务中。</p>\n<p>请注意，这里出现的 handleReceive 和 handleStart 方法分别用于记录 Span 的关键事件。从命名上，我们不难理解 handleReceive 用于处理 cr 事件，而 handleStart 则用来处理 cs 事件。通过这种方式，当请求在某一个服务中被处理完成，相应的事件也会被记录下来。</p>\n<h3 id="使用-brave-创建自定义-span"><a href="#%E4%BD%BF%E7%94%A8-brave-%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89-span" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 Brave 创建自定义 Span</h3>\n<p>在前面的内容中，我们已经提到了通过 Brave 框架来生成 Span 的实现方法。同样的，如果想要在访问链路中创建自定义的 Span，需要对 Brave 框架所提供的功能有足够的了解。</p>\n<p>我们首先来关注 Brave 中的 Span 类，该类的方法列表如下所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-20-14-25-04-230a789584923190762ff51c223c3d2f-c18ed.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 388px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 115.97938144329898%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAAAsSAAALEgHS3X78AAAC10lEQVQ4y52VyZLaQBBE+f9f8c0/4JNPY0cwCNC+IxBC+8YyoHR2M8EQMDC2O6JpcdDrqqzK0uiH7+H7bwPffk5RbQ8Q6zQMGK62WNfPz9ao7LZYhT4UTYdpO5++dAt+CsTphGbXIAg9GLoGL/CR5xu0dYqqiNE2xR34GXwkfspdi2ARwDBMvCoTJBuCqhj5ZnGGEr7btndRfx4hV9aXCKMAuq5D1VR41HVDaJktCQ2Rrj0U6QIdo22b/CbC4R5Y7btzhEw5oJ5hYCFeL2VUArLta/QtYXX2F8BBpNzAdi1oBEbLCFkSoqkSvB32D8V/mnK+reF6DlPWMJvPMJ3NkGcJ0thhdNV/FIWpuUEA0zQIU2DZPAmuqgzJykbfN3z59L4fp3tJuWCElmtjNptiPB7DNDS8/HqBzgts24Ju6CgLRrx2sdt1X6ecdhVsz2XbGFJHVZ3DciyofC6KDapsgW1XfanfBdjIKvuMxib03DpCT9fzZPoC3DQlCrZQ3zUf0EcaZrzdtExMFEVqKJ5tEaGqIgg8rOMAaRKwQA2OxzcJelQYCRQaurScpmmEGbI4PptbmU5lg/f12S2PWucaOhK31bRenKzhOOeUxSnaR2dxQnrc8wysVgtkWS6j7NuKI+AoazzcTCZZ5awT1gtZEFUWxbJNqaGmzeX/OTUVcggpRKTZ2sF+3z8uSiWGwzKULSIAunFuF2WqEDaXp0afv07G0pJRaLL6Kbq+R9e1dNQOB15w4Pk+bRr49LLoN4P6GSZPpruIFnJQGJZFTX15WRhFlMCVVvVphjiOpE2LLEKZr96tR/N71Gr8OpbFaJsUdbn+1AlfTmzxU+9pPYLE+BIR2q7Lvivkrfv97s7Hz/YlZdt3KfxENvWMTknThLMwkKPrn4H5toLLlCcUP9kkSGKfkzqRw+DET8QFeCXBUy93hwMcOkJha4h5OAxHHN8OD1++/RJe7z+ZUuD8Q9o4VgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 20 14 25 04" title="" data-src="/static/2024-11-20-14-25-04-230a789584923190762ff51c223c3d2f-c18ed.png" data-srcset="/static/2024-11-20-14-25-04-230a789584923190762ff51c223c3d2f-a2138.png 200w,\n/static/2024-11-20-14-25-04-230a789584923190762ff51c223c3d2f-c18ed.png 388w" data-sizes="(max-width: 388px) 100vw, 388px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>注意到 Span 是一个抽象类，在上面的方法列表中，我们也看到该类的几乎所有方法都是抽象方法，需要子类进行实现。在 Brave 中，该抽象类的子类就是 RealSpan。RealSpan 中的 start 方法如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80894045526769980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Override\npublic Span start(long timestamp) {\n   synchronized (state) {\n      state.startTimestamp(timestamp);\n   }\n   return this;\n}`, `80894045526769980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token class-name">Span</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      state<span class="token punctuation">.</span><span class="token function">startTimestamp</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里的 state 是一个可变的 MutableSpan，而上述 start 方法就是为这个 MutableSpan 设置了开始时间。可以想象，对应的 finish 方法也会为 MutableSpan 设置结束时间，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31594115408216883000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Override\npublic void finish(long timestamp) {\n   if (!pendingSpans.remove(context)) return;\n   synchronized (state) {\n      state.finishTimestamp(timestamp);\n   }\n   finishedSpanHandler.handle(context, state);\n}`, `31594115408216883000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pendingSpans<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>\n   <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      state<span class="token punctuation">.</span><span class="token function">finishTimestamp</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   finishedSpanHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对于关闭 Span 的操作而言，上述方法还添加了一个 Handler 以便执行回调逻辑，这也是非常常见的一种实现技巧。</p>\n<p>我们接着来看另一个非常有用的 annotate 方法，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24766257154103054000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Override\npublic Span annotate(long timestamp, String value) {\n   if (&quot;cs&quot;.equals(value)) {\n      synchronized (state) {\n         state.kind(Span.Kind.CLIENT);\n         state.startTimestamp(timestamp);\n      }\n   } else if (&quot;sr&quot;.equals(value)) {\n      synchronized (state) {\n         state.kind(Span.Kind.SERVER);\n         state.startTimestamp(timestamp);\n      }\n   } else if (&quot;cr&quot;.equals(value)) {\n      synchronized (state) {\n         state.kind(Span.Kind.CLIENT);\n      }\n      finish(timestamp);\n   } else if (&quot;ss&quot;.equals(value)) {\n      synchronized (state) {\n         state.kind(Span.Kind.SERVER);\n      }\n      finish(timestamp);\n   } else {\n      synchronized (state) {\n         state.annotate(timestamp, value);\n      }\n   }\n   return this;\n}`, `24766257154103054000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token class-name">Span</span> <span class="token function">annotate</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"cs"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         state<span class="token punctuation">.</span><span class="token function">kind</span><span class="token punctuation">(</span><span class="token class-name">Span</span><span class="token punctuation">.</span><span class="token class-name">Kind</span><span class="token punctuation">.</span>CLIENT<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         state<span class="token punctuation">.</span><span class="token function">startTimestamp</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"sr"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         state<span class="token punctuation">.</span><span class="token function">kind</span><span class="token punctuation">(</span><span class="token class-name">Span</span><span class="token punctuation">.</span><span class="token class-name">Kind</span><span class="token punctuation">.</span>SERVER<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         state<span class="token punctuation">.</span><span class="token function">startTimestamp</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"cr"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         state<span class="token punctuation">.</span><span class="token function">kind</span><span class="token punctuation">(</span><span class="token class-name">Span</span><span class="token punctuation">.</span><span class="token class-name">Kind</span><span class="token punctuation">.</span>CLIENT<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token function">finish</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"ss"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         state<span class="token punctuation">.</span><span class="token function">kind</span><span class="token punctuation">(</span><span class="token class-name">Span</span><span class="token punctuation">.</span><span class="token class-name">Kind</span><span class="token punctuation">.</span>SERVER<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token function">finish</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         state<span class="token punctuation">.</span><span class="token function">annotate</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>基于前面讨论的四种监控事件，我们不难理解上述代码的作用就是为这些事件指定类型以及时间，从而为构建监控链路提供基础。</p>\n<p>RealSpan 中最后一个值得介绍的方法是如下所示的 tag 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8506242343492377000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Override\npublic Span tag(String key, String value) {\n   synchronized (state) {\n      state.tag(key, value);\n   }\n   return this;\n}`, `8506242343492377000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token class-name">Span</span> <span class="token function">tag</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      state<span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>该方法为 Span 打上一个标签，其中两个参数分别代表标签的 Key 和 Value，开发人员可以根据需要对任何一个 Span 添加自定义的标签体系。</p>\n<p>了解了 Span 的定义之后，我们就来讨论如何在业务代码中创建自定义 Span 的方法，这时候就需要引入前面已经给出的 Tracer 类，我们同样挑选几个常见的方法进行展开。</p>\n<p>首先，我们来看如何通过 Tracer 创建一个新的根 Span，可以通过如下所示的 newTrace 方法进行实现：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53260234635814930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public Span newTrace() {\n   return _toSpan(newRootContext());\n}`, `53260234635814930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Span</span> <span class="token function">newTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> <span class="token function">_toSpan</span><span class="token punctuation">(</span><span class="token function">newRootContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这里用到了一个用于保存跟踪信息的 TraceContext 上下文对象，对于根 Span 而言，这个 TraceContext 就是全新的上下文，没有父 Span。而这里的 _toSpan 方法则最终构建了一个前面提到的 RealSpan 对象。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84823810016854640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Span _toSpan(TraceContext decorated) {\n   if (isNoop(decorated)) return new NoopSpan(decorated);\n   PendingSpan pendingSpan = pendingSpans.getOrCreate(decorated, false);\n   return new RealSpan(decorated, pendingSpans, pendingSpan.state(), pendingSpan.clock(), finishedSpanHandler);\n}`, `84823810016854640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">Span</span> <span class="token function">_toSpan</span><span class="token punctuation">(</span><span class="token class-name">TraceContext</span> decorated<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNoop</span><span class="token punctuation">(</span>decorated<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NoopSpan</span><span class="token punctuation">(</span>decorated<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token class-name">PendingSpan</span> pendingSpan <span class="token operator">=</span> pendingSpans<span class="token punctuation">.</span><span class="token function">getOrCreate</span><span class="token punctuation">(</span>decorated<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RealSpan</span><span class="token punctuation">(</span>decorated<span class="token punctuation">,</span> pendingSpans<span class="token punctuation">,</span> pendingSpan<span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pendingSpan<span class="token punctuation">.</span><span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> finishedSpanHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里多了一个新建的对象叫 PendingSpan，该对象用于收集一条 Trace 上暂时被挂起的未完成的 Span。</p>\n<p>一旦创建了根 Span，我们就可以在这个 Span 上执行 nextSpan 方法来添加新的 Span，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39035214443331850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public Span nextSpan() {\n   TraceContext parent = currentTraceContext.get();\n   return parent != null ? newChild(parent) : newTrace();\n}`, `39035214443331850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Span</span> <span class="token function">nextSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token class-name">TraceContext</span> parent <span class="token operator">=</span> currentTraceContext<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> parent <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token function">newChild</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">newTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里获取当前 TraceContext，如果该上下文不存在，就通过 newTrace 方法来创建一个新的根 Span；如果存在，则基于这个上下文并调用 newChild 方法来创建一个子 Span。newChild 方法也比较简单，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59210515494309910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public Span newChild(TraceContext parent) {\n   if (parent == null) throw new NullPointerException(&quot;parent == null&quot;);\n   return _toSpan(nextContext(parent));\n}`, `59210515494309910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Span</span> <span class="token function">newChild</span><span class="token punctuation">(</span><span class="token class-name">TraceContext</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">"parent == null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> <span class="token function">_toSpan</span><span class="token punctuation">(</span><span class="token function">nextContext</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当然，在很多场景下，我们需要获取当前的 Span，这时候就可以使用 Tracer 类所提供的 currentSpan 方法，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20443654075575026000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public Span currentSpan() {\n   TraceContext currentContext = currentTraceContext.get();\n   return currentContext != null ? toSpan(currentContext) : null;\n}`, `20443654075575026000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Span</span> <span class="token function">currentSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token class-name">TraceContext</span> currentContext <span class="token operator">=</span> currentTraceContext<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> currentContext <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token function">toSpan</span><span class="token punctuation">(</span>currentContext<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>基于 Tracer 提供的这些常见方法，我们可以梳理在业务代码中添加一个自定义 Span 的模版方法，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67727018336684620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Service\npublic class MyService {\n   @Autowired\n   private Tracer tracer;\n\n   public void perform() {\n      Span newSpan = tracer.nextSpan().name(&quot;spanName&quot;).start();\n      try {\n         // 执行业务逻辑\n      } finally{\n         newSpan.tag(&quot;key&quot;, &quot;value&quot;);\n         newSpan.annotate(&quot;myannotation&quot;);\n         newSpan.finish();\n      }\n   }\n}`, `67727018336684620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Service</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyService</span> <span class="token punctuation">{</span>\n   <span class="token annotation punctuation">@Autowired</span>\n   <span class="token keyword">private</span> <span class="token class-name">Tracer</span> tracer<span class="token punctuation">;</span>\n\n   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">perform</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token class-name">Span</span> newSpan <span class="token operator">=</span> tracer<span class="token punctuation">.</span><span class="token function">nextSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"spanName"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">try</span> <span class="token punctuation">{</span>\n         <span class="token comment">// 执行业务逻辑</span>\n      <span class="token punctuation">}</span> <span class="token keyword">finally</span><span class="token punctuation">{</span>\n         newSpan<span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">,</span> <span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         newSpan<span class="token punctuation">.</span><span class="token function">annotate</span><span class="token punctuation">(</span><span class="token string">"myannotation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         newSpan<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在上述代码中，我们注入了一个 Tracer 对象，然后通过 nextSpan 方法创建并启动了一个名称为“spanName”的新 Span。这是在业务代码中嵌入自定义 Span 的一种常用实现方法。当我们执行完各种业务逻辑之后，可以分别通过 tag 方法和 annotate 方法添加标签和定义事件，最后通过 finish 方法关闭 Span。这段模板代码可以直接引入到日常的开发过程中。</p>\n<h2 id="解题要点-17"><a href="#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-17" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解题要点</h2>\n<p>构建服务监控和链路跟踪在分布式系统开发过程中是一项基础设施类工作，而我们可以借助于类似 Spring Cloud Sleuth 这样的框架来轻松完成这项工作。Spring Cloud Sleuth 内置了日志采集和分析机制，能够帮忙我们自动建立 TraceId 和 SpanId 之间的关联关系。对于这些工具和框架的介绍是应对这类面试题的第一个要点，也是最基本的要求。在日常开发过程中，很多开发平台已经帮我们内置了对这些工具的支持，但我们还是需要多接触一下这方面的技术组件。</p>\n<p>就面试官的考查方式而言，先从框架应用开始聊起，然后再切入到框架基本原理的讨论是一种常见的提问方式。因此，我们需要对具体框架中所涉及的实现原理做进一步展开。</p>\n<p>这里有两个要点，一方面我们需要介绍分布式服务跟踪的设计思想和基本概念，这部分包括如何基于 Trace 和 Span 构建服务链路的整个过程。另一方面，我们需要结合具体的框架来分析这些概念如何在现实中进行落地，这部分可以重点对本讲中介绍的 Brave 框架进行讨论。</p>\n<p>最后，关于链路跟踪，我们还可以介绍与可视化相关的一些话题，例如 Zipkin 的基本架构、Spring Cloud Sleuth 如何与 Zipkin 进行集成等。作为加分项，这些内容可以展示候选人所具备的知识体系。</p>\n<h2 id="小结与预告-15"><a href="#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-15" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结与预告</h2>\n<p>链路跟踪是一个理论和实践紧密结合的综合性话题，本讲内容对这个话题背后所涉及的核心概念和基本原理都做了详细的介绍。同时，我们基于 Spring Cloud 中的 Spring Cloud Sleuth 以及业界主流的 Brave 框架分析了对应的实现方式。</p>\n<p>讨论完服务监控之后，下一讲我们将讨论消息通信机制。在分布式系统中，消息通信也是一个基础的技术组件，业界也存在一批不同的消息中间件，这些中间件在使用方式上不尽相同。那么，作为基础设施类组件，我们如何设计跨消息中间件的统一消息通信平台？这是下一讲要展开的内容。</p>\n<h1 id="消息通信：如何设计跨消息中间件的统一消息通信平台？"><a href="#%E6%B6%88%E6%81%AF%E9%80%9A%E4%BF%A1%EF%BC%9A%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E8%B7%A8%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E7%BB%9F%E4%B8%80%E6%B6%88%E6%81%AF%E9%80%9A%E4%BF%A1%E5%B9%B3%E5%8F%B0%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>消息通信：如何设计跨消息中间件的统一消息通信平台？</h1>\n<p>在上一讲中，我们解决了分布式系统构建过程中的一个重要问题，即如何对整个服务链路进行有效的监控。基于 Spring Cloud Sleuth 框架，我们发现可以利用 Brave、Zipkin 等一组业务主流的第三方组件来实现这一目标。</p>\n<p>在本讲内容中，我们也将采用类似的讲解思路，来对 Spring Cloud 中另一款强大的框架展开讨论，这款框架就是 Spring Cloud Stream。</p>\n<p>Spring Cloud Stream 是 Spring 家族提供的消息通信框架，而消息通信也是我们在分布式系统构建过程中的一个重要技术组件。然而，和普通的消息中间件不同，Spring Cloud Stream 为开发人员提供的是一种跨消息中间件的统一消息通信平台。</p>\n<p>那么，它是如何做到这一点的呢？这是一个很好的面试题，本讲内容将围绕这一问题展开讨论。</p>\n<h2 id="问题背景-15"><a href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-15" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题背景</h2>\n<p>我们知道，在分布式系统设计和开发过程中，服务与服务之间可以通过 RPC 实现交互。但是，RPC 虽然实现起来比较简单，但却是一种耦合度较高的实现技术。为了降低服务与服务之间的耦合度，有时候我们需要引入消息通信机制，采用异步的方式来完成不同服务之间的交互。</p>\n<p>讲到这里，你可能会说，这不就是消息中间件能解决的问题吗？答案是肯定的，但还不够。</p>\n<p>我们知道常见的消息通信规范以及中间件有很多种，代表性的规范有 JMS 和 AMQP，对应的实现框架包括 ActiveMQ 和 RabbitMQ 等，而 Kafka、RocketMQ 等工具并不遵循特定的规范但也提供了消息通信的实现方案。显然，这些中间件的使用方式是完全不同的。</p>\n<p>那么，如何屏蔽这些中间件在使用上的差别，从而为开发人员提供一套统一且高效的消息发送和接收 API，这是我们今天要讨论的问题，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-21-14-15-03-5a80b036e605d9496845798acd67701c-d6910.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 568px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 46.47887323943662%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABvUlEQVQoz2WQCW/aUBCE/f9/RJASKaGVglJU4kIwVUHFEAjExDimgB1ISDnFIW5jvj6bIygdad+1s/NmV0Kg3+9SLoexbZl8PoimXdNsRik+hlkslh4F13X93TRzghfh2fhGLhekrN/4d8P47eclbxkMelSrUSGikM1+FaLXvNhRKhVFCG05RaNp+B/repiM+oWnUphWS+FP5X4nuN3uCubzBbPZgtVqzXrt0Ov1MY1n+t0ui9mMuYjxaIRVq9N6e/ede7zlcsV0OsdxNh+CB9FT9IdDbo0ysmnyq9kgYdvc1WqECgU6Iufhc5WnIx0OhzjOyrJITKfEhStZuLxpCNHxGHkwoPL6epzraa3v0Ht0t/vYEzyMJhNS+hP5eo2CbfFg1Sk2bJIljcHeobs3cKwXIf3XqxjFZrXB3Ww+Wlk6OLPl8e6I2blr1+d+hqSaKhk7Q7qWFnuWaDFK8jlJu9shW71HtVRi2h1y4Yd/zll52p02KSNFXI/7dWpdaLxkRBcPSCE9ROTtO+e5cwJqgKvSFfFOnEdDI1K7JVgO7nLpAJfaJcpfhaJeRG7KKEOFs/QZF/kLfk4SxBox/gGEEJTWz8U6EQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 21 14 15 03" title="" data-src="/static/2024-11-21-14-15-03-5a80b036e605d9496845798acd67701c-d6910.png" data-srcset="/static/2024-11-21-14-15-03-5a80b036e605d9496845798acd67701c-487ad.png 200w,\n/static/2024-11-21-14-15-03-5a80b036e605d9496845798acd67701c-1cefb.png 400w,\n/static/2024-11-21-14-15-03-5a80b036e605d9496845798acd67701c-d6910.png 568w" data-sizes="(max-width: 568px) 100vw, 568px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在面试过程中，我也经常拿这个问题来考查候选人，发现大家都没有很好的回答思路，可以说这是一个比较有挑战的话题。围绕这个话题，我们还可以有以下几种提问方式：</p>\n<ul>\n<li>消息通信机制如何实现服务与服务之间的解耦？</li>\n<li>如果让你设计一套统一的消息发送和消费的 API，你会怎么考虑？</li>\n<li>Spring Cloud Stream 的基本架构是怎么样？</li>\n<li>Spring Cloud Stream 与 Spring Integration 之间是什么关系？</li>\n<li>Spring Cloud Stream 是如何完成与 Kafka、RocketMQ 等不同中间件之间的无缝集成？</li>\n</ul>\n<p>上述问题的考查点并不在于某一个消息中间件，而是站在通用性和统一性的角度来看问题，所以难度很大，需要候选人具备较强的抽象能力。而通过学习 Spring Cloud Stream 这种优秀的开源框架，可以帮助你构建这种抽象能力。</p>\n<p>接下来，让我们再对这些问题做进一步分析。</p>\n<h2 id="问题分析-16"><a href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-16" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题分析</h2>\n<p>想要回答这类面试题，首先我们需要对消息中间件本身有足够的了解，这是设计跨消息中间件的统一消息通信平台的前提。在本讲中，这部分内容我们不会做重点展开，需要你事先做一些学习。</p>\n<p>围绕统一消息平台的设计和实现，我们接下来要明确的是所采用的技术体系。目前，针对这个主题，我们可以参考和借鉴的框架并不多，而 Spring 家族中的 Spring Cloud Stream 是其中的代表。</p>\n<p>Spring Cloud Stream 对整个消息发布和消费过程做了高度抽象，并提供了一系列核心组件，包括 Binder、Channel、Source 和 Sink 等。</p>\n<p>最后，让我们基于具体框架来分析底层的实现原理。在 Spring Cloud Stream 中，真正完成与对不同消息中间件之间的集成的是 Binder 组件。而不同的消息中间件具有不同的 API，所以在 Binder 组件的设计和实现过程中，一方面需要考虑抽象，另一方面也需要针对不同中间件的特性来完成底层的交互过程。这部分内容是我们需要掌握的重点，值得深入进行学习，对于自身架构设计能力的提升有很大帮助。</p>\n<h2 id="技术体系-18"><a href="#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-18" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术体系</h2>\n<h3 id="spring-家族中的消息通信解决方案"><a href="#spring-%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E6%B6%88%E6%81%AF%E9%80%9A%E4%BF%A1%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Spring 家族中的消息通信解决方案</h3>\n<p>在 Spring 家族中，与消息通信机制相关的框架有三个，分别是 Spring Messaging、Spring Integration 和 Spring Cloud Steam。</p>\n<p>事实上，Spring Cloud 中的 Spring Cloud Stream 是基于 Spring Integration 实现了消息发布和消费机制并提供了一层封装，很多关于消息发布、消费的概念和实现方法本质上都是依赖于 Spring Integration。而在 Spring Integration 的背后，则依赖于 Spring Messaging 组件来实现消息处理机制的基础设施。</p>\n<p>这三个框架之间的依赖关系如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-21-14-16-14-1a63673ad172aaddb8f0e0ebc8b1b752-72b6c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 527px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 67.93168880455408%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAACmUlEQVQ4y3VT+VPaUBDmz7c/tnQ60gPBe0QIEM5wM1ZbCGgEBAFxdOQSvAhHwvV184hYa92Znd23u+97X3Y3htl8Dk1a7TY2wmHsp1Kwp1Pgshk4j4+Zb/t1BBfz08zXctpZs1r9ZjSCRqvJcAyz2Yw5pYsaPM0WTsnfkiQ4azU4KlV4bm7gJXVUKvDW67CVzmE/P4etWAJHd8pU77+9RaFS1gF1hk2NYTQKhyjC5HLhh9+PLxzH7DrFv3k8sAgC1iMRmNw8qRvWUIhYZrEVj6He1BnOCXCug84mE4wVhfntVgt9WV7GqQiz6ZSd77pdPD09Ml+rZ3mA4RjwjnTv7qCO1f/mVFVFU2f0LM+kDFNliqlKqkwwGdFLkznub++R+Z2B0leg5bU4q1OmSwANcKoz/vsrDUJWQFSKIp6PI0aaKCQQEANY49eQOEuyOMudxlj8SDpabAW1ZDQavQUsogjukoOjxsF9zSPQCcDT8NIEOYo7sV+1w0k2/BBGDnm48248dB4wUkbodDqvPpf1kK/SxAQTjC4jTAGybiPMMTM+cR+xsrmCz7wRq75VWJIWcCUOzkMn1KGK8WSMRqPxlmGXJtbr9SD3ZfTkHtNHmmB/IKPT7eDsrMDscDiAVjscDJZ9bLdb1EdtwgtAbaffnfLL9IBGvY1a7WoZ0/8FFAolXF5ev6pf7uHzC5pcXV0gmdxHNutDLhdCJuOFz2dGOs0jdypAkoIEFkE8votIZBsnJ0GkUjwODsIvDBeAizWQpJ+Q5RAGgyQyohXVip2YuFAq7kFMW5HP7xDgDopFGy5oeKp6QLdysFg//Au4YFgu5yCKeyjkefj933F4uIsA2UR8A7HYOtNg0Ayv9ysEwUy1dlSrtB2ebfwBCy3xmDWEztgAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 21 14 16 14" title="" data-src="/static/2024-11-21-14-16-14-1a63673ad172aaddb8f0e0ebc8b1b752-72b6c.png" data-srcset="/static/2024-11-21-14-16-14-1a63673ad172aaddb8f0e0ebc8b1b752-96efc.png 200w,\n/static/2024-11-21-14-16-14-1a63673ad172aaddb8f0e0ebc8b1b752-b717e.png 400w,\n/static/2024-11-21-14-16-14-1a63673ad172aaddb8f0e0ebc8b1b752-72b6c.png 527w" data-sizes="(max-width: 527px) 100vw, 527px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>从依赖关系上讲，Spring Messaging 是 Spring 家族中处理消息通信的底层框架。而 Spring Integration 在定位上属于一种企业服务总线，依赖于 Spring Messaging。因此，我们先来介绍 Spring Messaging。</p>\n<p>Spring Messaging 是 Spring 框架内置的一个模块，提供了最基本的消息通信 API，其中，消息这个概念由 Message 接口进行表示，包括一个消息头 Header 和一个消息体 Payload，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44082736596708920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface Message<T> {\n   T getPayload();\n   MessageHeaders getHeaders();\n}`, `44082736596708920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Message</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>\n   <span class="token class-name">T</span> <span class="token function">getPayload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token class-name">MessageHeaders</span> <span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>而消息通道 MessageChannel 的定义也比较简单，只包含了一个用来发送消息的 send 方法，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39996899636955870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface MessageChannel {\n   long INDEFINITE_TIMEOUT = -1;\n\n   default boolean send(Message<?> message) {\n      return send(message, INDEFINITE_TIMEOUT);\n   }\n\n   boolean send(Message<?> message, long timeout);\n}`, `39996899636955870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MessageChannel</span> <span class="token punctuation">{</span>\n   <span class="token keyword">long</span> INDEFINITE_TIMEOUT <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">default</span> <span class="token keyword">boolean</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">Message</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> INDEFINITE_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">boolean</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">Message</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> message<span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Spring Messaging 把通道抽象成两种基本的表现形式，即支持轮询的 PollableChannel 和实现发布-订阅模式的 SubscribableChannel，这两个通道都继承自具有消息发送功能的 MessageChannel，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96950221308390280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface PollableChannel extends MessageChannel {\n   Message<?> receive();\n   Message<?> receive(long timeout);\n}\n\npublic interface SubscribableChannel extends MessageChannel {\n   boolean subscribe(MessageHandler handler);\n   boolean unsubscribe(MessageHandler handler);\n}`, `96950221308390280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PollableChannel</span> <span class="token keyword">extends</span> <span class="token class-name">MessageChannel</span> <span class="token punctuation">{</span>\n   <span class="token class-name">Message</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token class-name">Message</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">receive</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SubscribableChannel</span> <span class="token keyword">extends</span> <span class="token class-name">MessageChannel</span> <span class="token punctuation">{</span>\n   <span class="token keyword">boolean</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">MessageHandler</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">boolean</span> <span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token class-name">MessageHandler</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意到对于 PollableChannel 而言才有 receive 的概念，代表通过轮询操作主动获取消息的过程。而 SubscribableChannel 则是通过注册回调函数 MessageHandler 来实现事件响应。MessageHandler 接口定义如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33330680870555040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface MessageHandler {\n   void handleMessage(Message<?> message) throws MessagingException;\n}`, `33330680870555040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MessageHandler</span> <span class="token punctuation">{</span>\n   <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MessagingException</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>在 Spring 家族中，Spring Integration 是对 Spring Messaging 的扩展，提供了对《企业集成模式：设计、构建及部署消息通信解决方案》一书中各种企业集成模式的支持，通常被认为是一种 ESB（Enterprise Service Bus，企业服务总线）框架。而 Spring Cloud Stream 则是 Spring Integration 的一种增强。</p>\n<p>我们先来看一下 Spring Cloud Stream 中与 Spring Integration 相关的内容。</p>\n<p>在 Spring Cloud Stream 中，存在一组 Source 和 Sink 接口，其中 Source 接口的定义如下所示。注意到这里通过 Spring Messaging 提供的 MessageChannel 来对外发送消息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52411699611866140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface Source {\n   String OUTPUT = &quot;output&quot;;\n\n   @Output(Source.OUTPUT)\n   MessageChannel output();\n}`, `52411699611866140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Source</span> <span class="token punctuation">{</span>\n   <span class="token class-name">String</span> OUTPUT <span class="token operator">=</span> <span class="token string">"output"</span><span class="token punctuation">;</span>\n\n   <span class="token annotation punctuation">@Output</span><span class="token punctuation">(</span><span class="token class-name">Source</span><span class="token punctuation">.</span>OUTPUT<span class="token punctuation">)</span>\n   <span class="token class-name">MessageChannel</span> <span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>类似的，Sink 接口定义如下所示，通过 Spring Messaging 中的 SubscribableChannel 实现对来自外部消息的接收。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92912557888659180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface Sink {\n   String INPUT = &quot;input&quot;;\n\n   @Input(Source.INPUT)\n   SubscribableChannel input();\n}`, `92912557888659180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Sink</span> <span class="token punctuation">{</span>\n   <span class="token class-name">String</span> INPUT <span class="token operator">=</span> <span class="token string">"input"</span><span class="token punctuation">;</span>\n\n   <span class="token annotation punctuation">@Input</span><span class="token punctuation">(</span><span class="token class-name">Source</span><span class="token punctuation">.</span>INPUT<span class="token punctuation">)</span>\n   <span class="token class-name">SubscribableChannel</span> <span class="token function">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="spring-cloud-stream-基本架构"><a href="#spring-cloud-stream-%E5%9F%BA%E6%9C%AC%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Spring Cloud Stream 基本架构</h3>\n<p>Spring Cloud Stream 对整个消息发布和消费过程做了高度抽象，并提供了一系列核心组件。我们先来介绍基于 Spring Cloud Stream 构建消息通信机制的基本工作流程。</p>\n<p>区别于直接使用 RabbitMQ、Kafka 等消息中间件，Spring Cloud Stream 在消息生产者和消费者之间添加了一种桥梁机制，所有的消息都将通过 Spring Cloud Stream 进行发送和接收，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-21-14-18-12-fc0883fec43962211685fe7138f34f04-0e173.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 646px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 45.6656346749226%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAAB9UlEQVQoz22Re1PaUBDF8/0/Qf/qdJTaKRgML+toVQj4CCGBRELCOyAveUhrH1op+fUSW+tMuzM7d++9e86e3ZWWywWuq+A4MTQtQqu9R72RZbVas7EgCP518d5oqnhelGIxglPbxfUUZvMJ0urhkenYY3ht02kaLGYei5seIeo34bMFf++LaZ/5jYtlZhn0LBE3uP/6HcnsmVRGFoZvknfyWKMrSgMDf+o/E/zxdfCkevOnX5eoDG0umheY12XMQYXyqIy0W41x1ZbRy9t8VF9Rb+5S6EQ59y8JHl+oe2GXguzE26HViZPXXuM0YtiNKEfTA6QPnX3OXJmCHUW136NVZbLdBKaotiH8sXoUvgr9/uEhJLQmNkcNOczNC5zmxik4QshdHilVT9K/PcEfHVJtJRjPTrBmhxhDk+X8E2/UHBG9xLZW5K2uM57MqAhCfZgOc6vtJO3hAb35MeryFGm/laFQi6GW33GobXEuVB634uj9EtPRFMvv4k4muOMxznDAl7tvXLQ1EsYWl1eiTYFRyzvkRax+ziElvQT1fga7JnOmR+j4GbR+kqIg5Od/RygWYlJoyrS76RDj1PeodZLkboVCpaaQ6qVJdVOk/c2ZRvEVjL4RznCz2XW44YDV+qmC0TOQRRdpUTwjxGzwSkshu8zxC/+5f2ng38J4AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 21 14 18 12" title="" data-src="/static/2024-11-21-14-18-12-fc0883fec43962211685fe7138f34f04-0e173.png" data-srcset="/static/2024-11-21-14-18-12-fc0883fec43962211685fe7138f34f04-2fb9f.png 200w,\n/static/2024-11-21-14-18-12-fc0883fec43962211685fe7138f34f04-f1e72.png 400w,\n/static/2024-11-21-14-18-12-fc0883fec43962211685fe7138f34f04-0e173.png 646w" data-sizes="(max-width: 646px) 100vw, 646px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在上图中，我们不难看出 Spring Cloud Stream 具备四个核心组件，分别是 Binder、Channel、Source 和 Sink，其中 Binder 和 Channel 成对出现，而 Source 和 Sink 分别面向消息的发布者和消费者。</p>\n<ul>\n<li>\n<p>Source 和 Sink</p>\n<p>在 Spring Cloud Stream 中，Source 组件是真正生成消息的组件，相当于是一个输出（Output）组件。而 Sink 则是真正消费消息的组件，相当于是一个输入（Input）组件。根据我们对事件驱动架构的了解，对于同一个 Source 组件而言，不同的服务可能会实现不同的 Sink 组件，分别根据自身需求进行业务上的处理。</p>\n</li>\n<li>\n<p>Channel</p>\n<p>Channel 的概念比较容易理解，就是常见的通道，这里不再展开。</p>\n</li>\n<li>\n<p>Binder</p>\n<p>Spring Cloud Stream 中最重要的概念就是 Binder。所谓 Binder，顾名思义就是一种黏合剂，将业务服务与消息通信系统黏合在一起。通过 Binder，我们可以很方便地连接消息中间件，可以动态地改变消息的目标地址、发送方式，而不需要了解各种消息中间件在实现上的差异。</p>\n</li>\n</ul>\n<p>关于 Binder 是如何与不同的消息中间件进行整合的实现原理，我们在接下来的内容中进行详细展开。</p>\n<h2 id="源码解析-16"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-16" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h2>\n<h3 id="spring-cloud-stream-中的-binder"><a href="#spring-cloud-stream-%E4%B8%AD%E7%9A%84-binder" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Spring Cloud Stream 中的 Binder</h3>\n<p>基于 Spring Cloud Stream，我们知道在发送和接收消息时，需要使用 @EnableBinding 注解。我们可以在 @EnableBinding 注解中指定一个 Source 或 Sink 接口。</p>\n<p>在 Spring Cloud Stream 中，BindableProxyFactory 是一个用于初始化由 @EnableBinding 注解所提供接口的工厂类，该类的定义如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2852936308552478000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class BindableProxyFactory implements MethodInterceptor, FactoryBean<Object>, Bindable, InitializingBean`, `2852936308552478000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BindableProxyFactory</span> <span class="token keyword">implements</span> <span class="token class-name">MethodInterceptor</span><span class="token punctuation">,</span> <span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">Bindable</span><span class="token punctuation">,</span> <span class="token class-name">InitializingBean</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>注意到 BindableProxyFactory 同时实现了 MethodInterceptor 接口和 Bindable 接口。其中，前者是 AOP 中的方法拦截器，而后者是一个标明能够绑定 Input 和 Output 的接口，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-21-14-19-48-3eabbef76133444d81dc72a86b93d92c-42472.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 468px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 46.794871794871796%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABq0lEQVQoz31Si07CQBDs//+ABo0aSYxGDRSM+EAqApVaKC9ReZSXlkqlVNRiQOm4d0aJEd1kspfr7ezMdoWUvIt2+wT5fAjZbICjVAyj0Tii8z5Go1ew8DyPg8Vw+ARVFVEoiPy9pgVRKoWIYx/C1ZWIB+sY5cttKIofWnYDlZsARm4ChhHH84v7i7DftwlnaDZEyKk1JBMrMM0INUpDiEaXETtZhCyv4lxeg3rh5zl9vopcLgjXHc0lbLUOUansIJlcwankg14PkNNjCIqyC9tOkpoYul2Jo9OJ0scDbsGdY/nxcYhUaou/MwyJcIpbOpfLhxBsewDLeiDbfZ5Z97s7g6xrcJwBoyKi6TdYjMdjUp9H1zB5Te/eQq9nYTBwIOCfeHtjZD/vJpMpEb7/WSN8WWGYTj8VOI6NaiWDhp6jOamo1zW0WwXKWVSrKprNHI3khjdjqlndpwOPEeJ7Rl+EptmiP+dDPO5DIrEESVqg9Vjn50zGDyW9hGLxAO9c6Gy2XOFM7Iyw09Fptzah63u0QkFSukfKRNSqIdRqYVxfb1ODCNhzDzOHDB+vUZJ8yu44DAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 21 14 19 48" title="" data-src="/static/2024-11-21-14-19-48-3eabbef76133444d81dc72a86b93d92c-42472.png" data-srcset="/static/2024-11-21-14-19-48-3eabbef76133444d81dc72a86b93d92c-4d5a2.png 200w,\n/static/2024-11-21-14-19-48-3eabbef76133444d81dc72a86b93d92c-65125.png 400w,\n/static/2024-11-21-14-19-48-3eabbef76133444d81dc72a86b93d92c-42472.png 468w" data-sizes="(max-width: 468px) 100vw, 468px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>我们先来看 MethodInterceptor 接口中用于实现拦截的 invoke 方法，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88217022036043270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Override\npublic synchronized Object invoke(MethodInvocation invocation) throws Throwable {\n   Method method = invocation.getMethod();\n\n   // 从缓存中获取目标对象\n   Object boundTarget = targetCache.get(method);\n   if (boundTarget != null) {\n      return boundTarget;\n   }\n\n   // 获取 Input 接口\n   Input input = AnnotationUtils.findAnnotation(method, Input.class);\n   if (input != null) {\n      String name = BindingBeanDefinitionRegistryUtils.getBindingTargetName(input, method);\n      boundTarget = this.inputHolders.get(name).getBoundTarget();\n      targetCache.put(method, boundTarget);\n      return boundTarget;\n   }\n   // 获取 Output 接口，和获取 Input 接口实现方式类似\n   else {\n      // ...\n   }\n   return null;\n}`, `88217022036043270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">MethodInvocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>\n   <span class="token class-name">Method</span> method <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token comment">// 从缓存中获取目标对象</span>\n   <span class="token class-name">Object</span> boundTarget <span class="token operator">=</span> targetCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>boundTarget <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> boundTarget<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token comment">// 获取 Input 接口</span>\n   <span class="token class-name">Input</span> input <span class="token operator">=</span> <span class="token class-name">AnnotationUtils</span><span class="token punctuation">.</span><span class="token function">findAnnotation</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token class-name">Input</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token class-name">BindingBeanDefinitionRegistryUtils</span><span class="token punctuation">.</span><span class="token function">getBindingTargetName</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      boundTarget <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>inputHolders<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBoundTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      targetCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> boundTarget<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> boundTarget<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token comment">// 获取 Output 接口，和获取 Input 接口实现方式类似</span>\n   <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// ...</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里的逻辑比较简单，可以看到 BindableProxyFactory 保存了一个缓存对象 targetCache，如果所调用方法已经存在于缓存中，则直接返回目标对象。反之，会根据 @Input 和 @Output 注解从 inputHolders 和 outputHolders 中获取对应的目标对象并放入缓存中。至于这里提到的这个目标对象，暂时可以把它理解为就是一种 MessageChannel 对象。</p>\n<p>然后我们来看 Bindable 接口，该接口提供了对 Input 和 Output 的绑定和解绑操作，而这些操作是通过 Binder 接口来完成的。Binder 接口分别提供了绑定生产者和消费者的方法，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14519455211604759000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface Binder<T, C extends ConsumerProperties, P extends ProducerProperties> {\n   // 绑定生产者\n   Binding<T> bindProducer(String name, T outboundBindTarget, P producerProperties);\n\n   // 绑定消费者\n   Binding<T> bindConsumer(String name, String group, T inboundBindTarget, C consumerProperties);\n}`, `14519455211604759000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Binder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">C</span> <span class="token keyword">extends</span> <span class="token class-name">ConsumerProperties</span><span class="token punctuation">,</span> <span class="token class-name">P</span> <span class="token keyword">extends</span> <span class="token class-name">ProducerProperties</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>\n   <span class="token comment">// 绑定生产者</span>\n   <span class="token class-name">Binding</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">bindProducer</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">T</span> outboundBindTarget<span class="token punctuation">,</span> <span class="token class-name">P</span> producerProperties<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token comment">// 绑定消费者</span>\n   <span class="token class-name">Binding</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">bindConsumer</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> group<span class="token punctuation">,</span> <span class="token class-name">T</span> inboundBindTarget<span class="token punctuation">,</span> <span class="token class-name">C</span> consumerProperties<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 Spring Cloud Stream 中，Binder 接口的类层关系如下所示，注意到这里还展示了 RabbitMessageChannelBinder 类，这个类在接下来讲到 Spring Cloud Stream 与 RabbitMQ 的集成过程时会具体展开。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-21-14-20-30-b0af608facbad238082da8d8bd1e40a2-115a3.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 13.48314606741573%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsSAAALEgHS3X78AAAAkklEQVQI1x2MSQ7CMBRDe/+LZS6opD9zGghVM6x6A77wxk+25UWt6/p8MEqVkijGOOeCUiIEF1IhSIkkMCSEIOxaCyEYYzheALQxZgddz5qPbK1x3oXoY4rGGh/c+10AwDqUDTFgtb22fKQx2nLO03sHxsCu7b/Go5TSfd+ttz5a62hXn721a85Rv7WUUusn5/QD62qXyEmnXz4AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 21 14 20 30" title="" data-src="/static/2024-11-21-14-20-30-b0af608facbad238082da8d8bd1e40a2-fee1c.png" data-srcset="/static/2024-11-21-14-20-30-b0af608facbad238082da8d8bd1e40a2-a67b7.png 200w,\n/static/2024-11-21-14-20-30-b0af608facbad238082da8d8bd1e40a2-0b187.png 400w,\n/static/2024-11-21-14-20-30-b0af608facbad238082da8d8bd1e40a2-fee1c.png 800w,\n/static/2024-11-21-14-20-30-b0af608facbad238082da8d8bd1e40a2-115a3.png 801w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>针对 Binder 接口的实现过程，Spring Cloud Stream 首先提供了一个 AbstractBinder，这是一个抽象类。AbstractBinder 的子类是 AbstractMessageChannelBinder，它同样也是一个抽象类。我们来看它的 doBindProducer 方法，并对该方法中的核心语句进行提取和整理，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46458741277148774000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Override\npublic final Binding<MessageChannel> doBindProducer(final String destination, MessageChannel outputChannel, final P producerProperties) throws BinderException {\n   // …\n   // 发送到 outputChannel 通道的消息会被 SendingHandler 进行处理\n   ((SubscribableChannel) outputChannel).subscribe( new SendingHandler(producerMessageHandler, ...);\n\n   // 基于 outputChannel 构建 Binding\n   Binding<MessageChannel> binding = new DefaultBinding<MessageChannel>(destination, null, outputChannel, producerMessageHandler instanceof Lifecycle ? (Lifecycle) producerMessageHandler : null) {\n      // …\n   };\n\n   return binding;\n}`, `46458741277148774000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Binding</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageChannel</span><span class="token punctuation">></span></span> <span class="token function">doBindProducer</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> destination<span class="token punctuation">,</span> <span class="token class-name">MessageChannel</span> outputChannel<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">P</span> producerProperties<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BinderException</span> <span class="token punctuation">{</span>\n   <span class="token comment">// …</span>\n   <span class="token comment">// 发送到 outputChannel 通道的消息会被 SendingHandler 进行处理</span>\n   <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SubscribableChannel</span><span class="token punctuation">)</span> outputChannel<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token class-name">SendingHandler</span><span class="token punctuation">(</span>producerMessageHandler<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token comment">// 基于 outputChannel 构建 Binding</span>\n   <span class="token class-name">Binding</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageChannel</span><span class="token punctuation">></span></span> binding <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultBinding</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageChannel</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>destination<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> outputChannel<span class="token punctuation">,</span> producerMessageHandler <span class="token keyword">instanceof</span> <span class="token class-name">Lifecycle</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token class-name">Lifecycle</span><span class="token punctuation">)</span> producerMessageHandler <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// …</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">return</span> binding<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上述代码的核心逻辑在于，通过 Source 发送的消息会被 outputChannel 这个通道传递出去，而负责处理这些消息的是 SendingHandler，它是一个 Spring Messaging 模块中的 MessageHandler。</p>\n<p>这里要注意的是，SendingHandler 会使用 Spring Messaging 组件中的 Message 消息对象，而 Spring Cloud Stream 会把这个 Message 消息对象转换成对应中间件的消息数据格式并进行发送。</p>\n<p>下面转到消息消费的场景。针对消息消费，我们可以使用 @StreamListener 注解。如果在一个方法上添加了 @StreamListener 注解，那么这个方法就可以用来接收消息，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81623894042064540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@StreamListener(&quot;input&quot;)\npublic void handleMessage(MyMessage myMessage)`, `81623894042064540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@StreamListener</span><span class="token punctuation">(</span><span class="token string">"input"</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">MyMessage</span> myMessage<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>基于 @StreamListener 注解，在 Spring Cloud Stream 中存在一个 StreamListenerMessageHandler 类，用于订阅 inputChannel 消息通道中传入的消息并进行消费。</p>\n<p>作为总结，我们可以用如下所示的流程图来概括整个消息发送和消费流程：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-21-14-21-49-6cee773fc528711e5659a0000db69108-f1382.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 533px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 93.05816135084427%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsSAAALEgHS3X78AAADL0lEQVQ4y42U+VPbVhSF+f+nIbQ/tZMQmras05mOSWxsgvEqjxcwliyDVyEvWm0HgyGQMfLXJ9FSKNDmzZy570pPZ86971wthKsRYkaMteIa66X1IG6WN9k43AiwWlwlrIWJGlFSjRTezMNf8/n8WSwoAwVlrCA1JRLVBCk1RbgoCA6ixOU4+/I+R9ZRcKZhNZh783vC59bC1fSKsTtmcnbO9GLKzc0NpmEyHA7p6l1cx2XyecLIGXH95fo/1QUKQ9UQsWGMXXeXreMtfkr+yJv0mwBvs2+JGBGiVpSIE2Gvvsfs6wzxKZ7n4f1F8lDxQttsUbfrNJ0GtX4NWZOp6SqH9RLqqYw+7ghoaOM29pn5bJkPy1947oAtSjzpmaQPFFqGS7Pv0Bw4NAY2Vb1HpX2K2u2jW1ag9JFCb+5L97j1boMHlusQtV0ynQJ1fRepEqKgfiCvfgz2pVoEzUySa2WI2w6j8fgxIcHmn16Yto0kmp8zTihrabalbbazIdbCvxBK/0GsuIPcy5HrVshNL3Fc91+EPG6q6ThkLq/I+v3sZlEGBQqtFMmjMLmT/SCXdQlJLyOdX+AOnxA+bqwlCFMXl5TMKsZZSVzIAeVmnGJth9JJLMgHZwccDspkJ+f/T+iXnPUVitvPtXLsqWnSDYlQJkTyOEOiliGv5cn0akgX36DQLzl9+YWSXqDd/kAi8yv76fcks6ukpd/I5tfpD3Y5aCUF4fTbCOOjIZmbr/zebLIqy6xWZDZUlc3aMSuFAtvdHqnra+KOfU94Z3TvKeFsNqNhDITRbWH0HqquU+8NaPRN4UULVdNROqd03BG67T6d5Zccf7+EP41x/w6f+4yuHKotmYZ+jH1uojnaHeyOgPZUoR/9Gf3b6J1+h6gjZn34iZX8Csu5ZYF3QfTz9/mf2aptkThP8MnZfX70eDD0t7e3uCMXdzwUDrAYiHZYjkVFrtBsN1FrKrZrMxTvnaHzAuEDxZPpBNVSqfQrKKZCVfhTMRSKnSLlXpmSVgreyYbMyaj+MqF/Y/7SDZ3l/DsWw695HVliaWeJxY+LvPogIOJ326+C/PvYD2yK39+f3HVuYyEfJ68AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 21 14 21 49" title="" data-src="/static/2024-11-21-14-21-49-6cee773fc528711e5659a0000db69108-f1382.png" data-srcset="/static/2024-11-21-14-21-49-6cee773fc528711e5659a0000db69108-7cec2.png 200w,\n/static/2024-11-21-14-21-49-6cee773fc528711e5659a0000db69108-dfa51.png 400w,\n/static/2024-11-21-14-21-49-6cee773fc528711e5659a0000db69108-f1382.png 533w" data-sizes="(max-width: 533px) 100vw, 533px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>到目前为止，Spring Cloud Stream 通过 Binder 组件分别完成了对 RabbitMQ 以及 Kafka 的集成。在接下来的内容中，我们将以 RabbitMQ 为例，给出 Spring Cloud Stream 集成 RabbitMQ 的实现过程。</p>\n<h3 id="spring-cloud-stream-集成-rabbitmq"><a href="#spring-cloud-stream-%E9%9B%86%E6%88%90-rabbitmq" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Spring Cloud Stream 集成 RabbitMQ</h3>\n<p>Spring Cloud Stream 团队提供了 spring-cloud-stream-binder-rabbit 作为与 RabbitMQ 集成的代码工程。这个代码工程只有四个类，我们需要重点关注的就是实现了 AbstractMessageChannelBinder 中几个抽象方法的 RabbitMessageChannelBinder 类。</p>\n<p>首先我们找到 RabbitMessageChannelBinder 中的 createProducerMessageHandler 方法，我们知道该方法用于完成消息的发送。我们在 createProducerMessageHandler 中找到了以下核心代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26942007964104440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`final AmqpOutboundEndpoint endpoint = new AmqpOutboundEndpoint(buildRabbitTemplate(producerProperties.getExtension(), errorChannel != null));\nendpoint.setExchangeName(producerDestination.getName());`, `26942007964104440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">final</span> <span class="token class-name">AmqpOutboundEndpoint</span> endpoint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AmqpOutboundEndpoint</span><span class="token punctuation">(</span><span class="token function">buildRabbitTemplate</span><span class="token punctuation">(</span>producerProperties<span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> errorChannel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nendpoint<span class="token punctuation">.</span><span class="token function">setExchangeName</span><span class="token punctuation">(</span>producerDestination<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>首先，在 buildRabbitTemplate 方法中，我们看到了 RabbitTemplate 的构建过程。RabbitTemplate 是 Spring Amqp 组件提供的专门用于封装与 RabbitMQ 底层交互 API 的模板类。在构建 RabbitTemplate 的整个过程中，涉及到设置与 RabbitMQ 相关的 ConnectionFactory 等众多参数。</p>\n<p>然后，我们发现 RabbitMessageChannelBinder 也是直接集成了 Spring 中用于整合 AQMP 协议的 AmqpOutboundEndpoint，该类来自于 Spring Integration 框架，并提供了如下所示的 send 方法进行消息的发送：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64807836108382360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`private void send(String exchangeName, String routingKey, final Message<?> requestMessage, CorrelationData correlationData) {\n   if (this.amqpTemplate instanceof RabbitTemplate) {\n      // 实现消息格式的转换\n      MessageConverter converter = ((RabbitTemplate) this.amqpTemplate).getMessageConverter();\n      org.springframework.amqp.core.Message amqpMessage = MappingUtils.mapMessage(...);\n      // ...\n      // 实现消息发送\n      ((RabbitTemplate) this.amqpTemplate).send(exchangeName, routingKey, amqpMessage, correlationData);\n   }\n   else {\n      // 实现消息转换和发送\n      this.amqpTemplate.convertAndSend(exchangeName, routingKey, requestMessage.getPayload(), message -> {\n         getHeaderMapper().fromHeadersToRequest(requestMessage.getHeaders(), message.getMessageProperties());\n         return message;\n      });\n   }\n}`, `64807836108382360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">String</span> exchangeName<span class="token punctuation">,</span> <span class="token class-name">String</span> routingKey<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Message</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> requestMessage<span class="token punctuation">,</span> <span class="token class-name">CorrelationData</span> correlationData<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>amqpTemplate <span class="token keyword">instanceof</span> <span class="token class-name">RabbitTemplate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 实现消息格式的转换</span>\n      <span class="token class-name">MessageConverter</span> converter <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RabbitTemplate</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>amqpTemplate<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span><span class="token class-name">Message</span> amqpMessage <span class="token operator">=</span> <span class="token class-name">MappingUtils</span><span class="token punctuation">.</span><span class="token function">mapMessage</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// ...</span>\n      <span class="token comment">// 实现消息发送</span>\n      <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RabbitTemplate</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>amqpTemplate<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">,</span> routingKey<span class="token punctuation">,</span> amqpMessage<span class="token punctuation">,</span> correlationData<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 实现消息转换和发送</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>amqpTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">,</span> routingKey<span class="token punctuation">,</span> requestMessage<span class="token punctuation">.</span><span class="token function">getPayload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> message <span class="token operator">-></span> <span class="token punctuation">{</span>\n         <span class="token function">getHeaderMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fromHeadersToRequest</span><span class="token punctuation">(</span>requestMessage<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">return</span> message<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到这里依赖于 Spring Amqp 提供的 AmqpTemplate 接口实现消息发送，而 RabbitTemplate 是 AmqpTemplate 的一个实现类。同时，我们还注意到这里通过 MessageConverter 工具类完成了从 org.springframework.messaging.Message 到 org.springframework.amqp.core.Message 这两个消息数据结构之间的转换。</p>\n<p>介绍完消息发送，接下来我们来看消息的消费。</p>\n<p>RabbitMessageChannelBinder 中与消息消费相关的是 createConsumerEndpoint 方法。类似的，这个方法中也大量使用了 Spring Amqp 和 Spring Integration 中的工具类。该方法最终返回的是一个 AmqpInboundChannelAdapter 对象。在 Spring Integration 中，AmqpInboundChannelAdapter 是一种 InboundChannelAdapter，代表面向输入的通道适配器，提供了消息监听功能，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89920622476787650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`protected class Listener implements ChannelAwareMessageListener, RetryListener {\n   @Override\n   public void onMessage(final Message message, final Channel channel) throws Exception {\n      // 省略相关实现\n   }\n}`, `89920622476787650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">class</span> <span class="token class-name">Listener</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelAwareMessageListener</span><span class="token punctuation">,</span> <span class="token class-name">RetryListener</span> <span class="token punctuation">{</span>\n   <span class="token annotation punctuation">@Override</span>\n   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 省略相关实现</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在这个 onMessage 方法内部，最关键的是用于创建消息的 createMessage 方法，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5096872917921580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`private org.springframework.messaging.Message<Object> createMessage(Message message, Channel channel) {\n   // 创建消息体\n   Object payload = AmqpInboundChannelAdapter.this.messageConverter.fromMessage(message);\n   // 创建消息头\n   Map<String, Object> headers = AmqpInboundChannelAdapter.this.headerMapper.toHeadersFromRequest(message.getMessageProperties());\n   // ...\n   // 创建消息\n   final org.springframework.messaging.Message<Object> messagingMessage = getMessageBuilderFactory()\n      .withPayload(payload)\n      .copyHeaders(headers)\n      .build();\n   return messagingMessage;\n}`, `5096872917921580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">private</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>messaging<span class="token punctuation">.</span><span class="token class-name">Message</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token function">createMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 创建消息体</span>\n   <span class="token class-name">Object</span> payload <span class="token operator">=</span> <span class="token class-name">AmqpInboundChannelAdapter</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageConverter<span class="token punctuation">.</span><span class="token function">fromMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 创建消息头</span>\n   <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> headers <span class="token operator">=</span> <span class="token class-name">AmqpInboundChannelAdapter</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>headerMapper<span class="token punctuation">.</span><span class="token function">toHeadersFromRequest</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// ...</span>\n   <span class="token comment">// 创建消息</span>\n   <span class="token keyword">final</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>messaging<span class="token punctuation">.</span><span class="token class-name">Message</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> messagingMessage <span class="token operator">=</span> <span class="token function">getMessageBuilderFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">copyHeaders</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> messagingMessage<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>显然，在这个 createMessage 方法中，我们完成了消息数据格式从 org.springframework.amqp.core.Message 到 org.springframework.messaging.Message 的反向转换。</p>\n<h2 id="解题要点-18"><a href="#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-18" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解题要点</h2>\n<p>针对 Spring 框架，关于消息通信机制也是一个非常好的面试考查点，因为 Spring 框架对消息发送和接收过程进行了抽象，这种抽象很有参考价值。虽然这类面试题中规中矩，但回答起来也有一定的难度，原因在于在 Spring 框架中，关于消息通信机制的实现组件并不是只有一个，所有想要完整阐述其对消息发送和接收的抽象过程需要比较广的知识体系。</p>\n<p>可以说针对类似这样的出题方式，要求面试者对主流开源框架有较高的理解程度。在 Spring 框架中，关于消息通信的实现组件和框架主要有三个，即位于 Spring 内核中的 Spring Messaging 组件，以及独立的 Spring Integration 和 Spring Cloud Stream 框架。</p>\n<p>其中，Spring Messaging 是 Spring 家族中处理消息通信的底层框架。而 Spring Integration 在定位上属于一种企业服务总线，依赖于 Spring Messaging。Spring Cloud Stream 是 Spring Integration 的一种增强，同时与 Spring Boot 体系进行了融合。</p>\n<p>从设计抽象角度讲，Spring Messaging 组件提供了用于消息通信最基本的消息（Message）、消息通道（MessageChannel）等概念的定义，Spring Integration 框架则在此基础上给出了一套完整的 ESB 解决方案。而本讲重点阐述的 Spring Cloud Stream 框架在定位上则是一种平台，完成了与各个消息中间件的无缝集成。</p>\n<p>关于如何构建一个统一化的消息通信平台，Spring Cloud Stream 是我们值得深入分析和研究的一个框架。对于消息通信而言，我们需要分别实现消息的发布者和消费者。在 Spring Cloud Stream 中分别是 Source 和 Sink 组件。而消息的传递显然应该用到通道，所以 Spring Cloud Stream 也包含了 Channel 组件。最后，作为 Spring Cloud Stream 框架在设计上的一大特色，Binder 组件专门用于屏蔽与各种消息中间件之间的技术差异，为开发者提供统一的 API。</p>\n<p>这样，我们就把 Spring Cloud Stream 中的四个核心组件都梳理了一遍，分别是 Binder、Channel、Source 和 Sink。在回答这类问题时，可以围绕 Spring Cloud Stream 的基本架构把这些组件都介绍到，并重点对 Binder 组件做细化阐述。</p>\n<h2 id="小结与预告-16"><a href="#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-16" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结与预告</h2>\n<p>本讲讨论了分布式系统中与消息通信相关的话题，但我们的切入点并不是消息通信本身，而是关注如何构建一个跨消息中间件的统一消息通信平台。与前面几讲的行文思路不同，我们在引入 Spring Cloud Stream 时并不是直接介绍它的实现原理，而是从 Spring 家族中所具备的各种消息通信组件和框架开始，引出 Spring Cloud Stream 的基本架构。然后，作为一款平台型的开源框架，我们重点对 Spring Cloud Stream 如何与各个消息中间件之间实现整合的过程做了源码级的深入分析。</p>\n<p>从下一讲开始，我们将进入到一个新的模块的讲解，这个模块包含了一组通用型的技术组件。我们要引入的第一个通用型技术组件是动态代理。那么，动态代理在分布式服务中起到什么作用？这就是下一讲要展开的内容。</p>\n<h1 id="动态代理：动态代理在分布式服务中起到什么作用？"><a href="#%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%EF%BC%9A%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E5%9C%A8%E5%88%86%E5%B8%83%E5%BC%8F%E6%9C%8D%E5%8A%A1%E4%B8%AD%E8%B5%B7%E5%88%B0%E4%BB%80%E4%B9%88%E4%BD%9C%E7%94%A8%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>动态代理：动态代理在分布式服务中起到什么作用？</h1>\n<p>在上一讲中，我们介绍了消息通信这个在分布式系统构建过程中非常常用的技术组件，这也是我们针对分布式系统讨论的最后一个专用技术组件。</p>\n<p>从本讲开始，我们将进入到另一类技术组件的讲解，这类技术组件并不局限于只能用于分布式系统的构建过程，而是具有更大的通用性和灵活性。首先，我们要引入的是动态代理机制。</p>\n<p>在系统设计过程中，对象之间相互依赖会造成耦合度过高，我们需要引入一个中间类来消除或缓解在直接访问目标对象时所带来的问题。但是对于发起访问的对象而言，通常希望这个中间类的存在是无感知的，这时候我们就可以引入动态代理机制。</p>\n<p>那么，问题就来了，作为一种通用型的技术组件，动态代理在分布式系统构建过程中起到什么作用呢？本讲内容将和你一起探讨这个话题。</p>\n<h2 id="问题背景-16"><a href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-16" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题背景</h2>\n<p>在系统设计领域，代理（Proxy）是一种常见的技术组件，主要目的就是在访问目标对象之前添加一层代理对象，用于消除或缓解在直接访问目标对象时带来的问题。</p>\n<p>而在现实应用中，代理机制也非常常见，可以说处处是代理。举一个简单的场景，假设我们需要在服务层组件中调用数据访问层组件，并记录一个操作日志。通常，服务层组件有很多方法，而对所有方法操作都需要添加日志。显然，在每个方法中手工调用同一个日志方法不是一种很好的解决方案，会造成代码冗余，增加维护成本。这个时候，代理机制就可以派上用场了。</p>\n<p>我们可以构建一个代理对象，然后由这个代理对象统一实现日志记录操作，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-27-11-45-02-af2cc31482492df573c88973b5ef5ab4-6dd13.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 459px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 20.697167755991284%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAA/UlEQVQY0x2Q/U6DMBTFef9H0BhdTIx/kAVtUJMhCjLCIJuwMLpZSjflQ1kwcS9wvPQmTW/7u+fc2xplWaBpSloCquI4nf4wRtd9YbmcIksZFpEJXjxik9tQSmg+1inF0bYSdS20x+EgYPjeNbyXC8yDCZL4hqDSAs4zKMnwuX9C4F9RbuPYu3S/1jzPVwhJ4zrnePMu4T6fYZ2x0XCCvWI0HaNpbiHlVguyLEaRm+gaB7+Dh6518LG7043GCMNXbLkJsbNQinvI0sL7agojTX0yS1DJBMVmjmE4akHf11T4QE0s4jPiMzKw6QWV5t8/LZ0DYjGZRbQv6Fsi/ANYxhgInYNHxAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 27 11 45 02" title="" data-src="/static/2024-11-27-11-45-02-af2cc31482492df573c88973b5ef5ab4-6dd13.png" data-srcset="/static/2024-11-27-11-45-02-af2cc31482492df573c88973b5ef5ab4-fad05.png 200w,\n/static/2024-11-27-11-45-02-af2cc31482492df573c88973b5ef5ab4-a671c.png 400w,\n/static/2024-11-27-11-45-02-af2cc31482492df573c88973b5ef5ab4-6dd13.png 459w" data-sizes="(max-width: 459px) 100vw, 459px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可以看到，通过代理机制，一个对象就可以在承接另一个对象功能的基础之上，同时添加新的功能。相比直接在原有对象中嵌入代码，代理机制为我们提供了更为优雅的解决方案。</p>\n<p>可能你看了前面这段描述之后，会觉得代理机制很简单，但事实并非如此，你可以先来看一下下面这些现实中的面试题：</p>\n<ul>\n<li>静态代理和动态代理的本质区别是什么？</li>\n<li>你了解的动态代理实现技术有哪些？</li>\n<li>你知道哪些场景中用到了动态代理机制吗？</li>\n<li>JDK 自带的动态代理机制组成结构是怎么样的？</li>\n<li>Dubbo 中的远程调用本地化机制背后使用的是什么技术？</li>\n<li>为什么 MyBatis 中的 Mapper 接口没有实现类但却能提供 SQL 执行功能？</li>\n<li>如果让你实现类似动态代理的执行效果，你有什么思路？</li>\n</ul>\n<p>事实上，代理机制背后的应用场景以及实现原理是面试过程中非常高频的一类面试题，可以考查的范围非常广，对候选人的要求也很高。</p>\n<h2 id="问题分析-17"><a href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-17" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题分析</h2>\n<p>在分布式系统构建过程中，动态代理是一种非常通用的实现机制，被广泛应用于 Dubbo 和 MyBatis 等各种开源框架中。面试过程中，面试官也通常会基于这些框架来考查候选人对这一技术组件的掌握程度。</p>\n<p>那么，我们应该如何掌握与代理机制相关的解题思路呢？这里我总结了三点思路。</p>\n<p>首先，就理论知识而言，我们需要明确代理机制的概念和分类。关于代理机制的概念，你可以结合设计模式中的代理模式一起进行理解。而关于代理机制的分类，一般认为具体的表现形式有两种，一种是静态代理机制，一种是动态代理机制。面试过程中，关于静态代理机制只需要简单介绍即可，重点要做展开的是动态代理机制。</p>\n<p>然后，我们需要对动态代理机制的主流实现技术展开讨论。在 Java 的世界中，想要实现动态代理，主要有三种实现方式，即 JDK 自带的代理类以及第三方的 Cglib 和 Javassist。这些实现技术的使用方式大致相同，但背后的原理却各有特点。候选人至少需要对其中的一种实现方式有深入的理解，建议可以从 JDK 自带的代理类进行切入。</p>\n<p>最后，明确了概念和技术之后，接下来就是具体的应用场景了。可以说，动态代理机制在各个主流的开源框架中应用非常广泛。因为它是一种通用型的技术组件，所以可以根据不同的应用场景解决不同的问题。这里也需要候选人对主流开源框架中涉及到动态代理的常见应用场景和实现方式有足够的了解。</p>\n<h2 id="技术体系-19"><a href="#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-19" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术体系</h2>\n<p>通过问题背景部分所介绍的应用场景，实际上我们可以梳理代理机制中存在的三种不同的角色，即抽象角色、代理角色和真实角色，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-27-11-45-56-cb4bb2c78dfef57e1d08bcfcceff8759-0e173.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 646px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 25.386996904024766%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAABF0lEQVQY01WQi2rCQBBF8/9fI6aCJjHaWgpFsL4aNWvM07R52U1sVBLkdrKh0C4c5s7sshxGwp9T1zWG5hidtYzutoddaMGxZtgYMpaLlrdZB+vVA9HDailjMe+Kam778L0xpIo+qe933KoKZVnCCz0EUYAwCXG5XXC9foPzBHmeIucpvk5xm4lmznkqKPIM5yKDpDMG2TCgULUcB6/BFKqlE0NYkYOjv4Zt6zDeFTBTh+c+k7GCPRtRnogZM+ntfoQknkI6FQWiLBNwzuEeXWHY0BiW5RkJ2SbJB+I4RJp+tpX639zcNWRZBOn/DiuMDxP0DxoGzlDs0LPnYGyA7WaAwH8S7JkGc6eQlUaWj9SrZKkiil7wAycNac3ribdCAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 27 11 45 56" title="" data-src="/static/2024-11-27-11-45-56-cb4bb2c78dfef57e1d08bcfcceff8759-0e173.png" data-srcset="/static/2024-11-27-11-45-56-cb4bb2c78dfef57e1d08bcfcceff8759-2fb9f.png 200w,\n/static/2024-11-27-11-45-56-cb4bb2c78dfef57e1d08bcfcceff8759-f1e72.png 400w,\n/static/2024-11-27-11-45-56-cb4bb2c78dfef57e1d08bcfcceff8759-0e173.png 646w" data-sizes="(max-width: 646px) 100vw, 646px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可以看到，代理角色和真实角色一样实现了抽象角色，但是它是真实角色的一种代理。通过代理角色，开发人员可以在真实角色的基础上添加各种定制化的处理逻辑。</p>\n<p>上图展示代理机制中的三种角色及其对应的职责，转化为面向对象领域的表现形式，就是如下图所示的类层结构：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-27-11-46-27-4d0bde33b798b76b0df8df86566cfea9-a3fce.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 515px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 75.33980582524272%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAACA0lEQVQ4y5VTa3PSUBDN//8DOqNOx34Qx7ZCH0gYTB+8TEigIuRBIaEJBdpSYNKGIAQ4bkIdAaHizpzcnZvdc/fJYEVms1lwjkYeJIlDIR+GJEbAfztATtgnPY7hcLRkuyjMJkLHGaJaTaKuH8EyWSIK4UoLw9DPYdvO/xO67gg8f4SGeQKz/iXAjRVFjg/j6cndjtA3+G3keRPIZRGqmkK5dIESQVGSdPJUjvFf9hsjXPfydApMJi/b/DPCbvcBhlFFq9VAsZjHZUEMdP+u07nfLsJFA0XJUgOOoddYKPIhIYK6Ecd1PQpZTm5PSN8gRV0X4Q4y1OUYSj8+Ew7QbnIY/eTpER5znhcI/7w2C4w1jcejTWNjsJTuJ0i5EDr3SQycDEWfWvJZBDOlcJYxr/5l4Qxy6QOujZNgFuc4prsQRJF9btYEq/5ru2zbj0inz6AqAq4qeVQ0MYCva6qAVIpDr9db32VdV6l7eoCGVYFp6jS4DgaDATaJ6w6D/82mBcvSyLdGeo0mQAVzcf6epn8XifgrOncg0Hb4NfTT8bwxwVvB+DlVQBBYZDNvwSVeI5t+R/oumJywh9sWB6NGq9VgkZdi6PdtmsNukNY69Ps9tNt34L7u02rGqM4s7tqnKBUjYNjYG5q3KNWHCl7eQzp1iG0lJyRQ/P4RVfL1OU65HfwCetVmzaC2AHMAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 27 11 46 27" title="" data-src="/static/2024-11-27-11-46-27-4d0bde33b798b76b0df8df86566cfea9-a3fce.png" data-srcset="/static/2024-11-27-11-46-27-4d0bde33b798b76b0df8df86566cfea9-96d1c.png 200w,\n/static/2024-11-27-11-46-27-4d0bde33b798b76b0df8df86566cfea9-2b9d0.png 400w,\n/static/2024-11-27-11-46-27-4d0bde33b798b76b0df8df86566cfea9-a3fce.png 515w" data-sizes="(max-width: 515px) 100vw, 515px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>上图中，代理接口扮演的就是抽象角色，而代理类和委托类则分别充当了代理角色和真实角色，请注意它们都实现了代理接口。</p>\n<p>前面已经提到，代理机制在具体实现上一般有两种方式，一种是静态代理机制，一种是动态代理机制。在 Dubbo、MyBatis 等常见开源框架中，这两种实现方式都有应用。本讲内容重点对动态代理展开讨论，主要因为动态代理理解和实现起来相对比较复杂，而且在 Dubbo、MyBatis 等框架中的应用方式和实现过程也值得我们学习和模仿。</p>\n<p>在接下来的内容中，我们就以 JDK 自带的代理类为例给出具体的实现方式。</p>\n<p>现在假设存在一个 Account 接口，然后需要在调用其 open 方法的前后记录日志。显然，通过静态代理完全能做到这一点，而使用 JDK 自带的动态代理也并不复杂。在 JDK 自带的动态代理中存在一个 InvocationHandler 接口，我们首先要做的就是提供该接口的一个实现类，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93625870126159840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class AccountHandler implements InvocationHandler {\n   private Object obj;\n\n   public AccountHandler(Object obj) {\n      super();\n      this.obj = obj;\n   }\n\n   @Override\n   public Object invoke(Object proxy, Method method, Object[] arg) throws Throwable {\n      Object result = null;\n      doBefore();\n      result = method.invoke(obj, arg);\n      doAfter();\n      return result;\n   }\n\n   public void doBefore() {\n      System.out.println(&quot;开户前&quot;);\n   }\n\n   public void doAfter() {\n      System.out.println(&quot;开户后&quot;);\n   }\n}`, `93625870126159840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountHandler</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">{</span>\n   <span class="token keyword">private</span> <span class="token class-name">Object</span> obj<span class="token punctuation">;</span>\n\n   <span class="token keyword">public</span> <span class="token class-name">AccountHandler</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>obj <span class="token operator">=</span> obj<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token annotation punctuation">@Override</span>\n   <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>\n      <span class="token class-name">Object</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n      <span class="token function">doBefore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      result <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">doAfter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> result<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doBefore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"开户前"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doAfter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"开户后"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到 InvocationHandler 中包含一个 invoke 方法，我们必须实现这一方法。在这一方法中，我们通常需要调用 method.invoke 方法执行原有对象的代码逻辑，然后可以在该方法前后添加相应的代理实现。在上述代码中，我们只是简单打印了日志。</p>\n<p>然后，我们编写测试类来应用上述 AccountHandler 类，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11198498550611945000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class AccountTest {\n   public static void main(String[] args) {\n      Account account = new RealAccount(&quot;tianyalan&quot;);\n      InvocationHandler handler = new AccountHandler(account);\n\n      Account proxy = (Account)Proxy.newProxyInstance(account.getClass().getClassLoader(), account.getClass().getInterfaces(), handler);\n      proxy.open();\n   }\n}`, `11198498550611945000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountTest</span> <span class="token punctuation">{</span>\n   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token class-name">Account</span> account <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RealAccount</span><span class="token punctuation">(</span><span class="token string">"tianyalan"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token class-name">InvocationHandler</span> handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccountHandler</span><span class="token punctuation">(</span>account<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token class-name">Account</span> proxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Account</span><span class="token punctuation">)</span><span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>account<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> account<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      proxy<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Proxy.newProxyInstance 方法的作用就是生成代理类，当该方法被调用时，RealAccount 类的实例被传入。然后执行到代理类的 open 方法时，AccountHandler 中的 invoke 方法就会被执行，从而触发代理逻辑。这里的类层结构如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-27-11-47-29-64ca411eeda0b3150d52fefc82b4533b-0e173.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 646px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 52.012383900928796%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABlElEQVQoz41S2U7CUBC9//8Fvii8aIAXMT6ZmADKUnaRsLZAy1ZKC2WJINBynN6CUojGJid37syZ05m5w/DHt9/b/FTkEmqVMFLJABLxO1QrDxCbcdg8vCfenp8OmHP5DbZ9FCygXg2i/B5CqRhApRyAJEY8gkewU/XToGu7gv1+C62WgE47jWYjga6So3sJDu08n7mtHVs8b9lrf6wszOefh8ouuY6fSWKG/1ESU3TmsVwuCHNIkgC5k8ViYWKz2dDM0pDlDPkyaFO1s5mB9XpN/gxaxFXkHAb9Itjrix/ZtJ8GfoNC7hbaSEW324FAdyHpx3CgwDRNxCLXSAvkS/kQi14RR8R4rJPtI9415ftoxkGwkSpjYvQ4NE3h1Wy3W7JlSlB4xbvdDpPJkIQdqDCMPnFcnjrsUKxHvh7nM/zjc1objYaYTnUSNKCPNei6DsuyLrjMeUkvji9tf6/NarWmGUXRrIdpB+9pVs8kqPKYbVuefPazJnxRDi92uj6uYL32hNJbCPlsAI3aI7WpHQRtD/8LuzvynNNQjcMAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 27 11 47 29" title="" data-src="/static/2024-11-27-11-47-29-64ca411eeda0b3150d52fefc82b4533b-0e173.png" data-srcset="/static/2024-11-27-11-47-29-64ca411eeda0b3150d52fefc82b4533b-2fb9f.png 200w,\n/static/2024-11-27-11-47-29-64ca411eeda0b3150d52fefc82b4533b-f1e72.png 400w,\n/static/2024-11-27-11-47-29-64ca411eeda0b3150d52fefc82b4533b-0e173.png 646w" data-sizes="(max-width: 646px) 100vw, 646px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>仔细分析上述代码结构，可以发现其遵循设计并实现业务接口 -> 实现 Handler -> 创建代理类这一实现流程，然后在 Handler 中构建具体的代理逻辑。</p>\n<p>上述流程展示了基本的代理机制实现过程。我们可以联想一下很多基于 AOP 机制的拦截器实际上就是类似的流程。</p>\n<h2 id="源码解析-17"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-17" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h2>\n<p>在本讲的源码解析部分，我们将分别基于 Dubbo 框架和 MyBatis 框架来深入分析在主流开源框架中动态代理机制的应用场景和实现原理。</p>\n<h3 id="dubbo-远程访问中的代理机制"><a href="#dubbo-%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE%E4%B8%AD%E7%9A%84%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dubbo 远程访问中的代理机制</h3>\n<p>当使用 Dubbo 进行远程服务调用时，我们所做的事情就是在配置文件或代码中添加对某个服务的引用，整个过程让人感觉并没有执行任何与远程方法调用相关的网络连接、数据传输、序列化等操作，这就是所谓的远程调用本地化。远程调用本地化得以实现的背后用到的实际上就是动态代理机制。</p>\n<p>在 Dubbo 中，我们知道执行远程调用的是 Invoker 对象。因此，当该对象被创建出来之后，我们就需要为它生成对应的代理对象，完成这一操作的是 ProxyFactory 工厂类，该工厂类的 getProxy 方法如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10273482610443852000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface ProxyFactory {\n   @Adaptive({Constants.PROXY_KEY})\n   <T> T getProxy(Invoker<T> invoker) throws RpcException;\n\n   @Adaptive({Constants.PROXY_KEY})\n   <T> Invoker<T> getInvoker(T proxy, Class<T> type, URL url) throws RpcException;\n}`, `10273482610443852000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProxyFactory</span> <span class="token punctuation">{</span>\n   <span class="token annotation punctuation">@Adaptive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>PROXY_KEY<span class="token punctuation">}</span><span class="token punctuation">)</span>\n   <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> invoker<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span><span class="token punctuation">;</span>\n\n   <span class="token annotation punctuation">@Adaptive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>PROXY_KEY<span class="token punctuation">}</span><span class="token punctuation">)</span>\n   <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">getInvoker</span><span class="token punctuation">(</span><span class="token class-name">T</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> type<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 Dubbo 中，ProxyFactory 的直接实现类是 AbstractProxyFactory。该类是一个抽象类，除了为每个服务自动添加回声（Echo）功能之外，还预留了一个 getProxy 抽象方法供子类进行实现。</p>\n<p>在 Dubbo 中存在两个 ProxyFactory 的实现类，即 JavassistProxyFactory 和 JdkProxyFactory。其中的 JdkProxyFactory 的实现比较典型，接下来我们就对 JdkProxyFactory 进行展开，该类的 getProxy 方法如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95412173493584640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public <T> T getProxy(Invoker<T> invoker, Class<?>[] interfaces) {\n   return (T) Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(), interfaces, new InvokerInvocationHandler(invoker));\n}`, `95412173493584640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> invoker<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> interfaces<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">InvokerInvocationHandler</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这里看到了熟悉的 Proxy.newProxyInstance 方法，这是典型的 JDK 动态代理的用法。根据传入的接口获得动态代理类，当调用这些接口的方法时都会转而调用 InvokerInvocationHandler。基于 JDK 动态代理的实现机制，可以想象 InvokerInvocationHandler 类必定实现了 InvocationHandler 接口，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69952456322565730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class InvokerInvocationHandler implements InvocationHandler {\n   private final Invoker<?> invoker;\n\n   public InvokerInvocationHandler(Invoker<?> handler) {\n      this.invoker = handler;\n   }\n\n   public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n      String methodName = method.getName();\n      Class<?>[] parameterTypes = method.getParameterTypes();\n\n      if (method.getDeclaringClass() == Object.class) {\n         return method.invoke(invoker, args);\n      }\n\n      if (&quot;toString&quot;.equals(methodName) && parameterTypes.length == 0) {\n         return invoker.toString();\n      }\n\n      if (&quot;hashCode&quot;.equals(methodName) && parameterTypes.length == 0) {\n         return invoker.hashCode();\n      }\n\n      if (&quot;equals&quot;.equals(methodName) && parameterTypes.length == 1) {\n         return invoker.equals(args[0]);\n      }\n\n      return invoker.invoke(new RpcInvocation(method, args)).recreate();\n   }\n}`, `69952456322565730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InvokerInvocationHandler</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">{</span>\n   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> invoker<span class="token punctuation">;</span>\n\n   <span class="token keyword">public</span> <span class="token class-name">InvokerInvocationHandler</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>invoker <span class="token operator">=</span> handler<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>\n      <span class="token class-name">String</span> methodName <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> parameterTypes <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invoker<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"toString"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>methodName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> parameterTypes<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span> invoker<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"hashCode"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>methodName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> parameterTypes<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span> invoker<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"equals"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>methodName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> parameterTypes<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span> invoker<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">return</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RpcInvocation</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">recreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，这里只是把方法的执行转向了 invoker.invoke 方法。关于 Invoker 的介绍不是本讲内容的重点，我们已经在前面介绍服务调用时对其进行了详细的展开，你可以做一些回顾。</p>\n<h3 id="mybatis-数据访问中的代理机制"><a href="#mybatis-%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E4%B8%AD%E7%9A%84%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>MyBatis 数据访问中的代理机制</h3>\n<p>在 MyBatis 中，应用动态代理的场景实际上非常多，我们无意对所有的场景都一一展开。这里列举一个最典型的应用场景，即 Mapper 层的动态代理，用于根据 Mapper 层接口获取 SQL 执行结果。</p>\n<p>在开始介绍 MyBatis 中的代理机制之前，我们先来回顾一下 MyBatis 的执行主流程，如下图所示。可以看到 MyBatis 是通过 MapperProxy 动态代理 Mapper。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-27-11-49-05-a2ecbf899f55bde2a80e6827c6e8b989-7278c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 651px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 44.70046082949309%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABK0lEQVQoz3VR2VLDMAzM//8QdBh4YPiFJmleU0qdwzmcy7mEVmDGtKAZj631erWSgyh8oTg68HqmdV1J6w86xU8Uh490eT+Si2WxBG50fKAkeeV8oeT0xtiBQsbO50h4wbat1PeG6lpTURRUVZqu1wsLF1SWBeV5zlgld1mmBLd2ImOMvBsGQ9u20DxbKRJAdRwn8sNay+SBiRsTZ3GOhXPTNPKw73vhKZVRmqZcvBQs2PedqwwsOgpxmibJ4QwYSBDRWkueKSVuu64TDnCcXYjDuq65neyHhLPih74z5xT3cOZwFIQRBMyJQ1T2AxiIfwXmiXt/PFh3gpiXI6Iy2nYkh2Nv2/YXhhGBfyfoV0UL/wneciHm59+//OXQhftdJ+LvKHYriJax4+4TcsC6ITqD7VgAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 27 11 49 05" title="" data-src="/static/2024-11-27-11-49-05-a2ecbf899f55bde2a80e6827c6e8b989-7278c.png" data-srcset="/static/2024-11-27-11-49-05-a2ecbf899f55bde2a80e6827c6e8b989-5503e.png 200w,\n/static/2024-11-27-11-49-05-a2ecbf899f55bde2a80e6827c6e8b989-992a5.png 400w,\n/static/2024-11-27-11-49-05-a2ecbf899f55bde2a80e6827c6e8b989-7278c.png 651w" data-sizes="(max-width: 651px) 100vw, 651px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>使用过 MyBatis 的同学应该都接触过这样一种操作，我们只需要定义 Mapper 层的接口而不需要对其进行具体的实现，该接口却能够正常调用并完成 SQL 执行等一系列操作，听起来很神奇，这是怎么做到的呢？让我们梳理一下整个调用流程。</p>\n<p>在使用 MyBatis 时，业务层代码中调用各种 Mapper 的一般做法是通过 SqlSession 这个外观类，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88033534890137200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`TestMapper testMapper = sqlSession.getMapper(TestMapper.class);`, `88033534890137200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">TestMapper</span> testMapper <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">TestMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>作为外观类，DefaultSqlSession 把这一操作转移给了 Configuration 对象，该对象中的 getMapper 方法如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15094993050523798000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Override\npublic <T> T getMapper(Class<T> type) {\n   return configuration.getMapper(type, this);\n}`, `15094993050523798000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> configuration<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>让我们来到这里出现的 MapperRegistry 类，会发现真正负责创建 Mapper 实例对象的是 MapperProxyFactory 类。请注意，mapperProxyFactory.newInstance 方法的传入参数是一个 SqlSession，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68578115814481350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public T newInstance(SqlSession sqlSession) {\n   final MapperProxy<T> mapperProxy = new MapperProxy<>(sqlSession, mapperInterface, methodCache);\n   return newInstance(mapperProxy);\n}`, `68578115814481350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">SqlSession</span> sqlSession<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">final</span> <span class="token class-name">MapperProxy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> mapperProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapperProxy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> mapperInterface<span class="token punctuation">,</span> methodCache<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> <span class="token function">newInstance</span><span class="token punctuation">(</span>mapperProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里引出了另一个核心类 MapperProxy，从命名上看，我们可以猜想该类就是一个代理类，因此势必使用了前面介绍的某种动态代理技术。可以先看一下 MapperProxy 类的签名，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58126462449666550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class MapperProxy<T> implements InvocationHandler, Serializable`, `58126462449666550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MapperProxy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>显然，这里用到的是 JDK 自带的基于 InvocationHandler 的动态代理实现方案，因此，在 MapperProxy 类中同样肯定存在一个 invoke 方法，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25034716116107416000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Override\npublic Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n   try {\n      if (Object.class.equals(method.getDeclaringClass())) {\n         return method.invoke(this, args);\n      } else if (method.isDefault()) {\n         return invokeDefaultMethod(proxy, method, args);\n      }\n   } catch (Throwable t) {\n      throw ExceptionUtil.unwrapThrowable(t);\n   }\n\n   final MapperMethod mapperMethod = cachedMapperMethod(method);\n   return mapperMethod.execute(sqlSession, args);\n}`, `25034716116107416000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>\n   <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">isDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span> <span class="token function">invokeDefaultMethod</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">throw</span> <span class="token class-name">ExceptionUtil</span><span class="token punctuation">.</span><span class="token function">unwrapThrowable</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">final</span> <span class="token class-name">MapperMethod</span> mapperMethod <span class="token operator">=</span> <span class="token function">cachedMapperMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> mapperMethod<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对于执行 SQL 语句的方法而言，MapperProxy 会把这部分工作交给 MapperMethod 处理。而在 MapperMethod 的 execute 方法中，我们传入了 SqlSession 以及相关的参数。在这个 execute 方法内部，根据 SQL 命令的不同类型（insert、update、delete、select）分别调用 SqlSession 的不同方法。</p>\n<p>目前为止，我们看到了 MapperProxy 类实现 InvocationHandler 接口，但还没有看到 Proxy.newProxyInstance 方法的调用，该方法实际上也同样位于 MapperProxyFactory 类中，该类还存在一个 newInstance 重载方法，通过传入 mapperProxy 的代理对象最终完成代理方法的执行，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32871303705083466000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`protected T newInstance(MapperProxy<T> mapperProxy) {\n   return (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), new Class[] { mapperInterface }, mapperProxy);\n}`, `32871303705083466000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">T</span> <span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">MapperProxy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> mapperProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>mapperInterface<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> mapperInterface <span class="token punctuation">}</span><span class="token punctuation">,</span> mapperProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>作为总结，我们梳理了 MyBatis 中 Mapper 层动态代理相关类的类层结构，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-11-27-11-50-25-880923778297c19ddab3568afe4a244f-21746.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 449px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 71.0467706013363%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAACG0lEQVQ4y5VTaXPSUBTN//+uM1orWupS2Wrp6FQoECLSsATCltoSFkMCpaWgRZAtx0MQ+sVRmpk7773cd7dzzhOwxWfbC2ftdCxkMwHo1RAyaT/NB4XnghpEox5GOhWE8JCE3SsTphHCr9EZykUf1JwHmdRrfNXeYzRMwjKlhyW8YkIx9txJIsVdSEgvnDUS3kE8touccgjBtu2tE7bbLY53iOuuhLYVY0cRWhSdtojejQQly5EXiwX+Z+ui0+kULeMbms0GzJZBzGSo+RxM00CzUWdBa7uRV13aW90TUqkwVDWMSlkkBiEUCxGOFXHWcimKYlFEv9/fBPRvb/AlEUSJvmVcSv4ATRORzYZwd/cDghTfR/T0CWLRHcjJPeJAwMVdpGU3Umd7qJQClETNGX0ymaFcVnAafoyTj4/oX93JZV9RPm8xGNxC+HTiIu1+SuCAwT6UCp4/5uXZy27cMIjb+tO0Aos/hVbxo5B/xyl8nM5Lpp+h17uGYBg6waw5Zllcrdrm3G7XoesVVh5sEk6nExJzSaab9OuM0dHtkiRTd3xbkTKbzTAejzEajTAc/tz87/W+E7eRs5/Pl8RhJZulzuzF323pv+9uDlmOEgaPo7m4+IZ47pOQIAk9QqNxsRL2v2wtmfW+Ws3wPbuR+OxCnrgnEy+pxQNcXgToK2779O4TKopEIgIkJUgyjnCuHeO8coy84iVhKn4DPLYKL7EB5aYAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 11 27 11 50 25" title="" data-src="/static/2024-11-27-11-50-25-880923778297c19ddab3568afe4a244f-21746.png" data-srcset="/static/2024-11-27-11-50-25-880923778297c19ddab3568afe4a244f-17e1d.png 200w,\n/static/2024-11-27-11-50-25-880923778297c19ddab3568afe4a244f-f4f9f.png 400w,\n/static/2024-11-27-11-50-25-880923778297c19ddab3568afe4a244f-21746.png 449w" data-sizes="(max-width: 449px) 100vw, 449px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>总体而言，基于代理机制，MyBatis 中 Mapper 层的接口调用过程还是比较简单明确的，这里采用的实现方案也比较经典，相关的类层结构设计也可以用作日常开发工作的参考。</p>\n<h2 id="解题要点-19"><a href="#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-19" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解题要点</h2>\n<p>关于动态代理的实现技术是面试过程中的一个要点。动态代理是代理机制的主要实现方式，相比静态代理更为复杂也更为实用。常见的动态代理实现技术包括 JDK 自带的代理类、第三方的 Cglib 和 javassist。在回答该题时，这三个名词是一定要点到的，至于具体的细节，视面试的进展可以合理进行展开，包括给出一些自己开发过程中的实践体会，或者部分核心类的介绍。针对这道题而言，我们关注的是动态代理的技术本身，而不是应用的方式和场景。在准备这类面试题时，我们可以事先对动态代理的三种实现方式做一些示例代码，从而确保自己先有一个感性的认识。</p>\n<p>针对具体框架的应用场景和实现机制的考查，是与动态代理机制相关的另一个面试要点，我也经常拿这些问题来面试不同层级的候选人。例如，对 Dubbo 而言，存在两种动态代理的实现机制，即 JDK 和 Javassist。尽管默认采用的是后者，但由于 Javassist 的实现过程过于复杂，一般不大适合作为一个面试题进行考查，所以更多的时候我们还是会拿 JDK 中的动态代理机制来进行讨论。</p>\n<p>在回答这种问题上，第一步肯定是回答关于动态代理实现机制本身的内容，例如这里我们就需要对 JDK 中的 InvocationHandler 接口和 Proxy 静态类做详细的介绍。然后，针对 Dubbo 框架，我们也要明确所有的远程调用过程都是封装在一个个的 Invoker 对象中，所以动态代理的目的实际上就是把本地代码的调用过程转移到对 Invoker 对象的使用上，这是我们在回答类似问题上的基本思路。</p>\n<p>Dubbo 中动态代理的整个执行流程还是比较清晰和明确的，在理解上建议关注于各个接口方法的输入输出参数，尤其是 Invoker 对象的使用方式。</p>\n<p>再比如说，类似“在 MyBatis 中，为什么我们只需要定义 Mapper 层的接口而不需要对其进行具体的实现就能完成正常的 SQL 执行过程？”这样的问题也很经典，经典之处在于一般的开发人员很难通过题目中的描述明确问题的考点。</p>\n<p>实际上，该题考查的还是代理机制。而从问题的问法上是基于 Mybatis 这个框架，但问题本身是跟 MyBatis 没有关系的，关注的是“没有具体实现的接口如何完成方法调用”这个本质问题。我们要理理思路来慢慢解开这道题的回答内容。</p>\n<p>首先，我们明确通过 MyBatis 可以提供一系列的自定义 Mapper 接口，我们使用这些接口定义就可以执行数据库的查询、更新等操作。这是框架应用上的具体做法，相信所有用过 MyBatis 的同学都能明确这一点。然后，我们再次明确，通过接口定义就能提供方法调用的基本原理就是对这些接口进行了动态代理。只要明确了这一点，就可以把动态代理的相关内容嫁接到这个问题上，从而完成该问题的回答。</p>\n<h2 id="小结与预告-17"><a href="#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-17" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结与预告</h2>\n<p>本章介绍动态代理的基本概念、应用场景、组成结构以及技术实现方式。这些内容在 Dubbo 和 MyBatis 框架中都得到了应用，其中 Dubbo 主要使用动态代理实现远程方法的调用，而 MyBatis 则基于它来完成数据访问。</p>\n<p>介绍完动态代理，下一讲我们要讨论的是缓存机制。在分布式系统构建过程中，缓存也是一个通用型的技术组件，其应用方式也比较多样化。那么，如何在数据访问过程中嵌入缓存机制？我们下一讲再聊。</p>\n<h1 id="应用缓存：如何在数据访问过程中嵌入缓存机制？"><a href="#%E5%BA%94%E7%94%A8%E7%BC%93%E5%AD%98%EF%BC%9A%E5%A6%82%E4%BD%95%E5%9C%A8%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E8%BF%87%E7%A8%8B%E4%B8%AD%E5%B5%8C%E5%85%A5%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>应用缓存：如何在数据访问过程中嵌入缓存机制？</h1>\n<p>在上一讲中，我们介绍了动态代理这一通用型的技术组件。本讲继续围绕通用型技术组件展开讨论，我们将要介绍的是缓存机制。</p>\n<p>想要理解缓存的设计策略，我们一般都会从应用层缓存的角度切入来具体探讨如何使用缓存的方法。缓存的作用在于减少数据的访问时间和计算时间，表现为将来自持久化或其他外部系统的数据转变为一系列可以直接从内存获取的数据结构的过程。</p>\n<p>那么，针对分布式系统，如何在数据访问过程中嵌入缓存机制？这是开发人员都需要面对的一种场景，也是面试过程中的高频话题。本讲内容将和你一起探讨应用缓存的实现机制和底层原理。</p>\n<h2 id="问题背景-17"><a href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-17" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题背景</h2>\n<p>缓存技术在分布式系统的开发过程中应用非常广泛，开发人员可以使用位于应用程序内部的本地缓存，也可以使用位于独立服务器上的分布式缓存。在日常开发中，缓存的应用通常都是分层级的，我们会综合使用多级缓存来提高目标对象访问的效率和性能。</p>\n<p>想要理解缓存的设计策略，我们一般都会基于一定的缓存架构体系展开讨论。在日常面试过程中，关于缓存的讨论也会涉及到一系列与设计思想和应用方式相关的话题，常见的包括：</p>\n<ul>\n<li>缓存的基本结构是怎么样的？</li>\n<li>你怎么理解多级缓存的概念和作用？</li>\n<li>如果让你设计一个基础的缓存，你会怎么做？</li>\n<li>Mybatis 中包含哪些具体的缓存结构，各自有什么特点？</li>\n<li>Mybatis 中的缓存数据是如何进行分级管理的？</li>\n<li>Mybatis 的二级缓存与一级缓存有什么关联关系？</li>\n</ul>\n<p>事实上，缓存的基本原理都是类似的，都是一种空间换时间的实现方案。但是，在现实中，我们通常会引入多级缓存的技术手段来对缓存数据进行更为合理和有效的管理，这也是我们在学习主流开源框架时要特别注意的技术点。</p>\n<h2 id="问题分析-18"><a href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-18" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题分析</h2>\n<p>让我们对缓存相关的问题做一些分析和展开。缓存是一项实现技术丰富、表现形式也比较多样的技术组件。在本讲中，我们关注的是应用程序内部的本地缓存实现策略。针对这种场景，最简单的缓存实现策略就是基于 JDK 中的某种数据结构来提供 CRUD 入口。但正如前面所提到的，现实中的缓存实现策略往往没有那么简单，多级缓存的设计思想普遍存在。</p>\n<p>因此，在应对这类面试题时，我们需要从多级缓存的设计思想出发梳理对应的组成结构和实现策略。这是应对这类面试题的第一点思路。</p>\n<p>有了理论基础之后，我们就可以采用一定的数据结构或工具来实现多级缓存。而目前主流的开源框架中也不乏实现多级缓存的经典场景，尤其是那些与数据库访问相关的 ORM（Object Relational Mapping，对象关系映射）框架。以常见的 Mybatis 框架而言，就内置了由一级缓存和二级缓存所构成的一整套多级缓存机制。</p>\n<p>通过对框架源码的学习，我们就能掌握应对上述面试题的回答技巧。同时，这些多级缓存机制的实现原理也为我们应对类似的应用场景提供了很好的参考。</p>\n<h2 id="技术体系-20"><a href="#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-20" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术体系</h2>\n<p>关于缓存的设计策略是一个比较大的话题，而缓存的分层思想是其中的一个核心设计思想。本节内容先从经典的缓存分层架构出发，分析应用层缓存的分级管理模式。</p>\n<p>缓存的核心作用在于降低获取目标数据所需的时间，具体表现上，通常是把来自持久化或其他外部系统的数据转变为一系列可以直接从内存获取的数据结构的过程。</p>\n<p>在学习互联网系统中的主流架构时，我们经常会看到类似如下所示的架构图：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-12-16-11-21-50-933955649f7b3c7ab129ff9050f3e81d-700d4.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 540px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 15.555555555555555%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsSAAALEgHS3X78AAAAyElEQVQI1x2O22rCUBBF8//fYwtqJNTGhgTxySK5G5KTY+7GpK0U6uq0D8PAbNZeY7wfl1QXiyQ2GceZNHEplUngP3G9dugyQhVrsvMSpXyGoZfsmShcyH5lmj4Ig81/RxxbGKXaMt1s5skjDGPS1KatN1y0KQWZQHv6zhJgLbcTvn+iyFdk6YI8d4iiRJ5Z0dQmbeNgqGILjwO30aWqGgEP3L8cuvaFrqvQOuT77opwR10HMpqht/mc3yhLj7btRbTj8fMn9vgFw2TX6KYevokAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 12 16 11 21 50" title="" data-src="/static/2024-12-16-11-21-50-933955649f7b3c7ab129ff9050f3e81d-700d4.png" data-srcset="/static/2024-12-16-11-21-50-933955649f7b3c7ab129ff9050f3e81d-555fa.png 200w,\n/static/2024-12-16-11-21-50-933955649f7b3c7ab129ff9050f3e81d-eb4c6.png 400w,\n/static/2024-12-16-11-21-50-933955649f7b3c7ab129ff9050f3e81d-700d4.png 540w" data-sizes="(max-width: 540px) 100vw, 540px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在上图中，在 Nginx、Redis 等组件中都可以存在缓存机制，我们无意对所有缓存机制进行展开，本讲关注的是上图中应用程序层的缓存。这里的应用程序泛指诸如 Tomcat、Undertow 等应用程序容器，也包括像 Spring、Dubbo、Mybatis 等的开源框架，以及我们自己开发的业务系统。</p>\n<p>如果我们分析应用层所具备的缓存实现技术，都可以抽象出通用的缓存结构，下图就是一种常见的缓存表现形式：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-12-16-11-24-15-3356949419823f291ffebd4fd8d3d6dc-72de5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 648px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 42.28395061728394%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAAByklEQVQozz1SiW7aQBTk/z+jUiu1qqKQtAUaQKUQwDnA1Bc+8H1BYsDBBJDaTMem6kqjXc++N2/e89ZUpYHQ/465dgVNqUOfX/+HKl/C1L8ijW9g21OUa7NZIY5mSFMJafIPPEeRjDzPUXPsEQJ/QMEOLLNH/ICqUGDxk6Id+N4tnlYCE/RK0F7IcJ0rijYRhTQTNFiwWRkKwxC133+A4+mNlQtYlk94UFWTjoIKq9UWxyPwhvNyHY0iLYp0kZSIOlilXRohlyaoeZ7IahM4tsDqI7rq4/GhgYU1YtAQnnvPtqZYpm4lGPgGHXexy4fYbvrEAMXulnFtdkGHhv4Nz08dKNJnipUzq8OY1+EsvjC5yeodFC89JkxRFCfc3fUwEz9iOHjH/ROE8Xs83H/Ar9kl4jhCLcsySJKEyeQRsixBFEWI0ykURa74890E6/Uau90eui6y1Rv4bot7mzNuVd+u00aSsOXlMoTrGpyXBs8zYZoyRQUEgUVuDsfRySnYbjMcDieORoNl1Om+RdcNCpevpMkXcX12aBpNHA8CXvdjZM89BF55eVEF74sRMcbhdQhDH1c/Lgwtxg2QbwXOb1xh9yKQ7yNOYvwFoNw5tjSNIkAAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 12 16 11 24 15" title="" data-src="/static/2024-12-16-11-24-15-3356949419823f291ffebd4fd8d3d6dc-72de5.png" data-srcset="/static/2024-12-16-11-24-15-3356949419823f291ffebd4fd8d3d6dc-bb436.png 200w,\n/static/2024-12-16-11-24-15-3356949419823f291ffebd4fd8d3d6dc-c5634.png 400w,\n/static/2024-12-16-11-24-15-3356949419823f291ffebd4fd8d3d6dc-72de5.png 648w" data-sizes="(max-width: 648px) 100vw, 648px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在上图中，数据表示为 Key-Value 对，然后我们对 Key 施加一定的算法获取其哈希值。有了这个哈希值，我们就可以找到目标 Value 所在的位置并获取值。</p>\n<p>各类缓存实现工具，尽管其支持的数据结构以及数据在内存中的分配和查找方式有所不同，但基本结构模型都与上图类似。从该图中，我们也认识到缓存本质上是一种空间换时间的做法。</p>\n<p>现在，我们已经明确了单级缓存的基本结构，让我们对上图进行扩展和延伸，把讨论范围扩大到多级缓存。如果对应用程序层的缓存进行进一步分析，我们发现同样存在分级模式，这种分级模式通常包括两级，即一级缓存和二级缓存，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-12-16-11-25-21-9b070bb9587d50c7eda1cd40ede94a6a-f72ce.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 419px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 54.41527446300716%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAAB8klEQVQoz22RC1PaUBCF8/9/RqdOq0VGh4ICTi0FFfM05AERFHkbEx4dUAK5yenmtjgFvDNndvaw+faBgH8vjmPsvsTb9Tf5eDyGbdtwXXerVvi/iDGGfr+PVquF5XL5DvF9H51OB/P5/N1bLBYYjUYIw3CrkRDHETaKIobhcMCBq1WQlHF5nod2+3ELGARL3ih5yXcbhrC75nrN8PYW7K3v+5OtPAwZJpPZXp3Q7bahqlewTAlOQ4Msl1Gt/oTjaLAsGXVbgWGIKJXyaNQ1upsCk2pluYKrygWMmgj9rgpNu0G9rkOo3hwTV8FwUEDnKUuANGr6Efq9c/RISXxqZyGLn9Ht5NB+zGA2LYGFEtYrkWsV3NK6CnrdIgSjlgVby5BuDwh6QdBzrlbzO3TtiODf0LBPCXqGQb9IW5zSVCkawkYcaRR1OvMdRZPOUoFQ03N4XVxDUw/5j8FSpAYKPPcS1etPkMQDPLSyCMlLANNJGZrylWotREzlXsQSsAHv5RcETc1QUsO9k6FpUjCNYy7LTNNkJ3w600hDVQ55U1n6Avf5kjdnocphSUwYLy4BVeWEEoev8LEM+N4PapBCw0rj96xMXp37yZp/ZXBvOqGVJalI98rThIUP5TTysK0cTZkl5eifzqN5X9jTQ7NAt83jD6t0Jsm7DtZ7AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 12 16 11 25 21" title="" data-src="/static/2024-12-16-11-25-21-9b070bb9587d50c7eda1cd40ede94a6a-f72ce.png" data-srcset="/static/2024-12-16-11-25-21-9b070bb9587d50c7eda1cd40ede94a6a-58799.png 200w,\n/static/2024-12-16-11-25-21-9b070bb9587d50c7eda1cd40ede94a6a-69db4.png 400w,\n/static/2024-12-16-11-25-21-9b070bb9587d50c7eda1cd40ede94a6a-f72ce.png 419w" data-sizes="(max-width: 419px) 100vw, 419px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>简单来说，常见的一级缓存就是指一次请求（Request）级别或者说会话（Session）级别的缓存。针对第一次查询操作，我们会把从数据库中获取的数据放在会话中。针对后续的查询操作，我们就可以直接从会话中拿到目标数据并直接返回。</p>\n<p>而二级缓存的范围则更大一点，它是一种全局作用域的缓存。只要应用程序处于运行状态，那么所有请求和会话都可以使用。</p>\n<p>多级缓存代表着一种架构设计的方法论，在多款开源框架中都有对应的实现方案。接下来，我们将基于 Mybatis 框架来分析它的一级缓存和二级缓存。</p>\n<h2 id="源码解析-18"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-18" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h2>\n<h3 id="mybatis-一级缓存"><a href="#mybatis-%E4%B8%80%E7%BA%A7%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Mybatis 一级缓存</h3>\n<p>Mybatis 的一级缓存是二级缓存的基础，我们需要深入理解一组 Cache 对象，以及这些 Cache 对象与 SQL 执行器（Executor）之间的交互关系。</p>\n<p>在 Mybatis 中，存在如下所示的一个 Cache 接口，代表了对缓存操作最高层次抽象。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52936916960000930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface Cache {\n   String getId();\n   void putObject(Object key, Object value);\n   Object getObject(Object key);\n   Object removeObject(Object key);\n   void clear();\n   int getSize();\n\n   default ReadWriteLock getReadWriteLock() {\n      return null;\n   }\n}`, `52936916960000930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Cache</span> <span class="token punctuation">{</span>\n   <span class="token class-name">String</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">void</span> <span class="token function">putObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token class-name">Object</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token class-name">Object</span> <span class="token function">removeObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">int</span> <span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">default</span> <span class="token class-name">ReadWriteLock</span> <span class="token function">getReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Cache 接口中的方法都是自解释的，而围绕该接口的类层结构如下图所示。在该图中，Cache 接口代表一种抽象，而位于图中央的 PerpetualCache 代表该接口的具体实现类。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-12-16-11-26-55-b1f888782887552495b1e3d67e672257-a2b3c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 434px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 60.13824884792627%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAACAElEQVQoz32SW2+bQBCF/f//UG8vUR6jxE3U2rCAAXM1sFyMm1a2wadzxnHUvBRphA27335nhsVyM+De7PDle4CHZMSdm+Prc4hvrJcQn5983K0zfFpu0Bz+4H/X5XLBYvh9glOmWK4cPDsenn6s8Sj1YgIUtkeQ5AiyUu4FqqbBfr/HwBoGuQ/yf4BtLY7Ho0IXwIyiL1DkCcJwA89zMcoi1jD06Dsr9w6d3nu0srltW/R9B2sb9PLsfD6rnQKneUbWl8jyFD/XKxjPQxRHSLMM42FEI5to0HYtajHsOsIE3PEQKQHzoNPpdAXOFwF2hQASGGME6OoGLuSGuqnVylqrNgTzHX/zoHEccRLDaZo+AmlIoO8bRFGoxV4x2jWmVQCN2b+bIdf8e2nkXCJvky1WEtlx1mJp4BpXTHox2KOuazQSl3ZVXSno1ks+0+HIOp3yNE8ylBLxNlaYJyBXy9Ee0rCqKlgBNhKbQLaELVCgVFXtdN07kIZpmsiEDcIoUjN+DhzALSYB/GRopj2+RZb4s6T8MOVcDSMEgQ9PKpQpx3EsPXX1ZDae0BusfrO8Rm/1PcGUUMNyX+mUN5sAkURnZM/3BB5I7INu4LRpSWtGJ4CHceLtWxLWuyEhy+WjxPZgfF8N8qLQnjUC2+1KHQ4tOSDC+bySZ6+vvzQ2P/C/uDSDYDyJkQAAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 12 16 11 26 55" title="" data-src="/static/2024-12-16-11-26-55-b1f888782887552495b1e3d67e672257-a2b3c.png" data-srcset="/static/2024-12-16-11-26-55-b1f888782887552495b1e3d67e672257-6a6e0.png 200w,\n/static/2024-12-16-11-26-55-b1f888782887552495b1e3d67e672257-8250c.png 400w,\n/static/2024-12-16-11-26-55-b1f888782887552495b1e3d67e672257-a2b3c.png 434w" data-sizes="(max-width: 434px) 100vw, 434px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>上图中的多数缓存实现类也都是自解释的，通过名称基本可以判断出它们的功能。而当我们想使用各种缓存类时，可以通过如下所示的装饰方法完成缓存对象的创建：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60694142311301010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Cache cache = new XXXCache(new PerpetualCache(&quot;cacheid&quot;))`, `60694142311301010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">Cache</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XXXCache</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PerpetualCache</span><span class="token punctuation">(</span><span class="token string">"cacheid"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果把这里的 XXXCache 替换成 FifoCache 就代表着这个新创建的 Cache 对象具备了 FIFO 功能。其他缓存类的使用方法也是一样。</p>\n<p>事实上，除了 PerpetualCache 类之外，Mybatis 其他的缓存实现类都是 Cache 的装饰器。而 PerpetualCache 是 Mybatis 中默认使用的缓存类型，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23096307044267885000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class PerpetualCache implements Cache {\n   private final String id;\n   private Map<Object, Object> cache = new HashMap<>();\n\n   public PerpetualCache(String id) {\n      this.id = id;\n   }\n\n   // 省略 getter/setter\n   // ...\n}`, `23096307044267885000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PerpetualCache</span> <span class="token keyword">implements</span> <span class="token class-name">Cache</span> <span class="token punctuation">{</span>\n   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>\n   <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">public</span> <span class="token class-name">PerpetualCache</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token comment">// 省略 getter/setter</span>\n   <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，整个 PerpetualCache 类的代码结构非常简单，除了一个 id 属性之外，代表缓存的 cache 属性只是一个 HashMap，是一种典型的基于内存的缓存实现方案。这里的几个方法也比较简单，所有对缓存的操作实际上就是对 HashMap 的操作。</p>\n<p>我们知道在 Mybatis 中存在一个配置项，用于指定一级缓存默认开启的级别，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10748141616846252000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<setting name=&quot;localCacheScope&quot; value=&quot;SESSION&quot;/>`, `10748141616846252000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="xml"\n              >\n                <span class="gatsby-code-button-language">xml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="xml"><pre style="counter-reset: linenumber NaN" class="language-xml line-numbers"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>localCacheScope<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SESSION<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>在 Mybatis 中一级缓存又可以分为两个级别，即 SESSION 级和 STATEMENT 级，它们之间的区别在于缓存范围的大小。对于 STATEMENT 级别而言，缓存的作用范围就是当前 SQL；而如果是 SESSION 级，则查询结果一直会位于该会话中。但是，要注意由于一级缓存是独立存在于每个 Session 内部的，因此，如果我们创建了不同的 Session，那么它们之间会使用不同的缓存。</p>\n<p>例如，完全一样的一个操作，如果在两个不同的 Session 中执行，那就意味着存在两份一样的缓存数据，但分别位于两个 Session 中，彼此之间不会共享，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-12-16-11-28-24-a9a164859c85d83d99eccc12c3de2cbd-72de5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 648px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 38.27160493827161%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABh0lEQVQoz22SWU/CUBCF+/9/A6/6YGIixqghPoCSKPtWIAJl6QKtFGJpWboezy1LQuIkJ/feme/OzF2kJEkQBAG22y1834cwz/MwNww4zm+6FkySxOkYhoL1yB7SmOtuoOs6RzeNS8IZhgkMY4Hd7ggJ2+18/GdRDOhkPW9/8e33wWUu6VqLyTqYjOus1IY6a7I7GZrahLmQYVkjdhPANAeX2HTaYLyFmVjPT6zZg6q2IX337yG37/Cez6BRu4UyzGI0yCIMKojCElZ2mUltJnuDMnpAR7CFDGqVGzbxhBF5/1BCHFWha6+Q3E0RazvPyjkGH7nxGRvng803U22cGruwsF59YuuRXRWwmOcwZFFNfWG8SK5BtWCZb5BsW8ZyKbOTLiuWoChfWP50eJwyN1R47D7vyGeSLgy9yuupY73uYZyyJbIyj8tkVhuTSQVSFPGiTzpbHB8fSiQSiukQo3ioIIyvWDEXvFD6KPwUOOv4Pc7ro4mvo2kaX9U9ea5ZoYhZoyhM9Qc/aViutrQX4wAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 12 16 11 28 24" title="" data-src="/static/2024-12-16-11-28-24-a9a164859c85d83d99eccc12c3de2cbd-72de5.png" data-srcset="/static/2024-12-16-11-28-24-a9a164859c85d83d99eccc12c3de2cbd-bb436.png 200w,\n/static/2024-12-16-11-28-24-a9a164859c85d83d99eccc12c3de2cbd-c5634.png 400w,\n/static/2024-12-16-11-28-24-a9a164859c85d83d99eccc12c3de2cbd-72de5.png 648w" data-sizes="(max-width: 648px) 100vw, 648px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>介绍完一级缓存的基本概念和组成结构，是时候回到 SqlSession 了，让我们回顾一下 DefaultSqlSession 中最具代表性的 selectList 方法，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18820241966139294000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Override\npublic <E> List<E> selectList(String statement, Object parameter, RowBounds rowBounds) {\n   try {\n      MappedStatement ms = configuration.getMappedStatement(statement);\n      return executor.query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);\n   } catch (Exception e) {\n      // ...\n   } finally {\n      ErrorContext.instance().reset();\n   }\n}`, `18820241966139294000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token function">selectList</span><span class="token punctuation">(</span><span class="token class-name">String</span> statement<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">,</span> <span class="token class-name">RowBounds</span> rowBounds<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      <span class="token class-name">MappedStatement</span> ms <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getMappedStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> executor<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> <span class="token function">wrapCollection</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">,</span> rowBounds<span class="token punctuation">,</span> <span class="token class-name">Executor</span><span class="token punctuation">.</span>NO_RESULT_HANDLER<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// ...</span>\n   <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>\n      <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>SqlSession 使用了经典的外观模式，背后真正执行查询操作的是 Executor，而 Executor 又使用了模板方法模式，它的 query 方法如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45498164132981400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Override\npublic <E> List<E> query(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql) throws SQLException {\n   // ...\n   // 强制清空一级缓存\n   if (queryStack == 0 && ms.isFlushCacheRequired()) {\n      clearLocalCache();\n   }\n\n   List<E> list;\n\n   try {\n      queryStack++;\n      list = resultHandler == null ? (List<E>) localCache.getObject(key) : null;\n      if (list != null) {\n         handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);\n      } else {\n         // 查询数据库\n         list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);\n      }\n   } finally {\n      queryStack--;\n   }\n\n   if (queryStack == 0) {\n      for (DeferredLoad deferredLoad : deferredLoads) {\n         deferredLoad.load();\n      }\n\n      deferredLoads.clear();\n      if (configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) {\n         // 如果是 STATEMENT 级，清空一级缓存\n         clearLocalCache();\n      }\n   }\n\n   return list;\n}`, `45498164132981400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">MappedStatement</span> ms<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">,</span> <span class="token class-name">RowBounds</span> rowBounds<span class="token punctuation">,</span> <span class="token class-name">ResultHandler</span> resultHandler<span class="token punctuation">,</span> <span class="token class-name">CacheKey</span> key<span class="token punctuation">,</span> <span class="token class-name">BoundSql</span> boundSql<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>\n   <span class="token comment">// ...</span>\n   <span class="token comment">// 强制清空一级缓存</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>queryStack <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ms<span class="token punctuation">.</span><span class="token function">isFlushCacheRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">clearLocalCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> list<span class="token punctuation">;</span>\n\n   <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      queryStack<span class="token operator">++</span><span class="token punctuation">;</span>\n      list <span class="token operator">=</span> resultHandler <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> localCache<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token function">handleLocallyCachedOutputParameters</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> key<span class="token punctuation">,</span> parameter<span class="token punctuation">,</span> boundSql<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         <span class="token comment">// 查询数据库</span>\n         list <span class="token operator">=</span> <span class="token function">queryFromDatabase</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> parameter<span class="token punctuation">,</span> rowBounds<span class="token punctuation">,</span> resultHandler<span class="token punctuation">,</span> key<span class="token punctuation">,</span> boundSql<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>\n      queryStack<span class="token operator">--</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>queryStack <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DeferredLoad</span> deferredLoad <span class="token operator">:</span> deferredLoads<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         deferredLoad<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      deferredLoads<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>configuration<span class="token punctuation">.</span><span class="token function">getLocalCacheScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">LocalCacheScope</span><span class="token punctuation">.</span>STATEMENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token comment">// 如果是 STATEMENT 级，清空一级缓存</span>\n         <span class="token function">clearLocalCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">return</span> list<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上述方法的实现逻辑有点复杂，首先我们来看最后一个 if 判断，可以看到如果一级缓存被设置为 STATEMENT 级，那么该方法会清空当前的本地缓存。这点跟前面的讨论一致。</p>\n<p>然后我们回到方法开头，这里会判断 queryStack 是否为 0，如果该值是 0 且当前的 SQL 语句中对 isFlushCacheRequired 参数进行了设置，那就会把 Session 中的 localCache 清空。请注意，Mybatis 一级缓存的启动过程不需要任何配置，它是强制开启的，我们无法关闭。但是通过动态 SQL 的 isFlushCacheRequired 参数可以强制清除所有一级缓存。</p>\n<p>通过查看定义，我们发现这个 localCache 就是一个 PerpetualCache 对象。如果这里没有从 localCache 获取到目标数据，就会调用 queryFromDatabase 方法查询数据库，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54539415740541510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`private <E> List<E> queryFromDatabase(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql) throws SQLException {\n   List<E> list;\n   localCache.putObject(key, EXECUTION_PLACEHOLDER);\n   try {\n      list = doQuery(ms, parameter, rowBounds, resultHandler, boundSql);\n   } finally {\n      localCache.removeObject(key);\n   }\n   localCache.putObject(key, list);\n   if (ms.getStatementType() == StatementType.CALLABLE) {\n      localOutputParameterCache.putObject(key, parameter);\n   }\n   return list;\n}`, `54539415740541510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token function">queryFromDatabase</span><span class="token punctuation">(</span><span class="token class-name">MappedStatement</span> ms<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">,</span> <span class="token class-name">RowBounds</span> rowBounds<span class="token punctuation">,</span> <span class="token class-name">ResultHandler</span> resultHandler<span class="token punctuation">,</span> <span class="token class-name">CacheKey</span> key<span class="token punctuation">,</span> <span class="token class-name">BoundSql</span> boundSql<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>\n   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> list<span class="token punctuation">;</span>\n   localCache<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> EXECUTION_PLACEHOLDER<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      list <span class="token operator">=</span> <span class="token function">doQuery</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> parameter<span class="token punctuation">,</span> rowBounds<span class="token punctuation">,</span> resultHandler<span class="token punctuation">,</span> boundSql<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>\n      localCache<span class="token punctuation">.</span><span class="token function">removeObject</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   localCache<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getStatementType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">StatementType</span><span class="token punctuation">.</span>CALLABLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      localOutputParameterCache<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">return</span> list<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>显然，一旦完成数据库查询，我们会将从数据库中获取的数据保存在 localCache 中。而如果你查看 BaseExecutor 的 update、commit 和 close 方法，会发现这些方法在执行完毕之后都会清空一级缓存。</p>\n<h3 id="mybatis-二级缓存"><a href="#mybatis-%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Mybatis 二级缓存</h3>\n<p>通过前面的介绍，我们发现 Mybatis 的一级缓存本质上就是一个 HashMap。Mybatis 没有对 HashMap 的大小进行管理，也没有缓存更新和过期的概念。这是因为一级缓存只发生在一次请求或一次会话中，生命周期非常短，不需要添加复杂的控制逻辑。</p>\n<p>接下来让我们继续研究 Mybatis 中的另一种缓存表现形式，即二级缓存。相较一级缓存，Mybatis 的二级缓存使用方法有所不同，代码结构和类层关系也要更加复杂一些。</p>\n<p>与一级缓存不同，Mybatis 的二级缓存默认是不启用的，我们需要设置对应的配置项才能让它发挥作用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7758998750642765000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<setting name=&quot;cacheEnabled&quot; value=&quot;true&quot;/>`, `7758998750642765000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="xml"\n              >\n                <span class="gatsby-code-button-language">xml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="xml"><pre style="counter-reset: linenumber NaN" class="language-xml line-numbers"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>cacheEnabled<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>下图展示了 Mybatis 中二级缓存的生效范围。请注意，二级缓存是与命名空间（Namespace）强关联的，即如果在不同的命名空间下存在相同的查询 SQL，这两者之间也是不共享缓存数据的。在 Mybatis 中，Configuration 管理着所有的配置信息，所以所有的二级缓存相当于全部位于 Configuration 之内，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-12-16-11-30-21-1a5fa20d4205afcce4f1418347211d8b-e5c7b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 612px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 30.22875816993464%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABXElEQVQY0z2QWU/CUBSE+/+fcYlxiRvILrSUtlBKBEtZBAq0FNnBaMREDQKucTy9BB8m9/bkm9OZy5mmjOlExWiYJqlM49H6HPQVWC2BybYEtJo8hoMUYzfMRpOxiradAeeavr/KWC4KWC0Nprf5NX5/qnhfGbjtxGA1w2hbETTNIOaveQB1LN70f971fn4UcTfVwBV0P7qdOMpFLyplH1OvKzCz076kVBFUb/yokaxWlFgeZj1A9whKxvnaU/Kh3+VRNILgstoJVRPQ7wnrJHaUnkAh+AyNehDjYZLqRtFshMgksLueP8ZkJFH6OPthx4kTJyJ35QWnyAds+8tzDmYtAIcWPs2yyKh7MPRTqq8zY63qp7nGGDm5jdmjhof7NKqVC4wGSQohIaUcgSsaIeRzhxB4DyQCk+IWZGkHNlVyl4jCeu5KTHhY8o4TgyLvsm93niAmq+1T5TD+AGRPkys/H4WCAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 12 16 11 30 21" title="" data-src="/static/2024-12-16-11-30-21-1a5fa20d4205afcce4f1418347211d8b-e5c7b.png" data-srcset="/static/2024-12-16-11-30-21-1a5fa20d4205afcce4f1418347211d8b-ec56c.png 200w,\n/static/2024-12-16-11-30-21-1a5fa20d4205afcce4f1418347211d8b-73c25.png 400w,\n/static/2024-12-16-11-30-21-1a5fa20d4205afcce4f1418347211d8b-e5c7b.png 612w" data-sizes="(max-width: 612px) 100vw, 612px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>回到代码，我们在 org.apache.ibatis.cache 包下试图寻找关于二级缓存的相关实现。但是，我们什么也没有找到。我们可以想象一下二级缓存实际上是跟 SQL Mapper 紧密相关的，因为命名空间位于 Mapper 中。所以，相关代码是否是与 Mapper 实现放在一起呢？答案是肯定的，我们在 org.apache.ibatis.mapping 包下找到了这么一个类：CacheBuilder。</p>\n<p>从命名上看，CacheBuilder 类的作用就是构建一个 Cache，这个过程通过它的 build 方法实现，该方法代码如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26123574200737520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public Cache build() {\n   // 设置缓存默认实现\n   setDefaultImplementations();\n   Cache cache = newBaseCacheInstance(implementation, id);\n   // 设置缓存属性\n   setCacheProperties(cache);\n   if (PerpetualCache.class.equals(cache.getClass())) {\n      for (Class<? extends Cache> decorator : decorators) {\n         cache = newCacheDecoratorInstance(decorator, cache);\n         setCacheProperties(cache);\n      }\n      // 对缓存执行装饰\n      cache = setStandardDecorators(cache);\n   } else if (!LoggingCache.class.isAssignableFrom(cache.getClass())) {\n      cache = new LoggingCache(cache);\n   }\n   return cache;\n}`, `26123574200737520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Cache</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 设置缓存默认实现</span>\n   <span class="token function">setDefaultImplementations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token class-name">Cache</span> cache <span class="token operator">=</span> <span class="token function">newBaseCacheInstance</span><span class="token punctuation">(</span>implementation<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 设置缓存属性</span>\n   <span class="token function">setCacheProperties</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">PerpetualCache</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Cache</span><span class="token punctuation">></span></span> decorator <span class="token operator">:</span> decorators<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         cache <span class="token operator">=</span> <span class="token function">newCacheDecoratorInstance</span><span class="token punctuation">(</span>decorator<span class="token punctuation">,</span> cache<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token function">setCacheProperties</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// 对缓存执行装饰</span>\n      cache <span class="token operator">=</span> <span class="token function">setStandardDecorators</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">LoggingCache</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoggingCache</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">return</span> cache<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们先来看该方法的第一句，即调用 setDefaultImplementations 方法，该方法设置默认的缓存实现，这时候创建的实际上就是一个 PerpetualCache 类。然后，遍历装饰类接口，通过 setStandardDecorators 方法对 PerpetualCache 添加对各种装饰类的包装，从而构建出 PerpetualCache → LruCache → ScheduledCache → SerializedCache → LoggingCache → SynchronizedCache 这样一个装饰链，装饰器模式在这里得到了完美的应用，</p>\n<p>现在，各种缓存装饰类的创建方法有了，那么谁来用呢？让我们跟踪 CacheBuilder 类的使用者。在 Mybatis 中，只有一个地方调用了 CacheBuilder 类，这就是 MapperBuilderAssistant 类。</p>\n<p>在该类中存在一个 useNewCache 方法，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11318463908602405000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public Cache useNewCache(\n   Class<? extends Cache> typeClass,\n   Class<? extends Cache> evictionClass,\n   Long flushInterval,\n   Integer size,\n   boolean readWrite,\n   boolean blocking,\n   Properties props\n) {\n   Cache cache = new CacheBuilder(currentNamespace)\n      .implementation(valueOrDefault(typeClass, PerpetualCache.class))\n      .addDecorator(valueOrDefault(evictionClass, LruCache.class))\n      .clearInterval(flushInterval)\n      .size(size)\n      .readWrite(readWrite)\n      .blocking(blocking)\n      .properties(props)\n      .build();\n   configuration.addCache(cache);\n   currentCache = cache;\n   return cache;\n}`, `11318463908602405000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Cache</span> <span class="token function">useNewCache</span><span class="token punctuation">(</span>\n   <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Cache</span><span class="token punctuation">></span></span> typeClass<span class="token punctuation">,</span>\n   <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Cache</span><span class="token punctuation">></span></span> evictionClass<span class="token punctuation">,</span>\n   <span class="token class-name">Long</span> flushInterval<span class="token punctuation">,</span>\n   <span class="token class-name">Integer</span> size<span class="token punctuation">,</span>\n   <span class="token keyword">boolean</span> readWrite<span class="token punctuation">,</span>\n   <span class="token keyword">boolean</span> blocking<span class="token punctuation">,</span>\n   <span class="token class-name">Properties</span> props\n<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token class-name">Cache</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CacheBuilder</span><span class="token punctuation">(</span>currentNamespace<span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">implementation</span><span class="token punctuation">(</span><span class="token function">valueOrDefault</span><span class="token punctuation">(</span>typeClass<span class="token punctuation">,</span> <span class="token class-name">PerpetualCache</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">addDecorator</span><span class="token punctuation">(</span><span class="token function">valueOrDefault</span><span class="token punctuation">(</span>evictionClass<span class="token punctuation">,</span> <span class="token class-name">LruCache</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">clearInterval</span><span class="token punctuation">(</span>flushInterval<span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">readWrite</span><span class="token punctuation">(</span>readWrite<span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">blocking</span><span class="token punctuation">(</span>blocking<span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">properties</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   configuration<span class="token punctuation">.</span><span class="token function">addCache</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   currentCache <span class="token operator">=</span> cache<span class="token punctuation">;</span>\n   <span class="token keyword">return</span> cache<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，二级缓存被成功创建并保存在 configuration 对象中，接下来讨论如在查询过程中使用二级缓存。</p>\n<p>首先明确一点，在 Mybatis 中，如果开启了二级缓存，那么所有的 SQL 执行过程都将由 CachingExecutor 负责。顾名思义，CachingExecutor 是带有缓存机制的 Executor，我们对 Executor 已经有了足够的了解，所以直接来看它的 query 方法，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64378144681488570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Override\npublic <E> List<E> query(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql) throws SQLException {\n   // 获取缓存对象\n   Cache cache = ms.getCache();\n   if (cache != null) {\n      // ...\n   }\n   return delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);\n}`, `64378144681488570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">MappedStatement</span> ms<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameterObject<span class="token punctuation">,</span> <span class="token class-name">RowBounds</span> rowBounds<span class="token punctuation">,</span> <span class="token class-name">ResultHandler</span> resultHandler<span class="token punctuation">,</span> <span class="token class-name">CacheKey</span> key<span class="token punctuation">,</span> <span class="token class-name">BoundSql</span> boundSql<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 获取缓存对象</span>\n   <span class="token class-name">Cache</span> cache <span class="token operator">=</span> ms<span class="token punctuation">.</span><span class="token function">getCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>cache <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// ...</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">return</span> delegate<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> parameterObject<span class="token punctuation">,</span> rowBounds<span class="token punctuation">,</span> resultHandler<span class="token punctuation">,</span> key<span class="token punctuation">,</span> boundSql<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在该方法体的第一行代码中，我们通过 MappedStatement 获取的 Cache 对象就是前面保存在 Configuration 中的 Cache 对象。</p>\n<h2 id="解题要点-20"><a href="#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-20" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解题要点</h2>\n<p>关于 Mybatis 中缓存机制的面试题，一般都会考查所谓的一级缓存和二级缓存。从考点上，因为比较容易混淆，我们首先需要明确这两种缓存的区别，可以从缓存的作用范围进行记忆，作用范围小的是一级，反之是二级。同时，我们也要明确，这种面试题往往会考查实现原理而不仅是简单应用，因为在 Mybatis 中缓存的应用更多是被动触发的，而不是由开发人员主动进行控制的。</p>\n<p>Mybatis 中的一级缓存实际上就是一个 HashMap，并没有太多涉及到缓存管理方面的操作。同时，我们需要解释一下一级缓存与 BaseExecutor 之间的关系，在 Executor 执行具体的查询操作时，就会使用到一级缓存。如果缓存中找不到对应数据才会执行数据库查询。作为加分项，这里可以重点解释一下 Mybatis 中 CacheKey 的实现方法，这也是 Mybatis 框架本身在设计上的一大亮点。这些内容，确实需要结合源代码才能够理解的更加清晰明白，建议大家还是要阅读 PerpetualCache、BaseExecutor 等核心类中的代码执行主流程。</p>\n<p>相较一级缓存，二级缓存更为复杂，因为需要更多关注于缓存对象的生命周期以及具体的缓存策略。有时候，这个考点也可以和装饰器模式结合在一起进行考查。针对二级缓存，我们也是从应用方法上进行切入。二级缓存的启动需要我们通过配置项进行控制，而它的作用范围则取决于 Mybatis 的命名空间定义。</p>\n<p>在实现原理上，针对二级缓存的回答内容需要包含两个要点。第一个要点是通过装饰器模式来构建具体种类的缓存对象，这块我们可以结合设计模式相关内容进行展开；第二个要点是它与 CachingExecutor 之间的交互关系。</p>\n<h2 id="小结与预告-18"><a href="#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-18" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结与预告</h2>\n<p>本讲内容关注于分布式系统构建过程中不可缺少的一个技术组件，即缓存。</p>\n<p>缓存是一个比较复杂的话题，也具有非常多的应用场景。针对应用层缓存，我们通常采用的是分级模式，从而更好地实现对缓存对象的存储和管理。同时，我们以 Mybatis 框架为例分析了它所具备的分级缓存模式。在 Mybatis 中，存在一级缓存和二级缓存。其中，一级缓存的作用范围较小，只能应用于请求级别或会话级别。而二级缓存具备更大作用范围，能够在应用程序级别确保目标对象得到缓存。我们对这两种缓存机制的底层实现原理都进行了详细的展开。</p>\n<p>从资源管理角度讲，缓存也是一种有效管理资源的技术手段。而除了缓存，业界也存在一些专门用来管理资源的技术组件，资源池就是其中的代表。那么，什么是池化操作？如何实现一个资源池？我们下一讲将对这些问题展开详细的讨论。</p>\n<h1 id="资源管理：什么是池化操作？如何实现一个资源池？"><a href="#%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%EF%BC%9A%E4%BB%80%E4%B9%88%E6%98%AF%E6%B1%A0%E5%8C%96%E6%93%8D%E4%BD%9C%EF%BC%9F%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E8%B5%84%E6%BA%90%E6%B1%A0%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>资源管理：什么是池化操作？如何实现一个资源池？</h1>\n<p>在上一讲中，我们介绍了缓存这一技术组件，并重点对多级缓存的设计思想和实现策略进行了详细的展开。本质上，缓存体现的是一种对资源利用效率进行合理管理的技术手段。</p>\n<p>资源管理对于软件系统开发而言是一个很大的话题，同时也是一个很通用的话题。在本讲内容中，我们继续围绕资源管理这一话题进行展开，并聚焦于资源池这一技术组件。</p>\n<p>那么，什么是池化操作？如何实现一个资源池？让我们带着这些问题来学习本讲内容。</p>\n<h2 id="问题背景-18"><a href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-18" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题背景</h2>\n<p>对于任何类型的应用程序而言，开发人员所处理的对象本质上都是各种资源（Resource）。所谓资源，在软件架构设计和实现过程中有很多表现形式，例如数据库会话、网络连接、分布式服务和组件等都可以认为是系统的资源，都需要进行管理，而性能、可伸缩性、灵活性则是资源管理的基本需求。</p>\n<p>我们知道资源本质上代表着一种系统运行的成本，我们需要尽量减少这种成本。那么，如何有效管理资源呢？就分布式系统开发而言，我们通常都可以引入资源池的概念和实现机制。</p>\n<p>资源池是一个最常见、也是最通用的资源管理技术组件。围绕这个技术组件，面试官也会提出各种问题来考查候选人，常见的提问方式包括：</p>\n<ul>\n<li>你能列举你所知道的资源池应用场景吗？它们各自有什么需求特点？</li>\n<li>如果让你自己实现一个资源池，你会怎么做？</li>\n<li>如果资源池中已经没有资源了，资源池应该怎么做？</li>\n<li>数据库连接池有哪些核心参数？</li>\n<li>你知道 Mybatis 是如何有效管理数据库连接的吗？</li>\n<li>你能简要描述 Mybatis 中对数据库连接对象 Connection 的管理过程？</li>\n</ul>\n<p>虽然具体的资源池表现形式有多种，但基本的组成结构和实现原理大同小异。接下来，我们围绕这些问题来对资源池的概念和特性做进一步分析。</p>\n<h2 id="问题分析-19"><a href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-19" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题分析</h2>\n<p>在计算机编程领域中，池（Pool）是一种对资源的抽象方法，代表一组可以使用的资源，但这些资源不能随时被创建和释放。在架构模式中，也存在一种资源池（Resource Pool）模式。客户端向资源池请求资源，在获取到资源之后就可以用它来完成特定的任务。一旦任务完成，这个资源又可以被回收到资源池继续进行使用。</p>\n<p>一个典型的资源池的组成结构如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-12-17-11-35-43-adea505ad97e6e0ee56ba27d5620ccea-a40ca.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 647px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 46.21329211746522%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAAB9klEQVQoz12Sa0/iUBRF+f//Y77MoPIQRV4C4ogjIhTBgmBLaXlneBShLZQ1BxKNzkluzk3au7LP2TsQbyaJGikiWoLIW4K4lSVcD/PSytG3qnLK9PsqrrfF931m8zlPvR6Pgz4PpokyGLBerznUfr8nEG3FaM/yNPopWqMM5WGaYOME9TVOtRLluRal3S6yWCzZbDaYlsVlvU608cJppUqm08FeLr8A1RhNAd4oQUqv5zwNM1zNs1TN+vGnv7O5KHD4VvLQ327Z73aw8799CiSta9ICDHViXJgJcsvfZDe3qJPmx2uWywWTyYjt1sHzNnLcT4ArYMfzjn3jugTOaiEsGbPVjGBolzT0OAlRqI6bn49se0FNCVF5+iUrOEGpRugZJpquE6xU+Ckr+PFY5rzbFYVmhrx9y5ka5sKIU1gVuV4XaE5bX2cUc9roWl2U6kynpqjd4YgibTymMxrRHg7Rp1MCMVl+bZrlj3ZBxUpSkh2m7DwlXWHvIeOuxZCVGOJ8sPFdj53jSHf5vwIR9ZxnUVYUU8ovIW5F6cHlrpXD0AsY3RyKkpGxBfq+omT2yEpc8hKdG7lPJEaH2kmk/IPL6V6Ou22Zq+E1pxKhm/cHkpZESMuhde4xew+yr9oRuJJ4VAVWMAwKbxp30me2fQQeYIfY/AN0ZY4vLYmN3AAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 12 17 11 35 43" title="" data-src="/static/2024-12-17-11-35-43-adea505ad97e6e0ee56ba27d5620ccea-a40ca.png" data-srcset="/static/2024-12-17-11-35-43-adea505ad97e6e0ee56ba27d5620ccea-3426a.png 200w,\n/static/2024-12-17-11-35-43-adea505ad97e6e0ee56ba27d5620ccea-f3a4f.png 400w,\n/static/2024-12-17-11-35-43-adea505ad97e6e0ee56ba27d5620ccea-a40ca.png 647w" data-sizes="(max-width: 647px) 100vw, 647px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>基于资源池的基本结构，我们可以进一步分析它的应用场景。作为一种通用的技术组件，资源池的应用场景包括以下几类：</p>\n<ul>\n<li>管理那些初始化代价非常大的对象；</li>\n<li>面向请求资源的频率很高且使用资源总数较低的业务处理过程；</li>\n<li>当系统面临性能问题时用来降低访问时间的延迟。</li>\n</ul>\n<p>资源池的主要特点在于节省了创建资源实例的开销和时间，但存储空间会随着对象的增多而增大。当我们面对资源池相关的面试问题时，我们首先需要基于日常开发过程中最常见，或者是自己平时最擅长的一种具体的资源池进行展开。例如，任何一个应用程序都需要访问数据库，也就需要引入数据库连接池（Connection Pool）。连接池就是一项适合进行深入挖掘的资源池技术。我们需要明确它的基本工作流程以及核心功能特性。</p>\n<p>一旦明白了连接池等具体资源池的工作流程和功能特性，我们就可以基于具体某一款开源框架来深入分析底层的设计方法和实现原理。这部分内容同样需要候选人平时有足够的积累，并在面试过程中能够以自己的语言进行总结和提炼。</p>\n<h2 id="技术体系-21"><a href="#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-21" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术体系</h2>\n<p>在接下里的内容中，我们将基于 Mybatis 框架来对连接池这一代表性的资源池展开讨论。在介绍 Mybatis 数据库连接池之前，我们有必要对连接池的实现机制有个总体的把握。因此，我们先来全面梳理连接池的工作流程和核心要素，然后在此基础上详细阐述 Mybatis 中对数据库连接对象 Connection 的获取过程。</p>\n<p>一个连接池的基本工作流程包含三个环节，即连接池的创建、管理和关闭。但作为一项应用广泛的池化技术，连接池在每一个环节也有一些自身的特点。</p>\n<p>在连接池中，对连接的管理策略是重点，也在很大程度上决定了不同连接池之间在实现上的差别。</p>\n<p>常见的实现策略是这样：当客户端请求连接时，首先查看连接池中是否有空闲连接，如果存在空闲连接，则将连接分配给客户端使用；如果没有空闲连接，则查看当前所开的连接数是否已经达到最大连接数，如果没达到就重新创建一个连接给到请求的客户端；如果达到就按设定的最大等待时间进行等待，如果超出最大等待时间，则抛出异常给客户端。整个流程如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-12-17-11-36-44-7a3abfe8d257fc53ef7890fe3d2dc082-9e167.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 538px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 90.33457249070632%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsSAAALEgHS3X78AAACSElEQVQ4y41Ta2/aUAzN//8Z+zBN24d2k9jWVtM0de1UIANawiNAQ2AJULIkBEgCeZzZF8JSBC2WrJtcOyfHx7YEsjRN+IBhaKhV3+PX7RvI5beQ5Q9wHAubnPQkl7JkNm9mYzSqo9MpoqPe4c/wAfO5hyRJEccx8rnHTMoS8onrNbN9gut6mEwmGA6H4txneoi5lL/MrFq9RrMpb9+OMzrEVtqAJSLo+0ssFktomgK938ZqtcZyuSQdbdi2LVg6jiNO13VxiIyUR7ftGTxvLp7jOIVlWQLU93269wTIYrEQoPyjg4C6fk961dDrFVGpXFHyeBdktt1ui0CD00tut66gtguoVs4I9DNMo0Vd3QSjKEGpdEl6lsV7kiRHm7IDnM9ZI5fKmdE5243HRjtHlMwyrKn1XG6e3dE5zIznjQE2jekTqL/VM4Gq9khjl+4CAo9en8MwjNDt3KD+cEbbck6b8o4kKImY9ihT17/ivnaOp8kPKMo3TKd/iUBMBFbCgyAgiaL/gMzOMFTS64bYFAn8DqbZE7HxSMNkXBfbU/l9SRvUFOwZgJ1lYsAwDJ+v3imd9DyeVZ9GKRTzaJomETGExs8YZgPOncz8UIyNV7HRkBHQIvBdxpJBpZeY7Y9GFK1FabZtkcYXxG5ATAMCi4SzlhJesf2SecwYhK/9IBTlZ8bbdRJDa2piOFAw0BVi9p2YPW43aUYLcY12q0zxBnSKSy8zS8XW6H3+oAC19ZE6foHB4CeVl2A87lDHv1D3P0HXCvSDW/wDuT5rwp5dW+AAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 12 17 11 36 44" title="" data-src="/static/2024-12-17-11-36-44-7a3abfe8d257fc53ef7890fe3d2dc082-9e167.png" data-srcset="/static/2024-12-17-11-36-44-7a3abfe8d257fc53ef7890fe3d2dc082-bd273.png 200w,\n/static/2024-12-17-11-36-44-7a3abfe8d257fc53ef7890fe3d2dc082-7e34d.png 400w,\n/static/2024-12-17-11-36-44-7a3abfe8d257fc53ef7890fe3d2dc082-9e167.png 538w" data-sizes="(max-width: 538px) 100vw, 538px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>围绕上述介绍的连接池的管理方式，我们可以抽象出一些控制参数，常见的参数包括最小空闲连接数（MinIdle）、最大空闲连接数（MaxIdle）、连接池最大活跃连接数（MaxActive）、最大超时时间（MaxTimeout）等。</p>\n<p>对于连接池而言，性能是我们选择不同实现工具的首要考虑因素。基于已知内容，我们可以进一步分析连接池内连接的分配和释放对系统性能的影响：</p>\n<ul>\n<li>如果将总连接数的上限设置得过大，可能因连接数过多而导致数据库僵死，系统整体性能下降；</li>\n<li>如果总连接数上限过小，则无法完全发挥数据库的性能，浪费数据库资源。</li>\n</ul>\n<p>另一方面：</p>\n<ul>\n<li>如果将空闲连接的上限设置得过大，则会浪费系统资源来维护这些空闲连接；</li>\n<li>如果空闲连接上限过小，当出现瞬间的峰值请求时，系统的快速响应能力就比较弱。</li>\n</ul>\n<p>所以在设置数据库连接池的这些参数时，需要进行测试和权衡，不同的实现方案会有不同的考虑。</p>\n<p>介绍完连接池的基本概念之后，接下来我们将花较大的篇幅来介绍 Mybatis 中的数据库连接池，以帮助你理解池化技术在开源框架中的实际应用。</p>\n<h2 id="源码解析-19"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-19" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h2>\n<p>与上一讲介绍 Mybatis 缓存时采用的自下而上（即从底层实现类 PerpetualCache 出发向上游逐层分析直到系统的访问入口 SqlSession）的分析方法不同，我们将采用自上而下的策略来介绍数据库连接池，即从如何获取连接 Connection 对象开始逐步分析其背后的池化操作。</p>\n<p>我们在介绍 Mybatis 缓存时，已经明确了 DefaultSqlSession 会调用 CachingExecutor，然后 CachingExecutor 是 BaseExecutor 的实现类，而 BaseExecutor 实现了 Executor 接口，该接口提供了多种用于数据 CRUD 的方法。有了这层调用链，我们可以想象，为了获取与数据库访问相关的 Connection，入口应该位于 BaseExecutor 中的几个与数据库访问直接相关的方法中。</p>\n<p>我们直接来到 BaseExecutor 的子类 SimpleExecutor 中的 doQuery 方法。在该方法中我们看到了一个 prepareStatement 方法，进一步猜想获取 Connection 应该是在这一方法中。让我们来看一下这个方法的实现过程，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11395759612642652000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`private Statement prepareStatement(StatementHandler handler, Log statementLog) throws SQLException {\n   Statement stmt;\n   Connection connection = getConnection(statementLog);\n   stmt = handler.prepare(connection, transaction.getTimeout());\n   handler.parameterize(stmt);\n   return stmt;\n}`, `11395759612642652000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Statement</span> <span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token class-name">StatementHandler</span> handler<span class="token punctuation">,</span> <span class="token class-name">Log</span> statementLog<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>\n   <span class="token class-name">Statement</span> stmt<span class="token punctuation">;</span>\n   <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token function">getConnection</span><span class="token punctuation">(</span>statementLog<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   stmt <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> transaction<span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   handler<span class="token punctuation">.</span><span class="token function">parameterize</span><span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> stmt<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>果然，在这里我们看到了获取 Connection 对象的 getConnection 方法，该方法如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23125663363666395000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`protected Connection getConnection(Log statementLog) throws SQLException {\n   Connection connection = transaction.getConnection();\n   if (statementLog.isDebugEnabled()) {\n      return ConnectionLogger.newInstance(connection, statementLog, queryStack);\n   } else {\n      return connection;\n   }\n}`, `23125663363666395000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token class-name">Log</span> statementLog<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>\n   <span class="token class-name">Connection</span> connection <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>statementLog<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token class-name">ConnectionLogger</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> statementLog<span class="token punctuation">,</span> queryStack<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> connection<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们发现 getConnection 实际上是 Transaction 接口的一个方法。除了 getConnection 方法之外，Transaction 作为事务类还包含 commit 和 rollback 等事务处理相关方法。在 Mybatis 中，Transaction 接口有两个实现类，即 JdbcTransaction 和 ManagedTransaction。无论哪种方案，我们在各自的 getConnection 方法中都能看到如下所示的语句：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18929443646477550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`this.connection = this.dataSource.getConnection();`, `18929443646477550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">this</span><span class="token punctuation">.</span>connection <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dataSource<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>显然，我们是通过 DataSource 来获取 Connection 对象。以执行查询操作的 query 方法为例，获取 Connection 对象的整体工作流程如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-12-17-11-38-25-958935f9b16ae8c25620326e655f7577-32a72.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 350px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 126.85714285714285%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAYAAAAxFw7TAAAACXBIWXMAAAsSAAALEgHS3X78AAAEnElEQVQ4y41VaVMiSRTs//8PdscZYx0Hj1GRs4EGAWnlauQ+upvmVPACGcdbnNysAid2IvaDRmQUVf2q6tXLl6mSOnQBGBItooOnhwxs04O25cXpMIxW3Y3TQQjN+g563QDXQhifRTCdJBhvEjZhEX10uxoUTdtiYAi2FYTTVlEq7kALf0YkvCKRSq5zvkJ8QjT6BVHtC5KJNeQy27BaAbRtVe7tOirSx24ok8kUrWYLtm3Dsiwe6qDf72FA9HtdDIcDVCplxjTQ6bRhmi00GjU5yj2mxQMtecZ4fA4FH/i7uprg8fEZNzcz5PMFNJsmpvz9f39Kr9dBLqujUMigYKQXKKRRLudwwrV67QS7uxvY2vyKcimPbDYl13M5HQZjjeUesW6aTShR7Rse7o8xvU7iZnqI2c0hrq/irI8H5+Mohv0QOm0/Ls5jcn52GsHoTGNcSsYLTCdJ3P3UUTzxQIkfrDPRJnFClIgy3uZ5JA7+RurwM0n5wsBNvkJkuMXCr/KyfcZViOISYi/r2gxCMQwduu7F8XEAx0cCfm4K8AmqnGcyIbLqRiK+z/ppODmJybVclsiFYXAtlw0jm1FZqtTHSJlOZ3h+ecX19ZQX5SUptu2wK9qoVuuo1RtybTy+gDKfv3HDD9bkliz+iclkhp8/H5BM6sik86jXW3xNGh2nx9Yx0W53USpVeZjFgxu4vLyCoushsuRl6j4ytkTeyzUfKmUVjXoER0fbOExuMKMEzNYBmz/Ig1Q5Vsoh1lYlgnx6BEoisS5lsyDGXEqQUvpVYPf7MBwIqWkYkd225cYZpbcg5D1WoEE47IawkN4mnxDkzX52fYBYjK2GD/HYKg6IUPAvREKfENNWpOya/Na2FrG23BOgwgIkcw/KlNITkus4Dpz/QMwHgz5GozPWriabdjwe0QA6qFWrco+Qnm3Z/Gai1RLSG3+U5SleX1+lVqOxGC/s8JDFgYZhoMILarUaLx9Bmc1m6EkT6MuM3nFKUxDj+fkY4XAI4ZDKrEQmDWbpkGFbZus4bb6mzUxNXFywbVR1nRbko1t4f8NsefmsPdSrbv4WbO/SD/dZp+Cydj4J8e19dChPPfWdLMfXlwZZWrInUMf1ZRzFwgaO9VW20DeUi5skYxdFwyW1D1SlTBcoSaYtS4WSSoUlO5m0Z4l9yshDHe/QTDegRVxkeQ1q8B/E46Ifd9lvPl4SYL/65VgwgrKPM+nwgpSXlzcW/U/M57/w9vZLkiIkd3f3gPv7B9atR/RZ8zNiRDM+pfH2ycNA+uWHWLbtDhk85+YhZZiSm206uxhLpQqJsiSk9MrlPJ1G5TM0Cj/yG/mcxmdEaf8pBAMueD1rJCdJzaYouQRdJy5RKiYlCkaMppwVBrvGHPLSIB/uj2TBnx7TuLzQKD0v+l0/5adSemE4tkfOb2eHMvb+TkDH3a2O+WsW1TINNhZzSZaenvJ4eTYk5q8Fujazqeww029LuPifziXN9vbHkYx5eV7seeZeYbSVsg9KpVLC9+2v2Hdvwr23sYRLzr2ebfj9OwgQft/33xDf9hjzHi/m21tr7I4j/AuGe9vbsdxOlwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 12 17 11 38 25" title="" data-src="/static/2024-12-17-11-38-25-958935f9b16ae8c25620326e655f7577-32a72.png" data-srcset="/static/2024-12-17-11-38-25-958935f9b16ae8c25620326e655f7577-47adc.png 200w,\n/static/2024-12-17-11-38-25-958935f9b16ae8c25620326e655f7577-32a72.png 350w" data-sizes="(max-width: 350px) 100vw, 350px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="pooleddatasource"><a href="#pooleddatasource" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>PooledDataSource</h3>\n<p>DataSource 是 JDBC 中定义的接口，Mybatis 实现了该接口，并提供了三种实现方案，相关的工厂类和实例类类层关系如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-12-17-11-39-19-b5e44e1339138e81a77837f16e603a64-0f06a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 643px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 39.03576982892691%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABpUlEQVQoz4VSa0/CQBDsX/ePqGDwGVE/qFFR64M3LX0BQi1QKLaCCokKFFrGscT4TS+Z5G5vb3dm9gSzcQ1F3oeuJeE4KjzXQrdzDlU5ZDyJVvMU3a6CBYDFIiQWf0KoGCfI3K9CKsZZSCJqUMoJZNOxCKVCDI9mBj9r+TBcIgx/90TIs/Ds2RgNHViPGiyrgeHwFdVqKWLqeS3Ydg2u62AymWE69fHfEn42/X4Lhn6GWjWFZjPLAj6eegob3TJ+Qekieo6M8XgMu62haUm8k5gro90qR5BlEUIQzKOCHcrV1A0Y2hbqD0cYDPr09QBqOU4/NxnbRbVyHMUL+W0ijmwmhnwuTrsSEdbXVn4ZPvU6lKxQZh2mqcKfBZFk120QJgdT4dBMBEFA9u8I5hNa8IGXFw/z+Ri+/4m3twEEQ78kkxRlpVjUZPIUun5NNleoGDf084ZDKdDwZeMZG9ltFQ81kfciLRJRr98xJw2na0EoS3uQSnuQpW0G8xiNXpG+26CEHeSyCRTzmygVk2QwjQpOOBjDSPEnLN9p6rctSZI6hKbl8AUfEUGZkxncNAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 12 17 11 39 19" title="" data-src="/static/2024-12-17-11-39-19-b5e44e1339138e81a77837f16e603a64-0f06a.png" data-srcset="/static/2024-12-17-11-39-19-b5e44e1339138e81a77837f16e603a64-66246.png 200w,\n/static/2024-12-17-11-39-19-b5e44e1339138e81a77837f16e603a64-2dbe7.png 400w,\n/static/2024-12-17-11-39-19-b5e44e1339138e81a77837f16e603a64-0f06a.png 643w" data-sizes="(max-width: 643px) 100vw, 643px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在上图中，我们重点要介绍的是 PooledDataSource，但也会涉及一部分 UnpooledDataSource 的内容，因为 PooledDataSource 也是构建在 UnpooledDataSource 的基础之上。</p>\n<p>在 PooledDataSource 类中，首先我们看到的是一组连接池的参数，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20385983441353404000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`protected int poolMaximumActiveConnections = 10;\nprotected int poolMaximumIdleConnections = 5;\nprotected int poolMaximumCheckoutTime = 20000;\nprotected int poolTimeToWait = 20000;\nprotected int poolMaximumLocalBadConnectionTolerance = 3;\nprotected String poolPingQuery = &quot;NO PING QUERY SET&quot;;\nprotected boolean poolPingEnabled;\nprotected int poolPingConnectionsNotUsedFor;`, `20385983441353404000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">int</span> poolMaximumActiveConnections <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>\n<span class="token keyword">protected</span> <span class="token keyword">int</span> poolMaximumIdleConnections <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>\n<span class="token keyword">protected</span> <span class="token keyword">int</span> poolMaximumCheckoutTime <span class="token operator">=</span> <span class="token number">20000</span><span class="token punctuation">;</span>\n<span class="token keyword">protected</span> <span class="token keyword">int</span> poolTimeToWait <span class="token operator">=</span> <span class="token number">20000</span><span class="token punctuation">;</span>\n<span class="token keyword">protected</span> <span class="token keyword">int</span> poolMaximumLocalBadConnectionTolerance <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>\n<span class="token keyword">protected</span> <span class="token class-name">String</span> poolPingQuery <span class="token operator">=</span> <span class="token string">"NO PING QUERY SET"</span><span class="token punctuation">;</span>\n<span class="token keyword">protected</span> <span class="token keyword">boolean</span> poolPingEnabled<span class="token punctuation">;</span>\n<span class="token keyword">protected</span> <span class="token keyword">int</span> poolPingConnectionsNotUsedFor<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里出现了最大空闲连接数（poolMaximumIdleConnections）、连接池最大持有连接数（poolMaximumActiveConnections）、最大存在时间（poolMaximumCheckoutTime）等核心参数，我们在前面介绍连接池的工作流程时都提到过这些参数，然后我们来看 PooledDataSource 的 getConnection 方法，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2986156918224081000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Override\npublic Connection getConnection(String username, String password) throws SQLException {\n   return popConnection(username, password).getProxyConnection();\n}`, `2986156918224081000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> <span class="token function">popConnection</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProxyConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们继续跟进，来到这里的 popConnection 方法，该方法非常长，但结构比较清晰。如果我们对连接池的管理方法有一定了解的话，理解这段代码难度并不大。为了更好地把握代码结构，我们对该方法的代码进行裁剪，只关注于主要的分支和流程，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50783564951960990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`private PooledConnection popConnection(String username, String password) throws SQLException {\n   while (conn == null) {\n      synchronized (state) {\n         if (!state.idleConnections.isEmpty()) {\n            // 如果 idle 列表不为空，表示有可用连接，直接选取第一个元素\n            conn = state.idleConnections.remove(0);\n         } else {\n            // 连接池没有可用连接的场景\n            if (state.activeConnections.size() < poolMaximumActiveConnections) {\n               // 如果 active 列表没有满，直接创建新连接\n               conn = new PooledConnection(dataSource.getConnection(), this);\n            } else {\n               // active 已经满了\n               // 获得使用最久的连接，判断是否已经超时\n               PooledConnection oldestActiveConnection = state.activeConnections.get(0);\n               long longestCheckoutTime = oldestActiveConnection.getCheckoutTime();\n               if (longestCheckoutTime > poolMaximumCheckoutTime) {\n                  // 已经超时，将原连接废弃并建立新连接\n                  conn = new PooledConnection(oldestActiveConnection.getRealConnection(), this);\n               } else {\n                  // 如果没有超时，则进行等待，并计算时间累加\n                  state.wait(poolTimeToWait);\n               }\n            }\n         }\n         if (conn != null) {\n            // 如果获取到了连接，则验证该连接是否有效\n            if (conn.isValid()) {\n               // 如果连接有效，更新该链接相关参数和状态\n            } else {\n               // 如果连接无效，且无效连接数量超过上限则抛异常\n            }\n         }\n      }\n   }\n\n   if (conn == null) {\n      // 如果最终无法获取有效连接，则同样抛异常\n   }\n\n   return conn;\n}`, `50783564951960990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">PooledConnection</span> <span class="token function">popConnection</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>\n   <span class="token keyword">while</span> <span class="token punctuation">(</span>conn <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span>idleConnections<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 如果 idle 列表不为空，表示有可用连接，直接选取第一个元素</span>\n            conn <span class="token operator">=</span> state<span class="token punctuation">.</span>idleConnections<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 连接池没有可用连接的场景</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>activeConnections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> poolMaximumActiveConnections<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token comment">// 如果 active 列表没有满，直接创建新连接</span>\n               conn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PooledConnection</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n               <span class="token comment">// active 已经满了</span>\n               <span class="token comment">// 获得使用最久的连接，判断是否已经超时</span>\n               <span class="token class-name">PooledConnection</span> oldestActiveConnection <span class="token operator">=</span> state<span class="token punctuation">.</span>activeConnections<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n               <span class="token keyword">long</span> longestCheckoutTime <span class="token operator">=</span> oldestActiveConnection<span class="token punctuation">.</span><span class="token function">getCheckoutTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n               <span class="token keyword">if</span> <span class="token punctuation">(</span>longestCheckoutTime <span class="token operator">></span> poolMaximumCheckoutTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                  <span class="token comment">// 已经超时，将原连接废弃并建立新连接</span>\n                  conn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PooledConnection</span><span class="token punctuation">(</span>oldestActiveConnection<span class="token punctuation">.</span><span class="token function">getRealConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n               <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n                  <span class="token comment">// 如果没有超时，则进行等待，并计算时间累加</span>\n                  state<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>poolTimeToWait<span class="token punctuation">)</span><span class="token punctuation">;</span>\n               <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 如果获取到了连接，则验证该连接是否有效</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>conn<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token comment">// 如果连接有效，更新该链接相关参数和状态</span>\n            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n               <span class="token comment">// 如果连接无效，且无效连接数量超过上限则抛异常</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 如果最终无法获取有效连接，则同样抛异常</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">return</span> conn<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在上述代码中，我们添加了很多注释来解释用于获取 Connection 的 popConnection 方法的整体流程，而不关心具体细节，整体流程如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-12-17-11-40-42-ac05af9cf25831f81f35a8af793b8821-92ba0.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 636px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 68.23899371069182%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAACFklEQVQ4y41UC3OaQBDm//+NNFPTx3SaadrOOG06tU18hSRGK/IKeoAGQQRRfIBfl2NiNCaZ3MzC3d7ex+633yGARhCM0JFOcNP4hNLvA/wpvcH52Vso8heo6t8sBOt1itcMIXssFnN4roGho8OyOrjVbyDLInq9JkymYD5fZJAEmlv+gYf5DuBj53K5gqapGA49RFFMNkMcxzsxTwHtAGblJMmKB1qWgXq9SFkvuC+KJphOpxu7B382w+3FeBzSgSWfu64Lz/PIfDiOw+eZLwiClwFNsw3LbBFvl2g1zyjDFnx/wDcZM9C39b1D92DbfG4ApXaRunsMVSlC135QM76h35f5puPYkKQqlR09y9tjv5CSGpJkjew9my2opIiXqSgqb1BefrbWEIYRxcyJy7xZabqfqbCtMcau0f53TPr7Tll/xmQyxqAvESWnRMcJpPZXGLc/0TVOiYoSRp69x6ewvRiNBlyDjEmkP4nrc+zfoddtkDVpr0HUiBDFX3QRKrBtxpuUJMlDhk8Ru8XQzkrTZOLX5koIwykH8/3RRnJZpcJrxJpzFkPuXMA0M25TLFfJS8LOwYLQpRtiUFMYWY8oMAlAhq43KTOVmpByGhjrkCKasC0FPsW4bo+uLsXTuc1NyYailFE+P0C1XECtUsBF7R3q1SPUyK7E9/SRAUmpi0r5kHwF/jO5vvqIeu2Izh3iUvyA/+81KLYdPOXiAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 12 17 11 40 42" title="" data-src="/static/2024-12-17-11-40-42-ac05af9cf25831f81f35a8af793b8821-92ba0.png" data-srcset="/static/2024-12-17-11-40-42-ac05af9cf25831f81f35a8af793b8821-cf954.png 200w,\n/static/2024-12-17-11-40-42-ac05af9cf25831f81f35a8af793b8821-955d7.png 400w,\n/static/2024-12-17-11-40-42-ac05af9cf25831f81f35a8af793b8821-92ba0.png 636w" data-sizes="(max-width: 636px) 100vw, 636px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在整体流程上，当 Mybatis 执行查询时会首先从 idleConnections 列表中申请一个空闲的连接，只有当 idleConnections 列表为空时才会创建新连接。当然，PooledDataSource 并不允许无限创建新连接。当连接池中连接达到一定数量时，即使 idleConnections 列表为空，也不会再继续创建新连接，而是从 activeConnections 列表中找出使用最久的一个连接，判断其是否超时。如果超时，则将该连接废弃并创建新连接，否则线程会一直等待直到连接池中有新的可用连接。</p>\n<p>但是，我们还是注意到这里有一个 PooledConnection 类，通过 PooledDataSource 获取的连接就是这个类。该类是 Mybatis 自己设计的一个 Connection 类，让我们来看一下。</p>\n<p>在 PooledConnection 中我们首先应该注意到的是它的两个变量，即 realConnection 和 proxyConnection，它们的类型都是 Connection。从命名上看，其中的 realConnection 是真正通过 JDBC 驱动类建立的连接，而 proxyConnection 是一个代理连接，也是 PooledDataSource 返回的连接。</p>\n<p>PooledConnection 本身就实现了 JDK 的 InvocationHandler 接口，并提供了如下所示的 invoke 方法实现：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79008611210198270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Override\npublic Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n   String methodName = method.getName();\n   if (CLOSE.hashCode() == methodName.hashCode() && CLOSE.equals(methodName)) {\n      dataSource.pushConnection(this);\n      return null;\n   }\n\n   try {\n      if (!Object.class.equals(method.getDeclaringClass())) {\n         checkConnection();\n      }\n      return method.invoke(realConnection, args);\n   } catch (Throwable t) {\n      throw ExceptionUtil.unwrapThrowable(t);\n   }\n}`, `79008611210198270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>\n   <span class="token class-name">String</span> methodName <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>CLOSE<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> methodName<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> CLOSE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>methodName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      dataSource<span class="token punctuation">.</span><span class="token function">pushConnection</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token function">checkConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>realConnection<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">throw</span> <span class="token class-name">ExceptionUtil</span><span class="token punctuation">.</span><span class="token function">unwrapThrowable</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里的逻辑主要是 DataSource 的 pushConnection 方法。我们采用与 popConnection 方法相同的方式来介绍 pushConnection 方法，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6293912367352217000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`protected void pushConnection(PooledConnection conn) throws SQLException {\n   synchronized (state) {\n      // 从 active 列表中移除该连接\n      state.activeConnections.remove(conn);\n      // 如果是有效连接\n      if (conn.isValid()) {\n         // 如果满足 idle 列表没有填满且类型符合期望\n         if (state.idleConnections.size() < poolMaximumIdleConnections && conn.getConnectionTypeCode() == expectedConnectionTypeCode) {\n            state.accumulatedCheckoutTime += conn.getCheckoutTime();\n            // 则创建一个新的连接并放入 idle 列表中\n            PooledConnection newConn = new PooledConnection(conn.getRealConnection(), this);\n            // 唤醒线程\n            state.notifyAll();\n         } else {\n            // 如果不满足判断条件，则说明该连接已经不需要存储，直接关闭真正连接\n            conn.getRealConnection().close();\n         }\n      } else {\n         // 如果是无效连接，则记录\n      }\n   }\n}`, `6293912367352217000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">pushConnection</span><span class="token punctuation">(</span><span class="token class-name">PooledConnection</span> conn<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>\n   <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 从 active 列表中移除该连接</span>\n      state<span class="token punctuation">.</span>activeConnections<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 如果是有效连接</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>conn<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token comment">// 如果满足 idle 列表没有填满且类型符合期望</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>idleConnections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> poolMaximumIdleConnections <span class="token operator">&amp;&amp;</span> conn<span class="token punctuation">.</span><span class="token function">getConnectionTypeCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> expectedConnectionTypeCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            state<span class="token punctuation">.</span>accumulatedCheckoutTime <span class="token operator">+=</span> conn<span class="token punctuation">.</span><span class="token function">getCheckoutTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">// 则创建一个新的连接并放入 idle 列表中</span>\n            <span class="token class-name">PooledConnection</span> newConn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PooledConnection</span><span class="token punctuation">(</span>conn<span class="token punctuation">.</span><span class="token function">getRealConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">// 唤醒线程</span>\n            state<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 如果不满足判断条件，则说明该连接已经不需要存储，直接关闭真正连接</span>\n            conn<span class="token punctuation">.</span><span class="token function">getRealConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         <span class="token comment">// 如果是无效连接，则记录</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>结合 popConnection 方法，pushConnection 方法的整体执行流程也在意料之中。这里唯一需要注意一点在于 state.notifyAll 语句，该语句与 popConnection 方法中用于等待线程的 state.wait 语句相对应，从而唤醒了线程。这样，当 SQL 执行完成时，PooledDataSource 也不会直接关闭线程，而是将其加入到 idleConnections 中并唤醒所有等待线程。</p>\n<h3 id="unpooleddatasource"><a href="#unpooleddatasource" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>UnpooledDataSource</h3>\n<p>接下来我们来讨论 UnpooledDataSource。在 Mybatis 中，PooledDataSource 实际上也是依赖 UnpooledDataSource 来创建真正的连接，这点通过 PooledDataSource 类的构造函数可以得到印证，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51921304974048720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public PooledDataSource(String driver, String url, String username, String password) {\n   dataSource = new UnpooledDataSource(driver, url, username, password);\n   expectedConnectionTypeCode = assembleConnectionTypeCode(dataSource.getUrl(), dataSource.getUsername(), dataSource.getPassword());\n}`, `51921304974048720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">PooledDataSource</span><span class="token punctuation">(</span><span class="token class-name">String</span> driver<span class="token punctuation">,</span> <span class="token class-name">String</span> url<span class="token punctuation">,</span> <span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   dataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnpooledDataSource</span><span class="token punctuation">(</span>driver<span class="token punctuation">,</span> url<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   expectedConnectionTypeCode <span class="token operator">=</span> <span class="token function">assembleConnectionTypeCode</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dataSource<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dataSource<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所以，PooledDataSource 中的 dataSource 变量实际上就是一个 UnpooledDataSource 对象。在 PooledDataSource 中 的 popConnection 方法中，我们看到如下所示的语句：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81365011457971520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`conn = new PooledConnection(dataSource.getConnection(), this);`, `81365011457971520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java">conn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PooledConnection</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这里通过 UnpooledDataSource 获取了 Connection 并构建 PooledConnection 对象，所以前面提到的 PooledConnection 中的 realConnection 对象实际就是来自 UnpooledDataSource。</p>\n<p>我们有必要进一步分析一下 UnpooledDataSource 中获取 Connection 的过程。我们跟踪 UnpooledDataSource 的 getConnection 方法，找到如下所示的 doGetConnection 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5642923821643242000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`private Connection doGetConnection(Properties properties) throws SQLException {\n   initializeDriver();\n   Connection connection = DriverManager.getConnection(url, properties);\n   configureConnection(connection);\n   return connection;\n}`, `5642923821643242000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Connection</span> <span class="token function">doGetConnection</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>\n   <span class="token function">initializeDriver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token function">configureConnection</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> connection<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，这里回归到了熟悉的 JDBC，实际上就是基于 JDBC 中的 DriverManager 工具类来获取 Connection。</p>\n<h2 id="解题要点-21"><a href="#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-21" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解题要点</h2>\n<p>以我的经历，有时候在面试时会出现类似 <code class="language-text">如果让你实现一个简单的资源池，你会怎么做？</code> 这种开放式问题。这类问题对于面试者而言有利有弊，有利的点在于本身就没有标准答案，自由发挥的空间比较大，很多时候可以做到自圆其说。不利的点在于需要有比较好的反应能力，能够快速地针对某个具体问题给出灵活的解决方案，而不是像存粹考查知识体系的问题那样给出固定的回答即可。</p>\n<p>针对这道开放式问题，在回答上一般会有三个要点。我们首先需要简要阐述资源池的作用和基本结构，这块偏理论知识，点到就好。然后，我们明确对于池化操作而言，最终都需要有个存储容器来保存池化最新，所以需要在 JDK 容器中选择一种作为方案。最后，我们需要设计如何对资源池中对象进行操作的方法，这些方法需要考虑到线程的安全性。上述三个要点对于类似的问题都是可以直接套用的。</p>\n<p>针对具体的开发框架，面试官经常可能会抛出类似 <code class="language-text">简要描述 Mybatis 中对数据库连接对象 Connection 的管理过程？</code> 这样的问题。这种问题问的是 Connection 的管理过程，本质上还是在考查大家对连接池的理解程度，因为 Connection 的管理就是通过连接池来完成的。对于普通的应用场景而言，Connection 的管理对于开发人员是透明的，所以该题的考点有一定难度，需要面试者对 Mybatis 内部实现原理有深入的理解。</p>\n<p>在解答思路上，我认为这道题的主要挑战是梳理 Connection 在使用上的整个流程，该流程涉及到两大方面，即获取 Connection 和释放 Connection。为此，Mybatis 中分别提供了 popConnection 和 pushConnection 方法。这两个方法是需要明确点到的，这是一个要点。另一方面，在连接池的管理上，获取和释放 Connection 的过程并不是很复杂，无非就是要做很多判断和异常处理，但如何确保并发访问下新连接的创建和访问是一个难题，需要指出 Mybatis 在多线程处理上的实现方式，这是该问题的第二个要点。</p>\n<p>本讲详细介绍了 Mybatis 中 PooledConnection 类的设计思想和实现方法，同时也给出了 popConnection 和 pushConnection 这两个核心方法的流程细节，方便你进行学习。</p>\n<h2 id="小结与预告-19"><a href="#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-19" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结与预告</h2>\n<p>本讲主要关注于资源池模式本身的概念、模型和实现过程，并引出了数据库连接池这一典型的资源池应用方式。和上一讲一样，我们结合 Mybatis 框架具体分析了该框架中如何实现数据库连接池的设计理念和详细过程。</p>\n<p>从下一讲开始中，我们将转换视角，讨论与系统扩展性相关的话题。扩展性是一个很通用的话题，涉及面很广。下一讲，我们先来考虑开发框架本身的扩展性，我们将围绕框架与框架之间的集成过程来分析扩展性的表现形态和实现方式。</p>\n<h1 id="框架集成：如果需要实现两个框架之间的集成，有什么办法？"><a href="#%E6%A1%86%E6%9E%B6%E9%9B%86%E6%88%90%EF%BC%9A%E5%A6%82%E6%9E%9C%E9%9C%80%E8%A6%81%E5%AE%9E%E7%8E%B0%E4%B8%A4%E4%B8%AA%E6%A1%86%E6%9E%B6%E4%B9%8B%E9%97%B4%E7%9A%84%E9%9B%86%E6%88%90%EF%BC%8C%E6%9C%89%E4%BB%80%E4%B9%88%E5%8A%9E%E6%B3%95%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>框架集成：如果需要实现两个框架之间的集成，有什么办法？</h1>\n<p>在上一讲中，我们分析了以数据库连接池为代表的资源池的设计思想和实现方式。而在本讲内容中，我们将讨论一个非常常见但又不被开发人员所感知的技术组件，这就是框架集成组件。这里的框架集成，指的是第三方框架与 Spring 框架之间的集成。在现实开发环境中，无论使用的是 Dubbo 还是 Mybatis 框架，你会发现它们的使用方式和 Spring 框架是完全一致的。</p>\n<p>作为一个通用型的开发框架，Spring 为我们提供了非常强大的扩展功能。那么，这些扩展功能是如何运作的？如果需要实现两个框架之间的集成，我们又有什么办法呢？这是一个实战性非常强的话题，本讲内容将围绕这一话题展开讨论。</p>\n<h2 id="问题背景-19"><a href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-19" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题背景</h2>\n<p>在 Java 的世界中，我们知道 Spring 是当下最主流的开发框架，没有之一。而在使用 Dubbo、Mybatis 等开源框架时，我们发现可以采用和 Spring 完全一样的方式来使用它们，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-12-18-10-39-02-5675f1895f17a288490199d49fd1f2f4-a40ca.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 647px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 70.78825347758887%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAACBElEQVQ4y4VT227aQBD1/6tVpD72oS9VWlVVoVCggbZKIqVRoSHgGAfbcYyNufgaEEm5JLZPZ5cYoRArIx3NWJ6Z3TNnVsATS5KY+9HIxoWYhyTmcN78DLH1BbKUQ6tVxcNDTHnJBuu6dSxkNRwO++heFtGR8miefUKbGl5pJcjyL+zWJJtYyPrJ/Hw+x3K5hOd5cF2Xg8WDwQCO4yAMQ8xms5du+NiQcHt7h9VqBUVRYBgGfN8nBHT7IW/MGk6n0+yG2zNhlDW1Qiij/ucDUS/AGR+Sf4HyNsXtGY5HA6hKiQvy88c7HHx/i2u9BLFdQxQl2aLEccybMJ/GjHAURej3bU6TGftmswuCkOexnLQueaxj2Jkhs/v7mIvBjM1J0zQ+w3Rei8WCcqLnSiEo3QaM6wZ0vQHLPCeavyFdnHAxmDEV12L4JNJaUXaYLJ9S7gnM3hlMk9D7Sz3qEBr1ffrIo1LeQ636Bna/SPuXgx8EyLIwvIHSLdCyv0ex8Arfiq9JrI/wvRoEy1KpSRc9o8Oh6yK9hlNOK8vuaJ3a7Tr0K5HyWY1El7qEZSnPz5AJF9ANVVUnqjdE+x/RncO2R+j1LEwmk8zDhFTdDaL1sF13TCtTICoVyJ0q+QN6fl/RbNbSY7FTSxCe7lH6PbBNuM4RPPeIqJX5u/bcQ4qPNwpv16T4D6tuIyqEMq6tAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 12 18 10 39 02" title="" data-src="/static/2024-12-18-10-39-02-5675f1895f17a288490199d49fd1f2f4-a40ca.png" data-srcset="/static/2024-12-18-10-39-02-5675f1895f17a288490199d49fd1f2f4-3426a.png 200w,\n/static/2024-12-18-10-39-02-5675f1895f17a288490199d49fd1f2f4-f3a4f.png 400w,\n/static/2024-12-18-10-39-02-5675f1895f17a288490199d49fd1f2f4-a40ca.png 647w" data-sizes="(max-width: 647px) 100vw, 647px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可能你在平时的使用过程中并没有意识到这一点，但仔细想一想，你会觉得这是一件比较神奇的事情。本来就是不同的框架，怎么能够无缝地集成在一起呢？</p>\n<p>无论从面试角度，还是日常开发角度，这都是一个值得分析和探讨的话题。因为我们自己也可能需要开发类似 Dubbo、Mybatis 这样的第三方框架，然后完成与 Spring 框架的集成。显然，这是一类偏向于实践的话题，因此，面试官也会更多地从应用的角度出发来考查候选人，常见的提问方式包括：</p>\n<ul>\n<li>你能列举 Spring 框架所提供的常见启动扩展点，以及它们的使用方式吗？</li>\n<li>Spring 中 Bean 中的 Constructor、@PostConstruct 以及 InitializingBean 这三者之间的执行顺序是怎么样的？</li>\n<li>如何基于 Spring Boot 的自动配置原理实现一个 starter 组件？</li>\n<li>你能描述 Dubbo 框架的启动过程吗？</li>\n<li>Mybatis Spring Boot Starter 的运行机制是怎么样的？</li>\n</ul>\n<p>要想回答上述面试题，就需要我们掌握 Spring 框架中内置了一组功能非常强大的扩展机制。通过这些扩展机制，可以实现我们想要的集成效果。接下来，让我们对这些问题做进一步分析。</p>\n<h2 id="问题分析-20"><a href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-20" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题分析</h2>\n<p>目前，很多主流的开源框架都提供了自身针对 Spring 框架的系统集成模块，包括我们前面几讲介绍的 Dubbo 和 Mybatis 框架。同样的，如果我们自己实现一款开源框架，也可以利用 Spring 所提供的扩展性来完成与它的集成过程。这里，我们可以把 Spring 框架本身做一个细分，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-12-18-10-40-01-9b0b1f84310658c71be500249090b226-0e173.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 646px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 26.47058823529412%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAAA/0lEQVQY052Qy06DYBCFef/naMSqwTYadePOai8gQm9A7YVLa35oobQL64J8jqy7cpKTmTnnZGYyGmfidPrGMg26bw06Lw3Mgc5k/Mx8/onZbwp0+j1dPE3erSuswSW97gWBf4+mVMxum7AVpGlElq4lK4LAJApdGWKzXNooteBwKInjEVHk1locDWuEK4dQeqU8tPHIwJve4Ng6i3kL33uQC3/4b2hJMiVJZGs45GszZrMO2O1y4ULKMmNfZBS5kuv2VFUlmpI+JReuKNK6LvdZXf9p2rktx+MB12njT+8YuS28SZvVssNs5gseWS2ehL/F/TBqj21d1/8r8ld+AZVtbUZfbTFrAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 12 18 10 40 01" title="" data-src="/static/2024-12-18-10-40-01-9b0b1f84310658c71be500249090b226-0e173.png" data-srcset="/static/2024-12-18-10-40-01-9b0b1f84310658c71be500249090b226-2fb9f.png 200w,\n/static/2024-12-18-10-40-01-9b0b1f84310658c71be500249090b226-f1e72.png 400w,\n/static/2024-12-18-10-40-01-9b0b1f84310658c71be500249090b226-0e173.png 646w" data-sizes="(max-width: 646px) 100vw, 646px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>从扩展性的角度讲，传统 Spring 提供了两大类扩展功能，一类是启动过程中的各种扩展点，另一类则是 Spring 内置的自定义标签体系，我们可以通过 XML Scheme 的命名空间机制来实现与 Spring 的集成。</p>\n<p>另一方面，Spring Boot 作为 Spring 框架的升级，也提供了功能强大的自动配置机制，我们也可以通过编写自定义的 starter 组件来完成与 Spring Boot 的集成。</p>\n<h2 id="技术体系-22"><a href="#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-22" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术体系</h2>\n<p>就目前的应用场景而言，Spring Boot 是 Java 世界中最主流的开发框架，开发自定义 starter 组件是主流的框架集成实现方案。因此，在接下来的内容中，我们重点对 Spring Boot 的自动配置机制做详细的展开。而针对传统 Spring 框架，只会简要介绍一些常见的启动扩展点机制。</p>\n<h3 id="spring-启动扩展点"><a href="#spring-%E5%90%AF%E5%8A%A8%E6%89%A9%E5%B1%95%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Spring 启动扩展点</h3>\n<p>就技术体系而言，让我们先从传统 Spring 框架的一组启动扩展点开始讲起。事实上，在 Spring 中，启动扩展点的数量非常多，这里只挑选一组最常用的进行介绍，包括 InitializingBean、FactoryBean 以及 ApplicationListener。</p>\n<p>在 Spring 中，InitializingBean 的作用是在 Bean 的初始化时，允许开发人员添加一些定制化处理逻辑，该接口定义如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34913566146469253000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface InitializingBean {\n   void afterPropertiesSet() throws Exception;\n}`, `34913566146469253000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">InitializingBean</span> <span class="token punctuation">{</span>\n   <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>我们看到 InitializingBean 接口只有一个方法，即 afterPropertiesSet 方法。从命名上看，这个方法应该作用于属性被设置之后。也就是说，该方法的初始化会晚于属性的初始化。</p>\n<p>接下来要介绍的 FactoryBean 接口相信你不会陌生，它的定义如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26423577511128314000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface FactoryBean<T> {\n   T getObject() throws Exception;\n   Class<?> getObjectType();\n   boolean isSingleton();\n}`, `26423577511128314000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>\n   <span class="token class-name">T</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>\n   <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">getObjectType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">boolean</span> <span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>实际上，FactoryBean 是 Spring 框架中非常核心的一个接口，负责从容器中获取具体的 Bean 对象。</p>\n<p>ApplicationEvent 和 ApplicationListener 是 Spring 框架中实现事件驱动编程的核心类。如果在一个 JavaBean 中实现了 ApplicationListener 接口，那么一旦有任何一种 ApplicationEvent 被发布，这个 Bean 将自动触发监听器处理程序。ApplicationListener 接口定义如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27493538237488857000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface ApplicationListener<E extends ApplicationEvent> extends EventListener {\n   void onApplicationEvent(E event);\n}`, `27493538237488857000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span> <span class="token keyword">extends</span> <span class="token class-name">ApplicationEvent</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">EventListener</span> <span class="token punctuation">{</span>\n   <span class="token keyword">void</span> <span class="token function">onApplicationEvent</span><span class="token punctuation">(</span><span class="token class-name">E</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>我们知道在 Spring 上下文对象 ApplicationContext 的整个生命周期中，每一个阶段或操作的开始和结束都可以触发一种事件。基于 ApplicationListener 这个监听器接口，我们就可以处理各种自定义的 ApplicationEvent。</p>\n<h3 id="spring-boot-自动配置"><a href="#spring-boot-%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Spring Boot 自动配置</h3>\n<p>Spring Boot 的自动配置功能强大，但也有一定的复杂度，让我们通过 @SpringBootApplication 注解来深入理解其背后的实现原理。</p>\n<p>通过查看 @SpringBootApplication 注解的定义，我们发现该注解实际上是一个复合注解，由 @SpringBootConfiguration、@ComponentScan 和 @EnableAutoConfiguration 所组成。我们知道 @ComponentScan 是传统 Spring 框架中就内置的注解，而 @SpringBootConfiguration 注解也很简单，实际上只是对 Spring 框架中另一个常用组件 @Configuration 的一种包装，本身没有定义任何内容。</p>\n<p>所以，我们接下来重点剖析 @EnableAutoConfiguration 注解，该注解定义如下所示。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87599177730059630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Target(ElementType.TYPE)\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Inherited\n@AutoConfigurationPackage\n@Import(AutoConfigurationImportSelector.class)\npublic @interface EnableAutoConfiguration {\n   String ENABLED_OVERRIDE_PROPERTY = &quot;spring.boot.enableautoconfiguration&quot;;\n   Class<?>[] exclude() default {};\n   String[] excludeName() default {};\n}`, `87599177730059630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span>\n<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>\n<span class="token annotation punctuation">@Documented</span>\n<span class="token annotation punctuation">@Inherited</span>\n<span class="token annotation punctuation">@AutoConfigurationPackage</span>\n<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token class-name">AutoConfigurationImportSelector</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">EnableAutoConfiguration</span> <span class="token punctuation">{</span>\n   <span class="token class-name">String</span> ENABLED_OVERRIDE_PROPERTY <span class="token operator">=</span> <span class="token string">"spring.boot.enableautoconfiguration"</span><span class="token punctuation">;</span>\n   <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">exclude</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n   <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">excludeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，这里出现了一个新的注解，即 @AutoConfigurationPackage。从命名上讲， @AutoConfigurationPackage 注解的作用就是自动对某一个代码包进行配置。</p>\n<p>另一方面，我们还看到通过 @Import 注解引入了一个 AutoConfigurationImportSelector 类。从命名上，我们也不难理解该类的作用是完成对导入的配置信息的自动选择。该类的核心方法 getCandidateConfigurations 实现了这一目标，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72416081035867160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`protected List<String> getCandidateConfigurations(AnnotationMetadata metadata, AnnotationAttributes attributes) {\n   List<String> configurations = SpringFactoriesLoader.loadFactoryNames(getSpringFactoriesLoaderFactoryClass(), getBeanClassLoader());\n   // ...\n   return configurations;\n}`, `72416081035867160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getCandidateConfigurations</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span> metadata<span class="token punctuation">,</span> <span class="token class-name">AnnotationAttributes</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> configurations <span class="token operator">=</span> <span class="token class-name">SpringFactoriesLoader</span><span class="token punctuation">.</span><span class="token function">loadFactoryNames</span><span class="token punctuation">(</span><span class="token function">getSpringFactoriesLoaderFactoryClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getBeanClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// ...</span>\n   <span class="token keyword">return</span> configurations<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里引出了在 Spring Boot 中真正负责加载配置信息的 SpringFactoriesLoader 类。这些类之间的交互关系如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-12-18-10-41-06-d6867c5f348c245629811bcfee96735a-8fcec.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 645px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 38.13953488372093%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABbUlEQVQoz3VRa0/CUAzd//8VJJpoREBNiI/4AXmMsbGxIWMbj8EYgzD5oIADwbtjNx6SoE1O2tvT0za9XEU4Q7GQAF86i2EaKfR7dRjNPMr8Nl/mt1xdvYRh5GBZItTaBQr5BAT+HIWXBOpaEoqcBmfbNfRslaCh21HQbgvw/SGmUxd2V6bmKjUR0CM/HumUdzCZDNB4zaNlScRrVFcjronRyAKHP2z1xbBeh4f3cvl9iDcb4lcM/xnHGANjkSCkwgCOoxAkml6CLD9A13NQlMfYV6v3tG0BrivD6VcRBIu4SaQPQxYj3jAMt9sEwSfd8BmaegtZykASU6gIydjLUhpi5ZrueYWmnoVpPmGxmOFYH2+4D/bJI+5gs1lwktvXRbpj7Br+JiLzfReDgQ7PMzF0Ddq4CG9oYuRZ9G7SpzjYjT+94fGUqCA6+ngswnOzMPQMLOMG7dYdOgS9kcLHew5vvoT5PNjdj5Fmc8APDzFP/v5a6eEAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 12 18 10 41 06" title="" data-src="/static/2024-12-18-10-41-06-d6867c5f348c245629811bcfee96735a-8fcec.png" data-srcset="/static/2024-12-18-10-41-06-d6867c5f348c245629811bcfee96735a-ba1e2.png 200w,\n/static/2024-12-18-10-41-06-d6867c5f348c245629811bcfee96735a-72011.png 400w,\n/static/2024-12-18-10-41-06-d6867c5f348c245629811bcfee96735a-8fcec.png 645w" data-sizes="(max-width: 645px) 100vw, 645px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>显然，想要完成配置信息的自动选择，我们首先需要执行配置文件的加载操作，这部分功能是由 SpringFactoriesLoader 来完成的。SpringFactoriesLoader 也是 Spring Boot 自动配置得以实现的关键组件。</p>\n<p>SpringFactoriesLoader 类似 JDK 中的 SPI 机制所使用的 ServiceLoader 类，区别只是在于配置文件的存放位置和配置项对应的键值定义。在 SpringFactoriesLoader 中，我们需要通过 <code class="language-text">META-INF/spring.factories</code> 目录来获取服务定义文件，并通过 EnableAutoConfiguration 这个健值来获取具体的配置信息。</p>\n<p>下图展示了 SpringFactoriesLoader 和 ServiceLoader 之间的区别：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-12-18-10-41-43-3ad4eec648c37c54103bbfbcb3117f27-72de5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 648px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 23.456790123456788%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAABL0lEQVQY0z2Qx27CQBRF+f8/IYVNGrFDigVSCphi7LFDsY2JGw4tECQ2Jw8vsjg6miu9mfumMo+a9Lo3dM1r8XVpe3hP/NXC8wxWqzVJmrD/2THwhzxFBq3klbrSubHqXPVuefRfaEpmRC0qRTEhjl25wCVNPBIhy0YUi7F4ym6353A4cDweyZYZn5JPlz5eOsKNPZTMjfIxE8lOroSBgbJ1lKPj2Bq2dV9yauhPX+WxhDzP2aw3ODOF5jXQHEE10IUH75HG53NpI5SG87nHbOYShqr0iSBQRJE0TgO2262sveJ3/0v6ndL3B1jBsGTgWwwC6/9sRw6VfreG2b6g36vREZudS9of57jqSlpr8gUpi2LBZrXhzX2n/vXAXahTNS84k5mqecl5v4YeP5X5H2awXvpKxVq1AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 12 18 10 41 43" title="" data-src="/static/2024-12-18-10-41-43-3ad4eec648c37c54103bbfbcb3117f27-72de5.png" data-srcset="/static/2024-12-18-10-41-43-3ad4eec648c37c54103bbfbcb3117f27-bb436.png 200w,\n/static/2024-12-18-10-41-43-3ad4eec648c37c54103bbfbcb3117f27-c5634.png 400w,\n/static/2024-12-18-10-41-43-3ad4eec648c37c54103bbfbcb3117f27-72de5.png 648w" data-sizes="(max-width: 648px) 100vw, 648px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>SpringFactoriesLoader 基于上图中指定的配置文件名和键值获取对应的配置信息，然后基于这些配置信息来实例化配置类，Spring Boot 通过反射机制实现了这一目标。SpringFactoriesLoader 类中的 loadSpringFactories 方法展示了这一过程，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54289344780249160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`private static Map<String, List<String>> loadSpringFactories(@Nullable ClassLoader classLoader) {\n   // 从缓存中获取配置内容，如果存在则直接返回\n   try {\n      // 基于 ClassLoader 从 META-INF/spring.factories 获取配置文件资源地址 URL\n      while (urls.hasMoreElements()) {\n         // 获取配置文件资源\n         // 加载配置项\n\n         for (Map.Entry<?, ?> entry : properties.entrySet()) {\n            // 组装配置项 Key-Value\n         }\n\n         // 把配置信息放入缓存\n         // 返回结果\n      }\n   }\n}`, `54289344780249160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">loadSpringFactories</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 从缓存中获取配置内容，如果存在则直接返回</span>\n   <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 基于 ClassLoader 从 META-INF/spring.factories 获取配置文件资源地址 URL</span>\n      <span class="token keyword">while</span> <span class="token punctuation">(</span>urls<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token comment">// 获取配置文件资源</span>\n         <span class="token comment">// 加载配置项</span>\n\n         <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">></span></span> entry <span class="token operator">:</span> properties<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 组装配置项 Key-Value</span>\n         <span class="token punctuation">}</span>\n\n         <span class="token comment">// 把配置信息放入缓存</span>\n         <span class="token comment">// 返回结果</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们在 spring-boot-autoconfigure 工程中所使用的 spring.factories 配置文件中知道了如下所示配置项：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46161308036898310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# Auto Configure\norg.springframework.boot.autoconfigure.EnableAutoConfiguration=\\\norg.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\\\norg.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\\\norg.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration,\\`, `46161308036898310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text"># Auto Configure\norg.springframework.boot.autoconfigure.EnableAutoConfiguration=\\\norg.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\\\norg.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\\\norg.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration,\\</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到在 org.springframework.boot.autoconfigure.EnableAutoConfiguration 配置项中定义了各种以 <code class="language-text">-AutoConfiguration</code> 结尾的配置类。通过 SpringFactoriesLoader，Spring Boot 就能做到在服务启动的过程中把它们加载到容器中并实现自动化配置。</p>\n<h2 id="源码解析-20"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-20" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h2>\n<p>在介绍完理论知识之后，让我们回到实践。我们将分别分析 Mybatis Spring 的启动过程以及 Mybatis Spring Boot Starter 的实现原理。</p>\n<h3 id="mybatis-spring-启动过程"><a href="#mybatis-spring-%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Mybatis Spring 启动过程</h3>\n<p>mybatis-spring 框架完成了 Mybatis 与 Spring 之间的集成。打开 mybatis-spring 代码工程，我们快速寻找实现了 Spring 扩展点的类，这个类并不难找，它就是 SqlSessionFactoryBean 类。</p>\n<p>很典型的，SqlSessionFactoryBean 实现了 FactoryBean、InitializingBean 和 ApplicationListener 这三个扩展点接口，其定义如下所示（列举了部分重要的变量）：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83751285529450270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class SqlSessionFactoryBean implements FactoryBean<SqlSessionFactory>, InitializingBean, ApplicationListener<ApplicationEvent> {\n   // ...\n   private Configuration configuration;\n   private SqlSessionFactoryBuilder sqlSessionFactoryBuilder = new SqlSessionFactoryBuilder();\n   private SqlSessionFactory sqlSessionFactory;\n   private String environment = SqlSessionFactoryBean.class.getSimpleName();\n   // ...\n}`, `83751285529450270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SqlSessionFactoryBean</span> <span class="token keyword">implements</span> <span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SqlSessionFactory</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">InitializingBean</span><span class="token punctuation">,</span> <span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApplicationEvent</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>\n   <span class="token comment">// ...</span>\n   <span class="token keyword">private</span> <span class="token class-name">Configuration</span> configuration<span class="token punctuation">;</span>\n   <span class="token keyword">private</span> <span class="token class-name">SqlSessionFactoryBuilder</span> sqlSessionFactoryBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSessionFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">private</span> <span class="token class-name">SqlSessionFactory</span> sqlSessionFactory<span class="token punctuation">;</span>\n   <span class="token keyword">private</span> <span class="token class-name">String</span> environment <span class="token operator">=</span> <span class="token class-name">SqlSessionFactoryBean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们还是按照既有的思路，先来看看这些扩展点如何完成 Spring 与 Mybatis 框架之前的整合。首先，我们来看 InitializingBean 接口的实现，即如下所示的 afterPropertiesSet 方法（代码做了裁剪）：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6202787910816499000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Override\npublic void afterPropertiesSet() throws Exception {\n   // ...\n   this.sqlSessionFactory = buildSqlSessionFactory();\n}`, `6202787910816499000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>\n   <span class="token comment">// ...</span>\n   <span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionFactory <span class="token operator">=</span> <span class="token function">buildSqlSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>显然，对于 SqlSessionFactoryBean 而言，主要职责就是完成 SqlSessionFactory 的构建，这也是这个类的类名由来，而完成这个操作的最合适的阶段就是 Bean 生命周期中的 InitializingBean 阶段。我们来看一下这里的 buildSqlSessionFactory 方法的具体实现过程，这个方法非常长，但代码结构比较简单。我们抛开大量的代码细节，使用如下所示的代码来展示这个方法的结构：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2129114366671092200"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`protected SqlSessionFactory buildSqlSessionFactory() throws IOException {\n   Configuration configuration;\n\n   XMLConfigBuilder xmlConfigBuilder = null;\n   if (this.configuration != null) {\n      // 如果当前的 configuration 不为空，则直接使用该对象\n      configuration = this.configuration;\n      // ...\n   } else if (this.configLocation != null) {\n      // 如果配置文件地址 configLocation 不为空，则通过 XMLConfigBuilder 进行解析并创建 configuration\n      xmlConfigBuilder = new XMLConfigBuilder(this.configLocation.getInputStream(), null, this.configurationProperties);\n      configuration = xmlConfigBuilder.getConfiguration();\n   } else {\n      // 如果以上两种情况都不满足，则创建一个新的 configuration 对象并进行参数赋值\n      configuration = new Configuration();\n      // ...\n   }\n\n   // 设置 objectFactory 等各种 Mybatis 运行时所需的配置信息\n   // ...\n\n   // 基于 configuration 通过 SqlSessionFactoryBuilder 构建 SqlSessionFactory\n   return this.sqlSessionFactoryBuilder.build(configuration);\n}`, `2129114366671092200`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">buildSqlSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>\n   <span class="token class-name">Configuration</span> configuration<span class="token punctuation">;</span>\n\n   <span class="token class-name">XMLConfigBuilder</span> xmlConfigBuilder <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configuration <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 如果当前的 configuration 不为空，则直接使用该对象</span>\n      configuration <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configuration<span class="token punctuation">;</span>\n      <span class="token comment">// ...</span>\n   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configLocation <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 如果配置文件地址 configLocation 不为空，则通过 XMLConfigBuilder 进行解析并创建 configuration</span>\n      xmlConfigBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLConfigBuilder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configLocation<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configurationProperties<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      configuration <span class="token operator">=</span> xmlConfigBuilder<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 如果以上两种情况都不满足，则创建一个新的 configuration 对象并进行参数赋值</span>\n      configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// ...</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token comment">// 设置 objectFactory 等各种 Mybatis 运行时所需的配置信息</span>\n   <span class="token comment">// ...</span>\n\n   <span class="token comment">// 基于 configuration 通过 SqlSessionFactoryBuilder 构建 SqlSessionFactory</span>\n   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionFactoryBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>关于 SqlSessionFactoryBuilder，我们知道该类会创建一个 DefaultSqlSessionFactory，可以通过 DefaultSqlSessionFactory 进而获取 SqlSession 对象的实例。</p>\n<p>然后，我们来关注 SqlSessionFactoryBean 实现的 FactoryBean 接口，从接口的泛型定义上，我们明白它的 getObject 方法应该返回的是一个 SqlSessionFactory 对象，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29427308680517530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Override\npublic SqlSessionFactory getObject() throws Exception {\n   if (this.sqlSessionFactory == null) {\n      afterPropertiesSet();\n   }\n\n   return this.sqlSessionFactory;\n}`, `29427308680517530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionFactory <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionFactory<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，这里的实现过程非常简单，如果目标 sqlSessionFactory 还没有被创建，就直接调用了前面介绍的 afterPropertiesSet 方法完成该对象的创建并返回。</p>\n<p>最后，我们需要关注的是 onApplicationEvent 方法，这是 ApplicationListener 接口的具体实现，用来对 Spring 中所生成的 ApplicationEvent 进行响应，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11786273245450762000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Override\npublic void onApplicationEvent(ApplicationEvent event) {\n   if (failFast && event instanceof ContextRefreshedEvent) {\n      this.sqlSessionFactory.getConfiguration().getMappedStatementNames();\n   }\n}`, `11786273245450762000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApplicationEvent</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>failFast <span class="token operator">&amp;&amp;</span> event <span class="token keyword">instanceof</span> <span class="token class-name">ContextRefreshedEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionFactory<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMappedStatementNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>就场景而言，这个方法的作用是在接收到代表容器刷新的 ContextRefreshedEvent 事件时，重新获取各种 MappedStatement。这里通过调用 Configuration 的 getMappedStatementNames 方法完成这一操作，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75757134702663710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public Collection<MappedStatement> getMappedStatements() {\n   buildAllStatements();\n   return mappedStatements.values();\n}`, `75757134702663710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MappedStatement</span><span class="token punctuation">></span></span> <span class="token function">getMappedStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token function">buildAllStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> mappedStatements<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>再往下看，就到了 Mybatis 内部的实现细节了，我们不再展开。至此，SqlSessionFactoryBean 中与 Spring 框架集成的相关内容就介绍到这里。通过 SqlSessionFactoryBean，我们就可以获取 SqlSessionFactory 对象，这是 Mybatis 框架启动过程的主要目标。</p>\n<h3 id="mybatis-spring-boot-starter"><a href="#mybatis-spring-boot-starter" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Mybatis Spring Boot Starter</h3>\n<p>基于前面介绍的 Spring Boot 中应用程序的自动配置机制，我们来做一些实践，通过剖析 Mybatis Spring Boot Starter 的启动过程来加深对所介绍内容的理解。</p>\n<p>在 mybatis-spring-boot-starter 中存在几个代码工程，我们重点关注 mybatis-spring-boot-autoconfigure 工程。而在这个代码工程中，最重要的显然就是 MybatisAutoConfiguration 类。对于 Spring Boot 中的 <code class="language-text">-AutoConfiguration</code> 类，我们首先需要重点关注的是类定义上的注解，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9768456787158163000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@org.springframework.context.annotation.Configuration\n@ConditionalOnClass({ SqlSessionFactory.class, SqlSessionFactoryBean.class })\n@ConditionalOnSingleCandidate(DataSource.class)\n@EnableConfigurationProperties(MybatisProperties.class)\n@AutoConfigureAfter(DataSourceAutoConfiguration.class)\npublic class MybatisAutoConfiguration implements InitializingBean {\n   // ...\n}`, `9768456787158163000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@org</span><span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span><span class="token class-name">Configuration</span>\n<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">SqlSessionFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">SqlSessionFactoryBean</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token annotation punctuation">@ConditionalOnSingleCandidate</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>\n<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">MybatisProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>\n<span class="token annotation punctuation">@AutoConfigureAfter</span><span class="token punctuation">(</span><span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MybatisAutoConfiguration</span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span> <span class="token punctuation">{</span>\n   <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们看到这里用到了 @ConditionalOnClass 和 @ConditionalOnSingleCandidate 这两个注解，它们就是 Spring Boot 中的条件注解。在介绍 MybatisAutoConfiguration 之前，有必要对这些注解做一定展开。</p>\n<p>我们在前面的介绍中已经了解到以 <code class="language-text">-AutoConfiguration</code> 结尾的自动配置类数量会很多，在一个应用程序的开发过程中，我们通常不会全部使用到。这时候就需要引入一种机制来对这些自动配置类进行过滤。为此，Spring Boot 提供了一组 @ConditionalOn 系列条件注解。通这些注解，我们就可以基于特定的条件来选择性地加载某些配置类。</p>\n<p>在 Spring Boot 中常见的条件注解可以参考下图：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-12-18-10-43-05-9d476027742985f73efaf1656be6c900-a40ca.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 647px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 39.876352395672335%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABuElEQVQoz02R6XLaQBCE9f4PkpRdRYxxoIwdW+he3RKYQ5xGAiGD3+HLIFc5+dHVszs7PT072nplkWd9lNclCO4Jgx5ZOmC1euV42KA2Ic9bncHbkF7ap5v8bvmK/mTIQzbgLurxtHxF35lop9OYqoyYzyyWhdPy/j3kfM5pTiVv9ZyoSVG7AF/eqfcAtQ9wNwpv5+PvQ6yl097nlwnaTh4uC5MkHpImT8TRkGJhiqjHhwim5RhjY/Ey03mZj/6D/o3H/Jk/kndLH60+ZpQSLOZGK7QQVGVA0yR8NCWTeoaqQ5x3hbVxGBWWxB721sOTuivrUquqkPicoZVlImOaTKfGNxcLm7qOOX9UTI4z4kuGkib22m2hz02MpY2zU1+xNEkvY+JGBHdbX4R0wajl2VQXtyNxrVrBrJpgly7W1pHRbcyrS1mksf4HvTAwJa+OIdqhysWRw2rpyV+6LRfCzSnn81IzOxX4VSSfHxEdUkGCL0u7nt2NT1jGOCsPd60Yf07RMlm/afzAsW+xrRvM0TW+EacDqv0KQ5p1kjs6UZefzi03qkM3feAu6fErvqcTd79yUj+YD/kLj2Mhkm7Th1kAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 12 18 10 43 05" title="" data-src="/static/2024-12-18-10-43-05-9d476027742985f73efaf1656be6c900-a40ca.png" data-srcset="/static/2024-12-18-10-43-05-9d476027742985f73efaf1656be6c900-3426a.png 200w,\n/static/2024-12-18-10-43-05-9d476027742985f73efaf1656be6c900-f3a4f.png 400w,\n/static/2024-12-18-10-43-05-9d476027742985f73efaf1656be6c900-a40ca.png 647w" data-sizes="(max-width: 647px) 100vw, 647px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在前面介绍的 MybatisAutoConfiguration 类上，我们发现了 @ConditionalOnClass 和 @ConditionalOnSingleCandidate 这两个条件注解。基于这两个条件注解，我们可以明确 MybatisAutoConfiguration 能够实例化的前提有两个，一个是类路径中存在 SqlSessionFactory 和 SqlSessionFactoryBean，另一个是容器中只存在一个 DataSource 实例。两者缺一不可，这是一种常用的自动配置控制技巧。</p>\n<p>然后，我们在 MybatisAutoConfiguration 类上看到了一个 @EnableConfigurationProperties 注解。通过这个注解，所有添加了 @ConfigurationProperties 注解的配置类就会自动生效。这里的 @EnableConfigurationProperties 注解中指定的是 MybatisProperties 类，该类定义了 Mybatis 运行时所需要的各种配置信息，而我们在 MybatisProperties 类上确实也发现了 @ConfigurationProperties 注解，并指定了 prefix 为 <code class="language-text">mybatis</code>，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30013929142682284000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@ConfigurationProperties(\n   prefix = &quot;mybatis&quot;\n)\npublic class MybatisProperties {\n   // ...\n}`, `30013929142682284000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>\n   prefix <span class="token operator">=</span> <span class="token string">"mybatis"</span>\n<span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MybatisProperties</span> <span class="token punctuation">{</span>\n   <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最后，在 MybatisAutoConfiguration 类上还存在一个 @AutoConfigureAfter 注解，这个注解可以根据字面意思进行理解，即在完成某一个类的自动配置之后再执行当前类的自动配置，这个需要提前装配的类指的就是 DataSourceAutoConfiguration。</p>\n<p>理解了 @ConditionalOnClass、@EnableConfigurationProperties 和 @AutoConfigureAfter 等一系列注解之后，我们回过头来再看 MybatisAutoConfiguration 类的代码结构就显得比较简单明了。MybatisAutoConfiguration 类中核心方法之一就是如下所示的 sqlSessionFactory 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13733803618956420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@Bean\n@ConditionalOnMissingBean\npublic SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception {\n   SqlSessionFactoryBean factory = new SqlSessionFactoryBean();\n   factory.setDataSource(dataSource);\n   factory.setVfs(SpringBootVFS.class);\n   if (StringUtils.hasText(this.properties.getConfigLocation())) {\n      factory.setConfigLocation(this.resourceLoader.getResource(this.properties.getConfigLocation()));\n   }\n   applyConfiguration(factory);\n\n   // 省略一系列配置项设置方法\n   return factory.getObject();\n}`, `13733803618956420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@Bean</span>\n<span class="token annotation punctuation">@ConditionalOnMissingBean</span>\n<span class="token keyword">public</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">sqlSessionFactory</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>\n   <span class="token class-name">SqlSessionFactoryBean</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSessionFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   factory<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   factory<span class="token punctuation">.</span><span class="token function">setVfs</span><span class="token punctuation">(</span><span class="token class-name">SpringBootVFS</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">getConfigLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      factory<span class="token punctuation">.</span><span class="token function">setConfigLocation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">getConfigLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token function">applyConfiguration</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token comment">// 省略一系列配置项设置方法</span>\n   <span class="token keyword">return</span> factory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>显然，这里基于前面介绍的 SqlSessionFactoryBean 构建了 SqlSessionFactory 实例。注意到在该方法上同样添加了一个 @ConditionalOnMissingBean 注解，标明只有在当前上下文中不存在 SqlSessionFactoryBean 对象时才会执行上述方法。</p>\n<p>接下来，我们需要在 <code class="language-text">META-INF/spring.factories</code> 文件中明确指定自动配置类。根据 Spring Boot 自动配置机制的原理，对于 mybatis-spring-boot-autoconfigure 工程而言，这个配置项内容应该是这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96727956832468090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# Auto Configure\norg.springframework.boot.autoconfigure.EnableAutoConfiguration=\\\norg.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration`, `96727956832468090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text"># Auto Configure\norg.springframework.boot.autoconfigure.EnableAutoConfiguration=\\\norg.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>至此，整个 Mybatis Spring Boot Starter 的介绍就告一段落。作为总结，我们可以把创建一个 Spring Boot Starter 的过程抽象三个步骤，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-12-18-10-43-47-a24e8f86720a24c38e6df3e807da0e20-72de5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 648px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 25.925925925925924%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAABN0lEQVQY0z2Q207CUBBF+///oUEiYLkYRKwBEVqUe2mRUlp6CtILfIFmOemDDzszk9mTrNma6zxxVAbzWQ1zVMJe1WV+wdv2yJOcrvNKO+7SiQyqdp0bq8TtuMzdtFLUstSO3LejLkbQQ0uSA3l+II49XHdKmoSkaUCWHfn9+eV0+SaQfXRV7JMA77Rjd/Lxz/v//pBHhOJRuULb+32CvcFq2WIxq7OYN4lVjzC0uGRX+psB1UWd6kRHF4++aPIguv+ooa9aNJ12odqywVs4REvTUAgDjscvPG/G+bwjS30hVAVhlCpWoY0drnGUiys+N96wPjhFvxE5aoMdrQtqbfLZkOzKWGaF90GJsVWRPB8kwwFXIRzuRrxfTEb5mGffQJcPGstH2ttnGvYjLaEbphaDzMQ8jfkDuG5Z7r+85LgAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 12 18 10 43 47" title="" data-src="/static/2024-12-18-10-43-47-a24e8f86720a24c38e6df3e807da0e20-72de5.png" data-srcset="/static/2024-12-18-10-43-47-a24e8f86720a24c38e6df3e807da0e20-bb436.png 200w,\n/static/2024-12-18-10-43-47-a24e8f86720a24c38e6df3e807da0e20-c5634.png 400w,\n/static/2024-12-18-10-43-47-a24e8f86720a24c38e6df3e807da0e20-72de5.png 648w" data-sizes="(max-width: 648px) 100vw, 648px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在日常开发过程中，基于上述三个步骤，我们就可以参考 Mybatis Spring Boot Starter 的实现方式来设计并开发自定义的 starter 组件。</p>\n<h2 id="解题要点-22"><a href="#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-22" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解题要点</h2>\n<p>正如在问题背景部分中给出的常见面试题所示，面试官在面试过程中往往不会直接问 <code class="language-text">Mybatis 与 Spring 框架是如何集成</code> 这样的问题，而是会考查具体的知识点，例如抛出 <code class="language-text">Spring 中 Bean 中的 Constructor、@PostConstruct 以及 InitializingBean 这三者之间的执行顺序是怎么样的？</code> 类似的问题。这是一类比较好的面试题，我作为面试官也经常会用这种类型的题目考查面试者对于 Spring 中一些基本实现机制的理解程度。</p>\n<p>从考点上讲，一方面这道题的知识点比较丰富，涉及到对 Spring 框架中的一些核心概念；另一方面，这道题也具有一定的综合性，要求面试者在理解这些核心概念的基础上能够用自己的表达方式串接起来。</p>\n<p>针对这一问题，我们首先应该对 Spring 中 @PostConstruct 注解和 InitializingBean 接口的作用和应用场景有明确的认识，最好有一定的实践基础，在回答这个问题时先说明这一点。然后，在介绍了应用方式的基础上，我们需要深入这些注解和方法的背后，进一步介绍 BeanPostProcessor 等 Spring 内部的实现接口及其实现过程。整个回答过程中涉及的概念和对象可能有点多，注意侧重点和回答问题的节奏。有些地方不用说得过细，只需要围绕“执行顺序”这一核心考点进行展开即可，避免陷入细节而导致问题回答思路上的混乱。</p>\n<p>随着 Spring Boot 成为日常开发的主流框架，Spring Boot 的自动配置机制也变成了一个经典问题。但凡是使用过 Spring Boot 的候选人，我一般都会通过这个问题来考查对方的知识体系。自动配置是 Spring Boot 最核心的机制，该问题的考点明确，问题的答案也很明确，大家通过记忆以及加上自己的一些理解进行解答即可。</p>\n<p>从回答思路上，Spring Boot 的自动配置机制涉及的知识点包括两大部分内容。首先我们需要介绍 @SpringBootApplication 注解及其背后的三大注解 @SpringBootConfiguration、@EnableAutoConfiguration 和 @ComponentScan，这几个注解必须点到。然后，随着对这些注解的深入阐述，我们需要再引出具有与 SPI 实现机制类似功能的 SpringFactoriesLoader 类，该类包含了自动配置相关的一些配置项处理方式。本讲详细阐述了 Spring Boot 自动配置机制的实现原理，从源码角度分析了为什么 Spring Boot 能够做到自动配置。文中所述的知识体系都可以用来回答这个问题。由于内容比较多，回答过程中还是建议需要把握节奏，避免过多嵌入细节。</p>\n<h2 id="小结与预告-20"><a href="#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-20" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结与预告</h2>\n<p>在本讲内容中，我们首先介绍的是 Spring 框架中的几个核心扩展点，这些扩展点是 Dubbo 和 Mybatis 等开源框架与 Spring 进行集成的主要入口。然后，Spring Boot 的自动配置原理也是我们需要掌握的内容，因为它们被广泛地应用到与 Spring Boot 框架的集成过程中。围绕前面介绍的这些内容，我们基于 Mybatis 框架讲解了 Mybatis Spring、Mybatis Spring Boot Starter 等专用于两者之间集成的框架实现原理。</p>\n<p>很多时候我们需要对框架的功能进行完善和升级，这时候就需要框架本身具备高度的可扩展性。针对这一点，业界也存在一些主流的架构模式可以用来实现这一目标，其中最具代表性的就是微内核架构。下一讲我们就将结合 Dubbo 等具体框架围绕“为什么很多开源框架都会内置一套微内核架构？”这一话题展开详细的分析。</p>\n<h1 id="组件扩展：为什么很多开源框架都会内置一套微内核架构？"><a href="#%E7%BB%84%E4%BB%B6%E6%89%A9%E5%B1%95%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BE%88%E5%A4%9A%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6%E9%83%BD%E4%BC%9A%E5%86%85%E7%BD%AE%E4%B8%80%E5%A5%97%E5%BE%AE%E5%86%85%E6%A0%B8%E6%9E%B6%E6%9E%84%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>组件扩展：为什么很多开源框架都会内置一套微内核架构？</h1>\n<p>在上一讲中，我们讨论了框架与框架之间如何进行集成的实现过程，也引出了框架扩展性这一话题。</p>\n<p>对于软件开发而言，扩展性是一个永恒的话题，实现系统可扩展的方法有很多。而本讲要介绍的微内核架构模式就是其中一种非常具有代表性的架构模式，除了我们熟悉的 Dubbo，还有 SkyWalking、ShardingSphere 等一系列主流的开源框架都应用了这一架构模式。</p>\n<p>那么，什么是微内核架构？为什么很多开源框架都会内置一套微内核架构？作为非常经典的一类面试题，本讲内容将和你一起分析和探讨这一组件背后的设计理念以及在开源框架中的具体实现方式。</p>\n<h2 id="问题背景-20"><a href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-20" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题背景</h2>\n<p>在日常开发过程中，你应该经常会遇到这样的需求：针对某个业务场景，我们希望在系统中添加一种新的处理逻辑，但又不想对现有的系统造成影响。从架构设计上讲，这是一种典型的系统扩展性需求。</p>\n<p>从扩展性的实现策略上讲，插件式系统是我们追求的一个目标。我们希望打造如下图所示的效果，调用者能够通过基于配置的插件机制动态获取它想要的任何插件。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-12-31-10-49-20-d758229412d548cc1b62797913c00e7d-8fcec.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 645px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 54.10852713178295%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABe0lEQVQoz32R2W6CYBCFef8n6Y2JaUyb9A3KjdTUsiskimyCQdkUOP1nLAZs9E+OIZ6ZbzZJmU+hazMsvqYw9Fd4no3+7XYr/CynUOYTWOYbTOMDaZL+uR3KssLy+13kTiB/vkBTZ5AC30IUWgh8A/v9Cnme3YBFkfF/YWAhjm0kexeXy+Xmd0Jx7HC+52niewWpN8qyRteBq9q2zSqKQgA6EewPihQ4Ho84nU6ieI62Batpr77UCcr5fBbj7TiYlGUZqyhyTtI0DUEQ4HA4YL1eQ1VVLBYLVpIkME0Dm83mCqSfpmk4+NGjbmRZZjgVJAg1QBDy0jSF7/tjIAVRt/eiF0URwjDkSahwVVWjgmVZjoG0aBpx+IZA8nRdh+u6LOqoj+nzqfsbkJ5pmjwGjbDdbuE4DgzD4APQ/hRF4U56yLBgK67SX1/qTcuyOJlMGo1Eo5FHwDiO/4GGwLquxyM/OwrBaIdDyH2HIyAdhfby6Ci0Bur4GbD3fwG1qE3Q2uskTAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 12 31 10 49 20" title="" data-src="/static/2024-12-31-10-49-20-d758229412d548cc1b62797913c00e7d-8fcec.png" data-srcset="/static/2024-12-31-10-49-20-d758229412d548cc1b62797913c00e7d-ba1e2.png 200w,\n/static/2024-12-31-10-49-20-d758229412d548cc1b62797913c00e7d-72011.png 400w,\n/static/2024-12-31-10-49-20-d758229412d548cc1b62797913c00e7d-8fcec.png 645w" data-sizes="(max-width: 645px) 100vw, 645px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>上图看似简单，但想要打造功能完备的插件式系统并不容易。我们知道很多编程语言具有动态加载机制。基于编程语言的动态加载机制，我们就可以实现插件化系统，在配置时而非编译时连接类。同时，通过引入工厂模式和配置化思想，我们也可以在动态加载机制上实现更为完善的自定义封装。</p>\n<p>这些都是系统设计上的理念，但在面试过程中，面试官会考查得更加直接、更为细节，常见的提问方式包括：</p>\n<ul>\n<li>为了实现系统扩展性，你有哪些思路？</li>\n<li>微内核架构的基本组成架构是怎么样的？</li>\n<li>Dubbo 框架采用了什么技术实现方式来确保它具有高度的可扩展性？</li>\n<li>Dubbo 框架为开发人员提供了哪些扩展点？</li>\n<li>如果想要在 Dubbo 中实现一个自定义的扩展点，你有什么办法？</li>\n<li>SPI 是什么概念？我们如何使用 SPI 机制？</li>\n<li>Dubbo 中的 SPI 机制与 JDK 中的 SPI 机制有什么区别？</li>\n</ul>\n<p>基于上述问题，我们需要引出本讲要讨论的主题，即微内核架构。这是一种应用非常广泛的架构模式，也是面试过程中出现频率非常高的一个技术组件。</p>\n<p>接下来，我们来对这类问题做一些分析和展开。</p>\n<h2 id="问题分析-21"><a href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-21" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题分析</h2>\n<p>微内核架构有时候就直接被称为插件架构，它在组成结构上包含两部分组件，即内核系统和插件。</p>\n<p>这里的内核系统用来定义插件的实现规范，并管理着插件的生命周期；而各个插件是相互独立的组件，各自根据实现规范完成某项业务功能，并嵌入到内核系统中，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-12-31-10-54-09-2f000df5d9da64bdf9aeecdaf861a21b-28558.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 514px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 62.64591439688716%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACkUlEQVQ4y22TCVPaUBCA8///hz1sBUVQA+UGiygKciSUJAgIIRQFFFKwwtdNcDpVuzM7e7y93h7K/HHBfL5FDzabjY8eNBpFritBSqUglXIAXSv5+vV6/df2UfwXC1fonOXqCaWpn6A1jgWjOI794vCMF1PX8gz6x5SvdnGGUTSt4L8/P//2aa9nie6YWjWC0YpxVgijtH4ExTFArxvFNFvbzGwrnD1MMYwG9foVVrvpy7xYeKDrFbqdCKXzHUbDGIXTLyimqdEWY8PQGQ6HjMdjXPn+cv6LJ/cJ9+EX9UrD51eLleiXzOV747sx/X5f/Lb+Xpzb2y4Kb2BwOyCcCpOw0iStDMl2hkDpgPRNlpTIcTNFJH0kFTn8DxRNy0kf8lSrWR4eZr5SrcX4zgUFLgkPVE5GcUK9IwqbEnmKJPS0b3d391P8MvL1U5lBVvgzlF4nhGUEGdpRLi/P6VgdPqV3yS3POOpF2TfC7OkH7DVDqHac3OqMz+mvtI2OTD8vwzqmWvnI9D7Oaf4DSvkqISuRpF7LM5lO/MwxLYE6TRAwD4lNUpw4cb/SSD+KOkuQbmVlFZB+j6hUUpQu4tRqGZl28X0PHXtIMLFPrJ0k2c0SMyVw+YBvntzJELUShJKH3P0c/7+Hg34be9Dxd8pxHB+9KXpTXrkr3EeX66uq8E8sF0sfZ9MZzmiEbdu+n213ZMKWbMkAxTJCtH4cYJkRTKP1KtvCXdDttWm1tivhuu6rd00rc2OFpYdfpCiVfO4zSq16SPX6UPYp7mf491K0xne5FJVGfZ9+T5UDKL67lGZT5by4R9v6JvQI5f5+wmQyxaNvb9kLULsOkMvuCB+iqV+8uuX1eiOrM2E2mwm992/6D1DDsCAuAofjAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 12 31 10 54 09" title="" data-src="/static/2024-12-31-10-54-09-2f000df5d9da64bdf9aeecdaf861a21b-28558.png" data-srcset="/static/2024-12-31-10-54-09-2f000df5d9da64bdf9aeecdaf861a21b-843f4.png 200w,\n/static/2024-12-31-10-54-09-2f000df5d9da64bdf9aeecdaf861a21b-8216e.png 400w,\n/static/2024-12-31-10-54-09-2f000df5d9da64bdf9aeecdaf861a21b-28558.png 514w" data-sizes="(max-width: 514px) 100vw, 514px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>基于微内核架构，当系统中的某个组件需要进行修改时，要做的只是创建一个新的组件并替换旧组件，而不需要改变原有组件的实现方式，更加不需要调整整个系统架构。</p>\n<p>那么这里的插件具体指的是什么呢？这就需要我们引入一个新的概念，即 SPI，英文全称叫 Service Provider Interface，也就是服务提供接口。可以认为 SPI 就是应对系统扩展性的一个个扩展点，也是我们对系统中所应具备的扩展性的抽象。</p>\n<p>插件化实现机制说起来简单，做起来却不容易，我们需要考虑两方面内容。一方面，我们需要梳理系统的变化并把它们抽象成一个个 SPI 扩展点。另一方面，当我们实现了这些 SPI 扩展点之后，就需要构建一个能够支持这种可插拔机制的具体实现，从而提供一种 SPI 运行时环境。如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-12-31-10-54-58-e8e5ea6dbadfd6da8ae4a232af954e5c-bf3e7.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 504px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 71.03174603174602%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAAC6klEQVQ4y12UW3PaSBCF+f8/IQ+7L0kqW2UXjkNMDMHiJsDGXGwQoAsYgwCBlcUgbosRXxoRu1w7qlaXembOnJ4+rdB+D/vD6904fL/GlssFD50qnXYlsNVqIbakUomQSX+iWgkzHHb/7PMJiQs+Xl72bLc+u90R1Pf9wI9GfUw9TP3+H4zWKU+TPp7n0e9d0n04ZzKO0e+33gOC6w7QtCuaTUXYFFmv129sp1NXYlcYepS2Fef5+SmIt9tlTONaQMtywPQIKE8AOLA1et2vdKywnBxjMpmw9/fMZjPmwubJdRk5DqZpCaDE5nMeH23GY1cOnMu6ucSf8XdvDEdYZlZYpGRTDnfikqqnCTfOiRo/iHfiXIr9EEs6GZRRmmg7RsbNkZpkSU9Ufg4UzKFFyLbbkpJGt9uSk6Z/qgLR5k9Oqp/lGs64r52gGeckZhliszRx8ap/S4l7ilQDn91dU7cbhHT9O63GCXY/gq4X+PVryuzfZ5S2MGyFieQ+ogioYn5DkUJECh/5XvhEyo5xva9w45e5FdDMpoA2aBKq1y5oamc0tMP9aW/FSOgKibkweSkJi3sysjlvRagWP1MpfkGV9dldiZzM58Qn1/kjoOfNWCxmwmwcpLzZbIThjHgz8ZZOcX/wd+Q3N6iLPDkxdVMk/xCl1Dijbl1wZX2j4RjHomy3O5FAhnLpVJie0zGqKJ0siVWa5EpFWWVRlllhoZLc5EhvC6TEzvJ/c5H8QCL7FxHtC3eilgDQ85aBxkzjVER8IhIq0xn1KPcrsqhGbaihOS3qTlN8k1uZzzRUUYJKzigSK6Wo2HWmkm0AuBP9DKXk/V6Nx+5dIKP3YzX3GPY6OIMu7thh7a1fG0w2+3TbLQa9NmPHJvT/Pn4dh9bb47P5byciLoo+w5KFXEcnzfZlF2hLtM9g2EKXljSNr+IjR4bHn4EACEgA9O7ncOhv276j93gpnXQhfXsjfe/zSnE0soI5Q8D0VpTfkAb396U5fvQAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 12 31 10 54 58" title="" data-src="/static/2024-12-31-10-54-58-e8e5ea6dbadfd6da8ae4a232af954e5c-bf3e7.png" data-srcset="/static/2024-12-31-10-54-58-e8e5ea6dbadfd6da8ae4a232af954e5c-3e0a5.png 200w,\n/static/2024-12-31-10-54-58-e8e5ea6dbadfd6da8ae4a232af954e5c-4bca5.png 400w,\n/static/2024-12-31-10-54-58-e8e5ea6dbadfd6da8ae4a232af954e5c-bf3e7.png 504w" data-sizes="(max-width: 504px) 100vw, 504px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>接下来，我们就来一起讨论与微内核架构相关的具体技术体系。</p>\n<h2 id="技术体系-23"><a href="#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-23" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术体系</h2>\n<p>微内核架构在 Dubbo 等主流开源框架中应用非常广泛。这些框架采用的实现方式也都比较类似，基本思路就是引入前面提到的 SPI 机制。</p>\n<p>那么，怎么实现 SPI 机制呢？事实上，JDK 已经内置了一套实现 SPI 机制的开发组件。基于这套组件，想要实现 SPI，具体来说要完成三个步骤，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-12-31-10-55-36-57ea14b6d16cbff7669a872381890173-87f29.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 602px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 74.25249169435216%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAAB6klEQVQ4y5WUbW+iQBSF/f9/ZdMWdF2tb13bftustb6AIKKAMqDCUFrNmkjPXqBqNbDNkpwwBOa5M+fcodB/rmCq1zDRapClMsZqFeasReMi5nMJ8fX+HpGSEb66CqpShrduw3VaBC0ld+7dQ5+IcJzhJ+DXsAQoS98xt2oYK0VYZg0ua8GxSaxOOgdeKn13XqjQfxYwGYvQVBGB3wYnvfAHrJZ12Iv+EZhu96RcIOcOgoAl4txOFHBG/mnwPO9j0klRdHIyy4ZCnhdvbyF6vTsK7BdMswPD6FCRLukJptHFbvcne4WpH9FRUbRPXqxXUwpJgDy8hq4VoY4ESMMrKlAibxtUMMgHJp4cvYlS4Nqg9qlgNq2Sl01K/hHS4AYzvQLLaGC7CbOBl1s9AJeuTmFdU/IVsMVtIk0VqAuoE5wGwtDP7IAMYFoxnmBZXTA2ALMHsO1+0kam+URFerl9mRnK4eM40f3+pPh5t9sT1MBqxbDdhtiQl5vNC15fOS2C56/w4C0uvA2CJUZykcK6gaqUKCgBnd/fyIaftJO7fwPPdQC6GPSuoMgilJFIZ16g8KowKMDFvJ7fh3lh+b6TTGaLBp33Mvz1PXwvVpuObPN/gOnKOV/SVn9QP94i/rG4rE1+PhDwkcJq4i9UdXYvQdNTeAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 12 31 10 55 36" title="" data-src="/static/2024-12-31-10-55-36-57ea14b6d16cbff7669a872381890173-87f29.png" data-srcset="/static/2024-12-31-10-55-36-57ea14b6d16cbff7669a872381890173-38577.png 200w,\n/static/2024-12-31-10-55-36-57ea14b6d16cbff7669a872381890173-26124.png 400w,\n/static/2024-12-31-10-55-36-57ea14b6d16cbff7669a872381890173-87f29.png 602w" data-sizes="(max-width: 602px) 100vw, 602px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>对于 SPI 而言，我们需要设计一个服务接口，并根据业务场景提供不同的实现类。然后，我们在 Java 代码工程的 META-INF/services 目录中创建一个以服务接口命名的文件，并配置对应的想要使用的实现类。在代码工程中执行这些步骤，最终我们可以得到一个包含 SPI 类和配置的 JAR 包。</p>\n<p>而对于 SPI 的使用者，就可以通过 JAR 包中 META-INF/services/ 目录下的配置文件找到具体的实现类名并进行实例化。</p>\n<p>上图中的后面两个步骤实际上都是为了遵循 JDK 中 SPI 的实现机制而进行的配置工作。</p>\n<p>接下来，我们可以通过简单的代码示例来演示这些步骤。</p>\n<p>让我们来模拟这样一个应用场景，一般业务系统中都会涉及日志组件，我们希望对业界主流的日志工具做一层包装，以便支持日志组件的灵活应用。那么，基于 SPI 的约定，我们将创建一个单独的工程 log-spi 来存放服务接口，并给出接口定义，请注意这个服务接口的完整类路径为 com.spi.LogProvider，接口中只包含一个以 Info 级别记录日志信息的简单方法，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15031717241907372000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`package com.spi;\n\npublic interface LogProvider {\n   // 记录 Info 日志\n   public void info(String info);\n}`, `15031717241907372000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>spi</span><span class="token punctuation">;</span>\n\n<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">LogProvider</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 记录 Info 日志</span>\n   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">String</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>假设系统在设计之初使用的是 log4j 日志库。然后我们需要实现这个服务接口，这里创建另一个代码工程 log-log4j 用来提供基于 log4j 日志库的实现，请注意，这个实现类的名称是 Log4jProvider，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91904297432430580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class Log4jProvider implements LogProvider {\n   @Override\n   public void info(String info) {\n      System.out.println(&quot;Log4j:&quot; + info);\n   }\n}`, `91904297432430580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Log4jProvider</span> <span class="token keyword">implements</span> <span class="token class-name">LogProvider</span> <span class="token punctuation">{</span>\n   <span class="token annotation punctuation">@Override</span>\n   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">String</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Log4j:"</span> <span class="token operator">+</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接下来的这个步骤很关键，我们需要创建一个以 LogProvider 这个接口对应的完整类路径命名的文件，并放在 META-INF/services/ 目录下。在这个文件中，我们指定该接口的实现类为前面已经创建的 Log4jProvider，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-12-31-10-56-47-2ab82cc4f0804544cee087434a7365bf-d80b6.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 492px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 42.68292682926829%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABcklEQVQoz42S626jMBSEef/HWm2lXW3VKlLLJdjEQDENEAIJNwNmemy1/ZGNVnukkW0sPo/n2MmyNyRJCikljQlknqNtW1xI5emMTMaoComyrFBVFd4yCc64FeMcYRgi2Ac4HASacwOHixQhY3C9V4JJaK2tZqWg1Ixpmux8HEccj0dcrhf4PMGzy7DzGP7sPDs+0TqvLnCu7QlZwhDQSSyKEEUcp/qE2zJg40avKxa9YZpXKNIw0cGLtut51XC2bUPXlEhjDp+sx7GA3jQhNgsy+6b6vofruliWBf8qCzRXbJuacuDwfA8ijsE5A2MhjkXxDfQ87xto/rsnZ+waFLlASAG/kAM/8G3YpkHDMH76BM2H/wNqykP1DdLDnhxGCAMXY9/9dZV7wHtgx3xcKUzV1dgLgUfqGMtKvLcj5LlHVncorwrdTYZfgLsZfm2IesBvluPnq8CDG+PHS0QS+LVPqZszCsrzFjjPs31SRoqe1wcANa2RgHXXoQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 12 31 10 56 47" title="" data-src="/static/2024-12-31-10-56-47-2ab82cc4f0804544cee087434a7365bf-d80b6.png" data-srcset="/static/2024-12-31-10-56-47-2ab82cc4f0804544cee087434a7365bf-3e95a.png 200w,\n/static/2024-12-31-10-56-47-2ab82cc4f0804544cee087434a7365bf-11c87.png 400w,\n/static/2024-12-31-10-56-47-2ab82cc4f0804544cee087434a7365bf-d80b6.png 492w" data-sizes="(max-width: 492px) 100vw, 492px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>最后，我们创建一个外部工程来调用服务接口，首先需要将 log-log4j 所生成的 JAR 包添加到这个外部工程中的类路径中。然后，我们使用 JDK 中 ServiceLoader 工具类来完成对 LogProvider 实例的加载。在这里，我们通过该工具类的 load 方法获取所有的 LogProvider 实例，然后遍历这些实例并调用服务接口方法，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90253509525106360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import java.util.ServiceLoader;\nimport com.spi.LogProvider;\n\npublic class Main {\n   public static void main(String[] args) {\n      ServiceLoader<LogProvider> loader = ServiceLoader.load(LogProvider.class);\n\n      for (LogProvider provider: loader) {\n         System.out.println(provider.getClass());\n         provider.info(&quot;testInfo&quot;);\n      }\n   }\n}`, `90253509525106360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">ServiceLoader</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>spi</span><span class="token punctuation">.</span><span class="token class-name">LogProvider</span><span class="token punctuation">;</span>\n\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>\n   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LogProvider</span><span class="token punctuation">></span></span> loader <span class="token operator">=</span> <span class="token class-name">ServiceLoader</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">LogProvider</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">LogProvider</span> provider<span class="token operator">:</span> loader<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>provider<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         provider<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"testInfo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>运行这段代码，我们会得到系统的输出。可以看到这里获取的是针对 log4j 的 Log4jProvider 类中的具体方法实现，表示整个 SPI 实例的加载过程是正常的，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60415966788605750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class com.spi.Log4jProvider\nLog4j:testInfo`, `60415966788605750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">class com.spi.Log4jProvider\nLog4j:testInfo</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>请注意，在上面这个 main 函数中，我们并没有引入任何与 Log4jProvider 相关的包结构，但在运行过程中，却实现了对 Log4jProvider 类的动态调用，这是微内核架构的核心特征，对组件之间的依赖关系进行了解耦，从而确保了系统的扩展性。</p>\n<p>现在，让我们来考虑这样一种场景。随着工具的更新或者架构的调整，我们需要提供一套基于 logback 日志库的日志实现来替换现有的基于 log4j 的方案。基于扩展性考虑，最好的办法是提供另一个 SPI 实例。这样，我们创建新的一个代码工程 log-logback，并完成与 log-log4j 代码工程一样的开发工作。然后，我们把 log-logback 所生成的 JAR 包添加到外部工程的类路径中并去除原有 log-log4j 的 JAR 包，完成这些操作之后，我们再来执行前面的 main 函数，得到的就是来自 LogbackProvider 类中的输出结果，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12766430684618380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class com.spi.LogbackProvider\nLogback:testInfo`, `12766430684618380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">class com.spi.LogbackProvider\nLogback:testInfo</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>当然，你可以根据需要提供任何 LogProvider 接口的实现类并动态集成到系统的执行流程中。请注意，无论是添加、替换或者移除具体的 SPI 实现，对于原有的外部工程而言，我们并没有做任何的代码调整。这就满足了我们在本讲开头提到的扩展性的设计理念，即在现有系统中添加新的组件时，不会对现有的系统造成影响。</p>\n<p>至此，完整的 SPI 提供者和使用者的实现过程演示完毕。这个示例非常简单，但却是 Dubbo 中实现微内核架构的基础。接下来，就让我们把话题转换到 Dubbo，看看 Dubbo 中应用 SPI 机制的具体方法。</p>\n<h2 id="源码解析-21"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-21" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h2>\n<h3 id="微内核模式在-dubbo-中的应用"><a href="#%E5%BE%AE%E5%86%85%E6%A0%B8%E6%A8%A1%E5%BC%8F%E5%9C%A8-dubbo-%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>微内核模式在 Dubbo 中的应用</h3>\n<p>Dubbo 中应用微内核模式的方法也是基于 SPI，但 Dubbo 对 JDK 中的 SPI 机制做了优化，并添加了一些扩展功能。</p>\n<p>首先，Dubbo 提供了一个 @SPI 扩展点注解，该注解是理解 Dubbo SPI 机制的基础。在 Dubbo 中，只有添加了 @SPI 注解的接口类才会去查找扩展点实现。</p>\n<p>我们随处可以看到 @SPI 注解的应用场景。例如，以常见的 Protocol 接口为例，在该接口上使用的就是 <code class="language-text">@SPI(&quot;dubbo&quot;)</code> 注解，代表该接口是一个扩展点，同时该扩展点的默认实现是 DubboProtocol，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16638894232482836000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@SPI(&quot;dubbo&quot;)\npublic interface Protocol`, `16638894232482836000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@SPI</span><span class="token punctuation">(</span><span class="token string">"dubbo"</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Protocol</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>我们已经知道 JDK 只会把 SPI 配置存放在 META-INF/services/ 这个目录下，而 Dubbo 则提供了三个类似这样的目录，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-12-31-10-58-18-61dd067885af51ab8b92776514a54b4f-d60ed.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 613px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 35.07340946166394%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABa0lEQVQoz42R227TQBRF/f+/kZZclKSFPjSCIgJSsB3iW3y3x9dEpDxUQuUNOlk9SdU3kBhp64xmNGfW3sfQWqOPf9eTfuK0miahaxei99jmG8LtFZ47xd1McERReM1+94EguMHgP9auVyi1JPBv2QZ3lMUX4uijNL6TxguybMnDg09T2xiO8nB2Pt4uwOm8F7UuTu+xVhvuf9xzOHzHdSySxKdtciHOaducvi+FTNF3JUURyVmFMXBHjKs5w2LKSM0YxEOG5ZT5/oZJfcU2i7CtT/x6/ExVvmWzHhAGY/ngQuxenKvnXPL4c0mWimUrt/laWaxKU6rNSpnnvSn4q8Kk2/dC0ZOmrsijrhKqKpYIIqEKxb6oPNGlQqwkQw36t+b458jxtYpezvQ5w8OhE5JbIVqIvW+SlSV1fd63jS3DWotsicLBkOf/HMbrXV2HqHJOEs1QxTVpPBPbI3z3NPEx0XZCns1I4nc8A1yF9EE34qg5AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 12 31 10 58 18" title="" data-src="/static/2024-12-31-10-58-18-61dd067885af51ab8b92776514a54b4f-d60ed.png" data-srcset="/static/2024-12-31-10-58-18-61dd067885af51ab8b92776514a54b4f-a256c.png 200w,\n/static/2024-12-31-10-58-18-61dd067885af51ab8b92776514a54b4f-56b73.png 400w,\n/static/2024-12-31-10-58-18-61dd067885af51ab8b92776514a54b4f-d60ed.png 613w" data-sizes="(max-width: 613px) 100vw, 613px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>作为示例，我们继续围绕 Dubbo 中的 Protocol 接口展开讨论。针对 Protocol 接口，Dubbo 提供了包括 GrpcProtocol、DubboProtocol 在内的多个实现类，并通过 SPI 机制完成对具体某种实现方案的加载过程。让我们分别来到提供这些实现类的代码工程 dubbo-rpc-grpc 和 dubbo-rpc-dubbo，会发现在 META-INF/dubbo/internal/ 目录下都包含了一个 com.apache.dubbo.rpc.Protocol 配置文件。</p>\n<p>其中，dubbo-rpc-grpc 工程的代码结构如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-12-31-10-58-59-122efb8516874604704ae7f7b6c79530-97065.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 786px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 38.167938931297705%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAAAy0lEQVQY05WO2wrCMAyG+/5vpYKHOydWVpu108mma3d0dkxrZ1AQQXaxn+SDhD8HEsogTmKlVZwkzrl+jIi5ZpfzyZgWi9HDmFV2EgJM244eRntn6ugYcACt1dNa96d+YCl5f9ubWgvhgxTW2n+TGxD5Om7FBTbrA/Mbpa5p2qjUaP1hf38MXv585bou9jw6m26nEyQGXy3Ycg7LhY6isirzPCvKAolCVnVFfjepPN8DZ8AhwITwGMpQCikY33PsM58jmE/plu4oAH8B6EDKFAXG7MMAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 12 31 10 58 59" title="" data-src="/static/2024-12-31-10-58-59-122efb8516874604704ae7f7b6c79530-97065.png" data-srcset="/static/2024-12-31-10-58-59-122efb8516874604704ae7f7b6c79530-43f99.png 200w,\n/static/2024-12-31-10-58-59-122efb8516874604704ae7f7b6c79530-da390.png 400w,\n/static/2024-12-31-10-58-59-122efb8516874604704ae7f7b6c79530-97065.png 786w" data-sizes="(max-width: 786px) 100vw, 786px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>类似的，dubbo-rpc-dubbo 工程的代码结构如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-12-31-10-59-29-d69cf4df43bef0e654ccec54ca75d19c-2b2cd.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 513px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 55.165692007797276%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABZ0lEQVQoz51TaW+CQBDl//+nNqlt9GO9OHZBEDXhUECQ+3odoLVa04R2srNvsuy+2Tc7CGmc4LA1wLgCx3HIbXCVw/N8dNa2be8UYYwJ3ZSnEY72DsE5RF3XV6J7QowlbNHQ/jILYW412K57/XhLOprwa3NdV4hOe6iaCvfoIi/yf5EOhOR13SC9+DB1hsVqCd3QEcfxnewxLtxmb0h7Hvs4mCoUxpCmKf5qwk9JddMQqQfD2EDTdURRhLIskWVZj2VVoSIvigJ5nvfrSZL0aro14bFOQ+wHATZUT1FagzEZKyoDVxnFDLIsgfMBDWq5rtUsy+prL9y+aDsE3cApOGNDt1TooKZ/4+5wAKNEKsWSIsOyLepZDw51x/WGD21Cso+UUZVESMs54Rri/B1svYLBeY8+/QRJGPZSw/CMkEpTlL8QNpcL3PkC/G0C8fkJ/HVAZfICfTaDNp3CnE2R7/ZfBz8ftcEH8BFOwZ1LiLoAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 12 31 10 59 29" title="" data-src="/static/2024-12-31-10-59-29-d69cf4df43bef0e654ccec54ca75d19c-2b2cd.png" data-srcset="/static/2024-12-31-10-59-29-d69cf4df43bef0e654ccec54ca75d19c-2a6c9.png 200w,\n/static/2024-12-31-10-59-29-d69cf4df43bef0e654ccec54ca75d19c-aed38.png 400w,\n/static/2024-12-31-10-59-29-d69cf4df43bef0e654ccec54ca75d19c-2b2cd.png 513w" data-sizes="(max-width: 513px) 100vw, 513px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>我们分别打开这两个工程的 com.apache.dubbo.rpc.Protocol 配置文件，可以发现它们分别指向了 org.apache.dubbo.rpc.protocol.grpc.GrpcProtocol 和 org.apache.dubbo.rpc.protocol.dubbo.DubboProtocol 类，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30101868669878317000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// dubbo-rpc-grpc 工程\ngrpc=org.apache.dubbo.rpc.protocol.grpc.GrpcProtocol\n\n// dubbo-rpc-dubbo 工程\ndubbo=org.apache.dubbo.rpc.protocol.dubbo.DubboProtocol`, `30101868669878317000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">// dubbo-rpc-grpc 工程\ngrpc=org.apache.dubbo.rpc.protocol.grpc.GrpcProtocol\n\n// dubbo-rpc-dubbo 工程\ndubbo=org.apache.dubbo.rpc.protocol.dubbo.DubboProtocol</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当 Dubbo 在引用具体某一个代码工程时，就可以通过该工程中的配置项找到 Dubbo 接口对应的扩展点实现。</p>\n<p>接下来，就让我们深入探讨 Dubbo 中扩展点的加载机制，为了加载扩展点，Dubbo 专门提供了一个 ExtensionLoader 类，如果我们想要获取 DubboProtocol 的实现类，可以使用如下代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69568140027401770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`DubboProtocol dubboProtocol = ExtensionLoader.getExtensionLoader(Protocol.class).getExtension(DubboProtocol.NAME);`, `69568140027401770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">DubboProtocol</span> dubboProtocol <span class="token operator">=</span> <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Protocol</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token class-name">DubboProtocol</span><span class="token punctuation">.</span>NAME<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>我们来看一下 getExtension 方法的细节，该方法的具体实现过程如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91239042212235430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public T getExtension(String name) {\n   if (name == null || name.length() == 0) {\n      throw new IllegalArgumentException(&quot;Extension name == null&quot;);\n   }\n\n   if (&quot;true&quot;.equals(name)) {\n      return getDefaultExtension();\n   }\n\n   Holder<Object> holder = cachedInstances.get(name);\n   if (holder == null) {\n      cachedInstances.putIfAbsent(name, new Holder<Object>());\n      holder = cachedInstances.get(name);\n   }\n\n   Object instance = holder.get();\n   if (instance == null) {\n      synchronized (holder) {\n         instance = holder.get();\n         if (instance == null) {\n            instance = createExtension(name);\n            holder.set(instance);\n         }\n      }\n   }\n   return (T) instance;\n}`, `91239042212235430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> name<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Extension name == null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"true"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token function">getDefaultExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token class-name">Holder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> holder <span class="token operator">=</span> cachedInstances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>holder <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      cachedInstances<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Holder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      holder <span class="token operator">=</span> cachedInstances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token class-name">Object</span> instance <span class="token operator">=</span> holder<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>holder<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         instance <span class="token operator">=</span> holder<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            instance <span class="token operator">=</span> <span class="token function">createExtension</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            holder<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> instance<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们看到这里用到了缓存，该方法会首先检查缓存中是否已经存在扩展点实例，如果没有则通过 createExtension 方法进行创建。我们一路跟踪 createExtension 方法，发现它又调用了 getExtensionClasses 方法，而 getExtensionClasses 方法内部又使用了 loadExtensionClasses 方法。在 loadExtensionClasses 方法中，我们终于看到了熟悉的 SPI，该方法如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98173240018198230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`private Map<String, Class<?>> loadExtensionClasses() {\n   final SPI defaultAnnotation = type.getAnnotation(SPI.class);\n   if (defaultAnnotation != null) {\n      // 确定缓存名称\n   }\n\n   Map<String, Class<?>> extensionClasses = new HashMap<String, Class<?>>();\n   loadFile(extensionClasses, DUBBO_INTERNAL_DIRECTORY);\n   loadFile(extensionClasses, DUBBO_DIRECTORY);\n   loadFile(extensionClasses, SERVICES_DIRECTORY);\n   return extensionClasses;\n}`, `98173240018198230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">loadExtensionClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">final</span> <span class="token class-name">SPI</span> defaultAnnotation <span class="token operator">=</span> type<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span>SPI<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>defaultAnnotation <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 确定缓存名称</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span> extensionClasses <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token function">loadFile</span><span class="token punctuation">(</span>extensionClasses<span class="token punctuation">,</span> DUBBO_INTERNAL_DIRECTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token function">loadFile</span><span class="token punctuation">(</span>extensionClasses<span class="token punctuation">,</span> DUBBO_DIRECTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token function">loadFile</span><span class="token punctuation">(</span>extensionClasses<span class="token punctuation">,</span> SERVICES_DIRECTORY<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> extensionClasses<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在这里，我们注意到调用了三次 loadFile 方法，分别对应 META-INF/ 目录下的三个子目录。在 loadFile 方法中，可以看到 Dubbo 是直接通过 Class.forName 的反射机制加载这些 SPI 的扩展类，并进行缓存。</p>\n<h3 id="dubbo-中的扩展点"><a href="#dubbo-%E4%B8%AD%E7%9A%84%E6%89%A9%E5%B1%95%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dubbo 中的扩展点</h3>\n<p>在 Dubbo 中存在一大批扩展点，这些扩展点对应于 RPC 架构中的不同组件。事实上，很多 Dubbo 内置的功能组件也都被设计成了扩展点，从而可以被框架的开发人员按需进行替换。</p>\n<p>要想知道 Dubbo 中到底包含了的所有扩展点，我们可以整合所有工程中 META-INF/dubbo/internal/ 目录下的配置文件来进行获取。下图展示了 Dubbo 扩展点分层图：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-12-31-11-00-05-7071a069985c0c24a1365242e074e44e-a40ca.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 647px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 49.45904173106646%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAACMUlEQVQoz42SW2+iUBSF+f+/YB5mMum0drQVKyigaCe2WrWt4gWnFcG71l5iOwgqXtdsThOTeRuSHQ6HnHW+tffikq00lLaKeDuB2liHa7vodrPodlQ09DiajzKGwww+Pt7wPw8XrkdxdB/AsR7EXb8E948Lw0iiXDpF6e4ntHIQbTOO5+cB9vsdNpsVtts11usVVivv8P2554GTrCTkcQrySwqVSQ321Ean8wvjkYp6lUe/l8RomKILwjBbClGLeHyQmIN6LUZ7Kkr3ETz8lvH0lAUXNxMQewqiAwnauIrZ+wyaJuK2eIJi/oRR+lUsHNNhAddX30k0DMsUqep4nz5jMhng9XWE6XQCTmxKiA0SEIYySkMN9ruNRkOGXj9H7voIteo5rXnkb06IKoFc9pgIReqtiJtckFpyQfQR3N2GYTSVT0KhI0MYyIzQt2wYKgmdEeUpHQgRWZwo+tSnDRaLOTxvyfrneQs4zgyu67D3cjkH9yN3im83R/iS/YqckYfz4aBlqMxWgSxXtBDaloRer8XEHMc+lOv6Yvah/D1O6aaQfssg8XaJ6ovOCC0rzXpUzAfImkCEMephgC6KoUDWHx+i9F9CuczT8DLMdttS8TS+AsfrAs6bUQSb/CE2pplmhL5dv4eWGaOJXqDfvaSJ8iSsMCF/EPvdllnfUGS22xUNRZcQqvA40yPQBlXMZ3OKzTUJRIiQBCtRdCj4fg53uz0d9lgGN5v1P4He7z/rLwjfv9x4fWXRAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 12 31 11 00 05" title="" data-src="/static/2024-12-31-11-00-05-7071a069985c0c24a1365242e074e44e-a40ca.png" data-srcset="/static/2024-12-31-11-00-05-7071a069985c0c24a1365242e074e44e-3426a.png 200w,\n/static/2024-12-31-11-00-05-7071a069985c0c24a1365242e074e44e-f3a4f.png 400w,\n/static/2024-12-31-11-00-05-7071a069985c0c24a1365242e074e44e-a40ca.png 647w" data-sizes="(max-width: 647px) 100vw, 647px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>我们无意对上图中所有的扩展点都做详细展开，在这里，我们选择 LoadBalance 作为我们的扩展点示例，以此介绍 Dubbo 中扩展点的具体实现方法。</p>\n<p>首先，让我们来看看 LoadBalance 接口的定义，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61211388235679400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@SPI(RandomLoadBalance.NAME)\npublic interface LoadBalance {\n   <T> Invoker<T> select(List<Invoker<T>> invokers, URL url, Invocation invocation) throws RpcException;\n}`, `61211388235679400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@SPI</span><span class="token punctuation">(</span><span class="token class-name">RandomLoadBalance</span><span class="token punctuation">.</span>NAME<span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">LoadBalance</span> <span class="token punctuation">{</span>\n   <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Invoker</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span><span class="token punctuation">></span></span> invokers<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果我们在 dubbo-cluster 工程中找到 META-INF/dubbo/internal/org.apache.dubbo.rpc.cluster.LoadBalance 配置文件，不难想象该文件中定义了我们已知的四个 LoadBalance 扩展实现，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20081894712169280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`random=org.apache.dubbo.rpc.cluster.loadbalance.RandomLoadBalance\nroundrobin=org.apache.dubbo.rpc.cluster.loadbalance.RoundRobinLoadBalance\nleastactive=org.apache.dubbo.rpc.cluster.loadbalance.LeastActiveLoadBalance\nconsistenthash=org.apache.dubbo.rpc.cluster.loadbalance.ConsistentHashLoadBalance`, `20081894712169280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">random=org.apache.dubbo.rpc.cluster.loadbalance.RandomLoadBalance\nroundrobin=org.apache.dubbo.rpc.cluster.loadbalance.RoundRobinLoadBalance\nleastactive=org.apache.dubbo.rpc.cluster.loadbalance.LeastActiveLoadBalance\nconsistenthash=org.apache.dubbo.rpc.cluster.loadbalance.ConsistentHashLoadBalance</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，在 LoadBalance 接口上存在 @SPI 注解，代表它是一个扩展点。而该解中的参数 RandomLoadBalance.NAME 表示该扩展点的默认实现是随机（random）算法，关于 Dubbo 中负载均衡算法，你可以结合之前做一些回顾。</p>\n<h2 id="解题要点-23"><a href="#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-23" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解题要点</h2>\n<p>对于微内核架构而言，我们首先需要明确它的组成作用。面试官会考查候选人对微内核架构基本概念的理解程度，该架构的作用还是提供了一个可以高度扩展的实现机制，是很多开源框架中实现系统扩展性的首选架构模式。从知识体系上讲，关于微内核架构的基本概念本讲都做了详细的介绍，回答时只要有条理地进行说明即可。</p>\n<p>回答这类问题时的一个建议是，可以把设计思想拔高到架构层次，从扩展性角度进行切入。同时，微内核架构确实应用非常广泛，像 Dubbo 框架以及主流的分库分表中间件 ShardingSphere 等开源框架都用到了这个架构模式。如果能够有所发散，展示一些自己的知识面，是一种加分策略。</p>\n<p>关于 SPI 机制也是常见的考查点。我们首先要明白 API 和 SPI 的区别，API 面向的是框架的用户，而 SPI 面向的是框架的开发人员。SPI 在本质上是提供给服务提供商与扩展框架功能的开发者使用的接口。</p>\n<p>回答这个问题时，我们可以先围绕 SPI 的定义，即服务提供接口 Service Provider Interface 来进行展开。然后，结合微内核架构的设计思想给出进一步的说明。本讲介绍了 SPI 机制的一种具体实现，即基于 JDK 的 ServiceLoader 类完成 SPI 实现的加载和管理，并给出了基于 ServiceLoader 类的具体使用案例。这也是理论联系实践的一种介绍方法，即先阐述理论知识，然后再给出案例的说明即可。当然，如果你对 JDK 的 ServiceLoader 类的实现原理有兴趣，也可以进行进一步的深入学习，我们在本讲内容中也基于 Dubbo 框架再次对微内核模式以及 ServiceLoader 类进行讨论。</p>\n<p>结合 SPI 和 Dubbo 框架，面试官会考查 Dubbo 中实现的 SPI 机制与 JDK 中默认的方式的不同点。这个问题也比较典型，在实际面试过程中经常被问到。针对这个问题，我们也需要明确，所谓的 SPI 机制只是一种设计理念，而具体的实现策略视框架的不同会有所差别。虽然 Dubbo 也采用了 SPI 机制，也是从 JAR 中加载对应的扩展类，但它的实现方式与 JDK 中基于 ServiceLoader 是不一样的。我们需要从这两方面的差异点出发来梳理这个问题的解答思路。</p>\n<p>基于本讲中给出的内容，就加载 SPI 实例的配置文件位置而言，Dubbo 支持更多的加载路径。同时，Dubbo 采用的是直接通过名称对应的 Key 值来定位具体的实现类，而 ServiceLoader 内部使用的是一个迭代器，在获取目标接口的实现类时只能通过遍历的方式把配置文件中的类全部加载并实例化，显然效率比较低下。Dubbo 中专门采用了与 JDK 不同的 SPI 实现机制，主要目的就是克服这种效率低下的情况，并提供更多的灵活性。</p>\n<h2 id="小结与预告-21"><a href="#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-21" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结与预告</h2>\n<p>本讲内容我们剖析分布式主流开源框架中所采用的一种常见架构模式，即微内核架构模式。对于微内核架构模式，我们关注它的基本概念以及 JDK 中所提供的 SPI 实现方式。而结合具体的开源框架，我们发现 Dubbo 中实现微内核架构采用了与 JDK 所提供的这套机制类似的设计思路，但并没有直接照搬而是重新提供了一套自己的实现机制。</p>\n<p>下一讲，我们继续讨论分布式系统构建过程中另一种具体代表性的架构模式，即管道-过滤器模式。可以说，管道-过滤器是所有请求-响应类框架中的标准组件。那么，为什么它会应用如此广泛？这个架构模式到底能用来解决什么问题呢？我们下一讲中再聊。</p>\n<h1 id="流程定制：管道-过滤器架构能用来解决什么问题？"><a href="#%E6%B5%81%E7%A8%8B%E5%AE%9A%E5%88%B6%EF%BC%9A%E7%AE%A1%E9%81%93-%E8%BF%87%E6%BB%A4%E5%99%A8%E6%9E%B6%E6%9E%84%E8%83%BD%E7%94%A8%E6%9D%A5%E8%A7%A3%E5%86%B3%E4%BB%80%E4%B9%88%E9%97%AE%E9%A2%98%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>流程定制：管道-过滤器架构能用来解决什么问题？</h1>\n<p>在上一讲中，我们基于微内核架构模式讨论了系统扩展性的实现方式。掌握架构模式的难度在于每个模式看上去都能够理解但就是不知道如何应用，固然在日常开发过程中多尝试应用这些模式有助于提高自身的设计能力，但通过阅读源代码来加深对架构模式的理解和掌握是一条捷径。</p>\n<p>在本讲内容中，我们将继续引出另一种可以用来实现系统扩展性的架构模式，这就是管道-过滤器模式。和微内核架构相比，管道-过滤器模式更加通用，几乎所有请求-响应式的系统中都可以用到这种架构模式。也正是因为这一点，管道-过滤器模式也经常出现在各大公司的面试环节。</p>\n<p>那么，什么是管道-过滤器架构？它究竟能用来解决什么问题？本讲内容将给出答案。</p>\n<h2 id="问题背景-21"><a href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-21" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题背景</h2>\n<p>很多系统都存在固定的主流程，执行该主流程就能完成系统的核心功能。但在现实开发过程中，我们往往希望在主流程中添加一些附加流程，一方面确保主流程的执行不受影响，另一方面又可以通过这些额外流程来完成一些定制化需求。通常，这里的主流程面向业务核心功能，而附加流程则更多关注非功能性需求或扩展性需求。管道-过滤器模式就是用来应对这类场景。</p>\n<p>下图展示了这一层抽象概念：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2025-01-08-11-34-07-2f96774ebb6b733040d7ddf36e54b84e-0e897.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 578px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 86.50519031141869%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAACM0lEQVQ4y4WUeY8SQRDF5/t/GDXqHybGI05Y0MixhBWG+77vmxng2b82jaxZoZKhe3qqXr2qV42XTL7WcPBFv3JvVAzeq9v5qKenrzqfZexsVruxq9uHYajHx3fq9z4pl32lQv6tBv3PSqU+yAsCX9NJWtWqr2bjQaPhT9VqmWeAPKfT6QIYRZHKpQeNR0nV6zF12t81HqdULP6QF4ZH7XahVqutttuD9vtIx+OfwFsWRSfD9GRjiWPlzHMO+/3ePDvD4mQAIx0OoS1tPp8bxjUVCgXNZjPL7nA4WJ/tdqNKpXJhjnmupHa7rWazaQGm06nW67UJ2BrmK41GI/X7fS0WC3u22WwMo519TyQSWi6XfwGPx6Opf6xcLqdWqyXeASXglkECxrBvNBo2CUQ8Suh2u/J93whT1WQyubC7Vvf6wUhcKpUUj8ctIJVw5tEPKFPSYDCw/QGQjPcAiaGHsIQtk+DxAwCHnU7HAtECRLplANJDYui/66nnMlIqPcDxevZw5BvCsLrvfMNIzrmr5gJI2bFYzIoDCCWQkTaUy2UFQWBXknKOcPSN/rN/NjbYcDi0KmMu+z2V8aOPvV7PzixEPMcuk8mYa1S3h2R0Wf8nCn7ZbNbGwZJpAdxzffC/+XYMKAdBWF9i6gDxyefzSqfT9hZRPm26MER+qLNndO4BuhtDq2CIL3vPfeTaIQCZyQbgNcC/gKjNuDHUxDohL6JQP/KTiQZf/w++xNKdk/z6mv4GsqcZWsHku5wAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2025 01 08 11 34 07" title="" data-src="/static/2025-01-08-11-34-07-2f96774ebb6b733040d7ddf36e54b84e-0e897.png" data-srcset="/static/2025-01-08-11-34-07-2f96774ebb6b733040d7ddf36e54b84e-d60f6.png 200w,\n/static/2025-01-08-11-34-07-2f96774ebb6b733040d7ddf36e54b84e-6689e.png 400w,\n/static/2025-01-08-11-34-07-2f96774ebb6b733040d7ddf36e54b84e-0e897.png 578w" data-sizes="(max-width: 578px) 100vw, 578px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可以看到，我们在请求和响应的前后添加一组定制化组件。上图看上去比较简单，但实现过程其实是很有难度的，我们需要考虑的点有很多，包括：</p>\n<ul>\n<li>如何在主流程中找到合适的切入点来添加定制化组件？</li>\n<li>这些定制化组件如何不影响到主流程的执行过程？</li>\n<li>有多个定制化组件时，我们如何管理它们的执行顺序？</li>\n<li>如何确保上一个定制化组件的输出能够成为下一个定制化组件的输入？</li>\n<li>这些定制化组件之间如何确保足够的解耦？</li>\n</ul>\n<p>围绕这些问题，我们可以采用很多不同的实现策略。而管道-过滤器架构天生就为我们管理上图中的各种定制化组件提供了解决方案。围绕管道-过滤器架构，我们也可以引出一些常见的面试题，如下所示：</p>\n<ul>\n<li>你所知道的管道-过滤器架构的应用场景有哪些？</li>\n<li>管道-过滤器架构的基本组成结构是怎么样的？</li>\n<li>如何管理多个过滤器之间的协作关系？</li>\n<li>如何高效构建一个过滤器链？</li>\n<li>Dubbo 中是如何实现管道-过滤器架构的？</li>\n<li>如果想要在 Dubbo 中实现一个自定义的过滤器，你会怎么做？</li>\n<li>Mybatis 中是如何实现管道-过滤器架构的？</li>\n<li>如果想要在 Mybatis 中实现一个自定义的过滤器，你会怎么做？</li>\n</ul>\n<p>针对不同的框架，类似上面所示的这些面试题还可以罗列很多。这些面试题既有概念，又有实践，有些还和日常开发过程中的一些需求息息相关，需要我们对这些问题背后的考点做细化分析。</p>\n<h2 id="问题分析-22"><a href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-22" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题分析</h2>\n<p>我们先来把管道-过滤器架构与上一讲中介绍的微内核架构做一个对比。</p>\n<p>本质上，微内核架构使用了一种插件化机制来对系统中组件与组件之间的调用关系进行扩展，从而增强系统构建的灵活性。而在请求-响应式的系统中，管道-过滤器实现扩展性采用的是类似切面（Aspect）的设计理念。基于这一架构模式，我们可以在请求流程中嵌入那些非功能的处理逻辑，这些处理逻辑的添加和删除过程相互独立，而且对于请求流程而言是无感知的。这是我们回答这类问题的第一个要点，即管道-过滤器模式能够解决的问题以及适用的具体场景。</p>\n<p>第二个需要考虑的要点是，如何动态把握请求的处理流程？我们首先想到的是诸如适配器模式等常见的设计模式，但设计模式主要关注细粒度的微观设计，并不适合高层次的体系结构设计。从结构上讲，管道-过滤器是一种组合行为，主功能是以切面的方式实现。管道-过滤器具有高度抽象化的通用结构和功能特性。</p>\n<p>最后，不可否认，在分布式系统构建过程中，管道-过滤器可以说是不可缺少的一种技术组件。当我们在阅读一些开源框架的源码时，看到 Filter（过滤器）或 Interceptor（拦截器）等名词时（如 Dubbo 用的是 Filter，而 Mybatis 用的是 Interceptor），往往就是碰上了管道-过滤器模式。因此，应对这类问题的第三个要点就是掌握管道-过滤器模式在主流开源框架中的应用方式和实现原理。</p>\n<h2 id="技术体系-24"><a href="#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-24" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术体系</h2>\n<p>管道-过滤器架构模式是用于解决适配和扩展性问题的代表性架构模式，结构上主要包括过滤器和管道两种元素，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2025-01-08-11-35-37-df5b3c500a86017f100c6926ca91ea7a-54e16.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 599px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 36.39398998330551%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABhElEQVQoz22SYU/aUBSG+/+/bt/mp2WJyTKnGEYCg04nVrRCEVAo4OqmKC0tSDdoldJnh4tsWbKTNPek581z3nvO1Wy7Sr93xv3gG6u4ujzi3HyPebqDVftI4yJLGIaq9vQUM5ut82UKXbuitKeVD9Rru9StLFqp+Ibzsy0u6jrTaYTd0XmOT6icvGPk6jxODIbDoYK0miammSdJlkwmP7nuHxFHBkb5LePgQL5jtEbjEMcp0+83SKWrVftMt7MvTvfp2Vnpusd4PFZAV8COs75JkqwaHGK3M1y2MnLLHFZ1D21T3MR8HuH7LkHgvZwjUv4fYTjF8x7w3Hul9X0PLU3X8iAYigNHBD8g/YuIohnNZklcfBHXB7RaRQZ3vX/A83n8JxfgUiVWLYdefEUh/5qbm664TlksFjK/W/yRTqe9S9Xc5lf4lfZVWRaUqCVFUSyNjmX+/gaYvmy3zHUvL+CMQO7Uv1XJdQcy/E/cfi9IPSevoSBaQ9WSZCHQZwyjpEazit8U0QExlVTwKwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2025 01 08 11 35 37" title="" data-src="/static/2025-01-08-11-35-37-df5b3c500a86017f100c6926ca91ea7a-54e16.png" data-srcset="/static/2025-01-08-11-35-37-df5b3c500a86017f100c6926ca91ea7a-e3250.png 200w,\n/static/2025-01-08-11-35-37-df5b3c500a86017f100c6926ca91ea7a-a3cce.png 400w,\n/static/2025-01-08-11-35-37-df5b3c500a86017f100c6926ca91ea7a-54e16.png 599w" data-sizes="(max-width: 599px) 100vw, 599px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在管道-过滤器结构中，执行定制化功能的组件被称为过滤器，负责执行具体的业务逻辑。每个过滤器都会接收来自主流程的请求，并返回一个响应结果到主流程中。而另一方面，管道用来获取来自过滤器的请求和响应，并把它们传递到后续的过滤器中，相当于是一种通道。同时，在管道-过滤器模式中，一般都会存在一个过滤器链（Filter Chain） 的概念。过滤器链带有多个过滤器，并按照链中的顺序执行过滤器。</p>\n<p>管道-过滤器风格的一个典型应用是 Web 容器的过滤器机制。例如，下图所示的就是 Nginx 中对 HTTP 请求的响应过程，可以看到在生成最终的 HTTP 响应之前，可以通过添加多个 Filter 对由处理器所产生的输出内容进行处理。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2025-01-08-11-36-55-5eb36a43fe21d94ecf928d3413d8c6d4-5d925.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 508px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 71.06299212598425%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAACZElEQVQ4y3VT2W7aQBTlx/gFPgaJL0A8894+VK3apmmLEqlVUhICCUlYk+CwGbM5LGEHs4XFBk7vjHEKgV7pasae4zP3nnts0jQNLBwOB8xmMxaLBX9eLpdYrVY8WRh749xut8Nqte5gTQah0+mExWLBvtgkNQhZATabbQdrWq2Wa/ASmqZiOp2g2+1CURQMBoNXAqMCVg0LRelhPB7h5WWMXq9L2eN4k8GsKEM0mx3U6y2USlWUyxUUCgXMZrOtKjfxo9EE1Wodlcoz4cuQZRkmSXpEsSjg/s6H25tTOkwjm33glb5teT5XkZUE5PMPSCQCSKdCRBJHIR+Hqqp6y3fRb5CLR0gnv0NM/6D1EJJ4iHIp9yqFQdhoNAh7gn7Pgwxh448H6LTO0GlfIJfN6ISpZJgO/IiEzxEI/IEgXCEWuyI9+lvasZhOp8iIEUhSEN6LI3g8LuRyEXoXovaHOqHR1nyukciTvdPdp2G93kW7bVz6D2MypsYmxian+2qx4z8Wk8mEqguTbmGk036I4jWKhRBpHsKg3zdss1oTjrlV3pJs7pvNJjKZY9Sqv2iIn3B7/R75nAu151Nape2WmT0Y6WaLm6nLMsfTk0hOEBEOexEKevhelpNcX06oqgt6UFEmL6VSGSLWyKwz/C+YQszrtXqba8j2659N11AQzkgHHxLxE2rjmEr3IZV0o1KWSbMpTW/Ek+nHjJtInJOl/ORBN1nMTd9ekmUu0Wo19QqDga+I3X9BKPCR1gMEbj4Q8WciTnHC4XDIk0kSjUYhxH6iJP9GkPA+7zvyrosucNNlBU74F8sXETRThJdcAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2025 01 08 11 36 55" title="" data-src="/static/2025-01-08-11-36-55-5eb36a43fe21d94ecf928d3413d8c6d4-5d925.png" data-srcset="/static/2025-01-08-11-36-55-5eb36a43fe21d94ecf928d3413d8c6d4-7e12f.png 200w,\n/static/2025-01-08-11-36-55-5eb36a43fe21d94ecf928d3413d8c6d4-6877e.png 400w,\n/static/2025-01-08-11-36-55-5eb36a43fe21d94ecf928d3413d8c6d4-5d925.png 508w" data-sizes="(max-width: 508px) 100vw, 508px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>从上图中，我们可以看到管道-过滤器模式的特点在于把一系列的定制化需求转换成一种类似数据流的处理方式，数据通过管道流经一系列的过滤器，在每个过滤器中完成特定的业务逻辑。显然，每个过滤器能够独立完成自身的职责而不需要依赖于其他过滤器。这种特性使得系统的扩展性得到了巨大的提升，因为过滤器之间没有耦合度，所以我们可以很容易对现有的过滤器进行替换，而动态添加和删除过滤器也不会对整个处理流程产生任何影响。</p>\n<p>在 Dubbo 和 Mybaits 框架中都应用了管道-过滤器模式，而且也都提供了基于过滤器链的实现方式，让我们先来看看它在 Dubbo 中的应用。</p>\n<h2 id="源码解析-22"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-22" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h2>\n<h3 id="管道-过滤器模式在-dubbo-中的应用"><a href="#%E7%AE%A1%E9%81%93-%E8%BF%87%E6%BB%A4%E5%99%A8%E6%A8%A1%E5%BC%8F%E5%9C%A8-dubbo-%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>管道-过滤器模式在 Dubbo 中的应用</h3>\n<p>Dubbo 中的过滤器概念基本上符合我们对管道-过滤器模式的理解。在接下来的内容中，我们先来看一下 Dubbo 中过滤器链的构建过程，然后介绍 Dubbo 中现有过滤器的实现方法。</p>\n<p>Dubbo 的过滤器实现入口是在 ProtocolFilterWrapper 类中，在服务暴露和服务引用时都会使用到过滤器链。所谓的 Wrapper，顾名思义，是对扩展类的一种包装，如下图所示：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2025-01-08-11-37-36-abb6442e29209da625fa702618293ec3-8e7aa.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 362px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 89.22651933701657%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsSAAALEgHS3X78AAADYUlEQVQ4y31UaVfbVhT0f+/HfuiXnJ7T5CSkicGrbAnb8ibbWrwvsrxjNpOGEPACFAMhJjAdy0uBnvTDnKv37tXoau6858j1CxALIgKqgKAuIKAxrsB1uLBtI1JkzEvcCzzLz+vDBQliNoi4lYRjuxeD0fZiepXDcKJidK5hvMR8XTXdsFo+WE0f2p0ATkcZjC/0df7vaQ754ib8wm8IdUQ4pHYU1n4YQA94tBgb/4Lrv45i6LaDqJZd9jMe6s/yQBuDwxj0zAbktgSH2IqieRhhok80idYL7CxzK3Re5Ofv7GF6kYXUCMAh9xWE8u/R6omo85eewuoFUWv5YbYFmB0BFcuLYtUFqxtc18xzzb6ElLGBgCXAoZ/kkb2vIHqahm8vBP8gAv9hGAK7dpJkk/AdhG24dkT8rr+Fe1eCcCTDN69jvTiQod0WkR7qcGhfcqhTh/SFAaEdQJJEcWoa2w3hXeIPJA8i0I4TNjKf44iTWGoJdk2amkbZROxYQZWaapPsirCFyFka3sRrzKZFXE50XJ0bti7VghOl3EeU806YJRfO+PL1ZQ5TQhZfwbX1K+SjBMpkUZ8Shk9T2M59WA6hsRS7gdFIxWAQxc6OhJOTFGaz2nogn47iyBa2EBnESGj9l1BUN1jYXVhjbomlLRaT7S6stbLLj7o99f19argbQYX7a0KT3STGGj6k3iDX8EEzPdCJLJ/VqodwQ6t5EFLeIFNxwagvaoy6F8HMO4TYYWXVoU7CGgkV6pbhaSmz2wLXRUb1roz4ZdZezxE8jkP9XrFzc5S4V2ZnyTMVpQfzOWGSWmnXBShfU4jyyxlOOWD8CUF/j0x/G6muyMiJNvxQOkHIppdG9qH0WP85of6thDCP2eSLgtlNCVcTA3s0cY8kBxxKk6Y++RTHmJ7devsLvOFXMNixMtR+0uFNEfG9CO5uy/YgHin+3V0Ft9/KjFXc3JYwu6/hkXqNzjLQLWrJJpTRE0JtRThcdCh3JVyPdeDexMP3KmPNfl5H2sben+vKzlV+JEXC4o8a1LEBh3FaoKxdpM51qByKzGMkl5xQGl4k6x4kXiC5RIK/L5Q2keMvJ4cZ+6QYl3leDu045OMkJHrJWXbDbfnhrBOmz8bH/4GLl8EmbeXhLRMjR7Adwj+J0M5qdqeqNQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2025 01 08 11 37 36" title="" data-src="/static/2025-01-08-11-37-36-abb6442e29209da625fa702618293ec3-8e7aa.png" data-srcset="/static/2025-01-08-11-37-36-abb6442e29209da625fa702618293ec3-acee0.png 200w,\n/static/2025-01-08-11-37-36-abb6442e29209da625fa702618293ec3-8e7aa.png 362w" data-sizes="(max-width: 362px) 100vw, 362px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>Dubbo 中的包装类同样实现扩展点接口，具有与扩展点一样的方法。目前，纵观整个 Dubbo 框架，只存在一个 Wrapper，即 ProtocolFilterWrapper。ProtocolFilterWrapper 类实现了 Protocol 接口，并具有如下所示的 export 和 refer 方法实现。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77291389952185880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public <T> Exporter<T> export(Invoker<T> invoker) throws RpcException {\n   if (Constants.REGISTRY_PROTOCOL.equals(invoker.getUrl().getProtocol())) {\n      return protocol.export(invoker);\n   }\n\n   return protocol.export(buildInvokerChain(invoker, Constants.SERVICE_FILTER_KEY, Constants.PROVIDER));\n }\n\npublic <T> Invoker<T> refer(Class<T> type, URL url) throws RpcException {\n   if (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) {\n      return protocol.refer(type, url);\n   }\n\n   return buildInvokerChain(protocol.refer(type, url), Constants.REFERENCE_FILTER_KEY, Constants.CONSUMER);\n}`, `77291389952185880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Exporter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> invoker<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>REGISTRY_PROTOCOL<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> protocol<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">return</span> protocol<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token function">buildInvokerChain</span><span class="token punctuation">(</span>invoker<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>SERVICE_FILTER_KEY<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>PROVIDER<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n <span class="token punctuation">}</span>\n\n<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">refer</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> type<span class="token punctuation">,</span> <span class="token class-name">URL</span> url<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>REGISTRY_PROTOCOL<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> protocol<span class="token punctuation">.</span><span class="token function">refer</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">return</span> <span class="token function">buildInvokerChain</span><span class="token punctuation">(</span>protocol<span class="token punctuation">.</span><span class="token function">refer</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>REFERENCE_FILTER_KEY<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>CONSUMER<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到这两个方法都使用了一个名为 buildInvokerChain 的方法，从命名上看，该方法就是用来构建调用链，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6280344673127058000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`private static <T> Invoker<T> buildInvokerChain(final Invoker<T> invoker, String key, String group) {\n   Invoker<T> last = invoker;\n   List<Filter> filters = ExtensionLoader.getExtensionLoader(Filter.class).getActivateExtension(invoker.getUrl(), key, group);\n   if (filters.size() > 0) {\n      for (int i = filters.size() - 1; i >= 0; i--) {\n         final Filter filter = filters.get(i);\n         final Invoker<T> next = last;\n         last = new Invoker<T>() {\n            // 这里构造一个最简化的 Invoker 作为调用链的载体 Invoker\n         };\n      }\n   }\n   return last;\n}`, `6280344673127058000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">buildInvokerChain</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> invoker<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> group<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> last <span class="token operator">=</span> invoker<span class="token punctuation">;</span>\n   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">></span></span> filters <span class="token operator">=</span> <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Filter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getActivateExtension</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>filters<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> filters<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">final</span> <span class="token class-name">Filter</span> filter <span class="token operator">=</span> filters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">final</span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> next <span class="token operator">=</span> last<span class="token punctuation">;</span>\n         last <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 这里构造一个最简化的 Invoker 作为调用链的载体 Invoker</span>\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">return</span> last<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们在这里看到了用于获取扩展点的 ExtensionLoader。注意，这里对通过扩展点加载的过滤器进行了排序，从而确保过滤器链按设想的顺序进行执行。</p>\n<p>看完过滤器链，我们反过来看一下过滤器。Dubbo 中的 Filter 接口定义如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2340300787606497300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@SPI\npublic interface Filter {\n   Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException;\n}`, `2340300787606497300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token annotation punctuation">@SPI</span>\n<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>\n   <span class="token class-name">Result</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> invoker<span class="token punctuation">,</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到 Filter 接口能够获取传入的 Invoker，从而对其进行拦截和处理。针对 Filter 接口，Dubbo 中一共存在 21 个实现类，我们无意对所有这些过滤器组件做详细展开，而是挑选一个代表性的 Filter 进行介绍，这里我们选择 TokenFilter。</p>\n<p>TokenFilter 的作用很明确，即通过 Token 进行访问鉴权，通过比对 Invoker 中的 Token 和输入参数中的 Token 来判断请求是否合法，其代码实现如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12363288502830260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class TokenFilter implements Filter {\n   public Result invoke(Invoker<?> invoker, Invocation inv) throws RpcException {\n      String token = invoker.getUrl().getParameter(Constants.TOKEN_KEY);\n      if (ConfigUtils.isNotEmpty(token)) {\n         Class<?> serviceType = invoker.getInterface();\n         Map<String, String> attachments = inv.getAttachments();\n         String remoteToken = attachments == null ? null : attachments.get(Constants.TOKEN_KEY);\n         // 比对 Token\n         if (!token.equals(remoteToken)) {\n            // ...\n         }\n      }\n      return invoker.invoke(inv);\n   }\n}`, `12363288502830260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>\n   <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> invoker<span class="token punctuation">,</span> <span class="token class-name">Invocation</span> inv<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>\n      <span class="token class-name">String</span> token <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>TOKEN_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ConfigUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> serviceType <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">getInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> attachments <span class="token operator">=</span> inv<span class="token punctuation">.</span><span class="token function">getAttachments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token class-name">String</span> remoteToken <span class="token operator">=</span> attachments <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> attachments<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>TOKEN_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token comment">// 比对 Token</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>remoteToken<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// ...</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>inv<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上述代码中，我们关注两点。首先我们看到可以通过 invoker.getUrl 方法获取 Invoker 中的 URL 对象，而我们知道 Dubbo 中的 URL 作为统一数据模型，以 Key-Value 对的形式包含了所有服务调用过程中的参数。同时，我们看到了 Invocation 对象，该对象可以理解为是一种 DTO（Data Transfer Object，数据传输对象），用来封装所需要传递的数据。这样，一方面我们通过 URL 对象获取本地 token 参数，另一方面，我们通过 Invocation 也获取了 remoteToken，从而可以执行对比和校验操作。这也是 Dubbo 中处理调用信息传递的非常常见的一种做法，我们可以在很多地方看到类似的代码。</p>\n<p>最后，让我们基于对 Dubbo 中过滤器机制的理解来实现一个自定义的过滤器组件。这个过滤器非常简单，就是记录一下 invoke 调用所使用的时间，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84321656948763820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class TimeLogFilter implements Filter {\n   private static Logger log = LoggerFactory.getLogger(TimeLogFilter.class);\n\n   @Override\n   public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {\n      long start = System.currentTimeMillis();\n      Result result = invoker.invoke(invocation);\n      long elapsed = System.currentTimeMillis() - start;\n      if (invoker.getUrl() != null) {\n         log.info(&quot;[{}], [{}], {}, [{}], [{}], [{}]&quot;, invoker.getInterface(), invocation.getMethodName(), Arrays.toString(invocation.getArguments()), result.getValue(), result.getException(), elapsed);\n      }\n      return result;\n   }\n}`, `84321656948763820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TimeLogFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>\n   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Logger</span> log <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">TimeLogFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token annotation punctuation">@Override</span>\n   <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Invoker</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> invoker<span class="token punctuation">,</span> <span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RpcException</span> <span class="token punctuation">{</span>\n      <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token class-name">Result</span> result <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">long</span> elapsed <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[{}], [{}], {}, [{}], [{}], [{}]"</span><span class="token punctuation">,</span> invoker<span class="token punctuation">.</span><span class="token function">getInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invocation<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>invocation<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">getException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> elapsed<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span> result<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，在 Dubbo 中，我们通过实现 Filter 接口并传入 Invoker 和 Invocation 对象就可以完成一个自定义过滤器的开发工作。</p>\n<h3 id="管道-过滤器模式在-mybatis-中的应用"><a href="#%E7%AE%A1%E9%81%93-%E8%BF%87%E6%BB%A4%E5%99%A8%E6%A8%A1%E5%BC%8F%E5%9C%A8-mybatis-%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>管道-过滤器模式在 Mybatis 中的应用</h3>\n<p>在 Mybatis 中，管道-过滤器模式通过拦截器的概念进行体现。而对外进行暴露时，则用到了 Plugin 配置项。想要在 Mybatis 中使用管道-过滤器模式，那就需要在配置文件中添加类似如下所示的配置项，可以看到在 <code class="language-text">&lt;plugin&gt;</code> 配置段中可以添加一个自定义的 interceptor 配置项。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92824352495983900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<configuration>\n   <plugins>\n      <plugin interceptor=&quot;com.tianyalan.mybatis.interceptor.MyInterceptor&quot;>\n         <property name=&quot;prop1&quot; value=&quot;prop1&quot;/>\n         <property name=&quot;prop2&quot; value=&quot;prop2&quot;/>\n      </plugin>\n   </plugins>\n</configuration>`, `92824352495983900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="xml"\n              >\n                <span class="gatsby-code-button-language">xml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="xml"><pre style="counter-reset: linenumber NaN" class="language-xml line-numbers"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span> <span class="token attr-name">interceptor</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.tianyalan.mybatis.interceptor.MyInterceptor<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>\n         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>prop1<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>prop1<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>\n         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>prop2<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>prop2<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后，在解析 XML 配置文件的 XMLConfigBuilder 类中，我们找到了解析 <code class="language-text">&lt;plugin&gt;</code> 配置段的代码，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59479147395524160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`private void pluginElement(XNode parent) throws Exception {\n   if (parent != null) {\n      for (XNode child : parent.getChildren()) {\n         String interceptor = child.getStringAttribute(&quot;interceptor&quot;);\n         Properties properties = child.getChildrenAsProperties();\n         Interceptor interceptorInstance = (Interceptor) resolveClass(interceptor).newInstance();\n         interceptorInstance.setProperties(properties);\n         configuration.addInterceptor(interceptorInstance);\n      }\n   }\n}`, `59479147395524160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">pluginElement</span><span class="token punctuation">(</span><span class="token class-name">XNode</span> parent<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">XNode</span> child <span class="token operator">:</span> parent<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token class-name">String</span> interceptor <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"interceptor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token class-name">Properties</span> properties <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getChildrenAsProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token class-name">Interceptor</span> interceptorInstance <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Interceptor</span><span class="token punctuation">)</span> <span class="token function">resolveClass</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         interceptorInstance<span class="token punctuation">.</span><span class="token function">setProperties</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         configuration<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>interceptorInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在上述代码中，我们看到了 Mybatis 中代表过滤器的 Interceptor 接口。我们根据配置的 interceptor 属性实例化 Interceptor 对象，然后通过 configuration.addInterceptor 方法添加新的 Interceptor 实例。我们跟踪代码，发现 Configuration 中定义了一个如下所示的 InterceptorChain 对象，该方法就是将 Interceptor 实例添加到了 InterceptorChain 中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60772553837800320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`protected final InterceptorChain interceptorChain = new InterceptorChain();`, `60772553837800320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">InterceptorChain</span> interceptorChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InterceptorChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这样，管道-过滤器模式中代表过滤器（Interceptor）和过滤器链（InterceptorChain）的相关对象都出现了，让我们首先从这些对象的定义和实现入手探究 Mybatis 的内部原理。</p>\n<p>在 Mybatis 中，Interceptor 和 InterceptorChain 都位于 org.apache.ibatis.plugin 包中，其中 Interceptor 是个接口，InterceptorChain 是个实体类，它们的代码看上去都不多。让我们先来看一下 InterceptorChain 类，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20153225241519480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class InterceptorChain {\n   private final List<Interceptor> interceptors = new ArrayList<>();\n\n   public Object pluginAll(Object target) {\n      for (Interceptor interceptor : interceptors) {\n         target = interceptor.plugin(target);\n      }\n      return target;\n   }\n\n   public void addInterceptor(Interceptor interceptor) {\n      interceptors.add(interceptor);\n   }\n\n   public List<Interceptor> getInterceptors() {\n      return Collections.unmodifiableList(interceptors);\n   }\n}`, `20153225241519480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InterceptorChain</span> <span class="token punctuation">{</span>\n   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Interceptor</span><span class="token punctuation">></span></span> interceptors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">pluginAll</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Interceptor</span> interceptor <span class="token operator">:</span> interceptors<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         target <span class="token operator">=</span> interceptor<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span> target<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token class-name">Interceptor</span> interceptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      interceptors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Interceptor</span><span class="token punctuation">></span></span> <span class="token function">getInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span>interceptors<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，这个 InterceptorChain 同样提供了 addInterceptor 方法用于将拦截器添加到链中。不同之处在于，它在这里持有一个 interceptors 数组用于把新加入的 Interceptor 添加到这个数组中。通过这种方式，在 pluginAll 方法中就可以直接遍历 interceptors 数组并基于每个 interceptor 执行拦截逻辑。</p>\n<p>在 InterceptorChain 中，我们尚不明确的就是 interceptor.plugin(target) 方法的逻辑，让我们把思路跳转到 Interceptor 接口，该接口定义如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42857937135862874000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public interface Interceptor {\n   Object intercept(Invocation invocation) throws Throwable;\n\n   default Object plugin(Object target) {\n      return Plugin.wrap(target, this);\n   }\n\n   default void setProperties(Properties properties) {\n      // NOP\n   }\n}`, `42857937135862874000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Interceptor</span> <span class="token punctuation">{</span>\n   <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">default</span> <span class="token class-name">Object</span> <span class="token function">plugin</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token class-name">Plugin</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">setProperties</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// NOP</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，Interceptor 接口中的 plugin 方法实际上存在一个默认实现，这里它通过 Plugin.wrap 方法完成对目标对象的拦截。Plugin.wrap 是一个静态方法，位于 Plugin 类中，Plugin 类的核心代码如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1711174500466472400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public class Plugin implements InvocationHandler {\n   // 省略变量定义和构造函数\n   public static Object wrap(Object target, Interceptor interceptor) {\n      Map<Class<?>, Set<Method>> signatureMap = getSignatureMap(interceptor);\n      Class<?> type = target.getClass();\n      Class<?>[] interfaces = getAllInterfaces(type, signatureMap);\n      if (interfaces.length > 0) {\n         return Proxy.newProxyInstance(type.getClassLoader(), interfaces, new Plugin(target, interceptor, signatureMap));\n      }\n      return target;\n   }\n\n   @Override\n   public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n      try {\n         Set<Method> methods = signatureMap.get(method.getDeclaringClass());\n         if (methods != null && methods.contains(method)) {\n            return interceptor.intercept(new Invocation(target, method, args));\n         }\n         return method.invoke(target, args);\n      } catch (Exception e) {\n         throw ExceptionUtil.unwrapThrowable(e);\n      }\n   }\n\n   // 省略 getSignatureMap 方法和 getAllInterfaces 辅助方法\n}`, `1711174500466472400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Plugin</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 省略变量定义和构造函数</span>\n   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">wrap</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">,</span> <span class="token class-name">Interceptor</span> interceptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">Method</span><span class="token punctuation">></span><span class="token punctuation">></span></span> signatureMap <span class="token operator">=</span> <span class="token function">getSignatureMap</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> type <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces <span class="token operator">=</span> <span class="token function">getAllInterfaces</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> signatureMap<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>interfaces<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> interfaces<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Plugin</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> interceptor<span class="token punctuation">,</span> signatureMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span> target<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token annotation punctuation">@Override</span>\n   <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>\n      <span class="token keyword">try</span> <span class="token punctuation">{</span>\n         <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Method</span><span class="token punctuation">></span></span> methods <span class="token operator">=</span> signatureMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>methods <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> methods<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> interceptor<span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Invocation</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">throw</span> <span class="token class-name">ExceptionUtil</span><span class="token punctuation">.</span><span class="token function">unwrapThrowable</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token comment">// 省略 getSignatureMap 方法和 getAllInterfaces 辅助方法</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>显然，我们看到了熟悉的 InvocationHandler 接口和 Proxy.newProxyInstance 方法，从而明白原来用到了 JDK 的动态代理机制。</p>\n<p>这里我们分别通过 getSignatureMap 和 getAllInterfaces 方法获取接口和方法定义的元数据，并通过动态代理机制产生代理。另一方面，我们实现了 InvocationHandler 接口的 invoke 方法，并判断是否需要对目标方法进行拦截。如果是，则调用 Interceptor.intercept 方法，在该方法中我们就可以加入任何想要加入的业务逻辑；如果不是，则调用 method.invoke 方法执行原来逻辑。</p>\n<p>这里有一点要注意，在 Mybatis 中，拦截器只能拦截 ParameterHandler、StatementHandler、ResultSetHandler 和 Executor 这四种类型的接口，这点在 Configuration 类中是通过代码预先定义好的。如果我们想要自定义拦截器，也只能围绕上述四种接口添加逻辑。</p>\n<h2 id="解题要点-24"><a href="#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-24" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解题要点</h2>\n<p>在回答与管道-过滤器模式相关的面试题是，常见会碰到一些概念类问题，例如“管道-过滤器模式的应用场景有哪些？列举你知道的用到管道过滤器模式的开源框架？”这种，这些问题看上去有点复杂，实际上就是考查你对管道过滤器模式相关基本概念的理解，从考点上讲是比较明确的。我们明确，管道过滤器模式的主要应用场景在于请求-响应型的处理过程，尤其适用于处理 Web 请求。只要具备这一思路，这道题的答案也是自然而然就能得出的。在日常能够接触到的开源框架中，处理 Web 请求的框架基本上都会或多或少采用了管道过滤器模式，包括但不限于我们将要介绍的 Dubbo，以及诸如 Netty、Spring MVC、Tomcat 等常见框架。</p>\n<p>另一方面，针对具体的开源框架，面试官的提问方式可以围绕 Mybatis 等框架中的某一个功能特性展开讨论，例如“Mybatis 中的拦截器如何对执行过程进行拦截？”。针对这类问题，我们首先需要明确背后的考点实际上就是代理机制。在主流的开源框架中，涉及到过滤、拦截等常见下的实现原理往往都有代理模式相关。只要掌握动态代理机制，不同的问法都是类似的解答思路。事实上，Mybatis 中实现拦截的基本原理还是基于动态代理机制，通过获取对应方法的签名信息以及输入的接口和参数来生成代理。Mybatis 中的代理机制实现方式就是采用的 JDK 动态代理，你可以结合第 21 讲内容做一些回顾。掌握了该类的实现过程，都可以结合自己的理解对代理机制进行展开。</p>\n<h2 id="小结与预告-22"><a href="#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-22" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结与预告</h2>\n<p>在本讲中，对于管道-过滤器架构模式，我们详细给出了该模式的基本概念和组成结构。现实中，管道-过滤器在实现上也有很多变种，我们分别基于 Dubbo 和 Mybatis 这两款主流开源框架来分析这一架构模式的具体实现方式和技巧。</p>\n<p>管道-过滤器是我们通用技术组件部分的最后一个技术组件。介绍完通用技术组件之后，我们将进入到一个扩展模块，专门讨论剖析开源框架代码结构的系统方法。在下一讲中，我们将讨论“如何基于组件设计原则剖析开源框架代码结构？”这一话题。</p>\n<p>// TODO <a href="https://juejin.cn/book/7106442254533066787/section/7107604658914328588" target="_blank" rel="nofollow noreferrer noopener">https://juejin.cn/book/7106442254533066787/section/7107604658914328588</a></p>',
excerpt:"…",timeToRead:169,tableOfContents:'<ul>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E3%80%81%E5%8D%95%E4%BD%93%E7%B3%BB%E7%BB%9F%E5%8C%BA%E5%88%AB">分布式系统、单体系统区别</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E8%83%8C%E6%99%AF">背景</a></li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB">技术体系</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E5%8D%95%E4%BD%93%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%A0%B8%E5%BF%83%E9%97%AE%E9%A2%98">单体系统的核心问题</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%9C%AC%E8%B4%A8%E7%89%B9%E6%80%A7">分布式系统的本质特性</a></li>\n</ul>\n</li>\n<li><a href="/distributed-services-practice-learn/#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9">解题要点</a></li>\n<li><a href="/distributed-services-practice-learn/#%E6%80%BB%E7%BB%93">总结</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E5%BA%94%E8%AF%A5%E5%85%B7%E5%A4%87%E5%93%AA%E4%BA%9B%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E7%BB%84%E4%BB%B6%EF%BC%9F">实现分布式系统应该具备哪些核心技术组件？</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E8%83%8C%E6%99%AF-1">背景</a></li>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90">问题分析</a></li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-1">技术体系</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E8%BF%9C%E7%A8%8B%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8%E7%BB%84%E4%BB%B6">远程过程调用组件</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%84%E5%BB%BA%E7%BB%84%E4%BB%B6">微服务构建组件</a></li>\n<li><a href="/distributed-services-practice-learn/#%E9%80%9A%E7%94%A8%E6%8A%80%E6%9C%AF%E7%BB%84%E4%BB%B6">通用技术组件</a></li>\n</ul>\n</li>\n<li><a href="/distributed-services-practice-learn/#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-1">解题要点</a></li>\n<li><a href="/distributed-services-practice-learn/#%E6%80%BB%E7%BB%93-1">总结</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AE%8C%E6%88%90%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%B9%8B%E9%97%B4%E7%9A%84%E9%AB%98%E6%95%88%E9%80%9A%E4%BF%A1%EF%BC%9F">网络通信：如何完成客户端和服务端之间的高效通信？</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E8%83%8C%E6%99%AF-2">背景</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%88%86%E6%9E%90">分析</a></li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-2">技术体系</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5">网络连接</a></li>\n<li><a href="/distributed-services-practice-learn/#io-%E6%A8%A1%E5%9E%8B">IO 模型</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%8F%AF%E9%9D%A0%E6%80%A7">可靠性</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90">源码解析</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#dubbo-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E9%80%9A%E4%BF%A1%E5%8E%9F%E7%90%86">Dubbo 服务器端通信原理</a></li>\n<li><a href="/distributed-services-practice-learn/#dubbo-%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%80%9A%E4%BF%A1%E5%8E%9F%E7%90%86">Dubbo 客户端通信原理</a></li>\n</ul>\n</li>\n<li><a href="/distributed-services-practice-learn/#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-2">解题要点</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A">小结与预告</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AF%B9%E5%BA%8F%E5%88%97%E5%8C%96%E5%AE%9E%E7%8E%B0%E5%B7%A5%E5%85%B7%E8%BF%9B%E8%A1%8C%E6%AD%A3%E7%A1%AE%E9%80%89%E5%9E%8B%EF%BC%9F">序列化：如何对序列化实现工具进行正确选型？</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF">问题背景</a></li>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-1">问题分析</a></li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-3">技术体系</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E5%8A%9F%E8%83%BD">序列化的功能</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E6%80%A7%E8%83%BD">序列化的性能</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E5%85%BC%E5%AE%B9%E6%80%A7">序列化的兼容性</a></li>\n</ul>\n</li>\n<li><a href="/distributed-services-practice-learn/#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-1">源码解析</a></li>\n<li><a href="/distributed-services-practice-learn/#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-3">解题要点</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-1">小结与预告</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%EF%BC%9A%E5%A6%82%E6%9E%9C%E8%AE%A9%E4%BD%A0%E8%87%AA%E5%B7%B1%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84-rpc-%E6%9E%B6%E6%9E%84%EF%BC%8C%E4%BD%A0%E4%BC%9A%E6%80%8E%E4%B9%88%E5%81%9A%EF%BC%9F">远程调用：如果让你自己设计一个简单的 RPC 架构，你会怎么做？</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-1">问题背景</a></li>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-2">问题分析</a></li>\n<li><a href="/distributed-services-practice-learn/#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-4">技术体系</a></li>\n<li><a href="/distributed-services-practice-learn/#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-2">源码解析</a></li>\n<li><a href="/distributed-services-practice-learn/#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-4">解题要点</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-2">小结与预告</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%EF%BC%9A%E5%A6%82%E4%BD%95%E5%90%88%E7%90%86%E8%AE%BE%E8%AE%A1%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E6%9C%BA%E5%88%B6%EF%BC%9F">远程调用：如何合理设计服务发布机制？</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-2">问题背景</a></li>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-3">问题分析</a></li>\n<li><a href="/distributed-services-practice-learn/#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-5">技术体系</a></li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-3">源码解析</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2">远程服务暴露</a></li>\n<li><a href="/distributed-services-practice-learn/#%E6%9C%AC%E5%9C%B0%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2">本地服务暴露</a></li>\n</ul>\n</li>\n<li><a href="/distributed-services-practice-learn/#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-5">解题要点</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-3">小结与预告</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%EF%BC%9A%E6%9C%8D%E5%8A%A1%E5%BC%95%E7%94%A8%E6%9C%89%E5%93%AA%E4%BA%9B%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F%EF%BC%9F">远程调用：服务引用有哪些实现方式？</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-3">问题背景</a></li>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-4">问题分析</a></li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-6">技术体系</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E9%80%9A%E7%94%A8%E6%9C%8D%E5%8A%A1%E5%BC%95%E7%94%A8%E6%B5%81%E7%A8%8B">通用服务引用流程</a></li>\n<li><a href="/distributed-services-practice-learn/#%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8%E7%9A%84%E7%B1%BB%E5%9E%8B">服务调用的类型</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-4">源码解析</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E6%9C%8D%E5%8A%A1%E5%BC%95%E7%94%A8">服务引用</a></li>\n<li><a href="/distributed-services-practice-learn/#%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8%E5%BC%82%E6%AD%A5%E8%BD%AC%E5%90%8C%E6%AD%A5%E8%BF%87%E7%A8%8B">服务调用异步转同步过程</a></li>\n</ul>\n</li>\n<li><a href="/distributed-services-practice-learn/#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-6">解题要点</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-4">小结与预告</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%EF%BC%9A%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%A6%82%E4%BD%95%E4%B8%8E%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B%E8%BF%9B%E8%A1%8C%E6%95%B4%E5%90%88%EF%BC%9F">负载均衡：负载均衡如何与远程调用过程进行整合？</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-4">问题背景</a></li>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-5">问题分析</a></li>\n<li><a href="/distributed-services-practice-learn/#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-7">技术体系</a></li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-5">源码解析</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#spring-cloud-%E4%B8%AD%E7%9A%84-loadbalanced">Spring Cloud 中的 @LoadBalanced</a></li>\n<li><a href="/distributed-services-practice-learn/#loadbalanceclient-%E6%8E%A5%E5%8F%A3%E4%B8%8E%E5%AE%9E%E7%8E%B0%E7%B1%BB">LoadBalanceClient 接口与实现类</a></li>\n</ul>\n</li>\n<li><a href="/distributed-services-practice-learn/#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-7">解题要点</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-5">小结与预告</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%B8%B8%E8%A7%81%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95%EF%BC%9F">负载均衡：如何实现常见的负载均衡算法？</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-5">问题背景</a></li>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-6">问题分析</a></li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-8">技术体系</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E7%B1%BB%E5%9E%8B">负载均衡的类型</a></li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95%E5%92%8C%E7%AD%96%E7%95%A5">负载均衡算法和策略</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E9%9D%99%E6%80%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1">静态负载均衡</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%8A%A8%E6%80%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95">动态负载均衡算法</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-6">源码解析</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#dubbo-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84">Dubbo 负载均衡整体结构</a></li>\n<li><a href="/distributed-services-practice-learn/#dubbo-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0%E7%A4%BA%E4%BE%8B">Dubbo 负载均衡算法实现示例</a></li>\n</ul>\n</li>\n<li><a href="/distributed-services-practice-learn/#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-8">解题要点</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-6">小结与预告</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%9C%8D%E5%8A%A1%E5%AE%B9%E9%94%99%EF%BC%9A%E4%BB%80%E4%B9%88%E6%98%AF%E9%9B%86%E7%BE%A4%E5%AE%B9%E9%94%99%EF%BC%9F%E6%9C%89%E5%93%AA%E4%BA%9B%E9%9B%86%E7%BE%A4%E5%AE%B9%E9%94%99%E7%AD%96%E7%95%A5%EF%BC%9F">服务容错：什么是集群容错？有哪些集群容错策略？</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-6">问题背景</a></li>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-7">问题分析</a></li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-9">技术体系</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E9%9B%AA%E5%B4%A9%E6%95%88%E5%BA%94">雪崩效应</a></li>\n<li><a href="/distributed-services-practice-learn/#%E9%9B%86%E7%BE%A4%E5%AE%B9%E9%94%99%E7%9A%84%E7%AD%96%E7%95%A5">集群容错的策略</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-7">源码解析</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#dubbo-%E4%B8%AD%E7%9A%84%E9%9B%86%E7%BE%A4">Dubbo 中的集群</a></li>\n<li><a href="/distributed-services-practice-learn/#dubbo-%E4%B8%AD%E7%9A%84%E9%9B%86%E7%BE%A4%E5%AE%B9%E9%94%99%E6%9C%BA%E5%88%B6">Dubbo 中的集群容错机制</a></li>\n</ul>\n</li>\n<li><a href="/distributed-services-practice-learn/#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-9">解题要点</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-7">小结与预告</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%9C%8D%E5%8A%A1%E5%AE%B9%E9%94%99%EF%BC%9A%E7%86%94%E6%96%AD%E5%99%A8%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84%E6%98%AF%E6%80%8E%E4%B9%88%E6%A0%B7%E7%9A%84%EF%BC%9F%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%EF%BC%9F">服务容错：熔断器的基本结构是怎么样的？如何实现？</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-7">问题背景</a></li>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-8">问题分析</a></li>\n<li><a href="/distributed-services-practice-learn/#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-10">技术体系</a></li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-8">源码解析</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#spring-cloud-circuit-breaker-%E7%BB%84%E6%88%90%E7%BB%93%E6%9E%84">Spring Cloud Circuit Breaker 组成结构</a></li>\n<li><a href="/distributed-services-practice-learn/#hystrix-%E7%86%94%E6%96%AD%E6%9C%BA%E5%88%B6">Hystrix 熔断机制</a></li>\n</ul>\n</li>\n<li><a href="/distributed-services-practice-learn/#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-10">解题要点</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-8">小结与预告</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%EF%BC%9A%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%E7%9A%84%E5%B8%B8%E8%A7%81%E5%AE%9E%E7%8E%B0%E7%AD%96%E7%95%A5%E6%9C%89%E5%93%AA%E4%BA%9B%EF%BC%9F">服务降级：服务降级的常见实现策略有哪些？</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-8">问题背景</a></li>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-9">问题分析</a></li>\n<li><a href="/distributed-services-practice-learn/#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-11">技术体系</a></li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-9">源码解析</a></p>\n<ul>\n<li>\n<p><a href="/distributed-services-practice-learn/#dubbo-%E4%B8%AD%E7%9A%84%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7">Dubbo 中的服务降级</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#dubbo-%E4%B8%AD%E7%9A%84-mock-%E6%9C%BA%E5%88%B6">Dubbo 中的 Mock 机制</a></li>\n<li><a href="/distributed-services-practice-learn/#mockinvoker-%E5%92%8C-mockclusterinvoker">MockInvoker 和 MockClusterInvoker</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#spring-cloud-%E4%B8%AD%E7%9A%84%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7">Spring Cloud 中的服务降级</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#spring-cloud-%E4%B8%AD%E7%9A%84%E5%9B%9E%E9%80%80%E6%9C%BA%E5%88%B6">Spring Cloud 中的回退机制</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%9F%BA%E4%BA%8E%E6%8B%A6%E6%88%AA%E5%99%A8%E5%AE%9E%E7%8E%B0%E5%9B%9E%E9%80%80">基于拦截器实现回退</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href="/distributed-services-practice-learn/#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-11">解题要点</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-9">小结与预告</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%EF%BC%9A%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E6%AC%BE%E5%85%B7%E5%A4%87%E5%AE%9E%E6%97%B6%E9%80%9A%E7%9F%A5%E8%83%BD%E5%8A%9B%E7%9A%84%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%A8%A1%E5%9E%8B%EF%BC%9F">注册中心：如何设计一款具备实时通知能力的注册中心模型？</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-9">问题背景</a></li>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-10">问题分析</a></li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-12">技术体系</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%A8%A1%E5%9E%8B">注册中心模型</a></li>\n<li><a href="/distributed-services-practice-learn/#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0%E5%B7%A5%E5%85%B7">注册中心实现工具</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-10">源码解析</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#dubbo-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%A8%A1%E5%9E%8B">Dubbo 注册中心模型</a></li>\n<li><a href="/distributed-services-practice-learn/#zookeeper-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B">Zookeeper 注册中心实现过程</a></li>\n</ul>\n</li>\n<li><a href="/distributed-services-practice-learn/#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-12">解题要点</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-10">小结与预告</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%EF%BC%9A%E5%A6%82%E6%9E%9C%E9%87%87%E7%94%A8%E5%AE%9A%E6%97%B6%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5%E6%9D%A5%E8%AE%BE%E8%AE%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%EF%BC%8C%E6%9C%89%E5%93%AA%E4%BA%9B%E6%B3%A8%E6%84%8F%E7%82%B9%EF%BC%9F">注册中心：如果采用定时更新策略来设计注册中心，有哪些注意点？</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-10">问题背景</a></li>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-11">问题分析</a></li>\n<li><a href="/distributed-services-practice-learn/#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-13">技术体系</a></li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-11">源码解析</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#eureka-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86">Eureka 服务器端基本原理</a></li>\n<li><a href="/distributed-services-practice-learn/#eureka-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86">Eureka 客户端基本原理</a></li>\n</ul>\n</li>\n<li><a href="/distributed-services-practice-learn/#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-13">解题要点</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-11">小结与预告</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E6%AC%BE%E9%AB%98%E6%80%A7%E8%83%BD%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3%EF%BC%9F">服务网关：如何实现一款高性能服务网关？</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-11">问题背景</a></li>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-12">问题分析</a></li>\n<li><a href="/distributed-services-practice-learn/#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-14">技术体系</a></li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-12">源码解析</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#spring-cloud-gateway-%E6%9E%B6%E6%9E%84">Spring Cloud Gateway 架构</a></li>\n<li><a href="/distributed-services-practice-learn/#spring-cloud-gateway-%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B">Spring Cloud Gateway 工作流程</a></li>\n</ul>\n</li>\n<li><a href="/distributed-services-practice-learn/#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-14">解题要点</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-12">小结与预告</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%EF%BC%9A%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%92%8C%E5%90%84%E4%B8%AA%E6%9C%8D%E5%8A%A1%E4%B9%8B%E9%97%B4%E6%98%AF%E5%A6%82%E4%BD%95%E4%BA%A4%E4%BA%92%E7%9A%84%EF%BC%9F">配置中心：配置中心和各个服务之间是如何交互的？</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-12">问题背景</a></li>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-13">问题分析</a></li>\n<li><a href="/distributed-services-practice-learn/#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-15">技术体系</a></li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-13">源码解析</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#spring-cloud-config-server-%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6">Spring Cloud Config Server 工作机制</a></li>\n<li><a href="/distributed-services-practice-learn/#spring-cloud-config-client-%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6">Spring Cloud Config Client 工作机制</a></li>\n</ul>\n</li>\n<li><a href="/distributed-services-practice-learn/#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-15">解题要点</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-13">小结与预告</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%EF%BC%9A%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E6%9C%89%E5%8F%98%E6%9B%B4%E6%97%B6%EF%BC%8C%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%83%AD%E6%9B%B4%E6%96%B0%EF%BC%9F">配置中心：配置信息有变更时，如何实现热更新？</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-13">问题背景</a></li>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-14">问题分析</a></li>\n<li><a href="/distributed-services-practice-learn/#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-16">技术体系</a></li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-14">源码解析</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E5%A6%82%E4%BD%95%E8%87%AA%E5%8A%A8%E8%B0%83%E7%94%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E6%89%80%E6%9A%B4%E9%9C%B2%E7%9A%84-actuatorbus-refresh-%E7%AB%AF%E7%82%B9%EF%BC%9F">如何自动调用服务器端所暴露的 &#x3C;code class="language-text">/actuator/bus-refresh&#x3C;/code> 端点？</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%A6%82%E4%BD%95%E5%BE%97%E7%9F%A5%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E7%9A%84%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E5%B7%B2%E7%BB%8F%E6%9B%B4%E6%96%B0%EF%BC%9F">客户端如何得知服务器端的配置信息已经更新？</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E6%97%B6%E8%8E%B7%E5%8F%96%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E6%89%80%E6%9B%B4%E6%96%B0%E7%9A%84%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%EF%BC%9F">客户端如何实时获取服务器端所更新的配置信息？</a></li>\n</ul>\n</li>\n<li><a href="/distributed-services-practice-learn/#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-16">解题要点</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-14">小结与预告</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AF%B9%E6%9C%8D%E5%8A%A1%E9%93%BE%E8%B7%AF%E8%BF%9B%E8%A1%8C%E6%9C%89%E6%95%88%E7%9B%91%E6%8E%A7%EF%BC%9F">链路跟踪：如何对服务链路进行有效监控？​</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-14">问题背景</a></li>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-15">问题分析</a></li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-17">技术体系</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E5%88%86%E5%B8%83%E5%BC%8F%E6%9C%8D%E5%8A%A1%E8%B7%9F%E8%B8%AA%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86">分布式服务跟踪基本原理</a></li>\n<li><a href="/distributed-services-practice-learn/#spring-cloud-%E4%B8%AD%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7">Spring Cloud 中的服务监控</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-15">源码解析</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E5%9F%BA%E4%BA%8E-spring-cloud-sleuth-%E7%94%9F%E6%88%90%E5%92%8C%E4%BC%A0%E9%80%92-span">基于 Spring Cloud Sleuth 生成和传递 Span</a></li>\n<li><a href="/distributed-services-practice-learn/#%E4%BD%BF%E7%94%A8-brave-%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89-span">使用 Brave 创建自定义 Span</a></li>\n</ul>\n</li>\n<li><a href="/distributed-services-practice-learn/#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-17">解题要点</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-15">小结与预告</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%B6%88%E6%81%AF%E9%80%9A%E4%BF%A1%EF%BC%9A%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E8%B7%A8%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E7%BB%9F%E4%B8%80%E6%B6%88%E6%81%AF%E9%80%9A%E4%BF%A1%E5%B9%B3%E5%8F%B0%EF%BC%9F">消息通信：如何设计跨消息中间件的统一消息通信平台？</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-15">问题背景</a></li>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-16">问题分析</a></li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-18">技术体系</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#spring-%E5%AE%B6%E6%97%8F%E4%B8%AD%E7%9A%84%E6%B6%88%E6%81%AF%E9%80%9A%E4%BF%A1%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">Spring 家族中的消息通信解决方案</a></li>\n<li><a href="/distributed-services-practice-learn/#spring-cloud-stream-%E5%9F%BA%E6%9C%AC%E6%9E%B6%E6%9E%84">Spring Cloud Stream 基本架构</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-16">源码解析</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#spring-cloud-stream-%E4%B8%AD%E7%9A%84-binder">Spring Cloud Stream 中的 Binder</a></li>\n<li><a href="/distributed-services-practice-learn/#spring-cloud-stream-%E9%9B%86%E6%88%90-rabbitmq">Spring Cloud Stream 集成 RabbitMQ</a></li>\n</ul>\n</li>\n<li><a href="/distributed-services-practice-learn/#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-18">解题要点</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-16">小结与预告</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%EF%BC%9A%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E5%9C%A8%E5%88%86%E5%B8%83%E5%BC%8F%E6%9C%8D%E5%8A%A1%E4%B8%AD%E8%B5%B7%E5%88%B0%E4%BB%80%E4%B9%88%E4%BD%9C%E7%94%A8%EF%BC%9F">动态代理：动态代理在分布式服务中起到什么作用？</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-16">问题背景</a></li>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-17">问题分析</a></li>\n<li><a href="/distributed-services-practice-learn/#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-19">技术体系</a></li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-17">源码解析</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#dubbo-%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE%E4%B8%AD%E7%9A%84%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6">Dubbo 远程访问中的代理机制</a></li>\n<li><a href="/distributed-services-practice-learn/#mybatis-%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E4%B8%AD%E7%9A%84%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6">MyBatis 数据访问中的代理机制</a></li>\n</ul>\n</li>\n<li><a href="/distributed-services-practice-learn/#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-19">解题要点</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-17">小结与预告</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E5%BA%94%E7%94%A8%E7%BC%93%E5%AD%98%EF%BC%9A%E5%A6%82%E4%BD%95%E5%9C%A8%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E8%BF%87%E7%A8%8B%E4%B8%AD%E5%B5%8C%E5%85%A5%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6%EF%BC%9F">应用缓存：如何在数据访问过程中嵌入缓存机制？</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-17">问题背景</a></li>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-18">问题分析</a></li>\n<li><a href="/distributed-services-practice-learn/#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-20">技术体系</a></li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-18">源码解析</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#mybatis-%E4%B8%80%E7%BA%A7%E7%BC%93%E5%AD%98">Mybatis 一级缓存</a></li>\n<li><a href="/distributed-services-practice-learn/#mybatis-%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98">Mybatis 二级缓存</a></li>\n</ul>\n</li>\n<li><a href="/distributed-services-practice-learn/#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-20">解题要点</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-18">小结与预告</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%EF%BC%9A%E4%BB%80%E4%B9%88%E6%98%AF%E6%B1%A0%E5%8C%96%E6%93%8D%E4%BD%9C%EF%BC%9F%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E8%B5%84%E6%BA%90%E6%B1%A0%EF%BC%9F">资源管理：什么是池化操作？如何实现一个资源池？</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-18">问题背景</a></li>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-19">问题分析</a></li>\n<li><a href="/distributed-services-practice-learn/#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-21">技术体系</a></li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-19">源码解析</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#pooleddatasource">PooledDataSource</a></li>\n<li><a href="/distributed-services-practice-learn/#unpooleddatasource">UnpooledDataSource</a></li>\n</ul>\n</li>\n<li><a href="/distributed-services-practice-learn/#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-21">解题要点</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-19">小结与预告</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%A1%86%E6%9E%B6%E9%9B%86%E6%88%90%EF%BC%9A%E5%A6%82%E6%9E%9C%E9%9C%80%E8%A6%81%E5%AE%9E%E7%8E%B0%E4%B8%A4%E4%B8%AA%E6%A1%86%E6%9E%B6%E4%B9%8B%E9%97%B4%E7%9A%84%E9%9B%86%E6%88%90%EF%BC%8C%E6%9C%89%E4%BB%80%E4%B9%88%E5%8A%9E%E6%B3%95%EF%BC%9F">框架集成：如果需要实现两个框架之间的集成，有什么办法？</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-19">问题背景</a></li>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-20">问题分析</a></li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-22">技术体系</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#spring-%E5%90%AF%E5%8A%A8%E6%89%A9%E5%B1%95%E7%82%B9">Spring 启动扩展点</a></li>\n<li><a href="/distributed-services-practice-learn/#spring-boot-%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE">Spring Boot 自动配置</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-20">源码解析</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#mybatis-spring-%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B">Mybatis Spring 启动过程</a></li>\n<li><a href="/distributed-services-practice-learn/#mybatis-spring-boot-starter">Mybatis Spring Boot Starter</a></li>\n</ul>\n</li>\n<li><a href="/distributed-services-practice-learn/#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-22">解题要点</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-20">小结与预告</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E7%BB%84%E4%BB%B6%E6%89%A9%E5%B1%95%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BE%88%E5%A4%9A%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6%E9%83%BD%E4%BC%9A%E5%86%85%E7%BD%AE%E4%B8%80%E5%A5%97%E5%BE%AE%E5%86%85%E6%A0%B8%E6%9E%B6%E6%9E%84%EF%BC%9F">组件扩展：为什么很多开源框架都会内置一套微内核架构？</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-20">问题背景</a></li>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-21">问题分析</a></li>\n<li><a href="/distributed-services-practice-learn/#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-23">技术体系</a></li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-21">源码解析</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E5%BE%AE%E5%86%85%E6%A0%B8%E6%A8%A1%E5%BC%8F%E5%9C%A8-dubbo-%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8">微内核模式在 Dubbo 中的应用</a></li>\n<li><a href="/distributed-services-practice-learn/#dubbo-%E4%B8%AD%E7%9A%84%E6%89%A9%E5%B1%95%E7%82%B9">Dubbo 中的扩展点</a></li>\n</ul>\n</li>\n<li><a href="/distributed-services-practice-learn/#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-23">解题要点</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-21">小结与预告</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%B5%81%E7%A8%8B%E5%AE%9A%E5%88%B6%EF%BC%9A%E7%AE%A1%E9%81%93-%E8%BF%87%E6%BB%A4%E5%99%A8%E6%9E%B6%E6%9E%84%E8%83%BD%E7%94%A8%E6%9D%A5%E8%A7%A3%E5%86%B3%E4%BB%80%E4%B9%88%E9%97%AE%E9%A2%98%EF%BC%9F">流程定制：管道-过滤器架构能用来解决什么问题？</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF-21">问题背景</a></li>\n<li><a href="/distributed-services-practice-learn/#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90-22">问题分析</a></li>\n<li><a href="/distributed-services-practice-learn/#%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB-24">技术体系</a></li>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-22">源码解析</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E7%AE%A1%E9%81%93-%E8%BF%87%E6%BB%A4%E5%99%A8%E6%A8%A1%E5%BC%8F%E5%9C%A8-dubbo-%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8">管道-过滤器模式在 Dubbo 中的应用</a></li>\n<li><a href="/distributed-services-practice-learn/#%E7%AE%A1%E9%81%93-%E8%BF%87%E6%BB%A4%E5%99%A8%E6%A8%A1%E5%BC%8F%E5%9C%A8-mybatis-%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8">管道-过滤器模式在 Mybatis 中的应用</a></li>\n</ul>\n</li>\n<li><a href="/distributed-services-practice-learn/#%E8%A7%A3%E9%A2%98%E8%A6%81%E7%82%B9-24">解题要点</a></li>\n<li><a href="/distributed-services-practice-learn/#%E5%B0%8F%E7%BB%93%E4%B8%8E%E9%A2%84%E5%91%8A-22">小结与预告</a></li>\n</ul>\n</li>\n</ul>',
wordCount:{words:14890},frontmatter:{date:"2024-10-11 18:39:07",path:"/distributed-services-practice-learn/",tags:"后端, 系统设计, 读书笔记, 分布式",title:"分布式服务入门学习",draft:null,catalog_number:null}},nextPost:{html:'<h1 id="背景"><a href="#%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景</h1>\n<ol>\n<li>针对 postgres 某个表里面的 labels 字段（labels 字段是一维数组类型）做复杂查询，要求支持常见的且，或，非等等功能</li>\n<li>原来的业务逻辑已实现了且，或，非功能，但不支持括号来提高运算符的优先级</li>\n</ol>\n<h1 id="方案"><a href="#%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方案</h1>\n<p>显而易见的方案就是实现一个 python 版本的语法解析器来支持各种语法，有以下方案</p>\n<ol>\n<li><a href="https://github.com/dabeaz/ply" target="_blank" rel="nofollow noreferrer noopener">ply</a> 语法简单易懂，上手有一定难度</li>\n<li><a href="https://github.com/pyparsing/pyparsing" target="_blank" rel="nofollow noreferrer noopener">pyparsing</a> 语义结构化比较好，比 ply 上手难度要高</li>\n</ol>\n<p>综上，采用方案 1</p>\n<h1 id="实现"><a href="#%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现</h1>\n<p>由于后端使用的 django 框架，根据数据库的不同以及 orm 的不同，操作数据库一般有 3 种形式</p>\n<ol>\n<li>原生 postgres sql 查询</li>\n<li>django Q 对象查询</li>\n<li>原生 mongodb sql 查询</li>\n</ol>\n<p>结合业务，只需要实现 1, 2，主要功能如下</p>\n<ol>\n<li>() - , | % 分别代表左括号、右括号、非、且、或、模糊搜索，优先级 () > % > - > , > |</li>\n<li>如果要搜索的 label 带有上述字符，可以用 \\ 转义，不是开头的 -、% 可以不用转义</li>\n</ol>\n<h2 id="原生-postgres-sql-查询"><a href="#%E5%8E%9F%E7%94%9F-postgres-sql-%E6%9F%A5%E8%AF%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原生 postgres sql 查询</h2>\n<p><code class="language-text">utils/pg_sql_utils.py</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17109213275951407000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import re\n\nfrom pydash import py_\n\n\ndef replace_dashes(match):\n    result = match.group()\n    first_char = \'\'\n\n    if result.startswith(\'-\'):\n        first_char = \'-\'\n        result = result[1:]\n\n    return first_char + re.sub(r\'(?<!\\\\)-\', r\'\\-\', result)\n\n\ndef parse_sql(common_expression, like_expression, sql):\n    # () - , | 分别代表左右括号，非，且，或，优先级 () > - > , > |，如果要搜索的 label 带有上述 5 种字符，可以用 \\ 转义，非开头的 - 不需要转义\n    sql = sql.strip()\n    if not sql:\n        return \'\'\n\n    # 预处理，将筛选出 - 开头的匹配项，然后对匹配项里面除了开头的 - 以外的 - 替换为 \\-，最后将替换的结果拼接到原字符串\n    # 就是将下面的 [^()|,-])+ 改为 [^()|,])+，在这里处理替换 - 开头的情况，即将剩余的 - 替换为 \\-\n    pattern = r\'((?:\\\\[()|,-])|[^()|,])+\'\n    sql = re.sub(pattern, replace_dashes, sql)\n\n    print(\'sql:\', sql)\n\n    import ply.lex as lex\n    import ply.yacc as yacc\n\n    # 定义词法分析器的词法规则\n    tokens = (  # noqa: F841\n        \'LPAREN\',\n        \'RPAREN\',\n        \'OR\',\n        \'AND\',\n        \'NOT\',\n        \'TERM\',\n    )\n\n    t_LPAREN = r\'\\(\'  # noqa: F841\n    t_RPAREN = r\'\\)\'  # noqa: F841\n    t_OR = r\'\\|\'  # noqa: F841\n    t_AND = r\',\'  # noqa: F841\n    t_NOT = r\'-\'  # noqa: F841\n\n    def t_TERM(t):\n        # 匹配以 ()|,- 的分割的连续字符，但是要忽略转义字符 \\，如 \\- 表示匹配 -\n        r\'((?:\\\\[()|,-])|[^()|,-])+\'\n        # 去掉转义字符 \\\n        if t.value.startswith(\'\\%\'):\n            t.value = \'\\%\' + re.sub(r\'\\\\([()|,\\-%])\', r\'\\1\', t.value[2:])\n        else:\n            t.value = re.sub(r\'\\\\([()|,\\-%])\', r\'\\1\', t.value)\n        return t\n\n    # 忽略空格和制表符\n    t_ignore = \' \\t\'  # noqa: F841\n\n    # 错误处理\n    def t_error(t):\n        raise TypeError(&quot;Unknown text \'%s\'&quot; % (py_.get(t, \'value\'),))\n\n    # 构建词法分析器\n    lexer = lex.lex()\n\n    # 确定运算符的优先级\n    precedence = (  # noqa: F841\n      (\'left\', \'OR\'),\n      (\'left\', \'AND\'),\n      (\'right\', \'NOT\')\n    )\n\n    # 定义语法分析器的语法规则\n    def p_expression_group(p):\n        \'\'\'expression : LPAREN expression RPAREN\'\'\'\n        p[0] = f\'({p[2]})\'\n\n    def p_expression_or(p):\n        \'\'\'expression : expression OR expression\'\'\'\n        p[0] = f\'{p[1]} OR {p[3]}\'\n\n    def p_expression_and(p):\n        \'\'\'expression : expression AND expression\'\'\'\n        p[0] = f\'{p[1]} AND {(p[3])}\'\n\n    def p_expression_not(p):\n        \'\'\'expression : NOT expression\'\'\'\n        p[0] = f\'NOT {p[2]}\'\n\n    def p_expression_term(p):\n        \'\'\'expression : TERM\'\'\'\n        if p[1].startswith(\'%\'):\n            p[0] = like_expression.format(\n                value=p[1][1:])\n        else:\n            if p[1].startswith(\'\\%\'):\n                p[1] = p[1][1:]\n            p[0] = common_expression.format(\n                value=p[1])\n\n    def p_error(p):\n        raise SyntaxError(\n            f&quot;Syntax error in input! Text is {sql}, Token is {py_.get(p, \'value\')}&quot;)\n\n    # 构建语法分析器\n    parser = yacc.yacc()\n    result = parser.parse(sql, lexer=lexer)\n    return result\n\n\nif __name__ == \'__main__\':\n    common_expression = &quot;labels::TEXT[] @> ARRAY [\'{value}\']&quot;\n    like_expression = &quot;labels::TEXT LIKE \'%{value}%\'&quot;\n    print(\n        parse_sql(common_expression, like_expression, \'a|-直行路口,-free-,\\,\\(\\)\\|space专项,(b|c),(d,e),%3434,\\%3434\'))\n    print(\n        parse_sql(common_expression, like_expression, \'-ego\\-turn\\-right,ego-turn\\-right,ego-turn-right,v4.0.4-f30-ota31-pro,v4.0.4\\-f30\\-ota31\\-pro\'))`, `17109213275951407000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> re\n\n<span class="token keyword">from</span> pydash <span class="token keyword">import</span> py_\n\n\n<span class="token keyword">def</span> <span class="token function">replace_dashes</span><span class="token punctuation">(</span>match<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    result <span class="token operator">=</span> match<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    first_char <span class="token operator">=</span> <span class="token string">\'\'</span>\n\n    <span class="token keyword">if</span> result<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">\'-\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        first_char <span class="token operator">=</span> <span class="token string">\'-\'</span>\n        result <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>\n\n    <span class="token keyword">return</span> first_char <span class="token operator">+</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r\'(?&lt;!\\\\)-\'</span><span class="token punctuation">,</span> <span class="token string">r\'\\-\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">parse_sql</span><span class="token punctuation">(</span>common_expression<span class="token punctuation">,</span> like_expression<span class="token punctuation">,</span> sql<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># () - , | 分别代表左右括号，非，且，或，优先级 () > - > , > |，如果要搜索的 label 带有上述 5 种字符，可以用 \\ 转义，非开头的 - 不需要转义</span>\n    sql <span class="token operator">=</span> sql<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token keyword">not</span> sql<span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string">\'\'</span>\n\n    <span class="token comment"># 预处理，将筛选出 - 开头的匹配项，然后对匹配项里面除了开头的 - 以外的 - 替换为 \\-，最后将替换的结果拼接到原字符串</span>\n    <span class="token comment"># 就是将下面的 [^()|,-])+ 改为 [^()|,])+，在这里处理替换 - 开头的情况，即将剩余的 - 替换为 \\-</span>\n    pattern <span class="token operator">=</span> <span class="token string">r\'((?:\\\\[()|,-])|[^()|,])+\'</span>\n    sql <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> replace_dashes<span class="token punctuation">,</span> sql<span class="token punctuation">)</span>\n\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'sql:\'</span><span class="token punctuation">,</span> sql<span class="token punctuation">)</span>\n\n    <span class="token keyword">import</span> ply<span class="token punctuation">.</span>lex <span class="token keyword">as</span> lex\n    <span class="token keyword">import</span> ply<span class="token punctuation">.</span>yacc <span class="token keyword">as</span> yacc\n\n    <span class="token comment"># 定义词法分析器的词法规则</span>\n    tokens <span class="token operator">=</span> <span class="token punctuation">(</span>  <span class="token comment"># noqa: F841</span>\n        <span class="token string">\'LPAREN\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'RPAREN\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'OR\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'AND\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'NOT\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'TERM\'</span><span class="token punctuation">,</span>\n    <span class="token punctuation">)</span>\n\n    t_LPAREN <span class="token operator">=</span> <span class="token string">r\'\\(\'</span>  <span class="token comment"># noqa: F841</span>\n    t_RPAREN <span class="token operator">=</span> <span class="token string">r\'\\)\'</span>  <span class="token comment"># noqa: F841</span>\n    t_OR <span class="token operator">=</span> <span class="token string">r\'\\|\'</span>  <span class="token comment"># noqa: F841</span>\n    t_AND <span class="token operator">=</span> <span class="token string">r\',\'</span>  <span class="token comment"># noqa: F841</span>\n    t_NOT <span class="token operator">=</span> <span class="token string">r\'-\'</span>  <span class="token comment"># noqa: F841</span>\n\n    <span class="token keyword">def</span> <span class="token function">t_TERM</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># 匹配以 ()|,- 的分割的连续字符，但是要忽略转义字符 \\，如 \\- 表示匹配 -</span>\n        <span class="token string">r\'((?:\\\\[()|,-])|[^()|,-])+\'</span>\n        <span class="token comment"># 去掉转义字符 \\</span>\n        <span class="token keyword">if</span> t<span class="token punctuation">.</span>value<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">\'\\%\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            t<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">\'\\%\'</span> <span class="token operator">+</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r\'\\\\([()|,\\-%])\'</span><span class="token punctuation">,</span> <span class="token string">r\'\\1\'</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>value<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            t<span class="token punctuation">.</span>value <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r\'\\\\([()|,\\-%])\'</span><span class="token punctuation">,</span> <span class="token string">r\'\\1\'</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>value<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> t\n\n    <span class="token comment"># 忽略空格和制表符</span>\n    t_ignore <span class="token operator">=</span> <span class="token string">\' \\t\'</span>  <span class="token comment"># noqa: F841</span>\n\n    <span class="token comment"># 错误处理</span>\n    <span class="token keyword">def</span> <span class="token function">t_error</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">"Unknown text \'%s\'"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>py_<span class="token punctuation">.</span>get<span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">\'value\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n    <span class="token comment"># 构建词法分析器</span>\n    lexer <span class="token operator">=</span> lex<span class="token punctuation">.</span>lex<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    <span class="token comment"># 确定运算符的优先级</span>\n    precedence <span class="token operator">=</span> <span class="token punctuation">(</span>  <span class="token comment"># noqa: F841</span>\n      <span class="token punctuation">(</span><span class="token string">\'left\'</span><span class="token punctuation">,</span> <span class="token string">\'OR\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token punctuation">(</span><span class="token string">\'left\'</span><span class="token punctuation">,</span> <span class="token string">\'AND\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token punctuation">(</span><span class="token string">\'right\'</span><span class="token punctuation">,</span> <span class="token string">\'NOT\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">)</span>\n\n    <span class="token comment"># 定义语法分析器的语法规则</span>\n    <span class="token keyword">def</span> <span class="token function">p_expression_group</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token triple-quoted-string string">\'\'\'expression : LPAREN expression RPAREN\'\'\'</span>\n        p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'(</span><span class="token interpolation"><span class="token punctuation">{</span>p<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n    <span class="token keyword">def</span> <span class="token function">p_expression_or</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token triple-quoted-string string">\'\'\'expression : expression OR expression\'\'\'</span>\n        p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> OR </span><span class="token interpolation"><span class="token punctuation">{</span>p<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n\n    <span class="token keyword">def</span> <span class="token function">p_expression_and</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token triple-quoted-string string">\'\'\'expression : expression AND expression\'\'\'</span>\n        p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> AND </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n\n    <span class="token keyword">def</span> <span class="token function">p_expression_not</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token triple-quoted-string string">\'\'\'expression : NOT expression\'\'\'</span>\n        p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'NOT </span><span class="token interpolation"><span class="token punctuation">{</span>p<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n\n    <span class="token keyword">def</span> <span class="token function">p_expression_term</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token triple-quoted-string string">\'\'\'expression : TERM\'\'\'</span>\n        <span class="token keyword">if</span> p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">\'%\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> like_expression<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>\n                value<span class="token operator">=</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">\'\\%\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n                p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>\n            p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> common_expression<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>\n                value<span class="token operator">=</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">p_error</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> SyntaxError<span class="token punctuation">(</span>\n            <span class="token string-interpolation"><span class="token string">f"Syntax error in input! Text is </span><span class="token interpolation"><span class="token punctuation">{</span>sql<span class="token punctuation">}</span></span><span class="token string">, Token is </span><span class="token interpolation"><span class="token punctuation">{</span>py_<span class="token punctuation">.</span>get<span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token string">\'value\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>\n\n    <span class="token comment"># 构建语法分析器</span>\n    parser <span class="token operator">=</span> yacc<span class="token punctuation">.</span>yacc<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    result <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> lexer<span class="token operator">=</span>lexer<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> result\n\n\n<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">\'__main__\'</span><span class="token punctuation">:</span>\n    common_expression <span class="token operator">=</span> <span class="token string">"labels::TEXT[] @> ARRAY [\'{value}\']"</span>\n    like_expression <span class="token operator">=</span> <span class="token string">"labels::TEXT LIKE \'%{value}%\'"</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>\n        parse_sql<span class="token punctuation">(</span>common_expression<span class="token punctuation">,</span> like_expression<span class="token punctuation">,</span> <span class="token string">\'a|-直行路口,-free-,\\,\\(\\)\\|space专项,(b|c),(d,e),%3434,\\%3434\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>\n        parse_sql<span class="token punctuation">(</span>common_expression<span class="token punctuation">,</span> like_expression<span class="token punctuation">,</span> <span class="token string">\'-ego\\-turn\\-right,ego-turn\\-right,ego-turn-right,v4.0.4-f30-ota31-pro,v4.0.4\\-f30\\-ota31\\-pro\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76690659576057820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`sql: a|-直行路口,-free\\-,\\,\\(\\)\\|space专项,(b|c),(d,e),%3434,\\%3434\n\nlabels::TEXT[] @> ARRAY [\'a\'] OR NOT labels::TEXT[] @> ARRAY [\'直行路口\'] AND NOT labels::TEXT[] @> ARRAY [\'free-\'] AND labels::TEXT[] @> ARRAY [\',()|space专项\'] AND (labels::TEXT[] @> ARRAY [\'b\'] OR labels::TEXT[] @> ARRAY [\'c\']) AND (labels::TEXT[] @> ARRAY [\'d\'] AND labels::TEXT[] @> ARRAY [\'e\']) AND labels::TEXT LIKE \'%3434%\' AND labels::TEXT[] @> ARRAY [\'%3434\']\n\n\nsql: -ego\\-turn\\-right,ego\\-turn\\-right,ego\\-turn\\-right,v4.0.4\\-f30\\-ota31\\-pro,v4.0.4\\-f30\\-ota31\\-pro\n\nNOT labels::TEXT[] @> ARRAY [\'ego-turn-right\'] AND labels::TEXT[] @> ARRAY [\'ego-turn-right\'] AND labels::TEXT[] @> ARRAY [\'ego-turn-right\'] AND labels::TEXT[] @> ARRAY [\'v4.0.4-f30-ota31-pro\'] AND labels::TEXT[] @> ARRAY [\'v4.0.4-f30-ota31-pro\']`, `76690659576057820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">sql: a<span class="token operator">|</span>-直行路口,-free<span class="token punctuation">\\</span>-,<span class="token punctuation">\\</span>,<span class="token punctuation">\\</span><span class="token punctuation">(</span><span class="token punctuation">\\</span><span class="token punctuation">)</span><span class="token punctuation">\\</span><span class="token operator">|</span>space专项,<span class="token punctuation">(</span>b<span class="token operator">|</span>c<span class="token punctuation">)</span>,<span class="token punctuation">(</span>d,e<span class="token punctuation">)</span>,%3434,<span class="token punctuation">\\</span>%3434\n\nlabels::TEXT<span class="token punctuation">[</span><span class="token punctuation">]</span> @<span class="token operator">></span> ARRAY <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">]</span> OR NOT labels::TEXT<span class="token punctuation">[</span><span class="token punctuation">]</span> @<span class="token operator">></span> ARRAY <span class="token punctuation">[</span><span class="token string">\'直行路口\'</span><span class="token punctuation">]</span> AND NOT labels::TEXT<span class="token punctuation">[</span><span class="token punctuation">]</span> @<span class="token operator">></span> ARRAY <span class="token punctuation">[</span><span class="token string">\'free-\'</span><span class="token punctuation">]</span> AND labels::TEXT<span class="token punctuation">[</span><span class="token punctuation">]</span> @<span class="token operator">></span> ARRAY <span class="token punctuation">[</span><span class="token string">\',()|space专项\'</span><span class="token punctuation">]</span> AND <span class="token punctuation">(</span>labels::TEXT<span class="token punctuation">[</span><span class="token punctuation">]</span> @<span class="token operator">></span> ARRAY <span class="token punctuation">[</span><span class="token string">\'b\'</span><span class="token punctuation">]</span> OR labels::TEXT<span class="token punctuation">[</span><span class="token punctuation">]</span> @<span class="token operator">></span> ARRAY <span class="token punctuation">[</span><span class="token string">\'c\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> AND <span class="token punctuation">(</span>labels::TEXT<span class="token punctuation">[</span><span class="token punctuation">]</span> @<span class="token operator">></span> ARRAY <span class="token punctuation">[</span><span class="token string">\'d\'</span><span class="token punctuation">]</span> AND labels::TEXT<span class="token punctuation">[</span><span class="token punctuation">]</span> @<span class="token operator">></span> ARRAY <span class="token punctuation">[</span><span class="token string">\'e\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> AND labels::TEXT LIKE <span class="token string">\'%3434%\'</span> AND labels::TEXT<span class="token punctuation">[</span><span class="token punctuation">]</span> @<span class="token operator">></span> ARRAY <span class="token punctuation">[</span><span class="token string">\'%3434\'</span><span class="token punctuation">]</span>\n\n\nsql: -ego<span class="token punctuation">\\</span>-turn<span class="token punctuation">\\</span>-right,ego<span class="token punctuation">\\</span>-turn<span class="token punctuation">\\</span>-right,ego<span class="token punctuation">\\</span>-turn<span class="token punctuation">\\</span>-right,v4.0.4<span class="token punctuation">\\</span>-f30<span class="token punctuation">\\</span>-ota31<span class="token punctuation">\\</span>-pro,v4.0.4<span class="token punctuation">\\</span>-f30<span class="token punctuation">\\</span>-ota31<span class="token punctuation">\\</span>-pro\n\nNOT labels::TEXT<span class="token punctuation">[</span><span class="token punctuation">]</span> @<span class="token operator">></span> ARRAY <span class="token punctuation">[</span><span class="token string">\'ego-turn-right\'</span><span class="token punctuation">]</span> AND labels::TEXT<span class="token punctuation">[</span><span class="token punctuation">]</span> @<span class="token operator">></span> ARRAY <span class="token punctuation">[</span><span class="token string">\'ego-turn-right\'</span><span class="token punctuation">]</span> AND labels::TEXT<span class="token punctuation">[</span><span class="token punctuation">]</span> @<span class="token operator">></span> ARRAY <span class="token punctuation">[</span><span class="token string">\'ego-turn-right\'</span><span class="token punctuation">]</span> AND labels::TEXT<span class="token punctuation">[</span><span class="token punctuation">]</span> @<span class="token operator">></span> ARRAY <span class="token punctuation">[</span><span class="token string">\'v4.0.4-f30-ota31-pro\'</span><span class="token punctuation">]</span> AND labels::TEXT<span class="token punctuation">[</span><span class="token punctuation">]</span> @<span class="token operator">></span> ARRAY <span class="token punctuation">[</span><span class="token string">\'v4.0.4-f30-ota31-pro\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="django-q-对象查询"><a href="#django-q-%E5%AF%B9%E8%B1%A1%E6%9F%A5%E8%AF%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>django Q 对象查询</h2>\n<p><code class="language-text">utils/q_sql_utils.py</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82734242708481360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import re\n\nfrom pydash import py_\nfrom django.db.models import Q\n\n\ndef replace_dashes(match):\n    result = match.group()\n    first_char = \'\'\n\n    if result.startswith(\'-\'):\n        first_char = \'-\'\n        result = result[1:]\n\n    return first_char + re.sub(r\'(?<!\\\\)-\', r\'\\-\', result)\n\n\ndef parse_q(common_expression, like_expression, sql):\n    # () - , | 分别代表左右括号，非，且，或，优先级 () > - > , > |，如果要搜索的 label 带有上述 5 种字符，可以用 \\ 转义，非开头的 - 不需要转义\n    sql = sql.strip()\n    if not sql:\n        return \'\'\n\n    # 预处理，将筛选出 - 开头的匹配项，然后对匹配项里面除了开头的 - 以外的 - 替换为 \\-，最后将替换的结果拼接到原字符串\n    # 就是将下面的 [^()|,-])+ 改为 [^()|,])+，在这里处理替换 - 开头的情况，即将剩余的 - 替换为 \\-\n    pattern = r\'((?:\\\\[()|,-])|[^()|,])+\'\n    sql = re.sub(pattern, replace_dashes, sql)\n\n    print(\'sql:\', sql)\n\n    import ply.lex as lex\n    import ply.yacc as yacc\n\n    # 定义词法分析器的词法规则\n    tokens = (  # noqa: F841\n        \'LPAREN\',\n        \'RPAREN\',\n        \'OR\',\n        \'AND\',\n        \'NOT\',\n        \'TERM\',\n    )\n\n    t_LPAREN = r\'\\(\'  # noqa: F841\n    t_RPAREN = r\'\\)\'  # noqa: F841\n    t_OR = r\'\\|\'  # noqa: F841\n    t_AND = r\',\'  # noqa: F841\n    t_NOT = r\'-\'  # noqa: F841\n\n    def t_TERM(t):\n        # 匹配以 ()|,- 的分割的连续字符，但是要忽略转义字符 \\，如 \\- 表示匹配 -\n        r\'((?:\\\\[()|,-])|[^()|,-])+\'\n        # 去掉转义字符 \\\n        if t.value.startswith(\'\\%\'):\n            t.value = \'\\%\' + re.sub(r\'\\\\([()|,\\-%])\', r\'\\1\', t.value[2:])\n        else:\n            t.value = re.sub(r\'\\\\([()|,\\-%])\', r\'\\1\', t.value)\n        return t\n\n    # 忽略空格和制表符\n    t_ignore = \' \\t\'  # noqa: F841\n\n    # 错误处理\n    def t_error(t):\n        raise TypeError(&quot;Unknown text \'%s\'&quot; % (py_.get(t, \'value\'),))\n\n    # 构建词法分析器\n    lexer = lex.lex()\n\n    # 确定运算符的优先级\n    precedence = (  # noqa: F841\n      (\'left\', \'OR\'),\n      (\'left\', \'AND\'),\n      (\'right\', \'NOT\')\n    )\n\n    # 定义语法分析器的语法规则\n    def p_expression_group(p):\n        \'\'\'expression : LPAREN expression RPAREN\'\'\'\n        p[0] = (p[2])\n\n    def p_expression_or(p):\n        \'\'\'expression : expression OR expression\'\'\'\n        p[0] = Q(p[1]) | Q(p[3])\n\n    def p_expression_and(p):\n        \'\'\'expression : expression AND expression\'\'\'\n        p[0] = Q(p[1]) & Q(p[3])\n\n    def p_expression_not(p):\n        \'\'\'expression : NOT expression\'\'\'\n        p[0] = ~Q(p[2])\n\n    def p_expression_term(p):\n        \'\'\'expression : TERM\'\'\'\n        if p[1].startswith(\'%\'):\n            p[0] = Q(**like_expression(p[1][1:]))\n        else:\n            if p[1].startswith(\'\\%\'):\n                p[1] = p[1][1:]\n            p[0] = Q(**common_expression(p[1]))\n\n    def p_error(p):\n        raise SyntaxError(\n            f&quot;Syntax error in input! Text is {sql}, Token is {py_.get(p, \'value\')}&quot;)\n\n    # 构建语法分析器\n    parser = yacc.yacc()\n    result = parser.parse(sql, lexer=lexer)\n    return result\n\n\nif __name__ == \'__main__\':\n    def common_expression(value): return {\'labels__contains\': [value]}\n    def like_expression(value): return {\'labels__regex\': r\'%s\' % value}\n\n    print(\n        parse_q(common_expression, like_expression, \'a|-直行路口,-free-,\\,\\(\\)\\|space专项,(b|c),(d,e),%3434,\\%3434\'))\n    print(\n        parse_q(common_expression, like_expression, \'-ego\\-turn\\-right,ego-turn\\-right,ego-turn-right,v4.0.4-f30-ota31-pro,v4.0.4\\-f30\\-ota31\\-pro\'))`, `82734242708481360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> re\n\n<span class="token keyword">from</span> pydash <span class="token keyword">import</span> py_\n<span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models <span class="token keyword">import</span> Q\n\n\n<span class="token keyword">def</span> <span class="token function">replace_dashes</span><span class="token punctuation">(</span>match<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    result <span class="token operator">=</span> match<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    first_char <span class="token operator">=</span> <span class="token string">\'\'</span>\n\n    <span class="token keyword">if</span> result<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">\'-\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        first_char <span class="token operator">=</span> <span class="token string">\'-\'</span>\n        result <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>\n\n    <span class="token keyword">return</span> first_char <span class="token operator">+</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r\'(?&lt;!\\\\)-\'</span><span class="token punctuation">,</span> <span class="token string">r\'\\-\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">parse_q</span><span class="token punctuation">(</span>common_expression<span class="token punctuation">,</span> like_expression<span class="token punctuation">,</span> sql<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># () - , | 分别代表左右括号，非，且，或，优先级 () > - > , > |，如果要搜索的 label 带有上述 5 种字符，可以用 \\ 转义，非开头的 - 不需要转义</span>\n    sql <span class="token operator">=</span> sql<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token keyword">not</span> sql<span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string">\'\'</span>\n\n    <span class="token comment"># 预处理，将筛选出 - 开头的匹配项，然后对匹配项里面除了开头的 - 以外的 - 替换为 \\-，最后将替换的结果拼接到原字符串</span>\n    <span class="token comment"># 就是将下面的 [^()|,-])+ 改为 [^()|,])+，在这里处理替换 - 开头的情况，即将剩余的 - 替换为 \\-</span>\n    pattern <span class="token operator">=</span> <span class="token string">r\'((?:\\\\[()|,-])|[^()|,])+\'</span>\n    sql <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> replace_dashes<span class="token punctuation">,</span> sql<span class="token punctuation">)</span>\n\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'sql:\'</span><span class="token punctuation">,</span> sql<span class="token punctuation">)</span>\n\n    <span class="token keyword">import</span> ply<span class="token punctuation">.</span>lex <span class="token keyword">as</span> lex\n    <span class="token keyword">import</span> ply<span class="token punctuation">.</span>yacc <span class="token keyword">as</span> yacc\n\n    <span class="token comment"># 定义词法分析器的词法规则</span>\n    tokens <span class="token operator">=</span> <span class="token punctuation">(</span>  <span class="token comment"># noqa: F841</span>\n        <span class="token string">\'LPAREN\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'RPAREN\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'OR\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'AND\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'NOT\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'TERM\'</span><span class="token punctuation">,</span>\n    <span class="token punctuation">)</span>\n\n    t_LPAREN <span class="token operator">=</span> <span class="token string">r\'\\(\'</span>  <span class="token comment"># noqa: F841</span>\n    t_RPAREN <span class="token operator">=</span> <span class="token string">r\'\\)\'</span>  <span class="token comment"># noqa: F841</span>\n    t_OR <span class="token operator">=</span> <span class="token string">r\'\\|\'</span>  <span class="token comment"># noqa: F841</span>\n    t_AND <span class="token operator">=</span> <span class="token string">r\',\'</span>  <span class="token comment"># noqa: F841</span>\n    t_NOT <span class="token operator">=</span> <span class="token string">r\'-\'</span>  <span class="token comment"># noqa: F841</span>\n\n    <span class="token keyword">def</span> <span class="token function">t_TERM</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># 匹配以 ()|,- 的分割的连续字符，但是要忽略转义字符 \\，如 \\- 表示匹配 -</span>\n        <span class="token string">r\'((?:\\\\[()|,-])|[^()|,-])+\'</span>\n        <span class="token comment"># 去掉转义字符 \\</span>\n        <span class="token keyword">if</span> t<span class="token punctuation">.</span>value<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">\'\\%\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            t<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">\'\\%\'</span> <span class="token operator">+</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r\'\\\\([()|,\\-%])\'</span><span class="token punctuation">,</span> <span class="token string">r\'\\1\'</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>value<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            t<span class="token punctuation">.</span>value <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r\'\\\\([()|,\\-%])\'</span><span class="token punctuation">,</span> <span class="token string">r\'\\1\'</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>value<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> t\n\n    <span class="token comment"># 忽略空格和制表符</span>\n    t_ignore <span class="token operator">=</span> <span class="token string">\' \\t\'</span>  <span class="token comment"># noqa: F841</span>\n\n    <span class="token comment"># 错误处理</span>\n    <span class="token keyword">def</span> <span class="token function">t_error</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">"Unknown text \'%s\'"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>py_<span class="token punctuation">.</span>get<span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">\'value\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n    <span class="token comment"># 构建词法分析器</span>\n    lexer <span class="token operator">=</span> lex<span class="token punctuation">.</span>lex<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    <span class="token comment"># 确定运算符的优先级</span>\n    precedence <span class="token operator">=</span> <span class="token punctuation">(</span>  <span class="token comment"># noqa: F841</span>\n      <span class="token punctuation">(</span><span class="token string">\'left\'</span><span class="token punctuation">,</span> <span class="token string">\'OR\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token punctuation">(</span><span class="token string">\'left\'</span><span class="token punctuation">,</span> <span class="token string">\'AND\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token punctuation">(</span><span class="token string">\'right\'</span><span class="token punctuation">,</span> <span class="token string">\'NOT\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">)</span>\n\n    <span class="token comment"># 定义语法分析器的语法规则</span>\n    <span class="token keyword">def</span> <span class="token function">p_expression_group</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token triple-quoted-string string">\'\'\'expression : LPAREN expression RPAREN\'\'\'</span>\n        p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">p_expression_or</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token triple-quoted-string string">\'\'\'expression : expression OR expression\'\'\'</span>\n        p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> Q<span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">|</span> Q<span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">p_expression_and</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token triple-quoted-string string">\'\'\'expression : expression AND expression\'\'\'</span>\n        p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> Q<span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> Q<span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">p_expression_not</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token triple-quoted-string string">\'\'\'expression : NOT expression\'\'\'</span>\n        p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">~</span>Q<span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">p_expression_term</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token triple-quoted-string string">\'\'\'expression : TERM\'\'\'</span>\n        <span class="token keyword">if</span> p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">\'%\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> Q<span class="token punctuation">(</span><span class="token operator">**</span>like_expression<span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">\'\\%\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n                p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>\n            p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> Q<span class="token punctuation">(</span><span class="token operator">**</span>common_expression<span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">p_error</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> SyntaxError<span class="token punctuation">(</span>\n            <span class="token string-interpolation"><span class="token string">f"Syntax error in input! Text is </span><span class="token interpolation"><span class="token punctuation">{</span>sql<span class="token punctuation">}</span></span><span class="token string">, Token is </span><span class="token interpolation"><span class="token punctuation">{</span>py_<span class="token punctuation">.</span>get<span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token string">\'value\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>\n\n    <span class="token comment"># 构建语法分析器</span>\n    parser <span class="token operator">=</span> yacc<span class="token punctuation">.</span>yacc<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    result <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> lexer<span class="token operator">=</span>lexer<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> result\n\n\n<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">\'__main__\'</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">common_expression</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">\'labels__contains\'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token punctuation">}</span>\n    <span class="token keyword">def</span> <span class="token function">like_expression</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">\'labels__regex\'</span><span class="token punctuation">:</span> <span class="token string">r\'%s\'</span> <span class="token operator">%</span> value<span class="token punctuation">}</span>\n\n    <span class="token keyword">print</span><span class="token punctuation">(</span>\n        parse_q<span class="token punctuation">(</span>common_expression<span class="token punctuation">,</span> like_expression<span class="token punctuation">,</span> <span class="token string">\'a|-直行路口,-free-,\\,\\(\\)\\|space专项,(b|c),(d,e),%3434,\\%3434\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>\n        parse_q<span class="token punctuation">(</span>common_expression<span class="token punctuation">,</span> like_expression<span class="token punctuation">,</span> <span class="token string">\'-ego\\-turn\\-right,ego-turn\\-right,ego-turn-right,v4.0.4-f30-ota31-pro,v4.0.4\\-f30\\-ota31\\-pro\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4067849112278310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`sql: a|-直行路口,-free\\-,\\,\\(\\)\\|space专项,(b|c),(d,e),%3434,\\%3434\n\n(OR: (AND: (\'labels__contains\', [\'a\'])), (AND: (AND: (AND: (AND: (AND: (AND: (NOT (AND: (AND: (\'labels__contains\', [\'直行路口\'])))), (NOT (AND: (AND: (\'labels__contains\', [\'free-\']))))), (AND: (\'labels__contains\', [\',()|space专项\']))), (OR: (AND: (\'labels__contains\', [\'b\'])), (AND: (\'labels__contains\', [\'c\'])))), (AND: (AND: (\'labels__contains\', [\'d\'])), (AND: (\'labels__contains\', [\'e\'])))), (AND: (\'labels__regex\', \'3434\'))), (AND: (\'labels__contains\', [\'%3434\']))))\n\n\nsql: -ego\\-turn\\-right,ego\\-turn\\-right,ego\\-turn\\-right,v4.0.4\\-f30\\-ota31\\-pro,v4.0.4\\-f30\\-ota31\\-pro\n\n(AND: (AND: (AND: (AND: (NOT (AND: (AND: (\'labels__contains\', [\'ego-turn-right\'])))), (AND: (\'labels__contains\', [\'ego-turn-right\']))), (AND: (\'labels__contains\', [\'ego-turn-right\']))), (AND: (\'labels__contains\', [\'v4.0.4-f30-ota31-pro\']))), (AND: (\'labels__contains\', [\'v4.0.4-f30-ota31-pro\'])))`, `4067849112278310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="sql"\n              >\n                <span class="gatsby-code-button-language">sql</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="sql"><pre style="counter-reset: linenumber NaN" class="language-sql line-numbers"><code class="language-sql"><span class="token keyword">sql</span>: a<span class="token operator">|</span><span class="token operator">-</span>直行路口<span class="token punctuation">,</span><span class="token operator">-</span>free\\<span class="token operator">-</span><span class="token punctuation">,</span>\\<span class="token punctuation">,</span>\\<span class="token punctuation">(</span>\\<span class="token punctuation">)</span>\\<span class="token operator">|</span>space专项<span class="token punctuation">,</span><span class="token punctuation">(</span>b<span class="token operator">|</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">%</span><span class="token number">3434</span><span class="token punctuation">,</span>\\<span class="token operator">%</span><span class="token number">3434</span>\n\n<span class="token punctuation">(</span><span class="token operator">OR</span>: <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token string">\'labels__contains\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token operator">NOT</span> <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token string">\'labels__contains\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'直行路口\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">NOT</span> <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token string">\'labels__contains\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'free-\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token string">\'labels__contains\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\',()|space专项\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">OR</span>: <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token string">\'labels__contains\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'b\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token string">\'labels__contains\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'c\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token string">\'labels__contains\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'d\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token string">\'labels__contains\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'e\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token string">\'labels__regex\'</span><span class="token punctuation">,</span> <span class="token string">\'3434\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token string">\'labels__contains\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'%3434\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">sql</span>: <span class="token operator">-</span>ego\\<span class="token operator">-</span>turn\\<span class="token operator">-</span><span class="token keyword">right</span><span class="token punctuation">,</span>ego\\<span class="token operator">-</span>turn\\<span class="token operator">-</span><span class="token keyword">right</span><span class="token punctuation">,</span>ego\\<span class="token operator">-</span>turn\\<span class="token operator">-</span><span class="token keyword">right</span><span class="token punctuation">,</span>v4<span class="token punctuation">.</span><span class="token number">0.4</span>\\<span class="token operator">-</span>f30\\<span class="token operator">-</span>ota31\\<span class="token operator">-</span>pro<span class="token punctuation">,</span>v4<span class="token punctuation">.</span><span class="token number">0.4</span>\\<span class="token operator">-</span>f30\\<span class="token operator">-</span>ota31\\<span class="token operator">-</span>pro\n\n<span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token operator">NOT</span> <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token string">\'labels__contains\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'ego-turn-right\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token string">\'labels__contains\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'ego-turn-right\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token string">\'labels__contains\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'ego-turn-right\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token string">\'labels__contains\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'v4.0.4-f30-ota31-pro\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">AND</span>: <span class="token punctuation">(</span><span class="token string">\'labels__contains\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'v4.0.4-f30-ota31-pro\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>',
excerpt:"背景 针对 postgres 某个表里面的 labels 字段（labels 字段是一维数组类型）做复杂查询，要求支持常见的且，或，非等等功能 原来的业务逻辑已实现了且，或，非功能，但不支持括号来提高运算符的优先级 方案 显而易见的方案就是实现一个 python…",frontmatter:{date:"2024-05-15 18:09:57",path:"/python-search-by-syntax/",tags:"后端, python, 预研",title:"Python 语法解析器实现复杂搜索",draft:null}},prePost:{html:'<h1 id="前端远程调试"><a href="#%E5%89%8D%E7%AB%AF%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>前端远程调试</h1>\n<h2 id="背景"><a href="#%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景</h2>\n<p>由于有些时候不方便到用户实地/远程桌面复现 bug，需要远程查看对方网页的控制台，经过预研发现远程调试工具 <a href="https://github.com/HuolalaTech/page-spy-web/tree/main" target="_blank" rel="nofollow noreferrer noopener">page-spy-web</a> 比较合适</p>\n<h2 id="实现"><a href="#%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现</h2>\n<ol>\n<li>\n<p>在开发机（由于开发只能完全控制开发机，同时要保证此开发机能被下面的前端服务器访问）上部署一个 <a href="https://github.com/HuolalaTech/page-spy-web/blob/main/README_ZH.md" target="_blank" rel="nofollow noreferrer noopener">docker 镜像</a></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74563233238200830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker run -d --restart=always -p 6752:6752 --name=&quot;pageSpy&quot; ghcr.io/huolalatech/page-spy-web:latest`, `74563233238200830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker run -d --restart<span class="token operator">=</span>always -p <span class="token number">6752</span>:6752 --name<span class="token operator">=</span><span class="token string">"pageSpy"</span> ghcr.io/huolalatech/page-spy-web:latest</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n</li>\n<li>\n<p>通过特定域名（可以自定义域名后缀，配合下面的前端服务器），配置 nginx 转发到此开发机</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75969395747942900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`server {\n  listen 80;\n  server_name *.你的对外域名后缀（和前端域名保持一致后缀）;\n  access_log  /var/log/nginx/access.log main;\n  proxy_read_timeout 240s;\n\n  location / {\n     proxy_http_version 1.1;\n     proxy_set_header Upgrade \\$http_upgrade;\n     proxy_set_header Connection &quot;Upgrade&quot;;\n     proxy_set_header Host \\$host;\n     proxy_pass http://localhost:6752;\n  }\n}`, `75969395747942900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">server <span class="token punctuation">{</span>\n  listen <span class="token number">80</span><span class="token punctuation">;</span>\n  server_name *.你的对外域名后缀（和前端域名保持一致后缀）<span class="token punctuation">;</span>\n  access_log  /var/log/nginx/access.log main<span class="token punctuation">;</span>\n  proxy_read_timeout 240s<span class="token punctuation">;</span>\n\n  location / <span class="token punctuation">{</span>\n     proxy_http_version <span class="token number">1.1</span><span class="token punctuation">;</span>\n     proxy_set_header Upgrade <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>\n     proxy_set_header Connection <span class="token string">"Upgrade"</span><span class="token punctuation">;</span>\n     proxy_set_header Host <span class="token variable">$host</span><span class="token punctuation">;</span>\n     proxy_pass http://localhost:6752<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>由于前端服务器需要能访问到开发机，所以需要在前端服务器对应的 nginx 做转发，这里配置到前端域名的子路径，参考<a href="https://github.com/HuolalaTech/page-spy-web/wiki/%F0%9F%90%9E-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E7%AD%94#%E5%A6%82%E4%BD%95%E9%83%A8%E7%BD%B2%E5%88%B0%E5%AD%90%E8%B7%AF%E5%BE%84" target="_blank" rel="nofollow noreferrer noopener">步骤</a></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35083963399615013000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`server {\n  location /pagespy/  {\n     # 这里请求转发到开发机，同时由于开发机的 nginx 配置的和前端域名一致，所以能成功转发到开发机对应的 pagespy 服务\n     rewrite ^/pagespy/(.*)\\$ /\\$1 break;\n     proxy_pass  http://开发机对外ip;\n     proxy_http_version 1.1;\n     proxy_set_header  Upgrade \\$http_upgrade;\n     proxy_set_header  Connection &quot;upgrade&quot;;\n     proxy_set_header  Host \\$host;\n     proxy_set_header  X-Real-IP \\$remote_addr;\n     proxy_set_header  X-Forwarded-For \\$proxy_add_x_forwarded_for;\n  }\n\n  location /pagespy {\n     return 301 \\$scheme://\\$host\\$request_uri/;\n  }\n}`, `35083963399615013000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">server <span class="token punctuation">{</span>\n  location /pagespy/  <span class="token punctuation">{</span>\n     <span class="token comment"># 这里请求转发到开发机，同时由于开发机的 nginx 配置的和前端域名一致，所以能成功转发到开发机对应的 pagespy 服务</span>\n     rewrite ^/pagespy/<span class="token punctuation">(</span>.*<span class="token punctuation">)</span>$ /<span class="token variable">$1</span> <span class="token builtin class-name">break</span><span class="token punctuation">;</span>\n     proxy_pass  http://开发机对外ip<span class="token punctuation">;</span>\n     proxy_http_version <span class="token number">1.1</span><span class="token punctuation">;</span>\n     proxy_set_header  Upgrade <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>\n     proxy_set_header  Connection <span class="token string">"upgrade"</span><span class="token punctuation">;</span>\n     proxy_set_header  Host <span class="token variable">$host</span><span class="token punctuation">;</span>\n     proxy_set_header  X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>\n     proxy_set_header  X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  location /pagespy <span class="token punctuation">{</span>\n     <span class="token builtin class-name">return</span> <span class="token number">301</span> <span class="token variable">$scheme</span>://<span class="token variable">$host</span><span class="token variable">$request_uri</span>/<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>修改前端代码主入口适配远程调试</p>\n<p>src/utils/index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35634681869617890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 异步加载单个脚本\nasync function loadSingleScript(src, options) {\n  return await new Promise((resolve, reject) => {\n     // 这里未考虑到同一 src 同时发起的情况，改用缓存实现\n     // if (!id) {\n     //   const NAMESPACE = \'c2b16a16-12b3-423a-879f-6b46d1a01d60\'\n     //   const PREFIX = \'script-id-\'\n     //   id = PREFIX + uuidv5(src, NAMESPACE)\n     // }\n     // if (!src || document.querySelector(\\`#\\${id}\\`)) {\n     //   return\n     // }\n     const script = document.createElement(\'script\');\n     const { attributesMap = {}, ...rest } = options;\n     Object.keys(rest).forEach((key) => {\n        script[key] = rest[key];\n     });\n     Object.keys(attributesMap).forEach((key) => {\n        script.setAttribute(key, attributesMap[key]);\n     });\n     script.async = true;\n     script.src = src;\n     script.onload = resolve;\n     script.onerror = reject;\n     document.getElementsByTagName(\'head\')[0].appendChild(script);\n  });\n}\n\n// 异步加载多个脚本\n// memoize 默认情况下用第一个参数作为缓存的 key，即 src\nexport const loadScript = memoize(loadSingleScript);`, `35634681869617890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 异步加载单个脚本</span>\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">loadSingleScript</span><span class="token punctuation">(</span><span class="token parameter">src<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n     <span class="token comment">// 这里未考虑到同一 src 同时发起的情况，改用缓存实现</span>\n     <span class="token comment">// if (!id) {</span>\n     <span class="token comment">//   const NAMESPACE = \'c2b16a16-12b3-423a-879f-6b46d1a01d60\'</span>\n     <span class="token comment">//   const PREFIX = \'script-id-\'</span>\n     <span class="token comment">//   id = PREFIX + uuidv5(src, NAMESPACE)</span>\n     <span class="token comment">// }</span>\n     <span class="token comment">// if (!src || document.querySelector(`#${id}`)) {</span>\n     <span class="token comment">//   return</span>\n     <span class="token comment">// }</span>\n     <span class="token keyword">const</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'script\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n     <span class="token keyword">const</span> <span class="token punctuation">{</span> attributesMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>\n     Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>rest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        script<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> rest<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>\n     <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n     Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>attributesMap<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        script<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> attributesMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n     <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n     script<span class="token punctuation">.</span>async <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n     script<span class="token punctuation">.</span>src <span class="token operator">=</span> src<span class="token punctuation">;</span>\n     script<span class="token punctuation">.</span>onload <span class="token operator">=</span> resolve<span class="token punctuation">;</span>\n     script<span class="token punctuation">.</span>onerror <span class="token operator">=</span> reject<span class="token punctuation">;</span>\n     document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">\'head\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 异步加载多个脚本</span>\n<span class="token comment">// memoize 默认情况下用第一个参数作为缓存的 key，即 src</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> loadScript <span class="token operator">=</span> <span class="token function">memoize</span><span class="token punctuation">(</span>loadSingleScript<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>src/index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30087619492052898000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { loadScript } from \'./utils\';\n\nasync function loadScriptFunc() {\n  // 这里使用别名访问 pagespy 服务\n  await loadScript(\'/pagespy/page-spy/index.min.js\', { attributesMap: { crossorigin: \'anonymous\' } });\n  if (!window.PageSpy) {\n     return;\n  }\n  window.\\$pageSpy = new window.PageSpy({\n     api: window.location.host + \'/pagespy\',\n     clientOrigin: window.location.origin + \'/pagespy\',\n     project: window.location.host,\n     title: window.localStorage.getItem(\'simUsername\') || \'anonymous\'\n  });\n}\n\nconst is_debug = new URLSearchParams(window.location.hash.split(\'?\')[1]).get(\'is_debug\');\n\nif (process.env.NODE_ENV === \'production\' && is_debug) {\n  loadScriptFunc();\n}`, `30087619492052898000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> loadScript <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'./utils\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">loadScriptFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 这里使用别名访问 pagespy 服务</span>\n  <span class="token keyword">await</span> <span class="token function">loadScript</span><span class="token punctuation">(</span><span class="token string">\'/pagespy/page-spy/index.min.js\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> attributesMap<span class="token punctuation">:</span> <span class="token punctuation">{</span> crossorigin<span class="token punctuation">:</span> <span class="token string">\'anonymous\'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>PageSpy<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n     <span class="token keyword">return</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  window<span class="token punctuation">.</span>$pageSpy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">window<span class="token punctuation">.</span>PageSpy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n     api<span class="token punctuation">:</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>host <span class="token operator">+</span> <span class="token string">\'/pagespy\'</span><span class="token punctuation">,</span>\n     clientOrigin<span class="token punctuation">:</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>origin <span class="token operator">+</span> <span class="token string">\'/pagespy\'</span><span class="token punctuation">,</span>\n     project<span class="token punctuation">:</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>host<span class="token punctuation">,</span>\n     title<span class="token punctuation">:</span> window<span class="token punctuation">.</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">\'simUsername\'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">\'anonymous\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> is_debug <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'?\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">\'is_debug\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">\'production\'</span> <span class="token operator">&amp;&amp;</span> is_debug<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">loadScriptFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<h2 id="效果"><a href="#%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果</h2>\n<ol>\n<li>让需要调试的远程页面加上 <code class="language-text">?is_debug=1</code> 参数，可以看到左下角进入待调试状态，点击左下角按钮然后点击 copy 复制出来待调试的远程链接，如果不方便让用户复制，转步骤 2</li>\n</ol>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-05-16-11-03-42-7bb8f8dbc780c4d008ab7c3b02979e82-47ad6.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 78px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 105.12820512820514%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAIAAADJt1n/AAAACXBIWXMAAAsSAAALEgHS3X78AAAB4UlEQVQ4y5VU207CQBDtZ5gYY3zxwWgk6iNq4oUoiRjUGK/xEgkaoFdaoHa73QJ+t2d36lookngeYDo7Zy5ntjVihSiK4n+CMWb8RWYKkQLZRf4MMuxPhSgH7ZlHRkQYhlSt2Aul0EcGeSkaNJzNHE8TEDkYDOjR0LPNYQqRpEORn4v4Wdt9hSITDQ3HqdnyKuVbFrGYZ/6BgkGZgiAoCi6ZI+HawerC4dnxo0gTrQPK9no9SUbDsDjnhZrCsfy1xZP66ctonE6lzipTz3kyEqOmYwYbS7Xa0WvMeCI4ldXioaQko2dYmoyjJOF2p1davjrZfdnfelxfvGy+uukw0XwaVqrt+z50/iVHbPQl6pXm9srtfunpYOd5c+n65rw1GgupWU7zjExtsx/whHt2v7r3dnX6US03LirvUwMjGPUycrfbpcrUktxtCge/O+/c1ztCSDtmE2TUkzNDatu2i3tqPLjNZw9MrHfqsoLseZ5BN9ayrLzg+Ped0DNDKFe8OQjDnhzHyS4J2gYfRk62mM8gxiQNOgXF0BtHJrikWjNJP0z8UmS2Z33X4TJNEwb/AyBYCphx4kuCB6rfbreRBSrS20+iINp1XTqCTS/CxMeA4rA55G4rdBTIhhNHKK7f7W+yYVMJjySfhwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 05 16 11 03 42" title="" data-src="/static/2024-05-16-11-03-42-7bb8f8dbc780c4d008ab7c3b02979e82-47ad6.png" data-srcset="/static/2024-05-16-11-03-42-7bb8f8dbc780c4d008ab7c3b02979e82-47ad6.png 78w" data-sizes="(max-width: 78px) 100vw, 78px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-05-16-11-03-29-f6cc133339429b322dde7d38f5047470-83562.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 315px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 56.19047619047619%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABaklEQVQoz41RXW+CMBTt//8jLvF9PuiTwhxqYgwyJ0ihUHELM/L9KWOHwsN886S5ub0959zblozH4+12qyjK6mmADMlo9EI2m03btk3TtE+jJ8uyRNbrVRzHsizv95ouoGkfaZoej7pl2UmS3O/3uqq6VSNUeZ7jFOLXyYRISwVZEITQgK1pmmmaZVl6nsf5+UvAdbnjOJzzy+UCfVEWkMznc7J878RgqOoe3dCfUgp7Si1HAF7UspjNLIHb7VYUnXixWBDcHhmmhexw+ATVcVwcow+ag80Y830f7tfr9VsAcw3ilRDHcYKxVVXd7XaGYUBsM3Y6mcgRXc6pSUHQdQNt4ALJdDodxsac8MPL4TGyLEMuHiYTu7wQSJIUxUQAktlsRqS3916M42oAtCVi81tjDfuuUvWxv7MkdV+1RoZq/Q/4HdDONDhbAZL6Ef2d8bsEBjALwzB+RBTFnvPDbT8Mo8d6BDIsMPYfvLhW1+5TuC0AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 05 16 11 03 29" title="" data-src="/static/2024-05-16-11-03-29-f6cc133339429b322dde7d38f5047470-83562.png" data-srcset="/static/2024-05-16-11-03-29-f6cc133339429b322dde7d38f5047470-738c0.png 200w,\n/static/2024-05-16-11-03-29-f6cc133339429b322dde7d38f5047470-83562.png 315w" data-sizes="(max-width: 315px) 100vw, 315px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-05-16-11-08-15-23fa931a67f570e50ce463e2f81ee53c-7f18a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 47.46987951807229%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAAA5UlEQVQoz52Sa5LCIBCEuf/Z9hD+SqKyGnkOz3ZCRKNV1uqm8hVMQzo9FMKrgnE44iCPiDGilPIxuZEbXRPDMCJQgNcKzjlorWGMgV7g+TsUM+vLymW+60JOO5x+J4y7H8RAsM6D2Jh4MYaAlBISJ2/jK/HGRhNeB8jDCZ4ijDZQysArDdpPKCmjP7VWPIr2bqj3PcLMASWiYa3lhJzOWJCUiNx2Yi0Ttc2fIJyzKLW0/yxn6Dwh8BjO52aWeJ659S8MHWpZi+UMevSnFjfan4bLVelFzvnx8RcmT4Y9QbtXW8N/cgVTEcN13/j7JAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 05 16 11 08 15" title="" data-src="/static/2024-05-16-11-08-15-23fa931a67f570e50ce463e2f81ee53c-fee1c.png" data-srcset="/static/2024-05-16-11-08-15-23fa931a67f570e50ce463e2f81ee53c-a67b7.png 200w,\n/static/2024-05-16-11-08-15-23fa931a67f570e50ce463e2f81ee53c-0b187.png 400w,\n/static/2024-05-16-11-08-15-23fa931a67f570e50ce463e2f81ee53c-fee1c.png 800w,\n/static/2024-05-16-11-08-15-23fa931a67f570e50ce463e2f81ee53c-b1a91.png 1200w,\n/static/2024-05-16-11-08-15-23fa931a67f570e50ce463e2f81ee53c-7f18a.png 1245w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<ol start="2">\n<li>进入调试界面，网址为前端域名加上 /pagespy/，找到对应的项目/用户名/设备号（设备号可让用户截图发过来避免调试错误页面的情况）进入房间列表去调试</li>\n</ol>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-05-16-11-01-42-c62d5f073bf24e89b39c7a25a86fe74b-a9fd5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 51.09375000000001%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABTklEQVQoz4WSPU/DMBCG8xuiJP5MUtw6qUGoNI3SCEVI0IER0Q2GTgjEwP8fX+y0qWLR0uFk++783Hv2BXmqUegSQnBQSsEY+9dcjpAS80mO1XSKWZ4jzTKkaQqtNQLKOAghF0D0YKfjnHNEUYT1eo2Ac9k7zpmw8VTkkDy3Z+HF2JAjBOI4RtM0CJgDukouwasqkJAYV7JEW2xxr3Z2b0BZvAcelLl1AB4VDrL5AbpPiNDULXbbH7x033i4eUOtXqHl6ggd7rl813LXdb5Cvx0GY65xd7eEnpXgJMNEaqhJ0b+n9yyXgK6yFNYvGeriGZv6HZ9fH3jaPIJQ0gNcwfPAUdBTaZXMslsYtULbtpiXcyQJ8QqfBI5nzI1QkiRHi+KwtzAM+zMffd5Jhe5TpB3UzA7n1A6qMQaLxQJVVWFZLfu98yml9q2yv92Mgb8ZGw/gKUxbggAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 05 16 11 01 42" title="" data-src="/static/2024-05-16-11-01-42-c62d5f073bf24e89b39c7a25a86fe74b-fee1c.png" data-srcset="/static/2024-05-16-11-01-42-c62d5f073bf24e89b39c7a25a86fe74b-a67b7.png 200w,\n/static/2024-05-16-11-01-42-c62d5f073bf24e89b39c7a25a86fe74b-0b187.png 400w,\n/static/2024-05-16-11-01-42-c62d5f073bf24e89b39c7a25a86fe74b-fee1c.png 800w,\n/static/2024-05-16-11-01-42-c62d5f073bf24e89b39c7a25a86fe74b-b1a91.png 1200w,\n/static/2024-05-16-11-01-42-c62d5f073bf24e89b39c7a25a86fe74b-a9fd5.png 1280w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-05-16-11-07-05-e0a887dd5aa70ca72c948b8b0b521022-2407e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 34.28209993674889%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAAAw0lEQVQY03WPTQvCMAyG9///kBdP3gUPIsz5cZgwFV3b5aNrt4lpuymIewihafrmTbPqWllru65jZu99N49zjiNEJBkRs1Qbo/M811rLoHSDEZ6IFUjXtiGSPqOInOq6loOYi4NkKWWWnwAAY4xMJgyR/EdxAqAhptQQI/oByToqi+a8U9ziKJZ3ss4wvA7FUSR93/9RfiZAiET4M4ZV+H7h6kTl/gEKg/esnOJmUWw5/F723a7UZqnWi+etBOt43vvLGz0MkDjnxXr/AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 05 16 11 07 05" title="" data-src="/static/2024-05-16-11-07-05-e0a887dd5aa70ca72c948b8b0b521022-fee1c.png" data-srcset="/static/2024-05-16-11-07-05-e0a887dd5aa70ca72c948b8b0b521022-a67b7.png 200w,\n/static/2024-05-16-11-07-05-e0a887dd5aa70ca72c948b8b0b521022-0b187.png 400w,\n/static/2024-05-16-11-07-05-e0a887dd5aa70ca72c948b8b0b521022-fee1c.png 800w,\n/static/2024-05-16-11-07-05-e0a887dd5aa70ca72c948b8b0b521022-b1a91.png 1200w,\n/static/2024-05-16-11-07-05-e0a887dd5aa70ca72c948b8b0b521022-2407e.png 1581w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="后端调试"><a href="#%E5%90%8E%E7%AB%AF%E8%B0%83%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后端调试</h1>\n<h2 id="背景-1"><a href="#%E8%83%8C%E6%99%AF-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景</h2>\n<p>对于 python 后端框架，在内部逻辑有执行 <code class="language-text">orm</code> 或 <code class="language-text">原生 sql</code> 的接口的过程中不知道具体执行了什么 sql，需要有一个调试工具能展示</p>\n<h2 id="django"><a href="#django" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>django</h2>\n<p>针对后端使用的 Django 3.1 以及 python 3.6 版本，预研发现只有 <a href="https://github.com/jazzband/django-debug-toolbar" target="_blank" rel="nofollow noreferrer noopener">django-debug-toolbar</a>，<a href="https://github.com/jazzband/django-silk" target="_blank" rel="nofollow noreferrer noopener">django-silk</a> 符合要求</p>\n<h3 id="实现-1"><a href="#%E5%AE%9E%E7%8E%B0-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现</h3>\n<h4 id="django-debug-toolbar--django-silk"><a href="#django-debug-toolbar--django-silk" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>django-debug-toolbar + django-silk</h4>\n<ol>\n<li>\n<p>安装依赖库</p>\n<p>Dockerfile-local</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12043275715221301000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RUN python3.6 -m pip install django-silk==4.2.0 django-debug-toolbar==3.1.1 ipython pyflame git+https://github.com/towavephone/django-debug-toolbar-mongo.git@v0.3`, `12043275715221301000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">RUN</span> python3.6 <span class="token punctuation">-</span>m pip install django<span class="token punctuation">-</span>silk==4.2.0 django<span class="token punctuation">-</span>debug<span class="token punctuation">-</span>toolbar==3.1.1 ipython pyflame git+https<span class="token punctuation">:</span>//github.com/towavephone/django<span class="token punctuation">-</span>debug<span class="token punctuation">-</span>toolbar<span class="token punctuation">-</span>mongo.git@v0.3</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n</li>\n<li>\n<p>修改启动脚本，挂载 tmp 目录</p>\n<p>deployment/local/start.sh</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70087878223138685000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`-v /tmp:/tmp`, `70087878223138685000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">-v /tmp:/tmp</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n</li>\n<li>\n<p>修改本地配置</p>\n<p>local.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12480706411245656000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;debug&quot;: true,\n  &quot;debug_tools&quot;: [&quot;django-debug-toolbar&quot;]\n}`, `12480706411245656000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"debug"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  <span class="token property">"debug_tools"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"django-debug-toolbar"</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>修改 setting.py</p>\n<p>settings.py</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99124699055891680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`DEBUG = __config.get(\'debug\', False)\nDEBUG_TOOLS = __config.get(\'debug_tools\', [])\n\nif DEBUG:\n  if \'django-silk\' in DEBUG_TOOLS:\n     SILKY_META = True\n     SILKY_PYTHON_PROFILER = True\n     SILKY_PYTHON_PROFILER_BINARY = True\n     def request_func(request):\n           # 过滤掉 debug toolbar 的请求\n           return not (request.path.startswith(\'/__debug__\') or request.path == \'/\')\n     SILKY_INTERCEPT_FUNC = request_func\n\n     MIDDLEWARE += [\n        \'silk.middleware.SilkyMiddleware\',\n        \'entry.middleware.SilkProfileAllViewsMiddleware\'\n     ]\n\n     INSTALLED_APPS += [\n        \'silk\'\n     ]\n\n  if \'django-debug-toolbar\' in DEBUG_TOOLS:\n     MIDDLEWARE += [\n        \'debug_toolbar.middleware.DebugToolbarMiddleware\'\n     ]\n\n     INSTALLED_APPS += [\n        \'debug_toolbar\',\n        \'pympler\',\n        \'debug_toolbar_mongo\',\n        \'pyflame\'\n     ]\n\n     INTERNAL_IPS = [\n        &quot;127.0.0.1&quot;,\n        &quot;localhost&quot;\n     ]\n\n     def custom_show_toolbar(request):\n           # 路径为 /debug，即显示 silk 时候不需要显示 debug toolbar\n           from debug_toolbar.middleware import show_toolbar\n           return show_toolbar(request) and not request.path.startswith(&quot;/debug&quot;)\n\n     DEBUG_TOOLBAR_CONFIG = {\n        \'SHOW_TOOLBAR_CALLBACK\': custom_show_toolbar,\n     }\n\n     DEBUG_TOOLBAR_PANELS =  [\n        \'debug_toolbar.panels.history.HistoryPanel\',\n        \'debug_toolbar.panels.sql.SQLPanel\',\n        \'debug_toolbar_mongo.panel.MongoDebugPanel\',\n        \'debug_toolbar.panels.timer.TimerPanel\',\n        \'pympler.panels.MemoryPanel\' ,\n        \'pyflame.djdt.panel.FlamegraphPanel\',\n        \'debug_toolbar.panels.versions.VersionsPanel\',\n        \'debug_toolbar.panels.settings.SettingsPanel\',\n        \'debug_toolbar.panels.headers.HeadersPanel\',\n        \'debug_toolbar.panels.request.RequestPanel\',\n        \'debug_toolbar.panels.staticfiles.StaticFilesPanel\',\n        \'debug_toolbar.panels.templates.TemplatesPanel\',\n        \'debug_toolbar.panels.cache.CachePanel\',\n        \'debug_toolbar.panels.signals.SignalsPanel\',\n        \'debug_toolbar.panels.logging.LoggingPanel\',\n        \'debug_toolbar.panels.redirects.RedirectsPanel\',\n        \'debug_toolbar.panels.profiling.ProfilingPanel\',\n     ]\n\n     PYFLAME_CONFIG = {\n           # https://gitlab.com/living180/pyflame\n           # 默认值 None 告诉 pyflame 使用环境变量 PATH 搜索 Flamegraph.pl\n           \'FLAMEGRAPH_SCRIPT_PATH\': \'/root/third_party/flamegraph.pl\',\n     }\n\n     # mongo toolbar 每个操作的最大显示数量\n     DEBUG_TOOLBAR_MONGO_MAX_OPERATION_SIZE = 20\n\nif DEBUG and \'django-silk\' in DEBUG_TOOLS:\n  MEDIA_ROOT = \'/tmp\'`, `99124699055891680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">DEBUG <span class="token operator">=</span> __config<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'debug\'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>\nDEBUG_TOOLS <span class="token operator">=</span> __config<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'debug_tools\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> DEBUG<span class="token punctuation">:</span>\n  <span class="token keyword">if</span> <span class="token string">\'django-silk\'</span> <span class="token keyword">in</span> DEBUG_TOOLS<span class="token punctuation">:</span>\n     SILKY_META <span class="token operator">=</span> <span class="token boolean">True</span>\n     SILKY_PYTHON_PROFILER <span class="token operator">=</span> <span class="token boolean">True</span>\n     SILKY_PYTHON_PROFILER_BINARY <span class="token operator">=</span> <span class="token boolean">True</span>\n     <span class="token keyword">def</span> <span class="token function">request_func</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>\n           <span class="token comment"># 过滤掉 debug toolbar 的请求</span>\n           <span class="token keyword">return</span> <span class="token keyword">not</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>path<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">\'/__debug__\'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> request<span class="token punctuation">.</span>path <span class="token operator">==</span> <span class="token string">\'/\'</span><span class="token punctuation">)</span>\n     SILKY_INTERCEPT_FUNC <span class="token operator">=</span> request_func\n\n     MIDDLEWARE <span class="token operator">+=</span> <span class="token punctuation">[</span>\n        <span class="token string">\'silk.middleware.SilkyMiddleware\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'entry.middleware.SilkProfileAllViewsMiddleware\'</span>\n     <span class="token punctuation">]</span>\n\n     INSTALLED_APPS <span class="token operator">+=</span> <span class="token punctuation">[</span>\n        <span class="token string">\'silk\'</span>\n     <span class="token punctuation">]</span>\n\n  <span class="token keyword">if</span> <span class="token string">\'django-debug-toolbar\'</span> <span class="token keyword">in</span> DEBUG_TOOLS<span class="token punctuation">:</span>\n     MIDDLEWARE <span class="token operator">+=</span> <span class="token punctuation">[</span>\n        <span class="token string">\'debug_toolbar.middleware.DebugToolbarMiddleware\'</span>\n     <span class="token punctuation">]</span>\n\n     INSTALLED_APPS <span class="token operator">+=</span> <span class="token punctuation">[</span>\n        <span class="token string">\'debug_toolbar\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'pympler\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'debug_toolbar_mongo\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'pyflame\'</span>\n     <span class="token punctuation">]</span>\n\n     INTERNAL_IPS <span class="token operator">=</span> <span class="token punctuation">[</span>\n        <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span>\n        <span class="token string">"localhost"</span>\n     <span class="token punctuation">]</span>\n\n     <span class="token keyword">def</span> <span class="token function">custom_show_toolbar</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>\n           <span class="token comment"># 路径为 /debug，即显示 silk 时候不需要显示 debug toolbar</span>\n           <span class="token keyword">from</span> debug_toolbar<span class="token punctuation">.</span>middleware <span class="token keyword">import</span> show_toolbar\n           <span class="token keyword">return</span> show_toolbar<span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token keyword">not</span> request<span class="token punctuation">.</span>path<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"/debug"</span><span class="token punctuation">)</span>\n\n     DEBUG_TOOLBAR_CONFIG <span class="token operator">=</span> <span class="token punctuation">{</span>\n        <span class="token string">\'SHOW_TOOLBAR_CALLBACK\'</span><span class="token punctuation">:</span> custom_show_toolbar<span class="token punctuation">,</span>\n     <span class="token punctuation">}</span>\n\n     DEBUG_TOOLBAR_PANELS <span class="token operator">=</span>  <span class="token punctuation">[</span>\n        <span class="token string">\'debug_toolbar.panels.history.HistoryPanel\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'debug_toolbar.panels.sql.SQLPanel\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'debug_toolbar_mongo.panel.MongoDebugPanel\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'debug_toolbar.panels.timer.TimerPanel\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'pympler.panels.MemoryPanel\'</span> <span class="token punctuation">,</span>\n        <span class="token string">\'pyflame.djdt.panel.FlamegraphPanel\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'debug_toolbar.panels.versions.VersionsPanel\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'debug_toolbar.panels.settings.SettingsPanel\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'debug_toolbar.panels.headers.HeadersPanel\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'debug_toolbar.panels.request.RequestPanel\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'debug_toolbar.panels.staticfiles.StaticFilesPanel\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'debug_toolbar.panels.templates.TemplatesPanel\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'debug_toolbar.panels.cache.CachePanel\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'debug_toolbar.panels.signals.SignalsPanel\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'debug_toolbar.panels.logging.LoggingPanel\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'debug_toolbar.panels.redirects.RedirectsPanel\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'debug_toolbar.panels.profiling.ProfilingPanel\'</span><span class="token punctuation">,</span>\n     <span class="token punctuation">]</span>\n\n     PYFLAME_CONFIG <span class="token operator">=</span> <span class="token punctuation">{</span>\n           <span class="token comment"># https://gitlab.com/living180/pyflame</span>\n           <span class="token comment"># 默认值 None 告诉 pyflame 使用环境变量 PATH 搜索 Flamegraph.pl</span>\n           <span class="token string">\'FLAMEGRAPH_SCRIPT_PATH\'</span><span class="token punctuation">:</span> <span class="token string">\'/root/third_party/flamegraph.pl\'</span><span class="token punctuation">,</span>\n     <span class="token punctuation">}</span>\n\n     <span class="token comment"># mongo toolbar 每个操作的最大显示数量</span>\n     DEBUG_TOOLBAR_MONGO_MAX_OPERATION_SIZE <span class="token operator">=</span> <span class="token number">20</span>\n\n<span class="token keyword">if</span> DEBUG <span class="token keyword">and</span> <span class="token string">\'django-silk\'</span> <span class="token keyword">in</span> DEBUG_TOOLS<span class="token punctuation">:</span>\n  MEDIA_ROOT <span class="token operator">=</span> <span class="token string">\'/tmp\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>修改中间件以便让 silk 测量每个接口的性能</p>\n<p>middleware.py</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9802684219322067000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class SilkProfileAllViewsMiddleware:\n     def __init__(self, get_response):\n        self.get_response = get_response\n\n     def __call__(self, request):\n        response = self.get_response(request)\n        return response\n\n     def process_view(self, request, view_func, view_args, view_kwargs):\n        from silk.profiling.profiler import silk_profile\n        return silk_profile(name=request.path)(view_func)(request, *view_args, **view_kwargs)`, `9802684219322067000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">SilkProfileAllViewsMiddleware</span><span class="token punctuation">:</span>\n     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> get_response<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>get_response <span class="token operator">=</span> get_response\n\n     <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        response <span class="token operator">=</span> self<span class="token punctuation">.</span>get_response<span class="token punctuation">(</span>request<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> response\n\n     <span class="token keyword">def</span> <span class="token function">process_view</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> view_func<span class="token punctuation">,</span> view_args<span class="token punctuation">,</span> view_kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">from</span> silk<span class="token punctuation">.</span>profiling<span class="token punctuation">.</span>profiler <span class="token keyword">import</span> silk_profile\n        <span class="token keyword">return</span> silk_profile<span class="token punctuation">(</span>name<span class="token operator">=</span>request<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">(</span>view_func<span class="token punctuation">)</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token operator">*</span>view_args<span class="token punctuation">,</span> <span class="token operator">**</span>view_kwargs<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>修改 urls.py，暴露调试地址</p>\n<p>urls.py</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36663928714265137000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if settings.DEBUG:\n  # https://github.com/jazzband/django-debug-toolbar/blob/3.1.1/docs/installation.rst\n  # https://github.com/jazzband/django-debug-toolbar/blob/3.1.1/docs/configuration.rst\n  if \'django-debug-toolbar\' in settings.DEBUG_TOOLS:\n     import debug_toolbar\n     urlpatterns += [\n           re_path(r\'^__debug__/\', include(debug_toolbar.urls)),\n     ]\n\n  # https://github.com/jazzband/django-silk/tree/4.2.0\n  if \'django-silk\' in settings.DEBUG_TOOLS:\n     urlpatterns += [\n           re_path(r\'^debug/\', include(\'silk.urls\', namespace=\'silk\'))\n     ]\nelse:\n  urlpatterns += [\n     re_path(r\'\', root_router)\n  ]`, `36663928714265137000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">if</span> settings<span class="token punctuation">.</span>DEBUG<span class="token punctuation">:</span>\n  <span class="token comment"># https://github.com/jazzband/django-debug-toolbar/blob/3.1.1/docs/installation.rst</span>\n  <span class="token comment"># https://github.com/jazzband/django-debug-toolbar/blob/3.1.1/docs/configuration.rst</span>\n  <span class="token keyword">if</span> <span class="token string">\'django-debug-toolbar\'</span> <span class="token keyword">in</span> settings<span class="token punctuation">.</span>DEBUG_TOOLS<span class="token punctuation">:</span>\n     <span class="token keyword">import</span> debug_toolbar\n     urlpatterns <span class="token operator">+=</span> <span class="token punctuation">[</span>\n           re_path<span class="token punctuation">(</span><span class="token string">r\'^__debug__/\'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span>debug_toolbar<span class="token punctuation">.</span>urls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n     <span class="token punctuation">]</span>\n\n  <span class="token comment"># https://github.com/jazzband/django-silk/tree/4.2.0</span>\n  <span class="token keyword">if</span> <span class="token string">\'django-silk\'</span> <span class="token keyword">in</span> settings<span class="token punctuation">.</span>DEBUG_TOOLS<span class="token punctuation">:</span>\n     urlpatterns <span class="token operator">+=</span> <span class="token punctuation">[</span>\n           re_path<span class="token punctuation">(</span><span class="token string">r\'^debug/\'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span><span class="token string">\'silk.urls\'</span><span class="token punctuation">,</span> namespace<span class="token operator">=</span><span class="token string">\'silk\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n     <span class="token punctuation">]</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n  urlpatterns <span class="token operator">+=</span> <span class="token punctuation">[</span>\n     re_path<span class="token punctuation">(</span><span class="token string">r\'\'</span><span class="token punctuation">,</span> root_router<span class="token punctuation">)</span>\n  <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<h4 id="vscode-debugger"><a href="#vscode-debugger" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>vscode debugger</h4>\n<ol>\n<li>\n<p>安装依赖库</p>\n<p>Dockerfile-local</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87282635815543010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RUN python3.6 -m pip install debugpy==1.5.1`, `87282635815543010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">RUN</span> python3.6 <span class="token punctuation">-</span>m pip install debugpy==1.5.1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n</li>\n<li>\n<p>首次启动时打开调试端口，local.json 及 setting.py 部分省略，不设置 <code class="language-text">DEBUG_PORT</code> 默认为 9999</p>\n<p>manage.py</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25639263075579420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from django.conf import settings\n\nif settings.DEBUG:\n  # 这里只在第一次启动，防止热重载中断 debug\n  if os.environ.get(&quot;RUN_MAIN&quot;) != &quot;true&quot;:\n     import debugpy\n\n     debugpy.listen((&quot;0.0.0.0&quot;, settings.DEBUG_PORT))\n     # debugpy.wait_for_client()\n     print(f&quot;Django debug started, port is {settings.DEBUG_PORT}&quot;)`, `25639263075579420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> django<span class="token punctuation">.</span>conf <span class="token keyword">import</span> settings\n\n<span class="token keyword">if</span> settings<span class="token punctuation">.</span>DEBUG<span class="token punctuation">:</span>\n  <span class="token comment"># 这里只在第一次启动，防止热重载中断 debug</span>\n  <span class="token keyword">if</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"RUN_MAIN"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">"true"</span><span class="token punctuation">:</span>\n     <span class="token keyword">import</span> debugpy\n\n     debugpy<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> settings<span class="token punctuation">.</span>DEBUG_PORT<span class="token punctuation">)</span><span class="token punctuation">)</span>\n     <span class="token comment"># debugpy.wait_for_client()</span>\n     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Django debug started, port is </span><span class="token interpolation"><span class="token punctuation">{</span>settings<span class="token punctuation">.</span>DEBUG_PORT<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>配置 vscode 调试面板</p>\n<p>.vscode/launch.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93544607563927220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;version&quot;: &quot;0.2.0&quot;,\n  &quot;configurations&quot;: [\n     {\n        &quot;name&quot;: &quot;Run Django (Docker)&quot;,\n        &quot;type&quot;: &quot;python&quot;,\n        &quot;request&quot;: &quot;attach&quot;,\n        &quot;pathMappings&quot;: [\n           {\n              &quot;localRoot&quot;: &quot;\\${workspaceFolder}/后端代码位置/entry&quot;,\n              &quot;remoteRoot&quot;: &quot;/root/entry&quot;\n           }\n        ],\n        &quot;port&quot;: 9999,\n        &quot;host&quot;: &quot;127.0.0.1&quot;\n     }\n  ]\n}`, `93544607563927220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"0.2.0"</span><span class="token punctuation">,</span>\n  <span class="token property">"configurations"</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n     <span class="token punctuation">{</span>\n        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Run Django (Docker)"</span><span class="token punctuation">,</span>\n        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"python"</span><span class="token punctuation">,</span>\n        <span class="token property">"request"</span><span class="token operator">:</span> <span class="token string">"attach"</span><span class="token punctuation">,</span>\n        <span class="token property">"pathMappings"</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n           <span class="token punctuation">{</span>\n              <span class="token property">"localRoot"</span><span class="token operator">:</span> <span class="token string">"${workspaceFolder}/后端代码位置/entry"</span><span class="token punctuation">,</span>\n              <span class="token property">"remoteRoot"</span><span class="token operator">:</span> <span class="token string">"/root/entry"</span>\n           <span class="token punctuation">}</span>\n        <span class="token punctuation">]</span><span class="token punctuation">,</span>\n        <span class="token property">"port"</span><span class="token operator">:</span> <span class="token number">9999</span><span class="token punctuation">,</span>\n        <span class="token property">"host"</span><span class="token operator">:</span> <span class="token string">"127.0.0.1"</span>\n     <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<h3 id="疑难点"><a href="#%E7%96%91%E9%9A%BE%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>疑难点</h3>\n<h4 id="django-debug-toolbar"><a href="#django-debug-toolbar" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>django-debug-toolbar</h4>\n<ol>\n<li>需要找到适配 Django 3.1 以及 python 3.6 版本的 django-debug-toolbar</li>\n<li>为了显示 Python 代码火焰图，需要合适的 pyflame 配置，需要在 docker 里面将 <a href="https://github.com/brendangregg/FlameGraph/blob/master/flamegraph.pl" target="_blank" rel="nofollow noreferrer noopener">flamegraph.pl</a> 暴露给 <code class="language-text">/root/third_party/flamegraph.pl</code> 这个路径，否则不能正常工作</li>\n<li>为了同时支持显示 mongodb 的 sql 显示，这个 <a href="https://github.com/hmarr/django-debug-toolbar-mongo/compare/master...towavephone:django-debug-toolbar-mongo:master" target="_blank" rel="nofollow noreferrer noopener">django-debug-toolbar-mongo</a> 需要兼容旧版本的 django</li>\n</ol>\n<h4 id="django-silk"><a href="#django-silk" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>django-silk</h4>\n<ol>\n<li>需要找到适配 Django 3.1 以及 python 3.6 版本的 django-silk</li>\n<li>挂载 tmp 目录以便让性能分析结果持久化</li>\n<li>编写中间件以便让每个接口都能进行性能分析</li>\n</ol>\n<h3 id="效果-1"><a href="#%E6%95%88%E6%9E%9C-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果</h3>\n<h4 id="django-debug-toolbar-1"><a href="#django-debug-toolbar-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>django-debug-toolbar</h4>\n<p>本地后端启动后，直接访问后端地址，即可看到以下常用功能：请求历史、请求涉及的 django orm sql 语句执行情况、请求涉及的 mongo sql 语句执行情况，执行时间分布、内存占用、内存调用栈</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-05-17-14-48-20-0adf0a5ebf3281c74f48215c11d0a066-68585.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 46.29225736095965%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAAA8klEQVQoz52NTUvDQBBA928IcZNWPBRs2NSbF3vxD/oLApqUInr0WPDkyepZEGujoc3OztrVQLr5app6KEUP5vFmmMtjSDS/Cz9G3+o+Sx+ydJxnj0X+9JepHpfl8+3Neadt9Z0uCcPX4P0ligLEmVI8jjFJVOVyvRc7xrEsy/zac/fofp85ZDJ5m06D2TwSKAEQQAix3pWIUqmvbeXnosiLq4tLetA+ZT2CNfAbQgCi2BaA62UydF2r1TrrHf/EG6SU1WwOWR87AOda66HnHVrmicMI/gdex/5gQCntHHUbxb5vmqZt2w1jwzCax9VnxtgKS8HFnboIPxoAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 05 17 14 48 20" title="" data-src="/static/2024-05-17-14-48-20-0adf0a5ebf3281c74f48215c11d0a066-fee1c.png" data-srcset="/static/2024-05-17-14-48-20-0adf0a5ebf3281c74f48215c11d0a066-a67b7.png 200w,\n/static/2024-05-17-14-48-20-0adf0a5ebf3281c74f48215c11d0a066-0b187.png 400w,\n/static/2024-05-17-14-48-20-0adf0a5ebf3281c74f48215c11d0a066-fee1c.png 800w,\n/static/2024-05-17-14-48-20-0adf0a5ebf3281c74f48215c11d0a066-b1a91.png 1200w,\n/static/2024-05-17-14-48-20-0adf0a5ebf3281c74f48215c11d0a066-95179.png 1600w,\n/static/2024-05-17-14-48-20-0adf0a5ebf3281c74f48215c11d0a066-68585.png 1834w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-05-17-14-54-57-7a03987c785c823c6bc2e0be7908e390-01d9c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 40.022296544035676%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABcUlEQVQoz52Qy07CQBSG+y6ICFourSxKDFoawYStG30Jg4Etr+CCp/ElUFFaEmiB1lAIvUADVBD4nZkFe1l8+WfOmfkyZzjLfIVJ2G3fsP1tstzv3hl0zerbJttj/8GSntvvvlGvPyGbFSAIPBKJU8iKDM6yDLjuGD9hgJCwWPhkb7MaXVOWyxl8bwLHsRm0t9ks0Wi8oFQqoFwuQlGucf/wCE5TNRjGAP3+ALpuoNfT8dVWMRia5KIHz/NZ0l6324NBzrVan7DtMXlhHckkD1EUwPMXKJTK4HRdh6qp0DQN7XYbnU4Hw+EAo9EIlmmS7zCJqAvLsojEZvT7BiaTCSqVZzJqAplMBpHICaR8AdxsNkMQBJjP54ekNd/3D9AaTc/zDqzXa1SrVaRSKUiSRIQR5G5uwbmui/8ynU6xWq2YMBqN4py8MhaL4UouHi8Mw5AJ6cjpdBpn8Tjyyt1xQsdxmLBWq7H/uxRFxIkwl5fxB6GQCAohws7rAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 05 17 14 54 57" title="" data-src="/static/2024-05-17-14-54-57-7a03987c785c823c6bc2e0be7908e390-fee1c.png" data-srcset="/static/2024-05-17-14-54-57-7a03987c785c823c6bc2e0be7908e390-a67b7.png 200w,\n/static/2024-05-17-14-54-57-7a03987c785c823c6bc2e0be7908e390-0b187.png 400w,\n/static/2024-05-17-14-54-57-7a03987c785c823c6bc2e0be7908e390-fee1c.png 800w,\n/static/2024-05-17-14-54-57-7a03987c785c823c6bc2e0be7908e390-01d9c.png 897w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-05-17-14-56-02-e5a7140eb7247d296af1a073d6767cfd-01d9c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 47.71460423634336%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAACRUlEQVQoz21RyW7aUBT1j1RKaISaqElQEhNV2SSkmQR400hVFlWj/kE+oVJ/pOqqw7qVWvUHUIAMDnMAgw3G4AFsjMuQ0/teRdVFF0dX7737znCvoKnf0VC+QaXa0X9ysHNb+4HZJE24xMMsw4GHLCGD2fQW/X4Jp6fHWF9fxcpKGEtLC4g934dQreWgNktoNIowTRWWpaHXa8K0NTiBhdF0gMFA57DMJr0pvMc0NSQSR1hdXcbykyUsLD7C7uExhLtcHmbPgmF0SdWFY/fh+QHuU5f4+vYdbj9+xojO48kU7ZaOSqWKUqkCm/rOz19je1vEzs4ziOIWpBcvIVxfX6FWr6HV0tBsNKBp5NA04RgGjHIZRvWe3PUxcAcYDofwPI/EDTiOg4uLC5wcnyAejyMW28fZqzcQKpUKZFkm1RIYeTqdRrfbxSgI4I/HCMYT4NeM8EBOR/CGHsZ0zwgZUTQaRVQUEQo9xt5hAkImm0GxWESZ3CiKgnsSaKoq/xAQgW518CH9Be/Tn1DTFdimhXa7Dcu2kUwmaSErNMenRBjC7kEcgnwnc4JOp0OxW1QNGroFl6L5Qx/OwIGs5XGr5mD2LXiuC13Xec+ccG1tjdeDE4m2XK0in89jHv365oY22fs7L1YnwQRTAhNgdwGNgyWQJAkbGxucMBwOI3aUhJBKpVAoFPhC6vU6j66TW9//85nB9VyO+ZmJMELmMBKJ8Dkywr1Dinx1leUOWQSb5sLAmucO/4d/CUVayNbWJhYXQ9iXzvAbmHSBNuk/AV0AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 05 17 14 56 02" title="" data-src="/static/2024-05-17-14-56-02-e5a7140eb7247d296af1a073d6767cfd-fee1c.png" data-srcset="/static/2024-05-17-14-56-02-e5a7140eb7247d296af1a073d6767cfd-a67b7.png 200w,\n/static/2024-05-17-14-56-02-e5a7140eb7247d296af1a073d6767cfd-0b187.png 400w,\n/static/2024-05-17-14-56-02-e5a7140eb7247d296af1a073d6767cfd-fee1c.png 800w,\n/static/2024-05-17-14-56-02-e5a7140eb7247d296af1a073d6767cfd-01d9c.png 897w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-05-17-14-56-44-069f0e53309c41e0954d5dd6ad629634-8afa6.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100.6674082313682%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAADoElEQVQ4y11Uy1LrRhT0t1zwQ1h+YLxIbliySVGV1c2fECCmKEiRVbLnV5LssssqyYVbXEhhDLItWZYs6+kX2HROjxCh4qoujcYzPX26zyjnOr/DMH6D8fALuur5K+LoD+D5I1bLv/C8+vt/+Ijl058ATPz8Uwu1mg5dL6FYXEOprCHXbl+h07lBEDjwvAHGY8JGFLkIQ0fBlznft1/heRbmswgnJy1sbBRQqWhC+A5arY7czc0/+Pz5Gvf3D6K0C6Pbk00B7u46eHgw0OsPMJnM5IAJojhFGMVYrZ7RarWwtvYOpVIRxUIehXINOdd1RNFYlIRIkgTD4RDeaATXcRDHMQLZnEynmMzmCokgjBPwd3Z2hmazie3tbTQaDdSbXyLneR5c10Xg+4o4iiI5faU28DmdTtDv90XlBI+PCyyXS1gDS1RGOD8/x+7uLr798AE7OzvY+fob5EZUI4Rdw5CSDQwGA3S7XdiidDabgQdyngfNFwshfYTpDOCOR6rkcrkswdRSUCFLJKktRLZtK8KrqytcXl7i06dLXF/fwDRNVf7T05NSaDsSjD/G4eEhNE1DvV5XxBu1JnL0jqDKkStqSW4PVfm+2JCB7/R4Pp9jYFny7ovCI2mZivKPhCV9EzkuDIJAqVR+ypOesVwqonecZ8lcR1BhlMSqZF3X8dX79ypprf5F6iFhSVmWnEy0222laCF+RVEIRxKnssWLh/1eD6YEc3BwIN7VReEm8vk8SpVGmrLnjZEpVW0jc1nikXj3FrG0TNvowLRM8fB7VKtVFUiBhNVm2oe+EMXiD43PyOgby42StAeDKFGI5Z1p83d0dKT8I/L5dWibL32YljNXRNOptMrYU4RMlCUSoRzK4Djmej8M8N3+fkq42UhLpkL6xwC4iGOzbyoPWXp6wFQRk4ztw47gWjfysCeEFUm52dxKCfU6+9BWhI9SBkm6cp95j29vb3FxcYHO/b3c8w56EgR7NFMYJCH2Dw/kw1DB1tYL4UbtTckCjtmDBDczTRLd3YliSZo2MCimzZ7c29tThLzPrx5yUeYTF7NMElMtkSQTFRZL5X9Z+pw7Pj5WfcibUigU0rbhgqzHSE6vCEvagoT0jw1OAhLRU46TaSJfmx9fCYvF4n83JWvYMIxUT7KRScgQJkJAQpJRJcdcz6/T6ekPipBJ63oZWnUrLZl+ENzAdza4/+Zzxv8ywkypPRri5PRUqVM3ZX0dRfnA/gvbnRwJ6ftU7AAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 05 17 14 56 44" title="" data-src="/static/2024-05-17-14-56-44-069f0e53309c41e0954d5dd6ad629634-fee1c.png" data-srcset="/static/2024-05-17-14-56-44-069f0e53309c41e0954d5dd6ad629634-a67b7.png 200w,\n/static/2024-05-17-14-56-44-069f0e53309c41e0954d5dd6ad629634-0b187.png 400w,\n/static/2024-05-17-14-56-44-069f0e53309c41e0954d5dd6ad629634-fee1c.png 800w,\n/static/2024-05-17-14-56-44-069f0e53309c41e0954d5dd6ad629634-8afa6.png 899w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-05-17-14-59-42-1eeb4ab95edd9c44c4dc51f728e4d06d-6cf8d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 104.77777777777777%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsSAAALEgHS3X78AAAD90lEQVQ4y42V3U+bVRzH+T82BYSuZvQVytAbk+2CK5dsXQe0OMlivHBR0BmXGDWLmYnGGa8wU5d4oe5NY3Q2YgI4zTKzMQkgMqAMaOnT9+ec0xYoJm769XtOyyTaCy++Oc3ze87n+Z7fy2lDyhpFPD6CdGoMf/05/b90749p3L9vYWDgCLxeF9ranGhq2o1QTwgNUqZgF5IQIoVSKUtlqmuRazmHYnIWJZnks1wtloFSafy+VUQ4fBRte51VYPNDONwbRoNSNl8Q0KuUhX8kqKKEiN2GzCUh+c52zLbzqGyuExiGw9FK4F4Cm3G4p187zGFb6t8q8iOLN6Bycf4umGfb7xZVAaFQiEf2ot3vR3PzIzh0NKKBWb6YRd21RODsKGTmbg24M55DMBhER0cH9u3rxMONjTikHSrJnFDyP2vaANXst5CpxRpwZzxrgE6nzmEbWlpaEew9poHcWEe6WMbhzUtQ6XnmM1d7vh3PGKDb5TbHbnU4EOwzQG6sJ2FBlVmE2xch12bpUDuzqh+iNLi3tweBQMDI6XyUDp/SQAv1xcqW8ij9+imUNcUqZ6rPanENHhwcRHd3Nw4efBJdjz2O48+d1MAk6kmKBNR6HvboOcjlWzy+Bq4RpHs2gY2NvGkbXRSPx4PGpib2oTnyGupKxA1QjA9DrvwMWViBsldNTNhxbFVsRCIR+Lw+uFyunUA6qSMpuHkzj/wX70Is/AS5egvSmmEu6ZDgCmOR/gg6OzvhcbsJZGNHntFAOqknQUfrbODrZ6Fi45CxH6ESPLrSDpdRqVSBgY4Aj+xmH2qHT2ugPkYdiWWoSg6FK29CTH8HuXSNubxOYJzAuwTmTA49Hi/8Pl8VGIpoIJ3Uk+B0bHAqxs5AzUdRuBmFmBsjcKUGzBqgjzCfz1udlCN9GsiNRstmlWLJSBU4HVtZFC68CvvGRagFupwbMR8SjG9VMujr62NT++D3a4cPcqhhS1UVV1DcsIxUmcXZZKt8/xrUzCXO9FXIma8JjBEYY1HSpspuFuRBUXSVpb3AluBo2YsQqUlkuSmrN09/CZWfRz56GuLyC7B/+BBi6iu2zgKBiwSmCAwT6KFLTxWoL4dSJYHyvSzKKCEzE8VEvwOTx5xIDwUgExNIR99C6swTEFdfh5y8QOAcgQvMoWWA5vpqb4djz57qbZP85gPMv3cSyXNvwDp7HL+caMFvg60Qp/0oZycQ/+hlxF9xwf78eYhrw7wbpwi8wxyumVnWRdEX7K5duznLBN658jYm3ulHbPhZxM+fwNT5FzH3yRCsy6dgrU4iOf4Z4u+/hFz0Y+ZxhOnROVxFuZzmf8oAurq6sP/AATOCQ5ztvwGd9SVBe/Z4VgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 05 17 14 59 42" title="" data-src="/static/2024-05-17-14-59-42-1eeb4ab95edd9c44c4dc51f728e4d06d-fee1c.png" data-srcset="/static/2024-05-17-14-59-42-1eeb4ab95edd9c44c4dc51f728e4d06d-a67b7.png 200w,\n/static/2024-05-17-14-59-42-1eeb4ab95edd9c44c4dc51f728e4d06d-0b187.png 400w,\n/static/2024-05-17-14-59-42-1eeb4ab95edd9c44c4dc51f728e4d06d-fee1c.png 800w,\n/static/2024-05-17-14-59-42-1eeb4ab95edd9c44c4dc51f728e4d06d-6cf8d.png 900w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h4 id="django-silk-1"><a href="#django-silk-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>django-silk</h4>\n<p>本地后端启动后，访问 <code class="language-text">后端地址 + /debug/</code>，即可看到以下常用功能：请求概况、请求耗时、调用栈可视化、清空数据库（此功能涉及到读写 local 环境的 pg 库，如无必要请勿开启）</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-05-17-15-02-21-4165c850d0ab69904b7b061565ed3a6f-25bb8.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 75.82116788321169%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAABzElEQVQ4y41T207CUBDkE0GNCUExMdFf8NGPJDVCoQUKtKW3c6G8rjtbSilU48NmN+ecne7MTnthGNLHxyfdP7zQaPROw+EbPT6+0mAwpn5/xPlZot9/uojRucbd3d34FM/Us9ZSUeSU59k5siwjpRQFQUCu69J2u6E4jmi/33OOJao6ojRNuL/gvlyiZ4yhw8G2wlqcHRg4pdlsJgA4x4fQrFQhWWtNZXkgDIXAGwE0RvGlkgfGVIEHeZ7SbrejMNzxtGsBxkRJEnMkXKdU9dd9qgbUN4EJAeS6M/KXHk2n3xQxxbIs+Y4Z2IpJ01PVJ8DLaB4AFBnT+v6CnC9HdMJ0ihk175v+3jWIANSZJ9B8rljL7WpJvrcgc9Kwkac9TAdgo2GWJUIb21wx7aXv0XYT8EKyK7o3GppODaMoosViznQ9yav1iqa8dSwGG71mdkHZdIxvzhbCIgDoOI7U8Cp8+k8Nm9pazqDGxq81zHk6+FOLLOY3yre2qX0Iq8RxSMG6AtS8ENim/d502aY9ITTEMvDrITwGmzPtvCjOdvpDQ93hRSOTgNbxeBSDTyYTsYtQ1jXl9rS/UsY5fscC/y3rVmuIGlvWYuxbyj+40E9YI6spbwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 05 17 15 02 21" title="" data-src="/static/2024-05-17-15-02-21-4165c850d0ab69904b7b061565ed3a6f-fee1c.png" data-srcset="/static/2024-05-17-15-02-21-4165c850d0ab69904b7b061565ed3a6f-a67b7.png 200w,\n/static/2024-05-17-15-02-21-4165c850d0ab69904b7b061565ed3a6f-0b187.png 400w,\n/static/2024-05-17-15-02-21-4165c850d0ab69904b7b061565ed3a6f-fee1c.png 800w,\n/static/2024-05-17-15-02-21-4165c850d0ab69904b7b061565ed3a6f-25bb8.png 1096w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-05-17-15-03-45-daa5e9860d381667bcf7fb0bd0615c92-85a77.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 24.094202898550723%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAAAwklEQVQY04XOywqCQBQG4HmwNkEXI4roYkUP1K5lr1YLJ1PLRsdMR2da/p0uBEHZ4oNz/sOBn62XK/RqHSy6U8ytCYb1PmaNAVqtMZrNapZlo922aR69MyZ9HyHf4bRzH0LOISgTUQwhop8iujsOh+vuEceS9mfOSqNhrldoYl60MdBa/6QKhUuaYrvZgFOBJEmQZRkM/TGlFFSef7pnFXJyOQkcPA/HIEB2PiN//bF/z98VKKillBIpNS3LkvbicbsBPYpVWYRoHggAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 05 17 15 03 45" title="" data-src="/static/2024-05-17-15-03-45-daa5e9860d381667bcf7fb0bd0615c92-fee1c.png" data-srcset="/static/2024-05-17-15-03-45-daa5e9860d381667bcf7fb0bd0615c92-a67b7.png 200w,\n/static/2024-05-17-15-03-45-daa5e9860d381667bcf7fb0bd0615c92-0b187.png 400w,\n/static/2024-05-17-15-03-45-daa5e9860d381667bcf7fb0bd0615c92-fee1c.png 800w,\n/static/2024-05-17-15-03-45-daa5e9860d381667bcf7fb0bd0615c92-85a77.png 1104w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-05-17-15-03-00-e45e1cf0aef8302008912357ef3a95e2-a5624.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 84.22131147540983%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAACZ0lEQVQ4y3VU246bQAzl/z+kj/2D9mnVp0pRErXa3DZAuATC/RICZDi1PcAmu9uRjjzxzBj7HDtGUWTIixzFEwqxYeDD9zycTjYsy8T57MO2LURRiKoqkOfP99kaZVlgAl9iqy8USNMESRwhtE3sdlt4FDxJEmRZ+iGBfH5j8Ff4kkYsQcqyFFRVibquKEAi2fGDqqrEP93RKMRKQMexsFgssFqvsFwusV6v4fs+LpeQEBAuso8iyjQMENJvLln2YShn0z6OYxhVleN6rSmTEk1zJdRib7cr+XWGnBH7uq4ldKNt0Y6W0fcd2rblkjNsNhu8bl5xcmwRIAgCKU2pO4ZBzRYYyA5iNfCwH3C/37UoJil4tCy4vgeLVHRcF83ths9rwNdL+3VAUtY1TXj7PcztFm/7HfaUsU0fsKwjtclJWoU5YtG0eJHsmbM4ft+zMAZzlZGyHNTcbBE4Di6Oi5QuJGksvcZtwpUwT33fj7ajjHqB9vXCr1GTIA3LTioG1BrXusb/12feAPVcctM0qLm34gT5JUJLacuTQQuglBJBJlGmgPpczXYOyCV/XBxEB7o/BWS19dldzt6D6sBMg+F5DjXzSmY1Yd5kWlLhjScky7JxPyEb/YlM1SOYbyMIzjgcDjDNI7XLSbqep8O2bfEdj2/yMZvm2XUdaiv26z8K7lc9JXpS+GMGdznXPqknE9BqdFRepwaaCJoCOrsR3zfqT4acP0wNg/0Gc/Go2kw08dQVCbyXnzh8/4b+Ws9ifTUpk4iGUv1I+Dv5dARF/ZXu/uL8+xfclx9Itn/081Gs6Y16EIXxDzhMGaPpeLzfAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 05 17 15 03 00" title="" data-src="/static/2024-05-17-15-03-00-e45e1cf0aef8302008912357ef3a95e2-fee1c.png" data-srcset="/static/2024-05-17-15-03-00-e45e1cf0aef8302008912357ef3a95e2-a67b7.png 200w,\n/static/2024-05-17-15-03-00-e45e1cf0aef8302008912357ef3a95e2-0b187.png 400w,\n/static/2024-05-17-15-03-00-e45e1cf0aef8302008912357ef3a95e2-fee1c.png 800w,\n/static/2024-05-17-15-03-00-e45e1cf0aef8302008912357ef3a95e2-a5624.png 976w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-05-17-15-04-41-883c55b6ac2367ad3e69554a66f027bb-5cc8c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 29.758011772400263%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABHklEQVQY02WRy26DMBBF+eU86CZpm00/Jat+SKSuYEF5pRISEAWCwLwxD916Js2i7eJoPLbvnRlb2+3esF4/43h8x+n0gdVqr/I97223r9hsXjjq+uHO04Hzv+j6HW0YBkg5oOs6tG2LaRpRlgJFkaOua0aqO8PPnaZpMM8zlmVRzAzlUkpGK8sSRFVVjBAl+r5Hnue4XhOORVHgdsuQpqk6Fywcx5GZponNG9UM+WgPowe0SQIhCkRRhCRJVAzhuh4sy1LRhWma8DwX5/MXgiBAFMdcjPS/DGk8MqSqtA7DEKkyjJWx5/mwbRuO48IwDLX+ZHPHceD7Zy5Omn8dEjRylmWILxfuMFYdeL7PBmRKMVLF6M1pGvoHelvSfgPFt6rw9cRuPQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 05 17 15 04 41" title="" data-src="/static/2024-05-17-15-04-41-883c55b6ac2367ad3e69554a66f027bb-fee1c.png" data-srcset="/static/2024-05-17-15-04-41-883c55b6ac2367ad3e69554a66f027bb-a67b7.png 200w,\n/static/2024-05-17-15-04-41-883c55b6ac2367ad3e69554a66f027bb-0b187.png 400w,\n/static/2024-05-17-15-04-41-883c55b6ac2367ad3e69554a66f027bb-fee1c.png 800w,\n/static/2024-05-17-15-04-41-883c55b6ac2367ad3e69554a66f027bb-b1a91.png 1200w,\n/static/2024-05-17-15-04-41-883c55b6ac2367ad3e69554a66f027bb-5cc8c.png 1529w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h4 id="vscode-debugger-1"><a href="#vscode-debugger-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>vscode debugger</h4>\n<p>启动 vscode 调试，鼠标设置断点后，访问某个接口即可触发调试过程</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2025-04-15-14-05-01-60b2ac02b5fc54da1a00ceba69325ec3-d6910.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 568px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 91.90140845070421%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAAsSAAALEgHS3X78AAABLElEQVQ4y8XTyW6DMBAGYN6kAi/BhKVKoHZsYwNCqUKwGiWVuhyqtuq573/sBKKox8Kl6Nec+BjZw3hKq41SSRwXRSGESJKEMRZFUcjCvsife/fe7T77PeSj3389uKe2edXKrlaUMU/U23j/FkfMGJtlt5QuMCYQhPAuy3bGHow51fVj0xyrCuqW88N6LZfxTYA8qUtRVkmaAgYAjBAKwYQyQmOEI4QZJEDRWDFZEkrhBUy8tqruSw3M99HIrgGPhvo7aAgZ8YsxByUlY8HwPfLnnPH36eja1oahj6fjTkon7tLFAk2RF7zRmisVIEJmYME5ZKq84LqutFLXCU3DnHP4t2Z3Pj8w5zkY2uZ5PrOz1lpK+R9nttaq2bcNO8xnz9k513Wd7wewyVPxD9dMsOJth/sWAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2025 04 15 14 05 01" title="" data-src="/static/2025-04-15-14-05-01-60b2ac02b5fc54da1a00ceba69325ec3-d6910.png" data-srcset="/static/2025-04-15-14-05-01-60b2ac02b5fc54da1a00ceba69325ec3-487ad.png 200w,\n/static/2025-04-15-14-05-01-60b2ac02b5fc54da1a00ceba69325ec3-1cefb.png 400w,\n/static/2025-04-15-14-05-01-60b2ac02b5fc54da1a00ceba69325ec3-d6910.png 568w" data-sizes="(max-width: 568px) 100vw, 568px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2025-04-15-14-10-27-cf012a36086343963aabad0e53f2b9f1-a36d1.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 604px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 20.52980132450331%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAA5UlEQVQY00WPyW6DQBBE+Q2zDfYYGGyG1ZhV2BDnlEQ55f8/5WVMouTwVN2lVqvKEsGeMFaEUcRR7kkSo0eJlAfiODSewLZtg/PHbvezO8Z37B2u6+J53oalpWQ6n6mUItI5w21kXTrWtef9beH1pWXsS+paU5ap0Yy2rbjUKef6Stp0qCRG+D5CCKwPFfOlNZ+ZRniC5JQydB1FnjGOA9drw3KfmMaWeZ5Y1huPx8LdeO0w0s93Lk1DYyiLHOtgKld5QWmeuq6DPEjSKEWFCq0zgiD4rePj+2Ljf/ZMMm9L97x78g33jXeZo2R9uQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2025 04 15 14 10 27" title="" data-src="/static/2025-04-15-14-10-27-cf012a36086343963aabad0e53f2b9f1-a36d1.png" data-srcset="/static/2025-04-15-14-10-27-cf012a36086343963aabad0e53f2b9f1-765e7.png 200w,\n/static/2025-04-15-14-10-27-cf012a36086343963aabad0e53f2b9f1-c9f48.png 400w,\n/static/2025-04-15-14-10-27-cf012a36086343963aabad0e53f2b9f1-a36d1.png 604w" data-sizes="(max-width: 604px) 100vw, 604px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2025-04-15-14-13-23-81b5fedc0528a80f14c9a2934f01655e-e4a77.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 60.4270462633452%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAAB7klEQVQoz41S7W7cIBD0a6S5j9g+MAaMDRjb50suqlL1/d9oOtDej1ZV2h+jBbTMzs5u5dOKYXBomhZ2GDDPc7lLKaCVhGgbCCGhrYOxFmEMCC7AGAtrh4LHue97VGm7wep8Meg6RaIOSvWFpGNMKSDNIwbb82OPZUzYlx1unAqRNqYI0NqQQ5Nw2bCEFXGc+cgEnSs6dFJBSIklBsxxJHlXVCfmLX6BJVkunFXlmNF1HaoQArz1SM5jcQZpoFISZQukUtivK+73Het+Y9sW67jgdb7C2QehpkpbomJ+5X1AHCJufsVbGPEeJ34aoFlNCIGJ7fhppEcWgh0kN+M1zFj5tnmCMZ8NCbNNVR6CNx43tv1tifi+zgjWFLLeKEyToQ0CbfOCy6UuCt/mHZGd/UQsMQuz/FfFGJFigusHElmqpcnZl07SswaTUzRdwWjJKSukiR6GpQzlMeW8HZad5KFV00Tv1g291mjaC1rKTsuKwEJPT19wPJ5wOBzx/Hwo8Xw+F5xOGaffkHMrR8LBRxg3oZU9ZG8xUnFPow+Hw18+HT9FNVBuXbf0RxRTM/K5rmucmPAn4ecgYW4tQyldiC6/SOu6KS1mlf+Fh8LrtuHj6wfu+5Urwn3idC33SXOJJSerO1HO/4KoX9C+nPAD0jxjZFiNl8cAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2025 04 15 14 13 23" title="" data-src="/static/2025-04-15-14-13-23-81b5fedc0528a80f14c9a2934f01655e-fee1c.png" data-srcset="/static/2025-04-15-14-13-23-81b5fedc0528a80f14c9a2934f01655e-a67b7.png 200w,\n/static/2025-04-15-14-13-23-81b5fedc0528a80f14c9a2934f01655e-0b187.png 400w,\n/static/2025-04-15-14-13-23-81b5fedc0528a80f14c9a2934f01655e-fee1c.png 800w,\n/static/2025-04-15-14-13-23-81b5fedc0528a80f14c9a2934f01655e-b1a91.png 1200w,\n/static/2025-04-15-14-13-23-81b5fedc0528a80f14c9a2934f01655e-e4a77.png 1405w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="flask"><a href="#flask" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>flask</h2>\n<p>针对 flask 框架同样需要上面的一套后端调试工具，由于这里使用的是最近几个版本（2024-05-17 15:12:42）的 flask（2.3.3），所以不需要考虑调试工具的版本，直接使用最新版本</p>\n<h3 id="实现-2"><a href="#%E5%AE%9E%E7%8E%B0-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现</h3>\n<ol>\n<li>\n<p>安装依赖</p>\n<p>requirements.txt</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6236831844559587000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`flask-debugtoolbar\nflask_profiler\nsqlalchemy`, `6236831844559587000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">flask<span class="token operator">-</span>debugtoolbar\nflask_profiler\nsqlalchemy</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>更新主入口文件</p>\n<p>app.py</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10713472115217670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import flask_profiler\n\nfrom flask_debugtoolbar import DebugToolbarExtension\n\nif app.debug:\n  app.config[\'SECRET_KEY\'] = \'123456\'\n  app.config[\'DEBUG_TB_TEMPLATE_EDITOR_ENABLED\'] = True\n\n  app.config[\'DEBUG_TB_PANELS\'] = (\n     \'flask_debugtoolbar.panels.versions.VersionDebugPanel\',\n     \'flask_debugtoolbar.panels.timer.TimerDebugPanel\',\n     \'flask_debugtoolbar.panels.headers.HeaderDebugPanel\',\n     \'flask_debugtoolbar.panels.request_vars.RequestVarsDebugPanel\',\n     \'flask_debugtoolbar.panels.config_vars.ConfigVarsDebugPanel\',\n     \'flask_debugtoolbar.panels.template.TemplateDebugPanel\',\n     \'flask_debugtoolbar.panels.sqlalchemy.SQLAlchemyDebugPanel\',\n     # \'flask_debugtoolbar.panels.logger.LoggingPanel\',\n     \'flask_debugtoolbar.panels.route_list.RouteListDebugPanel\',\n     \'flask_debugtoolbar.panels.profiler.ProfilerDebugPanel\',\n     \'flask_debugtoolbar.panels.g.GDebugPanel\'\n  )\n  # http://localhost:5001/\n  DebugToolbarExtension(app)\n  app.config[&quot;flask_profiler&quot;] = {\n     &quot;enabled&quot;: True,\n     &quot;storage&quot;: {\n           &quot;engine&quot;: &quot;sqlalchemy&quot;,\n           &quot;db_url&quot;: &quot;sqlite:///flask_profiler.sql&quot;\n     },\n     &quot;ignore&quot;: [\n           &quot;^/static/.*&quot;,\n           &quot;^/_debug_toolbar/.*&quot;\n     ]\n  }\n\n# http://localhost:5001/flask-profiler/\nif app.debug:\n  flask_profiler.init_app(app)`, `10713472115217670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> flask_profiler\n\n<span class="token keyword">from</span> flask_debugtoolbar <span class="token keyword">import</span> DebugToolbarExtension\n\n<span class="token keyword">if</span> app<span class="token punctuation">.</span>debug<span class="token punctuation">:</span>\n  app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">\'SECRET_KEY\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'123456\'</span>\n  app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">\'DEBUG_TB_TEMPLATE_EDITOR_ENABLED\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>\n\n  app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">\'DEBUG_TB_PANELS\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>\n     <span class="token string">\'flask_debugtoolbar.panels.versions.VersionDebugPanel\'</span><span class="token punctuation">,</span>\n     <span class="token string">\'flask_debugtoolbar.panels.timer.TimerDebugPanel\'</span><span class="token punctuation">,</span>\n     <span class="token string">\'flask_debugtoolbar.panels.headers.HeaderDebugPanel\'</span><span class="token punctuation">,</span>\n     <span class="token string">\'flask_debugtoolbar.panels.request_vars.RequestVarsDebugPanel\'</span><span class="token punctuation">,</span>\n     <span class="token string">\'flask_debugtoolbar.panels.config_vars.ConfigVarsDebugPanel\'</span><span class="token punctuation">,</span>\n     <span class="token string">\'flask_debugtoolbar.panels.template.TemplateDebugPanel\'</span><span class="token punctuation">,</span>\n     <span class="token string">\'flask_debugtoolbar.panels.sqlalchemy.SQLAlchemyDebugPanel\'</span><span class="token punctuation">,</span>\n     <span class="token comment"># \'flask_debugtoolbar.panels.logger.LoggingPanel\',</span>\n     <span class="token string">\'flask_debugtoolbar.panels.route_list.RouteListDebugPanel\'</span><span class="token punctuation">,</span>\n     <span class="token string">\'flask_debugtoolbar.panels.profiler.ProfilerDebugPanel\'</span><span class="token punctuation">,</span>\n     <span class="token string">\'flask_debugtoolbar.panels.g.GDebugPanel\'</span>\n  <span class="token punctuation">)</span>\n  <span class="token comment"># http://localhost:5001/</span>\n  DebugToolbarExtension<span class="token punctuation">(</span>app<span class="token punctuation">)</span>\n  app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">"flask_profiler"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n     <span class="token string">"enabled"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>\n     <span class="token string">"storage"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n           <span class="token string">"engine"</span><span class="token punctuation">:</span> <span class="token string">"sqlalchemy"</span><span class="token punctuation">,</span>\n           <span class="token string">"db_url"</span><span class="token punctuation">:</span> <span class="token string">"sqlite:///flask_profiler.sql"</span>\n     <span class="token punctuation">}</span><span class="token punctuation">,</span>\n     <span class="token string">"ignore"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n           <span class="token string">"^/static/.*"</span><span class="token punctuation">,</span>\n           <span class="token string">"^/_debug_toolbar/.*"</span>\n     <span class="token punctuation">]</span>\n  <span class="token punctuation">}</span>\n\n<span class="token comment"># http://localhost:5001/flask-profiler/</span>\n<span class="token keyword">if</span> app<span class="token punctuation">.</span>debug<span class="token punctuation">:</span>\n  flask_profiler<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<h3 id="疑难点-1"><a href="#%E7%96%91%E9%9A%BE%E7%82%B9-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>疑难点</h3>\n<h4 id="flask-debugtoolbar"><a href="#flask-debugtoolbar" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>flask-debugtoolbar</h4>\n<ol>\n<li>LoggingPanel 会影响控制台日志的打印，需要屏蔽掉</li>\n<li>这里没有 history，不能看到历史请求，待预研</li>\n</ol>\n<h4 id="flask_profiler"><a href="#flask_profiler" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>flask_profiler</h4>\n<ol>\n<li>需要正确配置 sqlalchemy</li>\n<li>忽略 flask-debugtoolbar 插件请求</li>\n</ol>\n<h3 id="效果-2"><a href="#%E6%95%88%E6%9E%9C-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果</h3>\n<h4 id="flask-debugtoolbar-1"><a href="#flask-debugtoolbar-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>flask-debugtoolbar</h4>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-05-17-15-21-50-b193cd3c53076915bb65408f5edef0cc-8ec0b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 43.02767227346717%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAAArUlEQVQoz53PTQ6CMBAF4J4E2AkNK1hZT2wLhIN4A6MumqgLiG2nPxpLKnIABV5eZvflZRDnB6NPzl6sPf8t6GMI97bdE7IjZIs4v3F+7XtpzEvr5+9KaUIIlLKyLIuiQEpKAOX9O8yI9368dV3neY4xRl3XOeeGYZiPq6rCU5AQwlq7EiulluKmaTZpirMMAYA2ZhFmjCVJ8sXiIcxCTCmNomhaVrACx3E8/vwBEHDcJR3mJ6AAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 05 17 15 21 50" title="" data-src="/static/2024-05-17-15-21-50-b193cd3c53076915bb65408f5edef0cc-fee1c.png" data-srcset="/static/2024-05-17-15-21-50-b193cd3c53076915bb65408f5edef0cc-a67b7.png 200w,\n/static/2024-05-17-15-21-50-b193cd3c53076915bb65408f5edef0cc-0b187.png 400w,\n/static/2024-05-17-15-21-50-b193cd3c53076915bb65408f5edef0cc-fee1c.png 800w,\n/static/2024-05-17-15-21-50-b193cd3c53076915bb65408f5edef0cc-b1a91.png 1200w,\n/static/2024-05-17-15-21-50-b193cd3c53076915bb65408f5edef0cc-95179.png 1600w,\n/static/2024-05-17-15-21-50-b193cd3c53076915bb65408f5edef0cc-8ec0b.png 1843w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h4 id="flask_profiler-1"><a href="#flask_profiler-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>flask_profiler</h4>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-05-17-15-23-36-98c7c312ff4ecf5d42905aec2000ca18-d49a9.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 63.22645290581163%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACKklEQVQ4y4VSTWsUQRCdX+HV/+BHPCiIIGt+QvDkaRVElISchBAPnvTu3QWNQhA8KJocInjyKgQPWTbuTnZmdrPz0TPTPdPT3c/qNrtu0I0Db6q7uqr61evyllc7aK2/RWttC1cfvMKdZztYefoR1x++xjXa33i0hct3O39h6V4HF9sd3Fx9g8cvPmFl8x0utF/COzgMcNCP8HM4cfDDBMNRBj9KZxiEJzb6Y/tBjO5ghB9dH4d+RDF2P4bHWA5RFqgER1VxyLoGjDkFozW0aggKumncnn6oK4GCMQheopESeV7CUzXHcHyMOE4o2EBTgaZRVIfW2riaNV0SJwmyjCFJUwhRgdwO069RmmIYvO2vDS492cP6t01kkkFJhTTLXJAtavGvb3rmUFIesU/SHN6tjWOcu7+LK+9b+Hz0xV2bZMksaeF3cmZ4Dh31oWxeSgyfbwucX9vB7b02+uURjNSYxBMXbG/VVr8zIHv7UMMuGpLHFayVxO73PnoTf1Ykz3MwapuXJRiJXhSF8xUWtLa+ks6yJEYe+mDjCKKqkNqWzZy0ml5utqbb3cPMaXVKBjOfZ2hCqt8aGkWsKLmhcfjfQ0gaDduBoBGzlnPuRomxDHb80qyAFyQDV8y2cpZWUykskyAIqKhAGIbOjqKI/DUVJIYf9nvEGeQQszYXYVo4I32VY8YcGWtrYu809CONqpYkMqcBltRWsxD23CZyYmXXU2sHXRBDq+EvPtjJwM2EQz8AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 05 17 15 23 36" title="" data-src="/static/2024-05-17-15-23-36-98c7c312ff4ecf5d42905aec2000ca18-fee1c.png" data-srcset="/static/2024-05-17-15-23-36-98c7c312ff4ecf5d42905aec2000ca18-a67b7.png 200w,\n/static/2024-05-17-15-23-36-98c7c312ff4ecf5d42905aec2000ca18-0b187.png 400w,\n/static/2024-05-17-15-23-36-98c7c312ff4ecf5d42905aec2000ca18-fee1c.png 800w,\n/static/2024-05-17-15-23-36-98c7c312ff4ecf5d42905aec2000ca18-d49a9.png 998w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-05-17-15-24-15-878d602076fd399c4e78577c96d7a964-3cc2a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 38.06047966631908%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABMklEQVQoz42Qz0rDQBDG95UEPXjsqZ68CeJdFLwoKHgsXnwIby1C9OJJEHwQ0Ytt1TaBJKYJcZvd7H7OTAqNPUiX/bF/5ttvZlZ1L+6wQ3TPA2weDdA5DdA5C3Bw/YS9q0c5b5/cUqyPLYr/4XiAjcM+di/v0bt5xn7vAeptOMX7V4LRJG2YMt/4iDKhObdj6VJLDIkx6UeTRHxUPsvh6hqAp+n+wS9X0frWGw8zn6MilHMeTE2mngJugV/gVnEOxhjSO1hr5Y6H1hpZNqMKs0QEaZqKaRt+3IYTVFUl2jlVE4YhiqKQPaO5wtcxt2wRx7FcclZOwEgFK6Z8V5alGEdRJLBxnudStXr5tPIXLFh3cHv871IV7dmM98ZYKICzNu1ZEq1D8+dOVn6rNbdc4YfWX5GrUNRPMq7iAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 05 17 15 24 15" title="" data-src="/static/2024-05-17-15-24-15-878d602076fd399c4e78577c96d7a964-fee1c.png" data-srcset="/static/2024-05-17-15-24-15-878d602076fd399c4e78577c96d7a964-a67b7.png 200w,\n/static/2024-05-17-15-24-15-878d602076fd399c4e78577c96d7a964-0b187.png 400w,\n/static/2024-05-17-15-24-15-878d602076fd399c4e78577c96d7a964-fee1c.png 800w,\n/static/2024-05-17-15-24-15-878d602076fd399c4e78577c96d7a964-3cc2a.png 959w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2024-05-17-15-25-17-a70eb4e92fa05d3859d671be27fa11ec-aa0f5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 61.754780652418454%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABT0lEQVQoz5WSy3KDMAxF+f+/a5aBEALEIQb8fsnYTtWm3bSZJtXIM1rozJWuXEEACCGlVEq5vRbldu8slda6HY7cCQduMUyDwSJEEE4xKyxY7TUz3ARrgzXB+Ohns+qgQ4Iq5tixfrWcyvnMyEVMs1qkU5izWTCpmi98ooKuhhlvldc+hi1tqF5teRslIepKPrFhGZGXTlpwZ3k5rN1qGWoig8CP+SsHHgW5FdJK7LiPp73BGmeWXrnoUs655N/LV8aYtm0XxSRoG93tP1Hh6/seebpShXqbRykTLSR46v8HPF2n3dvuUDfH6dSJgaHz0ccUv0/yJ0wI2Td13TUDOzesY07KoFNOuRS0E8/xcOEvmFJa7+tuPI2c1Gs7SHJW06QpusUcxwIHeQxHiEKJK5+FVpBw12CjDxug8nPDnHNSIxdlAAPJQtYhx/TSV30Hfi23XS5WhlQAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2024 05 17 15 25 17" title="" data-src="/static/2024-05-17-15-25-17-a70eb4e92fa05d3859d671be27fa11ec-fee1c.png" data-srcset="/static/2024-05-17-15-25-17-a70eb4e92fa05d3859d671be27fa11ec-a67b7.png 200w,\n/static/2024-05-17-15-25-17-a70eb4e92fa05d3859d671be27fa11ec-0b187.png 400w,\n/static/2024-05-17-15-25-17-a70eb4e92fa05d3859d671be27fa11ec-fee1c.png 800w,\n/static/2024-05-17-15-25-17-a70eb4e92fa05d3859d671be27fa11ec-aa0f5.png 889w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="实现历史请求"><a href="#%E5%AE%9E%E7%8E%B0%E5%8E%86%E5%8F%B2%E8%AF%B7%E6%B1%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现历史请求</h2>\n<h3 id="实现-3"><a href="#%E5%AE%9E%E7%8E%B0-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现</h3>\n<p><a href="https://github.com/towavephone/flask-debugger-demo" target="_blank" rel="nofollow noreferrer noopener">Flask 调试项目 Demo</a></p>\n<h3 id="疑难点-2"><a href="#%E7%96%91%E9%9A%BE%E7%82%B9-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>疑难点</h3>\n<ol>\n<li>接口并发高的情况下 flask_profiler 不可用，因为底层是 sqlite 不支持高并发写，可能要迁移到别的数据库，也可以屏蔽此插件</li>\n<li>flask-debugtoolbar 只能查看请求下的 mongodb 数据库访问记录，针对 sqlalchemy 的访问记录还需另外实现</li>\n</ol>\n<h3 id="效果-3"><a href="#%E6%95%88%E6%9E%9C-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2025-08-06-13-55-54-f63bf619476cd474f61870bf72f8f534-2bcbc.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 23.897659227000545%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAAAy0lEQVQY04WOwU7DMBBE8znEHJIzLf/MqQR+gAM3rhH0ggpR2rjpOkrSOn5sGooqVMFIT2t5xrOO8vyJ5fKZ1eoFcW84pWkU9/ovssshfPL4cMd8fstsdkNkrVBVW4pyy/tHxcY2rEtLUWwodZZrq0s62vag7L/nxHg/arG4J01TkiQhCmFQQ/CHvf7M6caBuq7puhaRHcPg9UngkiYPsiwjjuMj0aWgcw7vPSGEPxkzP4VXMebaTIXnoVEiQt/3nHun80m/C40xR74ArjxprX8MZ9wAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2025 08 06 13 55 54" title="" data-src="/static/2025-08-06-13-55-54-f63bf619476cd474f61870bf72f8f534-fee1c.png" data-srcset="/static/2025-08-06-13-55-54-f63bf619476cd474f61870bf72f8f534-a67b7.png 200w,\n/static/2025-08-06-13-55-54-f63bf619476cd474f61870bf72f8f534-0b187.png 400w,\n/static/2025-08-06-13-55-54-f63bf619476cd474f61870bf72f8f534-fee1c.png 800w,\n/static/2025-08-06-13-55-54-f63bf619476cd474f61870bf72f8f534-b1a91.png 1200w,\n/static/2025-08-06-13-55-54-f63bf619476cd474f61870bf72f8f534-95179.png 1600w,\n/static/2025-08-06-13-55-54-f63bf619476cd474f61870bf72f8f534-2bcbc.png 1837w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2025-08-06-13-56-19-13305695e13d33240b64d98f3a8145e6-f2644.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 19.793926247288503%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAAsklEQVQY03WOzQqCQBhFfRkFX8GtIPgCPnD7VlGLICsEx34kccbxJ52TWq2yC4ePu/gux9ptV2w/JMmax2OPkjGyPKBUjK5OVCN6AaWOdG3C+bQhDENc18XK84KikFyvOULcKMuK+71ASo3WHX0Pz6dZpOsGpqTphSiK8DwPi5+Y0UjN99v/Ycx7MMsEvu9j2zZW27Y0TTNT1/VopUc7Ofd+0ptejVlkGN6DQgiCIMBxHF7BMyO5gN8l/AAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2025 08 06 13 56 19" title="" data-src="/static/2025-08-06-13-56-19-13305695e13d33240b64d98f3a8145e6-fee1c.png" data-srcset="/static/2025-08-06-13-56-19-13305695e13d33240b64d98f3a8145e6-a67b7.png 200w,\n/static/2025-08-06-13-56-19-13305695e13d33240b64d98f3a8145e6-0b187.png 400w,\n/static/2025-08-06-13-56-19-13305695e13d33240b64d98f3a8145e6-fee1c.png 800w,\n/static/2025-08-06-13-56-19-13305695e13d33240b64d98f3a8145e6-b1a91.png 1200w,\n/static/2025-08-06-13-56-19-13305695e13d33240b64d98f3a8145e6-95179.png 1600w,\n/static/2025-08-06-13-56-19-13305695e13d33240b64d98f3a8145e6-f2644.png 1844w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>',
excerpt:"前端远程调试 背景 由于有些时候不方便到用户实地/远程桌面复现 bug，需要远程查看对方网页的控制台，经过预研发现远程调试工具  page-spy-web…",frontmatter:{date:"2025-04-17 18:49:44",path:"/frontend-backend-debug-tool/",tags:"前端, 后端, python, 预研",title:"前后端调试工具应用",draft:null}}},pathContext:{mainPostPath:"/distributed-services-practice-learn/",nextPostPath:"/python-search-by-syntax/",prePostPath:"/frontend-backend-debug-tool/"}}}});