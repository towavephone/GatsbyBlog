webpackJsonp([1482970639750],{1419:function(n,s){n.exports={data:{file:{childImageSharp:{sizes:{base64:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAACXBIWXMAAAsSAAALEgHS3X78AAAHlElEQVRIx12We2xT5xXAbcI2Vmn7o1I1uhVYRxL8tuPn9bXv0+/4/YgdOyYkkATCCEEYsqVNC2wCIYQWShmUBFh4hMAWECot0BUtlI4yAS1oKqJQXimsDBgTU8codnLO7r0uUPpJn87Rp+/8vvOdc75zr8xmZmTieI1NykU5yxOfxDncz3NUjAlyDXMjXGMhys+cG+FzGQ8VU4t7XuV8z8m+GUkrJclSqVReYJ0ZWQ8Tl2AdTPhnq9ns2QKd+crDZiHha8NsYCE21HZiXphpb3sxxTf99Tdsw51ldHqFaLOXXyzvYqOyZ0YPk5soylfouuUbvHOxh56JbiqJfi4/FnE1lxKetrGUZ954nbcdU/752ORpxWVsc6mZjPxctFtApeVtra1lmIPwTxClgeCqvGTsX/WWOEbtyTGWSoGbToOPzUHQ1QghVxOEhRniZ5U8XB4TzvTdgj1ZJdq2OOrkGhVRBnrYFum6TiK0l2fr0emMlVxcBhlnEniqDjlBuqg0CnD0MPWiDrwzhR4u+5B3x3WiLUNHJjxzZYvR8ZKTCP+Xo1JoM/nBYvSB1egHuyUIrCOBPj4LtD0KlD2K4h7SGip62aygxzaK9rHA3Aqt2vw0MRYjnyJtYaQdsXG9hgWFwgmVlXZUKUjUqmm0CgfwhA80Kgr1Wg40Sue4SuFEnZq+YjMbJ0kh0zmfemjQ0j2EJYh2a23RVOODIBvHmCsBUaoWLDoWKIsP50bTApxC5QwH1Ghp0Gk4MBk8aDLQEslooCc88VClsK+zGANI2mqLer0XFuea8PSuN+DM7o3QWyhAR7IBfj+vDbyOICS9aSjkZo8nvSlUKuxXLDUOKdN6LSl/AlRUE+vNAnD50l8XeTIEPiYEzXYG5mlNeGz7BvjPpY/g5snDcHxwE+zs7oCh1zvHCrNm48u/ML8j2muVQblBZ3t6ZY2KXKtQcDiwdk1xx9rV0BlqghEuD4fNUTy1Zwhw7Cbioxu461fdsOgFDa5pbh3zu6NifE9f+XCPlGHS5nuaFI3K8brJ4EUHES4WFiyEP2/dCPc2vYH/3NIHePcywP1LWLp3Ec4tWQa3FvbAu7294yqVA801rju5utYfiQyKDD4DnC8GWEhMafJPtBALxuHjo3+C8bufIn59DfHBFcDiDcQvzyF+/iEsbWuDadNMaDW5H7nY6Iyyh165zfLNtdUqIqLTsEJSQqBVUTD1JQPqdRT8sf9NuH7kMHy0fRg+O3EUzp96H/Zs2SBklxFKxwFmowtdTCIoPQx7oKLzl32PPTRPVSudDwQgCrUGL0+twdzsDjjSdwD2J1fh/q7N0N+1EtykB178qVY4lAahRktWkw95JrG4DAxPvHU3Wwb+rlcsHfK0WNxCoMdUCgdUaxnMBPKw7dVe2LyhDw4MboORA4NQOd2CaiUFaqWjZJGAyQGRUeubP8FqElqZspquEBeUM2zrnEQUa3R8USVcp2qGDZV6ErqXL4PfrlwFhSU9cPL4MejfshOsZq90sCg5KvHZ5MnPfa+cmFrxukRFuRZNcYqIoNngHheeFmiF11ClIDBdPwfqG9qhc1E3rF25GnrX90M204JqBfWItPrP8lTqa7vFpSw3GJ9cZjI4pW5TXaWezpKxh4Q5gEY9LwApVOtZMApxVWhd2DKvC7K5FjTUsFCj45Ah4yXaHuz1MBlgyHCb1HXISIXMTcekOJqN1h/72Mx92h5DwuwHjeChWseBQsNgJJ6H944eB5oNgaLajnaL/07E24wuKr7Cz+XuuenUsMioCxYmyHhnSPLQTYVVYVfjI46Mo80WBLMgLY4E1FhCOENBAsfHQG/0juuNPqGguU8ywXas5XNbg6783wJ8w781GtUPJc+irkap/Ufdje0JXytStnDJbA2D1Z4EKxEHsyUMRmsIdcZaNFpCYBYqwWQLPhD3Btn6t2Pe5uF0cD7Sdr/xmSab8racFaDooOvuk0wDEs40EFQGbVQGbEKXJoTPgZ3JoJGIgULvR6M1jE67rzvpae5ojC7GEJ9rfgILc7lC3NV0T6flTtjoPLK+VuD8rcD65gDtaQInPxOtzoxQRrXgD8/BdW/+YezYByfxvfdHvnxl+ZLKCDfzUMIze60Ey+brJukrqcjA1u3tBw8dfZiZuRQFaNFory/WEPUlE5kFK5WDQKRtbFPfUOnChUvFL27cwKuj/8CBHXv2iQw/k/KGuNwyCYiIkhw+sO/569eu7b1+ffR/H5z4BAcG38X1m/biyjX9ODR8GC9dHsXLV0fx5KlzePDIyFd7ht9ZJZhJrcvLhV/wMuUPljQWtC6Z+FjfuWPHlPMXLq64Onpz3d8/Pf9WX//OW2vWbITBof3n3tqya9fbh/7SvW1gZ9Xj/V1dr8kf614qIZONjBwrezi8Ty54K5d9ZzTmF+xe1LnioaD+4Nvrn4/ermif3yHp8UCDLMCky7Z+n192+/YdST9z5mPZ7t1D8ouXv6gQ4S9WTplks7mut8xZijxbKz2vvi2D39/cPyB/HC5xOm2czPvd35F8rkGCS0+I4WXV1QbJaMq06XqbNXCQJIILpH8hOic3GghZMpl62qG/Nf4PRzaQ862MzO4AAAAASUVORK5CYII=",aspectRatio:.6666666666666666,src:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-25c91.png",srcSet:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-8a97b.png 200w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-0fdf3.png 400w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-25c91.png 600w",srcWebp:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-216f6.webp",srcSetWebp:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-5d70e.webp 200w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-d1677.webp 400w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-216f6.webp 600w",sizes:"(max-width: 600px) 100vw, 600px"}}},site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}},mainPost:{html:'<p>会话发起协议（SIP）是 VoIP 技术中最常用的协议之一。它是一种应用层协议，与其他应用层协议协同工作，通过 Internet 控制多媒体通信会话。</p>\n<h1 id="概述"><a href="#%E6%A6%82%E8%BF%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>概述</h1>\n<ul>\n<li>SIP 是用于通过因特网协议创建，修改和终止多媒体会话的信令协议。会话只不过是两个端点之间的简单调用。端点可以是智能电话，笔记本电脑或可以通过因特网接收和发送多媒体内容的任何设备。</li>\n<li>SIP 是由 IETF（Internet Engineering Task Force） 标准定义的应用层协议。它在 RFC 3261 中定义。</li>\n<li>SIP 体现了客户端 - 服务器体系结构，以及使用 HTTP 和 URL 的 URL 和 URI 以及 SMTP 的文本编码方案和头样式。</li>\n<li>SIP 采用 SDP（会话描述协议） 的帮助，它描述了用于通过 IP 网络传送语音和视频的会话和 RTP（实时传输协议）。</li>\n<li>SIP 可用于双方（单播）或多方（多播）会话。</li>\n<li>其他 SIP 应用包括文件传输，即时通讯，视频会议，网络游戏，以及流多媒体分发。</li>\n</ul>\n<p>下图说明了 SIP 在一般方案中的适用性：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-06-10-11-59-57-514e7696b1300e07d312f20f411c5d24-ae33f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 391px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 138.3631713554987%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAIAAADuuAg3AAAACXBIWXMAAAsSAAALEgHS3X78AAAD1ElEQVQ4y02VWS+kURCGv98gbkhc2GMLiQSJ3+BO3BIJ3bR1dNO2Qbdd26fHlpluS+y7MZZphLYNZkxCuHYj3EgkfsA83yndM+/FSXWdqvetqnO+09rz87PD4WhtbbXb7Tabzb+KIXZLS0tzc7Pdh/b29qamJo/Hoy0vLwcGBoaEhKSlpSUlJcXGxqampsbHx0dHR6ekpCQmJsbFxWHjiYmJYTchISE0NDQgICAzM1NbWVlhOzk5uaSkBMqamprCwsLS0lKz2VxeXm61WsvKyjIyMvCwVVdXZzKZ0tPT4crJydGWlpaCgoIiIyMjIiJwQRQeHh4VFSUe1rCwMDyII4s4sviDg4OzsrI0ekZQemtSwG5sbGT9qCDd2nyQEVDC7u6u9vj46Ha7vyq4XC7Wqamp2dnZ+fn58fHxsbGxLwouBX/Y6Ojo0dGRtr+/bzAY6PCDAp0jC93AwACaTqdzeHgYis7OznIFYioqKoqLi9HXTk5OGAm/8ZoVqqurqc2q0KoAC3XKrmjA0tfXpx0fHxuNRjnAoqIivAxWRKgCBaFmyHjghQg6PEzqPbmtra2jo4M9WElg5cCIIBM1Dgkn+Q0NDYR1dXVZLBZS9GQECwoK6BzDpEAmNqT4Mfjp9xsUMLq7u9+VaQlZ6NFBUFYp3qKAp7KyEqO2tra+vp7WKEFPhonrDZP0yQYiQpSfn09OVVWVUQGbyP7+fjx0ridTgwwQ0CTJZMoqI4QROmx25bTYguU9uVSBCOkcyITomd3/uaQ0jH/JPT09nBuVs8E2CqTJUVEh1VI/P7me1Mz9Yf76tA8PD7Ozs80+UJXQSwlwQeSvSC4SXPzkXmhPT09c3U//wakwNDSEAjrYnxUw/DGDg4Ner1d7fX3d3t7+7sPm5ibrxsYG6+rq6traGsY3H7C3traIX19fv7u70w4ODnJzc6mTzvkkkOLe8RlwjHye3H5+0h5ri4LMkrK5pxrqdMK5c/okO3wgXz5gLiPJTBQPyYRxo/hment79U8yLy9PThhWvMycIFbUYEGfNH5yBZmcf4S6Mi/JxMSEW4EPnQdAHoPFxcWZmZnJycm5uTneOX5i8wwQJo8EZ6y9vb39Vri+vr65ufmjIJ6fChi/FAiQLYzLy8uHhweNBF4jngSelenpaYbJVH8o7OzsMHYMxru3t0cYtlcBWf3dvr+/J+3q6goyxkO3IyMjrPTJOXO2lI0tfwwLCwuUQDnE62/Y7e0tfGdnZyKOAofnUcDg/uFBmRLwoHl6ekokq6788vKCdaZwfn4Oq6xi+O2LiwvxSCRlU/JfMSqBLu9O3AUAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 06 10 11 59 57" title="" data-src="/static/2019-06-10-11-59-57-514e7696b1300e07d312f20f411c5d24-ae33f.png" data-srcset="/static/2019-06-10-11-59-57-514e7696b1300e07d312f20f411c5d24-12493.png 200w,\n/static/2019-06-10-11-59-57-514e7696b1300e07d312f20f411c5d24-ae33f.png 391w" data-sizes="(max-width: 391px) 100vw, 391px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>通常，SIP 协议用于两个或多个端点之间的互联网电话和多媒体分发。例如，一个人可以使用 SIP 发起对另一个人的电话呼叫，或者有人可以与许多参与者建立电话会议。</p>\n<p>SIP 协议的设计非常简单，配置有限的命令。它也是基于文本的，所以任何人都可以读取 SIP 会话中的端点之间传递的 SIP 消息。</p>\n<p>有一些实体帮助 SIP 创建其网络。在 SIP 中，每个网元由 SIP URI（统一资源标识符） 来标识，它像一个地址。以下是网络元素：</p>\n<ul>\n<li>用户代理</li>\n<li>代理服务器</li>\n<li>注册服务器</li>\n<li>重定向服务器</li>\n<li>位置服务器</li>\n</ul>\n<h2 id="用户代理"><a href="#%E7%94%A8%E6%88%B7%E4%BB%A3%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>用户代理</h2>\n<p>它是 SIP 网络的端点和最重要的网络元素之一。端点可以启动，修改或终止会话。用户代理是 SIP 网络中最智能的设备或网络元件。它可以是软电话，手机或笔记本电脑。</p>\n<p>用户代理在逻辑上分为两部分：</p>\n<ul>\n<li>用户代理客户端（UAC） - 发送请求并接收响应的实体。</li>\n<li>用户代理服务器（UAS） - 接收请求并发送响应的实体。</li>\n</ul>\n<p>SIP 基于客户机 - 服务器架构，其中呼叫者的电话充当发起呼叫的客户端，被叫方的电话充当响应呼叫的服务器。</p>\n<h2 id="代理服务器"><a href="#%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>代理服务器</h2>\n<p>网络元素接收来自用户代理的请求并将其转发给另一个用户。</p>\n<ul>\n<li>基本上代理服务器的作用就像一个路由器。</li>\n<li>它有一些智慧来了解 SIP 请求，并在 URI 的帮助下发送它。</li>\n<li>代理服务器位于两个用户代理之间。</li>\n<li>源和目的地之间最多可以有 70 个代理服务器。</li>\n</ul>\n<p>有两种类型的代理服务器：</p>\n<ul>\n<li>无状态代理服务器 - 它只是转发收到的消息。这种类型的服务器不存储任何呼叫或交易的信息。</li>\n<li>有状态代理服务器 - 这种类型的代理服务器可以跟踪收到的每个请求和响应，并且如果需要，可以将来使用它。如果对方没有响应，它可以重新发送请求。</li>\n</ul>\n<h2 id="注册服务器"><a href="#%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>注册服务器</h2>\n<p>注册服务器接受用户代理的注册请求。它可以帮助用户在网络中进行身份验证。它将 URI 和用户的位置存储在数据库中，以帮助同一域内的其他 SIP 服务器。</p>\n<p>看看下面的示例，显示 SIP 注册的过程：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-06-10-14-04-44-91eda7151b50ca646842814cf1b14b11-16a51.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 324px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 62.96296296296296%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABo0lEQVQoz5VSW3OaUBDm/7/4H9InX9q0zUMzEy6lIBqIXI8F5Zo2oHNUxhF7rKMkX+IIJm0fug/L7rf77e3A/bjPNFVjbPv4/8LdGQZ/I6RZxhj7a0Zd19BJGMiy4ti2rt+KgqzfDuaLFcff8B4ZOZZF6aJJhXr5trJljNL5HEmLRV5MKaW/2G9us9kURYHw4ST1iVe/yDm4rqplWTY9ONQghDSpMOIovPp89VWUJFEk34PzUJ7nk8nk2OmZvF6vO52OruuWZQ1N07asXk+9/nLN87wkSYqiAjdNczgcOo4DMAzDtnNZlqqq7na77UlgHzDs/rDf7xsc54SbZVkURS15uVye++fbvkGgsWOSJK86G4axWq1wRhSCO6ezi3cXHy/ff7j8hMMCAY5oVVXI9H2/JYMmCAIgnM3zvKPGng7e1LZhjwg5gnEcd7td13Xbg6FkEARvxv7XrzKdTl8djD2/PoV1n6WmZWKENE3DcBxFiR8EcRw9FMV47P98yJGDTrPZrCU3FvHcb4o86PexqyyLPW0gCKLW11ziqYrseqM/p3sCoy7NG/C5ws4AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 06 10 14 04 44" title="" data-src="/static/2019-06-10-14-04-44-91eda7151b50ca646842814cf1b14b11-16a51.png" data-srcset="/static/2019-06-10-14-04-44-91eda7151b50ca646842814cf1b14b11-6752f.png 200w,\n/static/2019-06-10-14-04-44-91eda7151b50ca646842814cf1b14b11-16a51.png 324w" data-sizes="(max-width: 324px) 100vw, 324px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这里呼叫者想要向 TMC 域注册。因此，它向 TMC 的 Registrar 服务器发送 REGISTER 请求，并且服务器在授权客户端时返回 200 OK 响应。</p>\n<h2 id="重定向服务器"><a href="#%E9%87%8D%E5%AE%9A%E5%90%91%E6%9C%8D%E5%8A%A1%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>重定向服务器</h2>\n<p>重定向服务器接收请求，并在注册器创建的位置数据库中查找请求的预期收件人。</p>\n<p>重定向服务器使用数据库获取位置信息，并以 3xx（重定向响应） 响应给用户。我们将在本教程的后面讨论响应代码。</p>\n<h2 id="位置服务器"><a href="#%E4%BD%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>位置服务器</h2>\n<p>位置服务器提供有关呼叫者可能的位置到重定向和代理服务器的信息。</p>\n<p>只有代理服务器或重定向服务器可以联系位置服务器。</p>\n<p>下图描绘了每个网络元素在建立会话中所扮演的角色：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-06-10-14-06-20-13440bdd0d351c261f85053275b31948-28759.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 500px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 63.6%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB20lEQVQoz4VSz2/TMBTO37sTNw5oQhwQ4gKckLjsgpC4DgmBEAfQmBgrLVvXrmu6po27JG1+2E4cx3bsJDjJGrYdxpMd+f343vf0vRjVvcYgxDNTYFyWpWpMP7qsUZVloY++VRNtcs7aA44jOU/X3vz4yB8NsxUArjM1TcZZU1U24M5qeBOT4vNg8v7XRCW4FCKMY5qmJct6F/Mv/THlQtfkShVlZUQbZ//wdP8ESMErpRiCaHRqL+Zg7bKV7f/pR+cjOL0QNN0EAZjPfM9zIUYZZ1IaL188f/Tm7c6rPQQWm4WFA19zF3kuKNW984wmV4Aj2A4nwNId9PwwbCc3Hu7uPnv65NunD9q3Bv21vayrpAwj5IZxdUOeJpwTHPGMXgtmef5gtjQDgvQclCoh6q6FihLmYJ5Lpb2apekSQHRwcna5cq7BXBX6QMpZLju1cxjlKOrcql1EShxw9fF4eGaBNmT8y3Wa67KlRVa2YEylpI4pqdnpbEKARQiiJN7u+Qa6pUmoeH2AH3wV339OK9vMRE4pFVzI4rYAt/a8XT2M6eN3w529cc/caFdvZRHFK5h4mMii+A/Ycd3e0Y/z4W9zOtmKLHGclHeJ74CbL8zEZZSO/cRG9P4//y+u7uAR2J+vYAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 06 10 14 06 20" title="" data-src="/static/2019-06-10-14-06-20-13440bdd0d351c261f85053275b31948-28759.png" data-srcset="/static/2019-06-10-14-06-20-13440bdd0d351c261f85053275b31948-6ac48.png 200w,\n/static/2019-06-10-14-06-20-13440bdd0d351c261f85053275b31948-4b8bf.png 400w,\n/static/2019-06-10-14-06-20-13440bdd0d351c261f85053275b31948-28759.png 500w" data-sizes="(max-width: 500px) 100vw, 500px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="系统架构"><a href="#%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>系统架构</h1>\n<p>SIP 被构造为分层协议，这意味着其行为根据一组相当独立的处理阶段来描述，只有每个阶段之间的松散耦合。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-06-10-19-31-14-5e7501d7e92f7c43e4dca4328bd0686b-b50a0.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 202px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 216.83168316831686%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAArCAIAAAD3xz8iAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAFw0lEQVRIx32Wh1NaWRSH+Xt3ZyeWKCoaTbKr0bHEhgiPIogFEESKBQSlCPJAMJb0mbRJZtJ7V/d7XPYF0eyZ4XHfu+fc037nnKs5OTl58eJFIBCYm52TJGlqasrn84ZCoWCZ+B4Mhfx+v9M5bTSapqenPR7PgwcPkDo+PtbcunVrZGRkYWHBYJjw+nz+xcVgMORfWlpaXHS53J6FBZbhUGDaOcPT7XHPu1z68fHNzU3kNRaLxev13rlzRzJLlzvb/vrzj/bOq3X1jU2Njd3Xepu1zS2tbQb9WEtbW1NDHS+R2Ob2dra7u1sRfvz48fDwsMPhCIfDmUxmu0wsstksC+WZy4kFtLq6Ojc3NzAwUCwWFWF+nz9/TiQS+DM5OTk2NoYtMzMzOLK4uOjz+ebn5202m16vNxgM6FheXn716lXFZ34n/9GnT5/evHlz+/btUqlEqAYHBzc2NlB7eHj4/Pnzjx8/Hh0dCU4hpREvfFVPEQtOSafT6qtKqvwv4bPb5C8SibD4+fNntUA1aVRtMAklqmYCUaNZ5akIH5VJvHz//v3Zs2dggBRkMxnJZNrd3SWLDx8+fPToET5Xa6po/vbt28HBAeElzkaTkcCOjo6azRbblM1qtY6DCb2egywWM2EnEO/evatEG/PIkHFy0u32xOIbe3t7+/t7h4cHLPJyfqdYPDw4LBQKO8WdXC4HsHxeL1lgV9FM6kjmzZs3R0eGenr+btU26Tq6Ll5sudzZ2dHZ1drW1tHRYZKkznZdW3tne7uur78fBF2/fh10aIgK2Caf6+uRYNDvsNsdjukJg9FqtTlnZmyK4dZAYMlRXlms9nnX/JTdDqIqPsuyDHpw2O12g41UMlko5Atlysm5vCwnk8mVlVWvd8HlcplMJqrty5cvirAaeuIJE+hzOp0owbErV65SpByKa1Ql1u3v7xPdUwirwYDYuH//fjQaFfk7C7JT8FSzp24IQ9Sj1d1zECaYxLbgACc1woLhFMLUjRqzcQ/YfPjw4e3btwJP55h9XCZWAHNra4taJ54myWQ0GsfHx4kcSWZtNpvpR8T//fv3qjmKZoqbHExMTBBnKmlzcyORTNBMcjlZ6SrZDMAi1IFgkCOA4/r6uoi5BqCSFZpGNpsJLAXCy8sr5HR1dW1tjT/a59KSPxJVKB6Lx2OxzUQCvIATRRgmGmCxWErE13v7enU63YUL9T3XuhsaG5qatS2tLaPDQyNjo/X1jY11dXxwe/2Af8JgIB1KA+zv74/H4/m8vJXZQgO6I2trC14vSIpGorFYjDauGBUOoTsny5gJIn/8+KH4TD0qMZIkmJKplOKtLO/s7BAeOZ+nmMAvH1OpFDjDZ4AtemAFngSAusd+9ogweGR0EB4KGFZeRcCJBchTM6qp6X4i+Hfv3r1x44ap3EkYKQiobUSInYLnWfTxSnpwrFqmumf9tnvC9/XrV3LGU8jU1MZvhQURBTysLsD/E67uvhAG15h9TuutmQPiCBQ+efKE5DFoAIIYNNUj5VfAxIoCIpnlQW1g3JEYSTLZaWnTDhYUCTWDLS9fvlTlNcIY6oFeTW5BD6hw2MxN2tZrfX2tWm1zU0tv/0A6vSU6FOfS6tBU0QwMaFR0c5DEEGYRja5ZzJLdOev1uCWTec7lBl4ULOfCwNDFEOpcwycgxbCmB1N6iTLxXyoVr3ZdstqdjFt4kpXvCgFbDAR2GnotkMZb9ug7PNOpNJcCObc9ONBndTgBObYo8mWCAc+xsaenR/P06VPqGauoeyEfWVudslqoqnB4GfdANR2bK46wCzX5fJ6JgQuKzwweriXwsVcq7a6shHTa+n+6e3Udl7TaFq4yXR26Cw0XC2UTaEZDQ0OiK1eq6vXr15SbMhNJyexcsHwP41pFIwmFwryROaYnpULDYuL+qio16dxJGM4cT7ZnZ2dFMZJet8eDn/fu3SPC59xJzhbm76i6qv4FndI1TKRREB4AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 06 10 19 31 14" title="" data-src="/static/2019-06-10-19-31-14-5e7501d7e92f7c43e4dca4328bd0686b-b50a0.png" data-srcset="/static/2019-06-10-19-31-14-5e7501d7e92f7c43e4dca4328bd0686b-0e5e0.png 200w,\n/static/2019-06-10-19-31-14-5e7501d7e92f7c43e4dca4328bd0686b-b50a0.png 202w" data-sizes="(max-width: 202px) 100vw, 202px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<ul>\n<li>SIP 的最低层是其语法和编码。其编码使用增强的 Backus-Naur 表格语法（BNF）来指定。</li>\n<li>第二层是传输层。它定义客户端如何发送请求并接收响应，以及服务器如何接收请求并通过网络发送响应，所有 SIP 元素都包含传输层。</li>\n<li>接下来是事务层。事务是由客户端事务（使用传输层）发送到服务器事务的请求，以及从服务器事务发送回客户端的对该请求的所有响应。用户代理客户端（UAC）完成的任何任务都将使用一系列事务进行。无状态代理不包含事务层。</li>\n<li>事务层上面的层称为事务用户。除了无状态代理之外，每个 SIP 实体都是一个事务用户。</li>\n</ul>\n<p>下图显示了 SIP 会话的基本呼叫流程：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-06-10-19-32-44-f8ef215a624bdd21f854652eb7df10f3-81a6c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 600px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 61.33333333333334%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABYUlEQVQoz22RzY6CUAyFff+XGnfqYkxcCEEJIKCCClwE5Z+ZT2pEJ9NFU3rPOT0tk6IofoaguN1ufd8fg2OSJHSu12tVVV3X5XlOQed+v7/jJ3xTgYAZx/HhcFgsFqvVKgiC/X5PZ7n8nk6/5vMZWmEYIlSWpQiN5DRNgZIdx/E873w+K6VAW5blui5aIHltmobMJJWqiTwDzbIMt/B1XV+vNfhpqqIo2m63u90O2wyERgbJsIdt5CFghgc8kzVNE7Tv++BkQ9CcAybz67qmk+XZaFsmo0JGkU9js7lcLkJgDnIYlDF1XZ1O4QeZaNsWYYZAMwzDNE3WY0+YPOFRxv5zMLkKEmRODVMsSKBCkwz4g4wqfqgxiUPkOZXvP6ByKoImtilQxAuAcTK/kTcQsh6jOLtt2yInTdyBRxEKw55klkSMGgvNEKiQX59SI0EB+Gmb6fEQcuTkLV79PyF9bP4CKGOpcZAD1HMAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 06 10 19 32 44" title="" data-src="/static/2019-06-10-19-32-44-f8ef215a624bdd21f854652eb7df10f3-81a6c.png" data-srcset="/static/2019-06-10-19-32-44-f8ef215a624bdd21f854652eb7df10f3-468c3.png 200w,\n/static/2019-06-10-19-32-44-f8ef215a624bdd21f854652eb7df10f3-3ff2b.png 400w,\n/static/2019-06-10-19-32-44-f8ef215a624bdd21f854652eb7df10f3-81a6c.png 600w" data-sizes="(max-width: 600px) 100vw, 600px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>以下是对上述呼叫流程的逐步说明：</p>\n<ul>\n<li>发送到代理服务器的 INVITE 请求负责启动会话。</li>\n<li>代理服务器发送 100 尝试立即响应呼叫者（Alice）以停止 INVITE 请求的重新发送。</li>\n<li>代理服务器在位置服务器中搜索 Bob 的地址。获取地址后，进一步转发 INVITE 请求。</li>\n<li>此后，Bob 手机生成的 180 振铃（临时响应）返回给爱丽丝。</li>\n<li>鲍勃拿起手机后一个 200 OK 响应很快产生。</li>\n<li>一旦 200 OK 到达 Alice，Bob 从 Alice 收到一个 ACK。</li>\n<li>同时，会话建立，RTP 数据包（会话）从两端开始流动。</li>\n<li>会话结束后，任何参与者（Alice 或 Bob）都可以发送一个 BYE 请求来终止会话。</li>\n<li>BYE 直接从 Alice 到 Bob 绕过代理服务器。</li>\n<li>最后，Bob 发送 200 OK 响应来确认 BYE，会话终止。</li>\n<li>在上述基本呼叫流程中，可以使用三个事务（标记为 1，2，3）。</li>\n</ul>\n<p>完整的呼叫（从 INVITE 到 200 OK）称为对话 Dialog。</p>\n<h1 id="sip-梯形"><a href="#sip-%E6%A2%AF%E5%BD%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>SIP 梯形</h1>\n<p>代理如何帮助一个用户与另一个用户连接？让我们在下图的帮助下找出。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-06-10-19-41-07-626e78b214093282713cb4538e1b4946-068c2.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 422px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 62.085308056872044%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABTElEQVQoz3WSS66CUBBE7/53YAxODHtwihNQh+gIlETED2gUQUUB9Ui/EJ9iDfg0Xd1VdVGr1SpN02OFJEmCIJjP5/v9nlfqVOI4pofiZrM5/ofi86PC/X7n6jiOZVk8lGWZZdntdpPnfr+/WCzqNoFigJSkahhGt9u9Xq/smUwmnue5rmvbtqZp4/FYBjWQpcoGXdfzPEezbI6iCM2dTodZQq6X/5GF6VRYr9fv2mQ0Enzf/5TN4O12ezqdiqIYDocSwXtH7SgMQzppI06kvci8Hw6H8/lMzlj9cFVDimxCwm63k07FSXBDam3+8QPyiWW1L4Xgy+VC6ZtZVvjm445oXuTRaESSvV6PKYhhECFzJWdMknNWgQpuscYa0zRbrRa/gyJDzmYwGMjZRj/AIHLiwJfL5Ww2a7fbEBVp8euQQaPJxgigTKdT5DwBp/ykSH3SIScAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 06 10 19 41 07" title="" data-src="/static/2019-06-10-19-41-07-626e78b214093282713cb4538e1b4946-068c2.png" data-srcset="/static/2019-06-10-19-41-07-626e78b214093282713cb4538e1b4946-2e5ea.png 200w,\n/static/2019-06-10-19-41-07-626e78b214093282713cb4538e1b4946-68ec0.png 400w,\n/static/2019-06-10-19-41-07-626e78b214093282713cb4538e1b4946-068c2.png 422w" data-sizes="(max-width: 422px) 100vw, 422px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>图中所示的拓扑结构称为 SIP 梯形图。该过程发生如下：</p>\n<ul>\n<li>当呼叫方发起呼叫时，将向代理服务器发送 INVITE 消息。代理服务器收到 INVITE 后，尝试借助 DNS 服务器解析受理者的地址。</li>\n<li>在获得下一个路由之后，呼叫者的代理服务器（代理 1，也称为出站代理服务器）将 INVITE 请求转发给作为被呼叫者的入站代理服务器（代理服务器 2）的被呼叫者的代理服务器。</li>\n<li>入站代理服务器联系位置服务器以获取用户注册的被叫方地址信息。</li>\n<li>从位置服务器获取信息后，将呼叫转发到其目的地。</li>\n<li>一旦用户代理知道他们的地址，他们可以绕过呼叫，即直接通话。</li>\n</ul>\n<p>以上更新于<code class="language-text">2019-6-10 20:24:54</code></p>\n<hr>',excerpt:"会话发起协议（SIP）是 VoIP 技术中最常用的协议之一。它是一种应用层协议，与其他应用层协议协同工作，通过 Internet 控制多媒体通信会话。 概述 SIP…",timeToRead:3,tableOfContents:'<ul>\n<li>\n<p><a href="/sip-protocol-introduction-learning/#%E6%A6%82%E8%BF%B0">概述</a></p>\n<ul>\n<li><a href="/sip-protocol-introduction-learning/#%E7%94%A8%E6%88%B7%E4%BB%A3%E7%90%86">用户代理</a></li>\n<li><a href="/sip-protocol-introduction-learning/#%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8">代理服务器</a></li>\n<li><a href="/sip-protocol-introduction-learning/#%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%E5%99%A8">注册服务器</a></li>\n<li><a href="/sip-protocol-introduction-learning/#%E9%87%8D%E5%AE%9A%E5%90%91%E6%9C%8D%E5%8A%A1%E5%99%A8">重定向服务器</a></li>\n<li><a href="/sip-protocol-introduction-learning/#%E4%BD%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1%E5%99%A8">位置服务器</a></li>\n</ul>\n</li>\n<li><a href="/sip-protocol-introduction-learning/#%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84">系统架构</a></li>\n<li><a href="/sip-protocol-introduction-learning/#sip-%E6%A2%AF%E5%BD%A2">SIP 梯形</a></li>\n</ul>',wordCount:{words:355},frontmatter:{date:"2019-06-10 11:43:51",path:"/sip-protocol-introduction-learning/",tags:"前端, SIP",title:"SIP协议入门学习",draft:null,catalog_number:null}},nextPost:{html:'<h1 id="一个站点配置多个域名"><a href="#%E4%B8%80%E4%B8%AA%E7%AB%99%E7%82%B9%E9%85%8D%E7%BD%AE%E5%A4%9A%E4%B8%AA%E5%9F%9F%E5%90%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一个站点配置多个域名</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32928789986156093000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`server {\n    listen       80;\n    server_name  ops-coffee.cn b.ops-coffee.cn;\n}`, `32928789986156093000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">server {\n    listen       80;\n    server_name  ops-coffee.cn b.ops-coffee.cn;\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>server_name 后跟多个域名即可，多个域名之间用空格分隔</p>\n<h1 id="一个服务配置多个站点"><a href="#%E4%B8%80%E4%B8%AA%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E5%A4%9A%E4%B8%AA%E7%AB%99%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一个服务配置多个站点</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85526077589253640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`server {\n    listen       80;\n    server_name  a.ops-coffee.cn;\n\n    location / {\n        root /home/project/pa;\n        index index.html;\n    }\n}\n\nserver {\n    listen       80;\n    server_name  ops-coffee.cn b.ops-coffee.cn;\n\n    location / {\n        root /home/project/pb;\n        index index.html;\n    }\n}\n\nserver {\n    listen       80;\n    server_name  c.ops-coffee.cn;\n\n    location / {\n        root /home/project/pc;\n        index index.html;\n    }\n}`, `85526077589253640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">server {\n    listen       80;\n    server_name  a.ops-coffee.cn;\n\n    location / {\n        root /home/project/pa;\n        index index.html;\n    }\n}\n\nserver {\n    listen       80;\n    server_name  ops-coffee.cn b.ops-coffee.cn;\n\n    location / {\n        root /home/project/pb;\n        index index.html;\n    }\n}\n\nserver {\n    listen       80;\n    server_name  c.ops-coffee.cn;\n\n    location / {\n        root /home/project/pc;\n        index index.html;\n    }\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>基于 nginx 虚拟主机配置实现，nginx 有三种类型的虚拟主机</p>\n<p>基于 ip 的虚拟主机：需要你的服务器上有多个地址，每个站点对应不同的地址，这种方式使用的比较少</p>\n<p>基于端口的虚拟主机：每个站点对应不同的端口，访问的时候使用 ip:port 的方式访问，可以修改 listen 的端口来使用</p>\n<p>基于域名的虚拟主机：使用最广的方式，上边例子中就是用了基于域名的虚拟主机，前提条件是你有多个域名分别对应每个站点，server_name 填写不同的域名即可</p>\n<h1 id="nginx-添加账号密码验证"><a href="#nginx-%E6%B7%BB%E5%8A%A0%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%E9%AA%8C%E8%AF%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>nginx 添加账号密码验证</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32333519447250780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`server {\n    location / {\n        auth_basic &quot;please input user&passwd&quot;;\n        auth_basic_user_file key/auth.key;\n    }\n}`, `32333519447250780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">server {\n    location / {\n        auth_basic &quot;please input user&amp;passwd&quot;;\n        auth_basic_user_file key/auth.key;\n    }\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有很多服务通过 nginx 访问，但本身没有提供账号认证的功能，就可以通过 nginx 提供的 authbase 账号密码认证来实现，可以用以下脚本来生成账号的密码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66646463923768476000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# cat pwd.pl\n#!/usr/bin/perl\nuse strict;\n\nmy \\$pw=\\$ARGV[0] ;\nprint crypt(\\$pw,\\$pw).&quot;\\n&quot;;`, `66646463923768476000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># cat pwd.pl</span>\n<span class="token comment">#!/usr/bin/perl</span>\nuse strict<span class="token punctuation">;</span>\n\nmy <span class="token variable">$pw</span><span class="token operator">=</span><span class="token variable">$ARGV</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">;</span>\nprint crypt<span class="token punctuation">(</span><span class="token variable">$pw</span>,<span class="token variable">$pw</span><span class="token punctuation">)</span>.<span class="token string">"<span class="token entity" title="\\n">\\n</span>"</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6999298949115396000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# perl pwd.pl ops-coffee.cn\nopf8BImqCAXww\n# echo &quot;admin:opf8BImqCAXww&quot; > key/auth.key`, `6999298949115396000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># perl pwd.pl ops-coffee.cn</span>\nopf8BImqCAXww\n<span class="token comment"># echo "admin:opf8BImqCAXww" > key/auth.key</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h1 id="nginx-开启列目录"><a href="#nginx-%E5%BC%80%E5%90%AF%E5%88%97%E7%9B%AE%E5%BD%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>nginx 开启列目录</h1>\n<p>当你想让 nginx 作为文件下载服务器存在时，需要开启 nginx 列目录</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89611285873629450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`server {\n    location download {\n        autoindex on;\n\n        autoindex_exact_size off;\n        autoindex_localtime on;\n    }\n}`, `89611285873629450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">server {\n    location download {\n        autoindex on;\n\n        autoindex_exact_size off;\n        autoindex_localtime on;\n    }\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">autoindex_exact_size</code>：为 on（默认）时显示文件的确切大小，单位是 byte；改为 off 显示文件大概大小，单位 KB 或 MB 或 GB</p>\n<p><code class="language-text">autoindex_localtime</code>：为 off（默认）时显示的文件时间为 GMT 时间；改为 on 后，显示的文件时间为服务器时间</p>\n<p>默认当访问列出的 txt 等文件时会在浏览器上显示文件的内容，如果你想让浏览器直接下载，加上下边的配置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71805940824097370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (\\$request_filename ~* ^.*?\\.(txt|pdf|jpg|png)\\$) {\n    add_header Content-Disposition \'attachment\';\n}`, `71805940824097370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">if ($request_filename ~* ^.*?\\.(txt|pdf|jpg|png)$) {\n    add_header Content-Disposition &#39;attachment&#39;;\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h1 id="配置默认站点"><a href="#%E9%85%8D%E7%BD%AE%E9%BB%98%E8%AE%A4%E7%AB%99%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配置默认站点</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3499173632430796300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`server {\n    listen 80 default;\n}`, `3499173632430796300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">server {\n    listen 80 default;\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>当一个 nginx 服务上创建了多个虚拟主机时默认会从上到下查找，如果匹配不到虚拟主机则会返回第一个虚拟主机的内容，如果你想指定一个默认站点时，可以将这个站点的虚拟主机放在配置文件中第一个虚拟主机的位置，或者在这个站点的虚拟主机上配置 listen default</p>\n<h1 id="不允许通过-ip-访问"><a href="#%E4%B8%8D%E5%85%81%E8%AE%B8%E9%80%9A%E8%BF%87-ip-%E8%AE%BF%E9%97%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>不允许通过 IP 访问</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56151315701263950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`server {\n    listen       80 default;\n    server_name  _;\n\n    return      404;\n}`, `56151315701263950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">server {\n    listen       80 default;\n    server_name  _;\n\n    return      404;\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可能有一些未备案的域名或者你不希望的域名将服务器地址指向了你的服务器，这时候就会对你的站点造成一定的影响，需要禁止 IP 或未配置的域名访问，我们利用上边所说的 default 规则，将默认流量都转到 404 去</p>\n<p>上边这个方法比较粗暴，当然你也可以配置下所有未配置的地址访问时直接 301 重定向到你的网站去，也能为你的网站带来一定的流量</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="907415257178057000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`server {\n    rewrite ^/(.*)\\$ https://ops-coffee.cn/\\$1    permanent;\n}`, `907415257178057000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">server {\n    rewrite ^/(.*)$ https://ops-coffee.cn/$1    permanent;\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h1 id="直接返回验证文件"><a href="#%E7%9B%B4%E6%8E%A5%E8%BF%94%E5%9B%9E%E9%AA%8C%E8%AF%81%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>直接返回验证文件</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21288791277086670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`location = /XDFyle6tNA.txt {\n    default_type text/plain;\n    return 200 \'d6296a84657eb275c05c31b10924f6ea\';\n}`, `21288791277086670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">location = /XDFyle6tNA.txt {\n    default_type text/plain;\n    return 200 &#39;d6296a84657eb275c05c31b10924f6ea&#39;;\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>很多时候微信等程序都需要我们放一个 txt 的文件到项目里以验证项目归属，我们可以直接通过上边这种方式修改 nginx 即可，无需真正的把文件给放到服务器上</p>\n<h1 id="nginx-配置-upstream-反向代理"><a href="#nginx-%E9%85%8D%E7%BD%AE-upstream-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>nginx 配置 upstream 反向代理</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54172177151410470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`http {\n    ...\n    upstream tomcats {\n        server 192.168.106.176 weight=1;\n        server 192.168.106.177 weight=1;\n    }\n\n    server {\n        location /ops-coffee/ {\n            proxy_pass http://tomcats;\n\n            proxy_set_header Host \\$host;\n            proxy_set_header X-Real-IP \\$remote_addr;\n            proxy_set_header X-Forwarded-For \\$proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto \\$scheme;\n        }\n    }\n\n}`, `54172177151410470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">http {\n    ...\n    upstream tomcats {\n        server 192.168.106.176 weight=1;\n        server 192.168.106.177 weight=1;\n    }\n\n    server {\n        location /ops-coffee/ {\n            proxy_pass http://tomcats;\n\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto $scheme;\n        }\n    }\n\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>稍不注意可能会落入一个 <code class="language-text">proxy_pass</code> 加杠不加杠的陷阱，这里详细说下 <code class="language-text">proxy_pass</code> <code class="language-text">http://tomcats</code> 与 <code class="language-text">proxy_pass</code> <code class="language-text">http://tomcats/</code> 的区别：</p>\n<p>虽然只是一个 / 的区别但结果确千差万别。分为以下两种情况：</p>\n<ol>\n<li>\n<p>目标地址中不带 uri(<code class="language-text">proxy_pass</code> <code class="language-text">http://tomcats</code>)。此时新的目标 url 中，匹配的 uri 部分不做修改，原来是什么就是什么。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30694484477296103000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`location /ops-coffee/ {\n   proxy_pass  http://192.168.106.135:8181;\n}\n\nhttp://domain/ops-coffee/   -->     http://192.168.106.135:8181/ops-coffee/\nhttp://domain/ops-coffee/action/abc   -->     http://192.168.106.135:8181/ops-coffee/action/abc`, `30694484477296103000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">location /ops-coffee/ {\n   proxy_pass  http://192.168.106.135:8181;\n}\n\nhttp://domain/ops-coffee/   --&gt;     http://192.168.106.135:8181/ops-coffee/\nhttp://domain/ops-coffee/action/abc   --&gt;     http://192.168.106.135:8181/ops-coffee/action/abc</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>目标地址中带 uri (<code class="language-text">proxy_pass</code> <code class="language-text">http://tomcats/</code>，/也是 uri) ,此时新的目标 url 中，匹配的 uri 部分将会被修改为该参数中的 uri。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80524856606085840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`location /ops-coffee/ {\n   proxy_pass  http://192.168.106.135:8181/;\n}\n\nhttp://domain/ops-coffee/   -->     http://192.168.106.135:8181\nhttp://domain/ops-coffee/action/abc   -->     http://192.168.106.135:8181/action/abc`, `80524856606085840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">location /ops-coffee/ {\n   proxy_pass  http://192.168.106.135:8181/;\n}\n\nhttp://domain/ops-coffee/   --&gt;     http://192.168.106.135:8181\nhttp://domain/ops-coffee/action/abc   --&gt;     http://192.168.106.135:8181/action/abc</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<h1 id="nginx-upstream-开启-keepalive"><a href="#nginx-upstream-%E5%BC%80%E5%90%AF-keepalive" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>nginx upstream 开启 keepalive</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97325247614078830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`upstream tomcat {\n    server ops-coffee.cn:8080;\n    keepalive 1024;\n}\n\nserver {\n    location / {\n        proxy_http_version 1.1;\n        proxy_set_header Connection &quot;&quot;;\n\n        proxy_pass http://tomcat;\n    }\n}`, `97325247614078830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">upstream tomcat {\n    server ops-coffee.cn:8080;\n    keepalive 1024;\n}\n\nserver {\n    location / {\n        proxy_http_version 1.1;\n        proxy_set_header Connection &quot;&quot;;\n\n        proxy_pass http://tomcat;\n    }\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>nginx 在项目中大多数情况下会作为反向代理使用，例如 nginx 后接 tomcat，nginx 后接 php 等，这时我们开启 nginx 和后端服务之间的 keepalive 能够减少频繁创建 TCP 连接造成的资源消耗，配置如上</p>\n<p>keepalive: 指定每个 nginxworker 可以保持的最大连接数量为 1024，默认不设置，即 nginx 作为 client 时 keepalive 未生效</p>\n<p><code class="language-text">proxy_http_version 1.1</code>: 开启 keepalive 要求 HTTP 协议版本为 HTTP 1.1</p>\n<p><code class="language-text">proxy_set_header Connection &quot;&quot;</code>: 为了兼容老的协议以及防止 http 头中有 Connection close 导致的 keepalive 失效，这里需要及时清掉 HTTP 头部的 Connection</p>\n<h1 id="404-自动跳转到首页"><a href="#404-%E8%87%AA%E5%8A%A8%E8%B7%B3%E8%BD%AC%E5%88%B0%E9%A6%96%E9%A1%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>404 自动跳转到首页</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51250001438748050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`server {\n    location / {\n       error_page 404 =  @ops-coffee;\n    }\n\n    location @ops-coffee {\n       rewrite  .*  / permanent;\n    }\n}`, `51250001438748050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">server {\n    location / {\n       error_page 404 =  @ops-coffee;\n    }\n\n    location @ops-coffee {\n       rewrite  .*  / permanent;\n    }\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>网站出现 404 页面不是特别友好，我们可以通过上边的配置在出现 404 之后给自动跳转到首页去</p>',
excerpt:"一个站点配置多个域名 server_name 后跟多个域名即可，多个域名之间用空格分隔 一个服务配置多个站点 基于 nginx 虚拟主机配置实现，nginx 有三种类型的虚拟主机 基于 ip…",frontmatter:{date:"2019-06-06 15:03:49",path:"/nginx-common-configurations-techniques/",tags:"后端, nginx",title:"nginx常用配置和技巧",draft:null}},prePost:{html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>最近由于第三方云端电话私自更改接口导致了线上事故的发生，所以公司决定由前端直接连接 freeswitch ，用它来借助第三方线路打云端电话</p>\n<h1 id="知识背景"><a href="#%E7%9F%A5%E8%AF%86%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>知识背景</h1>\n<p><a href="/SIP-protocol-introduction-learning/">SIP 协议入门学习</a></p>\n<h1 id="核心思路"><a href="#%E6%A0%B8%E5%BF%83%E6%80%9D%E8%B7%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心思路</h1>\n<p>首先在网上找到相应前端的 SIP 连接库，发现大概满足的有 2 种，一个是 JsSIP，看了一下支持的列表里面是没有 freeswitch 的，所以选了支持 freeswitch 的 SIP.js</p>\n<h1 id="代码预览"><a href="#%E4%BB%A3%E7%A0%81%E9%A2%84%E8%A7%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>代码预览</h1>\n<p>在写代码时考虑到要兼容之前第三方云端电话的逻辑，所以需要将所有的方法封装成一个类</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9149591309573512000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Call\nimport { UA } from \'./libs/sip-0.14.1\';\n\nclass Call {\n  constructor() {\n    // eslint-disable-next-line constructor-super\n    this.callInfo = null;\n    this.userAgent = null; // 注册 SIP 后实例\n    this.session = null; // 拨打成功后 session 实例\n    this.remoteView = null;\n\n    this.hasSignedIn = false;\n    this.createElements();\n\n    window.onbeforeunload = () => {\n      // eslint-disable-line\n      this.signOut();\n    };\n  }\n\n  createElements() {\n    this.remoteView = document.createElement(\'video\');\n    this.remoteView.style.display = \'none\';\n    document.body.appendChild(this.remoteView);\n  }\n\n  async signIn(callInfo) {\n    const { ws_domain: sipServer, ws_port: sipPort, ws_protocol: wsType } = await getCallInfo();\n    return new Promise((resolve, reject) => {\n      this.signInResolve = resolve;\n      this.signInReject = reject;\n      this.callInfo = {\n        authorizationUser: callInfo.agent_id,\n        password: callInfo.agent_pwd,\n        sipServer,\n        sipPort,\n        wsType\n      };\n      this.registerSip();\n    });\n  }\n\n  // 注册分机（软电话）\n  registerSip() {\n    const { authorizationUser, password, sipServer, sipPort, wsType } = this.callInfo;\n    const config = {\n      // Replace this IP address with your FreeSWITCH IP address\n      uri: \\`\\${authorizationUser}@\\${sipServer}:\\${sipPort}\\`,\n      transportOptions: {\n        wsServers: [\\`\\${wsType}://\\${sipServer}:\\${sipPort}\\`]\n      },\n      // Replace sipjs.com with your domain name\n      // and replace the port with your FreeSWITCH wss port\n      ws_servers: \\`\\${wsType}://\\${sipServer}:\\${sipPort}/\\`,\n      // FreeSWITCH Default Username\n      authorizationUser,\n      // FreeSWITCH Default Password\n      password,\n      // displayName: \'8300211193\',\n      hackIpInContact: true,\n      // register: true,\n      sessionDescriptionHandlerFactoryOptions: {\n        constraints: {\n          audio: true,\n          video: false\n        }\n      }\n    };\n\n    this.userAgent = new UA(config);\n\n    this.userAgent.on(\'connected\', () => {\n      console.log(\'连接成功\');\n    });\n\n    this.userAgent.on(\'disconnected\', () => {\n      console.log(\'连接断开\');\n    });\n\n    this.userAgent.on(\'registered\', () => {\n      console.log(\'注册成功\');\n      this.hasSignedIn = true;\n      this.signInResolve();\n    });\n\n    this.userAgent.on(\'unregistered\', () => {\n      console.log(\'反注册成功\');\n      this.upperSelf.onAgentStateChange && this.upperSelf.onAgentStateChange(\'0\', \'2\');\n      this.hasSignedIn = false;\n      this.signInReject();\n    });\n\n    this.userAgent.on(\'registrationFailed\', () => {\n      console.log(\'注册失败\');\n      this.hasSignedIn = false;\n      this.signInReject();\n    });\n\n    this.userAgent.once(\'transportCreated\', (transport) => {\n      console.log(\'transportCreated\', transport);\n    });\n\n    this.userAgent.on(\'message\', () => {\n      console.log(\'message\');\n    });\n\n    this.userAgent.on(\'invite\', (incomingSession) => {\n      console.log(\'incomingSession\', incomingSession);\n      this.session = incomingSession;\n      this.session.accept();\n      // 播放对方会话\n      this.session.on(\'trackAdded\', () => {\n        console.log(\'trackAdded\');\n        const pc = this.session.sessionDescriptionHandler.peerConnection;\n        // Gets remote tracks\n        const remoteStream = new MediaStream();\n        pc.getReceivers().forEach((receiver) => {\n          remoteStream.addTrack(receiver.track);\n        });\n        this.remoteView.srcObject = remoteStream;\n        this.remoteView.play();\n      });\n      this.session.on(\'progress\', (response) => {\n        console.log(\'progress\', response);\n      });\n      this.session.on(\'failed\', (response, cause) => {\n        console.log(\'failed\', response, cause);\n      });\n      // 响铃动作\n      this.session.on(\'accepted\', (data) => {\n        console.log(\'accepted\', data);\n      });\n      this.session.on(\'rejected\', (response, cause) => {\n        console.log(\'rejected\', response, cause);\n      });\n      // 挂断动作\n      this.session.on(\'terminated\', (message, cause) => {\n        console.log(\'terminated\', message, cause);\n      });\n      this.session.on(\'referRequested\', () => {\n        console.log(\'referRequested\');\n      });\n      this.session.on(\'reinvite\', () => {\n        console.log(\'reinvite\');\n      });\n      this.session.on(\'replaced\', () => {\n        console.log(\'replaced\');\n      });\n      this.session.on(\'cancel\', () => {\n        console.log(\'cancel\');\n      });\n      // 挂断动作\n      this.session.on(\'bye\', (request) => {\n        console.log(\'bye\', request);\n      });\n      this.session.on(\'directionChanged\', () => {\n        console.log(\'directionChanged\');\n      });\n      this.session.on(\'SessionDescriptionHandler-created\', () => {\n        console.log(\'SessionDescriptionHandler-created\');\n      });\n    });\n  }\n\n  // 来电挂断\n  hangup() {\n    console.log(\'挂断\', this.session);\n    if (this.session) {\n      this.session.bye();\n    }\n  }\n\n  signOut() {\n    console.log(\'退出登录成功\');\n    if (this.userAgent) {\n      this.userAgent.stop();\n      this.userAgent = null;\n    }\n    if (this.session) {\n      this.session.terminate();\n      this.session = null;\n    }\n    this.hasSignedIn = false;\n  }\n\n  // 603 Decline\n  // 当成功访问到被叫方的设备，但是用户明确的不想应答。这个应答可以通过增加一个Retry-After头域更明确的告诉呼叫方多久以后可以继续呼叫\n  // 只有当终端知道没有其他任何终端设备能够响应这个呼叫的势能才能给出这个应答。\n  makeIdle() {\n    console.log(\'在忙\');\n    // this.session.reply({\n    //   statusCode: \'486\',\n    // });\n  }\n}\n\nexport default Call;`, `9149591309573512000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// Call</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">UA</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'./libs/sip-0.14.1\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Call</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// eslint-disable-next-line constructor-super</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>callInfo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>userAgent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 注册 SIP 后实例</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>session <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 拨打成功后 session 实例</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>remoteView <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">this</span><span class="token punctuation">.</span>hasSignedIn <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    window<span class="token punctuation">.</span><span class="token function-variable function">onbeforeunload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// eslint-disable-line</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">signOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">createElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>remoteView <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'video\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>remoteView<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">\'none\'</span><span class="token punctuation">;</span>\n    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>remoteView<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">async</span> <span class="token function">signIn</span><span class="token punctuation">(</span><span class="token parameter">callInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token punctuation">{</span> ws_domain<span class="token punctuation">:</span> sipServer<span class="token punctuation">,</span> ws_port<span class="token punctuation">:</span> sipPort<span class="token punctuation">,</span> ws_protocol<span class="token punctuation">:</span> wsType <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getCallInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>signInResolve <span class="token operator">=</span> resolve<span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>signInReject <span class="token operator">=</span> reject<span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>callInfo <span class="token operator">=</span> <span class="token punctuation">{</span>\n        authorizationUser<span class="token punctuation">:</span> callInfo<span class="token punctuation">.</span>agent_id<span class="token punctuation">,</span>\n        password<span class="token punctuation">:</span> callInfo<span class="token punctuation">.</span>agent_pwd<span class="token punctuation">,</span>\n        sipServer<span class="token punctuation">,</span>\n        sipPort<span class="token punctuation">,</span>\n        wsType\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerSip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 注册分机（软电话）</span>\n  <span class="token function">registerSip</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token punctuation">{</span> authorizationUser<span class="token punctuation">,</span> password<span class="token punctuation">,</span> sipServer<span class="token punctuation">,</span> sipPort<span class="token punctuation">,</span> wsType <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>callInfo<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>\n      <span class="token comment">// Replace this IP address with your FreeSWITCH IP address</span>\n      uri<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>authorizationUser<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">@</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sipServer<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sipPort<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n      transportOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        wsServers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>wsType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sipServer<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sipPort<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token comment">// Replace sipjs.com with your domain name</span>\n      <span class="token comment">// and replace the port with your FreeSWITCH wss port</span>\n      ws_servers<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>wsType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sipServer<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sipPort<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n      <span class="token comment">// FreeSWITCH Default Username</span>\n      authorizationUser<span class="token punctuation">,</span>\n      <span class="token comment">// FreeSWITCH Default Password</span>\n      password<span class="token punctuation">,</span>\n      <span class="token comment">// displayName: \'8300211193\',</span>\n      hackIpInContact<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n      <span class="token comment">// register: true,</span>\n      sessionDescriptionHandlerFactoryOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        constraints<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n          audio<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n          video<span class="token punctuation">:</span> <span class="token boolean">false</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">this</span><span class="token punctuation">.</span>userAgent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UA</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">this</span><span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'connected\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'连接成功\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">this</span><span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'disconnected\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'连接断开\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">this</span><span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'registered\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'注册成功\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>hasSignedIn <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">signInResolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">this</span><span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'unregistered\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'反注册成功\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>upperSelf<span class="token punctuation">.</span>onAgentStateChange <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>upperSelf<span class="token punctuation">.</span><span class="token function">onAgentStateChange</span><span class="token punctuation">(</span><span class="token string">\'0\'</span><span class="token punctuation">,</span> <span class="token string">\'2\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>hasSignedIn <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">signInReject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">this</span><span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'registrationFailed\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'注册失败\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>hasSignedIn <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">signInReject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">this</span><span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">\'transportCreated\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">transport</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'transportCreated\'</span><span class="token punctuation">,</span> transport<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">this</span><span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'message\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'message\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">this</span><span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'invite\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">incomingSession</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'incomingSession\'</span><span class="token punctuation">,</span> incomingSession<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session <span class="token operator">=</span> incomingSession<span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 播放对方会话</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'trackAdded\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'trackAdded\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> pc <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span>sessionDescriptionHandler<span class="token punctuation">.</span>peerConnection<span class="token punctuation">;</span>\n        <span class="token comment">// Gets remote tracks</span>\n        <span class="token keyword">const</span> remoteStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        pc<span class="token punctuation">.</span><span class="token function">getReceivers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">receiver</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          remoteStream<span class="token punctuation">.</span><span class="token function">addTrack</span><span class="token punctuation">(</span>receiver<span class="token punctuation">.</span>track<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>remoteView<span class="token punctuation">.</span>srcObject <span class="token operator">=</span> remoteStream<span class="token punctuation">;</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>remoteView<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'progress\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'progress\'</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'failed\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">response<span class="token punctuation">,</span> cause</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'failed\'</span><span class="token punctuation">,</span> response<span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 响铃动作</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'accepted\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'accepted\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'rejected\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">response<span class="token punctuation">,</span> cause</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'rejected\'</span><span class="token punctuation">,</span> response<span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 挂断动作</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'terminated\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> cause</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'terminated\'</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'referRequested\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'referRequested\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'reinvite\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'reinvite\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'replaced\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'replaced\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'cancel\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'cancel\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 挂断动作</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'bye\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'bye\'</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'directionChanged\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'directionChanged\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'SessionDescriptionHandler-created\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'SessionDescriptionHandler-created\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 来电挂断</span>\n  <span class="token function">hangup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'挂断\'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">bye</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">signOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'退出登录成功\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>userAgent<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>userAgent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>session <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>hasSignedIn <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 603 Decline</span>\n  <span class="token comment">// 当成功访问到被叫方的设备，但是用户明确的不想应答。这个应答可以通过增加一个Retry-After头域更明确的告诉呼叫方多久以后可以继续呼叫</span>\n  <span class="token comment">// 只有当终端知道没有其他任何终端设备能够响应这个呼叫的势能才能给出这个应答。</span>\n  <span class="token function">makeIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'在忙\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// this.session.reply({</span>\n    <span class="token comment">//   statusCode: \'486\',</span>\n    <span class="token comment">// });</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> Call<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="疑难问题"><a href="#%E7%96%91%E9%9A%BE%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>疑难问题</h1>\n<p>以上因为 freeswitch 第三方线路的失败回调导致挂断电话不能正常挂断，此时最佳的解决办法就是后端写 websocket 来推送给前端以做到实时更新，否则总是有些不成功的回调导致 UI 显示错误，现阶段主要采用轮询后端的方式来获取最新的状态。</p>\n<p>以上更新于<code class="language-text">2019-6-10 20:20:52</code></p>\n<hr>\n<h1 id="实现效果"><a href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现效果</h1>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-06-10-20-13-17-6d6b1011cd526e12a624b1c69091f4b8-d42cb.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 407px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 107.37100737100738%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAIAAADJt1n/AAAACXBIWXMAAAsSAAALEgHS3X78AAAC20lEQVQ4y22T21LaUBSGeZw6HSUJIQmCIGoVFeWQhBxIQkBArKjYm/aidXrbTp3p4QH6IJ2+Sqftk/Tb2RQ7Tmf+Sf69sg7/WjsrVzRMt+e5vV7P88qVLUXVtIIuoWqgkBHx1IsGwJ/nVrVmGGautFkGVmnTtEqQzbJE5RGyT0tODUlyMt8qZUEvUof6POGQvKJC/q3MJ2CYVm4lUspDQqvdGQzSOE5oZzyZDEejbte2HVemW9/In7bajcMj8uZkViAJiXd2905OW0fHxweNBn6E7R80gCxOzO7es+36DicRTLeyZ54Aj5VIvkrAVz4UwFI0zRzSPT9AYT+Kg7AP6Xm+5/mQKE4AR98PHLcnLWE/wtLudEXPJKM9PwjPZxejszEkihISkfFyfjWZnmNJkgF5pWV6PoPQi0Flcc/k5Gw7mCCdbDwQx3GdjHBmZl4Qdpc+fvPkBOWisp9Zx5Pp2XgCCYIQnZDp9HyQDvHu9yPyd2334vllmg7J2Ol2CRQ983PZXRvxURRTwXFdQDXE0yEEB3FbtkNkGPYJ5hZEz8yayphwFd5hX/yoni8tBPPiiBHCETs1GJhuGEK2SO/2kI1IpsqR8aDgZnHLwFASZzOHXN8scMMHIUI2AxN34wdA3EoQokqOEC6BN5EQ6UbqVqtdpDLS/eye42QQZoPxsnsmgPklgzTLE5LO+asOC7JNcc+mJcPS4QhX0VEUR0niR9H1YjGdzQLuPU2pBubzK+LxIZFpWTn+Q5azWtvmKUllq1o2yhWjYhasSlEQceTbdl3uI6RcqdBvTu7gA9SCquvVN079c9z8OK7eBztfkuprR1U0RdMIAHlFYT1Ez/KnX8IwEFIsWc3vL05/3t39+jr/8an1+23z261eEDt3eHTMMmqaruvGsvJjFI3aK7v+Idp/l7TfT+r3Ue2lXdDEzpJdrpTYqv8H08hTVV1TlLX8+pMNCEdpf9j8LPgPDhtowU2c6joAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 06 10 20 13 17" title="" data-src="/static/2019-06-10-20-13-17-6d6b1011cd526e12a624b1c69091f4b8-d42cb.png" data-srcset="/static/2019-06-10-20-13-17-6d6b1011cd526e12a624b1c69091f4b8-68801.png 200w,\n/static/2019-06-10-20-13-17-6d6b1011cd526e12a624b1c69091f4b8-d3489.png 400w,\n/static/2019-06-10-20-13-17-6d6b1011cd526e12a624b1c69091f4b8-d42cb.png 407w" data-sizes="(max-width: 407px) 100vw, 407px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-06-10-20-15-11-7efbc5afdb7a66d757b0c02675f7ffb5-17038.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 463px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 117.27861771058315%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAIAAACEf/j0AAAACXBIWXMAAAsSAAALEgHS3X78AAAC5UlEQVQ4y41USVMaURCenxMDygzrbIws4yxv2EERGDZRQCKaPefcc81PyM38Bo/m5EWxypSmKheteJO7ku/NUBQVg8mrrq5+M+973f1192M4fyCeVE1d8ylEKA78HMdy/qcFEEGUYDDhCJ8rFO1KOaBXtO5Hno8Ew5HQkwKIshqDwfCCKIoSL0qKLPFBjm4l2RXYiyTCC9AMYiitb9j1ht1oIn6Pd9m7vLLk8cLwsf9IgQkEQ4ZJKtVaebOi6UYiqRZLJWwLxZIcVYDH7YuEgomV6vX6ne1tGCaxYBy8fLW9043F4wD7A8GFYPzTDXNN03WTSHJ0ecUHQeTQLrHzYNjzWwq2Umn4zGRzsXjC8RSCgnaPupnP7PlEaNjpTLbf3+32esAjf+S80+1lc3mkQIjV3x00mi1Eh1+9/u5w/8Cu10HHlLB8oVBvNJutFm5B/Ll8oVqzYYM/4Ku12vpGGbam6TW7jrqgOigkBSMYfBoO99+9/7BZqeIQaN/bG4Jt6tlKDQYv6o0GrnE9v37zttXeAjsUHAyFcQh3Q+AW4FQ6U7Nt6Kiy6ibvCtzM29Oc44kkQt0ob6prGvDgD0lCAzyj6rFQMDznC0X4wR5d5dZp6bnHrdYicerogMFWe6sDhnTdoLkZpulowyB/FdO00IgUjNRPTk6urn5Arq+vb29vfz25bm5u7u7ujo6OKBjDNR6PJ5PJw8PD5D/W/f099OnpKdJkMNbHx98uLr6PRqPz83OoEV0z4891dnZ2eXl1ePiVZf0UzAsStGOIgkgn2bVlWQHh84IcBfo9Sg1RYvAgpFNWNpNBbdCYoB2lRm+gSZARCjl7QGBHkyoplWRVBc0QhuUCUtJa1VI4Cg5Rc1QbfKN+uB4lmb5bnN/jY9uq+rnTGRKCatGcA6FwothR0lVVVdFq4HA2lfMDhGl8xnKfYvGfO90vhLDOeDmPASqq6+gtxIzHbdZVj6d/BVezHDTOYLB+A0x1vxBYHZqdAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 06 10 20 15 11" title="" data-src="/static/2019-06-10-20-15-11-7efbc5afdb7a66d757b0c02675f7ffb5-17038.png" data-srcset="/static/2019-06-10-20-15-11-7efbc5afdb7a66d757b0c02675f7ffb5-ebf63.png 200w,\n/static/2019-06-10-20-15-11-7efbc5afdb7a66d757b0c02675f7ffb5-37c59.png 400w,\n/static/2019-06-10-20-15-11-7efbc5afdb7a66d757b0c02675f7ffb5-17038.png 463w" data-sizes="(max-width: 463px) 100vw, 463px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2019-06-10-20-16-33-03507c8d6bc624be7f4884dc39009044-cac7f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 21.52542372881356%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAr0lEQVQI1y2O2Q7CMAwE+//fBoWWoyR2jsamJ4jSgjjEAw5FGo02q5XiRIfC18ZVaCuYQVb2CDO+Ma5Gw1oG1Lt64NO9FeuyECeOwTIYmtdxh6SQtBEYXGzA/J7VmW+fq3C6dRC0ONnRauPTbYjOXRpzucrdUsKeMum3YZ37NLML7Ir2Qe2TwoCZW4gTyxqCMqTkT0GuwKC0LzA2Mf8PYWgux/F1md5DP7a6PPRT8wUfD9IcalHJpQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2019 06 10 20 16 33" title="" data-src="/static/2019-06-10-20-16-33-03507c8d6bc624be7f4884dc39009044-fee1c.png" data-srcset="/static/2019-06-10-20-16-33-03507c8d6bc624be7f4884dc39009044-a67b7.png 200w,\n/static/2019-06-10-20-16-33-03507c8d6bc624be7f4884dc39009044-0b187.png 400w,\n/static/2019-06-10-20-16-33-03507c8d6bc624be7f4884dc39009044-fee1c.png 800w,\n/static/2019-06-10-20-16-33-03507c8d6bc624be7f4884dc39009044-cac7f.png 1180w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>',
excerpt:"需求背景 最近由于第三方云端电话私自更改接口导致了线上事故的发生，所以公司决定由前端直接连接 freeswitch ，用它来借助第三方线路打云端电话 知识背景 SIP 协议入门学习 核心思路 首先在网上找到相应前端的 SIP 连接库，发现大概满足的有 2 种，一个是 JsSIP…",frontmatter:{date:"2019-06-10 11:44:03",path:"/sip-protocol-practice/",tags:"前端, SIP, webrtc, 预研",title:"基于SIP协议云端电话的实践",draft:null}}},pathContext:{mainPostPath:"/sip-protocol-introduction-learning/",nextPostPath:"/nginx-common-configurations-techniques/",prePostPath:"/sip-protocol-practice/"}}}});