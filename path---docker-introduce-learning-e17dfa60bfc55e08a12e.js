webpackJsonp([0x6e94445cb5e2],{1218:function(n,a){n.exports={data:{file:{childImageSharp:{sizes:{base64:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAACXBIWXMAAAsSAAALEgHS3X78AAAHlElEQVRIx12We2xT5xXAbcI2Vmn7o1I1uhVYRxL8tuPn9bXv0+/4/YgdOyYkkATCCEEYsqVNC2wCIYQWShmUBFh4hMAWECot0BUtlI4yAS1oKqJQXimsDBgTU8codnLO7r0uUPpJn87Rp+/8vvOdc75zr8xmZmTieI1NykU5yxOfxDncz3NUjAlyDXMjXGMhys+cG+FzGQ8VU4t7XuV8z8m+GUkrJclSqVReYJ0ZWQ8Tl2AdTPhnq9ns2QKd+crDZiHha8NsYCE21HZiXphpb3sxxTf99Tdsw51ldHqFaLOXXyzvYqOyZ0YPk5soylfouuUbvHOxh56JbiqJfi4/FnE1lxKetrGUZ954nbcdU/752ORpxWVsc6mZjPxctFtApeVtra1lmIPwTxClgeCqvGTsX/WWOEbtyTGWSoGbToOPzUHQ1QghVxOEhRniZ5U8XB4TzvTdgj1ZJdq2OOrkGhVRBnrYFum6TiK0l2fr0emMlVxcBhlnEniqDjlBuqg0CnD0MPWiDrwzhR4u+5B3x3WiLUNHJjxzZYvR8ZKTCP+Xo1JoM/nBYvSB1egHuyUIrCOBPj4LtD0KlD2K4h7SGip62aygxzaK9rHA3Aqt2vw0MRYjnyJtYaQdsXG9hgWFwgmVlXZUKUjUqmm0CgfwhA80Kgr1Wg40Sue4SuFEnZq+YjMbJ0kh0zmfemjQ0j2EJYh2a23RVOODIBvHmCsBUaoWLDoWKIsP50bTApxC5QwH1Ghp0Gk4MBk8aDLQEslooCc88VClsK+zGANI2mqLer0XFuea8PSuN+DM7o3QWyhAR7IBfj+vDbyOICS9aSjkZo8nvSlUKuxXLDUOKdN6LSl/AlRUE+vNAnD50l8XeTIEPiYEzXYG5mlNeGz7BvjPpY/g5snDcHxwE+zs7oCh1zvHCrNm48u/ML8j2muVQblBZ3t6ZY2KXKtQcDiwdk1xx9rV0BlqghEuD4fNUTy1Zwhw7Cbioxu461fdsOgFDa5pbh3zu6NifE9f+XCPlGHS5nuaFI3K8brJ4EUHES4WFiyEP2/dCPc2vYH/3NIHePcywP1LWLp3Ec4tWQa3FvbAu7294yqVA801rju5utYfiQyKDD4DnC8GWEhMafJPtBALxuHjo3+C8bufIn59DfHBFcDiDcQvzyF+/iEsbWuDadNMaDW5H7nY6Iyyh165zfLNtdUqIqLTsEJSQqBVUTD1JQPqdRT8sf9NuH7kMHy0fRg+O3EUzp96H/Zs2SBklxFKxwFmowtdTCIoPQx7oKLzl32PPTRPVSudDwQgCrUGL0+twdzsDjjSdwD2J1fh/q7N0N+1EtykB178qVY4lAahRktWkw95JrG4DAxPvHU3Wwb+rlcsHfK0WNxCoMdUCgdUaxnMBPKw7dVe2LyhDw4MboORA4NQOd2CaiUFaqWjZJGAyQGRUeubP8FqElqZspquEBeUM2zrnEQUa3R8USVcp2qGDZV6ErqXL4PfrlwFhSU9cPL4MejfshOsZq90sCg5KvHZ5MnPfa+cmFrxukRFuRZNcYqIoNngHheeFmiF11ClIDBdPwfqG9qhc1E3rF25GnrX90M204JqBfWItPrP8lTqa7vFpSw3GJ9cZjI4pW5TXaWezpKxh4Q5gEY9LwApVOtZMApxVWhd2DKvC7K5FjTUsFCj45Ah4yXaHuz1MBlgyHCb1HXISIXMTcekOJqN1h/72Mx92h5DwuwHjeChWseBQsNgJJ6H944eB5oNgaLajnaL/07E24wuKr7Cz+XuuenUsMioCxYmyHhnSPLQTYVVYVfjI46Mo80WBLMgLY4E1FhCOENBAsfHQG/0juuNPqGguU8ywXas5XNbg6783wJ8w781GtUPJc+irkap/Ufdje0JXytStnDJbA2D1Z4EKxEHsyUMRmsIdcZaNFpCYBYqwWQLPhD3Btn6t2Pe5uF0cD7Sdr/xmSab8racFaDooOvuk0wDEs40EFQGbVQGbEKXJoTPgZ3JoJGIgULvR6M1jE67rzvpae5ojC7GEJ9rfgILc7lC3NV0T6flTtjoPLK+VuD8rcD65gDtaQInPxOtzoxQRrXgD8/BdW/+YezYByfxvfdHvnxl+ZLKCDfzUMIze60Ey+brJukrqcjA1u3tBw8dfZiZuRQFaNFory/WEPUlE5kFK5WDQKRtbFPfUOnChUvFL27cwKuj/8CBHXv2iQw/k/KGuNwyCYiIkhw+sO/569eu7b1+ffR/H5z4BAcG38X1m/biyjX9ODR8GC9dHsXLV0fx5KlzePDIyFd7ht9ZJZhJrcvLhV/wMuUPljQWtC6Z+FjfuWPHlPMXLq64Onpz3d8/Pf9WX//OW2vWbITBof3n3tqya9fbh/7SvW1gZ9Xj/V1dr8kf614qIZONjBwrezi8Ty54K5d9ZzTmF+xe1LnioaD+4Nvrn4/ermif3yHp8UCDLMCky7Z+n192+/YdST9z5mPZ7t1D8ouXv6gQ4S9WTplks7mut8xZijxbKz2vvi2D39/cPyB/HC5xOm2czPvd35F8rkGCS0+I4WXV1QbJaMq06XqbNXCQJIILpH8hOic3GghZMpl62qG/Nf4PRzaQ862MzO4AAAAASUVORK5CYII=",aspectRatio:.6666666666666666,src:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-25c91.png",srcSet:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-8a97b.png 200w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-0fdf3.png 400w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-25c91.png 600w",srcWebp:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-216f6.webp",srcSetWebp:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-5d70e.webp 200w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-d1677.webp 400w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-216f6.webp 600w",sizes:"(max-width: 600px) 100vw, 600px"}}},site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}},mainPost:{html:'<h1 id="基本概念"><a href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基本概念</h1>\n<h2 id="镜像"><a href="#%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>镜像</h2>\n<p>Docker 镜像是一个特殊的文件系统，除了提供容器运行时所需的程序、库、资源、配置等文件外，还包含了一些为运行时准备的一些配置参数（如匿名卷、环境变量、用户等）。镜像不包含任何动态数据，其内容在构建之后也不会被改变。</p>\n<h3 id="分层存储"><a href="#%E5%88%86%E5%B1%82%E5%AD%98%E5%82%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分层存储</h3>\n<p>因为镜像包含操作系统完整的 root 文件系统，其体积往往是庞大的，因此在 Docker 设计时，就充分利用 Union FS 的技术，将其设计为分层存储的架构。所以严格来说，镜像并非是像一个 ISO 那样的打包文件，镜像只是一个虚拟的概念，其实际体现并非由一个文件组成，而是由一组文件系统组成，或者说，由多层文件系统联合组成。</p>\n<p>镜像构建时，会一层层构建，前一层是后一层的基础。每一层构建完就不会再发生改变，后一层上的任何改变只发生在自己这一层。比如，删除前一层文件的操作，实际不是真的删除前一层的文件，而是仅在当前层标记为该文件已删除。在最终容器运行的时候，虽然不会看到这个文件，但是实际上该文件会一直跟随镜像。因此，在构建镜像的时候，需要额外小心，每一层尽量只包含该层需要添加的东西，任何额外的东西应该在该层构建结束前清理掉。</p>\n<p>分层存储的特征还使得镜像的复用、定制变的更为容易。甚至可以用之前构建好的镜像作为基础层，然后进一步添加新的层，以定制自己所需的内容，构建新的镜像。</p>\n<h2 id="容器"><a href="#%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器</h2>\n<p>镜像（Image）和容器（Container）的关系，就像是面向对象程序设计中的类和实例一样，镜像是静态的定义，容器是镜像运行时的实体。容器可以被创建、启动、停止、删除、暂停等。</p>\n<p>容器的实质是进程，但与直接在宿主执行的进程不同，容器进程运行于属于自己的独立的命名空间（opens new window）。因此容器可以拥有自己的 root 文件系统、自己的网络配置、自己的进程空间，甚至自己的用户 ID 空间。容器内的进程是运行在一个隔离的环境里，使用起来，就好像是在一个独立于宿主的系统下操作一样。这种特性使得容器封装的应用比直接在宿主运行更加安全。也因为这种隔离的特性，很多人初学 Docker 时常常会混淆容器和虚拟机。</p>\n<p>前面讲过镜像使用的是分层存储，容器也是如此。每一个容器运行时，是以镜像为基础层，在其上创建一个当前容器的存储层，我们可以称这个为容器运行时读写而准备的存储层为容器存储层。</p>\n<p>容器存储层的生存周期和容器一样，容器消亡时，容器存储层也随之消亡。因此，任何保存于容器存储层的信息都会随容器删除而丢失。</p>\n<p>按照 Docker 最佳实践的要求，容器不应该向其存储层内写入任何数据，容器存储层要保持无状态化。所有的文件写入操作，都应该使用数据卷（Volume）、或者绑定宿主目录，在这些位置的读写会跳过容器存储层，直接对宿主（或网络存储）发生读写，其性能和稳定性更高。</p>\n<p>数据卷的生存周期独立于容器，容器消亡，数据卷不会消亡。因此，使用数据卷后，容器删除或者重新运行之后，数据却不会丢失。</p>\n<h2 id="仓库"><a href="#%E4%BB%93%E5%BA%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>仓库</h2>\n<p>镜像构建完成后，可以很容易的在当前宿主机上运行，但是，如果需要在其它服务器上使用这个镜像，我们就需要一个集中的存储、分发镜像的服务，Docker Registry 就是这样的服务。</p>\n<p>一个 Docker Registry 中可以包含多个仓库（Repository）；每个仓库可以包含多个标签（Tag）；每个标签对应一个镜像。</p>\n<p>通常，一个仓库会包含同一个软件不同版本的镜像，而标签就常用于对应该软件的各个版本。我们可以通过 <code class="language-text">&lt;仓库名&gt;:&lt;标签&gt;</code> 的格式来指定具体是这个软件哪个版本的镜像。如果不给出标签，将以 latest 作为默认标签。</p>\n<p>以 Ubuntu 镜像为例，ubuntu 是仓库的名字，其内包含有不同的版本标签，如 16.04, 18.04。我们可以通过 ubuntu:16.04 或者 ubuntu:18.04 来具体指定所需哪个版本的镜像。如果忽略了标签，比如 ubuntu，那将视为 ubuntu:latest。</p>\n<p>仓库名经常以两段式路径形式出现，比如 jwilder/nginx-proxy，前者往往意味着 Docker Registry 多用户环境下的用户名，后者则往往是对应的软件名。但这并非绝对，取决于所使用的具体 Docker Registry 的软件或服务。</p>\n<h3 id="docker-registry-公开服务"><a href="#docker-registry-%E5%85%AC%E5%BC%80%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker Registry 公开服务</h3>\n<p>Docker Registry 公开服务是开放给用户使用、允许用户管理镜像的 Registry 服务。一般这类公开服务允许用户免费上传、下载公开的镜像，并可能提供收费服务供用户管理私有镜像。</p>\n<p>最常使用的 Registry 公开服务是官方的 Docker Hub，这也是默认的 Registry，并拥有大量的高质量的官方镜像。除此以外，还有 Red Hat 的 Quay.io ；Google 的 Google Container Registry，Kubernetes 的镜像使用的就是这个服务；代码托管平台 GitHub 推出的 ghcr.io。</p>\n<p>由于某些原因，在国内访问这些服务可能会比较慢。国内的一些云服务商提供了针对 Docker Hub 的镜像服务（Registry Mirror），这些镜像服务被称为加速器。常见的有阿里云加速器、DaoCloud 加速器等。使用加速器会直接从国内的地址下载 Docker Hub 的镜像，比直接从 Docker Hub 下载速度会提高很多。</p>\n<p>国内也有一些云服务商提供类似于 Docker Hub 的公开服务。比如网易云镜像服务、DaoCloud 镜像市场、阿里云镜像库等。</p>\n<h3 id="私有-docker-registry"><a href="#%E7%A7%81%E6%9C%89-docker-registry" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>私有 Docker Registry</h3>\n<p>除了使用公开服务外，用户还可以在本地搭建私有 Docker Registry。Docker 官方提供了 Docker Registry 镜像，可以直接使用做为私有 Registry 服务。在私有仓库一节中，会有进一步的搭建私有 Registry 服务的讲解。</p>\n<p>开源的 Docker Registry 镜像只提供了 Docker Registry API 的服务端实现，足以支持 docker 命令，不影响使用。但不包含图形界面，以及镜像维护、用户管理、访问控制等高级功能。</p>\n<p>除了官方的 Docker Registry 外，还有第三方软件实现了 Docker Registry API，甚至提供了用户界面以及一些高级功能，比如 Harbor 和 Sonatype Nexus</p>\n<h1 id="使用镜像"><a href="#%E4%BD%BF%E7%94%A8%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用镜像</h1>\n<p>Docker 运行容器前需要本地存在对应的镜像，如果本地不存在该镜像，Docker 会从镜像仓库下载该镜像。</p>\n<h2 id="获取镜像"><a href="#%E8%8E%B7%E5%8F%96%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>获取镜像</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37241630371890700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker pull [选项] [Docker Registry 地址[:端口号]/]仓库名[:标签]`, `37241630371890700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker pull <span class="token punctuation">[</span>选项<span class="token punctuation">]</span> <span class="token punctuation">[</span>Docker Registry 地址<span class="token punctuation">[</span>:端口号<span class="token punctuation">]</span>/<span class="token punctuation">]</span>仓库名<span class="token punctuation">[</span>:标签<span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<ul>\n<li>Docker 镜像仓库地址：地址的格式一般是 <code class="language-text">&lt;域名/IP&gt;[:端口号]</code>。默认地址是 Docker Hub(docker.io)。</li>\n<li>仓库名：如之前所说，这里的仓库名是两段式名称，即 <code class="language-text">&lt;用户名&gt;/&lt;软件名&gt;</code>。对于 Docker Hub，如果不给出用户名，则默认为 library，也就是官方镜像。</li>\n</ul>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72250397596484990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker pull ubuntu:18.04\n18.04: Pulling from library/ubuntu\n92dc2a97ff99: Pull complete\nbe13a9d27eb8: Pull complete\nc8299583700a: Pull complete\nDigest: sha256:4bc3ae6596938cb0d9e5ac51a1152ec9dcac2a1c50829c74abd9c4361e321b26\nStatus: Downloaded newer image for ubuntu:18.04\ndocker.io/library/ubuntu:18.04 # 完整名称`, `72250397596484990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker pull ubuntu:18.04\n<span class="token number">18.04</span>: Pulling from library/ubuntu\n92dc2a97ff99: Pull complete\nbe13a9d27eb8: Pull complete\nc8299583700a: Pull complete\nDigest: sha256:4bc3ae6596938cb0d9e5ac51a1152ec9dcac2a1c50829c74abd9c4361e321b26\nStatus: Downloaded newer image <span class="token keyword">for</span> ubuntu:18.04\ndocker.io/library/ubuntu:18.04 <span class="token comment"># 完整名称</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行"><a href="#%E8%BF%90%E8%A1%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1646694784608304600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -it --rm ubuntu:18.04 bash\n\nroot@e7009c6ce357:/# cat /etc/os-release\nNAME=&quot;Ubuntu&quot;\nVERSION=&quot;18.04.1 LTS (Bionic Beaver)&quot;\nID=ubuntu\nID_LIKE=debian\nPRETTY_NAME=&quot;Ubuntu 18.04.1 LTS&quot;\nVERSION_ID=&quot;18.04&quot;\nHOME_URL=&quot;https://www.ubuntu.com/&quot;\nSUPPORT_URL=&quot;https://help.ubuntu.com/&quot;\nBUG_REPORT_URL=&quot;https://bugs.launchpad.net/ubuntu/&quot;\nPRIVACY_POLICY_URL=&quot;https://www.ubuntu.com/legal/terms-and-policies/privacy-policy&quot;\nVERSION_CODENAME=bionic\nUBUNTU_CODENAME=bionic`, `1646694784608304600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -it --rm ubuntu:18.04 <span class="token function">bash</span>\n\nroot@e7009c6ce357:/<span class="token comment"># cat /etc/os-release</span>\n<span class="token assign-left variable">NAME</span><span class="token operator">=</span><span class="token string">"Ubuntu"</span>\n<span class="token assign-left variable">VERSION</span><span class="token operator">=</span><span class="token string">"18.04.1 LTS (Bionic Beaver)"</span>\n<span class="token assign-left variable">ID</span><span class="token operator">=</span>ubuntu\n<span class="token assign-left variable">ID_LIKE</span><span class="token operator">=</span>debian\n<span class="token assign-left variable">PRETTY_NAME</span><span class="token operator">=</span><span class="token string">"Ubuntu 18.04.1 LTS"</span>\n<span class="token assign-left variable">VERSION_ID</span><span class="token operator">=</span><span class="token string">"18.04"</span>\n<span class="token assign-left variable">HOME_URL</span><span class="token operator">=</span><span class="token string">"https://www.ubuntu.com/"</span>\n<span class="token assign-left variable">SUPPORT_URL</span><span class="token operator">=</span><span class="token string">"https://help.ubuntu.com/"</span>\n<span class="token assign-left variable">BUG_REPORT_URL</span><span class="token operator">=</span><span class="token string">"https://bugs.launchpad.net/ubuntu/"</span>\n<span class="token assign-left variable">PRIVACY_POLICY_URL</span><span class="token operator">=</span><span class="token string">"https://www.ubuntu.com/legal/terms-and-policies/privacy-policy"</span>\n<span class="token assign-left variable">VERSION_CODENAME</span><span class="token operator">=</span>bionic\n<span class="token assign-left variable">UBUNTU_CODENAME</span><span class="token operator">=</span>bionic</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>docker run 就是运行容器的命令，具体格式我们会在容器一节进行详细讲解，我们这里简要的说明一下上面用到的参数。</p>\n<ul>\n<li><code class="language-text">-it</code>：这是两个参数，一个是 <code class="language-text">-i</code> 交互式操作，一个是 <code class="language-text">-t</code> 终端。我们这里打算进入 bash 执行一些命令并查看返回结果，因此我们需要交互式终端。</li>\n<li><code class="language-text">--rm</code>：这个参数是说容器退出后随之将其删除。默认情况下，为了排障需求，退出的容器并不会立即删除，除非手动 docker rm。我们这里只是随便执行个命令，看看结果，不需要排障和保留结果，因此使用 —rm 可以避免浪费空间。</li>\n<li><code class="language-text">ubuntu:18.04</code>：这是指用 <code class="language-text">ubuntu:18.04</code> 镜像为基础来启动容器。</li>\n<li><code class="language-text">bash</code>：放在镜像名后的是命令，这里我们希望有个交互式 Shell，因此用的是 bash。进入容器后，我们可以在 Shell 下操作，执行任何所需的命令。这里，我们执行了 cat /etc/os-release，这是 Linux 常用的查看当前系统版本的命令，从返回的结果可以看到容器内是 <code class="language-text">Ubuntu 18.04.1 LTS</code> 系统。</li>\n</ul>\n<p>最后我们通过 exit 退出了这个容器。</p>\n<h2 id="列出镜像"><a href="#%E5%88%97%E5%87%BA%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>列出镜像</h2>\n<p>列出已经下载下来的镜像，可以使用 docker image ls 命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31486058260710003000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls\nREPOSITORY           TAG                 IMAGE ID            CREATED             SIZE\nredis                latest              5f515359c7f8        5 days ago          183 MB\nnginx                latest              05a60462f8ba        5 days ago          181 MB\nmongo                3.2                 fe9198c04d62        5 days ago          342 MB\n<none>               <none>              00285df0df87        5 days ago          342 MB\nubuntu               18.04               329ed837d508        3 days ago          63.3MB\nubuntu               bionic              329ed837d508        3 days ago          63.3MB`, `31486058260710003000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span>\nREPOSITORY           TAG                 IMAGE ID            CREATED             SIZE\nredis                latest              5f515359c7f8        <span class="token number">5</span> days ago          <span class="token number">183</span> MB\nnginx                latest              05a60462f8ba        <span class="token number">5</span> days ago          <span class="token number">181</span> MB\nmongo                <span class="token number">3.2</span>                 fe9198c04d62        <span class="token number">5</span> days ago          <span class="token number">342</span> MB\n<span class="token operator">&lt;</span>none<span class="token operator">></span>               <span class="token operator">&lt;</span>none<span class="token operator">></span>              00285df0df87        <span class="token number">5</span> days ago          <span class="token number">342</span> MB\nubuntu               <span class="token number">18.04</span>               329ed837d508        <span class="token number">3</span> days ago          <span class="token number">63</span>.3MB\nubuntu               bionic              329ed837d508        <span class="token number">3</span> days ago          <span class="token number">63</span>.3MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="镜像体积"><a href="#%E9%95%9C%E5%83%8F%E4%BD%93%E7%A7%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>镜像体积</h3>\n<p>Docker Hub 中显示的体积是压缩后的体积，而 docker image ls 显示的是镜像下载到本地后展开的大小</p>\n<p>另外一个需要注意的问题是，docker image ls 列表中的镜像体积总和并非是所有镜像实际硬盘消耗。由于 Docker 镜像是多层存储结构，并且可以继承、复用，因此不同镜像可能会因为使用相同的基础镜像，从而拥有共同的层。由于 Docker 使用 Union FS，相同的层只需要保存一份即可，因此实际镜像硬盘占用空间很可能要比这个列表镜像大小的总和要小的多。</p>\n<p>你可以通过 docker system df 命令来便捷的查看镜像、容器、数据卷所占用的空间。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35877157034309116000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker system df\n\nTYPE                TOTAL               ACTIVE              SIZE                RECLAIMABLE\nImages              24                  0                   1.992GB             1.992GB (100%)\nContainers          1                   0                   62.82MB             62.82MB (100%)\nLocal Volumes       9                   0                   652.2MB             652.2MB (100%)\nBuild Cache                                                 0B                  0B`, `35877157034309116000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker system <span class="token function">df</span>\n\nTYPE                TOTAL               ACTIVE              SIZE                RECLAIMABLE\nImages              <span class="token number">24</span>                  <span class="token number">0</span>                   <span class="token number">1</span>.992GB             <span class="token number">1</span>.992GB <span class="token punctuation">(</span><span class="token number">100</span>%<span class="token punctuation">)</span>\nContainers          <span class="token number">1</span>                   <span class="token number">0</span>                   <span class="token number">62</span>.82MB             <span class="token number">62</span>.82MB <span class="token punctuation">(</span><span class="token number">100</span>%<span class="token punctuation">)</span>\nLocal Volumes       <span class="token number">9</span>                   <span class="token number">0</span>                   <span class="token number">652</span>.2MB             <span class="token number">652</span>.2MB <span class="token punctuation">(</span><span class="token number">100</span>%<span class="token punctuation">)</span>\nBuild Cache                                                 0B                  0B</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="虚悬镜像"><a href="#%E8%99%9A%E6%82%AC%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>虚悬镜像</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59368831607034765000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<none>               <none>              00285df0df87        5 days ago          342 MB`, `59368831607034765000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">&lt;</span>none<span class="token operator">></span>               <span class="token operator">&lt;</span>none<span class="token operator">></span>              00285df0df87        <span class="token number">5</span> days ago          <span class="token number">342</span> MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这个镜像原本是有镜像名和标签的，原来为 <code class="language-text">mongo:3.2</code>，随着官方镜像维护，发布了新版本后，重新 <code class="language-text">docker pull mongo:3.2</code> 时，<code class="language-text">mongo:3.2</code> 这个镜像名被转移到了新下载的镜像身上，而旧的镜像上的这个名称则被取消，从而成为了 <code class="language-text">&lt;none&gt;</code>。除了 docker pull 可能导致这种情况，docker build 也同样可以导致这种现象。由于新旧镜像同名，旧镜像名称被取消，从而出现仓库名、标签均为 <code class="language-text">&lt;none&gt;</code> 的镜像。这类无标签镜像也被称为虚悬镜像 (dangling image) ，可以用下面的命令专门显示这类镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70645865494970786000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls -f dangling=true\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\n<none>              <none>              00285df0df87        5 days ago          342 MB`, `70645865494970786000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> -f <span class="token assign-left variable">dangling</span><span class="token operator">=</span>true\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\n<span class="token operator">&lt;</span>none<span class="token operator">></span>              <span class="token operator">&lt;</span>none<span class="token operator">></span>              00285df0df87        <span class="token number">5</span> days ago          <span class="token number">342</span> MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>一般来说，虚悬镜像已经失去了存在的价值，是可以随意删除的，可以用下面的命令删除。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16283429341458188000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image prune`, `16283429341458188000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image prune</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="中间层镜像"><a href="#%E4%B8%AD%E9%97%B4%E5%B1%82%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>中间层镜像</h3>\n<p>为了加速镜像构建、重复利用资源，Docker 会利用中间层镜像。所以在使用一段时间后，可能会看到一些依赖的中间层镜像。默认的 docker image ls 列表中只会显示顶层镜像，如果希望显示包括中间层镜像在内的所有镜像的话，需要加 -a 参数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50712072303173360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls -a`, `50712072303173360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> -a</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这样会看到很多无标签的镜像，与之前的虚悬镜像不同，这些无标签的镜像很多都是中间层镜像，是其它镜像所依赖的镜像。这些无标签镜像不应该删除，否则会导致上层镜像因为依赖丢失而出错。实际上，这些镜像也没必要删除，因为之前说过，相同的层只会存一遍，而这些镜像是别的镜像的依赖，因此并不会因为它们被列出来而多存了一份，无论如何你也会需要它们。只要删除那些依赖它们的镜像后，这些依赖的中间层镜像也会被连带删除。</p>\n<h3 id="列出部分镜像"><a href="#%E5%88%97%E5%87%BA%E9%83%A8%E5%88%86%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>列出部分镜像</h3>\n<p>不加任何参数的情况下，docker image ls 会列出所有顶层镜像，但是有时候我们只希望列出部分镜像。docker image ls 有好几个参数可以帮助做到这个事情。</p>\n<p>根据仓库名列出镜像</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18457784110061847000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls ubuntu\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nubuntu              18.04               329ed837d508        3 days ago          63.3MB\nubuntu              bionic              329ed837d508        3 days ago          63.3MB`, `18457784110061847000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> ubuntu\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nubuntu              <span class="token number">18.04</span>               329ed837d508        <span class="token number">3</span> days ago          <span class="token number">63</span>.3MB\nubuntu              bionic              329ed837d508        <span class="token number">3</span> days ago          <span class="token number">63</span>.3MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>列出特定的某个镜像，也就是说指定仓库名和标签</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56753109278495550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls ubuntu:18.04\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nubuntu              18.04               329ed837d508        3 days ago          63.3MB`, `56753109278495550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> ubuntu:18.04\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nubuntu              <span class="token number">18.04</span>               329ed837d508        <span class="token number">3</span> days ago          <span class="token number">63</span>.3MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>除此以外，docker image ls 还支持强大的过滤器参数 <code class="language-text">--filter</code>，或者简写 -f。之前我们已经看到了使用过滤器来列出虚悬镜像的用法，它还有更多的用法。比如，我们希望看到在 <code class="language-text">mongo:3.2</code> 之后建立的镜像，可以用下面的命令：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29134299881695470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls -f since=mongo:3.2\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nredis               latest              5f515359c7f8        5 days ago          183 MB\nnginx               latest              05a60462f8ba        5 days ago          181 MB`, `29134299881695470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> -f <span class="token assign-left variable">since</span><span class="token operator">=</span>mongo:3.2\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nredis               latest              5f515359c7f8        <span class="token number">5</span> days ago          <span class="token number">183</span> MB\nnginx               latest              05a60462f8ba        <span class="token number">5</span> days ago          <span class="token number">181</span> MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>想查看某个位置之前的镜像也可以，只需要把 since 换成 before 即可。</p>\n<p>此外，如果镜像构建时，定义了 LABEL，还可以通过 LABEL 来过滤。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42092787362139910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls -f label=com.example.version=0.1`, `42092787362139910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> -f <span class="token assign-left variable">label</span><span class="token operator">=</span>com.example.version<span class="token operator">=</span><span class="token number">0.1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="以特定格式显示"><a href="#%E4%BB%A5%E7%89%B9%E5%AE%9A%E6%A0%BC%E5%BC%8F%E6%98%BE%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>以特定格式显示</h3>\n<p>默认情况下，docker image ls 会输出一个完整的表格，但是我们并非所有时候都会需要这些内容。比如，刚才删除虚悬镜像的时候，我们需要利用 docker image ls 把所有的虚悬镜像的 ID 列出来，然后才可以交给 docker image rm 命令作为参数来删除指定的这些镜像，这个时候就用到了 -q 参数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30022932943736726000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls -q\n5f515359c7f8\n05a60462f8ba\nfe9198c04d62\n00285df0df87\n329ed837d508\n329ed837d508`, `30022932943736726000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> -q\n5f515359c7f8\n05a60462f8ba\nfe9198c04d62\n00285df0df87\n329ed837d508\n329ed837d508</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>—filter 配合 -q 产生出指定范围的 ID 列表，然后送给另一个 docker 命令作为参数，从而针对这组实体成批的进行某种操作的做法在 Docker 命令行使用过程中非常常见，不仅仅是镜像，将来我们会在各个命令中看到这类搭配以完成很强大的功能。因此每次在文档看到过滤器后，可以多注意一下它们的用法。</p>\n<p>另外一些时候，我们可能只是对表格的结构不满意，希望自己组织列；或者不希望有标题，这样方便其它程序解析结果等，这就用到了 Go 的模板语法。</p>\n<p>比如，下面的命令会直接列出镜像结果，并且只包含镜像 ID 和仓库名：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18770269314891895000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls --format &quot;{{.ID}}: {{.Repository}}&quot;\n5f515359c7f8: redis\n05a60462f8ba: nginx\nfe9198c04d62: mongo\n00285df0df87: <none>\n329ed837d508: ubuntu\n329ed837d508: ubuntu`, `18770269314891895000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> --format <span class="token string">"{{.ID}}: {{.Repository}}"</span>\n5f515359c7f8: redis\n05a60462f8ba: nginx\nfe9198c04d62: mongo\n00285df0df87: <span class="token operator">&lt;</span>none<span class="token operator">></span>\n329ed837d508: ubuntu\n329ed837d508: ubuntu</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>或者打算以表格等距显示，并且有标题行，和默认一样，不过自己定义列：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49769546277190476000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls --format &quot;table {{.ID}}\\t{{.Repository}}\\t{{.Tag}}&quot;\nIMAGE ID            REPOSITORY          TAG\n5f515359c7f8        redis               latest\n05a60462f8ba        nginx               latest\nfe9198c04d62        mongo               3.2\n00285df0df87        <none>              <none>\n329ed837d508        ubuntu              18.04\n329ed837d508        ubuntu              bionic`, `49769546277190476000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> --format <span class="token string">"table {{.ID}}<span class="token entity" title="\\t">\\t</span>{{.Repository}}<span class="token entity" title="\\t">\\t</span>{{.Tag}}"</span>\nIMAGE ID            REPOSITORY          TAG\n5f515359c7f8        redis               latest\n05a60462f8ba        nginx               latest\nfe9198c04d62        mongo               <span class="token number">3.2</span>\n00285df0df87        <span class="token operator">&lt;</span>none<span class="token operator">></span>              <span class="token operator">&lt;</span>none<span class="token operator">></span>\n329ed837d508        ubuntu              <span class="token number">18.04</span>\n329ed837d508        ubuntu              bionic</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="删除本地镜像"><a href="#%E5%88%A0%E9%99%A4%E6%9C%AC%E5%9C%B0%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>删除本地镜像</h2>\n<p>如果要删除本地的镜像，可以使用 docker image rm 命令，其格式为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9441533361309262000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image rm [选项] <镜像1> [<镜像2> ...]`, `9441533361309262000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">rm</span> <span class="token punctuation">[</span>选项<span class="token punctuation">]</span> <span class="token operator">&lt;</span>镜像<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>镜像<span class="token operator"><span class="token file-descriptor important">2</span>></span> <span class="token punctuation">..</span>.<span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="用-id、镜像名、摘要删除镜像"><a href="#%E7%94%A8-id%E3%80%81%E9%95%9C%E5%83%8F%E5%90%8D%E3%80%81%E6%91%98%E8%A6%81%E5%88%A0%E9%99%A4%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>用 ID、镜像名、摘要删除镜像</h3>\n<p>其中，&#x3C;镜像> 可以是 镜像短 ID、镜像长 ID、镜像名或者镜像摘要。</p>\n<p>比如我们有这么一些镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91314043873223620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls\nREPOSITORY                  TAG                 IMAGE ID            CREATED             SIZE\ncentos                      latest              0584b3d2cf6d        3 weeks ago         196.5 MB\nredis                       alpine              501ad78535f0        3 weeks ago         21.03 MB\ndocker                      latest              cf693ec9b5c7        3 weeks ago         105.1 MB\nnginx                       latest              e43d811ce2f4        5 weeks ago         181.5 MB`, `91314043873223620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span>\nREPOSITORY                  TAG                 IMAGE ID            CREATED             SIZE\ncentos                      latest              0584b3d2cf6d        <span class="token number">3</span> weeks ago         <span class="token number">196.5</span> MB\nredis                       alpine              501ad78535f0        <span class="token number">3</span> weeks ago         <span class="token number">21.03</span> MB\ndocker                      latest              cf693ec9b5c7        <span class="token number">3</span> weeks ago         <span class="token number">105.1</span> MB\nnginx                       latest              e43d811ce2f4        <span class="token number">5</span> weeks ago         <span class="token number">181.5</span> MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41988874484499530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image rm 501\n\\$ docker image rm centos`, `41988874484499530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">rm</span> <span class="token number">501</span>\n$ docker image <span class="token function">rm</span> centos</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>当然，更精确的是使用镜像摘要删除镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30550841104654758000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls --digests\nREPOSITORY                  TAG                 DIGEST                                                                    IMAGE ID            CREATED             SIZE\nnode                        slim                sha256:b4f0e0bdeb578043c1ea6862f0d40cc4afe32a4a582f3be235a3b164422be228   6e0c4c8e3913        3 weeks ago         214 MB\n\n\\$ docker image rm node@sha256:b4f0e0bdeb578043c1ea6862f0d40cc4afe32a4a582f3be235a3b164422be228\nUntagged: node@sha256:b4f0e0bdeb578043c1ea6862f0d40cc4afe32a4a582f3be235a3b164422be228`, `30550841104654758000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> --digests\nREPOSITORY                  TAG                 DIGEST                                                                    IMAGE ID            CREATED             SIZE\nnode                        slim                sha256:b4f0e0bdeb578043c1ea6862f0d40cc4afe32a4a582f3be235a3b164422be228   6e0c4c8e3913        <span class="token number">3</span> weeks ago         <span class="token number">214</span> MB\n\n$ docker image <span class="token function">rm</span> node@sha256:b4f0e0bdeb578043c1ea6862f0d40cc4afe32a4a582f3be235a3b164422be228\nUntagged: node@sha256:b4f0e0bdeb578043c1ea6862f0d40cc4afe32a4a582f3be235a3b164422be228</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="untagged-和-deleted"><a href="#untagged-%E5%92%8C-deleted" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Untagged 和 Deleted</h3>\n<p>删除行为分为两类，一类是 Untagged，另一类是 Deleted。我们之前介绍过，镜像的唯一标识是其 ID 和摘要，而一个镜像可以有多个标签。</p>\n<p>因此当我们使用上面命令删除镜像的时候，实际上是在要求删除某个标签的镜像。所以首先需要做的是将满足我们要求的所有镜像标签都取消，这就是我们看到的 Untagged 的信息。因为一个镜像可以对应多个标签，因此当我们删除了所指定的标签后，可能还有别的标签指向了这个镜像，如果是这种情况，那么 Delete 行为就不会发生。所以并非所有的 docker image rm 都会产生删除镜像的行为，有可能仅仅是取消了某个标签而已。</p>\n<p>当该镜像所有的标签都被取消了，该镜像很可能会失去了存在的意义，因此会触发删除行为。镜像是多层存储结构，因此在删除的时候也是从上层向基础层方向依次进行判断删除。镜像的多层结构让镜像复用变得非常容易，因此很有可能某个其它镜像正依赖于当前镜像的某一层。这种情况，依旧不会触发删除该层的行为。直到没有任何层依赖当前层时，才会真实的删除当前层。这就是为什么，有时候会奇怪，为什么明明没有别的标签指向这个镜像，但是它还是存在的原因，也是为什么有时候会发现所删除的层数和自己 docker pull 看到的层数不一样的原因。</p>\n<p>除了镜像依赖以外，还需要注意的是容器对镜像的依赖。如果有用这个镜像启动的容器存在（即使容器没有运行），那么同样不可以删除这个镜像。之前讲过，容器是以镜像为基础，再加一层容器存储层，组成这样的多层存储结构去运行的。因此该镜像如果被这个容器所依赖的，那么删除必然会导致故障。如果这些容器是不需要的，应该先将它们删除，然后再来删除镜像。</p>\n<h3 id="用-docker-image-ls-命令来配合"><a href="#%E7%94%A8-docker-image-ls-%E5%91%BD%E4%BB%A4%E6%9D%A5%E9%85%8D%E5%90%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>用 docker image ls 命令来配合</h3>\n<p>像其它可以承接多个实体的命令一样，可以使用 docker image ls -q 来配合使用 docker image rm，这样可以成批的删除希望删除的镜像。我们在“镜像列表”章节介绍过很多过滤镜像列表的方式都可以拿过来使用。</p>\n<p>比如，我们需要删除所有仓库名为 redis 的镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34476764943746740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image rm \\$(docker image ls -q redis)`, `34476764943746740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">rm</span> <span class="token variable"><span class="token variable">$(</span>docker image <span class="token function">ls</span> -q redis<span class="token variable">)</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>或者删除所有在 <code class="language-text">mongo:3.2</code> 之前的镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74782928436584370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image rm \\$(docker image ls -q -f before=mongo:3.2)`, `74782928436584370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">rm</span> <span class="token variable"><span class="token variable">$(</span>docker image <span class="token function">ls</span> -q -f <span class="token assign-left variable">before</span><span class="token operator">=</span>mongo:3.2<span class="token variable">)</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>充分利用你的想象力和 Linux 命令行的强大，你可以完成很多非常赞的功能。</p>\n<h2 id="利用-commit-理解镜像构成"><a href="#%E5%88%A9%E7%94%A8-commit-%E7%90%86%E8%A7%A3%E9%95%9C%E5%83%8F%E6%9E%84%E6%88%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>利用 commit 理解镜像构成</h2>\n<p>让我们以定制一个 Web 服务器为例子，来讲解镜像是如何构建的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27818103430055660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run --name webserver -d -p 80:80 nginx`, `27818103430055660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run --name webserver -d -p <span class="token number">80</span>:80 nginx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这条命令会用 nginx 镜像启动一个容器，命名为 webserver，并且映射了 80 端口，这样我们可以用浏览器去访问这个 nginx 服务器。</p>\n<p>如果是在本机运行的 Docker，那么可以直接访问：<code class="language-text">http://localhost</code> ，如果是在虚拟机、云服务器上安装的 Docker，则需要将 localhost 换为虚拟机地址或者实际云服务器地址。</p>\n<p>直接用浏览器访问的话，我们会看到默认的 Nginx 欢迎页面。</p>\n<p>现在，假设我们非常不喜欢这个欢迎页面，我们希望改成欢迎 Docker 的文字，我们可以使用 docker exec 命令进入容器，修改其内容。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5945021512649551000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker exec -it webserver bash\nroot@3729b97e8226:/# echo \'<h1>Hello, Docker!</h1>\' > /usr/share/nginx/html/index.html\nroot@3729b97e8226:/# exit\nexit`, `5945021512649551000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token builtin class-name">exec</span> -it webserver <span class="token function">bash</span>\nroot@3729b97e8226:/<span class="token comment"># echo \'&lt;h1>Hello, Docker!&lt;/h1>\' > /usr/share/nginx/html/index.html</span>\nroot@3729b97e8226:/<span class="token comment"># exit</span>\n<span class="token builtin class-name">exit</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们以交互式终端方式进入 webserver 容器，并执行了 bash 命令，也就是获得一个可操作的 Shell。</p>\n<p>然后，我们用 <code class="language-text">&lt;h1&gt;Hello, Docker!&lt;/h1&gt;</code> 覆盖了 <code class="language-text">/usr/share/nginx/html/index.html</code> 的内容。</p>\n<p>现在我们再刷新浏览器的话，会发现内容被改变了。</p>\n<p>我们修改了容器的文件，也就是改动了容器的存储层。我们可以通过 docker diff 命令看到具体的改动。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15124367169853348000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker diff webserver\nC /root\nA /root/.bash_history\nC /run\nC /usr\nC /usr/share\nC /usr/share/nginx\nC /usr/share/nginx/html\nC /usr/share/nginx/html/index.html\nC /var\nC /var/cache\nC /var/cache/nginx\nA /var/cache/nginx/client_temp\nA /var/cache/nginx/fastcgi_temp\nA /var/cache/nginx/proxy_temp\nA /var/cache/nginx/scgi_temp\nA /var/cache/nginx/uwsgi_temp`, `15124367169853348000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">diff</span> webserver\nC /root\nA /root/.bash_history\nC /run\nC /usr\nC /usr/share\nC /usr/share/nginx\nC /usr/share/nginx/html\nC /usr/share/nginx/html/index.html\nC /var\nC /var/cache\nC /var/cache/nginx\nA /var/cache/nginx/client_temp\nA /var/cache/nginx/fastcgi_temp\nA /var/cache/nginx/proxy_temp\nA /var/cache/nginx/scgi_temp\nA /var/cache/nginx/uwsgi_temp</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在我们定制好了变化，我们希望能将其保存下来形成镜像。</p>\n<p>要知道，当我们运行一个容器的时候（如果不使用卷的话），我们做的任何文件修改都会被记录于容器存储层里。而 Docker 提供了一个 docker commit 命令，可以将容器的存储层保存下来成为镜像。换句话说，就是在原有镜像的基础上，再叠加上容器的存储层，并构成新的镜像。以后我们运行这个新镜像的时候，就会拥有原有容器最后的文件变化。</p>\n<p>docker commit 的语法格式为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55193955466685220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker commit [选项] <容器ID或容器名> [<仓库名>[:<标签>]]`, `55193955466685220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker commit <span class="token punctuation">[</span>选项<span class="token punctuation">]</span> <span class="token operator">&lt;</span>容器ID或容器名<span class="token operator">></span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>仓库名<span class="token operator">></span><span class="token punctuation">[</span>:<span class="token operator">&lt;</span>标签<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>我们可以用下面的命令将容器保存为镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68399843984988440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker commit \\\n    --author &quot;Tao Wang <twang2218@gmail.com>&quot; \\\n    --message &quot;修改了默认网页&quot; \\\n    webserver \\\n    nginx:v2\nsha256:07e33465974800ce65751acc279adc6ed2dc5ed4e0838f8b86f0c87aa1795214`, `68399843984988440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker commit <span class="token punctuation">\\</span>\n    --author <span class="token string">"Tao Wang &lt;twang2218@gmail.com>"</span> <span class="token punctuation">\\</span>\n    --message <span class="token string">"修改了默认网页"</span> <span class="token punctuation">\\</span>\n    webserver <span class="token punctuation">\\</span>\n    nginx:v2\nsha256:07e33465974800ce65751acc279adc6ed2dc5ed4e0838f8b86f0c87aa1795214</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其中 —author 是指定修改的作者，而 —message 则是记录本次修改的内容。这点和 git 版本控制相似，不过这里这些信息可以省略留空。</p>\n<p>我们可以在 docker image ls 中看到这个新定制的镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21560537028223400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls nginx\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nnginx               v2                  07e334659748        9 seconds ago       181.5 MB\nnginx               1.11                05a60462f8ba        12 days ago         181.5 MB\nnginx               latest              e43d811ce2f4        4 weeks ago         181.5 MB`, `21560537028223400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> nginx\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nnginx               v2                  07e334659748        <span class="token number">9</span> seconds ago       <span class="token number">181.5</span> MB\nnginx               <span class="token number">1.11</span>                05a60462f8ba        <span class="token number">12</span> days ago         <span class="token number">181.5</span> MB\nnginx               latest              e43d811ce2f4        <span class="token number">4</span> weeks ago         <span class="token number">181.5</span> MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们还可以用 docker history 具体查看镜像内的历史记录，如果比较 <code class="language-text">nginx:latest</code> 的历史记录，我们会发现新增了我们刚刚提交的这一层。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31798752646849126000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker history nginx:v2\nIMAGE               CREATED             CREATED BY                                      SIZE                COMMENT\n07e334659748        54 seconds ago      nginx -g daemon off;                            95 B                修改了默认网页\ne43d811ce2f4        4 weeks ago         /bin/sh -c #(nop)  CMD [&quot;nginx&quot; &quot;-g&quot; &quot;daemon    0 B\n<missing>           4 weeks ago         /bin/sh -c #(nop)  EXPOSE 443/tcp 80/tcp        0 B\n<missing>           4 weeks ago         /bin/sh -c ln -sf /dev/stdout /var/log/nginx/   22 B\n<missing>           4 weeks ago         /bin/sh -c apt-key adv --keyserver hkp://pgp.   58.46 MB\n<missing>           4 weeks ago         /bin/sh -c #(nop)  ENV NGINX_VERSION=1.11.5-1   0 B\n<missing>           4 weeks ago         /bin/sh -c #(nop)  MAINTAINER NGINX Docker Ma   0 B\n<missing>           4 weeks ago         /bin/sh -c #(nop)  CMD [&quot;/bin/bash&quot;]            0 B\n<missing>           4 weeks ago         /bin/sh -c #(nop) ADD file:23aa4f893e3288698c   123 MB`, `31798752646849126000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">history</span> nginx:v2\nIMAGE               CREATED             CREATED BY                                      SIZE                COMMENT\n07e334659748        <span class="token number">54</span> seconds ago      nginx -g daemon off<span class="token punctuation">;</span>                            <span class="token number">95</span> B                修改了默认网页\ne43d811ce2f4        <span class="token number">4</span> weeks ago         /bin/sh -c <span class="token comment">#(nop)  CMD ["nginx" "-g" "daemon    0 B</span>\n<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">4</span> weeks ago         /bin/sh -c <span class="token comment">#(nop)  EXPOSE 443/tcp 80/tcp        0 B</span>\n<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">4</span> weeks ago         /bin/sh -c <span class="token function">ln</span> -sf /dev/stdout /var/log/nginx/   <span class="token number">22</span> B\n<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">4</span> weeks ago         /bin/sh -c apt-key adv --keyserver hkp://pgp.   <span class="token number">58.46</span> MB\n<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">4</span> weeks ago         /bin/sh -c <span class="token comment">#(nop)  ENV NGINX_VERSION=1.11.5-1   0 B</span>\n<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">4</span> weeks ago         /bin/sh -c <span class="token comment">#(nop)  MAINTAINER NGINX Docker Ma   0 B</span>\n<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">4</span> weeks ago         /bin/sh -c <span class="token comment">#(nop)  CMD ["/bin/bash"]            0 B</span>\n<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">4</span> weeks ago         /bin/sh -c <span class="token comment">#(nop) ADD file:23aa4f893e3288698c   123 MB</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>新的镜像定制好后，我们可以来运行这个镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88686784736159990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker run --name web2 -d -p 81:80 nginx:v2`, `88686784736159990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker run --name web2 -d -p <span class="token number">81</span>:80 nginx:v2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这里我们命名为新的服务为 web2，并且映射到 81 端口。访问 <code class="language-text">http://localhost:81</code> 看到结果，其内容应该和之前修改后的 webserver 一样。</p>\n<p>至此，我们第一次完成了定制镜像，使用的是 docker commit 命令，手动操作给旧的镜像添加了新的一层，形成新的镜像，对镜像多层存储应该有了更直观的感觉。</p>\n<h3 id="慎用-docker-commit"><a href="#%E6%85%8E%E7%94%A8-docker-commit" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>慎用 docker commit</h3>\n<p>使用 docker commit 命令虽然可以比较直观的帮助理解镜像分层存储的概念，但是实际环境中并不会这样使用。</p>\n<p>首先，如果仔细观察之前的 docker diff webserver 的结果，你会发现除了真正想要修改的 /usr/share/nginx/html/index.html 文件外，由于命令的执行，还有很多文件被改动或添加了。这还仅仅是最简单的操作，如果是安装软件包、编译构建，那会有大量的无关内容被添加进来，将会导致镜像极为臃肿。</p>\n<p>此外，使用 docker commit 意味着所有对镜像的操作都是黑箱操作，生成的镜像也被称为黑箱镜像，换句话说，就是除了制作镜像的人知道执行过什么命令、怎么生成的镜像，别人根本无从得知。而且，即使是这个制作镜像的人，过一段时间后也无法记清具体的操作。这种黑箱镜像的维护工作是非常痛苦的。</p>\n<p>而且，回顾之前提及的镜像所使用的分层存储的概念，除当前层外，之前的每一层都是不会发生改变的，换句话说，任何修改的结果仅仅是在当前层进行标记、添加、修改，而不会改动上一层。如果使用 docker commit 制作镜像，以及后期修改的话，每一次修改都会让镜像更加臃肿一次，所删除的上一层的东西并不会丢失，会一直如影随形的跟着这个镜像，即使根本无法访问到。这会让镜像更加臃肿。</p>\n<h2 id="使用-dockerfile-定制镜像"><a href="#%E4%BD%BF%E7%94%A8-dockerfile-%E5%AE%9A%E5%88%B6%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 Dockerfile 定制镜像</h2>\n<p>从刚才的 docker commit 的学习中，我们可以了解到，镜像的定制实际上就是定制每一层所添加的配置、文件。如果我们可以把每一层修改、安装、构建、操作的命令都写入一个脚本，用这个脚本来构建、定制镜像，那么之前提及的无法重复的问题、镜像构建透明性的问题、体积的问题就都会解决。这个脚本就是 Dockerfile。</p>\n<p>Dockerfile 是一个文本文件，其内包含了一条条的指令(Instruction)，每一条指令构建一层，因此每一条指令的内容，就是描述该层应当如何构建。</p>\n<p>还以之前定制 nginx 镜像为例，这次我们使用 Dockerfile 来定制。</p>\n<p>在一个空白目录中，建立一个文本文件，并命名为 Dockerfile：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51943669741491050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ mkdir mynginx\n\\$ cd mynginx\n\\$ touch Dockerfile`, `51943669741491050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">mkdir</span> mynginx\n$ <span class="token builtin class-name">cd</span> mynginx\n$ <span class="token function">touch</span> Dockerfile</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>其内容为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20087378517765250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM nginx\nRUN echo \'<h1>Hello, Docker!</h1>\' > /usr/share/nginx/html/index.html`, `20087378517765250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">FROM nginx\nRUN <span class="token builtin class-name">echo</span> <span class="token string">\'&lt;h1>Hello, Docker!&lt;/h1>\'</span> <span class="token operator">></span> /usr/share/nginx/html/index.html</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这个 Dockerfile 很简单，一共就两行。涉及到了两条指令，FROM 和 RUN。</p>\n<h3 id="from-指定基础镜像"><a href="#from-%E6%8C%87%E5%AE%9A%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>FROM 指定基础镜像</h3>\n<p>所谓定制镜像，那一定是以一个镜像为基础，在其上进行定制。就像我们之前运行了一个 nginx 镜像的容器，再进行修改一样，基础镜像是必须指定的。而 FROM 就是指定基础镜像，因此一个 Dockerfile 中 FROM 是必备的指令，并且必须是第一条指令。</p>\n<p>在 Docker Hub 上有非常多的高质量的官方镜像，有可以直接拿来使用的服务类的镜像，如 nginx、redis、mongo、mysql、httpd、php、tomcat 等；也有一些方便开发、构建、运行各种语言应用的镜像，如 node、openjdk、python、ruby、golang 等。可以在其中寻找一个最符合我们最终目标的镜像为基础镜像进行定制。</p>\n<p>如果没有找到对应服务的镜像，官方镜像中还提供了一些更为基础的操作系统镜像，如 ubuntu、debian、centos、fedora、alpine 等，这些操作系统的软件库为我们提供了更广阔的扩展空间。</p>\n<p>除了选择现有镜像为基础镜像外，Docker 还存在一个特殊的镜像，名为 scratch。这个镜像是虚拟的概念，并不实际存在，它表示一个空白的镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53817497259286530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM scratch\n...`, `53817497259286530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">FROM scratch\n<span class="token punctuation">..</span>.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果你以 scratch 为基础镜像的话，意味着你不以任何镜像为基础，接下来所写的指令将作为镜像第一层开始存在。</p>\n<p>不以任何系统为基础，直接将可执行文件复制进镜像的做法并不罕见，对于 Linux 下静态编译的程序来说，并不需要有操作系统提供运行时支持，所需的一切库都已经在可执行文件里了，因此直接 FROM scratch 会让镜像体积更加小巧。使用 Go 语言开发的应用很多会使用这种方式来制作镜像，这也是为什么有人认为 Go 是特别适合容器微服务架构的语言的原因之一。</p>\n<h3 id="run-执行命令"><a href="#run-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RUN 执行命令</h3>\n<p>RUN 指令是用来执行命令行命令的。由于命令行的强大能力，RUN 指令在定制镜像时是最常用的指令之一。其格式有两种：</p>\n<ul>\n<li>\n<p>shell 格式：<code class="language-text">RUN &lt;命令&gt;</code>，就像直接在命令行中输入的命令一样。刚才写的 Dockerfile 中的 RUN 指令就是这种格式。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69089029671556390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RUN echo \'<h1>Hello, Docker!</h1>\' > /usr/share/nginx/html/index.html`, `69089029671556390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">RUN <span class="token builtin class-name">echo</span> <span class="token string">\'&lt;h1>Hello, Docker!&lt;/h1>\'</span> <span class="token operator">></span> /usr/share/nginx/html/index.html</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n</li>\n<li>\n<p>exec 格式：RUN [“可执行文件”, “参数 1”, “参数 2”]，这更像是函数调用中的格式。</p>\n</li>\n</ul>\n<p>既然 RUN 就像 Shell 脚本一样可以执行命令，那么我们是否就可以像 Shell 脚本一样把每个命令对应一个 RUN 呢？比如这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87429002515968880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM debian:stretch\n\nRUN apt-get update\nRUN apt-get install -y gcc libc6-dev make wget\nRUN wget -O redis.tar.gz &quot;http://download.redis.io/releases/redis-5.0.3.tar.gz&quot;\nRUN mkdir -p /usr/src/redis\nRUN tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1\nRUN make -C /usr/src/redis\nRUN make -C /usr/src/redis install`, `87429002515968880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">FROM debian:stretch\n\nRUN <span class="token function">apt-get</span> update\nRUN <span class="token function">apt-get</span> <span class="token function">install</span> -y gcc libc6-dev <span class="token function">make</span> <span class="token function">wget</span>\nRUN <span class="token function">wget</span> -O redis.tar.gz <span class="token string">"http://download.redis.io/releases/redis-5.0.3.tar.gz"</span>\nRUN <span class="token function">mkdir</span> -p /usr/src/redis\nRUN <span class="token function">tar</span> -xzf redis.tar.gz -C /usr/src/redis --strip-components<span class="token operator">=</span><span class="token number">1</span>\nRUN <span class="token function">make</span> -C /usr/src/redis\nRUN <span class="token function">make</span> -C /usr/src/redis <span class="token function">install</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>之前说过，Dockerfile 中每一个指令都会建立一层，RUN 也不例外。每一个 RUN 的行为，就和刚才我们手工建立镜像的过程一样：新建立一层，在其上执行这些命令，执行结束后，commit 这一层的修改，构成新的镜像。</p>\n<p>而上面的这种写法，创建了 7 层镜像。这是完全没有意义的，而且很多运行时不需要的东西，都被装进了镜像里，比如编译环境、更新的软件包等等。结果就是产生非常臃肿、非常多层的镜像，不仅仅增加了构建部署的时间，也很容易出错。 这是很多初学 Docker 的人常犯的一个错误。</p>\n<p>Union FS 是有最大层数限制的，比如 AUFS，曾经是最大不得超过 42 层，现在是不得超过 127 层。</p>\n<p>上面的 Dockerfile 正确的写法应该是这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20873679422991143000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM debian:stretch\n\nRUN set -x; buildDeps=\'gcc libc6-dev make wget\' \\\n    && apt-get update \\\n    && apt-get install -y \\$buildDeps \\\n    && wget -O redis.tar.gz &quot;http://download.redis.io/releases/redis-5.0.3.tar.gz&quot; \\\n    && mkdir -p /usr/src/redis \\\n    && tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1 \\\n    && make -C /usr/src/redis \\\n    && make -C /usr/src/redis install \\\n    && rm -rf /var/lib/apt/lists/* \\\n    && rm redis.tar.gz \\\n    && rm -r /usr/src/redis \\\n    && apt-get purge -y --auto-remove \\$buildDeps`, `20873679422991143000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">FROM debian:stretch\n\nRUN <span class="token builtin class-name">set</span> -x<span class="token punctuation">;</span> <span class="token assign-left variable">buildDeps</span><span class="token operator">=</span><span class="token string">\'gcc libc6-dev make wget\'</span> <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> update <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y <span class="token variable">$buildDeps</span> <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">wget</span> -O redis.tar.gz <span class="token string">"http://download.redis.io/releases/redis-5.0.3.tar.gz"</span> <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> -p /usr/src/redis <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">tar</span> -xzf redis.tar.gz -C /usr/src/redis --strip-components<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> -C /usr/src/redis <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> -C /usr/src/redis <span class="token function">install</span> <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> -rf /var/lib/apt/lists/* <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> redis.tar.gz <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> -r /usr/src/redis <span class="token punctuation">\\</span>\n    <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> purge -y --auto-remove <span class="token variable">$buildDeps</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>首先，之前所有的命令只有一个目的，就是编译、安装 redis 可执行文件。因此没有必要建立很多层，这只是一层的事情。因此，这里没有使用很多个 RUN 一一对应不同的命令，而是仅仅使用一个 RUN 指令，并使用 &#x26;&#x26; 将各个所需命令串联起来，将之前的 7 层 简化为了 1 层。在撰写 Dockerfile 的时候，要经常提醒自己，这并不是在写 Shell 脚本，而是在定义每一层该如何构建。</p>\n<p>并且，这里为了格式化还进行了换行。Dockerfile 支持 Shell 类的行尾添加 \\ 的命令换行方式，以及行首 # 进行注释的格式。良好的格式，比如换行、缩进、注释等，会让维护、排障更为容易，这是一个比较好的习惯。</p>\n<p>此外，还可以看到这一组命令的最后添加了清理工作的命令，删除了为了编译构建所需要的软件，清理了所有下载、展开的文件，并且还清理了 apt 缓存文件。这是很重要的一步，我们之前说过，镜像是多层存储，每一层的东西并不会在下一层被删除，会一直跟随着镜像。因此镜像构建时，一定要确保每一层只添加真正需要添加的东西，任何无关的东西都应该清理掉。</p>\n<p>很多人初学 Docker 制作出了很臃肿的镜像的原因之一，就是忘记了每一层构建的最后一定要清理掉无关文件。</p>\n<h3 id="构建镜像"><a href="#%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建镜像</h3>\n<p>好了，让我们再回到之前定制的 nginx 镜像的 Dockerfile 来。现在我们明白了这个 Dockerfile 的内容，那么让我们来构建这个镜像吧。</p>\n<p>在 Dockerfile 文件所在目录执行：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97735761871885710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker build -t nginx:v3 .\nSending build context to Docker daemon 2.048 kB\nStep 1 : FROM nginx\n ---> e43d811ce2f4\nStep 2 : RUN echo \'<h1>Hello, Docker!</h1>\' > /usr/share/nginx/html/index.html\n ---> Running in 9cdc27646c7b\n ---> 44aa4490ce2c\nRemoving intermediate container 9cdc27646c7b\nSuccessfully built 44aa4490ce2c`, `97735761871885710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker build -t nginx:v3 <span class="token builtin class-name">.</span>\nSending build context to Docker daemon <span class="token number">2.048</span> kB\nStep <span class="token number">1</span> <span class="token builtin class-name">:</span> FROM nginx\n ---<span class="token operator">></span> e43d811ce2f4\nStep <span class="token number">2</span> <span class="token builtin class-name">:</span> RUN <span class="token builtin class-name">echo</span> <span class="token string">\'&lt;h1>Hello, Docker!&lt;/h1>\'</span> <span class="token operator">></span> /usr/share/nginx/html/index.html\n ---<span class="token operator">></span> Running <span class="token keyword">in</span> 9cdc27646c7b\n ---<span class="token operator">></span> 44aa4490ce2c\nRemoving intermediate container 9cdc27646c7b\nSuccessfully built 44aa4490ce2c</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从命令的输出结果中，我们可以清晰的看到镜像的构建过程。在 Step 2 中，如同我们之前所说的那样，RUN 指令启动了一个容器 9cdc27646c7b，执行了所要求的命令，并最后提交了这一层 44aa4490ce2c，随后删除了所用到的这个容器 9cdc27646c7b。</p>\n<p>这里我们使用了 docker build 命令进行镜像构建。其格式为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90233658271129940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker build [选项] <上下文路径/URL/->`, `90233658271129940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker build <span class="token punctuation">[</span>选项<span class="token punctuation">]</span> <span class="token operator">&lt;</span>上下文路径/URL/-<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>在这里我们指定了最终镜像的名称 <code class="language-text">-t nginx:v3</code>，构建成功后，我们可以像之前运行 nginx:v2 那样来运行这个镜像，其结果会和 nginx:v2 一样。</p>\n<h3 id="镜像构建上下文（context）"><a href="#%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E4%B8%8A%E4%B8%8B%E6%96%87%EF%BC%88context%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>镜像构建上下文（Context）</h3>\n<p>如果注意，会看到 docker build 命令最后有一个 <code class="language-text">.</code>。<code class="language-text">.</code> 表示当前目录，而 Dockerfile 就在当前目录，因此不少初学者以为这个路径是在指定 Dockerfile 所在路径，这么理解其实是不准确的。如果对应上面的命令格式，你可能会发现，这是在指定上下文路径。那么什么是上下文呢？</p>\n<p>首先我们要理解 docker build 的工作原理。Docker 在运行时分为 Docker 引擎（也就是服务端守护进程）和客户端工具。Docker 的引擎提供了一组 REST API，被称为 Docker Remote API，而如 docker 命令这样的客户端工具，则是通过这组 API 与 Docker 引擎交互，从而完成各种功能。因此，虽然表面上我们好像是在本机执行各种 docker 功能，但实际上，一切都是使用的远程调用形式在服务端（Docker 引擎）完成。也因为这种 C/S 设计，让我们操作远程服务器的 Docker 引擎变得轻而易举。</p>\n<p>当我们进行镜像构建的时候，并非所有定制都会通过 RUN 指令完成，经常会需要将一些本地文件复制进镜像，比如通过 COPY 指令、ADD 指令等。而 docker build 命令构建镜像，其实并非在本地构建，而是在服务端，也就是 Docker 引擎中构建的。那么在这种客户端/服务端的架构中，如何才能让服务端获得本地文件呢？</p>\n<p>这就引入了上下文的概念。当构建的时候，用户会指定构建镜像上下文的路径，docker build 命令得知这个路径后，会将路径下的所有内容打包，然后上传给 Docker 引擎。这样 Docker 引擎收到这个上下文包后，展开就会获得构建镜像所需的一切文件。</p>\n<p>如果在 Dockerfile 中这么写：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56414548820430930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`COPY ./package.json /app/`, `56414548820430930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">COPY ./package.json /app/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这并不是要复制执行 docker build 命令所在的目录下的 package.json，也不是复制 Dockerfile 所在目录下的 package.json，而是复制上下文（context）目录下的 package.json。</p>\n<p>因此，COPY 这类指令中的源文件的路径都是相对路径。这也是初学者经常会问的为什么 <code class="language-text">COPY ../package.json /app</code> 或者 <code class="language-text">COPY /opt/xxxx /app</code> 无法工作的原因，因为这些路径已经超出了上下文的范围，Docker 引擎无法获得这些位置的文件。如果真的需要那些文件，应该将它们复制到上下文目录中去。</p>\n<p>现在就可以理解刚才的命令 <code class="language-text">docker build -t nginx:v3 .</code> 中的这个 <code class="language-text">.</code>，实际上是在指定上下文的目录，docker build 命令会将该目录下的内容打包交给 Docker 引擎以帮助构建镜像。</p>\n<p>如果观察 docker build 输出，我们其实已经看到了这个发送上下文的过程：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86837043739437630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker build -t nginx:v3 .\nSending build context to Docker daemon 2.048 kB\n...`, `86837043739437630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker build -t nginx:v3 <span class="token builtin class-name">.</span>\nSending build context to Docker daemon <span class="token number">2.048</span> kB\n<span class="token punctuation">..</span>.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>理解构建上下文对于镜像构建是很重要的，避免犯一些不应该的错误。比如有些初学者在发现 <code class="language-text">COPY /opt/xxxx /app</code> 不工作后，于是干脆将 Dockerfile 放到了硬盘根目录去构建，结果发现 docker build 执行后，在发送一个几十 GB 的东西，极为缓慢而且很容易构建失败。那是因为这种做法是在让 docker build 打包整个硬盘，这显然是使用错误。</p>\n<p>一般来说，应该会将 Dockerfile 置于一个空目录下，或者项目根目录下。如果该目录下没有所需文件，那么应该把所需文件复制一份过来。如果目录下有些东西确实不希望构建时传给 Docker 引擎，那么可以用 .gitignore 一样的语法写一个 .dockerignore，该文件是用于剔除不需要作为上下文传递给 Docker 引擎的。</p>\n<p>那么为什么会有人误以为 <code class="language-text">.</code> 是指定 Dockerfile 所在目录呢？这是因为在默认情况下，如果不额外指定 Dockerfile 的话，会将上下文目录下的名为 Dockerfile 的文件作为 Dockerfile。</p>\n<p>这只是默认行为，实际上 Dockerfile 的文件名并不要求必须为 Dockerfile，而且并不要求必须位于上下文目录中，比如可以用 -f ../Dockerfile.php 参数指定某个文件作为 Dockerfile。</p>\n<p>当然，一般大家习惯性的会使用默认的文件名 Dockerfile，以及会将其置于镜像构建上下文目录中。</p>\n<h3 id="其它-docker-build-的用法"><a href="#%E5%85%B6%E5%AE%83-docker-build-%E7%9A%84%E7%94%A8%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其它 docker build 的用法</h3>\n<h4 id="直接用-git-repo-进行构建"><a href="#%E7%9B%B4%E6%8E%A5%E7%94%A8-git-repo-%E8%BF%9B%E8%A1%8C%E6%9E%84%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>直接用 Git repo 进行构建</h4>\n<p>或许你已经注意到了，docker build 还支持从 URL 构建，比如可以直接从 Git repo 中构建：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45677597869018010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# \\$env:DOCKER_BUILDKIT=0\n# export DOCKER_BUILDKIT=0\n\n\\$ docker build -t hello-world https://github.com/docker-library/hello-world.git#master:amd64/hello-world\n\nStep 1/3 : FROM scratch\n --->\nStep 2/3 : COPY hello /\n ---> ac779757d46e\nStep 3/3 : CMD [&quot;/hello&quot;]\n ---> Running in d2a513a760ed\nRemoving intermediate container d2a513a760ed\n ---> 038ad4142d2b\nSuccessfully built 038ad4142d2b`, `45677597869018010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># $env:DOCKER_BUILDKIT=0</span>\n<span class="token comment"># export DOCKER_BUILDKIT=0</span>\n\n$ docker build -t hello-world https://github.com/docker-library/hello-world.git<span class="token comment">#master:amd64/hello-world</span>\n\nStep <span class="token number">1</span>/3 <span class="token builtin class-name">:</span> FROM scratch\n ---<span class="token operator">></span>\nStep <span class="token number">2</span>/3 <span class="token builtin class-name">:</span> COPY hello /\n ---<span class="token operator">></span> ac779757d46e\nStep <span class="token number">3</span>/3 <span class="token builtin class-name">:</span> CMD <span class="token punctuation">[</span><span class="token string">"/hello"</span><span class="token punctuation">]</span>\n ---<span class="token operator">></span> Running <span class="token keyword">in</span> d2a513a760ed\nRemoving intermediate container d2a513a760ed\n ---<span class="token operator">></span> 038ad4142d2b\nSuccessfully built 038ad4142d2b</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这行命令指定了构建所需的 Git repo，并且指定分支为 master，构建目录为 /amd64/hello-world/，然后 Docker 就会自己去 git clone 这个项目、切换到指定分支、并进入到指定目录后开始构建。</p>\n<h4 id="用给定的-tar-压缩包构建"><a href="#%E7%94%A8%E7%BB%99%E5%AE%9A%E7%9A%84-tar-%E5%8E%8B%E7%BC%A9%E5%8C%85%E6%9E%84%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>用给定的 tar 压缩包构建</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48864185450838260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker build http://server/context.tar.gz`, `48864185450838260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker build http://server/context.tar.gz</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果所给出的 URL 不是个 Git repo，而是个 tar 压缩包，那么 Docker 引擎会下载这个包，并自动解压缩，以其作为上下文，开始构建。</p>\n<h4 id="从标准输入中读取-dockerfile-进行构建"><a href="#%E4%BB%8E%E6%A0%87%E5%87%86%E8%BE%93%E5%85%A5%E4%B8%AD%E8%AF%BB%E5%8F%96-dockerfile-%E8%BF%9B%E8%A1%8C%E6%9E%84%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>从标准输入中读取 Dockerfile 进行构建</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10194289130903654000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker build - < Dockerfile`, `10194289130903654000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker build - <span class="token operator">&lt;</span> Dockerfile</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>或</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85067841199509400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`cat Dockerfile | docker build -`, `85067841199509400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token function">cat</span> Dockerfile <span class="token operator">|</span> docker build -</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果标准输入传入的是文本文件，则将其视为 Dockerfile，并开始构建。这种形式由于直接从标准输入中读取 Dockerfile 的内容，它没有上下文，因此不可以像其他方法那样可以将本地文件 COPY 进镜像之类的事情。</p>\n<h4 id="从标准输入中读取上下文压缩包进行构建"><a href="#%E4%BB%8E%E6%A0%87%E5%87%86%E8%BE%93%E5%85%A5%E4%B8%AD%E8%AF%BB%E5%8F%96%E4%B8%8A%E4%B8%8B%E6%96%87%E5%8E%8B%E7%BC%A9%E5%8C%85%E8%BF%9B%E8%A1%8C%E6%9E%84%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>从标准输入中读取上下文压缩包进行构建</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67888689932164300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker build - < context.tar.gz`, `67888689932164300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker build - <span class="token operator">&lt;</span> context.tar.gz</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果发现标准输入的文件格式是 gzip、bzip2 以及 xz 的话，将会使其为上下文压缩包，直接将其展开，将里面视为上下文，并开始构建。</p>\n<h2 id="其它制作镜像的方式"><a href="#%E5%85%B6%E5%AE%83%E5%88%B6%E4%BD%9C%E9%95%9C%E5%83%8F%E7%9A%84%E6%96%B9%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其它制作镜像的方式</h2>\n<p>除了标准的使用 Dockerfile 生成镜像的方法外，由于各种特殊需求和历史原因，还提供了一些其它方法用以生成镜像。</p>\n<h3 id="从-rootfs-压缩包导入"><a href="#%E4%BB%8E-rootfs-%E5%8E%8B%E7%BC%A9%E5%8C%85%E5%AF%BC%E5%85%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>从 rootfs 压缩包导入</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80909848707147120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker import [选项] <文件>|<URL>|- [<仓库名>[:<标签>]]`, `80909848707147120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker <span class="token function">import</span> <span class="token punctuation">[</span>选项<span class="token punctuation">]</span> <span class="token operator">&lt;</span>文件<span class="token operator">>|</span><span class="token operator">&lt;</span>URL<span class="token operator">>|</span>- <span class="token punctuation">[</span><span class="token operator">&lt;</span>仓库名<span class="token operator">></span><span class="token punctuation">[</span>:<span class="token operator">&lt;</span>标签<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>压缩包可以是本地文件、远程 Web 文件，甚至是从标准输入中得到。压缩包将会在镜像 / 目录展开，并直接作为镜像第一层提交。</p>\n<p>比如我们想要创建一个 OpenVZ 的 Ubuntu 16.04 模板的镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57243614559025020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker import \\\n    http://download.openvz.org/template/precreated/ubuntu-16.04-x86_64.tar.gz \\\n    openvz/ubuntu:16.04\n\nDownloading from http://download.openvz.org/template/precreated/ubuntu-16.04-x86_64.tar.gz\nsha256:412b8fc3e3f786dca0197834a698932b9c51b69bd8cf49e100c35d38c9879213`, `57243614559025020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">import</span> <span class="token punctuation">\\</span>\n    http://download.openvz.org/template/precreated/ubuntu-16.04-x86_64.tar.gz <span class="token punctuation">\\</span>\n    openvz/ubuntu:16.04\n\nDownloading from http://download.openvz.org/template/precreated/ubuntu-16.04-x86_64.tar.gz\nsha256:412b8fc3e3f786dca0197834a698932b9c51b69bd8cf49e100c35d38c9879213</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这条命令自动下载了 ubuntu-16.04-x86_64.tar.gz 文件，并且作为根文件系统展开导入，并保存为镜像 openvz/ubuntu:16.04。</p>\n<p>导入成功后，我们可以用 docker image ls 看到这个导入的镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85691249812938260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls openvz/ubuntu\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nopenvz/ubuntu       16.04               412b8fc3e3f7        55 seconds ago      505MB`, `85691249812938260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> openvz/ubuntu\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nopenvz/ubuntu       <span class="token number">16.04</span>               412b8fc3e3f7        <span class="token number">55</span> seconds ago      505MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>如果我们查看其历史的话，会看到描述中有导入的文件链接：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47232672081506980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker history openvz/ubuntu:16.04\nIMAGE               CREATED              CREATED BY          SIZE                COMMENT\nf477a6e18e98        About a minute ago                       214.9 MB            Imported from http://download.openvz.org/template/precreated/ubuntu-16.04-x86_64.tar.gz`, `47232672081506980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">history</span> openvz/ubuntu:16.04\nIMAGE               CREATED              CREATED BY          SIZE                COMMENT\nf477a6e18e98        About a minute ago                       <span class="token number">214.9</span> MB            Imported from http://download.openvz.org/template/precreated/ubuntu-16.04-x86_64.tar.gz</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h2 id="docker-镜像的导入和导出-docker-save-和-docker-load"><a href="#docker-%E9%95%9C%E5%83%8F%E7%9A%84%E5%AF%BC%E5%85%A5%E5%92%8C%E5%AF%BC%E5%87%BA-docker-save-%E5%92%8C-docker-load" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 镜像的导入和导出 docker save 和 docker load</h2>\n<p>Docker 还提供了 docker save 和 docker load 命令，用以将镜像保存为一个文件，然后传输到另一个位置上，再加载进来。这是在没有 Docker Registry 时的做法，现在已经不推荐，镜像迁移应该直接使用 Docker Registry，无论是直接使用 Docker Hub 还是使用内网私有 Registry 都可以。</p>\n<h3 id="保存镜像"><a href="#%E4%BF%9D%E5%AD%98%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>保存镜像</h3>\n<p>使用 docker save 命令可以将镜像保存为归档文件。</p>\n<p>比如我们希望保存这个 alpine 镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84037050239048530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls alpine\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nalpine              latest              baa5d63471ea        5 weeks ago         4.803 MB`, `84037050239048530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span> alpine\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nalpine              latest              baa5d63471ea        <span class="token number">5</span> weeks ago         <span class="token number">4.803</span> MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>保存镜像的命令为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54879023317868160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker save alpine -o filename\n\\$ file filename\nfilename: POSIX tar archive`, `54879023317868160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker save alpine -o filename\n$ <span class="token function">file</span> filename\nfilename: POSIX <span class="token function">tar</span> archive</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这里的 filename 可以为任意名称甚至任意后缀名，但文件的本质都是归档文件</p>\n<p>注意：如果同名则会覆盖（没有警告）</p>\n<p>若使用 gzip 压缩：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41959897700664950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker save alpine | gzip > alpine-latest.tar.gz`, `41959897700664950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker save alpine <span class="token operator">|</span> <span class="token function">gzip</span> <span class="token operator">></span> alpine-latest.tar.gz</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后我们将 alpine-latest.tar.gz 文件复制到了到了另一个机器上，可以用下面这个命令加载镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42847629655240020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker load -i alpine-latest.tar.gz\nLoaded image: alpine:latest`, `42847629655240020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker load -i alpine-latest.tar.gz\nLoaded image: alpine:latest</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果我们结合这两个命令以及 ssh 甚至 pv 的话，利用 Linux 强大的管道，我们可以写一个命令完成从一个机器将镜像迁移到另一个机器，并且带进度条的功能：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57947439888608380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker save <镜像名> | bzip2 | pv | ssh <用户名>@<主机名> \'cat | docker load\'`, `57947439888608380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker save <span class="token operator">&lt;</span>镜像名<span class="token operator">></span> <span class="token operator">|</span> <span class="token function">bzip2</span> <span class="token operator">|</span> <span class="token function">pv</span> <span class="token operator">|</span> <span class="token function">ssh</span> <span class="token operator">&lt;</span>用户名<span class="token operator">></span>@<span class="token operator">&lt;</span>主机名<span class="token operator">></span> <span class="token string">\'cat | docker load\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="镜像的实现原理"><a href="#%E9%95%9C%E5%83%8F%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>镜像的实现原理</h2>\n<p>Docker 镜像是怎么实现增量的修改和维护的？</p>\n<p>每个镜像都由很多层次构成，Docker 使用 Union FS 将这些不同的层结合到一个镜像中去。</p>\n<p>通常 Union FS 有两个用途, 一方面可以实现不借助 LVM、RAID 将多个 disk 挂到同一个目录下,另一个更常用的就是将一个只读的分支和一个可写的分支联合在一起，Live CD 正是基于此方法可以允许在镜像不变的基础上允许用户在其上进行一些写操作。</p>\n<p>Docker 在 OverlayFS 上构建的容器也是利用了类似的原理。</p>\n<h1 id="dockerfile"><a href="#dockerfile" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dockerfile</h1>\n<h2 id="copy-复制文件"><a href="#copy-%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>COPY 复制文件</h2>\n<p>格式：</p>\n<ul>\n<li><code class="language-text">COPY [--chown=&lt;user&gt;:&lt;group&gt;] &lt;源路径&gt;... &lt;目标路径&gt;</code></li>\n<li><code class="language-text">COPY [--chown=&lt;user&gt;:&lt;group&gt;] [&quot;&lt;源路径1&gt;&quot;,... &quot;&lt;目标路径&gt;&quot;]</code></li>\n</ul>\n<p>和 RUN 指令一样，也有两种格式，一种类似于命令行，一种类似于函数调用。</p>\n<p>COPY 指令将从构建上下文目录中 <code class="language-text">&lt;源路径&gt;</code> 的文件/目录复制到新的一层的镜像内的 <code class="language-text">&lt;目标路径&gt;</code> 位置。比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7761693891085231000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`COPY package.json /usr/src/app/`, `7761693891085231000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">COPY</span> package.json /usr/src/app/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p><code class="language-text">&lt;源路径&gt;</code> 可以是多个，甚至可以是通配符，其通配符规则要满足 Go 的 filepath.Match 规则，如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80668496528426450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`COPY hom* /mydir/\nCOPY hom?.txt /mydir/`, `80668496528426450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">COPY</span> hom* /mydir/\n<span class="token keyword">COPY</span> hom<span class="token punctuation">?</span>.txt /mydir/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p><code class="language-text">&lt;目标路径&gt;</code> 可以是容器内的绝对路径，也可以是相对于工作目录的相对路径（工作目录可以用 WORKDIR 指令来指定）。目标路径不需要事先创建，如果目录不存在会在复制文件前先行创建缺失目录。</p>\n<p>此外，还需要注意一点，使用 COPY 指令，源文件的各种元数据都会保留。比如读、写、执行权限、文件变更时间等。这个特性对于镜像定制很有用。特别是构建相关文件都在使用 Git 进行管理的时候。</p>\n<p>在使用该指令的时候还可以加上 <code class="language-text">--chown=&lt;user&gt;:&lt;group&gt;</code> 选项来改变文件的所属用户及所属组。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75267745496144860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`COPY --chown=55:mygroup files* /mydir/\nCOPY --chown=bin files* /mydir/\nCOPY --chown=1 files* /mydir/\nCOPY --chown=10:11 files* /mydir/`, `75267745496144860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=55<span class="token punctuation">:</span>mygroup files* /mydir/\n<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=bin files* /mydir/\n<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=1 files* /mydir/\n<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=10<span class="token punctuation">:</span>11 files* /mydir/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果源路径为文件夹，复制的时候不是直接复制该文件夹，而是将文件夹中的内容复制到目标路径。</p>\n<h2 id="add-更高级的复制文件"><a href="#add-%E6%9B%B4%E9%AB%98%E7%BA%A7%E7%9A%84%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ADD 更高级的复制文件</h2>\n<p>ADD 指令和 COPY 的格式和性质基本一致。但是在 COPY 基础上增加了一些功能。</p>\n<p>比如 <code class="language-text">&lt;源路径&gt;</code> 可以是一个 URL，这种情况下，Docker 引擎会试图去下载这个链接的文件放到 <code class="language-text">&lt;目标路径&gt;</code> 去。下载后的文件权限自动设置为 600，如果这并不是想要的权限，那么还需要增加额外的一层 RUN 进行权限调整，另外，如果下载的是个压缩包，需要解压缩，也一样还需要额外的一层 RUN 指令进行解压缩。所以不如直接使用 RUN 指令，然后使用 wget 或者 curl 工具下载，处理权限、解压缩、然后清理无用文件更合理。因此，这个功能其实并不实用，而且不推荐使用。</p>\n<p>如果 <code class="language-text">&lt;源路径&gt;</code> 为一个 tar 压缩文件的话，压缩格式为 gzip, bzip2 以及 xz 的情况下，ADD 指令将会自动解压缩这个压缩文件到 <code class="language-text">&lt;目标路径&gt;</code> 去。</p>\n<p>在某些情况下，这个自动解压缩的功能非常有用，比如官方镜像 ubuntu 中：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86824072419076080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM scratch\nADD ubuntu-xenial-core-cloudimg-amd64-root.tar.gz /\n...`, `86824072419076080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> scratch\n<span class="token keyword">ADD</span> ubuntu<span class="token punctuation">-</span>xenial<span class="token punctuation">-</span>core<span class="token punctuation">-</span>cloudimg<span class="token punctuation">-</span>amd64<span class="token punctuation">-</span>root.tar.gz /\n<span class="token punctuation">...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>但在某些情况下，如果我们真的是希望复制个压缩文件进去，而不解压缩，这时就不可以使用 ADD 命令了。</p>\n<p>在 Docker 官方的 Dockerfile 最佳实践文档中要求，尽可能的使用 COPY，因为 COPY 的语义很明确，就是复制文件而已，而 ADD 则包含了更复杂的功能，其行为也不一定很清晰。最适合使用 ADD 的场合，就是所提及的需要自动解压缩的场合。</p>\n<p>另外需要注意的是，ADD 指令会令镜像构建缓存失效，从而可能会令镜像构建变得比较缓慢。</p>\n<p>因此在 COPY 和 ADD 指令中选择的时候，可以遵循这样的原则，所有的文件复制均使用 COPY 指令，仅在需要自动解压缩的场合使用 ADD。</p>\n<p>在使用该指令的时候还可以加上 <code class="language-text">--chown=&lt;user&gt;:&lt;group&gt;</code> 选项来改变文件的所属用户及所属组。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64298170528252770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ADD --chown=55:mygroup files* /mydir/\nADD --chown=bin files* /mydir/\nADD --chown=1 files* /mydir/k\nADD --chown=10:11 files* /mydir/`, `64298170528252770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">ADD</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=55<span class="token punctuation">:</span>mygroup files* /mydir/\n<span class="token keyword">ADD</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=bin files* /mydir/\n<span class="token keyword">ADD</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=1 files* /mydir/k\n<span class="token keyword">ADD</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>chown=10<span class="token punctuation">:</span>11 files* /mydir/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="cmd-容器启动命令"><a href="#cmd-%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CMD 容器启动命令</h2>\n<p>CMD 指令的格式和 RUN 相似，也是两种格式：</p>\n<ul>\n<li>shell 格式：<code class="language-text">CMD &lt;命令&gt;</code></li>\n<li>exec 格式：<code class="language-text">CMD [&quot;可执行文件&quot;, &quot;参数1&quot;, &quot;参数2&quot;...]</code></li>\n<li>参数列表格式：<code class="language-text">CMD [&quot;参数1&quot;, &quot;参数2&quot;...]</code>。在指定了 ENTRYPOINT 指令后，用 CMD 指定具体的参数。</li>\n</ul>\n<p>之前介绍容器的时候曾经说过，Docker 不是虚拟机，容器就是进程。既然是进程，那么在启动容器的时候，需要指定所运行的程序及参数。CMD 指令就是用于指定默认的容器主进程的启动命令的。</p>\n<p>在运行时可以指定新的命令来替代镜像设置中的这个默认命令，比如，ubuntu 镜像默认的 CMD 是 <code class="language-text">/bin/bash</code>，如果我们直接 <code class="language-text">docker run -it ubuntu</code> 的话，会直接进入 bash。我们也可以在运行时指定运行别的命令，如 <code class="language-text">docker run -it ubuntu cat /etc/os-release</code>。这就是用 <code class="language-text">cat /etc/os-release</code> 命令替换了默认的 <code class="language-text">/bin/bash</code> 命令了，输出了系统版本信息。</p>\n<p>在指令格式上，一般推荐使用 exec 格式，这类格式在解析时会被解析为 JSON 数组，因此一定要使用双引号，而不要使用单引号。</p>\n<p>如果使用 shell 格式的话，实际的命令会被包装为 <code class="language-text">sh -c</code> 的参数的形式进行执行。比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68176409934573674000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`CMD echo \\$HOME`, `68176409934573674000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">CMD</span> echo $HOME</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>在实际执行中，会将其变更为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38402942301353810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`CMD [ &quot;sh&quot;, &quot;-c&quot;, &quot;echo \\$HOME&quot; ]`, `38402942301353810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">CMD</span> <span class="token punctuation">[</span> <span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"echo $HOME"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这就是为什么我们可以使用环境变量的原因，因为这些环境变量会被 shell 进行解析处理。</p>\n<p>提到 CMD 就不得不提容器中应用在前台执行和后台执行的问题。这是初学者常出现的一个混淆。</p>\n<p>Docker 不是虚拟机，容器中的应用都应该以前台执行，而不是像虚拟机、物理机里面那样，用 systemd 去启动后台服务，容器内没有后台服务的概念。</p>\n<p>一些初学者将 CMD 写为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16770104133563724000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`CMD service nginx start`, `16770104133563724000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">CMD</span> service nginx start</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后发现容器执行后就立即退出了。甚至在容器内去使用 systemctl 命令结果却发现根本执行不了。这就是因为没有搞明白前台、后台的概念，没有区分容器和虚拟机的差异，依旧在以传统虚拟机的角度去理解容器。</p>\n<p>对于容器而言，其启动程序就是容器应用进程，容器就是为了主进程而存在的，主进程退出，容器就失去了存在的意义，从而退出，其它辅助进程不是它需要关心的东西。</p>\n<p>而使用 <code class="language-text">service nginx start</code> 命令，则是希望 upstart 来以后台守护进程形式启动 nginx 服务。而刚才说了 <code class="language-text">CMD service nginx start</code> 会被理解为 <code class="language-text">CMD [ &quot;sh&quot;, &quot;-c&quot;, &quot;service nginx start&quot;]</code>，因此主进程实际上是 sh。那么当 <code class="language-text">service nginx start</code> 命令结束后，sh 也就结束了，sh 作为主进程退出了，自然就会令容器退出。</p>\n<p>正确的做法是直接执行 nginx 可执行文件，并且要求以前台形式运行。比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6847979730788878000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`CMD [&quot;nginx&quot;, &quot;-g&quot;, &quot;daemon off;&quot;]`, `6847979730788878000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">CMD</span> <span class="token punctuation">[</span><span class="token string">"nginx"</span><span class="token punctuation">,</span> <span class="token string">"-g"</span><span class="token punctuation">,</span> <span class="token string">"daemon off;"</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="entrypoint-入口点"><a href="#entrypoint-%E5%85%A5%E5%8F%A3%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ENTRYPOINT 入口点</h2>\n<p>ENTRYPOINT 的格式和 RUN 指令格式一样，分为 exec 格式和 shell 格式。</p>\n<p>ENTRYPOINT 的目的和 CMD 一样，都是在指定容器启动程序及参数。ENTRYPOINT 在运行时也可以替代，不过比 CMD 要略显繁琐，需要通过 docker run 的参数 <code class="language-text">--entrypoint</code> 来指定。</p>\n<p>当指定了 ENTRYPOINT 后，CMD 的含义就发生了改变，不再是直接的运行其命令，而是将 CMD 的内容作为参数传给 ENTRYPOINT 指令，换句话说实际执行时，将变为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3128968513777863000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<ENTRYPOINT> &quot;<CMD>&quot;`, `3128968513777863000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">&lt;</span>ENTRYPOINT<span class="token operator">></span> <span class="token string">"&lt;CMD>"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>那么有了 CMD 后，为什么还要有 ENTRYPOINT 呢？这种 <code class="language-text">&lt;ENTRYPOINT&gt; &quot;&lt;CMD&gt;&quot;</code> 有什么好处么？让我们来看几个场景。</p>\n<h3 id="场景一：让镜像变成像命令一样使用"><a href="#%E5%9C%BA%E6%99%AF%E4%B8%80%EF%BC%9A%E8%AE%A9%E9%95%9C%E5%83%8F%E5%8F%98%E6%88%90%E5%83%8F%E5%91%BD%E4%BB%A4%E4%B8%80%E6%A0%B7%E4%BD%BF%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>场景一：让镜像变成像命令一样使用</h3>\n<p>假设我们需要一个得知自己当前公网 IP 的镜像，那么可以先用 CMD 来实现：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40636500062484630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM ubuntu:18.04\nRUN apt-get update \\\n    && apt-get install -y curl \\\n    && rm -rf /var/lib/apt/lists/*\nCMD [ &quot;curl&quot;, &quot;-s&quot;, &quot;http://myip.ipip.net&quot; ]`, `40636500062484630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> ubuntu<span class="token punctuation">:</span>18.04\n<span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update \\\n    &amp;&amp; apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y curl \\\n    &amp;&amp; rm <span class="token punctuation">-</span>rf /var/lib/apt/lists/*\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span> <span class="token string">"curl"</span><span class="token punctuation">,</span> <span class="token string">"-s"</span><span class="token punctuation">,</span> <span class="token string">"http://myip.ipip.net"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>假如我们使用 <code class="language-text">docker build -t myip .</code> 来构建镜像的话，如果我们需要查询当前公网 IP，只需要执行：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53808655319624974000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run myip\n当前 IP：61.148.226.66 来自：北京市 联通`, `53808655319624974000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run myip\n当前 IP：61.148.226.66 来自：北京市 联通</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>嗯，这么看起来好像可以直接把镜像当做命令使用了，不过命令总有参数，如果我们希望加参数呢？比如从上面的 CMD 中可以看到实质的命令是 curl，那么如果我们希望显示 HTTP 头信息，就需要加上 -i 参数。那么我们可以直接加 -i 参数给 <code class="language-text">docker run myip</code> 么？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48041970955412510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run myip -i\ndocker: Error response from daemon: invalid header field value &quot;oci runtime error: container_linux.go:247: starting container process caused \\&quot;exec: \\\\\\&quot;-i\\\\\\&quot;: executable file not found in \\$PATH\\&quot;\\n&quot;.`, `48041970955412510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run myip -i\ndocker: Error response from daemon: invalid header field value <span class="token string">"oci runtime error: container_linux.go:247: starting container process caused <span class="token entity" title="\\&quot;">\\"</span>exec: <span class="token entity" title="\\\\">\\\\</span><span class="token entity" title="\\&quot;">\\"</span>-i<span class="token entity" title="\\\\">\\\\</span><span class="token entity" title="\\&quot;">\\"</span>: executable file not found in <span class="token environment constant">$PATH</span><span class="token entity" title="\\&quot;">\\"</span><span class="token entity" title="\\n">\\n</span>"</span><span class="token builtin class-name">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>我们可以看到可执行文件找不到的报错，<code class="language-text">executable file not found</code>。之前我们说过，跟在镜像名后面的是 command，运行时会替换 CMD 的默认值。因此这里的 -i 替换了原来的 CMD，而不是添加在原来的 <code class="language-text">curl -s http://myip.ipip.net</code> 后面。而 -i 根本不是命令，所以自然找不到。</p>\n<p>那么如果我们希望加入 -i 这参数，我们就必须重新完整的输入这个命令：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99471747257163320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run myip curl -s http://myip.ipip.net -i`, `99471747257163320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run myip <span class="token function">curl</span> -s http://myip.ipip.net -i</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这显然不是很好的解决方案，而使用 ENTRYPOINT 就可以解决这个问题。现在我们重新用 ENTRYPOINT 来实现这个镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44997954989045790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM ubuntu:18.04\nRUN apt-get update \\\n    && apt-get install -y curl \\\n    && rm -rf /var/lib/apt/lists/*\nENTRYPOINT [ &quot;curl&quot;, &quot;-s&quot;, &quot;http://myip.ipip.net&quot; ]`, `44997954989045790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> ubuntu<span class="token punctuation">:</span>18.04\n<span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update \\\n    &amp;&amp; apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y curl \\\n    &amp;&amp; rm <span class="token punctuation">-</span>rf /var/lib/apt/lists/*\n<span class="token keyword">ENTRYPOINT</span> <span class="token punctuation">[</span> <span class="token string">"curl"</span><span class="token punctuation">,</span> <span class="token string">"-s"</span><span class="token punctuation">,</span> <span class="token string">"http://myip.ipip.net"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这次我们再来尝试直接使用 <code class="language-text">docker run myip -i</code>：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50593150046737720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run myip\n当前 IP：61.148.226.66 来自：北京市 联通\n\n\\$ docker run myip -i\nHTTP/1.1 200 OK\nServer: nginx/1.8.0\nDate: Tue, 22 Nov 2016 05:12:40 GMT\nContent-Type: text/html; charset=UTF-8\nVary: Accept-Encoding\nX-Powered-By: PHP/5.6.24-1~dotdeb+7.1\nX-Cache: MISS from cache-2\nX-Cache-Lookup: MISS from cache-2:80\nX-Cache: MISS from proxy-2_6\nTransfer-Encoding: chunked\nVia: 1.1 cache-2:80, 1.1 proxy-2_6:8006\nConnection: keep-alive\n\n当前 IP：61.148.226.66 来自：北京市 联通`, `50593150046737720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run myip\n当前 IP：61.148.226.66 来自：北京市 联通\n\n$ docker run myip -i\nHTTP/1.1 <span class="token number">200</span> OK\nServer: nginx/1.8.0\nDate: Tue, <span class="token number">22</span> Nov <span class="token number">2016</span> 05:12:40 GMT\nContent-Type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>UTF-8\nVary: Accept-Encoding\nX-Powered-By: PHP/5.6.24-1~dotdeb+7.1\nX-Cache: MISS from cache-2\nX-Cache-Lookup: MISS from cache-2:80\nX-Cache: MISS from proxy-2_6\nTransfer-Encoding: chunked\nVia: <span class="token number">1.1</span> cache-2:80, <span class="token number">1.1</span> proxy-2_6:8006\nConnection: keep-alive\n\n当前 IP：61.148.226.66 来自：北京市 联通</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，这次成功了。这是因为当存在 ENTRYPOINT 后，CMD 的内容将会作为参数传给 ENTRYPOINT，而这里 -i 就是新的 CMD，因此会作为参数传给 curl，从而达到了我们预期的效果。</p>\n<h3 id="场景二：应用运行前的准备工作"><a href="#%E5%9C%BA%E6%99%AF%E4%BA%8C%EF%BC%9A%E5%BA%94%E7%94%A8%E8%BF%90%E8%A1%8C%E5%89%8D%E7%9A%84%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>场景二：应用运行前的准备工作</h3>\n<p>启动容器就是启动主进程，但有些时候，启动主进程前，需要一些准备工作。</p>\n<p>比如 mysql 类的数据库，可能需要一些数据库配置、初始化的工作，这些工作要在最终的 mysql 服务器运行之前解决。</p>\n<p>此外，可能希望避免使用 root 用户去启动服务，从而提高安全性，而在启动服务前还需要以 root 身份执行一些必要的准备工作，最后切换到服务用户身份启动服务。或者除了服务外，其它命令依旧可以使用 root 身份执行，方便调试等。</p>\n<p>这些准备工作是和容器 CMD 无关的，无论 CMD 为什么，都需要事先进行一个预处理的工作。这种情况下，可以写一个脚本，然后放入 ENTRYPOINT 中去执行，而这个脚本会将接到的参数（也就是 <code class="language-text">&lt;CMD&gt;</code>）作为命令，在脚本最后执行。比如官方镜像 redis 中就是这么做的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12616251999135476000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM alpine:3.4\n...\nRUN addgroup -S redis && adduser -S -G redis redis\n...\nENTRYPOINT [&quot;docker-entrypoint.sh&quot;]\n\nEXPOSE 6379\nCMD [ &quot;redis-server&quot; ]`, `12616251999135476000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> alpine<span class="token punctuation">:</span>3.4\n<span class="token punctuation">...</span>\n<span class="token keyword">RUN</span> addgroup <span class="token punctuation">-</span>S redis &amp;&amp; adduser <span class="token punctuation">-</span>S <span class="token punctuation">-</span>G redis redis\n<span class="token punctuation">...</span>\n<span class="token keyword">ENTRYPOINT</span> <span class="token punctuation">[</span><span class="token string">"docker-entrypoint.sh"</span><span class="token punctuation">]</span>\n\n<span class="token keyword">EXPOSE</span> 6379\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span> <span class="token string">"redis-server"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到其中为了 redis 服务创建了 redis 用户，并在最后指定了 ENTRYPOINT 为 docker-entrypoint.sh 脚本。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64721441021656826000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/bin/sh\n...\n# allow the container to be started with \\`--user\\`\nif [ &quot;\\$1&quot; = \'redis-server\' -a &quot;\\$(id -u)&quot; = \'0\' ]; then\n   find . \\! -user redis -exec chown redis \'{}\' +\n   exec gosu redis &quot;\\$0&quot; &quot;\\$@&quot;\nfi\n\nexec &quot;\\$@&quot;`, `64721441021656826000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>\n<span class="token punctuation">..</span>.\n<span class="token comment"># allow the container to be started with `--user`</span>\n<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token operator">=</span> <span class="token string">\'redis-server\'</span> -a <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span>"</span> <span class="token operator">=</span> <span class="token string">\'0\'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n   <span class="token function">find</span> <span class="token builtin class-name">.</span> <span class="token punctuation">\\</span><span class="token operator">!</span> -user redis -exec <span class="token function">chown</span> redis <span class="token string">\'{}\'</span> +\n   <span class="token builtin class-name">exec</span> gosu redis <span class="token string">"<span class="token variable">$0</span>"</span> <span class="token string">"<span class="token variable">$@</span>"</span>\n<span class="token keyword">fi</span>\n\n<span class="token builtin class-name">exec</span> <span class="token string">"<span class="token variable">$@</span>"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>该脚本的内容就是根据 CMD 的内容来判断，如果是 redis-server 的话，则切换到 redis 用户身份启动服务器，否则依旧使用 root 身份执行。比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22795257881443144000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -it redis id\nuid=0(root) gid=0(root) groups=0(root)`, `22795257881443144000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -it redis <span class="token function">id</span>\n<span class="token assign-left variable">uid</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token assign-left variable">gid</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token assign-left variable">groups</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h2 id="env-设置环境变量"><a href="#env-%E8%AE%BE%E7%BD%AE%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ENV 设置环境变量</h2>\n<p>格式有两种：</p>\n<ul>\n<li><code class="language-text">ENV &lt;key&gt; &lt;value&gt;</code></li>\n<li><code class="language-text">ENV &lt;key1&gt;=&lt;value1&gt; &lt;key2&gt;=&lt;value2&gt;...</code></li>\n</ul>\n<p>这个指令很简单，就是设置环境变量而已，无论是后面的其它指令如 RUN，还是运行时的应用，都可以直接使用这里定义的环境变量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19988022739415024000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ENV VERSION=1.0 DEBUG=on \\\n    NAME=&quot;Happy Feet&quot;`, `19988022739415024000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">ENV</span> VERSION=1.0 DEBUG=on \\\n    NAME=<span class="token string">"Happy Feet"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这个例子中演示了如何换行，以及对含有空格的值用双引号括起来的办法，这和 Shell 下的行为是一致的。</p>\n<p>定义了环境变量，那么在后续的指令中，就可以使用这个环境变量。比如在官方 node 镜像 Dockerfile 中，就有类似这样的代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2452937274218136600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ENV NODE_VERSION 7.2.0\n\nRUN curl -SLO &quot;https://nodejs.org/dist/v\\$NODE_VERSION/node-v\\$NODE_VERSION-linux-x64.tar.xz&quot; \\\n  && curl -SLO &quot;https://nodejs.org/dist/v\\$NODE_VERSION/SHASUMS256.txt.asc&quot; \\\n  && gpg --batch --decrypt --output SHASUMS256.txt SHASUMS256.txt.asc \\\n  && grep &quot; node-v\\$NODE_VERSION-linux-x64.tar.xz\\\\$&quot; SHASUMS256.txt | sha256sum -c - \\\n  && tar -xJf &quot;node-v\\$NODE_VERSION-linux-x64.tar.xz&quot; -C /usr/local --strip-components=1 \\\n  && rm &quot;node-v\\$NODE_VERSION-linux-x64.tar.xz&quot; SHASUMS256.txt.asc SHASUMS256.txt \\\n  && ln -s /usr/local/bin/node /usr/local/bin/nodejs`, `2452937274218136600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">ENV</span> NODE_VERSION 7.2.0\n\n<span class="token keyword">RUN</span> curl <span class="token punctuation">-</span>SLO <span class="token string">"https://nodejs.org/dist/v$NODE_VERSION/node-v$NODE_VERSION-linux-x64.tar.xz"</span> \\\n  &amp;&amp; curl <span class="token punctuation">-</span>SLO <span class="token string">"https://nodejs.org/dist/v$NODE_VERSION/SHASUMS256.txt.asc"</span> \\\n  &amp;&amp; gpg <span class="token punctuation">-</span><span class="token punctuation">-</span>batch <span class="token punctuation">-</span><span class="token punctuation">-</span>decrypt <span class="token punctuation">-</span><span class="token punctuation">-</span>output SHASUMS256.txt SHASUMS256.txt.asc \\\n  &amp;&amp; grep <span class="token string">" node-v$NODE_VERSION-linux-x64.tar.xz\\$"</span> SHASUMS256.txt <span class="token punctuation">|</span> sha256sum <span class="token punctuation">-</span>c <span class="token punctuation">-</span> \\\n  &amp;&amp; tar <span class="token punctuation">-</span>xJf <span class="token string">"node-v$NODE_VERSION-linux-x64.tar.xz"</span> <span class="token punctuation">-</span>C /usr/local <span class="token punctuation">-</span><span class="token punctuation">-</span>strip<span class="token punctuation">-</span>components=1 \\\n  &amp;&amp; rm <span class="token string">"node-v$NODE_VERSION-linux-x64.tar.xz"</span> SHASUMS256.txt.asc SHASUMS256.txt \\\n  &amp;&amp; ln <span class="token punctuation">-</span>s /usr/local/bin/node /usr/local/bin/nodejs</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在这里先定义了环境变量 <code class="language-text">NODE_VERSION</code>，其后的 RUN 这层里，多次使用 <code class="language-text">$NODE_VERSION</code> 来进行操作定制。可以看到，将来升级镜像构建版本的时候，只需要更新 7.2.0 即可，Dockerfile 构建维护变得更轻松了。</p>\n<p>下列指令可以支持环境变量展开：ADD、COPY、ENV、EXPOSE、FROM、LABEL、USER、WORKDIR、VOLUME、STOPSIGNAL、ONBUILD、RUN。</p>\n<p>可以从这个指令列表里感觉到，环境变量可以使用的地方很多，很强大。通过环境变量，我们可以让一份 Dockerfile 制作更多的镜像，只需使用不同的环境变量即可。</p>\n<h2 id="arg-构建参数"><a href="#arg-%E6%9E%84%E5%BB%BA%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ARG 构建参数</h2>\n<p>格式：<code class="language-text">ARG &lt;参数名&gt;[=&lt;默认值&gt;]</code></p>\n<p>构建参数和 ENV 的效果一样，都是设置环境变量。所不同的是，ARG 所设置的构建环境的环境变量，在将来容器运行时是不会存在这些环境变量的。但是不要因此就使用 ARG 保存密码之类的信息，因为 docker history 还是可以看到所有值的。</p>\n<p>Dockerfile 中的 ARG 指令是定义参数名称，以及定义其默认值。该默认值可以在构建命令 docker build 中用 <code class="language-text">--build-arg &lt;参数名&gt;=&lt;值&gt;</code> 来覆盖。</p>\n<p>灵活的使用 ARG 指令，能够在不修改 Dockerfile 的情况下，构建出不同的镜像。</p>\n<p>ARG 指令有生效范围，如果在 FROM 指令之前指定，那么只能用于 FROM 指令中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67323110636443560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ARG DOCKER_USERNAME=library\n\nFROM \\${DOCKER_USERNAME}/alpine\n\nRUN set -x ; echo \\${DOCKER_USERNAME}`, `67323110636443560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">ARG</span> DOCKER_USERNAME=library\n\n<span class="token keyword">FROM</span> $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span>/alpine\n\n<span class="token keyword">RUN</span> set <span class="token punctuation">-</span>x ; echo $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用上述 Dockerfile 会发现无法输出 <code class="language-text">${DOCKER_USERNAME}</code> 变量的值，要想正常输出，你必须在 FROM 之后再次指定 ARG</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89080122456123130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 只在 FROM 中生效\nARG DOCKER_USERNAME=library\n\nFROM \\${DOCKER_USERNAME}/alpine\n\n# 要想在 FROM 之后使用，必须再次指定\nARG DOCKER_USERNAME=library\n\nRUN set -x ; echo \\${DOCKER_USERNAME}`, `89080122456123130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># 只在 FROM 中生效</span>\n<span class="token keyword">ARG</span> DOCKER_USERNAME=library\n\n<span class="token keyword">FROM</span> $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span>/alpine\n\n<span class="token comment"># 要想在 FROM 之后使用，必须再次指定</span>\n<span class="token keyword">ARG</span> DOCKER_USERNAME=library\n\n<span class="token keyword">RUN</span> set <span class="token punctuation">-</span>x ; echo $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对于多阶段构建，尤其要注意这个问题</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25558223473304520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 这个变量在每个 FROM 中都生效\nARG DOCKER_USERNAME=library\n\nFROM \\${DOCKER_USERNAME}/alpine\n\nRUN set -x ; echo 1\n\nFROM \\${DOCKER_USERNAME}/alpine\n\nRUN set -x ; echo 2`, `25558223473304520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># 这个变量在每个 FROM 中都生效</span>\n<span class="token keyword">ARG</span> DOCKER_USERNAME=library\n\n<span class="token keyword">FROM</span> $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span>/alpine\n\n<span class="token keyword">RUN</span> set <span class="token punctuation">-</span>x ; echo 1\n\n<span class="token keyword">FROM</span> $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span>/alpine\n\n<span class="token keyword">RUN</span> set <span class="token punctuation">-</span>x ; echo 2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对于上述 Dockerfile 两个 FROM 指令都可以使用 <code class="language-text">${DOCKER_USERNAME}</code>，对于在各个阶段中使用的变量都必须在每个阶段分别指定：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18262418576516782000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ARG DOCKER_USERNAME=library\n\nFROM \\${DOCKER_USERNAME}/alpine\n\n# 在 FROM 之后使用变量，必须在每个阶段分别指定\nARG DOCKER_USERNAME=library\n\nRUN set -x ; echo \\${DOCKER_USERNAME}\n\nFROM \\${DOCKER_USERNAME}/alpine\n\n# 在 FROM 之后使用变量，必须在每个阶段分别指定\nARG DOCKER_USERNAME=library\n\nRUN set -x ; echo \\${DOCKER_USERNAME}`, `18262418576516782000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">ARG</span> DOCKER_USERNAME=library\n\n<span class="token keyword">FROM</span> $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span>/alpine\n\n<span class="token comment"># 在 FROM 之后使用变量，必须在每个阶段分别指定</span>\n<span class="token keyword">ARG</span> DOCKER_USERNAME=library\n\n<span class="token keyword">RUN</span> set <span class="token punctuation">-</span>x ; echo $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span>\n\n<span class="token keyword">FROM</span> $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span>/alpine\n\n<span class="token comment"># 在 FROM 之后使用变量，必须在每个阶段分别指定</span>\n<span class="token keyword">ARG</span> DOCKER_USERNAME=library\n\n<span class="token keyword">RUN</span> set <span class="token punctuation">-</span>x ; echo $<span class="token punctuation">{</span>DOCKER_USERNAME<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="volume-定义匿名卷"><a href="#volume-%E5%AE%9A%E4%B9%89%E5%8C%BF%E5%90%8D%E5%8D%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>VOLUME 定义匿名卷</h2>\n<p>格式为：</p>\n<ul>\n<li><code class="language-text">VOLUME [&quot;&lt;路径 1&gt;&quot;, &quot;&lt;路径 2&gt;&quot;...]</code></li>\n<li><code class="language-text">VOLUME &lt;路径&gt;</code></li>\n</ul>\n<p>之前我们说过，容器运行时应该尽量保持容器存储层不发生写操作，对于数据库类需要保存动态数据的应用，其数据库文件应该保存于卷(volume)中，后面的章节我们会进一步介绍 Docker 卷的概念。为了防止运行时用户忘记将动态文件所保存目录挂载为卷，在 Dockerfile 中，我们可以事先指定某些目录挂载为匿名卷，这样在运行时如果用户不指定挂载，其应用也可以正常运行，不会向容器存储层写入大量数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10211026504852505000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`VOLUME /data`, `10211026504852505000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">VOLUME</span> /data</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这里的 /data 目录就会在容器运行时自动挂载为匿名卷，任何向 /data 中写入的信息都不会记录进容器存储层，从而保证了容器存储层的无状态化。当然，运行容器时可以覆盖这个挂载设置。比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43668586559584230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -v mydata:/data xxxx`, `43668586559584230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile">$ docker run <span class="token punctuation">-</span>d <span class="token punctuation">-</span>v mydata<span class="token punctuation">:</span>/data xxxx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>在这行命令中，就使用了 mydata 这个命名卷挂载到了 /data 这个位置，替代了 Dockerfile 中定义的匿名卷的挂载配置。</p>\n<h2 id="expose-声明端口"><a href="#expose-%E5%A3%B0%E6%98%8E%E7%AB%AF%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>EXPOSE 声明端口</h2>\n<p>格式为 <code class="language-text">EXPOSE &lt;端口1&gt; [&lt;端口2&gt;...]</code>。</p>\n<p>EXPOSE 指令是声明容器运行时提供服务的端口，这只是一个声明，在容器运行时并不会因为这个声明应用就会开启这个端口的服务。在 Dockerfile 中写入这样的声明有两个好处，一个是帮助镜像使用者理解这个镜像服务的守护端口，以方便配置映射；另一个用处则是在运行时使用随机端口映射时，也就是 <code class="language-text">docker run -P</code> 时，会自动随机映射 EXPOSE 的端口。</p>\n<p>要将 EXPOSE 和在运行时使用 <code class="language-text">-p &lt;宿主端口&gt;:&lt;容器端口&gt;</code> 区分开来。-p，是映射宿主端口和容器端口，换句话说，就是将容器的对应端口服务公开给外界访问，而 EXPOSE 仅仅是声明容器打算使用什么端口而已，并不会自动在宿主进行端口映射。</p>\n<h2 id="workdir-指定工作目录"><a href="#workdir-%E6%8C%87%E5%AE%9A%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WORKDIR 指定工作目录</h2>\n<p>格式为 <code class="language-text">WORKDIR &lt;工作目录路径&gt;</code>。</p>\n<p>使用 WORKDIR 指令可以来指定工作目录（或者称为当前目录），以后各层的当前目录就被改为指定的目录，如该目录不存在，WORKDIR 会帮你建立目录。</p>\n<p>之前提到一些初学者常犯的错误是把 Dockerfile 等同于 Shell 脚本来书写，这种错误的理解还可能会导致出现下面这样的错误：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46643914272427000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RUN cd /app\nRUN echo &quot;hello&quot; > world.txt`, `46643914272427000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">RUN</span> cd /app\n<span class="token keyword">RUN</span> echo <span class="token string">"hello"</span> <span class="token punctuation">></span> world.txt</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果将这个 Dockerfile 进行构建镜像运行后，会发现找不到 <code class="language-text">/app/world.txt</code> 文件，或者其内容不是 hello。原因其实很简单，在 Shell 中，连续两行是同一个进程执行环境，因此前一个命令修改的内存状态，会直接影响后一个命令；而在 Dockerfile 中，这两行 RUN 命令的执行环境根本不同，是两个完全不同的容器。这就是对 Dockerfile 构建分层存储的概念不了解所导致的错误。</p>\n<p>之前说过每一个 RUN 都是启动一个容器、执行命令、然后提交存储层文件变更。第一层 <code class="language-text">RUN cd /app</code> 的执行仅仅是当前进程的工作目录变更，一个内存上的变化而已，其结果不会造成任何文件变更。而到第二层的时候，启动的是一个全新的容器，跟第一层的容器更完全没关系，自然不可能继承前一层构建过程中的内存变化。</p>\n<p>因此如果需要改变以后各层的工作目录的位置，那么应该使用 WORKDIR 指令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21333136265942733000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`WORKDIR /app\n\nRUN echo &quot;hello&quot; > world.txt`, `21333136265942733000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">WORKDIR</span> /app\n\n<span class="token keyword">RUN</span> echo <span class="token string">"hello"</span> <span class="token punctuation">></span> world.txt</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>如果你的 WORKDIR 指令使用的相对路径，那么所切换的路径与之前的 WORKDIR 有关：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7411883433982914000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`WORKDIR /a\nWORKDIR b\nWORKDIR c\n\nRUN pwd`, `7411883433982914000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">WORKDIR</span> /a\n<span class="token keyword">WORKDIR</span> b\n<span class="token keyword">WORKDIR</span> c\n\n<span class="token keyword">RUN</span> pwd</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>RUN pwd 的工作目录为 /a/b/c。</p>\n<h2 id="user-指定当前用户"><a href="#user-%E6%8C%87%E5%AE%9A%E5%BD%93%E5%89%8D%E7%94%A8%E6%88%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>USER 指定当前用户</h2>\n<p>格式：<code class="language-text">USER &lt;用户名&gt;[:&lt;用户组&gt;]</code></p>\n<p>USER 指令和 WORKDIR 相似，都是改变环境状态并影响以后的层。WORKDIR 是改变工作目录，USER 则是改变之后层的执行 RUN, CMD 以及 ENTRYPOINT 这类命令的身份。</p>\n<p>注意，USER 只是帮助你切换到指定用户而已，这个用户必须是事先建立好的，否则无法切换。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77801575361477790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RUN groupadd -r redis && useradd -r -g redis redis\nUSER redis\nRUN [ &quot;redis-server&quot; ]`, `77801575361477790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">RUN</span> groupadd <span class="token punctuation">-</span>r redis &amp;&amp; useradd <span class="token punctuation">-</span>r <span class="token punctuation">-</span>g redis redis\n<span class="token keyword">USER</span> redis\n<span class="token keyword">RUN</span> <span class="token punctuation">[</span> <span class="token string">"redis-server"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>如果以 root 执行的脚本，在执行期间希望改变身份，比如希望以某个已经建立好的用户来运行某个服务进程，不要使用 su 或者 sudo，这些都需要比较麻烦的配置，而且在 TTY 缺失的环境下经常出错。建议使用 gosu。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84961508795052670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 建立 redis 用户，并使用 gosu 换另一个用户执行命令\nRUN groupadd -r redis && useradd -r -g redis redis\n# 下载 gosu\nRUN wget -O /usr/local/bin/gosu &quot;https://github.com/tianon/gosu/releases/download/1.12/gosu-amd64&quot; \\\n    && chmod +x /usr/local/bin/gosu \\\n    && gosu nobody true\n# 设置 CMD，并以另外的用户执行\nCMD [ &quot;exec&quot;, &quot;gosu&quot;, &quot;redis&quot;, &quot;redis-server&quot; ]`, `84961508795052670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># 建立 redis 用户，并使用 gosu 换另一个用户执行命令</span>\n<span class="token keyword">RUN</span> groupadd <span class="token punctuation">-</span>r redis &amp;&amp; useradd <span class="token punctuation">-</span>r <span class="token punctuation">-</span>g redis redis\n<span class="token comment"># 下载 gosu</span>\n<span class="token keyword">RUN</span> wget <span class="token punctuation">-</span>O /usr/local/bin/gosu <span class="token string">"https://github.com/tianon/gosu/releases/download/1.12/gosu-amd64"</span> \\\n    &amp;&amp; chmod +x /usr/local/bin/gosu \\\n    &amp;&amp; gosu nobody true\n<span class="token comment"># 设置 CMD，并以另外的用户执行</span>\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span> <span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token string">"gosu"</span><span class="token punctuation">,</span> <span class="token string">"redis"</span><span class="token punctuation">,</span> <span class="token string">"redis-server"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="healthcheck-健康检查"><a href="#healthcheck-%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>HEALTHCHECK 健康检查</h2>\n<p>格式：</p>\n<ul>\n<li><code class="language-text">HEALTHCHECK [选项] CMD &lt;命令&gt;</code>：设置检查容器健康状况的命令</li>\n<li><code class="language-text">HEALTHCHECK NONE</code>：如果基础镜像有健康检查指令，使用这行可以屏蔽掉其健康检查指令</li>\n</ul>\n<p>HEALTHCHECK 指令是告诉 Docker 应该如何进行判断容器的状态是否正常，这是 Docker 1.12 引入的新指令。</p>\n<p>在没有 HEALTHCHECK 指令前，Docker 引擎只可以通过容器内主进程是否退出来判断容器是否状态异常。很多情况下这没问题，但是如果程序进入死锁状态，或者死循环状态，应用进程并不退出，但是该容器已经无法提供服务了。在 1.12 以前，Docker 不会检测到容器的这种状态，从而不会重新调度，导致可能会有部分容器已经无法提供服务了却还在接受用户请求。</p>\n<p>而自 1.12 之后，Docker 提供了 HEALTHCHECK 指令，通过该指令指定一行命令，用这行命令来判断容器主进程的服务状态是否还正常，从而比较真实的反应容器实际状态。</p>\n<p>当在一个镜像指定了 HEALTHCHECK 指令后，用其启动容器，初始状态会为 starting，在 HEALTHCHECK 指令检查成功后变为 healthy，如果连续一定次数失败，则会变为 unhealthy。</p>\n<p>HEALTHCHECK 支持下列选项：</p>\n<ul>\n<li><code class="language-text">--interval=&lt;间隔&gt;</code>：两次健康检查的间隔，默认为 30 秒；</li>\n<li><code class="language-text">--timeout=&lt;时长&gt;</code>：健康检查命令运行超时时间，如果超过这个时间，本次健康检查就被视为失败，默认 30 秒；</li>\n<li><code class="language-text">--retries=&lt;次数&gt;</code>：当连续失败指定次数后，则将容器状态视为 unhealthy，默认 3 次。</li>\n</ul>\n<p>和 CMD, ENTRYPOINT 一样，HEALTHCHECK 只可以出现一次，如果写了多个，只有最后一个生效。</p>\n<p>在 <code class="language-text">HEALTHCHECK [选项] CMD</code> 后面的命令，格式和 ENTRYPOINT 一样，分为 shell 格式，和 exec 格式。命令的返回值决定了该次健康检查的成功与否：0：成功；1：失败；2：保留，不要使用这个值。</p>\n<p>假设我们有个镜像是个最简单的 Web 服务，我们希望增加健康检查来判断其 Web 服务是否在正常工作，我们可以用 curl 来帮助判断，其 Dockerfile 的 HEALTHCHECK 可以这么写：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46042065622553080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM nginx\nRUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*\nHEALTHCHECK --interval=5s --timeout=3s \\\n  CMD curl -fs http://localhost/ || exit 1`, `46042065622553080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> nginx\n<span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update &amp;&amp; apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y curl &amp;&amp; rm <span class="token punctuation">-</span>rf /var/lib/apt/lists/*\n<span class="token keyword">HEALTHCHECK</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>interval=5s <span class="token punctuation">-</span><span class="token punctuation">-</span>timeout=3s \\\n  <span class="token keyword">CMD</span> curl <span class="token punctuation">-</span>fs http<span class="token punctuation">:</span>//localhost/ <span class="token punctuation">|</span><span class="token punctuation">|</span> exit 1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里我们设置了每 5 秒检查一次（这里为了试验所以间隔非常短，实际应该相对较长），如果健康检查命令超过 3 秒没响应就视为失败，并且使用 curl -fs <a href="http://localhost/" target="_blank" rel="nofollow noreferrer noopener">http://localhost/</a> || exit 1 作为健康检查命令。</p>\n<p>使用 docker build 来构建这个镜像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43858028186109890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker build -t myweb:v1 .`, `43858028186109890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker build -t myweb:v1 <span class="token builtin class-name">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>构建好了后，我们启动一个容器：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11728284855944948000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d --name web -p 80:80 myweb:v1`, `11728284855944948000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d --name web -p <span class="token number">80</span>:80 myweb:v1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>当运行该镜像后，可以通过 <code class="language-text">docker container ls</code> 看到最初的状态为 (health: starting)：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="441973146829943700"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container ls\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                            PORTS               NAMES\n03e28eb00bd0        myweb:v1            &quot;nginx -g \'daemon off&quot;   3 seconds ago       Up 2 seconds (health: starting)   80/tcp, 443/tcp     web`, `441973146829943700`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container <span class="token function">ls</span>\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                            PORTS               NAMES\n03e28eb00bd0        myweb:v1            <span class="token string">"nginx -g \'daemon off"</span>   <span class="token number">3</span> seconds ago       Up <span class="token number">2</span> seconds <span class="token punctuation">(</span>health: starting<span class="token punctuation">)</span>   <span class="token number">80</span>/tcp, <span class="token number">443</span>/tcp     web</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>在等待几秒钟后，再次 docker container ls，就会看到健康状态变化为了 (healthy)：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41077439931082990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container ls\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                    PORTS               NAMES\n03e28eb00bd0        myweb:v1            &quot;nginx -g \'daemon off&quot;   18 seconds ago      Up 16 seconds (healthy)   80/tcp, 443/tcp     web`, `41077439931082990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container <span class="token function">ls</span>\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                    PORTS               NAMES\n03e28eb00bd0        myweb:v1            <span class="token string">"nginx -g \'daemon off"</span>   <span class="token number">18</span> seconds ago      Up <span class="token number">16</span> seconds <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>   <span class="token number">80</span>/tcp, <span class="token number">443</span>/tcp     web</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>如果健康检查连续失败超过了重试次数，状态就会变为 (unhealthy)。</p>\n<p>为了帮助排障，健康检查命令的输出（包括 stdout 以及 stderr）都会被存储于健康状态里，可以用 docker inspect 来查看。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6265894719251520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker inspect --format \'{{json .State.Health}}\' web | python -m json.tool\n{\n    &quot;FailingStreak&quot;: 0,\n    &quot;Log&quot;: [\n        {\n            &quot;End&quot;: &quot;2016-11-25T14:35:37.940957051Z&quot;,\n            &quot;ExitCode&quot;: 0,\n            &quot;Output&quot;: &quot;<!DOCTYPE html>\\n<html>\\n<head>\\n<title>Welcome to nginx!</title>\\n<style>\\n    body {\\n        width: 35em;\\n        margin: 0 auto;\\n        font-family: Tahoma, Verdana, Arial, sans-serif;\\n    }\\n</style>\\n</head>\\n<body>\\n<h1>Welcome to nginx!</h1>\\n<p>If you see this page, the nginx web server is successfully installed and\\nworking. Further configuration is required.</p>\\n\\n<p>For online documentation and support please refer to\\n<a href=\\&quot;http://nginx.org/\\&quot;>nginx.org</a>.<br/>\\nCommercial support is available at\\n<a href=\\&quot;http://nginx.com/\\&quot;>nginx.com</a>.</p>\\n\\n<p><em>Thank you for using nginx.</em></p>\\n</body>\\n</html>\\n&quot;,\n            &quot;Start&quot;: &quot;2016-11-25T14:35:37.780192565Z&quot;\n        }\n    ],\n    &quot;Status&quot;: &quot;healthy&quot;\n}`, `6265894719251520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker inspect --format <span class="token string">\'{{json .State.Health}}\'</span> web <span class="token operator">|</span> python -m json.tool\n<span class="token punctuation">{</span>\n    <span class="token string">"FailingStreak"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,\n    <span class="token string">"Log"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>\n        <span class="token punctuation">{</span>\n            <span class="token string">"End"</span><span class="token builtin class-name">:</span> <span class="token string">"2016-11-25T14:35:37.940957051Z"</span>,\n            <span class="token string">"ExitCode"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,\n            <span class="token string">"Output"</span><span class="token builtin class-name">:</span> <span class="token string">"&lt;!DOCTYPE html><span class="token entity" title="\\n">\\n</span>&lt;html><span class="token entity" title="\\n">\\n</span>&lt;head><span class="token entity" title="\\n">\\n</span>&lt;title>Welcome to nginx!&lt;/title><span class="token entity" title="\\n">\\n</span>&lt;style><span class="token entity" title="\\n">\\n</span>    body {<span class="token entity" title="\\n">\\n</span>        width: 35em;<span class="token entity" title="\\n">\\n</span>        margin: 0 auto;<span class="token entity" title="\\n">\\n</span>        font-family: Tahoma, Verdana, Arial, sans-serif;<span class="token entity" title="\\n">\\n</span>    }<span class="token entity" title="\\n">\\n</span>&lt;/style><span class="token entity" title="\\n">\\n</span>&lt;/head><span class="token entity" title="\\n">\\n</span>&lt;body><span class="token entity" title="\\n">\\n</span>&lt;h1>Welcome to nginx!&lt;/h1><span class="token entity" title="\\n">\\n</span>&lt;p>If you see this page, the nginx web server is successfully installed and<span class="token entity" title="\\n">\\n</span>working. Further configuration is required.&lt;/p><span class="token entity" title="\\n">\\n</span><span class="token entity" title="\\n">\\n</span>&lt;p>For online documentation and support please refer to<span class="token entity" title="\\n">\\n</span>&lt;a href=<span class="token entity" title="\\&quot;">\\"</span>http://nginx.org/<span class="token entity" title="\\&quot;">\\"</span>>nginx.org&lt;/a>.&lt;br/><span class="token entity" title="\\n">\\n</span>Commercial support is available at<span class="token entity" title="\\n">\\n</span>&lt;a href=<span class="token entity" title="\\&quot;">\\"</span>http://nginx.com/<span class="token entity" title="\\&quot;">\\"</span>>nginx.com&lt;/a>.&lt;/p><span class="token entity" title="\\n">\\n</span><span class="token entity" title="\\n">\\n</span>&lt;p>&lt;em>Thank you for using nginx.&lt;/em>&lt;/p><span class="token entity" title="\\n">\\n</span>&lt;/body><span class="token entity" title="\\n">\\n</span>&lt;/html><span class="token entity" title="\\n">\\n</span>"</span>,\n            <span class="token string">"Start"</span><span class="token builtin class-name">:</span> <span class="token string">"2016-11-25T14:35:37.780192565Z"</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">]</span>,\n    <span class="token string">"Status"</span><span class="token builtin class-name">:</span> <span class="token string">"healthy"</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="label-指令"><a href="#label-%E6%8C%87%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>LABEL 指令</h2>\n<p>LABEL 指令用来给镜像以键值对的形式添加一些元数据（metadata）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97798517633315730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`LABEL <key>=<value> <key>=<value> <key>=<value> ...`, `97798517633315730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">LABEL</span> &lt;key<span class="token punctuation">></span>=&lt;value<span class="token punctuation">></span> &lt;key<span class="token punctuation">></span>=&lt;value<span class="token punctuation">></span> &lt;key<span class="token punctuation">></span>=&lt;value<span class="token punctuation">></span> <span class="token punctuation">...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>我们还可以用一些标签来申明镜像的作者、文档地址等：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52887467947601110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`LABEL org.opencontainers.image.authors=&quot;yeasy&quot;\n\nLABEL org.opencontainers.image.documentation=&quot;https://yeasy.gitbooks.io&quot;`, `52887467947601110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">LABEL</span> org.opencontainers.image.authors=<span class="token string">"yeasy"</span>\n\n<span class="token keyword">LABEL</span> org.opencontainers.image.documentation=<span class="token string">"https://yeasy.gitbooks.io"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>具体可以参考 <a href="https://github.com/opencontainers/image-spec/blob/master/annotations.md" target="_blank" rel="nofollow noreferrer noopener">https://github.com/opencontainers/image-spec/blob/master/annotations.md</a></p>\n<h2 id="shell-指令"><a href="#shell-%E6%8C%87%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>SHELL 指令</h2>\n<p>格式：<code class="language-text">SHELL [&quot;executable&quot;, &quot;parameters&quot;]</code></p>\n<p>SHELL 指令可以指定 <code class="language-text">RUN ENTRYPOINT CMD</code> 指令的 shell，Linux 中默认为 <code class="language-text">[&quot;/bin/sh&quot;, &quot;-c&quot;]</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86883731881118660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`SHELL [&quot;/bin/sh&quot;, &quot;-c&quot;]\n\nRUN lll ; ls\n\nSHELL [&quot;/bin/sh&quot;, &quot;-cex&quot;]\n\nRUN lll ; ls`, `86883731881118660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">SHELL</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">]</span>\n\n<span class="token keyword">RUN</span> lll ; ls\n\n<span class="token keyword">SHELL</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-cex"</span><span class="token punctuation">]</span>\n\n<span class="token keyword">RUN</span> lll ; ls</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>两个 RUN 运行同一命令，第二个 RUN 运行的命令会打印出每条命令并当遇到错误时退出。</p>\n<p>当 <code class="language-text">ENTRYPOINT CMD</code> 以 shell 格式指定时，SHELL 指令所指定的 shell 也会成为这两个指令的 shell</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68057363007839580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`SHELL [&quot;/bin/sh&quot;, &quot;-cex&quot;]\n\n# /bin/sh -cex &quot;nginx&quot;\nENTRYPOINT nginx`, `68057363007839580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">SHELL</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-cex"</span><span class="token punctuation">]</span>\n\n<span class="token comment"># /bin/sh -cex </span><span class="token string">"nginx"</span>\n<span class="token keyword">ENTRYPOINT</span> nginx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97020504689061820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`SHELL [&quot;/bin/sh&quot;, &quot;-cex&quot;]\n\n# /bin/sh -cex &quot;nginx&quot;\nCMD nginx`, `97020504689061820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">SHELL</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-cex"</span><span class="token punctuation">]</span>\n\n<span class="token comment"># /bin/sh -cex </span><span class="token string">"nginx"</span>\n<span class="token keyword">CMD</span> nginx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="onbuild-为他人做嫁衣裳"><a href="#onbuild-%E4%B8%BA%E4%BB%96%E4%BA%BA%E5%81%9A%E5%AB%81%E8%A1%A3%E8%A3%B3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ONBUILD 为他人做嫁衣裳</h2>\n<p>格式：<code class="language-text">ONBUILD &lt;其它指令&gt;</code>。</p>\n<p>ONBUILD 是一个特殊的指令，它后面跟的是其它指令，比如 RUN, COPY 等，而这些指令，在当前镜像构建时并不会被执行。只有当以当前镜像为基础镜像，去构建下一级镜像的时候才会被执行。</p>\n<p>Dockerfile 中的其它指令都是为了定制当前镜像而准备的，唯有 ONBUILD 是为了帮助别人定制自己而准备的。</p>\n<p>假设我们要制作 Node.js 所写的应用的镜像。我们都知道 Node.js 使用 npm 进行包管理，所有依赖、配置、启动信息等会放到 package.json 文件里。在拿到程序代码后，需要先进行 npm install 才可以获得所有需要的依赖。然后就可以通过 npm start 来启动应用。因此，一般来说会这样写 Dockerfile：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77682246565140090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM node:slim\nRUN mkdir /app\nWORKDIR /app\nCOPY ./package.json /app\nRUN [ &quot;npm&quot;, &quot;install&quot; ]\nCOPY . /app/\nCMD [ &quot;npm&quot;, &quot;start&quot; ]`, `77682246565140090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>slim\n<span class="token keyword">RUN</span> mkdir /app\n<span class="token keyword">WORKDIR</span> /app\n<span class="token keyword">COPY</span> ./package.json /app\n<span class="token keyword">RUN</span> <span class="token punctuation">[</span> <span class="token string">"npm"</span><span class="token punctuation">,</span> <span class="token string">"install"</span> <span class="token punctuation">]</span>\n<span class="token keyword">COPY</span> . /app/\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span> <span class="token string">"npm"</span><span class="token punctuation">,</span> <span class="token string">"start"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>把这个 Dockerfile 放到 Node.js 项目的根目录，构建好镜像后，就可以直接拿来启动容器运行。但是如果我们还有第二个 Node.js 项目也差不多呢？好吧，那就再把这个 Dockerfile 复制到第二个项目里。那如果有第三个项目呢？再复制么？文件的副本越多，版本控制就越困难，让我们继续看这样的场景维护的问题。</p>\n<p>如果第一个 Node.js 项目在开发过程中，发现这个 Dockerfile 里存在问题，比如敲错字了、或者需要安装额外的包，然后开发人员修复了这个 Dockerfile，再次构建，问题解决。第一个项目没问题了，但是第二个项目呢？虽然最初 Dockerfile 是复制、粘贴自第一个项目的，但是并不会因为第一个项目修复了他们的 Dockerfile，而第二个项目的 Dockerfile 就会被自动修复。</p>\n<p>那么我们可不可以做一个基础镜像，然后各个项目使用这个基础镜像呢？这样基础镜像更新，各个项目不用同步 Dockerfile 的变化，重新构建后就继承了基础镜像的更新？好吧，可以，让我们看看这样的结果。那么上面的这个 Dockerfile 就会变为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72038190669193630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM node:slim\nRUN mkdir /app\nWORKDIR /app\nCMD [ &quot;npm&quot;, &quot;start&quot; ]`, `72038190669193630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>slim\n<span class="token keyword">RUN</span> mkdir /app\n<span class="token keyword">WORKDIR</span> /app\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span> <span class="token string">"npm"</span><span class="token punctuation">,</span> <span class="token string">"start"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里我们把项目相关的构建指令拿出来，放到子项目里去。假设这个基础镜像的名字为 my-node 的话，各个项目内的自己的 Dockerfile 就变为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92179262038275560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM my-node\nCOPY ./package.json /app\nRUN [ &quot;npm&quot;, &quot;install&quot; ]\nCOPY . /app/`, `92179262038275560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> my<span class="token punctuation">-</span>node\n<span class="token keyword">COPY</span> ./package.json /app\n<span class="token keyword">RUN</span> <span class="token punctuation">[</span> <span class="token string">"npm"</span><span class="token punctuation">,</span> <span class="token string">"install"</span> <span class="token punctuation">]</span>\n<span class="token keyword">COPY</span> . /app/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>基础镜像变化后，各个项目都用这个 Dockerfile 重新构建镜像，会继承基础镜像的更新。</p>\n<p>那么，问题解决了么？没有。准确说，只解决了一半。如果这个 Dockerfile 里面有些东西需要调整呢？比如 npm install 都需要加一些参数，那怎么办？这一行 RUN 是不可能放入基础镜像的，因为涉及到了当前项目的 <code class="language-text">./package.json</code>，难道又要一个个修改么？所以说，这样制作基础镜像，只解决了原来的 Dockerfile 的前 4 条指令的变化问题，而后面三条指令的变化则完全没办法处理。</p>\n<p>ONBUILD 可以解决这个问题。让我们用 ONBUILD 重新写一下基础镜像的 Dockerfile:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3595908833874084400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM node:slim\nRUN mkdir /app\nWORKDIR /app\nONBUILD COPY ./package.json /app\nONBUILD RUN [ &quot;npm&quot;, &quot;install&quot; ]\nONBUILD COPY . /app/\nCMD [ &quot;npm&quot;, &quot;start&quot; ]`, `3595908833874084400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>slim\n<span class="token keyword">RUN</span> mkdir /app\n<span class="token keyword">WORKDIR</span> /app\n<span class="token keyword">ONBUILD</span> <span class="token keyword">COPY</span> ./package.json /app\n<span class="token keyword">ONBUILD</span> <span class="token keyword">RUN</span> <span class="token punctuation">[</span> <span class="token string">"npm"</span><span class="token punctuation">,</span> <span class="token string">"install"</span> <span class="token punctuation">]</span>\n<span class="token keyword">ONBUILD</span> <span class="token keyword">COPY</span> . /app/\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span> <span class="token string">"npm"</span><span class="token punctuation">,</span> <span class="token string">"start"</span> <span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这次我们回到原始的 Dockerfile，但是这次将项目相关的指令加上 ONBUILD，这样在构建基础镜像的时候，这三行并不会被执行。然后各个项目的 Dockerfile 就变成了简单地：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67795746867366290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM my-node`, `67795746867366290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> my<span class="token punctuation">-</span>node</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>是的，只有这么一行。当在各个项目目录中，用这个只有一行的 Dockerfile 构建镜像时，之前基础镜像的那三行 ONBUILD 就会开始执行，成功的将当前项目的代码复制进镜像、并且针对本项目执行 npm install，生成应用镜像。</p>\n<h2 id="多阶段构建"><a href="#%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%9E%84%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多阶段构建</h2>\n<h3 id="之前的做法"><a href="#%E4%B9%8B%E5%89%8D%E7%9A%84%E5%81%9A%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>之前的做法</h3>\n<p>在 Docker 17.05 版本之前，我们构建 Docker 镜像时，通常会采用两种方式：</p>\n<h4 id="全部放入一个-dockerfile"><a href="#%E5%85%A8%E9%83%A8%E6%94%BE%E5%85%A5%E4%B8%80%E4%B8%AA-dockerfile" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>全部放入一个 Dockerfile</h4>\n<p>一种方式是将所有的构建过程包含在一个 Dockerfile 中，包括项目及其依赖库的编译、测试、打包等流程，这里可能会带来的一些问题：</p>\n<ul>\n<li>镜像层次多，镜像体积较大，部署时间变长</li>\n<li>源代码存在泄露的风险</li>\n</ul>\n<p>例如，编写 app.go 文件，该程序输出 Hello World!</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39958998635825414000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`package main\n\nimport &quot;fmt&quot;\n\nfunc main(){\n    fmt.Printf(&quot;Hello World!&quot;);\n}`, `39958998635825414000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="go"\n              >\n                <span class="gatsby-code-button-language">go</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="go"><pre style="counter-reset: linenumber NaN" class="language-go line-numbers"><code class="language-go"><span class="token keyword">package</span> main\n\n<span class="token keyword">import</span> <span class="token string">"fmt"</span>\n\n<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Hello World!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>编写 Dockerfile.one 文件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7097027716271854000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM golang:alpine\n\nRUN apk --no-cache add git ca-certificates\n\nWORKDIR /go/src/github.com/go/helloworld/\n\nCOPY app.go .\n\nRUN go get -d -v github.com/go-sql-driver/mysql \\\n  && CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o app . \\\n  && cp /go/src/github.com/go/helloworld/app /root\n\nWORKDIR /root/\n\nCMD [&quot;./app&quot;]`, `7097027716271854000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> golang<span class="token punctuation">:</span>alpine\n\n<span class="token keyword">RUN</span> apk <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>cache add git ca<span class="token punctuation">-</span>certificates\n\n<span class="token keyword">WORKDIR</span> /go/src/github.com/go/helloworld/\n\n<span class="token keyword">COPY</span> app.go .\n\n<span class="token keyword">RUN</span> go get <span class="token punctuation">-</span>d <span class="token punctuation">-</span>v github.com/go<span class="token punctuation">-</span>sql<span class="token punctuation">-</span>driver/mysql \\\n  &amp;&amp; CGO_ENABLED=0 GOOS=linux go build <span class="token punctuation">-</span>a <span class="token punctuation">-</span>installsuffix cgo <span class="token punctuation">-</span>o app . \\\n  &amp;&amp; cp /go/src/github.com/go/helloworld/app /root\n\n<span class="token keyword">WORKDIR</span> /root/\n\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span><span class="token string">"./app"</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>构建镜像</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14972144480018223000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker build -t go/helloworld:1 -f Dockerfile.one .`, `14972144480018223000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker build -t go/helloworld:1 -f Dockerfile.one <span class="token builtin class-name">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="分散到多个-dockerfile"><a href="#%E5%88%86%E6%95%A3%E5%88%B0%E5%A4%9A%E4%B8%AA-dockerfile" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分散到多个 Dockerfile</h4>\n<p>另一种方式，就是我们事先在一个 Dockerfile 将项目及其依赖库编译测试打包好后，再将其拷贝到运行环境中，这种方式需要我们编写两个 Dockerfile 和一些编译脚本才能将其两个阶段自动整合起来，这种方式虽然可以很好地规避第一种方式存在的风险，但明显部署过程较复杂。</p>\n<p>例如，编写 Dockerfile.build 文件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93163429113833360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM golang:alpine\n\nRUN apk --no-cache add git\n\nWORKDIR /go/src/github.com/go/helloworld\n\nCOPY app.go .\n\nRUN go get -d -v github.com/go-sql-driver/mysql \\\n  && CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o app .`, `93163429113833360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> golang<span class="token punctuation">:</span>alpine\n\n<span class="token keyword">RUN</span> apk <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>cache add git\n\n<span class="token keyword">WORKDIR</span> /go/src/github.com/go/helloworld\n\n<span class="token keyword">COPY</span> app.go .\n\n<span class="token keyword">RUN</span> go get <span class="token punctuation">-</span>d <span class="token punctuation">-</span>v github.com/go<span class="token punctuation">-</span>sql<span class="token punctuation">-</span>driver/mysql \\\n  &amp;&amp; CGO_ENABLED=0 GOOS=linux go build <span class="token punctuation">-</span>a <span class="token punctuation">-</span>installsuffix cgo <span class="token punctuation">-</span>o app .</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>编写 Dockerfile.copy 文件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49988680008872400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM alpine:latest\n\nRUN apk --no-cache add ca-certificates\n\nWORKDIR /root/\n\nCOPY app .\n\nCMD [&quot;./app&quot;]`, `49988680008872400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> alpine<span class="token punctuation">:</span>latest\n\n<span class="token keyword">RUN</span> apk <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>cache add ca<span class="token punctuation">-</span>certificates\n\n<span class="token keyword">WORKDIR</span> /root/\n\n<span class="token keyword">COPY</span> app .\n\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span><span class="token string">"./app"</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>新建 build.sh</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18498365441970434000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/bin/sh\necho Building go/helloworld:build\n\ndocker build -t go/helloworld:build . -f Dockerfile.build\n\ndocker create --name extract go/helloworld:build\ndocker cp extract:/go/src/github.com/go/helloworld/app ./app\ndocker rm -f extract\n\necho Building go/helloworld:2\n\ndocker build --no-cache -t go/helloworld:2 . -f Dockerfile.copy\nrm ./app`, `18498365441970434000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>\n<span class="token builtin class-name">echo</span> Building go/helloworld:build\n\ndocker build -t go/helloworld:build <span class="token builtin class-name">.</span> -f Dockerfile.build\n\ndocker create --name extract go/helloworld:build\ndocker <span class="token function">cp</span> extract:/go/src/github.com/go/helloworld/app ./app\ndocker <span class="token function">rm</span> -f extract\n\n<span class="token builtin class-name">echo</span> Building go/helloworld:2\n\ndocker build --no-cache -t go/helloworld:2 <span class="token builtin class-name">.</span> -f Dockerfile.copy\n<span class="token function">rm</span> ./app</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在运行脚本即可构建镜像</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85136231453713920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ chmod +x build.sh\n\n\\$ ./build.sh`, `85136231453713920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">chmod</span> +x build.sh\n\n$ ./build.sh</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>对比两种方式生成的镜像大小</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89399255498831530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls\n\nREPOSITORY      TAG    IMAGE ID        CREATED         SIZE\ngo/helloworld   2      f7cf3465432c    22 seconds ago  6.47MB\ngo/helloworld   1      f55d3e16affc    2 minutes ago   295MB`, `89399255498831530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span>\n\nREPOSITORY      TAG    IMAGE ID        CREATED         SIZE\ngo/helloworld   <span class="token number">2</span>      f7cf3465432c    <span class="token number">22</span> seconds ago  <span class="token number">6</span>.47MB\ngo/helloworld   <span class="token number">1</span>      f55d3e16affc    <span class="token number">2</span> minutes ago   295MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="使用多阶段构建"><a href="#%E4%BD%BF%E7%94%A8%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%9E%84%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用多阶段构建</h3>\n<p>为解决以上问题，Docker v17.05 开始支持多阶段构建 (multistage builds)。使用多阶段构建我们就可以很容易解决前面提到的问题，并且只需要编写一个 Dockerfile：</p>\n<p>例如，编写 Dockerfile 文件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8841609452882815000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM golang:alpine as builder\n\nRUN apk --no-cache add git\n\nWORKDIR /go/src/github.com/go/helloworld/\n\nRUN go get -d -v github.com/go-sql-driver/mysql\n\nCOPY app.go .\n\nRUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o app .\n\nFROM alpine:latest as prod\n\nRUN apk --no-cache add ca-certificates\n\nWORKDIR /root/\n\nCOPY --from=0 /go/src/github.com/go/helloworld/app .\n\nCMD [&quot;./app&quot;]`, `8841609452882815000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> golang<span class="token punctuation">:</span>alpine as builder\n\n<span class="token keyword">RUN</span> apk <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>cache add git\n\n<span class="token keyword">WORKDIR</span> /go/src/github.com/go/helloworld/\n\n<span class="token keyword">RUN</span> go get <span class="token punctuation">-</span>d <span class="token punctuation">-</span>v github.com/go<span class="token punctuation">-</span>sql<span class="token punctuation">-</span>driver/mysql\n\n<span class="token keyword">COPY</span> app.go .\n\n<span class="token keyword">RUN</span> CGO_ENABLED=0 GOOS=linux go build <span class="token punctuation">-</span>a <span class="token punctuation">-</span>installsuffix cgo <span class="token punctuation">-</span>o app .\n\n<span class="token keyword">FROM</span> alpine<span class="token punctuation">:</span>latest as prod\n\n<span class="token keyword">RUN</span> apk <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>cache add ca<span class="token punctuation">-</span>certificates\n\n<span class="token keyword">WORKDIR</span> /root/\n\n<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>from=0 /go/src/github.com/go/helloworld/app .\n\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span><span class="token string">"./app"</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>构建镜像</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86209406768305360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker build -t go/helloworld:3 .`, `86209406768305360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker build -t go/helloworld:3 <span class="token builtin class-name">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>对比三个镜像大小</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57594672184292730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker image ls\n\nREPOSITORY        TAG   IMAGE ID         CREATED            SIZE\ngo/helloworld     3     d6911ed9c846     7 seconds ago      6.47MB\ngo/helloworld     2     f7cf3465432c     22 seconds ago     6.47MB\ngo/helloworld     1     f55d3e16affc     2 minutes ago      295MB`, `57594672184292730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker image <span class="token function">ls</span>\n\nREPOSITORY        TAG   IMAGE ID         CREATED            SIZE\ngo/helloworld     <span class="token number">3</span>     d6911ed9c846     <span class="token number">7</span> seconds ago      <span class="token number">6</span>.47MB\ngo/helloworld     <span class="token number">2</span>     f7cf3465432c     <span class="token number">22</span> seconds ago     <span class="token number">6</span>.47MB\ngo/helloworld     <span class="token number">1</span>     f55d3e16affc     <span class="token number">2</span> minutes ago      295MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>很明显使用多阶段构建的镜像体积小，同时也完美解决了上边提到的问题。</p>\n<h4 id="只构建某一阶段的镜像"><a href="#%E5%8F%AA%E6%9E%84%E5%BB%BA%E6%9F%90%E4%B8%80%E9%98%B6%E6%AE%B5%E7%9A%84%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>只构建某一阶段的镜像</h4>\n<p>我们可以使用 as 来为某一阶段命名，例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60910056524855484000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM golang:alpine as builder`, `60910056524855484000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> golang<span class="token punctuation">:</span>alpine as builder</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>例如当我们只想构建 builder 阶段的镜像时，增加 —target=builder 参数即可</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35766116277654225000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker build --target builder -t username/imagename:tag .`, `35766116277654225000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile">$ docker build <span class="token punctuation">-</span><span class="token punctuation">-</span>target builder <span class="token punctuation">-</span>t username/imagename<span class="token punctuation">:</span>tag .</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="构建时从其他镜像复制文件"><a href="#%E6%9E%84%E5%BB%BA%E6%97%B6%E4%BB%8E%E5%85%B6%E4%BB%96%E9%95%9C%E5%83%8F%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建时从其他镜像复制文件</h4>\n<p>上面例子中我们使用 <code class="language-text">COPY --from=0 /go/src/github.com/go/helloworld/app .</code> 从上一阶段的镜像中复制文件，我们也可以复制任意镜像中的文件。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2977189666622970400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ COPY --from=nginx:latest /etc/nginx/nginx.conf /nginx.conf`, `2977189666622970400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile">$ COPY <span class="token punctuation">-</span><span class="token punctuation">-</span>from=nginx<span class="token punctuation">:</span>latest /etc/nginx/nginx.conf /nginx.conf</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="构建多种系统架构支持的-docker-镜像----docker-manifest-命令详解"><a href="#%E6%9E%84%E5%BB%BA%E5%A4%9A%E7%A7%8D%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E6%94%AF%E6%8C%81%E7%9A%84-docker-%E9%95%9C%E5%83%8F----docker-manifest-%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建多种系统架构支持的 Docker 镜像 — docker manifest 命令详解</h2>\n<p>我们知道使用镜像创建一个容器，该镜像必须与 Docker 宿主机系统架构一致，例如 <code class="language-text">Linux x86_64</code> 架构的系统中只能使用 <code class="language-text">Linux x86_64</code> 的镜像创建容器。</p>\n<p>Windows、macOS 除外，其使用了 <code class="language-text">binfmt_misc</code> 提供了多种架构支持，在 Windows、macOS 系统上 (x86_64) 可以运行 arm 等其他架构的镜像。</p>\n<p>例如我们在 <code class="language-text">Linux x86_64</code> 中构建一个 <code class="language-text">username/test</code> 镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68852841668394650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM alpine\n\nCMD echo 1`, `68852841668394650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> alpine\n\n<span class="token keyword">CMD</span> echo 1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>构建镜像后推送到 Docker Hub，之后我们尝试在树莓派 Linux arm64v8 中使用这个镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58596764976287160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -it --rm username/test`, `58596764976287160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -it --rm username/test</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>可以发现这个镜像根本获取不到。</p>\n<p>要解决这个问题，通常采用的做法是通过镜像名区分不同系统架构的镜像，例如在 <code class="language-text">Linux x86_64</code> 和 <code class="language-text">Linux arm64v8</code> 分别构建 <code class="language-text">username/test</code> 和 <code class="language-text">username/arm64v8-test</code> 镜像。运行时使用对应架构的镜像即可。</p>\n<p>这样做显得很繁琐，那么有没有一种方法让 Docker 引擎根据系统架构自动拉取对应的镜像呢？</p>\n<p>我们发现在 <code class="language-text">Linux x86_64</code> 和 <code class="language-text">Linux arm64v8</code> 架构的计算机中分别使用 <code class="language-text">golang:alpine</code> 镜像运行容器 <code class="language-text">$ docker run golang:alpine go version</code> 时，容器能够正常的运行。</p>\n<p>这是什么原因呢？</p>\n<p>原因就是 <code class="language-text">golang:alpine</code> 官方镜像有一个 manifest 列表 (manifest list) 。</p>\n<p>当用户获取一个镜像时，Docker 引擎会首先查找该镜像是否有 manifest 列表，如果有的话 Docker 引擎会按照 Docker 运行环境（系统及架构）查找出对应镜像（例如 golang:alpine）。如果没有的话会直接获取镜像（例如上例中我们构建的 username/test）。</p>\n<p>我们可以使用 <code class="language-text">$ docker manifest inspect golang:alpine</code> 查看这个 manifest 列表的结构。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59105569593673430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker manifest inspect golang:alpine`, `59105569593673430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker manifest inspect golang:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62171132483727385000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;schemaVersion&quot;: 2,\n  &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.list.v2+json&quot;,\n  &quot;manifests&quot;: [\n    {\n      &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,\n      &quot;size&quot;: 1365,\n      &quot;digest&quot;: &quot;sha256:5e28ac423243b187f464d635bcfe1e909f4a31c6c8bce51d0db0a1062bec9e16&quot;,\n      &quot;platform&quot;: {\n        &quot;architecture&quot;: &quot;amd64&quot;,\n        &quot;os&quot;: &quot;linux&quot;\n      }\n    },\n    {\n      &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,\n      &quot;size&quot;: 1365,\n      &quot;digest&quot;: &quot;sha256:2945c46e26c9787da884b4065d1de64cf93a3b81ead1b949843dda1fcd458bae&quot;,\n      &quot;platform&quot;: {\n        &quot;architecture&quot;: &quot;arm&quot;,\n        &quot;os&quot;: &quot;linux&quot;,\n        &quot;variant&quot;: &quot;v7&quot;\n      }\n    },\n    {\n      &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,\n      &quot;size&quot;: 1365,\n      &quot;digest&quot;: &quot;sha256:87fff60114fd3402d0c1a7ddf1eea1ded658f171749b57dc782fd33ee2d47b2d&quot;,\n      &quot;platform&quot;: {\n        &quot;architecture&quot;: &quot;arm64&quot;,\n        &quot;os&quot;: &quot;linux&quot;,\n        &quot;variant&quot;: &quot;v8&quot;\n      }\n    },\n    {\n      &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,\n      &quot;size&quot;: 1365,\n      &quot;digest&quot;: &quot;sha256:607b43f1d91144f82a9433764e85eb3ccf83f73569552a49bc9788c31b4338de&quot;,\n      &quot;platform&quot;: {\n        &quot;architecture&quot;: &quot;386&quot;,\n        &quot;os&quot;: &quot;linux&quot;\n      }\n    },\n    {\n      &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,\n      &quot;size&quot;: 1365,\n      &quot;digest&quot;: &quot;sha256:25ead0e21ed5e246ce31e274b98c09aaf548606788ef28eaf375dc8525064314&quot;,\n      &quot;platform&quot;: {\n        &quot;architecture&quot;: &quot;ppc64le&quot;,\n        &quot;os&quot;: &quot;linux&quot;\n      }\n    },\n    {\n      &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,\n      &quot;size&quot;: 1365,\n      &quot;digest&quot;: &quot;sha256:69f5907fa93ea591175b2c688673775378ed861eeb687776669a48692bb9754d&quot;,\n      &quot;platform&quot;: {\n        &quot;architecture&quot;: &quot;s390x&quot;,\n        &quot;os&quot;: &quot;linux&quot;\n      }\n    }\n  ]\n}`, `62171132483727385000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"schemaVersion"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n  <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.list.v2+json"</span><span class="token punctuation">,</span>\n  <span class="token property">"manifests"</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>\n      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">1365</span><span class="token punctuation">,</span>\n      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:5e28ac423243b187f464d635bcfe1e909f4a31c6c8bce51d0db0a1062bec9e16"</span><span class="token punctuation">,</span>\n      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"amd64"</span><span class="token punctuation">,</span>\n        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>\n      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">1365</span><span class="token punctuation">,</span>\n      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:2945c46e26c9787da884b4065d1de64cf93a3b81ead1b949843dda1fcd458bae"</span><span class="token punctuation">,</span>\n      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"arm"</span><span class="token punctuation">,</span>\n        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span><span class="token punctuation">,</span>\n        <span class="token property">"variant"</span><span class="token operator">:</span> <span class="token string">"v7"</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>\n      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">1365</span><span class="token punctuation">,</span>\n      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:87fff60114fd3402d0c1a7ddf1eea1ded658f171749b57dc782fd33ee2d47b2d"</span><span class="token punctuation">,</span>\n      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"arm64"</span><span class="token punctuation">,</span>\n        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span><span class="token punctuation">,</span>\n        <span class="token property">"variant"</span><span class="token operator">:</span> <span class="token string">"v8"</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>\n      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">1365</span><span class="token punctuation">,</span>\n      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:607b43f1d91144f82a9433764e85eb3ccf83f73569552a49bc9788c31b4338de"</span><span class="token punctuation">,</span>\n      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"386"</span><span class="token punctuation">,</span>\n        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>\n      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">1365</span><span class="token punctuation">,</span>\n      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:25ead0e21ed5e246ce31e274b98c09aaf548606788ef28eaf375dc8525064314"</span><span class="token punctuation">,</span>\n      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"ppc64le"</span><span class="token punctuation">,</span>\n        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>\n      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">1365</span><span class="token punctuation">,</span>\n      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:69f5907fa93ea591175b2c688673775378ed861eeb687776669a48692bb9754d"</span><span class="token punctuation">,</span>\n      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"s390x"</span><span class="token punctuation">,</span>\n        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看出 manifest 列表中包含了不同系统架构所对应的镜像 digest 值，这样 Docker 就可以在不同的架构中使用相同的 manifest (例如 golang:alpine) 获取对应的镜像。</p>\n<p>下面介绍如何使用 <code class="language-text">$ docker manifest</code> 命令创建并推送 manifest 列表到 Docker Hub。</p>\n<h3 id="构建镜像-1"><a href="#%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建镜像</h3>\n<p>首先在 <code class="language-text">Linux x86_64</code> 构建 <code class="language-text">username/x8664-test</code> 镜像。并在 <code class="language-text">Linux arm64v8</code> 中构建 <code class="language-text">username/arm64v8-test</code> 镜像，构建好之后推送到 Docker Hub。</p>\n<h3 id="创建-manifest-列表"><a href="#%E5%88%9B%E5%BB%BA-manifest-%E5%88%97%E8%A1%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建 manifest 列表</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63017256601428710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# \\$ docker manifest create MANIFEST_LIST MANIFEST [MANIFEST...]\n\\$ docker manifest create username/test \\\n      username/x8664-test \\\n      username/arm64v8-test`, `63017256601428710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># $ docker manifest create MANIFEST_LIST MANIFEST [MANIFEST...]</span>\n$ docker manifest create username/test <span class="token punctuation">\\</span>\n      username/x8664-test <span class="token punctuation">\\</span>\n      username/arm64v8-test</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当要修改一个 manifest 列表时，可以加入 -a 或 —amend 参数。</p>\n<h3 id="设置-manifest-列表"><a href="#%E8%AE%BE%E7%BD%AE-manifest-%E5%88%97%E8%A1%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>设置 manifest 列表</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22293675611055575000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# \\$ docker manifest annotate [OPTIONS] MANIFEST_LIST MANIFEST\n\\$ docker manifest annotate username/test \\\n      username/x8664-test \\\n      --os linux --arch x86_64\n\n\\$ docker manifest annotate username/test \\\n      username/arm64v8-test \\\n      --os linux --arch arm64 --variant v8`, `22293675611055575000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># $ docker manifest annotate [OPTIONS] MANIFEST_LIST MANIFEST</span>\n$ docker manifest annotate username/test <span class="token punctuation">\\</span>\n      username/x8664-test <span class="token punctuation">\\</span>\n      --os linux --arch x86_64\n\n$ docker manifest annotate username/test <span class="token punctuation">\\</span>\n      username/arm64v8-test <span class="token punctuation">\\</span>\n      --os linux --arch arm64 --variant v8</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样就配置好了 manifest 列表。</p>\n<h3 id="查看-manifest-列表"><a href="#%E6%9F%A5%E7%9C%8B-manifest-%E5%88%97%E8%A1%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看 manifest 列表</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82906660185520240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker manifest inspect username/test`, `82906660185520240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker manifest inspect username/test</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="推送-manifest-列表"><a href="#%E6%8E%A8%E9%80%81-manifest-%E5%88%97%E8%A1%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>推送 manifest 列表</h3>\n<p>最后我们可以将其推送到 Docker Hub。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81671630233516980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker manifest push username/test`, `81671630233516980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker manifest push username/test</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="测试"><a href="#%E6%B5%8B%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试</h3>\n<p>我们在 <code class="language-text">Linux x86_64</code> <code class="language-text">Linux arm64v8</code> 中分别执行 <code class="language-text">$ docker run -it --rm username/test</code> 命令，发现可以正确的执行。</p>\n<h1 id="操作容器"><a href="#%E6%93%8D%E4%BD%9C%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>操作容器</h1>\n<p>容器是 Docker 又一核心概念。</p>\n<p>简单的说，容器是独立运行的一个或一组应用，以及它们的运行态环境。对应的，虚拟机可以理解为模拟运行的一整套操作系统（提供了运行态环境和其他系统环境）和跑在上面的应用。</p>\n<p>本章将具体介绍如何来管理一个容器，包括创建、启动和停止等。</p>\n<h2 id="启动容器"><a href="#%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>启动容器</h2>\n<p>启动容器有两种方式，一种是基于镜像新建一个容器并启动，另外一个是将在终止状态（exited）的容器重新启动。</p>\n<p>因为 Docker 的容器实在太轻量级了，很多时候用户都是随时删除和新创建容器。</p>\n<h3 id="新建并启动"><a href="#%E6%96%B0%E5%BB%BA%E5%B9%B6%E5%90%AF%E5%8A%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>新建并启动</h3>\n<p>所需要的命令主要为 docker run。</p>\n<p>例如，下面的命令输出一个 “Hello World”，之后终止容器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12509714046073772000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run ubuntu:18.04 /bin/echo \'Hello world\'\nHello world`, `12509714046073772000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run ubuntu:18.04 /bin/echo <span class="token string">\'Hello world\'</span>\nHello world</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这跟在本地直接执行 <code class="language-text">/bin/echo &#39;hello world&#39;</code> 几乎感觉不出任何区别。</p>\n<p>下面的命令则启动一个 bash 终端，允许用户进行交互。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81744080697475650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -t -i ubuntu:18.04 /bin/bash\nroot@af8bae53bdd3:/#`, `81744080697475650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -t -i ubuntu:18.04 /bin/bash\nroot@af8bae53bdd3:/<span class="token comment">#</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>其中，<code class="language-text">-t</code> 选项让 Docker 分配一个伪终端（pseudo-tty）并绑定到容器的标准输入上，<code class="language-text">-i</code> 则让容器的标准输入保持打开。</p>\n<p>在交互模式下，用户可以通过所创建的终端来输入命令，例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18353944815948143000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`root@af8bae53bdd3:/# pwd\n/\nroot@af8bae53bdd3:/# ls\nbin boot dev etc home lib lib64 media mnt opt proc root run sbin srv sys tmp usr var`, `18353944815948143000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">root@af8bae53bdd3:/<span class="token comment"># pwd</span>\n/\nroot@af8bae53bdd3:/<span class="token comment"># ls</span>\nbin boot dev etc home lib lib64 media mnt opt proc root run sbin srv sys tmp usr var</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当利用 docker run 来创建容器时，Docker 在后台运行的标准操作包括：</p>\n<ul>\n<li>检查本地是否存在指定的镜像，不存在就从 registry 下载</li>\n<li>利用镜像创建并启动一个容器</li>\n<li>分配一个文件系统，并在只读的镜像层外面挂载一层可读写层</li>\n<li>从宿主主机配置的网桥接口中桥接一个虚拟接口到容器中去</li>\n<li>从地址池配置一个 ip 地址给容器</li>\n<li>执行用户指定的应用程序</li>\n<li>执行完毕后容器被终止</li>\n</ul>\n<h3 id="启动已终止容器"><a href="#%E5%90%AF%E5%8A%A8%E5%B7%B2%E7%BB%88%E6%AD%A2%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>启动已终止容器</h3>\n<p>可以利用 <code class="language-text">docker container start</code> 命令，直接将一个已经终止（exited）的容器启动运行。</p>\n<p>容器的核心为所执行的应用程序，所需要的资源都是应用程序运行所必需的。除此之外，并没有其它的资源。可以在伪终端中利用 ps 或 top 来查看进程信息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21885176222017510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`root@ba267838cc1b:/# ps\n  PID TTY          TIME CMD\n    1 ?        00:00:00 bash\n   11 ?        00:00:00 ps`, `21885176222017510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">root@ba267838cc1b:/<span class="token comment"># ps</span>\n  PID TTY          TIME CMD\n    <span class="token number">1</span> ?        00:00:00 <span class="token function">bash</span>\n   <span class="token number">11</span> ?        00:00:00 <span class="token function">ps</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可见，容器中仅运行了指定的 bash 应用。这种特点使得 Docker 对资源的利用率极高，是货真价实的轻量级虚拟化。</p>\n<h2 id="后台运行"><a href="#%E5%90%8E%E5%8F%B0%E8%BF%90%E8%A1%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后台运行</h2>\n<p>更多的时候，需要让 Docker 在后台运行而不是直接把执行命令的结果输出在当前宿主机下。此时，可以通过添加 <code class="language-text">-d</code> 参数来实现。</p>\n<p>下面举两个例子来说明一下。</p>\n<p>如果不使用 <code class="language-text">-d</code> 参数运行容器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67186479150583840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run ubuntu:18.04 /bin/sh -c &quot;while true; do echo hello world; sleep 1; done&quot;\nhello world\nhello world\nhello world\nhello world`, `67186479150583840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run ubuntu:18.04 /bin/sh -c <span class="token string">"while true; do echo hello world; sleep 1; done"</span>\nhello world\nhello world\nhello world\nhello world</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>容器会把输出的结果 (STDOUT) 打印到宿主机上面</p>\n<p>如果使用了 <code class="language-text">-d</code> 参数运行容器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97838294709483980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d ubuntu:18.04 /bin/sh -c &quot;while true; do echo hello world; sleep 1; done&quot;\n77b2dc01fe0f3f1265df143181e7b9af5e05279a884f4776ee75350ea9d8017a`, `97838294709483980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d ubuntu:18.04 /bin/sh -c <span class="token string">"while true; do echo hello world; sleep 1; done"</span>\n77b2dc01fe0f3f1265df143181e7b9af5e05279a884f4776ee75350ea9d8017a</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>此时容器会在后台运行并不会把输出的结果 (STDOUT) 打印到宿主机上面(输出结果可以用 <code class="language-text">docker logs</code> 查看)。</p>\n<blockquote>\n<p>注：容器是否会长久运行，是和 docker run 指定的命令有关，和 <code class="language-text">-d</code> 参数无关。</p>\n</blockquote>\n<p>使用 <code class="language-text">-d</code> 参数启动后会返回一个唯一的 id，也可以通过 docker container ls 命令来查看容器信息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50426051526663020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container ls\nCONTAINER ID  IMAGE         COMMAND               CREATED        STATUS       PORTS NAMES\n77b2dc01fe0f  ubuntu:18.04  /bin/sh -c \'while tr  2 minutes ago  Up 1 minute        agitated_wright`, `50426051526663020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container <span class="token function">ls</span>\nCONTAINER ID  IMAGE         COMMAND               CREATED        STATUS       PORTS NAMES\n77b2dc01fe0f  ubuntu:18.04  /bin/sh -c \'while <span class="token function">tr</span>  <span class="token number">2</span> minutes ago  Up <span class="token number">1</span> minute        agitated_wright</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>要获取容器的输出信息，可以通过 <code class="language-text">docker container logs</code> 命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50129139671598285000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container logs [container ID or NAMES]\nhello world\nhello world\nhello world\n. . .`, `50129139671598285000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container logs <span class="token punctuation">[</span>container ID or NAMES<span class="token punctuation">]</span>\nhello world\nhello world\nhello world\n<span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="终止容器"><a href="#%E7%BB%88%E6%AD%A2%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>终止容器</h2>\n<p>可以使用 <code class="language-text">docker container stop</code> 来终止一个运行中的容器。</p>\n<p>此外，当 Docker 容器中指定的应用终结时，容器也自动终止。</p>\n<p>例如对于上一章节中只启动了一个终端的容器，用户通过 <code class="language-text">exit</code> 命令或 <code class="language-text">Ctrl+d</code> 来退出终端时，所创建的容器立刻终止。</p>\n<p>终止状态的容器可以用 <code class="language-text">docker container ls -a</code> 命令看到。例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90592444964562030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container ls -a\nCONTAINER ID        IMAGE                    COMMAND                CREATED             STATUS                          PORTS               NAMES\nba267838cc1b        ubuntu:18.04             &quot;/bin/bash&quot;            30 minutes ago      Exited (0) About a minute ago                       trusting_newton`, `90592444964562030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container <span class="token function">ls</span> -a\nCONTAINER ID        IMAGE                    COMMAND                CREATED             STATUS                          PORTS               NAMES\nba267838cc1b        ubuntu:18.04             <span class="token string">"/bin/bash"</span>            <span class="token number">30</span> minutes ago      Exited <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> About a minute ago                       trusting_newton</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>处于终止状态的容器，可以通过 <code class="language-text">docker container start</code> 命令来重新启动。</p>\n<p>此外，<code class="language-text">docker container restart</code> 命令会将一个运行态的容器终止，然后再重新启动它。</p>\n<h2 id="进入容器"><a href="#%E8%BF%9B%E5%85%A5%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>进入容器</h2>\n<p>在使用 <code class="language-text">-d</code> 参数时，容器启动后会进入后台。</p>\n<p>某些时候需要进入容器进行操作，包括使用 docker attach 命令或 docker exec 命令，推荐大家使用 docker exec 命令，原因会在下面说明。</p>\n<h3 id="attach-命令"><a href="#attach-%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>attach 命令</h3>\n<p>下面示例如何使用 docker attach 命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10224574010013309000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -dit ubuntu\n243c32535da7d142fb0e6df616a3c3ada0b8ab417937c853a9e1c251f499f550\n\n\\$ docker container ls\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n243c32535da7        ubuntu:latest       &quot;/bin/bash&quot;         18 seconds ago      Up 17 seconds                           nostalgic_hypatia\n\n\\$ docker attach 243c\nroot@243c32535da7:/#`, `10224574010013309000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -dit ubuntu\n243c32535da7d142fb0e6df616a3c3ada0b8ab417937c853a9e1c251f499f550\n\n$ docker container <span class="token function">ls</span>\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n243c32535da7        ubuntu:latest       <span class="token string">"/bin/bash"</span>         <span class="token number">18</span> seconds ago      Up <span class="token number">17</span> seconds                           nostalgic_hypatia\n\n$ docker attach 243c\nroot@243c32535da7:/<span class="token comment">#</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意：如果从这个 stdin 中 exit，会导致容器的停止。</p>\n<h3 id="exec-命令--i--t-参数"><a href="#exec-%E5%91%BD%E4%BB%A4--i--t-%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>exec 命令 -i -t 参数</h3>\n<p>docker exec 后边可以跟多个参数，这里主要说明 <code class="language-text">-i -t</code> 参数。</p>\n<p>只用 <code class="language-text">-i</code> 参数时，由于没有分配伪终端，界面没有我们熟悉的 Linux 命令提示符，但命令执行结果仍然可以返回。</p>\n<p>当 <code class="language-text">-i -t</code> 参数一起使用时，则可以看到我们熟悉的 Linux 命令提示符。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88350121134945830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -dit ubuntu\n69d137adef7a8a689cbcb059e94da5489d3cddd240ff675c640c8d96e84fe1f6\n\n\\$ docker container ls\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n69d137adef7a        ubuntu:latest       &quot;/bin/bash&quot;         18 seconds ago      Up 17 seconds                           zealous_swirles\n\n\\$ docker exec -i 69d1 bash\nls\nbin\nboot\ndev\n...\n\n\\$ docker exec -it 69d1 bash\nroot@69d137adef7a:/#`, `88350121134945830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -dit ubuntu\n69d137adef7a8a689cbcb059e94da5489d3cddd240ff675c640c8d96e84fe1f6\n\n$ docker container <span class="token function">ls</span>\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n69d137adef7a        ubuntu:latest       <span class="token string">"/bin/bash"</span>         <span class="token number">18</span> seconds ago      Up <span class="token number">17</span> seconds                           zealous_swirles\n\n$ docker <span class="token builtin class-name">exec</span> -i 69d1 <span class="token function">bash</span>\n<span class="token function">ls</span>\nbin\nboot\ndev\n<span class="token punctuation">..</span>.\n\n$ docker <span class="token builtin class-name">exec</span> -it 69d1 <span class="token function">bash</span>\nroot@69d137adef7a:/<span class="token comment">#</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果从这个 stdin 中 exit，不会导致容器的停止。这就是为什么推荐大家使用 docker exec 的原因。</p>\n<p>更多参数说明请使用 <code class="language-text">docker exec --help</code> 查看。</p>\n<h2 id="导出和导入容器"><a href="#%E5%AF%BC%E5%87%BA%E5%92%8C%E5%AF%BC%E5%85%A5%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>导出和导入容器</h2>\n<h3 id="导出容器"><a href="#%E5%AF%BC%E5%87%BA%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>导出容器</h3>\n<p>如果要导出本地某个容器，可以使用 docker export 命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15596787956706759000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container ls -a\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                    PORTS               NAMES\n7691a814370e        ubuntu:18.04        &quot;/bin/bash&quot;         36 hours ago        Exited (0) 21 hours ago                       test\n\\$ docker export 7691a814370e > ubuntu.tar`, `15596787956706759000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container <span class="token function">ls</span> -a\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                    PORTS               NAMES\n7691a814370e        ubuntu:18.04        <span class="token string">"/bin/bash"</span>         <span class="token number">36</span> hours ago        Exited <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token number">21</span> hours ago                       <span class="token builtin class-name">test</span>\n$ docker <span class="token builtin class-name">export</span> 7691a814370e <span class="token operator">></span> ubuntu.tar</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样将导出容器快照到本地文件。</p>\n<h3 id="导入容器快照"><a href="#%E5%AF%BC%E5%85%A5%E5%AE%B9%E5%99%A8%E5%BF%AB%E7%85%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>导入容器快照</h3>\n<p>可以使用 docker import 从容器快照文件中再导入为镜像，例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10462465314826285000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ cat ubuntu.tar | docker import - test/ubuntu:v1.0\n\\$ docker image ls\nREPOSITORY          TAG                 IMAGE ID            CREATED              VIRTUAL SIZE\ntest/ubuntu         v1.0                9d37a6082e97        About a minute ago   171.3 MB`, `10462465314826285000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">cat</span> ubuntu.tar <span class="token operator">|</span> docker <span class="token function">import</span> - test/ubuntu:v1.0\n$ docker image <span class="token function">ls</span>\nREPOSITORY          TAG                 IMAGE ID            CREATED              VIRTUAL SIZE\ntest/ubuntu         v1.0                9d37a6082e97        About a minute ago   <span class="token number">171.3</span> MB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>此外，也可以通过指定 URL 或者某个目录来导入，例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25629860937554130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker import http://example.com/exampleimage.tgz example/imagerepo`, `25629860937554130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">import</span> http://example.com/exampleimage.tgz example/imagerepo</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<blockquote>\n<p>注：用户既可以使用 docker load 来导入镜像存储文件到本地镜像库，也可以使用 docker import 来导入一个容器快照到本地镜像库。这两者的区别在于容器快照文件将丢弃所有的历史记录和元数据信息（即仅保存容器当时的快照状态），而镜像存储文件将保存完整记录，体积也要大。此外，从容器快照文件导入时可以重新指定标签等元数据信息。</p>\n</blockquote>\n<h2 id="删除容器"><a href="#%E5%88%A0%E9%99%A4%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>删除容器</h2>\n<p>可以使用 <code class="language-text">docker container rm</code> 来删除一个处于终止状态的容器。例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38960638766450600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container rm trusting_newton\ntrusting_newton`, `38960638766450600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container <span class="token function">rm</span> trusting_newton\ntrusting_newton</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果要删除一个运行中的容器，可以添加 -f 参数。Docker 会发送 SIGKILL 信号给容器。</p>\n<h3 id="清理所有处于终止状态的容器"><a href="#%E6%B8%85%E7%90%86%E6%89%80%E6%9C%89%E5%A4%84%E4%BA%8E%E7%BB%88%E6%AD%A2%E7%8A%B6%E6%80%81%E7%9A%84%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>清理所有处于终止状态的容器</h3>\n<p>用 <code class="language-text">docker container ls -a</code> 命令可以查看所有已经创建的包括终止状态的容器，如果数量太多要一个个删除可能会很麻烦，用下面的命令可以清理掉所有处于终止状态的容器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54554232012855660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container prune`, `54554232012855660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container prune</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h1 id="docker-仓库"><a href="#docker-%E4%BB%93%E5%BA%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 仓库</h1>\n<p>仓库（Repository）是集中存放镜像的地方。</p>\n<p>一个容易混淆的概念是注册服务器（Registry）。实际上注册服务器是管理仓库的具体服务器，每个服务器上可以有多个仓库，而每个仓库下面有多个镜像。从这方面来说，仓库可以被认为是一个具体的项目或目录。例如对于仓库地址 <code class="language-text">docker.io/ubuntu</code> 来说，docker.io 是注册服务器地址，ubuntu 是仓库名。</p>\n<p>大部分时候，并不需要严格区分这两者的概念。</p>\n<h2 id="docker-hub"><a href="#docker-hub" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker Hub</h2>\n<p>目前 Docker 官方维护了一个公共仓库 Docker Hub，大部分需求都可以通过在 Docker Hub 中直接下载镜像来实现。</p>\n<h3 id="注册"><a href="#%E6%B3%A8%E5%86%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>注册</h3>\n<p>你可以在 <a href="https://hub.docker.com" target="_blank" rel="nofollow noreferrer noopener">https://hub.docker.com</a> 免费注册一个 Docker 账号。</p>\n<h3 id="登录"><a href="#%E7%99%BB%E5%BD%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>登录</h3>\n<p>可以通过执行 docker login 命令交互式的输入用户名及密码来完成在命令行界面登录 Docker Hub。</p>\n<p>你可以通过 docker logout 退出登录。</p>\n<h3 id="拉取镜像"><a href="#%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>拉取镜像</h3>\n<p>你可以通过 docker search 命令来查找官方仓库中的镜像，并利用 docker pull 命令来将它下载到本地。</p>\n<p>例如以 centos 为关键词进行搜索：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78014893710739140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker search centos\nNAME                               DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED\ncentos                             The official build of CentOS.                   6449      [OK]\nansible/centos7-ansible            Ansible on Centos7                              132                  [OK]\nconsol/centos-xfce-vnc             Centos container with &quot;headless&quot; VNC session…   126                  [OK]\njdeathe/centos-ssh                 OpenSSH / Supervisor / EPEL/IUS/SCL Repos - …   117                  [OK]\ncentos/systemd                     systemd enabled base container.                 96                   [OK]`, `78014893710739140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker search centos\nNAME                               DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED\ncentos                             The official build of CentOS.                   <span class="token number">6449</span>      <span class="token punctuation">[</span>OK<span class="token punctuation">]</span>\nansible/centos7-ansible            Ansible on Centos7                              <span class="token number">132</span>                  <span class="token punctuation">[</span>OK<span class="token punctuation">]</span>\nconsol/centos-xfce-vnc             Centos container with <span class="token string">"headless"</span> VNC session…   <span class="token number">126</span>                  <span class="token punctuation">[</span>OK<span class="token punctuation">]</span>\njdeathe/centos-ssh                 OpenSSH / Supervisor / EPEL/IUS/SCL Repos - …   <span class="token number">117</span>                  <span class="token punctuation">[</span>OK<span class="token punctuation">]</span>\ncentos/systemd                     systemd enabled base container.                 <span class="token number">96</span>                   <span class="token punctuation">[</span>OK<span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到返回了很多包含关键字的镜像，其中包括镜像名字、描述、收藏数（表示该镜像的受关注程度）、是否官方创建（OFFICIAL）、是否自动构建 （AUTOMATED）。</p>\n<p>根据是否是官方提供，可将镜像分为两类。</p>\n<ol>\n<li>\n<p>类似 centos 这样的镜像，被称为基础镜像或根镜像。这些基础镜像由 Docker 公司创建、验证、支持、提供。这样的镜像往往使用单个单词作为名字。</p>\n</li>\n<li>\n<p>比如 <code class="language-text">ansible/centos7-ansible</code> 镜像，它是由 Docker Hub 的注册用户创建并维护的，往往带有用户名称前缀。可以通过前缀 <code class="language-text">username/</code> 来指定使用某个用户提供的镜像，比如 ansible 用户。</p>\n</li>\n</ol>\n<p>另外，在查找的时候通过 <code class="language-text">--filter=stars=N</code> 参数可以指定仅显示收藏数量为 N 以上的镜像。</p>\n<p>下载官方 centos 镜像到本地。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39676407456624020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker pull centos\nUsing default tag: latest\nlatest: Pulling from library/centos\n7a0437f04f83: Pull complete\nDigest: sha256:5528e8b1b1719d34604c87e11dcd1c0a20bedf46e83b5632cdeac91b8c04efc1\nStatus: Downloaded newer image for centos:latest\ndocker.io/library/centos:latest`, `39676407456624020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker pull centos\nUsing default tag: latest\nlatest: Pulling from library/centos\n7a0437f04f83: Pull complete\nDigest: sha256:5528e8b1b1719d34604c87e11dcd1c0a20bedf46e83b5632cdeac91b8c04efc1\nStatus: Downloaded newer image <span class="token keyword">for</span> centos:latest\ndocker.io/library/centos:latest</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="推送镜像"><a href="#%E6%8E%A8%E9%80%81%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>推送镜像</h3>\n<p>用户也可以在登录后通过 docker push 命令来将自己的镜像推送到 Docker Hub。</p>\n<p>以下命令中的 username 请替换为你的 Docker 账号用户名。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63587391767260980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker tag ubuntu:18.04 username/ubuntu:18.04\n\n\\$ docker image ls\n\nREPOSITORY                                               TAG                    IMAGE ID            CREATED             SIZE\nubuntu                                                   18.04                  275d79972a86        6 days ago          94.6MB\nusername/ubuntu                                          18.04                  275d79972a86        6 days ago          94.6MB\n\n\\$ docker push username/ubuntu:18.04\n\n\\$ docker search username\n\nNAME                      DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED\nusername/ubuntu`, `63587391767260980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker tag ubuntu:18.04 username/ubuntu:18.04\n\n$ docker image <span class="token function">ls</span>\n\nREPOSITORY                                               TAG                    IMAGE ID            CREATED             SIZE\nubuntu                                                   <span class="token number">18.04</span>                  275d79972a86        <span class="token number">6</span> days ago          <span class="token number">94</span>.6MB\nusername/ubuntu                                          <span class="token number">18.04</span>                  275d79972a86        <span class="token number">6</span> days ago          <span class="token number">94</span>.6MB\n\n$ docker push username/ubuntu:18.04\n\n$ docker search username\n\nNAME                      DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED\nusername/ubuntu</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="自动构建"><a href="#%E8%87%AA%E5%8A%A8%E6%9E%84%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>自动构建</h3>\n<p>2021 年 7 月 26 日之后，该项功能仅限付费用户使用。</p>\n<p>自动构建（Automated Builds）可以自动触发构建镜像，方便升级镜像。</p>\n<p>有时候，用户构建了镜像，安装了某个软件，当软件发布新版本则需要手动更新镜像。</p>\n<p>而自动构建允许用户通过 Docker Hub 指定跟踪一个目标网站（支持 GitHub 或 BitBucket）上的项目，一旦项目发生新的提交（commit）或者创建了新的标签（tag），Docker Hub 会自动构建镜像并推送到 Docker Hub 中。</p>\n<p>要配置自动构建，包括如下的步骤：</p>\n<ul>\n<li>登录 Docker Hub；</li>\n<li>在 Docker Hub 点击右上角头像，在账号设置（Account Settings）中关联（Linked Accounts）目标网站；</li>\n<li>在 Docker Hub 中新建或选择已有的仓库，在 Builds 选项卡中选择 Configure Automated Builds；</li>\n<li>选取一个目标网站中的项目（需要含 Dockerfile）和分支；</li>\n<li>指定 Dockerfile 的位置，并保存。</li>\n</ul>\n<p>之后，可以在 Docker Hub 的仓库页面的 Timeline 选项卡中查看每次构建的状态。</p>\n<h1 id="数据管理"><a href="#%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数据管理</h1>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-17-02-27-55-57d5ef6874cbe3f16e841e537008e33d-1041c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 501px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 50.898203592814376%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAAB2klEQVQoz1VQS47TQBDNXVhyDE6AhNiwYsMZWI/QSGxmxRKEuABrFmgGxJBJMiGZfLBx4kz8d9xxt9ufdre7/aGSSKCRSlWlV/VU9V7vyet3j1+dP3p59vz8Iy14lGRxWuxwGpJ0R7JdkoUYGgpglOSI5pAh9jT3Me09e/PhxdtPT8/eX3y+6rqu7TqSsXvbs1x/Y7nm1rG90PZ3KStP00NuDzVlvIez4oh0ddsGKfczYfj78UIfjKfXg/HVj/5MM3TT0lzkUC7rOsrFMkyZbPJS9CKaAzMp5cghBspU01ZSBijGhK59ZEc4RNiLYqUUk7WFGTAv18giJeOiB8K4atyE3eNi5CR2Uv57DI7YCTcxX8elrA8IZlWYcpg37fFtcEI2rZOUpahQyggTQqqclVKqIBMFr0ouuKhgKoQghdiz6iTzQAZ7oVsEdPjH0o318NfdeLZcbbYmuFSomNCFYU7mv+faan1vX2oO4eo/GR01q7reOP50qQ8ns9vpfKabX6YmbIUoHs/1/mgC+J22Mjz0wO0TuW6a1db9fnP7rT+8vhl9HUx/ajbgYF4BzlQS3gYtcOMBOcAUelU34R5v3GDrhZa/s7yQJLRuWghYhNQeGbAGIVUDCM7YX52sId9byEsQAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 17 02 27 55" title="" data-src="/static/2022-07-17-02-27-55-57d5ef6874cbe3f16e841e537008e33d-1041c.png" data-srcset="/static/2022-07-17-02-27-55-57d5ef6874cbe3f16e841e537008e33d-d18f3.png 200w,\n/static/2022-07-17-02-27-55-57d5ef6874cbe3f16e841e537008e33d-764b5.png 400w,\n/static/2022-07-17-02-27-55-57d5ef6874cbe3f16e841e537008e33d-1041c.png 501w" data-sizes="(max-width: 501px) 100vw, 501px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这一章介绍如何在 Docker 内部以及容器之间管理数据，在容器中管理数据主要有两种方式：</p>\n<ul>\n<li>数据卷（Volumes）</li>\n<li>挂载主机目录 (Bind mounts)</li>\n</ul>\n<h2 id="数据卷"><a href="#%E6%95%B0%E6%8D%AE%E5%8D%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数据卷</h2>\n<p>数据卷是一个可供一个或多个容器使用的特殊目录，它绕过 UFS，可以提供很多有用的特性：</p>\n<ul>\n<li>数据卷可以在容器之间共享和重用</li>\n<li>对数据卷的修改会立马生效</li>\n<li>对数据卷的更新，不会影响镜像</li>\n<li>数据卷默认会一直存在，即使容器被删除</li>\n</ul>\n<blockquote>\n<p>注意：数据卷的使用，类似于 Linux 下对目录或文件进行 mount，镜像中的被指定为挂载点的目录中的文件会复制到数据卷中（仅数据卷为空时会复制）。</p>\n</blockquote>\n<h3 id="创建一个数据卷"><a href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%8D%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建一个数据卷</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1182011168695251700"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker volume create my-vol`, `1182011168695251700`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker volume create my-vol</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>查看所有的数据卷</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88931173377900090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker volume ls\n\nDRIVER              VOLUME NAME\nlocal               my-vol`, `88931173377900090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker volume <span class="token function">ls</span>\n\nDRIVER              VOLUME NAME\n<span class="token builtin class-name">local</span>               my-vol</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在主机里使用以下命令可以查看指定数据卷的信息</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25708495277719413000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker volume inspect my-vol\n[\n    {\n        &quot;Driver&quot;: &quot;local&quot;,\n        &quot;Labels&quot;: {},\n        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/my-vol/_data&quot;,\n        &quot;Name&quot;: &quot;my-vol&quot;,\n        &quot;Options&quot;: {},\n        &quot;Scope&quot;: &quot;local&quot;\n    }\n]`, `25708495277719413000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker volume inspect my-vol\n<span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n        <span class="token string">"Driver"</span><span class="token builtin class-name">:</span> <span class="token string">"local"</span>,\n        <span class="token string">"Labels"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>,\n        <span class="token string">"Mountpoint"</span><span class="token builtin class-name">:</span> <span class="token string">"/var/lib/docker/volumes/my-vol/_data"</span>,\n        <span class="token string">"Name"</span><span class="token builtin class-name">:</span> <span class="token string">"my-vol"</span>,\n        <span class="token string">"Options"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>,\n        <span class="token string">"Scope"</span><span class="token builtin class-name">:</span> <span class="token string">"local"</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="启动一个挂载数据卷的容器"><a href="#%E5%90%AF%E5%8A%A8%E4%B8%80%E4%B8%AA%E6%8C%82%E8%BD%BD%E6%95%B0%E6%8D%AE%E5%8D%B7%E7%9A%84%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>启动一个挂载数据卷的容器</h3>\n<p>在用 docker run 命令的时候，使用 <code class="language-text">--mount</code> 标记来将数据卷挂载到容器里。在一次 docker run 中可以挂载多个数据卷。</p>\n<p>下面创建一个名为 web 的容器，并加载一个数据卷到容器的 <code class="language-text">/usr/share/nginx/html</code> 目录。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42518549719115390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -P \\\n    --name web \\\n    # -v my-vol:/usr/share/nginx/html \\\n    --mount source=my-vol,target=/usr/share/nginx/html \\\n    nginx:alpine`, `42518549719115390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d -P <span class="token punctuation">\\</span>\n    --name web <span class="token punctuation">\\</span>\n    <span class="token comment"># -v my-vol:/usr/share/nginx/html \\</span>\n    --mount <span class="token assign-left variable">source</span><span class="token operator">=</span>my-vol,target<span class="token operator">=</span>/usr/share/nginx/html <span class="token punctuation">\\</span>\n    nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="查看数据卷的具体信息"><a href="#%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE%E5%8D%B7%E7%9A%84%E5%85%B7%E4%BD%93%E4%BF%A1%E6%81%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看数据卷的具体信息</h3>\n<p>在主机里使用以下命令可以查看 web 容器的信息</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34233795831094784000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker inspect web`, `34233795831094784000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker inspect web</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>数据卷信息在 <code class="language-text">&quot;Mounts&quot; Key</code> 下面</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81317500609621620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;Mounts&quot;: [\n    {\n        &quot;Type&quot;: &quot;volume&quot;,\n        &quot;Name&quot;: &quot;my-vol&quot;,\n        &quot;Source&quot;: &quot;/var/lib/docker/volumes/my-vol/_data&quot;,\n        &quot;Destination&quot;: &quot;/usr/share/nginx/html&quot;,\n        &quot;Driver&quot;: &quot;local&quot;,\n        &quot;Mode&quot;: &quot;&quot;,\n        &quot;RW&quot;: true,\n        &quot;Propagation&quot;: &quot;&quot;\n    }\n],`, `81317500609621620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token property">"Mounts"</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n        <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"volume"</span><span class="token punctuation">,</span>\n        <span class="token property">"Name"</span><span class="token operator">:</span> <span class="token string">"my-vol"</span><span class="token punctuation">,</span>\n        <span class="token property">"Source"</span><span class="token operator">:</span> <span class="token string">"/var/lib/docker/volumes/my-vol/_data"</span><span class="token punctuation">,</span>\n        <span class="token property">"Destination"</span><span class="token operator">:</span> <span class="token string">"/usr/share/nginx/html"</span><span class="token punctuation">,</span>\n        <span class="token property">"Driver"</span><span class="token operator">:</span> <span class="token string">"local"</span><span class="token punctuation">,</span>\n        <span class="token property">"Mode"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>\n        <span class="token property">"RW"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n        <span class="token property">"Propagation"</span><span class="token operator">:</span> <span class="token string">""</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="删除数据卷"><a href="#%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE%E5%8D%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>删除数据卷</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84141607641020190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker volume rm my-vol`, `84141607641020190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker volume <span class="token function">rm</span> my-vol</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>数据卷是被设计用来持久化数据的，它的生命周期独立于容器，Docker 不会在容器被删除后自动删除数据卷，并且也不存在垃圾回收这样的机制来处理没有任何容器引用的数据卷。如果需要在删除容器的同时移除数据卷。可以在删除容器的时候使用 <code class="language-text">docker rm -v</code> 这个命令。</p>\n<p>无主的数据卷可能会占据很多空间，要清理请使用以下命令</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46677561790296965000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker volume prune`, `46677561790296965000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker volume prune</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="挂载主机目录"><a href="#%E6%8C%82%E8%BD%BD%E4%B8%BB%E6%9C%BA%E7%9B%AE%E5%BD%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>挂载主机目录</h2>\n<h3 id="挂载一个主机目录作为数据卷"><a href="#%E6%8C%82%E8%BD%BD%E4%B8%80%E4%B8%AA%E4%B8%BB%E6%9C%BA%E7%9B%AE%E5%BD%95%E4%BD%9C%E4%B8%BA%E6%95%B0%E6%8D%AE%E5%8D%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>挂载一个主机目录作为数据卷</h3>\n<p>使用 <code class="language-text">--mount</code> 标记可以指定挂载一个本地主机的目录到容器中去。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66405916434612020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -P \\\n    --name web \\\n    # -v /src/webapp:/usr/share/nginx/html \\\n    --mount type=bind,source=/src/webapp,target=/usr/share/nginx/html \\\n    nginx:alpine`, `66405916434612020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d -P <span class="token punctuation">\\</span>\n    --name web <span class="token punctuation">\\</span>\n    <span class="token comment"># -v /src/webapp:/usr/share/nginx/html \\</span>\n    --mount <span class="token assign-left variable">type</span><span class="token operator">=</span>bind,source<span class="token operator">=</span>/src/webapp,target<span class="token operator">=</span>/usr/share/nginx/html <span class="token punctuation">\\</span>\n    nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的命令加载主机的 <code class="language-text">/src/webapp</code> 目录到容器的 <code class="language-text">/usr/share/nginx/html</code> 目录。这个功能在进行测试的时候十分方便，比如用户可以放置一些程序到本地目录中，来查看容器是否正常工作。本地目录的路径必须是绝对路径，以前使用 <code class="language-text">-v</code> 参数时如果本地目录不存在 Docker 会自动为你创建一个文件夹，现在使用 <code class="language-text">--mount</code> 参数时如果本地目录不存在，Docker 会报错。</p>\n<p>Docker 挂载主机目录的默认权限是读写，用户也可以通过增加 readonly 指定为只读。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50202717533043974000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -P \\\n    --name web \\\n    # -v /src/webapp:/usr/share/nginx/html:ro \\\n    --mount type=bind,source=/src/webapp,target=/usr/share/nginx/html,readonly \\\n    nginx:alpine`, `50202717533043974000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d -P <span class="token punctuation">\\</span>\n    --name web <span class="token punctuation">\\</span>\n    <span class="token comment"># -v /src/webapp:/usr/share/nginx/html:ro \\</span>\n    --mount <span class="token assign-left variable">type</span><span class="token operator">=</span>bind,source<span class="token operator">=</span>/src/webapp,target<span class="token operator">=</span>/usr/share/nginx/html,readonly <span class="token punctuation">\\</span>\n    nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>加了 readonly 之后，就挂载为只读了。如果你在容器内 <code class="language-text">/usr/share/nginx/html</code> 目录新建文件，会显示如下错误</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87860941336759660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/usr/share/nginx/html # touch new.txt\ntouch: new.txt: Read-only file system`, `87860941336759660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">/usr/share/nginx/html <span class="token comment"># touch new.txt</span>\ntouch: new.txt: Read-only <span class="token function">file</span> system</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="查看数据卷的具体信息-1"><a href="#%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE%E5%8D%B7%E7%9A%84%E5%85%B7%E4%BD%93%E4%BF%A1%E6%81%AF-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看数据卷的具体信息</h3>\n<p>在主机里使用以下命令可以查看 web 容器的信息</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81223494574784540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker inspect web`, `81223494574784540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker inspect web</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>挂载主机目录的配置信息在 <code class="language-text">&quot;Mounts&quot; Key</code> 下面</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33763795966706910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;Mounts&quot;: [\n    {\n        &quot;Type&quot;: &quot;bind&quot;,\n        &quot;Source&quot;: &quot;/src/webapp&quot;,\n        &quot;Destination&quot;: &quot;/usr/share/nginx/html&quot;,\n        &quot;Mode&quot;: &quot;&quot;,\n        &quot;RW&quot;: true,\n        &quot;Propagation&quot;: &quot;rprivate&quot;\n    }\n],`, `33763795966706910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token property">"Mounts"</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n        <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"bind"</span><span class="token punctuation">,</span>\n        <span class="token property">"Source"</span><span class="token operator">:</span> <span class="token string">"/src/webapp"</span><span class="token punctuation">,</span>\n        <span class="token property">"Destination"</span><span class="token operator">:</span> <span class="token string">"/usr/share/nginx/html"</span><span class="token punctuation">,</span>\n        <span class="token property">"Mode"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>\n        <span class="token property">"RW"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n        <span class="token property">"Propagation"</span><span class="token operator">:</span> <span class="token string">"rprivate"</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="挂载一个本地主机文件作为数据卷"><a href="#%E6%8C%82%E8%BD%BD%E4%B8%80%E4%B8%AA%E6%9C%AC%E5%9C%B0%E4%B8%BB%E6%9C%BA%E6%96%87%E4%BB%B6%E4%BD%9C%E4%B8%BA%E6%95%B0%E6%8D%AE%E5%8D%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>挂载一个本地主机文件作为数据卷</h3>\n<p><code class="language-text">--mount</code> 标记也可以从主机挂载单个文件到容器中</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94126300949039350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run --rm -it \\\n   # -v \\$HOME/.bash_history:/root/.bash_history \\\n   --mount type=bind,source=\\$HOME/.bash_history,target=/root/.bash_history \\\n   ubuntu:18.04 \\\n   bash\n\nroot@2affd44b4667:/# history\n1  ls\n2  diskutil list`, `94126300949039350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run --rm -it <span class="token punctuation">\\</span>\n   <span class="token comment"># -v $HOME/.bash_history:/root/.bash_history \\</span>\n   --mount <span class="token assign-left variable">type</span><span class="token operator">=</span>bind,source<span class="token operator">=</span><span class="token environment constant">$HOME</span>/.bash_history,target<span class="token operator">=</span>/root/.bash_history <span class="token punctuation">\\</span>\n   ubuntu:18.04 <span class="token punctuation">\\</span>\n   <span class="token function">bash</span>\n\nroot@2affd44b4667:/<span class="token comment"># history</span>\n<span class="token number">1</span>  <span class="token function">ls</span>\n<span class="token number">2</span>  diskutil list</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样就可以记录在容器输入过的命令了。</p>\n<h1 id="网络"><a href="#%E7%BD%91%E7%BB%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>网络</h1>\n<p>Docker 允许通过外部访问容器或容器互联的方式来提供网络服务。</p>\n<h2 id="外部访问容器"><a href="#%E5%A4%96%E9%83%A8%E8%AE%BF%E9%97%AE%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>外部访问容器</h2>\n<p>容器中可以运行一些网络应用，要让外部也可以访问这些应用，可以通过 <code class="language-text">-P</code> 或 <code class="language-text">-p</code> 参数来指定端口映射。</p>\n<p>当使用 <code class="language-text">-P</code> 标记时，Docker 会随机映射一个端口到内部容器开放的网络端口。</p>\n<p>使用 <code class="language-text">docker container ls</code> 可以看到，本地主机的 32768 被映射到了容器的 80 端口。此时访问本机的 32768 端口即可访问容器内 NGINX 默认页面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46932922305196966000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -P nginx:alpine\n\n\\$ docker container ls -l\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                   NAMES\nfae320d08268        nginx:alpine        &quot;/docker-entrypoint.…&quot;   24 seconds ago      Up 20 seconds       0.0.0.0:32768->80/tcp   bold_mcnulty`, `46932922305196966000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d -P nginx:alpine\n\n$ docker container <span class="token function">ls</span> -l\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                   NAMES\nfae320d08268        nginx:alpine        <span class="token string">"/docker-entrypoint.…"</span>   <span class="token number">24</span> seconds ago      Up <span class="token number">20</span> seconds       <span class="token number">0.0</span>.0.0:32768-<span class="token operator">></span><span class="token number">80</span>/tcp   bold_mcnulty</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同样的，可以通过 docker logs 命令来查看访问记录。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30051062098166350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker logs fa\n172.17.0.1 - - [25/Aug/2020:08:34:04 +0000] &quot;GET / HTTP/1.1&quot; 200 612 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:80.0) Gecko/20100101 Firefox/80.0&quot; &quot;-&quot;`, `30051062098166350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker logs fa\n<span class="token number">172.17</span>.0.1 - - <span class="token punctuation">[</span><span class="token number">25</span>/Aug/2020:08:34:04 +0000<span class="token punctuation">]</span> <span class="token string">"GET / HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">612</span> <span class="token string">"-"</span> <span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:80.0) Gecko/20100101 Firefox/80.0"</span> <span class="token string">"-"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p><code class="language-text">-p</code> 则可以指定要映射的端口，并且，在一个指定端口上只可以绑定一个容器。支持的格式有 <code class="language-text">ip:hostPort:containerPort | ip::containerPort | hostPort:containerPort</code>。</p>\n<h3 id="映射所有接口地址"><a href="#%E6%98%A0%E5%B0%84%E6%89%80%E6%9C%89%E6%8E%A5%E5%8F%A3%E5%9C%B0%E5%9D%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>映射所有接口地址</h3>\n<p>使用 <code class="language-text">hostPort:containerPort</code> 格式本地的 80 端口映射到容器的 80 端口，可以执行</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71969671888073240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -p 80:80 nginx:alpine`, `71969671888073240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d -p <span class="token number">80</span>:80 nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>此时默认会绑定本地所有接口上的所有地址。</p>\n<h3 id="映射到指定地址的指定端口"><a href="#%E6%98%A0%E5%B0%84%E5%88%B0%E6%8C%87%E5%AE%9A%E5%9C%B0%E5%9D%80%E7%9A%84%E6%8C%87%E5%AE%9A%E7%AB%AF%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>映射到指定地址的指定端口</h3>\n<p>可以使用 <code class="language-text">ip:hostPort:containerPort</code> 格式指定映射使用一个特定地址，比如 localhost 地址 127.0.0.1</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84610584528610340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -p 127.0.0.1:80:80 nginx:alpine`, `84610584528610340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d -p <span class="token number">127.0</span>.0.1:80:80 nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="映射到指定地址的任意端口"><a href="#%E6%98%A0%E5%B0%84%E5%88%B0%E6%8C%87%E5%AE%9A%E5%9C%B0%E5%9D%80%E7%9A%84%E4%BB%BB%E6%84%8F%E7%AB%AF%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>映射到指定地址的任意端口</h3>\n<p>使用 <code class="language-text">ip::containerPort</code> 绑定 localhost 的任意端口到容器的 80 端口，本地主机会自动分配一个端口。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76876432114999310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -p 127.0.0.1::80 nginx:alpine`, `76876432114999310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d -p <span class="token number">127.0</span>.0.1::80 nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>还可以使用 udp 标记来指定 udp 端口</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68798288848198296000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d -p 127.0.0.1:80:80/udp nginx:alpine`, `68798288848198296000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d -p <span class="token number">127.0</span>.0.1:80:80/udp nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="查看映射端口配置"><a href="#%E6%9F%A5%E7%9C%8B%E6%98%A0%E5%B0%84%E7%AB%AF%E5%8F%A3%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看映射端口配置</h3>\n<p>使用 docker port 来查看当前映射的端口配置，也可以查看到绑定的地址</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78429065603243210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker port fa 80\n0.0.0.0:32768`, `78429065603243210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker port fa <span class="token number">80</span>\n<span class="token number">0.0</span>.0.0:32768</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>注意：</p>\n<ul>\n<li>容器有自己的内部网络和 ip 地址（使用 docker inspect 查看，Docker 还可以有一个可变的网络配置。）</li>\n<li><code class="language-text">-p</code> 标记可以多次使用来绑定多个端口</li>\n</ul>\n<p>例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46692462313580175000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -d \\\n    -p 80:80 \\\n    -p 443:443 \\\n    nginx:alpine`, `46692462313580175000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -d <span class="token punctuation">\\</span>\n    -p <span class="token number">80</span>:80 <span class="token punctuation">\\</span>\n    -p <span class="token number">443</span>:443 <span class="token punctuation">\\</span>\n    nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="容器互联"><a href="#%E5%AE%B9%E5%99%A8%E4%BA%92%E8%81%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器互联</h2>\n<p>如果你之前有 Docker 使用经验，你可能已经习惯了使用 <code class="language-text">--link</code> 参数来使容器互联。</p>\n<p>随着 Docker 网络的完善，强烈建议大家将容器加入自定义的 Docker 网络来连接多个容器，而不是使用 <code class="language-text">--link</code> 参数。</p>\n<h3 id="新建网络"><a href="#%E6%96%B0%E5%BB%BA%E7%BD%91%E7%BB%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>新建网络</h3>\n<p>下面先创建一个新的 Docker 网络。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69998145096552360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker network create -d bridge my-net`, `69998145096552360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker network create -d bridge my-net</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p><code class="language-text">-d</code> 参数指定 Docker 网络类型，有 bridge、overlay。其中 overlay 网络类型用于 Swarm mode，在本小节中你可以忽略它。</p>\n<h3 id="连接容器"><a href="#%E8%BF%9E%E6%8E%A5%E5%AE%B9%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>连接容器</h3>\n<p>运行一个容器并连接到新建的 my-net 网络</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85286168584154870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -it --rm --name busybox1 --network my-net busybox sh`, `85286168584154870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -it --rm --name busybox1 --network my-net busybox <span class="token function">sh</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>打开新的终端，再运行一个容器并加入到 my-net 网络</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49430649917508230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -it --rm --name busybox2 --network my-net busybox sh`, `49430649917508230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -it --rm --name busybox2 --network my-net busybox <span class="token function">sh</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>再打开一个新的终端查看容器信息</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56273723482334350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker container ls\n\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\nb47060aca56b        busybox             &quot;sh&quot;                11 minutes ago      Up 11 minutes                           busybox2\n8720575823ec        busybox             &quot;sh&quot;                16 minutes ago      Up 16 minutes                           busybox1`, `56273723482334350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker container <span class="token function">ls</span>\n\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\nb47060aca56b        busybox             <span class="token string">"sh"</span>                <span class="token number">11</span> minutes ago      Up <span class="token number">11</span> minutes                           busybox2\n8720575823ec        busybox             <span class="token string">"sh"</span>                <span class="token number">16</span> minutes ago      Up <span class="token number">16</span> minutes                           busybox1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面通过 ping 来证明 busybox1 容器和 busybox2 容器建立了互联关系。</p>\n<p>在 busybox1 容器输入以下命令</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85899458179908040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/ # ping busybox2\nPING busybox2 (172.19.0.3): 56 data bytes\n64 bytes from 172.19.0.3: seq=0 ttl=64 time=0.072 ms\n64 bytes from 172.19.0.3: seq=1 ttl=64 time=0.118 ms`, `85899458179908040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">/ <span class="token comment"># ping busybox2</span>\nPING busybox2 <span class="token punctuation">(</span><span class="token number">172.19</span>.0.3<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes\n<span class="token number">64</span> bytes from <span class="token number">172.19</span>.0.3: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.072</span> ms\n<span class="token number">64</span> bytes from <span class="token number">172.19</span>.0.3: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.118</span> ms</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>用 ping 来测试连接 busybox2 容器，它会解析成 172.19.0.3。</p>\n<p>同理在 busybox2 容器执行 ping busybox1，也会成功连接到。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58021697783054746000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/ # ping busybox1\nPING busybox1 (172.19.0.2): 56 data bytes\n64 bytes from 172.19.0.2: seq=0 ttl=64 time=0.064 ms\n64 bytes from 172.19.0.2: seq=1 ttl=64 time=0.143 ms`, `58021697783054746000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">/ <span class="token comment"># ping busybox1</span>\nPING busybox1 <span class="token punctuation">(</span><span class="token number">172.19</span>.0.2<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes\n<span class="token number">64</span> bytes from <span class="token number">172.19</span>.0.2: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.064</span> ms\n<span class="token number">64</span> bytes from <span class="token number">172.19</span>.0.2: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.143</span> ms</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样，busybox1 容器和 busybox2 容器建立了互联关系。</p>\n<h3 id="docker-compose"><a href="#docker-compose" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker Compose</h3>\n<p>如果你有多个容器之间需要互相连接，推荐使用 Docker Compose。</p>\n<h2 id="配置-dns"><a href="#%E9%85%8D%E7%BD%AE-dns" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配置 DNS</h2>\n<p>如何自定义配置容器的主机名和 DNS 呢？秘诀就是 Docker 利用虚拟文件来挂载容器的 3 个相关配置文件。</p>\n<p>在容器中使用 mount 命令可以看到挂载信息：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27720622241959326000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ mount\n/dev/disk/by-uuid/1fec...ebdf on /etc/hostname type ext4 ...\n/dev/disk/by-uuid/1fec...ebdf on /etc/hosts type ext4 ...\ntmpfs on /etc/resolv.conf type tmpfs ...`, `27720622241959326000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">mount</span>\n/dev/disk/by-uuid/1fec<span class="token punctuation">..</span>.ebdf on /etc/hostname <span class="token builtin class-name">type</span> ext4 <span class="token punctuation">..</span>.\n/dev/disk/by-uuid/1fec<span class="token punctuation">..</span>.ebdf on /etc/hosts <span class="token builtin class-name">type</span> ext4 <span class="token punctuation">..</span>.\ntmpfs on /etc/resolv.conf <span class="token builtin class-name">type</span> tmpfs <span class="token punctuation">..</span>.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种机制可以让宿主主机 DNS 信息发生更新后，所有 Docker 容器的 DNS 配置通过 <code class="language-text">/etc/resolv.conf</code> 文件立刻得到更新。</p>\n<p>配置全部容器的 DNS，也可以在 <code class="language-text">/etc/docker/daemon.json</code> 文件中增加以下内容来设置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71328413727727290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;dns&quot;: [&quot;114.114.114.114&quot;, &quot;8.8.8.8&quot;]\n}`, `71328413727727290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"dns"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"114.114.114.114"</span><span class="token punctuation">,</span> <span class="token string">"8.8.8.8"</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这样每次启动的容器 DNS 自动配置为 <code class="language-text">114.114.114.114</code> 和 <code class="language-text">8.8.8.8</code>。使用以下命令来证明其已经生效。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37159928192099880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -it --rm ubuntu:18.04 cat etc/resolv.conf\n\nnameserver 114.114.114.114\nnameserver 8.8.8.8`, `37159928192099880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -it --rm ubuntu:18.04 <span class="token function">cat</span> etc/resolv.conf\n\nnameserver <span class="token number">114.114</span>.114.114\nnameserver <span class="token number">8.8</span>.8.8</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果用户想要手动指定容器的配置，可以在使用 docker run 命令启动容器时加入如下参数：</p>\n<p><code class="language-text">-h HOSTNAME</code> 或者 <code class="language-text">--hostname=HOSTNAME</code> 设定容器的主机名，它会被写到容器内的 <code class="language-text">/etc/hostname</code> 和 <code class="language-text">/etc/hosts</code>。但它在容器外部看不到，既不会在 <code class="language-text">docker container ls</code> 中显示，也不会在其他的容器的 <code class="language-text">/etc/hosts</code> 看到。</p>\n<p><code class="language-text">--dns=IP_ADDRESS</code> 添加 DNS 服务器到容器的 <code class="language-text">/etc/resolv.conf</code> 中，让容器用这个服务器来解析所有不在 <code class="language-text">/etc/hosts</code> 中的主机名。</p>\n<p><code class="language-text">--dns-search=DOMAIN</code> 设定容器的搜索域，当设定搜索域为 <code class="language-text">.example.com</code> 时，在搜索一个名为 host 的主机时，DNS 不仅搜索 host，还会搜索 <code class="language-text">host.example.com</code>。</p>\n<p>注意：如果在容器启动时没有指定最后两个参数，Docker 会默认用主机上的 <code class="language-text">/etc/resolv.conf</code> 来配置容器。</p>\n<h1 id="高级网络配置"><a href="#%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>高级网络配置</h1>\n<p>本章将介绍 Docker 的一些高级网络配置和选项。</p>\n<p>当 Docker 启动时，会自动在主机上创建一个 docker0 虚拟网桥，实际上是 Linux 的一个 bridge，可以理解为一个软件交换机。它会在挂载到它的网口之间进行转发。</p>\n<p>同时，Docker 随机分配一个本地未占用的私有网段（在 RFC1918 中定义）中的一个地址给 docker0 接口。比如典型的 <code class="language-text">172.17.42.1</code>，掩码为 <code class="language-text">255.255.0.0</code>。此后启动的容器内的网口也会自动分配一个同一网段（172.17.0.0/16）的地址。</p>\n<p>当创建一个 Docker 容器的时候，同时会创建了一对 <code class="language-text">veth pair</code> 接口（当数据包发送到一个接口时，另外一个接口也可以收到相同的数据包）。这对接口一端在容器内，即 eth0；另一端在本地并被挂载到 docker0 网桥，名称以 veth 开头（例如 vethAQI2QT）。通过这种方式，主机可以跟容器通信，容器之间也可以相互通信。Docker 就创建了在主机和所有容器之间一个虚拟共享网络。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-18-14-38-31-039827573c2ffaaa9def9207d177cbdf-b7caf.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 63.76172090457805%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACxklEQVQ4y11Sa1PTUBDlx+snxy86OoI6fhGcAXVGsOJjpG1oK4oUW9IHYh+U5nGT2zx7k6aUPW4AHfTDmd27OXvuubtZSlTQVfFERv19e9rfE9Penoj638Q0dEWiQmE6x2JkN8RY6OLUagjPN0WWRmJk2qJ5Ygi9Z4gGx7ElRKoCa4mb/PNZiKT2FHPtAea7D5F9eQL+hnmW4OdYw0HvFQ4HmxxfQ0x6AGU4ODaw+rmP9fIQazsDNE5M5DpLSoVupjw4OysX3Ve3qbVxiybFZYo9g9IkpvagRAVtmd6Wlql48Jxs2aOLuaLvnRE9elmllfVPtPx6j9glZYm/yB3KVE2gSisk9TsQ7btIyo8QyDMkSQR9UGI8wXB0D3vddRjiJ+hc4cuRgY3idwxO72Oj1KD91hjz9FIwkGkSIOrXaWLUIM4qiAd1xIEDNQ1gOb8wtvZhWVWc2S14ngmeIU4NG8eDIdc1dPqnNLYcpIoF1dSX2SxGtphRFAWQroP5IsMsDZEyFvMEcejDdQTnKWazCLmB8yzCxTyGsG3OQzrnnLWuHKppCM8dk5TP4LqPMXGGcJjo2CYkC/n+JoLwIcKgDcFOXGFwlAgCDYZ5B1LWaOJ6SJS3WJrNQulYAlrhB3UOP6Db2EZl+xClrSbKb5uXcffjFqqlVZQKFZS3dK7/QHFTR71awUlrC1+LFdrXuvyigAXTULq2QLnQoOJmGzm0QhPau2twXtlZQ6V8j4V3+bIOKu+PsLudX6Yzv4udN0dUr7WvBPMnM/h5FrnCRA7Or2HCky6i8DPi+AXM8SHaegetZgOj4YDHYV/zTfIkL/HmUtgp5Yv4FxG8iQ3fcxH4/K/y7KJQ8vDzeQU3uZe9f5eSN/KBGLiJvEk/4nkWP6F+8BW1apmXccYCMf7jUs69FGSbV4LqqngTOTlNwr/ief6n/qf2v+BvUvGtQZ/Bj1sAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 18 14 38 31" title="" data-src="/static/2022-07-18-14-38-31-039827573c2ffaaa9def9207d177cbdf-fee1c.png" data-srcset="/static/2022-07-18-14-38-31-039827573c2ffaaa9def9207d177cbdf-a67b7.png 200w,\n/static/2022-07-18-14-38-31-039827573c2ffaaa9def9207d177cbdf-0b187.png 400w,\n/static/2022-07-18-14-38-31-039827573c2ffaaa9def9207d177cbdf-fee1c.png 800w,\n/static/2022-07-18-14-38-31-039827573c2ffaaa9def9207d177cbdf-b1a91.png 1200w,\n/static/2022-07-18-14-38-31-039827573c2ffaaa9def9207d177cbdf-95179.png 1600w,\n/static/2022-07-18-14-38-31-039827573c2ffaaa9def9207d177cbdf-b7caf.png 1813w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>接下来的部分将介绍在一些场景中，Docker 所有的网络定制配置。以及通过 Linux 命令来调整、补充、甚至替换 Docker 默认的网络配置。</p>\n<h2 id="快速配置指南"><a href="#%E5%BF%AB%E9%80%9F%E9%85%8D%E7%BD%AE%E6%8C%87%E5%8D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>快速配置指南</h2>\n<p>下面是一个跟 Docker 网络相关的命令列表。</p>\n<p>其中有些命令选项只有在 Docker 服务启动的时候才能配置，而且不能马上生效。</p>\n<ul>\n<li><code class="language-text">-b BRIDGE</code> 或 <code class="language-text">--bridge=BRIDGE</code> 指定容器挂载的网桥</li>\n<li><code class="language-text">--bip=CIDR</code> 定制 docker0 的掩码</li>\n<li><code class="language-text">-H SOCKET...</code> 或 <code class="language-text">--host=SOCKET... Docker</code> 服务端接收命令的通道</li>\n<li><code class="language-text">--icc=true|false</code> 是否支持容器之间进行通信</li>\n<li><code class="language-text">--ip-forward=true|false</code> 请看下文容器之间的通信</li>\n<li><code class="language-text">--iptables=true|false</code> 是否允许 Docker 添加 iptables 规则</li>\n<li><code class="language-text">--mtu=BYTES</code> 容器网络中的 MTU</li>\n</ul>\n<p>下面 2 个命令选项既可以在启动服务时指定，也可以在启动容器时指定。在 Docker 服务启动的时候指定则会成为默认值，后面执行 docker run 时可以覆盖设置的默认值。</p>\n<ul>\n<li><code class="language-text">--dns=IP_ADDRESS...</code> 使用指定的 DNS 服务器</li>\n<li><code class="language-text">--dns-search=DOMAIN...</code> 指定 DNS 搜索域</li>\n</ul>\n<p>最后这些选项只有在 docker run 执行时使用，因为它是针对容器的特性内容。</p>\n<ul>\n<li><code class="language-text">-h HOSTNAME</code> 或 <code class="language-text">--hostname=HOSTNAME</code> 配置容器主机名</li>\n<li><code class="language-text">--link=CONTAINER_NAME:ALIAS</code> 添加到另一个容器的连接</li>\n<li><code class="language-text">--net=bridge|none|container:NAME_or_ID|host</code> 配置容器的桥接模式</li>\n<li><code class="language-text">-p SPEC</code> 或 <code class="language-text">--publish=SPEC</code> 映射容器端口到宿主主机</li>\n<li><code class="language-text">-P</code> 或 <code class="language-text">--publish-all=true|false</code> 映射容器所有端口到宿主主机</li>\n</ul>\n<h2 id="容器访问控制"><a href="#%E5%AE%B9%E5%99%A8%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器访问控制</h2>\n<p>容器的访问控制，主要通过 Linux 上的 iptables 防火墙来进行管理和实现。iptables 是 Linux 上默认的防火墙软件，在大部分发行版中都自带。</p>\n<h3 id="容器访问外部网络"><a href="#%E5%AE%B9%E5%99%A8%E8%AE%BF%E9%97%AE%E5%A4%96%E9%83%A8%E7%BD%91%E7%BB%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器访问外部网络</h3>\n<p>容器要想访问外部网络，需要本地系统的转发支持。在 Linux 系统中，检查转发是否打开。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5332998861355187000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$sysctl net.ipv4.ip_forward\nnet.ipv4.ip_forward = 1`, `5332998861355187000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token variable">$sysctl</span> net.ipv4.ip_forward\nnet.ipv4.ip_forward <span class="token operator">=</span> <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果为 0，说明没有开启转发，则需要手动打开。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27622130855497028000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$sysctl -w net.ipv4.ip_forward=1`, `27622130855497028000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token variable">$sysctl</span> -w net.ipv4.ip_forward<span class="token operator">=</span><span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果在启动 Docker 服务的时候设定 <code class="language-text">--ip-forward=true</code>, Docker 就会自动设定系统的 <code class="language-text">ip_forward</code> 参数为 1。</p>\n<h3 id="容器之间访问"><a href="#%E5%AE%B9%E5%99%A8%E4%B9%8B%E9%97%B4%E8%AE%BF%E9%97%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器之间访问</h3>\n<p>容器之间相互访问，需要两方面的支持。</p>\n<ol>\n<li>容器的网络拓扑是否已经互联。默认情况下，所有容器都会被连接到 docker0 网桥上。</li>\n<li>本地系统的防火墙软件 <code class="language-text">iptables</code> 是否允许通过。</li>\n</ol>\n<h4 id="访问所有端口"><a href="#%E8%AE%BF%E9%97%AE%E6%89%80%E6%9C%89%E7%AB%AF%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>访问所有端口</h4>\n<p>当启动 Docker 服务（即 dockerd）的时候，默认会添加一条转发策略到本地主机 iptables 的 FORWARD 链上。策略为通过（ACCEPT）还是禁止（DROP）取决于配置<code class="language-text">--icc=true</code>（缺省值）还是 <code class="language-text">--icc=false</code>。当然，如果手动指定 <code class="language-text">--iptables=false</code> 则不会添加 iptables 规则。</p>\n<p>可见，默认情况下，不同容器之间是允许网络互通的。如果为了安全考虑，可以在 <code class="language-text">/etc/docker/daemon.json</code> 文件中配置 <code class="language-text">{&quot;icc&quot;: false}</code> 来禁止它。</p>\n<h4 id="访问指定端口"><a href="#%E8%AE%BF%E9%97%AE%E6%8C%87%E5%AE%9A%E7%AB%AF%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>访问指定端口</h4>\n<p>在通过 <code class="language-text">--icc=false</code> 关闭网络访问后，还可以通过 <code class="language-text">--link=CONTAINER_NAME:ALIAS</code> 选项来访问容器的开放端口。</p>\n<p>例如，在启动 Docker 服务时，可以同时使用 <code class="language-text">--icc=false --iptables=true</code> 参数来关闭允许相互的网络访问，并让 Docker 可以修改系统中的 iptables 规则。</p>\n<p>此时，系统中的 iptables 规则可能是类似</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95389410744522980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo iptables -nL\n...\nChain FORWARD (policy ACCEPT)\ntarget     prot opt source               destination\nDROP       all  --  0.0.0.0/0            0.0.0.0/0\n...`, `95389410744522980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> iptables -nL\n<span class="token punctuation">..</span>.\nChain FORWARD <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>\ntarget     prot opt <span class="token builtin class-name">source</span>               destination\nDROP       all  --  <span class="token number">0.0</span>.0.0/0            <span class="token number">0.0</span>.0.0/0\n<span class="token punctuation">..</span>.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>之后，启动容器（docker run）时使用 <code class="language-text">--link=CONTAINER_NAME:ALIAS</code> 选项。Docker 会在 iptable 中为两个容器分别添加一条 ACCEPT 规则，允许相互访问开放的端口（取决于 Dockerfile 中的 EXPOSE 指令）。</p>\n<p>当添加了 <code class="language-text">--link=CONTAINER_NAME:ALIAS</code> 选项后，添加了 iptables 规则。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55771412025246470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo iptables -nL\n...\nChain FORWARD (policy ACCEPT)\ntarget     prot opt source               destination\nACCEPT     tcp  --  172.17.0.2           172.17.0.3           tcp spt:80\nACCEPT     tcp  --  172.17.0.3           172.17.0.2           tcp dpt:80\nDROP       all  --  0.0.0.0/0            0.0.0.0/0`, `55771412025246470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> iptables -nL\n<span class="token punctuation">..</span>.\nChain FORWARD <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>\ntarget     prot opt <span class="token builtin class-name">source</span>               destination\nACCEPT     tcp  --  <span class="token number">172.17</span>.0.2           <span class="token number">172.17</span>.0.3           tcp spt:80\nACCEPT     tcp  --  <span class="token number">172.17</span>.0.3           <span class="token number">172.17</span>.0.2           tcp dpt:80\nDROP       all  --  <span class="token number">0.0</span>.0.0/0            <span class="token number">0.0</span>.0.0/0</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意：<code class="language-text">--link=CONTAINER_NAME:ALIAS</code> 中的 CONTAINER_NAME 目前必须是 Docker 分配的名字，或使用 <code class="language-text">--name</code> 参数指定的名字。主机名则不会被识别。</p>\n<h2 id="映射容器端口到宿主主机的实现"><a href="#%E6%98%A0%E5%B0%84%E5%AE%B9%E5%99%A8%E7%AB%AF%E5%8F%A3%E5%88%B0%E5%AE%BF%E4%B8%BB%E4%B8%BB%E6%9C%BA%E7%9A%84%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>映射容器端口到宿主主机的实现</h2>\n<p>默认情况下，容器可以主动访问到外部网络的连接，但是外部网络无法访问到容器。</p>\n<h3 id="容器访问外部实现"><a href="#%E5%AE%B9%E5%99%A8%E8%AE%BF%E9%97%AE%E5%A4%96%E9%83%A8%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器访问外部实现</h3>\n<p>容器所有到外部网络的连接，源地址都会被 NAT 成本地系统的 IP 地址。这是使用 iptables 的源地址伪装操作实现的。</p>\n<p>查看主机的 NAT 规则。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35184762088888810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo iptables -t nat -nL\n...\nChain POSTROUTING (policy ACCEPT)\ntarget     prot opt source               destination\nMASQUERADE  all  --  172.17.0.0/16       !172.17.0.0/16\n...`, `35184762088888810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> iptables -t nat -nL\n<span class="token punctuation">..</span>.\nChain POSTROUTING <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>\ntarget     prot opt <span class="token builtin class-name">source</span>               destination\nMASQUERADE  all  --  <span class="token number">172.17</span>.0.0/16       <span class="token operator">!</span><span class="token number">172.17</span>.0.0/16\n<span class="token punctuation">..</span>.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其中，上述规则将所有源地址在 <code class="language-text">172.17.0.0/16</code> 网段，目标地址为其他网段（外部网络）的流量动态伪装为从系统网卡发出。MASQUERADE 跟传统 SNAT 的好处是它能动态从网卡获取地址。</p>\n<h3 id="外部访问容器实现"><a href="#%E5%A4%96%E9%83%A8%E8%AE%BF%E9%97%AE%E5%AE%B9%E5%99%A8%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>外部访问容器实现</h3>\n<p>容器允许外部访问，可以在 docker run 时候通过 -p 或 -P 参数来启用。</p>\n<p>不管用那种办法，其实也是在本地的 iptable 的 nat 表中添加相应的规则。</p>\n<p>使用 -P 时：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11627834979184538000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ iptables -t nat -nL\n...\nChain DOCKER (2 references)\ntarget     prot opt source               destination\nDNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:49153 to:172.17.0.2:80`, `11627834979184538000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ iptables -t nat -nL\n<span class="token punctuation">..</span>.\nChain DOCKER <span class="token punctuation">(</span><span class="token number">2</span> references<span class="token punctuation">)</span>\ntarget     prot opt <span class="token builtin class-name">source</span>               destination\nDNAT       tcp  --  <span class="token number">0.0</span>.0.0/0            <span class="token number">0.0</span>.0.0/0            tcp dpt:49153 to:172.17.0.2:80</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 -p 80:80 时：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93252126812986740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ iptables -t nat -nL\nChain DOCKER (2 references)\ntarget     prot opt source               destination\nDNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:80 to:172.17.0.2:80`, `93252126812986740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ iptables -t nat -nL\nChain DOCKER <span class="token punctuation">(</span><span class="token number">2</span> references<span class="token punctuation">)</span>\ntarget     prot opt <span class="token builtin class-name">source</span>               destination\nDNAT       tcp  --  <span class="token number">0.0</span>.0.0/0            <span class="token number">0.0</span>.0.0/0            tcp dpt:80 to:172.17.0.2:80</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意：</p>\n<ul>\n<li>\n<p>这里的规则映射了 <code class="language-text">0.0.0.0</code>，意味着将接受主机来自所有接口的流量。用户可以通过 <code class="language-text">-p IP:host_port:container_port</code> 或 <code class="language-text">-p IP::port</code> 来指定允许访问容器的主机上的 IP、接口等，以制定更严格的规则。</p>\n</li>\n<li>\n<p>如果希望永久绑定到某个固定的 IP 地址，可以在 Docker 配置文件 <code class="language-text">/etc/docker/daemon.json</code> 中添加如下内容。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17488654695522787000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n&quot;ip&quot;: &quot;0.0.0.0&quot;\n}`, `17488654695522787000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n<span class="token property">"ip"</span><span class="token operator">:</span> <span class="token string">"0.0.0.0"</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n</li>\n</ul>\n<h2 id="自定义网桥"><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E6%A1%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>自定义网桥</h2>\n<p>除了默认的 docker0 网桥，用户也可以指定网桥来连接各个容器。</p>\n<p>在启动 Docker 服务的时候，使用 <code class="language-text">-b BRIDGE</code> 或 <code class="language-text">--bridge=BRIDGE</code> 来指定使用的网桥。</p>\n<p>如果服务已经运行，那需要先停止服务，并删除旧的网桥。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47772851751943480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo systemctl stop docker\n\\$ sudo ip link set dev docker0 down\n\\$ sudo brctl delbr docker0`, `47772851751943480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> systemctl stop docker\n$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dev docker0 down\n$ <span class="token function">sudo</span> brctl delbr docker0</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>然后创建一个网桥 bridge0。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36391150117433856000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo brctl addbr bridge0\n\\$ sudo ip addr add 192.168.5.1/24 dev bridge0\n\\$ sudo ip link set dev bridge0 up`, `36391150117433856000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> brctl addbr bridge0\n$ <span class="token function">sudo</span> <span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">192.168</span>.5.1/24 dev bridge0\n$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dev bridge0 up</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>查看确认网桥创建并启动。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67860579218907200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ ip addr show bridge0\n4: bridge0: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state UP group default\n    link/ether 66:38:d0:0d:76:18 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.5.1/24 scope global bridge0\n       valid_lft forever preferred_lft forever`, `67860579218907200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">ip</span> addr show bridge0\n<span class="token number">4</span>: bridge0: <span class="token operator">&lt;</span>BROADCAST,MULTICAST<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc noop state UP group default\n    link/ether <span class="token number">66</span>:38:d0:0d:76:18 brd ff:ff:ff:ff:ff:ff\n    inet <span class="token number">192.168</span>.5.1/24 scope global bridge0\n       valid_lft forever preferred_lft forever</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 Docker 配置文件 <code class="language-text">/etc/docker/daemon.json</code> 中添加如下内容，即可将 Docker 默认桥接到创建的网桥上。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48090493363250020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;bridge&quot;: &quot;bridge0&quot;\n}`, `48090493363250020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"bridge"</span><span class="token operator">:</span> <span class="token string">"bridge0"</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>启动 Docker 服务。</p>\n<p>新建一个容器，可以看到它已经桥接到了 bridge0 上。</p>\n<p>可以继续用 brctl show 命令查看桥接的信息。另外，在容器中可以使用 ip addr 和 ip route 命令来查看 IP 地址配置和路由信息。</p>\n<h2 id="工具和示例"><a href="#%E5%B7%A5%E5%85%B7%E5%92%8C%E7%A4%BA%E4%BE%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>工具和示例</h2>\n<p>在介绍自定义网络拓扑之前，你可能会对一些外部工具和例子感兴趣：</p>\n<h3 id="pipework"><a href="#pipework" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pipework</h3>\n<p>Jérôme Petazzoni 编写了一个叫 <a href="https://github.com/jpetazzo/pipework" target="_blank" rel="nofollow noreferrer noopener">pipework</a> 的 shell 脚本，可以帮助用户在比较复杂的场景中完成容器的连接。</p>\n<h3 id="playground"><a href="#playground" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>playground</h3>\n<p>Brandon Rhodes 创建了一个提供完整的 Docker 容器网络拓扑管理的 <a href="https://github.com/brandon-rhodes/fopnp/tree/m/playground" target="_blank" rel="nofollow noreferrer noopener">Python 库</a>，包括路由、NAT 防火墙；以及一些提供 HTTP SMTP POP IMAP Telnet SSH FTP 的服务器。</p>\n<h2 id="编辑网络配置文件"><a href="#%E7%BC%96%E8%BE%91%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编辑网络配置文件</h2>\n<p>Docker 1.2.0 开始支持在运行中的容器里编辑 <code class="language-text">/etc/hosts</code>, <code class="language-text">/etc/hostname</code> 和 <code class="language-text">/etc/resolv.conf</code> 文件。</p>\n<p>但是这些修改是临时的，只在运行的容器中保留，容器终止或重启后并不会被保存下来，也不会被 <code class="language-text">docker commit</code> 提交。</p>\n<h2 id="示例：创建一个点到点连接"><a href="#%E7%A4%BA%E4%BE%8B%EF%BC%9A%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%82%B9%E5%88%B0%E7%82%B9%E8%BF%9E%E6%8E%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>示例：创建一个点到点连接</h2>\n<p>默认情况下，Docker 会将所有容器连接到由 docker0 提供的虚拟子网中。</p>\n<p>用户有时候需要两个容器之间可以直连通信，而不用通过主机网桥进行桥接。</p>\n<p>解决办法很简单：创建一对 peer 接口，分别放到两个容器中，配置成点到点链路类型即可。</p>\n<p>首先启动 2 个容器：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31682080104183250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run -i -t --rm --net=none base /bin/bash\nroot@1f1f4c1f931a:/#\n\\$ docker run -i -t --rm --net=none base /bin/bash\nroot@12e343489d2f:/#`, `31682080104183250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run -i -t --rm --net<span class="token operator">=</span>none base /bin/bash\nroot@1f1f4c1f931a:/<span class="token comment">#</span>\n$ docker run -i -t --rm --net<span class="token operator">=</span>none base /bin/bash\nroot@12e343489d2f:/<span class="token comment">#</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>找到进程号，然后创建网络命名空间的跟踪文件。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44524393696977340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker inspect -f \'{{.State.Pid}}\' 1f1f4c1f931a\n2989\n\\$ docker inspect -f \'{{.State.Pid}}\' 12e343489d2f\n3004\n\\$ sudo mkdir -p /var/run/netns\n\\$ sudo ln -s /proc/2989/ns/net /var/run/netns/2989\n\\$ sudo ln -s /proc/3004/ns/net /var/run/netns/3004`, `44524393696977340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker inspect -f <span class="token string">\'{{.State.Pid}}\'</span> 1f1f4c1f931a\n<span class="token number">2989</span>\n$ docker inspect -f <span class="token string">\'{{.State.Pid}}\'</span> 12e343489d2f\n<span class="token number">3004</span>\n$ <span class="token function">sudo</span> <span class="token function">mkdir</span> -p /var/run/netns\n$ <span class="token function">sudo</span> <span class="token function">ln</span> -s /proc/2989/ns/net /var/run/netns/2989\n$ <span class="token function">sudo</span> <span class="token function">ln</span> -s /proc/3004/ns/net /var/run/netns/3004</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>创建一对 peer 接口，然后配置路由</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21584046368397013000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo ip link add A type veth peer name B\n\n\\$ sudo ip link set A netns 2989\n\\$ sudo ip netns exec 2989 ip addr add 10.1.1.1/32 dev A\n\\$ sudo ip netns exec 2989 ip link set A up\n\\$ sudo ip netns exec 2989 ip route add 10.1.1.2/32 dev A\n\n\\$ sudo ip link set B netns 3004\n\\$ sudo ip netns exec 3004 ip addr add 10.1.1.2/32 dev B\n\\$ sudo ip netns exec 3004 ip link set B up\n\\$ sudo ip netns exec 3004 ip route add 10.1.1.1/32 dev B`, `21584046368397013000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token function">add</span> A <span class="token builtin class-name">type</span> veth peer name B\n\n$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> A netns <span class="token number">2989</span>\n$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">2989</span> <span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">10.1</span>.1.1/32 dev A\n$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">2989</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> A up\n$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">2989</span> <span class="token function">ip</span> route <span class="token function">add</span> <span class="token number">10.1</span>.1.2/32 dev A\n\n$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> B netns <span class="token number">3004</span>\n$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">3004</span> <span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">10.1</span>.1.2/32 dev B\n$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">3004</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> B up\n$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">3004</span> <span class="token function">ip</span> route <span class="token function">add</span> <span class="token number">10.1</span>.1.1/32 dev B</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在这 2 个容器就可以相互 ping 通，并成功建立连接。点到点链路不需要子网和子网掩码。</p>\n<p>此外，也可以不指定 <code class="language-text">--net=none</code> 来创建点到点链路。这样容器还可以通过原先的网络来通信。</p>\n<p>利用类似的办法，可以创建一个只跟主机通信的容器。但是一般情况下，更推荐使用 <code class="language-text">--icc=false</code> 来关闭容器之间的通信。</p>\n<h1 id="swarm-mode"><a href="#swarm-mode" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Swarm mode</h1>\n<p>Docker 1.12 <a href="https://docs.docker.com/engine/swarm/" target="_blank" rel="nofollow noreferrer noopener">Swarm mode</a> 已经内嵌入 Docker 引擎，成为了 docker 子命令 docker swarm。请注意与旧的 Docker Swarm 区分开来。</p>\n<p>Swarm mode 内置 kv 存储功能，提供了众多的新特性，比如：具有容错能力的去中心化设计、内置服务发现、负载均衡、路由网格、动态伸缩、滚动更新、安全传输等。使得 Docker 原生的 Swarm 集群具备与 Mesos、Kubernetes 竞争的实力。</p>\n<h2 id="基本概念-1"><a href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基本概念</h2>\n<p>Swarm 是使用 <a href="https://github.com/docker/swarmkit/" target="_blank" rel="nofollow noreferrer noopener">SwarmKit</a> 构建的 Docker 引擎内置（原生）的集群管理和编排工具。</p>\n<p>使用 Swarm 集群之前需要了解以下几个概念。</p>\n<h3 id="节点"><a href="#%E8%8A%82%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>节点</h3>\n<p>运行 Docker 的主机可以主动初始化一个 Swarm 集群或者加入一个已存在的 Swarm 集群，这样这个运行 Docker 的主机就成为一个 Swarm 集群的节点 (node) 。</p>\n<p>节点分为管理 (manager) 节点和工作 (worker) 节点。</p>\n<p>管理节点用于 Swarm 集群的管理，docker swarm 命令基本只能在管理节点执行（节点退出集群命令 <code class="language-text">docker swarm leave</code> 可以在工作节点执行）。一个 Swarm 集群可以有多个管理节点，但只有一个管理节点可以成为 leader，leader 通过 <a href="https://thesecretlivesofdata.com/raft/" target="_blank" rel="nofollow noreferrer noopener">raft 协议</a>实现。</p>\n<p>工作节点是任务执行节点，管理节点将服务 (service) 下发至工作节点执行。管理节点默认也作为工作节点。你也可以通过配置让服务只运行在管理节点。</p>\n<p>来自 Docker 官网的这张图片形象的展示了集群中管理节点与工作节点的关系。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-19-11-16-29-db0a7eee4e4ce292445a5148537ae9ac-d1d8a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 46.893123446561724%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAABmUlEQVQoz22PWU/bQBSF8///QougahRE+1CQKgQq0DYtSI2VhpSgxCFexmPH+9iexZ7FS90AD7Q9Ojq69+HTuXfQ7dR2HVEt4s2jc9n1Lh5TdRHldpyDpIAJTih/Qtp20D0rKOtpJLRYTkJxZaSXm/ji4Y8/m2io2ad6fO2xW594RDbtP3BcNdOQj91SC/jUZ9cQX1r5jUt+BmwM8FfItEjYtEl4W+/oF3BUNd8hOV+4exPn7QJ9Afhi5b+eOG/u0m+QflpuX/0AV4BkslV/we2ueRFXmh0Nb/0TPbWwmm+Lw1/BxzWysJy52WgenBo5kv9rZqImlapk3XRdnwlmlWq4ajDjOeP9o3XbUV7z5hno4URKm1CAscvYA8piJWDJbFyEguspAkVhZLlXMq+k/RCKysxzWJaoVkjKwbwojgxjf+UcO95obQwN/wSA/aX9wfFH682hGbwzreEaHNn+e8M40N1jAA+WmzOYBoIPQiE8KeaIWiUHFZ+lxJfiPmc6Lj0hZil1hVgV7D6jgZL9ahI6dYOxue2P+g2C3u29d5l6SwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 19 11 16 29" title="" data-src="/static/2022-07-19-11-16-29-db0a7eee4e4ce292445a5148537ae9ac-fee1c.png" data-srcset="/static/2022-07-19-11-16-29-db0a7eee4e4ce292445a5148537ae9ac-a67b7.png 200w,\n/static/2022-07-19-11-16-29-db0a7eee4e4ce292445a5148537ae9ac-0b187.png 400w,\n/static/2022-07-19-11-16-29-db0a7eee4e4ce292445a5148537ae9ac-fee1c.png 800w,\n/static/2022-07-19-11-16-29-db0a7eee4e4ce292445a5148537ae9ac-b1a91.png 1200w,\n/static/2022-07-19-11-16-29-db0a7eee4e4ce292445a5148537ae9ac-d1d8a.png 1207w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="服务和任务"><a href="#%E6%9C%8D%E5%8A%A1%E5%92%8C%E4%BB%BB%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务和任务</h3>\n<p>任务（Task）是 Swarm 中的最小的调度单位，目前来说就是一个单一的容器。</p>\n<p>服务（Services）是指一组任务的集合，服务定义了任务的属性。服务有两种模式：</p>\n<ol>\n<li><code class="language-text">replicated services</code> 按照一定规则在各个工作节点上运行指定个数的任务。</li>\n<li><code class="language-text">global services</code> 每个工作节点上运行一个任务</li>\n</ol>\n<p>两种模式通过 <code class="language-text">docker service create</code> 的 <code class="language-text">--mode</code> 参数指定。</p>\n<p>来自 Docker 官网的这张图片形象的展示了容器、任务、服务的关系。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-19-11-16-53-f4c415047158c2dd2c692b7057088a9b-fee1c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 69%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAACF0lEQVQoz4VS227bMAzN/3/JHnfBuqJb16xp2mQN2mRYk665+iZbN9uKJcuWZGWyvZcBQ0cQgiTygDw8HJxeN2uXqw2mqbsCAFfP2+WvLeeijZxOg1eAjbXPnE8gekyzOWNTQsYRmGI8JiSW8tSDbZcnSlmIUmltux9nldLnfvBuvfscgRFjS4R9kLj6wzh+4bwF2y7RGLP3o5edl7FjX9OdR1FeRuArwjdpepPntwgvKF0Qeh7H2x5cmwYKRaRJeA1YRav2KVQja1UppWxTNQ1mxXLnraPYeaFUaYxumhbMVTMM5G2irsPS+QTpy0BGx0pr7cKZUlRrUtdJWfqce0IEUkZSii464LW5R2qO6/cPmzfjn3d+PiMGFLUj4tp2bM/C6CJOrtJ0CuETRKsEnQOwLrq2XdoEqhmUH+b7tw+7sccmuAU3xjAhLkF84YfXEM3KckXTgKY+It8gXPOiBTt6s6R6xMr5nGjXwndYJUWtu7HvhViX4inLbg7+2A/vQrA6skWW0arqBqabUttDQlYHsAnhj42fclk3VsiWtpu687KqEE1xzmDGKmOcFr2Wgz7811K1Up16qUYQDQkZUTpm+Qjje0qmCH0CYN9L9e+l7E5Z12cH7+N2/yUEE843hCKICcRjiF5eAfdmrF0wNsvzmeOM0DWIJxA+pOkQoaAs/wNu+3dmbX7kay/wYniIoeNs7J8N/g1ZjhJSNTR2XQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 19 11 16 53" title="" data-src="/static/2022-07-19-11-16-53-f4c415047158c2dd2c692b7057088a9b-fee1c.png" data-srcset="/static/2022-07-19-11-16-53-f4c415047158c2dd2c692b7057088a9b-a67b7.png 200w,\n/static/2022-07-19-11-16-53-f4c415047158c2dd2c692b7057088a9b-0b187.png 400w,\n/static/2022-07-19-11-16-53-f4c415047158c2dd2c692b7057088a9b-fee1c.png 800w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="创建-swarm-集群"><a href="#%E5%88%9B%E5%BB%BA-swarm-%E9%9B%86%E7%BE%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建 Swarm 集群</h2>\n<p>Swarm 集群由管理节点和工作节点组成，本节我们来创建一个包含一个管理节点和两个工作节点的最小 Swarm 集群。</p>\n<h3 id="初始化集群"><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>初始化集群</h3>\n<p>在已经安装好 Docker 的主机上执行如下命令：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14811341389626941000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker swarm init --advertise-addr 192.168.99.100\nSwarm initialized: current node (dxn1zf6l61qsb1josjja83ngz) is now a manager.\n\nTo add a worker to this swarm, run the following command:\n\n    docker swarm join \\\n    --token SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c \\\n    192.168.99.100:2377\n\nTo add a manager to this swarm, run \'docker swarm join-token manager\' and follow the instructions.`, `14811341389626941000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker swarm init --advertise-addr <span class="token number">192.168</span>.99.100\nSwarm initialized: current node <span class="token punctuation">(</span>dxn1zf6l61qsb1josjja83ngz<span class="token punctuation">)</span> is now a manager.\n\nTo <span class="token function">add</span> a worker to this swarm, run the following command:\n\n    docker swarm <span class="token function">join</span> <span class="token punctuation">\\</span>\n    --token SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c <span class="token punctuation">\\</span>\n    <span class="token number">192.168</span>.99.100:2377\n\nTo <span class="token function">add</span> a manager to this swarm, run <span class="token string">\'docker swarm join-token manager\'</span> and follow the instructions.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果你的 Docker 主机有多个网卡，拥有多个 IP，必须使用 <code class="language-text">--advertise-addr</code> 指定 IP。</p>\n<blockquote>\n<p>执行 <code class="language-text">docker swarm init</code> 命令的节点自动成为管理节点。</p>\n</blockquote>\n<h3 id="增加工作节点"><a href="#%E5%A2%9E%E5%8A%A0%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>增加工作节点</h3>\n<p>上一步我们初始化了一个 Swarm 集群，拥有了一个管理节点，下面我们继续在两个 Docker 主机中分别执行如下命令，创建工作节点并加入到集群中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49907462815438650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker swarm join \\\n    --token SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c \\\n    192.168.99.100:2377\n\nThis node joined a swarm as a worker.`, `49907462815438650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker swarm <span class="token function">join</span> <span class="token punctuation">\\</span>\n    --token SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c <span class="token punctuation">\\</span>\n    <span class="token number">192.168</span>.99.100:2377\n\nThis node joined a swarm as a worker.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="查看集群"><a href="#%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看集群</h3>\n<p>经过上边的两步，我们已经拥有了一个最小的 Swarm 集群，包含一个管理节点和两个工作节点。</p>\n<p>在管理节点使用 <code class="language-text">docker node ls</code> 查看集群。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67561515601007624000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker node ls\nID                           HOSTNAME  STATUS  AVAILABILITY  MANAGER STATUS\n03g1y59jwfg7cf99w4lt0f662    worker2   Ready   Active\n9j68exjopxe7wfl6yuxml7a7j    worker1   Ready   Active\ndxn1zf6l61qsb1josjja83ngz *  manager   Ready   Active        Leader`, `67561515601007624000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker node <span class="token function">ls</span>\nID                           <span class="token environment constant">HOSTNAME</span>  STATUS  AVAILABILITY  MANAGER STATUS\n03g1y59jwfg7cf99w4lt0f662    worker2   Ready   Active\n9j68exjopxe7wfl6yuxml7a7j    worker1   Ready   Active\ndxn1zf6l61qsb1josjja83ngz *  manager   Ready   Active        Leader</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="部署服务"><a href="#%E9%83%A8%E7%BD%B2%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>部署服务</h2>\n<p>我们使用 docker service 命令来管理 Swarm 集群中的服务，该命令只能在管理节点运行。</p>\n<h3 id="新建服务"><a href="#%E6%96%B0%E5%BB%BA%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>新建服务</h3>\n<p>现在我们在上一节创建的 Swarm 集群中运行一个名为 nginx 服务。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40413651389553795000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service create --replicas 3 -p 80:80 --name nginx nginx:1.13.7-alpine`, `40413651389553795000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> create --replicas <span class="token number">3</span> -p <span class="token number">80</span>:80 --name nginx nginx:1.13.7-alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>现在我们使用浏览器，输入任意节点 IP（即 <code class="language-text">192.168.99.100:80</code>），即可看到 nginx 默认页面。</p>\n<h3 id="查看服务"><a href="#%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看服务</h3>\n<p>使用 <code class="language-text">docker service ls</code> 来查看当前 Swarm 集群运行的服务。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45300301892247740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service ls\nID                  NAME                MODE                REPLICAS            IMAGE                 PORTS\nkc57xffvhul5        nginx               replicated          3/3                 nginx:1.13.7-alpine   *:80->80/tcp`, `45300301892247740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> <span class="token function">ls</span>\nID                  NAME                MODE                REPLICAS            IMAGE                 PORTS\nkc57xffvhul5        nginx               replicated          <span class="token number">3</span>/3                 nginx:1.13.7-alpine   *:80-<span class="token operator">></span><span class="token number">80</span>/tcp</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>使用 <code class="language-text">docker service ps</code> 来查看某个服务的详情。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82376481904096150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service ps nginx\nID                  NAME                IMAGE                 NODE                DESIRED STATE       CURRENT STATE                ERROR               PORTS\npjfzd39buzlt        nginx.1             nginx:1.13.7-alpine   swarm2              Running             Running about a minute ago\nhy9eeivdxlaa        nginx.2             nginx:1.13.7-alpine   swarm1              Running             Running about a minute ago\n36wmpiv7gmfo        nginx.3             nginx:1.13.7-alpine   swarm3              Running             Running about a minute ago`, `82376481904096150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> <span class="token function">ps</span> nginx\nID                  NAME                IMAGE                 NODE                DESIRED STATE       CURRENT STATE                ERROR               PORTS\npjfzd39buzlt        nginx.1             nginx:1.13.7-alpine   swarm2              Running             Running about a minute ago\nhy9eeivdxlaa        nginx.2             nginx:1.13.7-alpine   swarm1              Running             Running about a minute ago\n36wmpiv7gmfo        nginx.3             nginx:1.13.7-alpine   swarm3              Running             Running about a minute ago</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 <code class="language-text">docker service logs</code> 来查看某个服务的日志。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2910560605041379000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service logs nginx\nnginx.3.36wmpiv7gmfo@swarm3    | 10.255.0.4 - - [25/Nov/2017:02:10:30 +0000] &quot;GET / HTTP/1.1&quot; 200 612 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0&quot; &quot;-&quot;\nnginx.3.36wmpiv7gmfo@swarm3    | 10.255.0.4 - - [25/Nov/2017:02:10:30 +0000] &quot;GET /favicon.ico HTTP/1.1&quot; 404 169 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0&quot; &quot;-&quot;\nnginx.3.36wmpiv7gmfo@swarm3    | 2017/11/25 02:10:30 [error] 5#5: *1 open() &quot;/usr/share/nginx/html/favicon.ico&quot; failed (2: No such file or directory), client: 10.255.0.4, server: localhost, request: &quot;GET /favicon.ico HTTP/1.1&quot;, host: &quot;192.168.99.102&quot;\nnginx.1.pjfzd39buzlt@swarm2    | 10.255.0.2 - - [25/Nov/2017:02:10:26 +0000] &quot;GET / HTTP/1.1&quot; 200 612 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0&quot; &quot;-&quot;\nnginx.1.pjfzd39buzlt@swarm2    | 10.255.0.2 - - [25/Nov/2017:02:10:27 +0000] &quot;GET /favicon.ico HTTP/1.1&quot; 404 169 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0&quot; &quot;-&quot;\nnginx.1.pjfzd39buzlt@swarm2    | 2017/11/25 02:10:27 [error] 5#5: *1 open() &quot;/usr/share/nginx/html/favicon.ico&quot; failed (2: No such file or directory), client: 10.255.0.2, server: localhost, request: &quot;GET /favicon.ico HTTP/1.1&quot;, host: &quot;192.168.99.101&quot;`, `2910560605041379000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> logs nginx\nnginx.3.36wmpiv7gmfo@swarm3    <span class="token operator">|</span> <span class="token number">10.255</span>.0.4 - - <span class="token punctuation">[</span><span class="token number">25</span>/Nov/2017:02:10:30 +0000<span class="token punctuation">]</span> <span class="token string">"GET / HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">612</span> <span class="token string">"-"</span> <span class="token string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0"</span> <span class="token string">"-"</span>\nnginx.3.36wmpiv7gmfo@swarm3    <span class="token operator">|</span> <span class="token number">10.255</span>.0.4 - - <span class="token punctuation">[</span><span class="token number">25</span>/Nov/2017:02:10:30 +0000<span class="token punctuation">]</span> <span class="token string">"GET /favicon.ico HTTP/1.1"</span> <span class="token number">404</span> <span class="token number">169</span> <span class="token string">"-"</span> <span class="token string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0"</span> <span class="token string">"-"</span>\nnginx.3.36wmpiv7gmfo@swarm3    <span class="token operator">|</span> <span class="token number">2017</span>/11/25 02:10:30 <span class="token punctuation">[</span>error<span class="token punctuation">]</span> <span class="token number">5</span><span class="token comment">#5: *1 open() "/usr/share/nginx/html/favicon.ico" failed (2: No such file or directory), client: 10.255.0.4, server: localhost, request: "GET /favicon.ico HTTP/1.1", host: "192.168.99.102"</span>\nnginx.1.pjfzd39buzlt@swarm2    <span class="token operator">|</span> <span class="token number">10.255</span>.0.2 - - <span class="token punctuation">[</span><span class="token number">25</span>/Nov/2017:02:10:26 +0000<span class="token punctuation">]</span> <span class="token string">"GET / HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">612</span> <span class="token string">"-"</span> <span class="token string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0"</span> <span class="token string">"-"</span>\nnginx.1.pjfzd39buzlt@swarm2    <span class="token operator">|</span> <span class="token number">10.255</span>.0.2 - - <span class="token punctuation">[</span><span class="token number">25</span>/Nov/2017:02:10:27 +0000<span class="token punctuation">]</span> <span class="token string">"GET /favicon.ico HTTP/1.1"</span> <span class="token number">404</span> <span class="token number">169</span> <span class="token string">"-"</span> <span class="token string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko/20100101 Firefox/58.0"</span> <span class="token string">"-"</span>\nnginx.1.pjfzd39buzlt@swarm2    <span class="token operator">|</span> <span class="token number">2017</span>/11/25 02:10:27 <span class="token punctuation">[</span>error<span class="token punctuation">]</span> <span class="token number">5</span><span class="token comment">#5: *1 open() "/usr/share/nginx/html/favicon.ico" failed (2: No such file or directory), client: 10.255.0.2, server: localhost, request: "GET /favicon.ico HTTP/1.1", host: "192.168.99.101"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="服务伸缩"><a href="#%E6%9C%8D%E5%8A%A1%E4%BC%B8%E7%BC%A9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务伸缩</h3>\n<p>我们可以使用 <code class="language-text">docker service scale</code> 对一个服务运行的容器数量进行伸缩。</p>\n<p>当业务处于高峰期时，我们需要扩展服务运行的容器数量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="356209925260686500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service scale nginx=5`, `356209925260686500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> scale <span class="token assign-left variable">nginx</span><span class="token operator">=</span><span class="token number">5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>当业务平稳时，我们需要减少服务运行的容器数量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1771544489293264100"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service scale nginx=2`, `1771544489293264100`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> scale <span class="token assign-left variable">nginx</span><span class="token operator">=</span><span class="token number">2</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="删除服务"><a href="#%E5%88%A0%E9%99%A4%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>删除服务</h3>\n<p>使用 <code class="language-text">docker service rm</code> 来从 Swarm 集群移除某个服务。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12957869302407365000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service rm nginx`, `12957869302407365000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> <span class="token function">rm</span> nginx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="在-swarm-集群中使用-compose-文件"><a href="#%E5%9C%A8-swarm-%E9%9B%86%E7%BE%A4%E4%B8%AD%E4%BD%BF%E7%94%A8-compose-%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>在 Swarm 集群中使用 compose 文件</h2>\n<p>正如之前使用 <code class="language-text">docker-compose.yml</code> 来一次配置、启动多个容器，在 Swarm 集群中也可以使用 compose 文件（docker-compose.yml）来配置、启动多个服务。</p>\n<p>上一节中，我们使用 <code class="language-text">docker service create</code> 一次只能部署一个服务，使用 <code class="language-text">docker-compose.yml</code> 我们可以一次启动多个关联的服务。</p>\n<p>我们以在 Swarm 集群中部署 WordPress 为例进行说明。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51926665499298210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\n\nservices:\n  wordpress:\n    image: wordpress\n    ports:\n      - 80:80\n    networks:\n      - overlay\n    environment:\n      WORDPRESS_DB_HOST: db:3306\n      WORDPRESS_DB_USER: wordpress\n      WORDPRESS_DB_PASSWORD: wordpress\n    deploy:\n      mode: replicated\n      replicas: 3\n\n  db:\n    image: mysql\n    networks:\n      - overlay\n    volumes:\n      - db-data:/var/lib/mysql\n    environment:\n      MYSQL_ROOT_PASSWORD: somewordpress\n      MYSQL_DATABASE: wordpress\n      MYSQL_USER: wordpress\n      MYSQL_PASSWORD: wordpress\n    deploy:\n      placement:\n        constraints: [node.role == manager]\n\n  visualizer:\n    image: dockersamples/visualizer:stable\n    ports:\n      - \'8080:8080\'\n    stop_grace_period: 1m30s\n    volumes:\n      - \'/var/run/docker.sock:/var/run/docker.sock\'\n    deploy:\n      placement:\n        constraints: [node.role == manager]\n\nvolumes:\n  db-data:\nnetworks:\n  overlay:`, `51926665499298210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">wordpress</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> wordpress\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token datetime number">80:80</span>\n    <span class="token key atrule">networks</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> overlay\n    <span class="token key atrule">environment</span><span class="token punctuation">:</span>\n      <span class="token key atrule">WORDPRESS_DB_HOST</span><span class="token punctuation">:</span> db<span class="token punctuation">:</span><span class="token number">3306</span>\n      <span class="token key atrule">WORDPRESS_DB_USER</span><span class="token punctuation">:</span> wordpress\n      <span class="token key atrule">WORDPRESS_DB_PASSWORD</span><span class="token punctuation">:</span> wordpress\n    <span class="token key atrule">deploy</span><span class="token punctuation">:</span>\n      <span class="token key atrule">mode</span><span class="token punctuation">:</span> replicated\n      <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>\n\n  <span class="token key atrule">db</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql\n    <span class="token key atrule">networks</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> overlay\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> db<span class="token punctuation">-</span>data<span class="token punctuation">:</span>/var/lib/mysql\n    <span class="token key atrule">environment</span><span class="token punctuation">:</span>\n      <span class="token key atrule">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span> somewordpress\n      <span class="token key atrule">MYSQL_DATABASE</span><span class="token punctuation">:</span> wordpress\n      <span class="token key atrule">MYSQL_USER</span><span class="token punctuation">:</span> wordpress\n      <span class="token key atrule">MYSQL_PASSWORD</span><span class="token punctuation">:</span> wordpress\n    <span class="token key atrule">deploy</span><span class="token punctuation">:</span>\n      <span class="token key atrule">placement</span><span class="token punctuation">:</span>\n        <span class="token key atrule">constraints</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>node.role == manager<span class="token punctuation">]</span>\n\n  <span class="token key atrule">visualizer</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> dockersamples/visualizer<span class="token punctuation">:</span>stable\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">\'8080:8080\'</span>\n    <span class="token key atrule">stop_grace_period</span><span class="token punctuation">:</span> 1m30s\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">\'/var/run/docker.sock:/var/run/docker.sock\'</span>\n    <span class="token key atrule">deploy</span><span class="token punctuation">:</span>\n      <span class="token key atrule">placement</span><span class="token punctuation">:</span>\n        <span class="token key atrule">constraints</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>node.role == manager<span class="token punctuation">]</span>\n\n<span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n  <span class="token key atrule">db-data</span><span class="token punctuation">:</span>\n<span class="token key atrule">networks</span><span class="token punctuation">:</span>\n  overlay<span class="token punctuation">:</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 Swarm 集群管理节点新建该文件，其中的 visualizer 服务提供一个可视化页面，我们可以从浏览器中很直观的查看集群中各个服务的运行节点。</p>\n<p>在 Swarm 集群中使用 <code class="language-text">docker-compose.yml</code> 需要用 <code class="language-text">docker stack</code> 命令，下面我们对该命令进行详细讲解。</p>\n<h3 id="部署服务-1"><a href="#%E9%83%A8%E7%BD%B2%E6%9C%8D%E5%8A%A1-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>部署服务</h3>\n<p>部署服务使用 <code class="language-text">docker stack deploy</code>，其中 <code class="language-text">-c</code> 参数指定 compose 文件名。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96785014452192310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker stack deploy -c docker-compose.yml wordpress`, `96785014452192310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker stack deploy -c docker-compose.yml wordpress</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>现在我们打开浏览器输入 <code class="language-text">任一节点IP:8080</code> 即可看到各节点运行状态。</p>\n<p>在浏览器新的标签页输入 <code class="language-text">任一节点IP</code> 即可看到 WordPress 安装界面，安装完成之后，输入 <code class="language-text">任一节点IP</code> 即可看到 WordPress 页面。</p>\n<h3 id="查看服务-1"><a href="#%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看服务</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34798257263983780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker stack ls\nNAME                SERVICES\nwordpress           3`, `34798257263983780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker stack <span class="token function">ls</span>\nNAME                SERVICES\nwordpress           <span class="token number">3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="移除服务"><a href="#%E7%A7%BB%E9%99%A4%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>移除服务</h3>\n<p>要移除服务，使用 <code class="language-text">docker stack down</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86234697389381500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker stack down wordpress\nRemoving service wordpress_db\nRemoving service wordpress_visualizer\nRemoving service wordpress_wordpress\nRemoving network wordpress_overlay\nRemoving network wordpress_default`, `86234697389381500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker stack down wordpress\nRemoving <span class="token function">service</span> wordpress_db\nRemoving <span class="token function">service</span> wordpress_visualizer\nRemoving <span class="token function">service</span> wordpress_wordpress\nRemoving network wordpress_overlay\nRemoving network wordpress_default</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>该命令不会移除服务所使用的数据卷，如果你想移除数据卷请使用 <code class="language-text">docker volume rm</code></p>\n<h2 id="在-swarm-集群中管理敏感数据"><a href="#%E5%9C%A8-swarm-%E9%9B%86%E7%BE%A4%E4%B8%AD%E7%AE%A1%E7%90%86%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>在 Swarm 集群中管理敏感数据</h2>\n<p>在动态的、大规模的分布式集群上，管理和分发密码、证书等敏感信息是极其重要的工作。传统的密钥分发方式（如密钥放入镜像中，设置环境变量，volume 动态挂载等）都存在着潜在的巨大的安全风险。</p>\n<p>Docker 目前已经提供了 secrets 管理功能，用户可以在 Swarm 集群中安全地管理密码、密钥证书等敏感数据，并允许在多个 Docker 容器实例之间共享访问指定的敏感数据。</p>\n<blockquote>\n<p>注意：secret 也可以在 Docker Compose 中使用。</p>\n</blockquote>\n<p>我们可以用 docker secret 命令来管理敏感信息。接下来我们在上面章节中创建好的 Swarm 集群中介绍该命令的使用。</p>\n<p>这里我们以在 Swarm 集群中部署 mysql 和 wordpress 服务为例。</p>\n<h3 id="创建-secret"><a href="#%E5%88%9B%E5%BB%BA-secret" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建 secret</h3>\n<p>我们使用 <code class="language-text">docker secret create</code> 命令以管道符的形式创建 secret</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39234055800331395000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ openssl rand -base64 20 | docker secret create mysql_password -\n\n\\$ openssl rand -base64 20 | docker secret create mysql_root_password -`, `39234055800331395000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ openssl rand -base64 <span class="token number">20</span> <span class="token operator">|</span> docker secret create mysql_password -\n\n$ openssl rand -base64 <span class="token number">20</span> <span class="token operator">|</span> docker secret create mysql_root_password -</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="查看-secret"><a href="#%E6%9F%A5%E7%9C%8B-secret" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看 secret</h3>\n<p>使用 <code class="language-text">docker secret ls</code> 命令来查看 secret</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9925788166541748000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker secret ls\n\nID                          NAME                  CREATED             UPDATED\nl1vinzevzhj4goakjap5ya409   mysql_password        41 seconds ago      41 seconds ago\nyvsczlx9votfw3l0nz5rlidig   mysql_root_password   12 seconds ago      12 seconds ago`, `9925788166541748000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker secret <span class="token function">ls</span>\n\nID                          NAME                  CREATED             UPDATED\nl1vinzevzhj4goakjap5ya409   mysql_password        <span class="token number">41</span> seconds ago      <span class="token number">41</span> seconds ago\nyvsczlx9votfw3l0nz5rlidig   mysql_root_password   <span class="token number">12</span> seconds ago      <span class="token number">12</span> seconds ago</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="创建-mysql-服务"><a href="#%E5%88%9B%E5%BB%BA-mysql-%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建 MySQL 服务</h3>\n<p>创建服务相关命令已经在前边章节进行了介绍，这里直接列出命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62937485279132525000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker network create -d overlay mysql_private\n\n\\$ docker service create \\\n     --name mysql \\\n     --replicas 1 \\\n     --network mysql_private \\\n     --mount type=volume,source=mydata,destination=/var/lib/mysql \\\n     --secret source=mysql_root_password,target=mysql_root_password \\\n     --secret source=mysql_password,target=mysql_password \\\n     -e MYSQL_ROOT_PASSWORD_FILE=&quot;/run/secrets/mysql_root_password&quot; \\\n     -e MYSQL_PASSWORD_FILE=&quot;/run/secrets/mysql_password&quot; \\\n     -e MYSQL_USER=&quot;wordpress&quot; \\\n     -e MYSQL_DATABASE=&quot;wordpress&quot; \\\n     mysql:latest`, `62937485279132525000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker network create -d overlay mysql_private\n\n$ docker <span class="token function">service</span> create <span class="token punctuation">\\</span>\n     --name mysql <span class="token punctuation">\\</span>\n     --replicas <span class="token number">1</span> <span class="token punctuation">\\</span>\n     --network mysql_private <span class="token punctuation">\\</span>\n     --mount <span class="token assign-left variable">type</span><span class="token operator">=</span>volume,source<span class="token operator">=</span>mydata,destination<span class="token operator">=</span>/var/lib/mysql <span class="token punctuation">\\</span>\n     --secret <span class="token assign-left variable">source</span><span class="token operator">=</span>mysql_root_password,target<span class="token operator">=</span>mysql_root_password <span class="token punctuation">\\</span>\n     --secret <span class="token assign-left variable">source</span><span class="token operator">=</span>mysql_password,target<span class="token operator">=</span>mysql_password <span class="token punctuation">\\</span>\n     -e <span class="token assign-left variable">MYSQL_ROOT_PASSWORD_FILE</span><span class="token operator">=</span><span class="token string">"/run/secrets/mysql_root_password"</span> <span class="token punctuation">\\</span>\n     -e <span class="token assign-left variable">MYSQL_PASSWORD_FILE</span><span class="token operator">=</span><span class="token string">"/run/secrets/mysql_password"</span> <span class="token punctuation">\\</span>\n     -e <span class="token assign-left variable">MYSQL_USER</span><span class="token operator">=</span><span class="token string">"wordpress"</span> <span class="token punctuation">\\</span>\n     -e <span class="token assign-left variable">MYSQL_DATABASE</span><span class="token operator">=</span><span class="token string">"wordpress"</span> <span class="token punctuation">\\</span>\n     mysql:latest</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果你没有在 target 中显式的指定路径时，secret 默认通过 tmpfs 文件系统挂载到容器的 /run/secrets 目录中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74313524750758450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service create \\\n     --name wordpress \\\n     --replicas 1 \\\n     --network mysql_private \\\n     --publish target=30000,port=80 \\\n     --mount type=volume,source=wpdata,destination=/var/www/html \\\n     --secret source=mysql_password,target=wp_db_password,mode=0444 \\\n     -e WORDPRESS_DB_USER=&quot;wordpress&quot; \\\n     -e WORDPRESS_DB_PASSWORD_FILE=&quot;/run/secrets/wp_db_password&quot; \\\n     -e WORDPRESS_DB_HOST=&quot;mysql:3306&quot; \\\n     -e WORDPRESS_DB_NAME=&quot;wordpress&quot; \\\n     wordpress:latest`, `74313524750758450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> create <span class="token punctuation">\\</span>\n     --name wordpress <span class="token punctuation">\\</span>\n     --replicas <span class="token number">1</span> <span class="token punctuation">\\</span>\n     --network mysql_private <span class="token punctuation">\\</span>\n     --publish <span class="token assign-left variable">target</span><span class="token operator">=</span><span class="token number">30000</span>,port<span class="token operator">=</span><span class="token number">80</span> <span class="token punctuation">\\</span>\n     --mount <span class="token assign-left variable">type</span><span class="token operator">=</span>volume,source<span class="token operator">=</span>wpdata,destination<span class="token operator">=</span>/var/www/html <span class="token punctuation">\\</span>\n     --secret <span class="token assign-left variable">source</span><span class="token operator">=</span>mysql_password,target<span class="token operator">=</span>wp_db_password,mode<span class="token operator">=</span>0444 <span class="token punctuation">\\</span>\n     -e <span class="token assign-left variable">WORDPRESS_DB_USER</span><span class="token operator">=</span><span class="token string">"wordpress"</span> <span class="token punctuation">\\</span>\n     -e <span class="token assign-left variable">WORDPRESS_DB_PASSWORD_FILE</span><span class="token operator">=</span><span class="token string">"/run/secrets/wp_db_password"</span> <span class="token punctuation">\\</span>\n     -e <span class="token assign-left variable">WORDPRESS_DB_HOST</span><span class="token operator">=</span><span class="token string">"mysql:3306"</span> <span class="token punctuation">\\</span>\n     -e <span class="token assign-left variable">WORDPRESS_DB_NAME</span><span class="token operator">=</span><span class="token string">"wordpress"</span> <span class="token punctuation">\\</span>\n     wordpress:latest</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>查看服务</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29720798629927846000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service ls\n\nID            NAME   MODE        REPLICAS  IMAGE\nwvnh0siktqr3  mysql      replicated  1/1       mysql:latest\nnzt5xzae4n62  wordpress  replicated  1/1       wordpress:latest`, `29720798629927846000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> <span class="token function">ls</span>\n\nID            NAME   MODE        REPLICAS  IMAGE\nwvnh0siktqr3  mysql      replicated  <span class="token number">1</span>/1       mysql:latest\nnzt5xzae4n62  wordpress  replicated  <span class="token number">1</span>/1       wordpress:latest</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在浏览器访问 <code class="language-text">IP:30000</code>，即可开始 WordPress 的安装与使用。</p>\n<p>通过以上方法，我们没有像以前通过设置环境变量来设置 MySQL 密码，而是采用 <code class="language-text">docker secret</code> 来设置密码，防范了密码泄露的风险。</p>\n<h2 id="在-swarm-集群中管理配置数据"><a href="#%E5%9C%A8-swarm-%E9%9B%86%E7%BE%A4%E4%B8%AD%E7%AE%A1%E7%90%86%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>在 Swarm 集群中管理配置数据</h2>\n<p>在动态的、大规模的分布式集群上，管理和分发配置文件也是很重要的工作。传统的配置文件分发方式（如配置文件放入镜像中，设置环境变量，volume 动态挂载等）都降低了镜像的通用性。</p>\n<p>在 Docker 17.06 以上版本中，Docker 新增了 docker config 子命令来管理集群中的配置信息，以后你无需将配置文件放入镜像或挂载到容器中就可实现对服务的配置。</p>\n<blockquote>\n<p>注意：config 仅能在 Swarm 集群中使用。</p>\n</blockquote>\n<p>这里我们以在 Swarm 集群中部署 redis 服务为例。</p>\n<h3 id="创建-config"><a href="#%E5%88%9B%E5%BB%BA-config" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建 config</h3>\n<p>新建 redis.conf 文件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58075594422537040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`port 6380`, `58075594422537040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">port <span class="token number">6380</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>此项配置 Redis 监听 6380 端口</p>\n<p>我们使用 docker config create 命令创建 config</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34505332419217514000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker config create redis.conf redis.conf`, `34505332419217514000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker config create redis.conf redis.conf</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="查看-config"><a href="#%E6%9F%A5%E7%9C%8B-config" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看 config</h3>\n<p>使用 docker config ls 命令来查看 config</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29216665404734353000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker config ls\n\nID                          NAME                CREATED             UPDATED\nyod8fx8iiqtoo84jgwadp86yk   redis.conf          4 seconds ago       4 seconds ago`, `29216665404734353000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker config <span class="token function">ls</span>\n\nID                          NAME                CREATED             UPDATED\nyod8fx8iiqtoo84jgwadp86yk   redis.conf          <span class="token number">4</span> seconds ago       <span class="token number">4</span> seconds ago</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="创建-redis-服务"><a href="#%E5%88%9B%E5%BB%BA-redis-%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建 redis 服务</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28381982046654230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service create \\\n     --name redis \\\n     # --config source=redis.conf,target=/etc/redis.conf \\\n     --config redis.conf \\\n     -p 6379:6380 \\\n     redis:latest \\\n     redis-server /redis.conf`, `28381982046654230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> create <span class="token punctuation">\\</span>\n     --name redis <span class="token punctuation">\\</span>\n     <span class="token comment"># --config source=redis.conf,target=/etc/redis.conf \\</span>\n     --config redis.conf <span class="token punctuation">\\</span>\n     -p <span class="token number">6379</span>:6380 <span class="token punctuation">\\</span>\n     redis:latest <span class="token punctuation">\\</span>\n     redis-server /redis.conf</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果你没有在 target 中显式的指定路径时，默认的 redis.conf 以 tmpfs 文件系统挂载到容器的 /config.conf。</p>\n<p>经过测试，redis 可以正常使用。</p>\n<p>以前我们通过监听主机目录来配置 Redis，就需要在集群的每个节点放置该文件，如果采用 <code class="language-text">docker config</code> 来管理服务的配置信息，我们只需在集群中的管理节点创建 config，当部署服务时，集群会自动的将配置文件分发到运行服务的各个节点中，大大降低了配置信息的管理和分发难度。</p>\n<h2 id="swarm-mode-与滚动升级"><a href="#swarm-mode-%E4%B8%8E%E6%BB%9A%E5%8A%A8%E5%8D%87%E7%BA%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Swarm mode 与滚动升级</h2>\n<p>在部署服务一节中我们使用 <code class="language-text">nginx:1.13.7-alpine</code> 镜像部署了一个名为 nginx 的服务。</p>\n<p>现在我们想要将 NGINX 版本升级到 <code class="language-text">1.13.12</code>，那么在 <code class="language-text">Swarm mode</code> 中如何升级服务呢？</p>\n<p>你可能会想到，先停止原来的服务，再使用新镜像部署一个服务，不就完成服务的 “升级” 了吗。</p>\n<p>这样做的弊端很明显，如果新部署的服务出现问题，原来的服务删除之后，很难恢复，那么在 Swarm mode 中到底该如何对服务进行滚动升级呢？</p>\n<p>答案就是使用 <code class="language-text">docker service update</code> 命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51765102042598924000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service update \\\n    --image nginx:1.13.12-alpine \\\n    nginx`, `51765102042598924000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> update <span class="token punctuation">\\</span>\n    --image nginx:1.13.12-alpine <span class="token punctuation">\\</span>\n    nginx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>以上命令使用 <code class="language-text">--image</code> 选项更新了服务的镜像。当然我们也可以使用 <code class="language-text">docker service update</code> 更新任意的配置。</p>\n<p><code class="language-text">--secret-add</code> 选项可以增加一个密钥</p>\n<p><code class="language-text">--secret-rm</code> 选项可以删除一个密钥</p>\n<p>更多选项可以通过 <code class="language-text">docker service update -h</code> 命令查看。</p>\n<h3 id="服务回退"><a href="#%E6%9C%8D%E5%8A%A1%E5%9B%9E%E9%80%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务回退</h3>\n<p>现在假设我们发现 nginx 服务的镜像升级到 <code class="language-text">nginx:1.13.12-alpine</code> 出现了一些问题，我们可以使用命令一键回退。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20500934333178278000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service rollback nginx`, `20500934333178278000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> rollback nginx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>现在使用 docker service ps 命令查看 nginx 服务详情。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87729053920583000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker service ps nginx\n\nID                  NAME                IMAGE                  NODE                DESIRED STATE       CURRENT STATE                ERROR               PORTS\nrt677gop9d4x        nginx.1             nginx:1.13.7-alpine   VM-20-83-debian     Running             Running about a minute ago\nd9pw13v59d00         \\_ nginx.1         nginx:1.13.12-alpine  VM-20-83-debian     Shutdown            Shutdown 2 minutes ago\ni7ynkbg6ybq5         \\_ nginx.1         nginx:1.13.7-alpine   VM-20-83-debian     Shutdown            Shutdown 2 minutes ago`, `87729053920583000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker <span class="token function">service</span> <span class="token function">ps</span> nginx\n\nID                  NAME                IMAGE                  NODE                DESIRED STATE       CURRENT STATE                ERROR               PORTS\nrt677gop9d4x        nginx.1             nginx:1.13.7-alpine   VM-20-83-debian     Running             Running about a minute ago\nd9pw13v59d00         <span class="token punctuation">\\</span>_ nginx.1         nginx:1.13.12-alpine  VM-20-83-debian     Shutdown            Shutdown <span class="token number">2</span> minutes ago\ni7ynkbg6ybq5         <span class="token punctuation">\\</span>_ nginx.1         nginx:1.13.7-alpine   VM-20-83-debian     Shutdown            Shutdown <span class="token number">2</span> minutes ago</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>结果的输出详细记录了服务的部署、滚动升级、回退的过程。</p>\n<h1 id="docker-buildx"><a href="#docker-buildx" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker Buildx</h1>\n<p>Docker Buildx 是一个 docker CLI 插件，其扩展了 docker 命令，支持 Moby BuildKit 提供的功能。提供了与 docker build 相同的用户体验，并增加了许多新功能。</p>\n<blockquote>\n<p>该功能仅适用于 Docker v19.03+ 版本</p>\n</blockquote>\n<h2 id="使用-buildkit-构建镜像"><a href="#%E4%BD%BF%E7%94%A8-buildkit-%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 BuildKit 构建镜像</h2>\n<p>BuildKit 是下一代的镜像构建组件，在 <a href="https://github.com/moby/buildkit" target="_blank" rel="nofollow noreferrer noopener">https://github.com/moby/buildkit</a> 开源。</p>\n<blockquote>\n<p>注意：如果您的镜像构建使用的是云服务商提供的镜像构建服务（腾讯云容器服务、阿里云容器服务等），由于上述服务提供商的 Docker 版本低于 18.09，BuildKit 无法使用，将造成镜像构建失败。建议使用 BuildKit 构建镜像时使用一个新的 Dockerfile 文件（例如 Dockerfile.buildkit）</p>\n</blockquote>\n<p>目前，Docker Hub 自动构建已经支持 buildkit，具体请参考 <a href="https://github.com/docker-practice/docker-hub-buildx" target="_blank" rel="nofollow noreferrer noopener">https://github.com/docker-practice/docker-hub-buildx</a></p>\n<h3 id="dockerfile-新增指令详解"><a href="#dockerfile-%E6%96%B0%E5%A2%9E%E6%8C%87%E4%BB%A4%E8%AF%A6%E8%A7%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dockerfile 新增指令详解</h3>\n<p>启用 BuildKit 之后，我们可以使用下面几个新的 Dockerfile 指令来加快镜像构建。</p>\n<h4 id="run---mounttypecache"><a href="#run---mounttypecache" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RUN —mount=type=cache</h4>\n<p>目前，几乎所有的程序都会使用依赖管理工具，例如 Go 中的 go mod、Node.js 中的 npm 等等，当我们构建一个镜像时，往往会重复的从互联网中获取依赖包，难以缓存，大大降低了镜像的构建效率。</p>\n<p>例如一个前端工程需要用到 npm：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71186771614391930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM node:alpine as builder\n\nWORKDIR /app\n\nCOPY package.json /app/\n\nRUN npm i --registry=https://registry.npm.taobao.org \\\n        && rm -rf ~/.npm\n\nCOPY src /app/src\n\nRUN npm run build\n\nFROM nginx:alpine\n\nCOPY --from=builder /app/dist /app/dist`, `71186771614391930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>alpine as builder\n\n<span class="token keyword">WORKDIR</span> /app\n\n<span class="token keyword">COPY</span> package.json /app/\n\n<span class="token keyword">RUN</span> npm i <span class="token punctuation">-</span><span class="token punctuation">-</span>registry=https<span class="token punctuation">:</span>//registry.npm.taobao.org \\\n        &amp;&amp; rm <span class="token punctuation">-</span>rf ~/.npm\n\n<span class="token keyword">COPY</span> src /app/src\n\n<span class="token keyword">RUN</span> npm run build\n\n<span class="token keyword">FROM</span> nginx<span class="token punctuation">:</span>alpine\n\n<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>from=builder /app/dist /app/dist</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用多阶段构建，构建的镜像中只包含了目标文件夹 dist，但仍然存在一些问题，当 package.json 文件变动时，<code class="language-text">RUN npm i &amp;&amp; rm -rf ~/.npm</code> 这一层会重新执行，变更多次后，生成了大量的中间层镜像。</p>\n<p>为解决这个问题，进一步的我们可以设想一个类似数据卷的功能，在镜像构建时把 <code class="language-text">node_modules</code> 文件夹挂载上去，在构建完成后，这个 <code class="language-text">node_modules</code> 文件夹会自动卸载，实际的镜像中并不包含 <code class="language-text">node_modules</code> 这个文件夹，这样我们就省去了每次获取依赖的时间，大大增加了镜像构建效率，同时也避免了生成了大量的中间层镜像。</p>\n<p>BuildKit 提供了 <code class="language-text">RUN --mount=type=cache</code> 指令，可以实现上边的设想。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45505772613112906000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# syntax = docker/dockerfile:experimental\nFROM node:alpine as builder\n\nWORKDIR /app\n\nCOPY package.json /app/\n\nRUN --mount=type=cache,target=/app/node_modules,id=my_app_npm_module,sharing=locked \\\n    --mount=type=cache,target=/root/.npm,id=npm_cache \\\n        npm i --registry=https://registry.npm.taobao.org\n\nCOPY src /app/src\n\nRUN --mount=type=cache,target=/app/node_modules,id=my_app_npm_module,sharing=locked \\\n# --mount=type=cache,target=/app/dist,id=my_app_dist,sharing=locked \\\n        npm run build\n\nFROM nginx:alpine\n\n# COPY --from=builder /app/dist /app/dist\n\n# 为了更直观的说明 from 和 source 指令，这里使用 RUN 指令\nRUN --mount=type=cache,target=/tmp/dist,from=builder,source=/app/dist \\\n    # --mount=type=cache,target/tmp/dist,from=my_app_dist,sharing=locked \\\n    mkdir -p /app/dist && cp -r /tmp/dist/* /app/dist`, `45505772613112906000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># syntax = docker/dockerfile:experimental</span>\n<span class="token keyword">FROM</span> node<span class="token punctuation">:</span>alpine as builder\n\n<span class="token keyword">WORKDIR</span> /app\n\n<span class="token keyword">COPY</span> package.json /app/\n\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=/app/node_modules<span class="token punctuation">,</span>id=my_app_npm_module<span class="token punctuation">,</span>sharing=locked \\\n    <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=/root/.npm<span class="token punctuation">,</span>id=npm_cache \\\n        npm i <span class="token punctuation">-</span><span class="token punctuation">-</span>registry=https<span class="token punctuation">:</span>//registry.npm.taobao.org\n\n<span class="token keyword">COPY</span> src /app/src\n\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=/app/node_modules<span class="token punctuation">,</span>id=my_app_npm_module<span class="token punctuation">,</span>sharing=locked \\\n<span class="token comment"># --mount=type=cache,target=/app/dist,id=my_app_dist,sharing=locked \\</span>\n        npm run build\n\n<span class="token keyword">FROM</span> nginx<span class="token punctuation">:</span>alpine\n\n<span class="token comment"># COPY --from=builder /app/dist /app/dist</span>\n\n<span class="token comment"># 为了更直观的说明 from 和 source 指令，这里使用 RUN 指令</span>\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=/tmp/dist<span class="token punctuation">,</span>from=builder<span class="token punctuation">,</span>source=/app/dist \\\n    <span class="token comment"># --mount=type=cache,target/tmp/dist,from=my_app_dist,sharing=locked \\</span>\n    mkdir <span class="token punctuation">-</span>p /app/dist &amp;&amp; cp <span class="token punctuation">-</span>r /tmp/dist/* /app/dist</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>由于 BuildKit 为实验特性，每个 Dockerfile 文件开头都必须加上如下指令</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46728423007371480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# syntax = docker/dockerfile:experimental`, `46728423007371480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># syntax = docker/dockerfile:experimental</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>第一个 RUN 指令执行后，id 为 <code class="language-text">my_app_npm_module</code> 的缓存文件夹挂载到了 <code class="language-text">/app/node_modules</code> 文件夹中。多次执行也不会产生多个中间层镜像。</p>\n<p>第二个 RUN 指令执行时需要用到 <code class="language-text">node_modules</code> 文件夹，<code class="language-text">node_modules</code> 已经挂载，命令也可以正确执行。</p>\n<p>第三个 RUN 指令将上一阶段产生的文件复制到指定位置，from 指明缓存的来源，这里 builder 表示缓存来源于构建的第一阶段，source 指明缓存来源的文件夹。</p>\n<p>上面的 Dockerfile 中 <code class="language-text">--mount=type=cache,...</code> 中指令作用如下：</p>\n<table>\n<thead>\n<tr>\n<th align="left">Option</th>\n<th align="left">Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">id</td>\n<td align="left">id 设置一个标志，以便区分缓存。</td>\n</tr>\n<tr>\n<td align="left">target(必填项)</td>\n<td align="left">缓存的挂载目标文件夹。</td>\n</tr>\n<tr>\n<td align="left">ro,readonly</td>\n<td align="left">只读，缓存文件夹不能被写入。</td>\n</tr>\n<tr>\n<td align="left">sharing</td>\n<td align="left">有 shared private locked 值可供选择。sharing 设置当一个缓存被多次使用时的表现，由于 BuildKit 支持并行构建，当多个步骤使用同一缓存时（同一 id）会发生冲突。shared 表示多个步骤可以同时读写，private 表示当多个步骤使用同一缓存时，每个步骤使用不同的缓存，locked 表示当一个步骤完成释放缓存后，后一个步骤才能继续使用该缓存。</td>\n</tr>\n<tr>\n<td align="left">from</td>\n<td align="left">缓存来源（构建阶段），不填写时为空文件夹。</td>\n</tr>\n<tr>\n<td align="left">source</td>\n<td align="left">来源的文件夹路径。</td>\n</tr>\n</tbody>\n</table>\n<h4 id="run---mounttypebind"><a href="#run---mounttypebind" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RUN —mount=type=bind</h4>\n<p>该指令可以将一个镜像（或上一构建阶段）的文件挂载到指定位置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50042885782007730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# syntax = docker/dockerfile:experimental\n\nRUN --mount=type=bind,from=php:alpine,source=/usr/local/bin/docker-php-entrypoint,target=/docker-php-entrypoint \\\n        cat /docker-php-entrypoint`, `50042885782007730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># syntax = docker/dockerfile:experimental</span>\n\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=bind<span class="token punctuation">,</span>from=php<span class="token punctuation">:</span>alpine<span class="token punctuation">,</span>source=/usr/local/bin/docker<span class="token punctuation">-</span>php<span class="token punctuation">-</span>entrypoint<span class="token punctuation">,</span>target=/docker<span class="token punctuation">-</span>php<span class="token punctuation">-</span>entrypoint \\\n        cat /docker<span class="token punctuation">-</span>php<span class="token punctuation">-</span>entrypoint</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="run---mounttypetmpfs"><a href="#run---mounttypetmpfs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RUN —mount=type=tmpfs</h4>\n<p>该指令可以将一个 tmpfs 文件系统挂载到指定位置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18180499793660520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# syntax = docker/dockerfile:experimental\n\nRUN --mount=type=tmpfs,target=/temp \\\n        mount | grep /temp`, `18180499793660520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># syntax = docker/dockerfile:experimental</span>\n\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=tmpfs<span class="token punctuation">,</span>target=/temp \\\n        mount <span class="token punctuation">|</span> grep /temp</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="run---mounttypesecret"><a href="#run---mounttypesecret" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RUN —mount=type=secret</h4>\n<p>该指令可以将一个文件（例如密钥）挂载到指定位置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63099872387231760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# syntax = docker/dockerfile:experimental\n\nRUN --mount=type=secret,id=aws,target=/root/.aws/credentials \\\n        cat /root/.aws/credentials\n\n\\$ docker build -t test --secret id=aws,src=\\$HOME/.aws/credentials .`, `63099872387231760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># syntax = docker/dockerfile:experimental</span>\n\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=secret<span class="token punctuation">,</span>id=aws<span class="token punctuation">,</span>target=/root/.aws/credentials \\\n        cat /root/.aws/credentials\n\n$ docker build <span class="token punctuation">-</span>t test <span class="token punctuation">-</span><span class="token punctuation">-</span>secret id=aws<span class="token punctuation">,</span>src=$HOME/.aws/credentials .</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="run---mounttypessh"><a href="#run---mounttypessh" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RUN —mount=type=ssh</h4>\n<p>该指令可以挂载 ssh 密钥。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4333918008867931600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# syntax = docker/dockerfile:experimental\n\nFROM alpine\nRUN apk add --no-cache openssh-client\nRUN mkdir -p -m 0700 ~/.ssh && ssh-keyscan gitlab.com >> ~/.ssh/known_hosts\nRUN --mount=type=ssh ssh git@gitlab.com | tee /hello`, `4333918008867931600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># syntax = docker/dockerfile:experimental</span>\n\n<span class="token keyword">FROM</span> alpine\n<span class="token keyword">RUN</span> apk add <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>cache openssh<span class="token punctuation">-</span>client\n<span class="token keyword">RUN</span> mkdir <span class="token punctuation">-</span>p <span class="token punctuation">-</span>m 0700 ~/.ssh &amp;&amp; ssh<span class="token punctuation">-</span>keyscan gitlab.com <span class="token punctuation">></span><span class="token punctuation">></span> ~/.ssh/known_hosts\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=ssh ssh git@gitlab.com <span class="token punctuation">|</span> tee /hello</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73743024364098716000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ eval \\$(ssh-agent)\n\\$ ssh-add ~/.ssh/id_rsa\n(Input your passphrase here)\n\\$ docker build -t test --ssh default=\\$SSH_AUTH_SOCK .`, `73743024364098716000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token builtin class-name">eval</span> <span class="token variable"><span class="token variable">$(</span>ssh-agent<span class="token variable">)</span></span>\n$ ssh-add ~/.ssh/id_rsa\n<span class="token punctuation">(</span>Input your passphrase here<span class="token punctuation">)</span>\n$ docker build -t <span class="token builtin class-name">test</span> --ssh <span class="token assign-left variable">default</span><span class="token operator">=</span><span class="token environment constant">$SSH_AUTH_SOCK</span> <span class="token builtin class-name">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="使用-buildx-构建镜像"><a href="#%E4%BD%BF%E7%94%A8-buildx-%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 Buildx 构建镜像</h2>\n<h3 id="使用"><a href="#%E4%BD%BF%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用</h3>\n<p>你可以直接使用 docker buildx build 命令构建镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7021476328931375000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker buildx build .\n[+] Building 8.4s (23/32)\n => ...`, `7021476328931375000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker buildx build <span class="token builtin class-name">.</span>\n<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Building <span class="token number">8</span>.4s <span class="token punctuation">(</span><span class="token number">23</span>/32<span class="token punctuation">)</span>\n <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">..</span>.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>Buildx 使用 BuildKit 引擎 进行构建，支持许多新的功能，具体参考 Buildkit 一节。</p>\n<h3 id="官方文档"><a href="#%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>官方文档</h3>\n<p><a href="https://docs.docker.com/engine/reference/commandline/buildx/" target="_blank" rel="nofollow noreferrer noopener">https://docs.docker.com/engine/reference/commandline/buildx/</a></p>\n<h2 id="使用-buildx-构建多种系统架构支持的-docker-镜像"><a href="#%E4%BD%BF%E7%94%A8-buildx-%E6%9E%84%E5%BB%BA%E5%A4%9A%E7%A7%8D%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E6%94%AF%E6%8C%81%E7%9A%84-docker-%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 buildx 构建多种系统架构支持的 Docker 镜像</h2>\n<p>在之前的版本中构建多种系统架构支持的 Docker 镜像，要想使用统一的名字必须使用 <code class="language-text">$ docker manifest</code> 命令。</p>\n<p>在 Docker 19.03+ 版本中可以使用 <code class="language-text">$ docker buildx build</code> 命令使用 BuildKit 构建镜像。该命令支持 <code class="language-text">--platform</code> 参数可以同时构建支持多种系统架构的 Docker 镜像，大大简化了构建步骤。</p>\n<h3 id="新建-builder-实例"><a href="#%E6%96%B0%E5%BB%BA-builder-%E5%AE%9E%E4%BE%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>新建 builder 实例</h3>\n<p>Docker for Linux 不支持构建 arm 架构镜像，我们可以运行一个新的容器让其支持该特性，Docker 桌面版无需进行此项设置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17889584903212708000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run --rm --privileged tonistiigi/binfmt:latest --install all`, `17889584903212708000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run --rm --privileged tonistiigi/binfmt:latest --install all</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>由于 Docker 默认的 builder 实例不支持同时指定多个 <code class="language-text">--platform</code>，我们必须首先创建一个新的 builder 实例。同时由于国内拉取镜像较缓慢，我们可以使用配置了<a href="https://github.com/moby/buildkit/blob/master/docs/buildkitd.toml.md" target="_blank" rel="nofollow noreferrer noopener">镜像加速地址</a>的 <a href="https://github.com/docker-practice/buildx" target="_blank" rel="nofollow noreferrer noopener">dockerpracticesig/buildkit:master</a> 镜像替换官方镜像。</p>\n<blockquote>\n<p>如果你有私有的镜像加速器，可以基于 <a href="https://github.com/docker-practice/buildx" target="_blank" rel="nofollow noreferrer noopener">https://github.com/docker-practice/buildx</a> 构建自己的 buildkit 镜像并使用它。</p>\n</blockquote>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96379016690153260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 适用于国内环境\n\\$ docker buildx create --use --name=mybuilder-cn --driver docker-container --driver-opt image=dockerpracticesig/buildkit:master\n\n# 适用于腾讯云环境(腾讯云主机、coding.net 持续集成)\n\\$ docker buildx create --use --name=mybuilder-cn --driver docker-container --driver-opt image=dockerpracticesig/buildkit:master-tencent\n\n# \\$ docker buildx create --name mybuilder --driver docker-container\n\n\\$ docker buildx use mybuilder`, `96379016690153260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 适用于国内环境</span>\n$ docker buildx create --use --name<span class="token operator">=</span>mybuilder-cn --driver docker-container --driver-opt <span class="token assign-left variable">image</span><span class="token operator">=</span>dockerpracticesig/buildkit:master\n\n<span class="token comment"># 适用于腾讯云环境(腾讯云主机、coding.net 持续集成)</span>\n$ docker buildx create --use --name<span class="token operator">=</span>mybuilder-cn --driver docker-container --driver-opt <span class="token assign-left variable">image</span><span class="token operator">=</span>dockerpracticesig/buildkit:master-tencent\n\n<span class="token comment"># $ docker buildx create --name mybuilder --driver docker-container</span>\n\n$ docker buildx use mybuilder</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="构建镜像-2"><a href="#%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建镜像</h3>\n<p>新建 Dockerfile 文件。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83895348820833080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM --platform=\\$TARGETPLATFORM alpine\n\nRUN uname -a > /os.txt\n\nCMD cat /os.txt`, `83895348820833080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>platform=$TARGETPLATFORM alpine\n\n<span class="token keyword">RUN</span> uname <span class="token punctuation">-</span>a <span class="token punctuation">></span> /os.txt\n\n<span class="token keyword">CMD</span> cat /os.txt</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 <code class="language-text">$ docker buildx build</code> 命令构建镜像，注意将 <code class="language-text">myusername</code> 替换为自己的 <code class="language-text">Docker Hub</code> 用户名。</p>\n<p><code class="language-text">--push</code> 参数表示将构建好的镜像推送到 Docker 仓库。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33925610410802156000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker buildx build --platform linux/arm,linux/arm64,linux/amd64 -t myusername/hello . --push\n\n# 查看镜像信息\n\\$ docker buildx imagetools inspect myusername/hello`, `33925610410802156000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker buildx build --platform linux/arm,linux/arm64,linux/amd64 -t myusername/hello <span class="token builtin class-name">.</span> --push\n\n<span class="token comment"># 查看镜像信息</span>\n$ docker buildx imagetools inspect myusername/hello</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在不同架构运行该镜像，可以得到该架构的信息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56041320319204080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# arm\n\\$ docker run -it --rm myusername/hello\nLinux buildkitsandbox 4.9.125-linuxkit #1 SMP Fri Sep 7 08:20:28 UTC 2018 armv7l Linux\n\n# arm64\n\\$ docker run -it --rm myusername/hello\nLinux buildkitsandbox 4.9.125-linuxkit #1 SMP Fri Sep 7 08:20:28 UTC 2018 aarch64 Linux\n\n# amd64\n\\$ docker run -it --rm myusername/hello\nLinux buildkitsandbox 4.9.125-linuxkit #1 SMP Fri Sep 7 08:20:28 UTC 2018 x86_64 Linux`, `56041320319204080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># arm</span>\n$ docker run -it --rm myusername/hello\nLinux buildkitsandbox <span class="token number">4.9</span>.125-linuxkit <span class="token comment">#1 SMP Fri Sep 7 08:20:28 UTC 2018 armv7l Linux</span>\n\n<span class="token comment"># arm64</span>\n$ docker run -it --rm myusername/hello\nLinux buildkitsandbox <span class="token number">4.9</span>.125-linuxkit <span class="token comment">#1 SMP Fri Sep 7 08:20:28 UTC 2018 aarch64 Linux</span>\n\n<span class="token comment"># amd64</span>\n$ docker run -it --rm myusername/hello\nLinux buildkitsandbox <span class="token number">4.9</span>.125-linuxkit <span class="token comment">#1 SMP Fri Sep 7 08:20:28 UTC 2018 x86_64 Linux</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="架构相关变量"><a href="#%E6%9E%B6%E6%9E%84%E7%9B%B8%E5%85%B3%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>架构相关变量</h3>\n<p>Dockerfile 支持如下架构相关的变量</p>\n<ul>\n<li>TARGETPLATFORM：构建镜像的目标平台，例如 <code class="language-text">linux/amd64</code>, <code class="language-text">linux/arm/v7</code>, <code class="language-text">windows/amd64</code>。</li>\n<li>TARGETOS：TARGETPLATFORM 的 OS 类型，例如 linux, windows</li>\n<li>TARGETARCH：TARGETPLATFORM 的架构类型，例如 amd64, arm</li>\n<li>TARGETVARIANT：TARGETPLATFORM 的变种，该变量可能为空，例如 v7</li>\n<li>BUILDPLATFORM：构建镜像主机平台，例如 <code class="language-text">linux/amd64</code></li>\n<li>BUILDOS：BUILDPLATFORM 的 OS 类型，例如 linux</li>\n<li>BUILDARCH：BUILDPLATFORM 的架构类型，例如 amd64</li>\n<li>BUILDVARIANT：BUILDPLATFORM 的变种，该变量可能为空，例如 v7</li>\n</ul>\n<h4 id="使用举例"><a href="#%E4%BD%BF%E7%94%A8%E4%B8%BE%E4%BE%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用举例</h4>\n<p>例如我们要构建支持 <code class="language-text">linux/arm/v7</code> 和 <code class="language-text">linux/amd64</code> 两种架构的镜像。假设已经生成了两个平台对应的二进制文件：</p>\n<ul>\n<li>bin/dist-linux-arm</li>\n<li>bin/dist-linux-amd64</li>\n</ul>\n<p>那么 Dockerfile 可以这样书写：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84972186438459600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM scratch\n\n# 使用变量必须申明\nARG TARGETOS\n\nARG TARGETARCH\n\nCOPY bin/dist-\\${TARGETOS}-\\${TARGETARCH} /dist\n\nENTRYPOINT [&quot;dist&quot;]`, `84972186438459600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">FROM scratch\n\n<span class="token comment"># 使用变量必须申明</span>\nARG TARGETOS\n\nARG TARGETARCH\n\nCOPY bin/dist-<span class="token variable">${TARGETOS}</span>-<span class="token variable">${TARGETARCH}</span> /dist\n\nENTRYPOINT <span class="token punctuation">[</span><span class="token string">"dist"</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="podman"><a href="#podman" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>podman</h1>\n<p><a href="https://github.com/containers/podman" target="_blank" rel="nofollow noreferrer noopener">podman</a> 是一个无守护程序与 docker 命令兼容的下一代 Linux 容器工具。</p>\n<h2 id="安装"><a href="#%E5%AE%89%E8%A3%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>安装</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53021034567443644000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo yum -y install podman`, `53021034567443644000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> yum -y <span class="token function">install</span> podman</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="使用-1"><a href="#%E4%BD%BF%E7%94%A8-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用</h2>\n<p>podman 与 docker 命令完全兼容，只需将 docker 替换为 podman 即可，例如运行一个容器：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76071953319744570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# \\$ docker run -d -p 80:80 nginx:alpine\n\n\\$ podman run -d -p 80:80 nginx:alpine`, `76071953319744570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># $ docker run -d -p 80:80 nginx:alpine</span>\n\n$ podman run -d -p <span class="token number">80</span>:80 nginx:alpine</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h1 id="常见问题总结"><a href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>常见问题总结</h1>\n<h2 id="镜像相关"><a href="#%E9%95%9C%E5%83%8F%E7%9B%B8%E5%85%B3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>镜像相关</h2>\n<h3 id="如何批量清理临时镜像文件？"><a href="#%E5%A6%82%E4%BD%95%E6%89%B9%E9%87%8F%E6%B8%85%E7%90%86%E4%B8%B4%E6%97%B6%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何批量清理临时镜像文件？</h3>\n<p>答：可以使用 <code class="language-text">docker image prune</code> 命令。</p>\n<h3 id="如何查看镜像支持的环境变量？"><a href="#%E5%A6%82%E4%BD%95%E6%9F%A5%E7%9C%8B%E9%95%9C%E5%83%8F%E6%94%AF%E6%8C%81%E7%9A%84%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何查看镜像支持的环境变量？</h3>\n<p>答：可以使用 <code class="language-text">docker run IMAGE env</code> 命令。</p>\n<h3 id="本地的镜像文件都存放在哪里？"><a href="#%E6%9C%AC%E5%9C%B0%E7%9A%84%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6%E9%83%BD%E5%AD%98%E6%94%BE%E5%9C%A8%E5%93%AA%E9%87%8C%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>本地的镜像文件都存放在哪里？</h3>\n<p>答：与 Docker 相关的本地资源默认存放在 <code class="language-text">/var/lib/docker/</code> 目录下，以 overlay2 文件系统为例，其中 containers 目录存放容器信息，image 目录存放镜像信息，overlay2 目录下存放具体的镜像层文件。</p>\n<h3 id="构建-docker-镜像应该遵循哪些原则？"><a href="#%E6%9E%84%E5%BB%BA-docker-%E9%95%9C%E5%83%8F%E5%BA%94%E8%AF%A5%E9%81%B5%E5%BE%AA%E5%93%AA%E4%BA%9B%E5%8E%9F%E5%88%99%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建 Docker 镜像应该遵循哪些原则？</h3>\n<p>答：整体原则上，尽量保持镜像功能的明确和内容的精简，要点包括</p>\n<ul>\n<li>尽量选取满足需求但较小的基础系统镜像，例如大部分时候可以选择 alpine 镜像，仅有不足六兆大小；</li>\n<li>清理编译生成文件、安装包的缓存等临时文件；</li>\n<li>安装各个软件时候要指定准确的版本号，并避免引入不需要的依赖；</li>\n<li>从安全角度考虑，应用要尽量使用系统的库和依赖；</li>\n<li>如果安装应用时候需要配置一些特殊的环境变量，在安装后要还原不需要保持的变量值；</li>\n<li>使用 Dockerfile 创建镜像时候要添加 <code class="language-text">.dockerignore</code> 文件或使用干净的工作目录。</li>\n</ul>\n<h3 id="碰到网络问题，无法-pull-镜像，命令行指定-http_proxy-无效？"><a href="#%E7%A2%B0%E5%88%B0%E7%BD%91%E7%BB%9C%E9%97%AE%E9%A2%98%EF%BC%8C%E6%97%A0%E6%B3%95-pull-%E9%95%9C%E5%83%8F%EF%BC%8C%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%8C%87%E5%AE%9A-http_proxy-%E6%97%A0%E6%95%88%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>碰到网络问题，无法 pull 镜像，命令行指定 <code class="language-text">http_proxy</code> 无效？</h3>\n<p>答：在 Docker 配置文件中添加 <code class="language-text">export http_proxy=&quot;http://&lt;PROXY_HOST&gt;:&lt;PROXY_PORT&gt;&quot;</code>，之后重启 Docker 服务即可。</p>\n<h2 id="容器相关"><a href="#%E5%AE%B9%E5%99%A8%E7%9B%B8%E5%85%B3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器相关</h2>\n<h3 id="容器退出后，通过-docker-container-ls-命令查看不到，数据会丢失么？"><a href="#%E5%AE%B9%E5%99%A8%E9%80%80%E5%87%BA%E5%90%8E%EF%BC%8C%E9%80%9A%E8%BF%87-docker-container-ls-%E5%91%BD%E4%BB%A4%E6%9F%A5%E7%9C%8B%E4%B8%8D%E5%88%B0%EF%BC%8C%E6%95%B0%E6%8D%AE%E4%BC%9A%E4%B8%A2%E5%A4%B1%E4%B9%88%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器退出后，通过 <code class="language-text">docker container ls</code> 命令查看不到，数据会丢失么？</h3>\n<p>答：容器退出后会处于终止（exited）状态，此时可以通过 <code class="language-text">docker container ls -a</code> 查看。其中的数据也不会丢失，还可以通过 docker start 命令来启动它。只有删除掉容器才会清除所有数据。</p>\n<h3 id="如何停止所有正在运行的容器？"><a href="#%E5%A6%82%E4%BD%95%E5%81%9C%E6%AD%A2%E6%89%80%E6%9C%89%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E7%9A%84%E5%AE%B9%E5%99%A8%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何停止所有正在运行的容器？</h3>\n<p>答：可以使用 <code class="language-text">docker stop $(docker container ls -q)</code> 命令。</p>\n<h3 id="如何批量清理已经停止的容器？"><a href="#%E5%A6%82%E4%BD%95%E6%89%B9%E9%87%8F%E6%B8%85%E7%90%86%E5%B7%B2%E7%BB%8F%E5%81%9C%E6%AD%A2%E7%9A%84%E5%AE%B9%E5%99%A8%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何批量清理已经停止的容器？</h3>\n<p>答：可以使用 <code class="language-text">docker container prune</code> 命令。</p>\n<h3 id="如何获取某个容器的-pid-信息？"><a href="#%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E6%9F%90%E4%B8%AA%E5%AE%B9%E5%99%A8%E7%9A%84-pid-%E4%BF%A1%E6%81%AF%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何获取某个容器的 PID 信息？</h3>\n<p>答：可以使用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27836978980575556000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker inspect --format \'{{ .State.Pid }}\' <CONTAINER ID or NAME>`, `27836978980575556000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker inspect --format <span class="token string">\'{{ .State.Pid }}\'</span> <span class="token operator">&lt;</span>CONTAINER ID or NAME<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="如何获取某个容器的-ip-地址？"><a href="#%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E6%9F%90%E4%B8%AA%E5%AE%B9%E5%99%A8%E7%9A%84-ip-%E5%9C%B0%E5%9D%80%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何获取某个容器的 IP 地址？</h3>\n<p>答：可以使用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63759194488335830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker inspect --format \'{{ .NetworkSettings.IPAddress }}\' <CONTAINER ID or NAME>`, `63759194488335830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker inspect --format <span class="token string">\'{{ .NetworkSettings.IPAddress }}\'</span> <span class="token operator">&lt;</span>CONTAINER ID or NAME<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="如何给容器指定一个固定-ip-地址，而不是每次重启容器-ip-地址都会变？"><a href="#%E5%A6%82%E4%BD%95%E7%BB%99%E5%AE%B9%E5%99%A8%E6%8C%87%E5%AE%9A%E4%B8%80%E4%B8%AA%E5%9B%BA%E5%AE%9A-ip-%E5%9C%B0%E5%9D%80%EF%BC%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E6%AF%8F%E6%AC%A1%E9%87%8D%E5%90%AF%E5%AE%B9%E5%99%A8-ip-%E5%9C%B0%E5%9D%80%E9%83%BD%E4%BC%9A%E5%8F%98%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何给容器指定一个固定 IP 地址，而不是每次重启容器 IP 地址都会变？</h3>\n<p>答：使用以下命令启动容器可以使容器 IP 固定不变</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97421278226440060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker network create -d bridge --subnet 172.25.0.0/16 my-net\n\n\\$ docker run --network=my-net --ip=172.25.3.3 -itd --name=my-container busybox`, `97421278226440060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker network create -d bridge --subnet <span class="token number">172.25</span>.0.0/16 my-net\n\n$ docker run --network<span class="token operator">=</span>my-net --ip<span class="token operator">=</span><span class="token number">172.25</span>.3.3 -itd --name<span class="token operator">=</span>my-container busybox</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="如何临时退出一个正在交互的容器的终端，而不终止它？"><a href="#%E5%A6%82%E4%BD%95%E4%B8%B4%E6%97%B6%E9%80%80%E5%87%BA%E4%B8%80%E4%B8%AA%E6%AD%A3%E5%9C%A8%E4%BA%A4%E4%BA%92%E7%9A%84%E5%AE%B9%E5%99%A8%E7%9A%84%E7%BB%88%E7%AB%AF%EF%BC%8C%E8%80%8C%E4%B8%8D%E7%BB%88%E6%AD%A2%E5%AE%83%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何临时退出一个正在交互的容器的终端，而不终止它？</h3>\n<p>答：按 <code class="language-text">Ctrl-p</code> <code class="language-text">Ctrl-q</code>。如果按 <code class="language-text">Ctrl-c</code> 往往会让容器内应用进程终止，进而会终止容器。</p>\n<h3 id="使用-docker-port-命令映射容器的端口时，系统报错-error-no-public-port-80-published-for-xxx？"><a href="#%E4%BD%BF%E7%94%A8-docker-port-%E5%91%BD%E4%BB%A4%E6%98%A0%E5%B0%84%E5%AE%B9%E5%99%A8%E7%9A%84%E7%AB%AF%E5%8F%A3%E6%97%B6%EF%BC%8C%E7%B3%BB%E7%BB%9F%E6%8A%A5%E9%94%99-error-no-public-port-80-published-for-xxx%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 docker port 命令映射容器的端口时，系统报错 “Error: No public port ‘80’ published for xxx”？</h3>\n<ul>\n<li>\n<p>创建镜像时 Dockerfile 要通过 EXPOSE 指定正确的开放端口；</p>\n</li>\n<li>\n<p>容器启动时指定 <code class="language-text">PublishAllPort = true</code>。</p>\n</li>\n</ul>\n<h3 id="可以在一个容器中同时运行多个应用进程么？"><a href="#%E5%8F%AF%E4%BB%A5%E5%9C%A8%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A8%E4%B8%AD%E5%90%8C%E6%97%B6%E8%BF%90%E8%A1%8C%E5%A4%9A%E4%B8%AA%E5%BA%94%E7%94%A8%E8%BF%9B%E7%A8%8B%E4%B9%88%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>可以在一个容器中同时运行多个应用进程么？</h3>\n<p>答：一般并不推荐在同一个容器内运行多个应用进程。如果有类似需求，可以通过一些额外的进程管理机制，比如 supervisord 来管理所运行的进程。可以参考 <a href="https://docs.docker.com/config/containers/multi-service_container/" target="_blank" rel="nofollow noreferrer noopener">https://docs.docker.com/config/containers/multi-service_container/</a> 。</p>\n<h3 id="如何控制容器占用系统资源（cpu、内存）的份额？"><a href="#%E5%A6%82%E4%BD%95%E6%8E%A7%E5%88%B6%E5%AE%B9%E5%99%A8%E5%8D%A0%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%B5%84%E6%BA%90%EF%BC%88cpu%E3%80%81%E5%86%85%E5%AD%98%EF%BC%89%E7%9A%84%E4%BB%BD%E9%A2%9D%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何控制容器占用系统资源（CPU、内存）的份额？</h3>\n<p>答：在使用 <code class="language-text">docker create</code> 命令创建容器或使用 <code class="language-text">docker run</code> 创建并启动容器的时候，可以使用 <code class="language-text">-c|--cpu-shares[=0]</code> 参数来调整容器使用 CPU 的权重；使用 <code class="language-text">-m|--memory[=MEMORY]</code> 参数来调整容器使用内存的大小。</p>\n<h2 id="仓库相关"><a href="#%E4%BB%93%E5%BA%93%E7%9B%B8%E5%85%B3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>仓库相关</h2>\n<h3 id="仓库（repository）、注册服务器（registry）、注册索引（index）有何关系？"><a href="#%E4%BB%93%E5%BA%93%EF%BC%88repository%EF%BC%89%E3%80%81%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88registry%EF%BC%89%E3%80%81%E6%B3%A8%E5%86%8C%E7%B4%A2%E5%BC%95%EF%BC%88index%EF%BC%89%E6%9C%89%E4%BD%95%E5%85%B3%E7%B3%BB%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>仓库（Repository）、注册服务器（Registry）、注册索引（Index）有何关系？</h3>\n<p>首先，仓库是存放一组关联镜像的集合，比如同一个应用的不同版本的镜像。</p>\n<p>注册服务器是存放实际的镜像文件的地方。注册索引则负责维护用户的账号、权限、搜索、标签等的管理。因此，注册服务器利用注册索引来实现认证等管理。</p>\n<h2 id="配置相关"><a href="#%E9%85%8D%E7%BD%AE%E7%9B%B8%E5%85%B3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配置相关</h2>\n<h3 id="docker-的配置文件放在哪里，如何修改配置？"><a href="#docker-%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%94%BE%E5%9C%A8%E5%93%AA%E9%87%8C%EF%BC%8C%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 的配置文件放在哪里，如何修改配置？</h3>\n<p>答：使用 systemd 的系统（如 <code class="language-text">Ubuntu 16.04</code>、Centos 等）的配置文件在 <code class="language-text">/etc/docker/daemon.json</code>。</p>\n<h3 id="如何更改-docker-的默认存储位置？"><a href="#%E5%A6%82%E4%BD%95%E6%9B%B4%E6%94%B9-docker-%E7%9A%84%E9%BB%98%E8%AE%A4%E5%AD%98%E5%82%A8%E4%BD%8D%E7%BD%AE%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何更改 Docker 的默认存储位置？</h3>\n<p>答：Docker 的默认存储位置是 <code class="language-text">/var/lib/docker</code>，如果希望将 Docker 的本地文件存储到其他分区，可以使用 Linux 软连接的方式来完成，或者在启动 daemon 时通过 <code class="language-text">-g</code> 参数指定，或者修改配置文件 <code class="language-text">/etc/docker/daemon.json</code> 的 “data-root” 项 。可以使用 <code class="language-text">docker system info | grep &quot;Root Dir&quot;</code> 查看当前使用的存储位置。</p>\n<p>例如，如下操作将默认存储位置迁移到 <code class="language-text">/storage/docker</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26701416460566675000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[root@s26 ~]# df -h\nFilesystem                    Size  Used Avail Use% Mounted on\n/dev/mapper/VolGroup-lv_root   50G  5.3G   42G  12% /\ntmpfs                          48G  228K   48G   1% /dev/shm\n/dev/sda1                     485M   40M  420M   9% /boot\n/dev/mapper/VolGroup-lv_home  222G  188M  210G   1% /home\n/dev/sdb2                     2.7T  323G  2.3T  13% /storage\n[root@s26 ~]# service docker stop\n[root@s26 ~]# cd /var/lib/\n[root@s26 lib]# mv docker /storage/\n[root@s26 lib]# ln -s /storage/docker/ docker\n[root@s26 lib]# ls -la docker\nlrwxrwxrwx. 1 root root 15 11月 17 13:43 docker -> /storage/docker\n[root@s26 lib]# service docker start`, `26701416460566675000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token punctuation">[</span>root@s26 ~<span class="token punctuation">]</span><span class="token comment"># df -h</span>\nFilesystem                    Size  Used Avail Use% Mounted on\n/dev/mapper/VolGroup-lv_root   50G  <span class="token number">5</span>.3G   42G  <span class="token number">12</span>% /\ntmpfs                          48G  228K   48G   <span class="token number">1</span>% /dev/shm\n/dev/sda1                     485M   40M  420M   <span class="token number">9</span>% /boot\n/dev/mapper/VolGroup-lv_home  222G  188M  210G   <span class="token number">1</span>% /home\n/dev/sdb2                     <span class="token number">2</span>.7T  323G  <span class="token number">2</span>.3T  <span class="token number">13</span>% /storage\n<span class="token punctuation">[</span>root@s26 ~<span class="token punctuation">]</span><span class="token comment"># service docker stop</span>\n<span class="token punctuation">[</span>root@s26 ~<span class="token punctuation">]</span><span class="token comment"># cd /var/lib/</span>\n<span class="token punctuation">[</span>root@s26 lib<span class="token punctuation">]</span><span class="token comment"># mv docker /storage/</span>\n<span class="token punctuation">[</span>root@s26 lib<span class="token punctuation">]</span><span class="token comment"># ln -s /storage/docker/ docker</span>\n<span class="token punctuation">[</span>root@s26 lib<span class="token punctuation">]</span><span class="token comment"># ls -la docker</span>\nlrwxrwxrwx. <span class="token number">1</span> root root <span class="token number">15</span> <span class="token number">11</span>月 <span class="token number">17</span> <span class="token number">13</span>:43 docker -<span class="token operator">></span> /storage/docker\n<span class="token punctuation">[</span>root@s26 lib<span class="token punctuation">]</span><span class="token comment"># service docker start</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="使用内存和-swap-限制启动容器时候报警告：warning-your-kernel-does-not-support-cgroup-swap-limit-warning-your-kernel-does-not-support-swap-limit-capabilities-limitation-discarded？"><a href="#%E4%BD%BF%E7%94%A8%E5%86%85%E5%AD%98%E5%92%8C-swap-%E9%99%90%E5%88%B6%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8%E6%97%B6%E5%80%99%E6%8A%A5%E8%AD%A6%E5%91%8A%EF%BC%9Awarning-your-kernel-does-not-support-cgroup-swap-limit-warning-your-kernel-does-not-support-swap-limit-capabilities-limitation-discarded%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用内存和 swap 限制启动容器时候报警告：“WARNING: Your kernel does not support cgroup swap limit. WARNING: Your kernel does not support swap limit capabilities. Limitation discarded.“？</h3>\n<p>答：这是因为系统默认没有开启对内存和 swap 使用的统计功能，引入该功能会带来性能的下降。要开启该功能，可以采取如下操作：</p>\n<ul>\n<li>编辑 <code class="language-text">/etc/default/grub</code> 文件（Ubuntu 系统为例），配置 <code class="language-text">GRUB_CMDLINE_LINUX=&quot;cgroup_enable=memory swapaccount=1&quot;</code></li>\n<li>更新 grub：<code class="language-text">$ sudo update-grub</code></li>\n<li>重启系统，即可。</li>\n</ul>\n<h2 id="docker-与虚拟化"><a href="#docker-%E4%B8%8E%E8%99%9A%E6%8B%9F%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 与虚拟化</h2>\n<h3 id="docker-与-lxc（linux-container）有何不同？"><a href="#docker-%E4%B8%8E-lxc%EF%BC%88linux-container%EF%BC%89%E6%9C%89%E4%BD%95%E4%B8%8D%E5%90%8C%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 与 LXC（Linux Container）有何不同？</h3>\n<p>答：LXC 利用 Linux 上相关技术实现了容器。Docker 则在如下的几个方面进行了改进：</p>\n<ul>\n<li>移植性：通过抽象容器配置，容器可以实现从一个平台移植到另一个平台；</li>\n<li>镜像系统：基于 OverlayFS 的镜像系统为容器的分发带来了很多的便利，同时共同的镜像层只需要存储一份，实现高效率的存储；</li>\n<li>版本管理：类似于 Git 的版本管理理念，用户可以更方便的创建、管理镜像文件；</li>\n<li>仓库系统：仓库系统大大降低了镜像的分发和管理的成本；</li>\n<li>周边工具：各种现有工具（配置管理、云平台）对 Docker 的支持，以及基于 Docker 的 PaaS、CI 等系统，让 Docker 的应用更加方便和多样化。</li>\n</ul>\n<h3 id="docker-与-vagrant-有何不同？"><a href="#docker-%E4%B8%8E-vagrant-%E6%9C%89%E4%BD%95%E4%B8%8D%E5%90%8C%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 与 Vagrant 有何不同？</h3>\n<p>答：两者的定位完全不同。</p>\n<ul>\n<li>Vagrant 类似 Boot2Docker（一款运行 Docker 的最小内核），是一套虚拟机的管理环境。Vagrant 可以在多种系统上和虚拟机软件中运行，可以在 Windows，Mac 等非 Linux 平台上为 Docker 提供支持，自身具有较好的包装性和移植性。</li>\n<li>原生的 Docker 自身只能运行在 Linux 平台上，但启动和运行的性能都比虚拟机要快，往往更适合快速开发和部署应用的场景。</li>\n</ul>\n<p>简单说：Vagrant 适合用来管理虚拟机，而 Docker 适合用来管理应用环境。</p>\n<h3 id="开发环境中-docker-和-vagrant-该如何选择？"><a href="#%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E4%B8%AD-docker-%E5%92%8C-vagrant-%E8%AF%A5%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>开发环境中 Docker 和 Vagrant 该如何选择？</h3>\n<p>答：Docker 不是虚拟机，而是进程隔离，对于资源的消耗很少，但是目前需要 Linux 环境支持。Vagrant 是虚拟机上做的封装，虚拟机本身会消耗资源。</p>\n<p>如果本地使用的 Linux 环境，推荐都使用 Docker。</p>\n<p>如果本地使用的是 macOS 或者 Windows 环境，那就需要开虚拟机，单一开发环境下 Vagrant 更简单；多环境开发下推荐在 Vagrant 里面再使用 Docker 进行环境隔离。</p>\n<h2 id="其它"><a href="#%E5%85%B6%E5%AE%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其它</h2>\n<h3 id="docker-能在非-linux-平台（比如-windows-或-macos-）上运行么？"><a href="#docker-%E8%83%BD%E5%9C%A8%E9%9D%9E-linux-%E5%B9%B3%E5%8F%B0%EF%BC%88%E6%AF%94%E5%A6%82-windows-%E6%88%96-macos-%EF%BC%89%E4%B8%8A%E8%BF%90%E8%A1%8C%E4%B9%88%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 能在非 Linux 平台（比如 Windows 或 macOS ）上运行么？</h3>\n<p>答：完全可以。</p>\n<h3 id="如何将一台宿主主机的-docker-环境迁移到另外一台宿主主机？"><a href="#%E5%A6%82%E4%BD%95%E5%B0%86%E4%B8%80%E5%8F%B0%E5%AE%BF%E4%B8%BB%E4%B8%BB%E6%9C%BA%E7%9A%84-docker-%E7%8E%AF%E5%A2%83%E8%BF%81%E7%A7%BB%E5%88%B0%E5%8F%A6%E5%A4%96%E4%B8%80%E5%8F%B0%E5%AE%BF%E4%B8%BB%E4%B8%BB%E6%9C%BA%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何将一台宿主主机的 Docker 环境迁移到另外一台宿主主机？</h3>\n<p>答：停止 Docker 服务。将整个 Docker 存储文件夹复制到另外一台宿主主机，然后调整另外一台宿主主机的配置即可。</p>\n<h3 id="如何进入-docker-容器的网络命名空间？"><a href="#%E5%A6%82%E4%BD%95%E8%BF%9B%E5%85%A5-docker-%E5%AE%B9%E5%99%A8%E7%9A%84%E7%BD%91%E7%BB%9C%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何进入 Docker 容器的网络命名空间？</h3>\n<p>答：Docker 在创建容器后，删除了宿主主机上 <code class="language-text">/var/run/netns</code> 目录中的相关的网络命名空间文件。因此，在宿主主机上是无法看到或访问容器的网络命名空间的。</p>\n<p>用户可以通过如下方法来手动恢复它。</p>\n<p>首先，使用下面的命令查看容器进程信息，比如这里的 1234。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61852302471429235000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker inspect --format=\'{{. State.Pid}}\' \\$container_id\n1234`, `61852302471429235000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker inspect --format<span class="token operator">=</span><span class="token string">\'{{. State.Pid}}\'</span> <span class="token variable">$container_id</span>\n<span class="token number">1234</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>接下来，在 <code class="language-text">/proc</code> 目录下，把对应的网络命名空间文件链接到 <code class="language-text">/var/run/netns</code> 目录。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49598320233844940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo ln -s /proc/1234/ns/net /var/run/netns/`, `49598320233844940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">ln</span> -s /proc/1234/ns/net /var/run/netns/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后，在宿主主机上就可以看到容器的网络命名空间信息。例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80362916979182880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo ip netns show\n1234`, `80362916979182880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">ip</span> netns show\n<span class="token number">1234</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>此时，用户可以通过正常的系统命令来查看或操作容器的命名空间了。例如修改容器的 IP 地址信息为 <code class="language-text">172.17.0.100/16</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23867161050962895000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo ip netns exec 1234 ifconfig eth0 172.17.0.100/16`, `23867161050962895000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token number">1234</span> <span class="token function">ifconfig</span> eth0 <span class="token number">172.17</span>.0.100/16</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="如何获取容器绑定到本地那个-veth-接口上？"><a href="#%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E5%AE%B9%E5%99%A8%E7%BB%91%E5%AE%9A%E5%88%B0%E6%9C%AC%E5%9C%B0%E9%82%A3%E4%B8%AA-veth-%E6%8E%A5%E5%8F%A3%E4%B8%8A%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何获取容器绑定到本地那个 veth 接口上？</h3>\n<p>答：Docker 容器启动后，会通过 veth 接口对连接到本地网桥，veth 接口命名跟容器命名毫无关系，十分难以找到对应关系。</p>\n<p>最简单的一种方式是通过查看接口的索引号，在容器中执行 <code class="language-text">ip a</code> 命令，查看到本地接口最前面的接口索引号，如 205，将此值加上 1，即 206，然后在本地主机执行 <code class="language-text">ip a</code> 命令，查找接口索引号为 206 的接口，两者即为连接的 veth 接口对。</p>\n<h1 id="docker-命令"><a href="#docker-%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 命令</h1>\n<p>Docker 命令有两大类，客户端命令和服务端命令。前者是主要的操作接口，后者用来启动 Docker Daemon。</p>\n<ul>\n<li>客户端命令：基本命令格式为 <code class="language-text">docker [OPTIONS] COMMAND [arg...]</code>；</li>\n<li>服务端命令：基本命令格式为 <code class="language-text">dockerd [OPTIONS]</code>。</li>\n</ul>\n<p>可以通过 <code class="language-text">man docker</code> 或 <code class="language-text">docker help</code> 来查看这些命令。</p>\n<h2 id="客户端命令docker"><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4docker" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>客户端命令(docker)</h2>\n<h3 id="客户端命令选项"><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4%E9%80%89%E9%A1%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>客户端命令选项</h3>\n<ul>\n<li><code class="language-text">--config=&quot;&quot;</code>：指定客户端配置文件，默认为 <code class="language-text">~/.docker</code>；</li>\n<li><code class="language-text">-D=true|false</code>：是否使用 debug 模式。默认不开启；</li>\n<li><code class="language-text">-H, --host=[]</code>：指定命令对应 Docker 守护进程的监听接口，可以为 unix 套接字 <code class="language-text">unix:///path/to/socket</code>，文件句柄 <code class="language-text">fd://socketfd</code> 或 tcp 套接字 <code class="language-text">tcp://[host[:port]]</code>，默认为 <code class="language-text">unix:///var/run/docker.sock</code>；</li>\n<li><code class="language-text">-l, --log-level=&quot;debug|info|warn|error|fatal&quot;</code>：指定日志输出级别；</li>\n<li><code class="language-text">--tls=true|false</code>：是否对 Docker 守护进程启用 TLS 安全机制，默认为否；</li>\n<li><code class="language-text">--tlscacert=/.docker/ca.pem</code>：TLS CA 签名的可信证书文件路径；</li>\n<li><code class="language-text">--tlscert=/.docker/cert.pem</code>：TLS 可信证书文件路径；</li>\n<li><code class="language-text">--tlscert=/.docker/key.pem</code>：TLS 密钥文件路径；</li>\n<li><code class="language-text">--tlsverify=true|false</code>：启用 TLS 校验，默认为否。</li>\n</ul>\n<h3 id="客户端命令"><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>客户端命令</h3>\n<p>可以通过 <code class="language-text">docker COMMAND --help</code> 来查看这些命令的具体用法。</p>\n<ul>\n<li>attach：依附到一个正在运行的容器中；</li>\n<li>build：从一个 Dockerfile 创建一个镜像；</li>\n<li>commit：从一个容器的修改中创建一个新的镜像；</li>\n<li>cp：在容器和本地宿主系统之间复制文件中；</li>\n<li>create：创建一个新容器，但并不运行它；</li>\n<li>diff：检查一个容器内文件系统的修改，包括修改和增加；</li>\n<li>events：从服务端获取实时的事件；</li>\n<li>exec：在运行的容器内执行命令；</li>\n<li>export：导出容器内容为一个 tar 包；</li>\n<li>history：显示一个镜像的历史信息；</li>\n<li>images：列出存在的镜像；</li>\n<li>import：导入一个文件（典型为 tar 包）路径或目录来创建一个本地镜像；</li>\n<li>info：显示一些相关的系统信息；</li>\n<li>inspect：显示一个容器的具体配置信息；</li>\n<li>kill：关闭一个运行中的容器 (包括进程和所有相关资源)；</li>\n<li>load：从一个 tar 包中加载一个镜像；</li>\n<li>login：注册或登录到一个 Docker 的仓库服务器；</li>\n<li>logout：从 Docker 的仓库服务器登出；</li>\n<li>logs：获取容器的 log 信息；</li>\n<li>network：管理 Docker 的网络，包括查看、创建、删除、挂载、卸载等；</li>\n<li>node：管理 swarm 集群中的节点，包括查看、更新、删除、提升/取消管理节点等；</li>\n<li>pause：暂停一个容器中的所有进程；</li>\n<li>port：查找一个 nat 到一个私有网口的公共口；</li>\n<li>ps：列出主机上的容器；</li>\n<li>pull：从一个 Docker 的仓库服务器下拉一个镜像或仓库；</li>\n<li>push：将一个镜像或者仓库推送到一个 Docker 的注册服务器；</li>\n<li>rename：重命名一个容器；</li>\n<li>restart：重启一个运行中的容器；</li>\n<li>rm：删除给定的若干个容器；</li>\n<li>rmi：删除给定的若干个镜像；</li>\n<li>run：创建一个新容器，并在其中运行给定命令；</li>\n<li>save：保存一个镜像为 tar 包文件；</li>\n<li>search：在 Docker index 中搜索一个镜像；</li>\n<li>service：管理 Docker 所启动的应用服务，包括创建、更新、删除等；</li>\n<li>start：启动一个容器；</li>\n<li>stats：输出（一个或多个）容器的资源使用统计信息；</li>\n<li>stop：终止一个运行中的容器；</li>\n<li>swarm：管理 Docker swarm 集群，包括创建、加入、退出、更新等；</li>\n<li>tag：为一个镜像打标签；</li>\n<li>top：查看一个容器中的正在运行的进程信息；</li>\n<li>unpause：将一个容器内所有的进程从暂停状态中恢复；</li>\n<li>update：更新指定的若干容器的配置信息；</li>\n<li>version：输出 Docker 的版本信息；</li>\n<li>volume：管理 Docker volume，包括查看、创建、删除等；</li>\n<li>wait：阻塞直到一个容器终止，然后输出它的退出符。</li>\n</ul>\n<h3 id="一张图总结-docker-的命令"><a href="#%E4%B8%80%E5%BC%A0%E5%9B%BE%E6%80%BB%E7%BB%93-docker-%E7%9A%84%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一张图总结 Docker 的命令</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-20-14-15-18-6a07fce065941fb650ecfc12354bb03b-95179.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 95%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAIAAAAf7rriAAAACXBIWXMAAAsSAAALEgHS3X78AAACh0lEQVQ4y5VUvW7UQBD2S/EKFLwALW9ARRdRICEh0VBRQQQtNUJEoUAhCaCg5EiU5Mzpcpf7sX3ntfd/7f2zGdvK5YBrGFmrsXe+mdlvvnWQITSdTPr90DlX/6cFK6+qqnXfe1/dmG/t37CgWrPVtjHGWiulVEoVRcEoI4RsAK88iIZQCBKcE4wZawCAT9EySRJKKQTACjGbwTjPM4zj8ej69EQoJaXIsrw3OBqMfkFxsAylQogNYGg1DEPWGqSnrUHNOI4IwdAFF5Kmc8Wyrv2/KwO+4xzACCGtNXyBFV67jEJwCLqtDNQUrakbA7/LAgzDAg6kLUu9illxFiTxbHw1TJLFxkmuT2HdIJvRRWBN0R2g61wbDXVuAa1DwzeTzw/Toy1Xom7DeysFac6c5/ll/4Jymuf49KwXxfN220Pz0Kl1lQpfLT49YN8eVWW+YgsKgEh8WRQAW1K5pCrLMcwWkEA1Qin4XReYSWMbLr2xivKSSWddADTAMNKcMO3hwbyhBWjuRsUZM7Yyl09n7++yvfuKXpNrdL5zcLXX01R28vTa+lxaJDRXxlnDOQdpNweuGkmbaDc7fsEvthVH/paNKjDWdEoEMaUpoiAlzgil8Txappmta+etrusUWjJOSMFTTKYLFiFXmgDmN52NkngOzUfRbLGYDwahEBKKLrN8ME9kWVa1B2HqssSUoOFs8vVsfnRpuAqgveEUHf4cf79IfvSj/eNhOF5UNxcQGMGYAKFKpE7TopB+7fI1ozrojZ9v7z57e/jk9f7jlx8/HAzWbl8Tyk+2Ru/upDv3vIqa795BdqPLAJTrnW0iCpdSo90ff4LWqR0+N7NdE39xpugKg7yUJL8BbOM6W57Sp9wAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 20 14 15 18" title="" data-src="/static/2022-07-20-14-15-18-6a07fce065941fb650ecfc12354bb03b-fee1c.png" data-srcset="/static/2022-07-20-14-15-18-6a07fce065941fb650ecfc12354bb03b-a67b7.png 200w,\n/static/2022-07-20-14-15-18-6a07fce065941fb650ecfc12354bb03b-0b187.png 400w,\n/static/2022-07-20-14-15-18-6a07fce065941fb650ecfc12354bb03b-fee1c.png 800w,\n/static/2022-07-20-14-15-18-6a07fce065941fb650ecfc12354bb03b-b1a91.png 1200w,\n/static/2022-07-20-14-15-18-6a07fce065941fb650ecfc12354bb03b-95179.png 1600w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="服务端命令dockerd"><a href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%91%BD%E4%BB%A4dockerd" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务端命令(dockerd)</h2>\n<h3 id="dockerd-命令选项"><a href="#dockerd-%E5%91%BD%E4%BB%A4%E9%80%89%E9%A1%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dockerd 命令选项</h3>\n<ul>\n<li><code class="language-text">--api-cors-header=&quot;&quot;</code>：CORS 头部域，默认不允许 CORS，要允许任意的跨域访问，可以指定为 ”*“；</li>\n<li><code class="language-text">--authorization-plugin=&quot;&quot;</code>：载入认证的插件；</li>\n<li><code class="language-text">-b=&quot;&quot;</code>：将容器挂载到一个已存在的网桥上。指定为 none 时则禁用容器的网络，与 <code class="language-text">--bip</code> 选项互斥；</li>\n<li><code class="language-text">--bip=&quot;&quot;</code>：让动态创建的 docker0 网桥采用给定的 CIDR 地址; 与 <code class="language-text">-b</code> 选项互斥；</li>\n<li><code class="language-text">--cgroup-parent=&quot;&quot;</code>：指定 cgroup 的父组，默认 fs cgroup 驱动为 <code class="language-text">/docker</code>，systemd cgroup 驱动为 <code class="language-text">system.slice</code>；</li>\n<li><code class="language-text">--cluster-store=&quot;&quot;</code>：构成集群（如 Swarm）时，集群键值数据库服务地址；</li>\n<li><code class="language-text">--cluster-advertise=&quot;&quot;</code>：构成集群时，自身的被访问地址，可以为 <code class="language-text">host:port</code> 或 <code class="language-text">interface:port</code>；</li>\n<li><code class="language-text">--cluster-store-opt=&quot;&quot;</code>：构成集群时，键值数据库的配置选项；</li>\n<li><code class="language-text">--config-file=&quot;/etc/docker/daemon.json&quot;</code>：daemon 配置文件路径；</li>\n<li><code class="language-text">--containerd=&quot;&quot;</code>：containerd 文件的路径；</li>\n<li><code class="language-text">-D, --debug=true|false</code>：是否使用 Debug 模式。缺省为 false；</li>\n<li><code class="language-text">--default-gateway=&quot;&quot;</code>：容器的 IPv4 网关地址，必须在网桥的子网段内；</li>\n<li><code class="language-text">--default-gateway-v6=&quot;&quot;</code>：容器的 IPv6 网关地址；</li>\n<li><code class="language-text">--default-ulimit=[]</code>：默认的 ulimit 值；</li>\n<li><code class="language-text">--disable-legacy-registry=true|false</code>：是否允许访问旧版本的镜像仓库服务器；</li>\n<li><code class="language-text">--dns=&quot;&quot;</code>：指定容器使用的 DNS 服务器地址；</li>\n<li><code class="language-text">--dns-opt=&quot;&quot;</code>：DNS 选项；</li>\n<li><code class="language-text">--dns-search=[]</code>：DNS 搜索域；</li>\n<li><code class="language-text">--exec-opt=[]</code>：运行时的执行选项；</li>\n<li><code class="language-text">--exec-root=&quot;&quot;</code>：容器执行状态文件的根路径，默认为 <code class="language-text">/var/run/docker</code>；</li>\n<li><code class="language-text">--fixed-cidr=&quot;&quot;</code>：限定分配 IPv4 地址范围；</li>\n<li><code class="language-text">--fixed-cidr-v6=&quot;&quot;</code>：限定分配 IPv6 地址范围；</li>\n<li><code class="language-text">-G, --group=&quot;&quot;</code>：分配给 unix 套接字的组，默认为 docker；</li>\n<li><code class="language-text">-g, --graph=&quot;&quot;</code>：Docker 运行时的根路径，默认为 <code class="language-text">/var/lib/docker</code>；</li>\n<li><code class="language-text">-H, --host=[]</code>：指定命令对应 Docker daemon 的监听接口，可以为 unix 套接字 <code class="language-text">unix:///path/to/socket</code>，文件句柄 <code class="language-text">fd://socketfd</code> 或 tcp 套接字 <code class="language-text">tcp://[host[:port]]</code>，默认为 <code class="language-text">unix:///var/run/docker.sock</code>；</li>\n<li><code class="language-text">--icc=true|false</code>：是否启用容器间以及跟 daemon 所在主机的通信。默认为 true。</li>\n<li><code class="language-text">--insecure-registry=[]</code>：允许访问给定的非安全仓库服务；</li>\n<li><code class="language-text">--ip=&quot;&quot;</code>：绑定容器端口时候的默认 IP 地址。缺省为 0.0.0.0；</li>\n<li><code class="language-text">--ip-forward=true|false</code>：是否检查启动在 Docker 主机上的启用 IP 转发服务，默认开启。注意关闭该选项将不对系统转发能力进行任何检查修改；</li>\n<li><code class="language-text">--ip-masq=true|false</code>：是否进行地址伪装，用于容器访问外部网络，默认开启；</li>\n<li><code class="language-text">--iptables=true|false</code>：是否允许 Docker 添加 iptables 规则。缺省为 true；</li>\n<li><code class="language-text">--ipv6=true|false</code>：是否启用 IPv6 支持，默认关闭；</li>\n<li><code class="language-text">-l, --log-level=&quot;debug|info|warn|error|fatal&quot;</code>：指定日志输出级别；</li>\n<li><code class="language-text">--label=&quot;[]&quot;</code>：添加指定的键值对标注；</li>\n<li><code class="language-text">--log-driver=&quot;json-file|syslog|journald|gelf|fluentd|awslogs|splunk|etwlogs|gcplogs|none&quot;</code>：指定日志后端驱动，默认为 <code class="language-text">json-file</code>；</li>\n<li><code class="language-text">--log-opt=[]</code>：日志后端的选项；</li>\n<li><code class="language-text">--mtu=VALUE</code>：指定容器网络的 mtu；</li>\n<li><code class="language-text">-p=&quot;&quot;</code>：指定 daemon 的 PID 文件路径。缺省为 <code class="language-text">/var/run/docker.pid</code>；</li>\n<li><code class="language-text">--raw-logs</code>：输出原始，未加色彩的日志信息；</li>\n<li><code class="language-text">--registry-mirror=&lt;scheme&gt;://&lt;host&gt;</code>：指定 docker pull 时使用的注册服务器镜像地址；</li>\n<li><code class="language-text">-s, --storage-driver=&quot;&quot;</code>：指定使用给定的存储后端；</li>\n<li><code class="language-text">--selinux-enabled=true|false</code>：是否启用 SELinux 支持。缺省值为 false。SELinux 目前尚不支持 overlay 存储驱动；</li>\n<li><code class="language-text">--storage-opt=[]</code>：驱动后端选项；</li>\n<li><code class="language-text">--tls=true|false</code>：是否对 Docker daemon 启用 TLS 安全机制，默认为否；</li>\n<li><code class="language-text">--tlscacert=/.docker/ca.pem</code>：TLS CA 签名的可信证书文件路径；</li>\n<li><code class="language-text">--tlscert=/.docker/cert.pem</code>：TLS 可信证书文件路径；</li>\n<li><code class="language-text">--tlscert=/.docker/key.pem</code>：TLS 密钥文件路径；</li>\n<li><code class="language-text">--tlsverify=true|false</code>：启用 TLS 校验，默认为否；</li>\n<li><code class="language-text">--userland-proxy=true|false</code>：是否使用用户态代理来实现容器间和出容器的回环通信，默认为 true；</li>\n<li><code class="language-text">--userns-remap=default|uid:gid|user:group|user|uid</code>：指定容器的用户命名空间，默认是创建新的 UID 和 GID 映射到容器内进程。</li>\n</ul>\n<h1 id="dockerfile-最佳实践"><a href="#dockerfile-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dockerfile 最佳实践</h1>\n<h2 id="一般性的指南和建议"><a href="#%E4%B8%80%E8%88%AC%E6%80%A7%E7%9A%84%E6%8C%87%E5%8D%97%E5%92%8C%E5%BB%BA%E8%AE%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一般性的指南和建议</h2>\n<h3 id="容器应该是短暂的"><a href="#%E5%AE%B9%E5%99%A8%E5%BA%94%E8%AF%A5%E6%98%AF%E7%9F%AD%E6%9A%82%E7%9A%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器应该是短暂的</h3>\n<p>通过 Dockerfile 构建的镜像所启动的容器应该尽可能短暂（生命周期短）。「短暂」意味着可以停止和销毁容器，并且创建一个新容器并部署好所需的设置和配置工作量应该是极小的。</p>\n<h3 id="使用-dockerignore-文件"><a href="#%E4%BD%BF%E7%94%A8-dockerignore-%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 .dockerignore 文件</h3>\n<p>使用 Dockerfile 构建镜像时最好是将 Dockerfile 放置在一个新建的空目录下。然后将构建镜像所需要的文件添加到该目录中。为了提高构建镜像的效率，你可以在目录下新建一个 .dockerignore 文件来指定要忽略的文件和目录。.dockerignore 文件的排除模式语法和 Git 的 .gitignore 文件相似。</p>\n<h3 id="使用多阶段构建-1"><a href="#%E4%BD%BF%E7%94%A8%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%9E%84%E5%BB%BA-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用多阶段构建</h3>\n<p>在 Docker 17.05 以上版本中，你可以使用多阶段构建来减少所构建镜像的大小。</p>\n<h3 id="避免安装不必要的包"><a href="#%E9%81%BF%E5%85%8D%E5%AE%89%E8%A3%85%E4%B8%8D%E5%BF%85%E8%A6%81%E7%9A%84%E5%8C%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>避免安装不必要的包</h3>\n<p>为了降低复杂性、减少依赖、减小文件大小、节约构建时间，你应该避免安装任何不必要的包。例如，不要在数据库镜像中包含一个文本编辑器。</p>\n<h3 id="一个容器只运行一个进程"><a href="#%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A8%E5%8F%AA%E8%BF%90%E8%A1%8C%E4%B8%80%E4%B8%AA%E8%BF%9B%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一个容器只运行一个进程</h3>\n<p>应该保证在一个容器中只运行一个进程。将多个应用解耦到不同容器中，保证了容器的横向扩展和复用。例如 web 应用应该包含三个容器：web 应用、数据库、缓存。</p>\n<p>如果容器互相依赖，你可以使用 Docker 自定义网络来把这些容器连接起来。</p>\n<h3 id="镜像层数尽可能少"><a href="#%E9%95%9C%E5%83%8F%E5%B1%82%E6%95%B0%E5%B0%BD%E5%8F%AF%E8%83%BD%E5%B0%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>镜像层数尽可能少</h3>\n<p>你需要在 Dockerfile 可读性（也包括长期的可维护性）和减少层数之间做一个平衡。</p>\n<h3 id="将多行参数排序"><a href="#%E5%B0%86%E5%A4%9A%E8%A1%8C%E5%8F%82%E6%95%B0%E6%8E%92%E5%BA%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>将多行参数排序</h3>\n<p>将多行参数按字母顺序排序（比如要安装多个包时）。这可以帮助你避免重复包含同一个包，更新包列表时也更容易。也便于 PRs 阅读和审查。建议在反斜杠符号 <code class="language-text">\\</code> 之前添加一个空格，以增加可读性。</p>\n<p>下面是来自 <code class="language-text">buildpack-deps</code> 镜像的例子：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89260857868955570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RUN apt-get update && apt-get install -y \\\n  bzr \\\n  cvs \\\n  git \\\n  mercurial \\\n  subversion`, `89260857868955570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update &amp;&amp; apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y \\\n  bzr \\\n  cvs \\\n  git \\\n  mercurial \\\n  subversion</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="构建缓存"><a href="#%E6%9E%84%E5%BB%BA%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建缓存</h3>\n<p>在镜像的构建过程中，Docker 会遍历 Dockerfile 文件中的指令，然后按顺序执行。在执行每条指令之前，Docker 都会在缓存中查找是否已经存在可重用的镜像，如果有就使用现存的镜像，不再重复创建。如果你不想在构建过程中使用缓存，你可以在 docker build 命令中使用 <code class="language-text">--no-cache=true</code> 选项。</p>\n<p>但是，如果你想在构建的过程中使用缓存，你得明白什么时候会，什么时候不会找到匹配的镜像，遵循的基本规则如下：</p>\n<ul>\n<li>从一个基础镜像开始（FROM 指令指定），下一条指令将和该基础镜像的所有子镜像进行匹配，检查这些子镜像被创建时使用的指令是否和被检查的指令完全一样。如果不是，则缓存失效。</li>\n<li>在大多数情况下，只需要简单地对比 Dockerfile 中的指令和子镜像。然而，有些指令需要更多的检查和解释。</li>\n<li>对于 ADD 和 COPY 指令，镜像中对应文件的内容也会被检查，每个文件都会计算出一个校验和。文件的最后修改时间和最后访问时间不会纳入校验。在缓存的查找过程中，会将这些校验和和已存在镜像中的文件校验和进行对比。如果文件有任何改变，比如内容和元数据，则缓存失效。</li>\n<li>除了 ADD 和 COPY 指令，缓存匹配过程不会查看临时容器中的文件来决定缓存是否匹配。例如，当执行完 <code class="language-text">RUN apt-get -y update</code> 指令后，容器中一些文件被更新，但 Docker 不会检查这些文件。这种情况下，只有指令字符串本身被用来匹配缓存。</li>\n</ul>\n<p>一旦缓存失效，所有后续的 Dockerfile 指令都将产生新的镜像，缓存不会被使用。</p>\n<h2 id="dockerfile-指令"><a href="#dockerfile-%E6%8C%87%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dockerfile 指令</h2>\n<p>下面针对 Dockerfile 中各种指令的最佳编写方式给出建议。</p>\n<h3 id="from"><a href="#from" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>FROM</h3>\n<p>尽可能使用当前官方仓库作为你构建镜像的基础。推荐使用 Alpine 镜像，因为它被严格控制并保持最小尺寸（目前小于 5 MB），但它仍然是一个完整的发行版。</p>\n<h3 id="label"><a href="#label" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>LABEL</h3>\n<p>你可以给镜像添加标签来帮助组织镜像、记录许可信息、辅助自动化构建等。每个标签一行，由 LABEL 开头加上一个或多个标签对。下面的示例展示了各种不同的可能格式。<code class="language-text">#</code> 开头的行是注释内容。</p>\n<p>注意：如果你的字符串中包含空格，必须将字符串放入引号中或者对空格使用转义。如果字符串内容本身就包含引号，必须对引号使用转义。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13991848008523934000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# Set one or more individual labels\nLABEL com.example.version=&quot;0.0.1-beta&quot;\n\nLABEL vendor=&quot;ACME Incorporated&quot;\n\nLABEL com.example.release-date=&quot;2015-02-12&quot;\n\nLABEL com.example.version.is-production=&quot;&quot;`, `13991848008523934000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># Set one or more individual labels</span>\n<span class="token keyword">LABEL</span> com.example.version=<span class="token string">"0.0.1-beta"</span>\n\n<span class="token keyword">LABEL</span> vendor=<span class="token string">"ACME Incorporated"</span>\n\n<span class="token keyword">LABEL</span> com.example.release<span class="token punctuation">-</span>date=<span class="token string">"2015-02-12"</span>\n\n<span class="token keyword">LABEL</span> com.example.version.is<span class="token punctuation">-</span>production=<span class="token string">""</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>一个镜像可以包含多个标签，但建议将多个标签放入到一个 LABEL 指令中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75031799032507300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# Set multiple labels at once, using line-continuation characters to break long lines\nLABEL vendor=ACME\\ Incorporated \\\n      com.example.is-beta= \\\n      com.example.is-production=&quot;&quot; \\\n      com.example.version=&quot;0.0.1-beta&quot; \\\n      com.example.release-date=&quot;2015-02-12&quot;`, `75031799032507300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># Set multiple labels at once, using line-continuation characters to break long lines</span>\n<span class="token keyword">LABEL</span> vendor=ACME\\ Incorporated \\\n      com.example.is<span class="token punctuation">-</span>beta= \\\n      com.example.is<span class="token punctuation">-</span>production=<span class="token string">""</span> \\\n      com.example.version=<span class="token string">"0.0.1-beta"</span> \\\n      com.example.release<span class="token punctuation">-</span>date=<span class="token string">"2015-02-12"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>关于标签可以接受的键值对，参考 <a href="https://docs.docker.com/config/labels-custom-metadata/" target="_blank" rel="nofollow noreferrer noopener">Understanding object labels</a>。关于查询标签信息，参考 <a href="https://docs.docker.com/config/labels-custom-metadata/" target="_blank" rel="nofollow noreferrer noopener">Managing labels on objects</a>。</p>\n<h3 id="run"><a href="#run" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RUN</h3>\n<p>为了保持 Dockerfile 文件的可读性，可理解性，以及可维护性，建议将长的或复杂的 RUN 指令用反斜杠 <code class="language-text">\\</code> 分割成多行。</p>\n<h4 id="apt-get"><a href="#apt-get" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>apt-get</h4>\n<p>RUN 指令最常见的用法是安装包用的 apt-get。因为 <code class="language-text">RUN apt-get</code> 指令会安装包，所以有几个问题需要注意。</p>\n<p>不要使用 <code class="language-text">RUN apt-get upgrade</code> 或 <code class="language-text">dist-upgrade</code>，因为许多基础镜像中的「必须」包不会在一个非特权容器中升级。如果基础镜像中的某个包过时了，你应该联系它的维护者。如果你确定某个特定的包，比如 foo，需要升级，使用 <code class="language-text">apt-get install -y foo</code> 就行，该指令会自动升级 foo 包。</p>\n<p>永远将 <code class="language-text">RUN apt-get update</code> 和 <code class="language-text">apt-get install</code> 组合成一条 RUN 声明，例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20053808836416233000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RUN apt-get update && apt-get install -y \\\n        package-bar \\\n        package-baz \\\n        package-foo`, `20053808836416233000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update &amp;&amp; apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y \\\n        package<span class="token punctuation">-</span>bar \\\n        package<span class="token punctuation">-</span>baz \\\n        package<span class="token punctuation">-</span>foo</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>将 <code class="language-text">apt-get update</code> 放在一条单独的 RUN 声明中会导致缓存问题以及后续的 <code class="language-text">apt-get install</code> 失败。比如，假设你有一个 Dockerfile 文件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43526489673755345000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM ubuntu:18.04\n\nRUN apt-get update\n\nRUN apt-get install -y curl`, `43526489673755345000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> ubuntu<span class="token punctuation">:</span>18.04\n\n<span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update\n\n<span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y curl</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>构建镜像后，所有的层都在 Docker 的缓存中。假设你后来又修改了其中的 <code class="language-text">apt-get install</code> 添加了一个包：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97861346763325980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM ubuntu:18.04\n\nRUN apt-get update\n\nRUN apt-get install -y curl nginx`, `97861346763325980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> ubuntu<span class="token punctuation">:</span>18.04\n\n<span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update\n\n<span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y curl nginx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Docker 发现修改后的 <code class="language-text">RUN apt-get update</code> 指令和之前的完全一样。所以，<code class="language-text">apt-get update</code> 不会执行，而是使用之前的缓存镜像。因为 <code class="language-text">apt-get update</code> 没有运行，后面的 <code class="language-text">apt-get install</code> 可能安装的是过时的 curl 和 nginx 版本。</p>\n<p>使用 <code class="language-text">RUN apt-get update &amp;&amp; apt-get install -y</code> 可以确保你的 Dockerfiles 每次安装的都是包的最新的版本，而且这个过程不需要进一步的编码或额外干预。这项技术叫作 <code class="language-text">cache busting</code>。你也可以显示指定一个包的版本号来达到 <code class="language-text">cache-busting</code>，这就是所谓的固定版本，例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14607579904734580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RUN apt-get update && apt-get install -y \\\n    package-bar \\\n    package-baz \\\n    package-foo=1.3.*`, `14607579904734580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update &amp;&amp; apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y \\\n    package<span class="token punctuation">-</span>bar \\\n    package<span class="token punctuation">-</span>baz \\\n    package<span class="token punctuation">-</span>foo=1.3.*</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>固定版本会迫使构建过程检索特定的版本，而不管缓存中有什么。这项技术也可以减少因所需包中未预料到的变化而导致的失败。</p>\n<p>下面是一个 RUN 指令的示例模板，展示了所有关于 apt-get 的建议。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47599550518904230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RUN apt-get update && apt-get install -y \\\n    aufs-tools \\\n    automake \\\n    build-essential \\\n    curl \\\n    dpkg-sig \\\n    libcap-dev \\\n    libsqlite3-dev \\\n    mercurial \\\n    reprepro \\\n    ruby1.9.1 \\\n    ruby1.9.1-dev \\\n    s3cmd=1.1.* \\\n && rm -rf /var/lib/apt/lists/*`, `47599550518904230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update &amp;&amp; apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y \\\n    aufs<span class="token punctuation">-</span>tools \\\n    automake \\\n    build<span class="token punctuation">-</span>essential \\\n    curl \\\n    dpkg<span class="token punctuation">-</span>sig \\\n    libcap<span class="token punctuation">-</span>dev \\\n    libsqlite3<span class="token punctuation">-</span>dev \\\n    mercurial \\\n    reprepro \\\n    ruby1.9.1 \\\n    ruby1.9.1<span class="token punctuation">-</span>dev \\\n    s3cmd=1.1.* \\\n &amp;&amp; rm <span class="token punctuation">-</span>rf /var/lib/apt/lists/*</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其中 s3cmd 指令指定了一个版本号 <code class="language-text">1.1.*</code>。如果之前的镜像使用的是更旧的版本，指定新的版本会导致 <code class="language-text">apt-get udpate</code> 缓存失效并确保安装的是新版本。</p>\n<p>另外，清理掉 apt 缓存 <code class="language-text">var/lib/apt/lists</code> 可以减小镜像大小。因为 RUN 指令的开头为 <code class="language-text">apt-get udpate</code>，包缓存总是会在 <code class="language-text">apt-get install</code> 之前刷新。</p>\n<blockquote>\n<p>注意：官方的 Debian 和 Ubuntu 镜像会自动运行 <code class="language-text">apt-get clean</code>，所以不需要显式的调用 <code class="language-text">apt-get clean</code>。</p>\n</blockquote>\n<h3 id="cmd"><a href="#cmd" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CMD</h3>\n<p>CMD 指令用于执行目标镜像中包含的软件，可以包含参数。CMD 大多数情况下都应该以 <code class="language-text">CMD [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;...]</code> 的形式使用。因此，如果创建镜像的目的是为了部署某个服务(比如 Apache)，你可能会执行类似于 <code class="language-text">CMD [&quot;apache2&quot;, &quot;-DFOREGROUND&quot;]</code> 形式的命令。我们建议任何服务镜像都使用这种形式的命令。</p>\n<p>多数情况下，CMD 都需要一个交互式的 shell (bash, Python, perl 等)，例如 <code class="language-text">CMD [&quot;perl&quot;, &quot;-de0&quot;]</code>，或者 <code class="language-text">CMD [&quot;PHP&quot;, &quot;-a&quot;]</code>。使用这种形式意味着，当你执行类似 <code class="language-text">docker run -it python</code> 时，你会进入一个准备好的 shell 中。CMD 应该在极少的情况下才能以 <code class="language-text">CMD [&quot;param&quot;, &quot;param&quot;]</code> 的形式与 ENTRYPOINT 协同使用，除非你和你的镜像使用者都对 ENTRYPOINT 的工作方式十分熟悉。</p>\n<h3 id="expose"><a href="#expose" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>EXPOSE</h3>\n<p>EXPOSE 指令用于指定容器将要监听的端口。因此，你应该为你的应用程序使用常见的端口。例如，提供 <code class="language-text">Apache web</code> 服务的镜像应该使用 <code class="language-text">EXPOSE 80</code>，而提供 MongoDB 服务的镜像使用 <code class="language-text">EXPOSE 27017</code>。</p>\n<p>对于外部访问，用户可以在执行 <code class="language-text">docker run</code> 时使用一个标志来指示如何将指定的端口映射到所选择的端口。</p>\n<h3 id="env"><a href="#env" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ENV</h3>\n<p>为了方便新程序运行，你可以使用 ENV 来为容器中安装的程序更新 PATH 环境变量。例如使用 <code class="language-text">ENV PATH /usr/local/nginx/bin:$PATH</code> 来确保 <code class="language-text">CMD [&quot;nginx&quot;]</code> 能正确运行。</p>\n<p>ENV 指令也可用于为你想要容器化的服务提供必要的环境变量，比如 Postgres 需要的 PGDATA。</p>\n<p>最后，ENV 也能用于设置常见的版本号，比如下面的示例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57156190396558570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ENV PG_MAJOR 9.3\n\nENV PG_VERSION 9.3.4\n\nRUN curl -SL http://example.com/postgres-\\$PG_VERSION.tar.xz | tar -xJC /usr/src/postgress && …\n\nENV PATH /usr/local/postgres-\\$PG_MAJOR/bin:\\$PATH`, `57156190396558570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">ENV</span> PG_MAJOR 9.3\n\n<span class="token keyword">ENV</span> PG_VERSION 9.3.4\n\n<span class="token keyword">RUN</span> curl <span class="token punctuation">-</span>SL http<span class="token punctuation">:</span>//example.com/postgres<span class="token punctuation">-</span>$PG_VERSION.tar.xz <span class="token punctuation">|</span> tar <span class="token punctuation">-</span>xJC /usr/src/postgress &amp;&amp; …\n\n<span class="token keyword">ENV</span> PATH /usr/local/postgres<span class="token punctuation">-</span>$PG_MAJOR/bin<span class="token punctuation">:</span>$PATH</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>类似于程序中的常量，这种方法可以让你只需改变 ENV 指令来自动的改变容器中的软件版本。</p>\n<h3 id="add-和-copy"><a href="#add-%E5%92%8C-copy" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ADD 和 COPY</h3>\n<p>虽然 ADD 和 COPY 功能类似，但一般优先使用 COPY。因为它比 ADD 更透明。COPY 只支持简单将本地文件拷贝到容器中，而 ADD 有一些并不明显的功能（比如本地 tar 提取和远程 URL 支持）。因此，ADD 的最佳用例是将本地 tar 文件自动提取到镜像中，例如 <code class="language-text">ADD rootfs.tar.xz</code>。</p>\n<p>如果你的 Dockerfile 有多个步骤需要使用上下文中不同的文件。单独 COPY 每个文件，而不是一次性的 COPY 所有文件，这将保证每个步骤的构建缓存只在特定的文件变化时失效。例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63558956049896650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`COPY requirements.txt /tmp/\n\nRUN pip install --requirement /tmp/requirements.txt\n\nCOPY . /tmp/`, `63558956049896650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">COPY</span> requirements.txt /tmp/\n\n<span class="token keyword">RUN</span> pip install <span class="token punctuation">-</span><span class="token punctuation">-</span>requirement /tmp/requirements.txt\n\n<span class="token keyword">COPY</span> . /tmp/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果将 <code class="language-text">COPY . /tmp/</code> 放置在 RUN 指令之前，只要 <code class="language-text">.</code> 目录中任何一个文件变化，都会导致后续指令的缓存失效。</p>\n<p>为了让镜像尽量小，最好不要使用 ADD 指令从远程 URL 获取包，而是使用 curl 和 wget。这样你可以在文件提取完之后删掉不再需要的文件来避免在镜像中额外添加一层。比如尽量避免下面的用法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49443646498784280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ADD http://example.com/big.tar.xz /usr/src/things/\n\nRUN tar -xJf /usr/src/things/big.tar.xz -C /usr/src/things\n\nRUN make -C /usr/src/things all`, `49443646498784280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">ADD</span> http<span class="token punctuation">:</span>//example.com/big.tar.xz /usr/src/things/\n\n<span class="token keyword">RUN</span> tar <span class="token punctuation">-</span>xJf /usr/src/things/big.tar.xz <span class="token punctuation">-</span>C /usr/src/things\n\n<span class="token keyword">RUN</span> make <span class="token punctuation">-</span>C /usr/src/things all</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>而是应该使用下面这种方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18955119138692833000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`RUN mkdir -p /usr/src/things \\\n    && curl -SL http://example.com/big.tar.xz \\\n    | tar -xJC /usr/src/things \\\n    && make -C /usr/src/things all`, `18955119138692833000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">RUN</span> mkdir <span class="token punctuation">-</span>p /usr/src/things \\\n    &amp;&amp; curl <span class="token punctuation">-</span>SL http<span class="token punctuation">:</span>//example.com/big.tar.xz \\\n    <span class="token punctuation">|</span> tar <span class="token punctuation">-</span>xJC /usr/src/things \\\n    &amp;&amp; make <span class="token punctuation">-</span>C /usr/src/things all</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面使用的管道操作，所以没有中间文件需要删除。</p>\n<p>对于其他不需要 ADD 的自动提取功能的文件或目录，你应该使用 COPY。</p>\n<h3 id="entrypoint"><a href="#entrypoint" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ENTRYPOINT</h3>\n<p>ENTRYPOINT 的最佳用处是设置镜像的主命令，允许将镜像当成命令本身来运行（用 CMD 提供默认选项）。</p>\n<p>例如，下面的示例镜像提供了命令行工具 s3cmd:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26003486684068090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ENTRYPOINT [&quot;s3cmd&quot;]\n\nCMD [&quot;--help&quot;]`, `26003486684068090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">ENTRYPOINT</span> <span class="token punctuation">[</span><span class="token string">"s3cmd"</span><span class="token punctuation">]</span>\n\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span><span class="token string">"--help"</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>现在直接运行该镜像创建的容器会显示命令帮助：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69865618859596830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run s3cmd`, `69865618859596830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run s3cmd</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>或者提供正确的参数来执行某个命令：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1037663957796408600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run s3cmd ls s3://mybucket`, `1037663957796408600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run s3cmd <span class="token function">ls</span> s3://mybucket</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这样镜像名可以当成命令行的参考。</p>\n<p>ENTRYPOINT 指令也可以结合一个辅助脚本使用，和前面命令行风格类似，即使启动工具需要不止一个步骤。</p>\n<p>例如，Postgres 官方镜像使用下面的脚本作为 ENTRYPOINT：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54464528154125705000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/bin/bash\nset -e\n\nif [ &quot;\\$1&quot; = \'postgres\' ]; then\n    chown -R postgres &quot;\\$PGDATA&quot;\n\n    if [ -z &quot;\\$(ls -A &quot;\\$PGDATA&quot;)&quot; ]; then\n        gosu postgres initdb\n    fi\n\n    exec gosu postgres &quot;\\$@&quot;\nfi\n\nexec &quot;\\$@&quot;`, `54464528154125705000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>\n<span class="token builtin class-name">set</span> -e\n\n<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token operator">=</span> <span class="token string">\'postgres\'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n    <span class="token function">chown</span> -R postgres <span class="token string">"<span class="token variable">$PGDATA</span>"</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">[</span> -z <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> -A <span class="token string">"<span class="token variable">$PGDATA</span>"</span><span class="token variable">)</span></span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n        gosu postgres initdb\n    <span class="token keyword">fi</span>\n\n    <span class="token builtin class-name">exec</span> gosu postgres <span class="token string">"<span class="token variable">$@</span>"</span>\n<span class="token keyword">fi</span>\n\n<span class="token builtin class-name">exec</span> <span class="token string">"<span class="token variable">$@</span>"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>注意：该脚本使用了 Bash 的内置命令 exec，所以最后运行的进程就是容器的 PID 为 1 的进程。这样，进程就可以接收到任何发送给容器的 Unix 信号了。</p>\n</blockquote>\n<p>该辅助脚本被拷贝到容器，并在容器启动时通过 ENTRYPOINT 执行：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63931213006025490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`COPY ./docker-entrypoint.sh /\n\nENTRYPOINT [&quot;/docker-entrypoint.sh&quot;]`, `63931213006025490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">COPY</span> ./docker<span class="token punctuation">-</span>entrypoint.sh /\n\n<span class="token keyword">ENTRYPOINT</span> <span class="token punctuation">[</span><span class="token string">"/docker-entrypoint.sh"</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>该脚本可以让用户用几种不同的方式和 Postgres 交互。</p>\n<p>你可以很简单地启动 Postgres：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54951111354761850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run postgres`, `54951111354761850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run postgres</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>也可以执行 Postgres 并传递参数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16180929683371280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run postgres postgres --help`, `16180929683371280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run postgres postgres --help</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>最后，你还可以启动另外一个完全不同的工具，比如 Bash：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85001012287363380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker run --rm -it postgres bash`, `85001012287363380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker run --rm -it postgres <span class="token function">bash</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="volume"><a href="#volume" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>VOLUME</h3>\n<p>VOLUME 指令用于暴露任何数据库存储文件，配置文件，或容器创建的文件和目录。强烈建议使用 VOLUME 来管理镜像中的可变部分和用户可以改变的部分。</p>\n<h3 id="user"><a href="#user" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>USER</h3>\n<p>如果某个服务不需要特权执行，建议使用 USER 指令切换到非 root 用户。先在 Dockerfile 中使用类似 <code class="language-text">RUN groupadd -r postgres &amp;&amp; useradd -r -g postgres postgres</code> 的指令创建用户和用户组。</p>\n<blockquote>\n<p>注意：在镜像中，用户和用户组每次被分配的 <code class="language-text">UID/GID</code> 都是不确定的，下次重新构建镜像时被分配到的 <code class="language-text">UID/GID</code> 可能会不一样。如果要依赖确定的 <code class="language-text">UID/GID</code>，你应该显式的指定一个 <code class="language-text">UID/GID</code>。</p>\n</blockquote>\n<p>你应该避免使用 sudo，因为它不可预期的 TTY 和信号转发行为可能造成的问题比它能解决的问题还多。如果你真的需要和 sudo 类似的功能（例如，以 root 权限初始化某个守护进程，以非 root 权限执行它），你可以使用 <a href="https://github.com/tianon/gosu" target="_blank" rel="nofollow noreferrer noopener">gosu</a>。</p>\n<p>最后，为了减少层数和复杂度，避免频繁地使用 USER 来回切换用户。</p>\n<h3 id="workdir"><a href="#workdir" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WORKDIR</h3>\n<p>为了清晰性和可靠性，你应该总是在 WORKDIR 中使用绝对路径。另外，你应该使用 WORKDIR 来替代类似于 <code class="language-text">RUN cd ... &amp;&amp; do-something</code> 的指令，后者难以阅读、排错和维护。</p>\n<h2 id="官方镜像示例"><a href="#%E5%AE%98%E6%96%B9%E9%95%9C%E5%83%8F%E7%A4%BA%E4%BE%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>官方镜像示例</h2>\n<p>这些官方镜像的 Dockerfile 都是参考典范：<a href="https://github.com/docker-library/docs" target="_blank" rel="nofollow noreferrer noopener">https://github.com/docker-library/docs</a></p>\n<h1 id="如何调试-docker"><a href="#%E5%A6%82%E4%BD%95%E8%B0%83%E8%AF%95-docker" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何调试 Docker</h1>\n<h2 id="开启-debug-模式"><a href="#%E5%BC%80%E5%90%AF-debug-%E6%A8%A1%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>开启 Debug 模式</h2>\n<p>在 dockerd 配置文件 <code class="language-text">daemon.json</code>（默认位于 <code class="language-text">/etc/docker/</code>）中添加</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58961865429290205000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;debug&quot;: true\n}`, `58961865429290205000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"debug"</span><span class="token operator">:</span> <span class="token boolean">true</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>重启守护进程。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71455168250696245000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo kill -SIGHUP \\$(pidof dockerd)`, `71455168250696245000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">kill</span> -SIGHUP <span class="token variable"><span class="token variable">$(</span>pidof dockerd<span class="token variable">)</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>此时 dockerd 会在日志中输入更多信息供分析。</p>\n<h2 id="检查内核日志"><a href="#%E6%A3%80%E6%9F%A5%E5%86%85%E6%A0%B8%E6%97%A5%E5%BF%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>检查内核日志</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29218986886957920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo dmesg | grep dockerd\n\\$ sudo dmesg | grep runc`, `29218986886957920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">dmesg</span> <span class="token operator">|</span> <span class="token function">grep</span> dockerd\n$ <span class="token function">sudo</span> <span class="token function">dmesg</span> <span class="token operator">|</span> <span class="token function">grep</span> runc</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h2 id="docker-不响应时处理"><a href="#docker-%E4%B8%8D%E5%93%8D%E5%BA%94%E6%97%B6%E5%A4%84%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker 不响应时处理</h2>\n<p>可以杀死 dockerd 进程查看其堆栈调用情况。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54058706058221230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo kill -SIGUSR1 \\$(pidof dockerd)`, `54058706058221230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">kill</span> -SIGUSR1 <span class="token variable"><span class="token variable">$(</span>pidof dockerd<span class="token variable">)</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="重置-docker-本地数据"><a href="#%E9%87%8D%E7%BD%AE-docker-%E6%9C%AC%E5%9C%B0%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>重置 Docker 本地数据</h2>\n<p>注意，本操作会移除所有的 Docker 本地数据，包括镜像和容器等。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19971083797984068000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo rm -rf /var/lib/docker`, `19971083797984068000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">rm</span> -rf /var/lib/docker</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h1 id="compose"><a href="#compose" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Compose</h1>\n<p>Compose 项目是 Docker 官方的开源项目，负责实现对 Docker 容器集群的快速编排。从功能上看，跟 OpenStack 中的 Heat 十分类似。</p>\n<p>其代码目前在 <a href="https://github.com/docker/compose" target="_blank" rel="nofollow noreferrer noopener">https://github.com/docker/compose</a> 上开源。</p>\n<p>Compose 定位是「定义和运行多个 Docker 容器的应用（Defining and running multi-container Docker applications）」，其前身是开源项目 Fig。</p>\n<p>通过第一部分中的介绍，我们知道使用一个 Dockerfile 模板文件，可以让用户很方便的定义一个单独的应用容器。然而，在日常工作中，经常会碰到需要多个容器相互配合来完成某项任务的情况。例如要实现一个 Web 项目，除了 Web 服务容器本身，往往还需要再加上后端的数据库服务容器，甚至还包括负载均衡容器等。</p>\n<p>Compose 恰好满足了这样的需求。它允许用户通过一个单独的 <code class="language-text">docker-compose.yml</code> 模板文件（YAML 格式）来定义一组相关联的应用容器为一个项目（project）。</p>\n<p>Compose 中有两个重要的概念：</p>\n<ul>\n<li>服务 (service)：一个应用的容器，实际上可以包括若干运行相同镜像的容器实例。</li>\n<li>项目 (project)：由一组关联的应用容器组成的一个完整业务单元，在 <code class="language-text">docker-compose.yml</code> 文件中定义。</li>\n</ul>\n<p>Compose 的默认管理对象是项目，通过子命令对项目中的一组容器进行便捷地生命周期管理。</p>\n<p>Compose 项目由 Python 编写，实现上调用了 Docker 服务提供的 API 来对容器进行管理。因此，只要所操作的平台支持 Docker API，就可以在其上利用 Compose 来进行编排管理。</p>\n<h2 id="使用-2"><a href="#%E4%BD%BF%E7%94%A8-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用</h2>\n<h3 id="术语"><a href="#%E6%9C%AF%E8%AF%AD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>术语</h3>\n<p>首先介绍几个术语。</p>\n<ul>\n<li>服务(service)：一个应用容器，实际上可以运行多个相同镜像的实例。</li>\n<li>项目(project)：由一组关联的应用容器组成的一个完整业务单元。</li>\n</ul>\n<p>可见，一个项目可以由多个服务（容器）关联而成，Compose 面向项目进行管理。</p>\n<h3 id="场景"><a href="#%E5%9C%BA%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>场景</h3>\n<p>最常见的项目是 web 网站，该项目应该包含 web 应用和缓存。</p>\n<p>下面我们用 Python 来建立一个能够记录页面访问次数的 web 网站。</p>\n<h4 id="web-应用"><a href="#web-%E5%BA%94%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>web 应用</h4>\n<p>新建文件夹，在该目录中编写 app.py 文件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72230378709631490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from flask import Flask\nfrom redis import Redis\n\napp = Flask(__name__)\nredis = Redis(host=\'redis\', port=6379)\n\n@app.route(\'/\')\ndef hello():\n    count = redis.incr(\'hits\')\n    return \'Hello World! 该页面已被访问 {} 次。\\n\'.format(count)\n\nif __name__ == &quot;__main__&quot;:\n    app.run(host=&quot;0.0.0.0&quot;, debug=True)`, `72230378709631490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask\n<span class="token keyword">from</span> redis <span class="token keyword">import</span> Redis\n\napp <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>\nredis <span class="token operator">=</span> Redis<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">\'redis\'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">)</span>\n\n@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    count <span class="token operator">=</span> redis<span class="token punctuation">.</span>incr<span class="token punctuation">(</span><span class="token string">\'hits\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token string">\'Hello World! 该页面已被访问 {} 次。\\n\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>\n    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="dockerfile-1"><a href="#dockerfile-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dockerfile</h4>\n<p>编写 Dockerfile 文件，内容为</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33241499124542796000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM python:3.6-alpine\nADD . /code\nWORKDIR /code\nRUN pip install redis flask\nCMD [&quot;python&quot;, &quot;app.py&quot;]`, `33241499124542796000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> python<span class="token punctuation">:</span>3.6<span class="token punctuation">-</span>alpine\n<span class="token keyword">ADD</span> . /code\n<span class="token keyword">WORKDIR</span> /code\n<span class="token keyword">RUN</span> pip install redis flask\n<span class="token keyword">CMD</span> <span class="token punctuation">[</span><span class="token string">"python"</span><span class="token punctuation">,</span> <span class="token string">"app.py"</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="docker-composeyml"><a href="#docker-composeyml" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>docker-compose.yml</h4>\n<p>编写 <code class="language-text">docker-compose.yml</code> 文件，这个是 Compose 使用的主模板文件。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44019035194379130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\nservices:\n  web:\n    build: .\n    ports:\n      - \'5000:5000\'\n\n  redis:\n    image: \'redis:alpine\'`, `44019035194379130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">web</span><span class="token punctuation">:</span>\n    <span class="token key atrule">build</span><span class="token punctuation">:</span> .\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">\'5000:5000\'</span>\n\n  <span class="token key atrule">redis</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">\'redis:alpine\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="运行-compose-项目"><a href="#%E8%BF%90%E8%A1%8C-compose-%E9%A1%B9%E7%9B%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行 compose 项目</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20850870534617317000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker compose up`, `20850870534617317000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker compose up</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>此时访问本地 5000 端口，每次刷新页面，计数就会加 1。</p>\n<h2 id="compose-命令说明"><a href="#compose-%E5%91%BD%E4%BB%A4%E8%AF%B4%E6%98%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Compose 命令说明</h2>\n<h3 id="命令对象与格式"><a href="#%E5%91%BD%E4%BB%A4%E5%AF%B9%E8%B1%A1%E4%B8%8E%E6%A0%BC%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>命令对象与格式</h3>\n<p>对于 Compose 来说，大部分命令的对象既可以是项目本身，也可以指定为项目中的服务或者容器。如果没有特别的说明，命令对象将是项目，这意味着项目中所有的服务都会受到命令影响。</p>\n<p>执行 <code class="language-text">docker compose [COMMAND] --help</code> 可以查看具体某个命令的使用格式。</p>\n<p>docker compose 命令的基本的使用格式是</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20749264094966223000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`docker compose [-f=<arg>...] [options] [COMMAND] [ARGS...]`, `20749264094966223000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">docker compose <span class="token punctuation">[</span>-f<span class="token operator">=</span><span class="token operator">&lt;</span>arg<span class="token operator">></span><span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> <span class="token punctuation">[</span>ARGS<span class="token punctuation">..</span>.<span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="命令选项"><a href="#%E5%91%BD%E4%BB%A4%E9%80%89%E9%A1%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>命令选项</h3>\n<ul>\n<li><code class="language-text">-f, --file FILE</code> 指定使用的 Compose 模板文件，默认为 <code class="language-text">docker-compose.yml</code>，可以多次指定。</li>\n<li><code class="language-text">-p, --project-name NAME</code> 指定项目名称，默认将使用所在目录名称作为项目名。</li>\n<li><code class="language-text">--verbose</code> 输出更多调试信息。</li>\n<li><code class="language-text">-v, --version</code> 打印版本并退出。</li>\n</ul>\n<h3 id="命令使用说明"><a href="#%E5%91%BD%E4%BB%A4%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>命令使用说明</h3>\n<h4 id="build"><a href="#build" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>build</h4>\n<p>格式为 <code class="language-text">docker compose build [options] [SERVICE...]</code>。</p>\n<p>构建（重新构建）项目中的服务容器。</p>\n<p>服务容器一旦构建后，将会带上一个标记名，例如对于 web 项目中的一个 db 容器，可能是 <code class="language-text">web_db</code>。</p>\n<p>可以随时在项目目录下运行 <code class="language-text">docker compose build</code> 来重新构建服务。</p>\n<p>选项包括：</p>\n<ul>\n<li><code class="language-text">--force-rm</code> 删除构建过程中的临时容器。</li>\n<li><code class="language-text">--no-cache</code> 构建镜像过程中不使用 cache（这将加长构建过程）。</li>\n<li><code class="language-text">--pull</code> 始终尝试通过 pull 来获取更新版本的镜像。</li>\n</ul>\n<h4 id="config"><a href="#config" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>config</h4>\n<p>验证 Compose 文件格式是否正确，若正确则显示配置，若格式错误显示错误原因。</p>\n<h4 id="down"><a href="#down" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>down</h4>\n<p>此命令将会停止 up 命令所启动的容器，并移除网络</p>\n<h4 id="exec"><a href="#exec" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>exec</h4>\n<p>进入指定的容器。</p>\n<h4 id="help"><a href="#help" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>help</h4>\n<p>获得一个命令的帮助。</p>\n<h4 id="images"><a href="#images" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>images</h4>\n<p>列出 Compose 文件中包含的镜像。</p>\n<h4 id="kill"><a href="#kill" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kill</h4>\n<p>格式为 <code class="language-text">docker compose kill [options] [SERVICE...]</code>。</p>\n<p>通过发送 SIGKILL 信号来强制停止服务容器。</p>\n<p>支持通过 <code class="language-text">-s</code> 参数来指定发送的信号，例如通过如下指令发送 SIGINT 信号。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35154570859975975000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker compose kill -s SIGINT`, `35154570859975975000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker compose <span class="token function">kill</span> -s SIGINT</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="logs"><a href="#logs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>logs</h4>\n<p>格式为 <code class="language-text">docker compose logs [options] [SERVICE...]</code>。</p>\n<p>查看服务容器的输出。默认情况下，<code class="language-text">docker compose</code> 将对不同的服务输出使用不同的颜色来区分。可以通过 <code class="language-text">--no-color</code> 来关闭颜色。</p>\n<p>该命令在调试问题的时候十分有用。</p>\n<h4 id="pause"><a href="#pause" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pause</h4>\n<p>格式为 <code class="language-text">docker compose pause [SERVICE...]</code>。</p>\n<p>暂停一个服务容器。</p>\n<h4 id="port"><a href="#port" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>port</h4>\n<p>格式为 <code class="language-text">docker compose port [options] SERVICE PRIVATE_PORT</code>。</p>\n<p>打印某个容器端口所映射的公共端口。</p>\n<p>选项：</p>\n<ul>\n<li><code class="language-text">--protocol=proto</code> 指定端口协议，tcp（默认值）或者 udp。</li>\n<li><code class="language-text">--index=index</code> 如果同一服务存在多个容器，指定命令对象容器的序号（默认为 1）。</li>\n</ul>\n<h4 id="ps"><a href="#ps" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ps</h4>\n<p>格式为 <code class="language-text">docker compose ps [options] [SERVICE...]</code>。</p>\n<p>列出项目中目前的所有容器。</p>\n<p>选项：</p>\n<ul>\n<li><code class="language-text">-q</code> 只打印容器的 ID 信息。</li>\n</ul>\n<h4 id="pull"><a href="#pull" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pull</h4>\n<p>格式为 <code class="language-text">docker compose pull [options] [SERVICE...]</code>。</p>\n<p>拉取服务依赖的镜像。</p>\n<p>选项：</p>\n<ul>\n<li><code class="language-text">--ignore-pull-failures</code> 忽略拉取镜像过程中的错误。</li>\n</ul>\n<h4 id="push"><a href="#push" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>push</h4>\n<p>推送服务依赖的镜像到 Docker 镜像仓库。</p>\n<h4 id="restart"><a href="#restart" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>restart</h4>\n<p>格式为 <code class="language-text">docker compose restart [options] [SERVICE...]</code>。</p>\n<p>重启项目中的服务。</p>\n<p>选项：</p>\n<ul>\n<li><code class="language-text">-t, --timeout TIMEOUT</code> 指定重启前停止容器的超时（默认为 10 秒）。</li>\n</ul>\n<h4 id="rm"><a href="#rm" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>rm</h4>\n<p>格式为 <code class="language-text">docker compose rm [options] [SERVICE...]</code>。</p>\n<p>删除所有（停止状态的）服务容器。推荐先执行 <code class="language-text">docker compose stop</code> 命令来停止容器。</p>\n<p>选项：</p>\n<ul>\n<li><code class="language-text">-f, --force</code> 强制直接删除，包括非停止状态的容器。一般尽量不要使用该选项。</li>\n<li><code class="language-text">-v</code> 删除容器所挂载的数据卷。</li>\n</ul>\n<h4 id="run-1"><a href="#run-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>run</h4>\n<p>格式为 <code class="language-text">docker compose run [options] [-p PORT...] [-e KEY=VAL...] SERVICE [COMMAND] [ARGS...]</code>。</p>\n<p>在指定服务上执行一个命令。</p>\n<p>例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46392386592305160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker compose run ubuntu ping docker.com`, `46392386592305160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker compose run ubuntu <span class="token function">ping</span> docker.com</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>将会启动一个 ubuntu 服务容器，并执行 <code class="language-text">ping docker.com</code> 命令。</p>\n<p>默认情况下，如果存在关联，则所有关联的服务将会自动被启动，除非这些服务已经在运行中。</p>\n<p>该命令类似启动容器后运行指定的命令，相关卷、链接等等都将会按照配置自动创建。</p>\n<p>两个不同点：</p>\n<ol>\n<li>给定命令将会覆盖原有的自动运行命令；</li>\n<li>不会自动创建端口，以避免冲突。</li>\n</ol>\n<p>如果不希望自动启动关联的容器，可以使用 <code class="language-text">--no-deps</code> 选项，例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21753726836613540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker compose run --no-deps web python manage.py shell`, `21753726836613540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker compose run --no-deps web python manage.py shell</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>将不会启动 web 容器所关联的其它容器。</p>\n<p>选项：</p>\n<ul>\n<li><code class="language-text">-d</code> 后台运行容器。</li>\n<li><code class="language-text">--name NAME</code> 为容器指定一个名字。</li>\n<li><code class="language-text">--entrypoint CMD</code> 覆盖默认的容器启动指令。</li>\n<li><code class="language-text">-e KEY=VAL</code> 设置环境变量值，可多次使用选项来设置多个环境变量。</li>\n<li><code class="language-text">-u, --user=&quot;&quot;</code> 指定运行容器的用户名或者 uid。</li>\n<li><code class="language-text">--no-deps</code> 不自动启动关联的服务容器。</li>\n<li><code class="language-text">--rm</code> 运行命令后自动删除容器，<code class="language-text">d</code> 模式下将忽略。</li>\n<li><code class="language-text">-p, --publish=[]</code> 映射容器端口到本地主机。</li>\n<li><code class="language-text">--service-ports</code> 配置服务端口并映射到本地主机。</li>\n<li><code class="language-text">-T</code> 不分配伪 tty，意味着依赖 tty 的指令将无法运行。</li>\n</ul>\n<h4 id="start"><a href="#start" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>start</h4>\n<p>格式为 <code class="language-text">docker compose start [SERVICE...]</code>。</p>\n<p>启动已经存在的服务容器。</p>\n<h4 id="stop"><a href="#stop" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>stop</h4>\n<p>格式为 <code class="language-text">docker compose stop [options] [SERVICE...]</code>。</p>\n<p>停止已经处于运行状态的容器，但不删除它。通过 <code class="language-text">docker compose start</code> 可以再次启动这些容器。</p>\n<p>选项：</p>\n<ul>\n<li><code class="language-text">-t, --timeout TIMEOUT</code> 停止容器时候的超时（默认为 10 秒）。</li>\n</ul>\n<h4 id="top"><a href="#top" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>top</h4>\n<p>查看各个服务容器内运行的进程。</p>\n<h4 id="unpause"><a href="#unpause" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>unpause</h4>\n<p>格式为 <code class="language-text">docker compose unpause [SERVICE...]</code>。</p>\n<p>恢复处于暂停状态中的服务。</p>\n<h4 id="up"><a href="#up" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>up</h4>\n<p>格式为 <code class="language-text">docker compose up [options] [SERVICE...]</code>。</p>\n<p>该命令十分强大，它将尝试自动完成包括构建镜像，（重新）创建服务，启动服务，并关联服务相关容器的一系列操作。</p>\n<p>链接的服务都将会被自动启动，除非已经处于运行状态。</p>\n<p>可以说，大部分时候都可以直接通过该命令来启动一个项目。</p>\n<p>默认情况，<code class="language-text">docker compose up</code> 启动的容器都在前台，控制台将会同时打印所有容器的输出信息，可以很方便进行调试。</p>\n<p>当通过 <code class="language-text">Ctrl-C</code> 停止命令时，所有容器将会停止。</p>\n<p>如果使用 <code class="language-text">docker compose up -d</code>，将会在后台启动并运行所有的容器。一般推荐生产环境下使用该选项。</p>\n<p>默认情况，如果服务容器已经存在，<code class="language-text">docker compose up</code> 将会尝试停止容器，然后重新创建（保持使用 <code class="language-text">volumes-from</code> 挂载的卷），以保证新启动的服务匹配 <code class="language-text">docker-compose.yml</code> 文件的最新内容。如果用户不希望容器被停止并重新创建，可以使用 <code class="language-text">docker compose up --no-recreate</code>。这样将只会启动处于停止状态的容器，而忽略已经运行的服务。如果用户只想重新部署某个服务，可以使用 <code class="language-text">docker compose up --no-deps -d &lt;SERVICE_NAME&gt;</code> 来重新创建服务并后台停止旧服务，启动新服务，并不会影响到其所依赖的服务。</p>\n<p>选项：</p>\n<ul>\n<li><code class="language-text">-d</code> 在后台运行服务容器。</li>\n<li><code class="language-text">--no-color</code> 不使用颜色来区分不同的服务的控制台输出。</li>\n<li><code class="language-text">--no-deps</code> 不启动服务所链接的容器。</li>\n<li><code class="language-text">--force-recreate</code> 强制重新创建容器，不能与 <code class="language-text">--no-recreate</code> 同时使用。</li>\n<li><code class="language-text">--no-recreate</code> 如果容器已经存在了，则不重新创建，不能与 <code class="language-text">--force-recreate</code> 同时使用。</li>\n<li><code class="language-text">--no-build</code> 不自动构建缺失的服务镜像。</li>\n<li><code class="language-text">-t, --timeout TIMEOUT</code> 停止容器时候的超时（默认为 10 秒）。</li>\n</ul>\n<h4 id="version"><a href="#version" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>version</h4>\n<p>格式为 <code class="language-text">docker compose version</code>。</p>\n<p>打印版本信息。</p>\n<h2 id="compose-模板文件"><a href="#compose-%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Compose 模板文件</h2>\n<p>模板文件是使用 Compose 的核心，涉及到的指令关键字也比较多。但大家不用担心，这里面大部分指令跟 docker run 相关参数的含义都是类似的。</p>\n<p>默认的模板文件名称为 <code class="language-text">docker-compose.yml</code>，格式为 YAML 格式。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31463711887244906000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\n\nservices:\n  webapp:\n    image: examples/web\n    ports:\n      - \'80:80\'\n    volumes:\n      - \'/data\'`, `31463711887244906000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">webapp</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> examples/web\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">\'80:80\'</span>\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">\'/data\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意每个服务都必须通过 image 指令指定镜像或 build 指令（需要 Dockerfile）等来自动构建生成镜像。</p>\n<p>如果使用 build 指令，在 Dockerfile 中设置的选项(例如：CMD, EXPOSE, VOLUME, ENV 等) 将会自动被获取，无需在 <code class="language-text">docker-compose.yml</code> 中重复设置。</p>\n<p>下面分别介绍各个指令的用法。</p>\n<h3 id="build-1"><a href="#build-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>build</h3>\n<p>指定 Dockerfile 所在文件夹的路径（可以是绝对路径，或者相对 <code class="language-text">docker-compose.yml</code> 文件的路径）。Compose 将会利用它自动构建这个镜像，然后使用这个镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43816228674005280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\nservices:\n  webapp:\n    build: ./dir`, `43816228674005280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">webapp</span><span class="token punctuation">:</span>\n    <span class="token key atrule">build</span><span class="token punctuation">:</span> ./dir</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>你也可以使用 context 指令指定 Dockerfile 所在文件夹的路径。</p>\n<p>使用 dockerfile 指令指定 Dockerfile 文件名。</p>\n<p>使用 arg 指令指定构建镜像时的变量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60932368147785840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\nservices:\n  webapp:\n    build:\n      context: ./dir\n      dockerfile: Dockerfile-alternate\n      args:\n        buildno: 1`, `60932368147785840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">webapp</span><span class="token punctuation">:</span>\n    <span class="token key atrule">build</span><span class="token punctuation">:</span>\n      <span class="token key atrule">context</span><span class="token punctuation">:</span> ./dir\n      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile<span class="token punctuation">-</span>alternate\n      <span class="token key atrule">args</span><span class="token punctuation">:</span>\n        <span class="token key atrule">buildno</span><span class="token punctuation">:</span> <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 <code class="language-text">cache_from</code> 指定构建镜像的缓存</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12828824189429900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`build:\n  context: .\n  cache_from:\n    - alpine:latest\n    - corp/web_app:3.14`, `12828824189429900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">build</span><span class="token punctuation">:</span>\n  <span class="token key atrule">context</span><span class="token punctuation">:</span> .\n  <span class="token key atrule">cache_from</span><span class="token punctuation">:</span>\n    <span class="token punctuation">-</span> alpine<span class="token punctuation">:</span>latest\n    <span class="token punctuation">-</span> corp/web_app<span class="token punctuation">:</span><span class="token number">3.14</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="cap_add-cap_drop"><a href="#cap_add-cap_drop" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="language-text">cap_add</code>, <code class="language-text">cap_drop</code></h3>\n<p>指定容器的内核能力（capacity）分配。</p>\n<p>例如，让容器拥有所有能力可以指定为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4424898506125596000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`cap_add:\n  - ALL`, `4424898506125596000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">cap_add</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> ALL</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>去掉 <code class="language-text">NET_ADMIN</code> 能力可以指定为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26915915184395800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`cap_drop:\n  - NET_ADMIN`, `26915915184395800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">cap_drop</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> NET_ADMIN</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="command"><a href="#command" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>command</h3>\n<p>覆盖容器启动后默认执行的命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61691101031977860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`command: echo &quot;hello world&quot;`, `61691101031977860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">command</span><span class="token punctuation">:</span> echo "hello world"</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="configs"><a href="#configs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>configs</h3>\n<p>仅用于 Swarm mode，详细内容请查看 Swarm mode 一节。</p>\n<h3 id="cgroup_parent"><a href="#cgroup_parent" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>cgroup_parent</h3>\n<p>指定父 cgroup 组，意味着将继承该组的资源限制。</p>\n<p>例如，创建了一个 cgroup 组名称为 <code class="language-text">cgroups_1</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4922625638761935000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`cgroup_parent: cgroups_1`, `4922625638761935000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">cgroup_parent</span><span class="token punctuation">:</span> cgroups_1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="container_name"><a href="#container_name" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>container_name</h3>\n<p>指定容器名称。默认将会使用 <code class="language-text">项目名称-服务名称-序号</code> 这样的格式。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94868118522620580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`container_name: docker-web-container`, `94868118522620580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">container_name</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>web<span class="token punctuation">-</span>container</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<blockquote>\n<p>注意: 指定容器名称后，该服务将无法进行扩展（scale），因为 Docker 不允许多个容器具有相同的名称。</p>\n</blockquote>\n<h3 id="deploy"><a href="#deploy" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>deploy</h3>\n<p>仅用于 Swarm mode，详细内容请查看 Swarm mode 一节</p>\n<h3 id="devices"><a href="#devices" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>devices</h3>\n<p>指定设备映射关系。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51694361797992070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`devices:\n  - \'/dev/ttyUSB1:/dev/ttyUSB0\'`, `51694361797992070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">devices</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token string">\'/dev/ttyUSB1:/dev/ttyUSB0\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="depends_on"><a href="#depends_on" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>depends_on</h3>\n<p>解决容器的依赖、启动先后的问题。以下例子中会先启动 <code class="language-text">redis db</code> 再启动 web</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12899543114437284000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\n\nservices:\n  web:\n    build: .\n    depends_on:\n      - db\n      - redis\n\n  redis:\n    image: redis\n\n  db:\n    image: postgres`, `12899543114437284000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">web</span><span class="token punctuation">:</span>\n    <span class="token key atrule">build</span><span class="token punctuation">:</span> .\n    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> db\n      <span class="token punctuation">-</span> redis\n\n  <span class="token key atrule">redis</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis\n\n  <span class="token key atrule">db</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> postgres</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>注意：web 服务不会等待 <code class="language-text">redis db</code>「完全启动」之后才启动。</p>\n</blockquote>\n<h3 id="dns"><a href="#dns" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dns</h3>\n<p>自定义 DNS 服务器。可以是一个值，也可以是一个列表。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30569144351340306000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`dns: 8.8.8.8\n\ndns:\n  - 8.8.8.8\n  - 114.114.114.114`, `30569144351340306000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">dns</span><span class="token punctuation">:</span> 8.8.8.8\n\n<span class="token key atrule">dns</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> 8.8.8.8\n  <span class="token punctuation">-</span> 114.114.114.114</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="dns_search"><a href="#dns_search" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dns_search</h3>\n<p>配置 DNS 搜索域。可以是一个值，也可以是一个列表。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91754635166319120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`dns_search: example.com\n\ndns_search:\n  - domain1.example.com\n  - domain2.example.com`, `91754635166319120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">dns_search</span><span class="token punctuation">:</span> example.com\n\n<span class="token key atrule">dns_search</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> domain1.example.com\n  <span class="token punctuation">-</span> domain2.example.com</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="tmpfs"><a href="#tmpfs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>tmpfs</h3>\n<p>挂载一个 tmpfs 文件系统到容器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20724971304067430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`tmpfs: /run\ntmpfs:\n  - /run\n  - /tmp`, `20724971304067430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">tmpfs</span><span class="token punctuation">:</span> /run\n<span class="token key atrule">tmpfs</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> /run\n  <span class="token punctuation">-</span> /tmp</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="env_file"><a href="#env_file" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>env_file</h3>\n<p>从文件中获取环境变量，可以为单独的文件路径或列表。</p>\n<p>如果通过 <code class="language-text">docker compose -f FILE</code> 方式来指定 Compose 模板文件，则 <code class="language-text">env_file</code> 中变量的路径会基于模板文件路径。</p>\n<p>如果有变量名称与 environment 指令冲突，则按照惯例，以后者为准。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77391259941993480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`env_file: .env\n\nenv_file:\n  - ./common.env\n  - ./apps/web.env\n  - /opt/secrets.env`, `77391259941993480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">env_file</span><span class="token punctuation">:</span> .env\n\n<span class="token key atrule">env_file</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> ./common.env\n  <span class="token punctuation">-</span> ./apps/web.env\n  <span class="token punctuation">-</span> /opt/secrets.env</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>环境变量文件中每一行必须符合格式，支持 # 开头的注释行。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8485430556714535000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# common.env: Set development environment\nPROG_ENV=development`, `8485430556714535000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># common.env: Set development environment</span>\n<span class="token assign-left variable">PROG_ENV</span><span class="token operator">=</span>development</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="environment"><a href="#environment" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>environment</h3>\n<p>设置环境变量。你可以使用数组或字典两种格式。</p>\n<p>只给定名称的变量会自动获取运行 Compose 主机上对应变量的值，可以用来防止泄露不必要的数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63855627908951340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`environment:\n  RACK_ENV: development\n  SESSION_SECRET:\n\nenvironment:\n  - RACK_ENV=development\n  - SESSION_SECRET`, `63855627908951340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">environment</span><span class="token punctuation">:</span>\n  <span class="token key atrule">RACK_ENV</span><span class="token punctuation">:</span> development\n  <span class="token key atrule">SESSION_SECRET</span><span class="token punctuation">:</span>\n\n<span class="token key atrule">environment</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> RACK_ENV=development\n  <span class="token punctuation">-</span> SESSION_SECRET</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果变量名称或者值中用到 <code class="language-text">true|false</code>，<code class="language-text">yes|no</code> 等表达布尔含义的词汇，最好放到引号里，避免 YAML 自动解析某些内容为对应的布尔语义。这些特定词汇，包括</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78317323609365630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`y|Y|yes|Yes|YES|n|N|no|No|NO|true|True|TRUE|false|False|FALSE|on|On|ON|off|Off|OFF`, `78317323609365630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">y<span class="token operator">|</span>Y<span class="token operator">|</span><span class="token function">yes</span><span class="token operator">|</span>Yes<span class="token operator">|</span>YES<span class="token operator">|</span>n<span class="token operator">|</span>N<span class="token operator">|</span>no<span class="token operator">|</span>No<span class="token operator">|</span>NO<span class="token operator">|</span><span class="token boolean">true</span><span class="token operator">|</span>True<span class="token operator">|</span>TRUE<span class="token operator">|</span><span class="token boolean">false</span><span class="token operator">|</span>False<span class="token operator">|</span>FALSE<span class="token operator">|</span>on<span class="token operator">|</span>On<span class="token operator">|</span>ON<span class="token operator">|</span>off<span class="token operator">|</span>Off<span class="token operator">|</span>OFF</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="expose-1"><a href="#expose-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>expose</h3>\n<p>暴露端口，但不映射到宿主机，只被连接的服务访问。</p>\n<p>仅可以指定内部端口为参数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10997723883073650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`expose:\n  - \'3000\'\n  - \'8000\'`, `10997723883073650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">expose</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token string">\'3000\'</span>\n  <span class="token punctuation">-</span> <span class="token string">\'8000\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="external_links"><a href="#external_links" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>external_links</h3>\n<p>注意：不建议使用该指令。</p>\n<p>链接到 <code class="language-text">docker-compose.yml</code> 外部的容器，甚至并非 Compose 管理的外部容器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50506395538729950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`external_links:\n  - redis_1\n  - project_db_1:mysql\n  - project_db_1:postgresql`, `50506395538729950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">external_links</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> redis_1\n  <span class="token punctuation">-</span> project_db_1<span class="token punctuation">:</span>mysql\n  <span class="token punctuation">-</span> project_db_1<span class="token punctuation">:</span>postgresql</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="extra_hosts"><a href="#extra_hosts" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>extra_hosts</h3>\n<p>类似 Docker 中的 <code class="language-text">--add-host</code> 参数，指定额外的 host 名称映射信息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26318265310847020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`extra_hosts:\n  - \'googledns:8.8.8.8\'\n  - \'dockerhub:52.1.157.61\'`, `26318265310847020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">extra_hosts</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token string">\'googledns:8.8.8.8\'</span>\n  <span class="token punctuation">-</span> <span class="token string">\'dockerhub:52.1.157.61\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>会在启动后的服务容器中 <code class="language-text">/etc/hosts</code> 文件中添加如下两条条目。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81379402286716700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`8.8.8.8 googledns\n52.1.157.61 dockerhub`, `81379402286716700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token number">8.8</span>.8.8 googledns\n<span class="token number">52.1</span>.157.61 dockerhub</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="healthcheck"><a href="#healthcheck" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>healthcheck</h3>\n<p>通过命令检查容器是否健康运行。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30338118643925172000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`healthcheck:\n  test: [\'CMD\', \'curl\', \'-f\', \'http://localhost\']\n  interval: 1m30s\n  timeout: 10s\n  retries: 3`, `30338118643925172000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">healthcheck</span><span class="token punctuation">:</span>\n  <span class="token key atrule">test</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'CMD\'</span><span class="token punctuation">,</span> <span class="token string">\'curl\'</span><span class="token punctuation">,</span> <span class="token string">\'-f\'</span><span class="token punctuation">,</span> <span class="token string">\'http://localhost\'</span><span class="token punctuation">]</span>\n  <span class="token key atrule">interval</span><span class="token punctuation">:</span> 1m30s\n  <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 10s\n  <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="image"><a href="#image" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>image</h3>\n<p>指定为镜像名称或镜像 ID。如果镜像在本地不存在，Compose 将会尝试拉取这个镜像。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55092562134834850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`image: ubuntu\nimage: orchardup/postgresql\nimage: a4bc65fd`, `55092562134834850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">image</span><span class="token punctuation">:</span> ubuntu\n<span class="token key atrule">image</span><span class="token punctuation">:</span> orchardup/postgresql\n<span class="token key atrule">image</span><span class="token punctuation">:</span> a4bc65fd</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="labels"><a href="#labels" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>labels</h3>\n<p>为容器添加 Docker 元数据（metadata）信息。例如可以为容器添加辅助说明信息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34764802932430537000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`labels:\n  com.startupteam.description: \'webapp for a startup team\'\n  com.startupteam.department: \'devops department\'\n  com.startupteam.release: \'rc3 for v1.0\'`, `34764802932430537000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">labels</span><span class="token punctuation">:</span>\n  <span class="token key atrule">com.startupteam.description</span><span class="token punctuation">:</span> <span class="token string">\'webapp for a startup team\'</span>\n  <span class="token key atrule">com.startupteam.department</span><span class="token punctuation">:</span> <span class="token string">\'devops department\'</span>\n  <span class="token key atrule">com.startupteam.release</span><span class="token punctuation">:</span> <span class="token string">\'rc3 for v1.0\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="links"><a href="#links" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>links</h3>\n<p>注意：不推荐使用该指令。</p>\n<h3 id="logging"><a href="#logging" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>logging</h3>\n<p>配置日志选项。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73144646636984720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`logging:\n  driver: syslog\n  options:\n    syslog-address: \'tcp://192.168.0.42:123\'`, `73144646636984720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">logging</span><span class="token punctuation">:</span>\n  <span class="token key atrule">driver</span><span class="token punctuation">:</span> syslog\n  <span class="token key atrule">options</span><span class="token punctuation">:</span>\n    <span class="token key atrule">syslog-address</span><span class="token punctuation">:</span> <span class="token string">\'tcp://192.168.0.42:123\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>目前支持三种日志驱动类型。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81888096633896400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`driver: &quot;json-file&quot;\ndriver: &quot;syslog&quot;\ndriver: &quot;none&quot;`, `81888096633896400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">driver</span><span class="token punctuation">:</span> <span class="token string">"json-file"</span>\n<span class="token key atrule">driver</span><span class="token punctuation">:</span> <span class="token string">"syslog"</span>\n<span class="token key atrule">driver</span><span class="token punctuation">:</span> <span class="token string">"none"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>options 配置日志驱动的相关参数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31356286003752710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`options:\n  max-size: \'200k\'\n  max-file: \'10\'`, `31356286003752710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">options</span><span class="token punctuation">:</span>\n  <span class="token key atrule">max-size</span><span class="token punctuation">:</span> <span class="token string">\'200k\'</span>\n  <span class="token key atrule">max-file</span><span class="token punctuation">:</span> <span class="token string">\'10\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="network_mode"><a href="#network_mode" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>network_mode</h3>\n<p>设置网络模式。使用和 docker run 的 <code class="language-text">--network</code> 参数一样的值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21517853721940705000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`network_mode: &quot;bridge&quot;\nnetwork_mode: &quot;host&quot;\nnetwork_mode: &quot;none&quot;\nnetwork_mode: &quot;service:[service name]&quot;\nnetwork_mode: &quot;container:[container name/id]&quot;`, `21517853721940705000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">network_mode</span><span class="token punctuation">:</span> <span class="token string">"bridge"</span>\n<span class="token key atrule">network_mode</span><span class="token punctuation">:</span> <span class="token string">"host"</span>\n<span class="token key atrule">network_mode</span><span class="token punctuation">:</span> <span class="token string">"none"</span>\n<span class="token key atrule">network_mode</span><span class="token punctuation">:</span> <span class="token string">"service:[service name]"</span>\n<span class="token key atrule">network_mode</span><span class="token punctuation">:</span> <span class="token string">"container:[container name/id]"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="networks"><a href="#networks" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>networks</h3>\n<p>配置容器连接的网络。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19192275694534898000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\nservices:\n  some-service:\n    networks:\n      - some-network\n      - other-network\n\nnetworks:\n  some-network:\n  other-network:`, `19192275694534898000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">some-service</span><span class="token punctuation">:</span>\n    <span class="token key atrule">networks</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> some<span class="token punctuation">-</span>network\n      <span class="token punctuation">-</span> other<span class="token punctuation">-</span>network\n\n<span class="token key atrule">networks</span><span class="token punctuation">:</span>\n  <span class="token key atrule">some-network</span><span class="token punctuation">:</span>\n  other<span class="token punctuation">-</span>network<span class="token punctuation">:</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="pid"><a href="#pid" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pid</h3>\n<p>跟主机系统共享进程命名空间。打开该选项的容器之间，以及容器和宿主机系统之间可以通过进程 ID 来相互访问和操作。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18092944405482460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pid: \'host\'`, `18092944405482460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">pid</span><span class="token punctuation">:</span> <span class="token string">\'host\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="ports"><a href="#ports" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ports</h3>\n<p>暴露端口信息。</p>\n<p>使用宿主端口：容器端口（HOST:CONTAINER）格式，或者仅仅指定容器的端口（宿主将会随机选择端口）都可以。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53267795503504400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ports:\n  - \'3000\'\n  - \'8000:8000\'\n  - \'49100:22\'\n  - \'127.0.0.1:8001:8001\'`, `53267795503504400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">ports</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token string">\'3000\'</span>\n  <span class="token punctuation">-</span> <span class="token string">\'8000:8000\'</span>\n  <span class="token punctuation">-</span> <span class="token string">\'49100:22\'</span>\n  <span class="token punctuation">-</span> <span class="token string">\'127.0.0.1:8001:8001\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>注意：当使用 <code class="language-text">HOST:CONTAINER</code> 格式来映射端口时，如果你使用的容器端口小于 60 并且没放到引号里，可能会得到错误结果，因为 YAML 会自动解析 <code class="language-text">xx:yy</code> 这种数字格式为 60 进制。为避免出现这种问题，建议数字串都采用引号包括起来的字符串格式。</p>\n</blockquote>\n<h3 id="secrets"><a href="#secrets" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>secrets</h3>\n<p>存储敏感数据，例如 mysql 服务密码。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37748491848905540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3.1\'\nservices:\n\nmysql:\n  image: mysql\n  environment:\n    MYSQL_ROOT_PASSWORD_FILE: /run/secrets/db_root_password\n  secrets:\n    - db_root_password\n    - my_other_secret\n\nsecrets:\n  my_secret:\n    file: ./my_secret.txt\n  my_other_secret:\n    external: true`, `37748491848905540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3.1\'</span>\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n\n<span class="token key atrule">mysql</span><span class="token punctuation">:</span>\n  <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql\n  <span class="token key atrule">environment</span><span class="token punctuation">:</span>\n    <span class="token key atrule">MYSQL_ROOT_PASSWORD_FILE</span><span class="token punctuation">:</span> /run/secrets/db_root_password\n  <span class="token key atrule">secrets</span><span class="token punctuation">:</span>\n    <span class="token punctuation">-</span> db_root_password\n    <span class="token punctuation">-</span> my_other_secret\n\n<span class="token key atrule">secrets</span><span class="token punctuation">:</span>\n  <span class="token key atrule">my_secret</span><span class="token punctuation">:</span>\n    <span class="token key atrule">file</span><span class="token punctuation">:</span> ./my_secret.txt\n  <span class="token key atrule">my_other_secret</span><span class="token punctuation">:</span>\n    <span class="token key atrule">external</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="security_opt"><a href="#security_opt" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>security_opt</h3>\n<p>指定容器模板标签（label）机制的默认属性（用户、角色、类型、级别等）。例如配置标签的用户名和角色名。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42098277169932510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`security_opt:\n  - label:user:USER\n  - label:role:ROLE`, `42098277169932510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">security_opt</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> label<span class="token punctuation">:</span>user<span class="token punctuation">:</span>USER\n  <span class="token punctuation">-</span> label<span class="token punctuation">:</span>role<span class="token punctuation">:</span>ROLE</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="stop_signal"><a href="#stop_signal" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>stop_signal</h3>\n<p>设置另一个信号来停止容器。在默认情况下使用的是 SIGTERM 停止容器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66563333710436300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`stop_signal: SIGUSR1`, `66563333710436300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">stop_signal</span><span class="token punctuation">:</span> SIGUSR1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="sysctls"><a href="#sysctls" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>sysctls</h3>\n<p>配置容器内核参数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59449726145249950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`sysctls:\n  net.core.somaxconn: 1024\n  net.ipv4.tcp_syncookies: 0\n\nsysctls:\n  - net.core.somaxconn=1024\n  - net.ipv4.tcp_syncookies=0`, `59449726145249950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">sysctls</span><span class="token punctuation">:</span>\n  <span class="token key atrule">net.core.somaxconn</span><span class="token punctuation">:</span> <span class="token number">1024</span>\n  <span class="token key atrule">net.ipv4.tcp_syncookies</span><span class="token punctuation">:</span> <span class="token number">0</span>\n\n<span class="token key atrule">sysctls</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> net.core.somaxconn=1024\n  <span class="token punctuation">-</span> net.ipv4.tcp_syncookies=0</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="ulimits"><a href="#ulimits" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ulimits</h3>\n<p>指定容器的 ulimits 限制值。</p>\n<p>例如，指定最大进程数为 65535，指定文件句柄数为 20000（软限制，应用可以随时修改，不能超过硬限制）和 40000（系统硬限制，只能 root 用户提高）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37386732810572700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ulimits:\n  nproc: 65535\n  nofile:\n    soft: 20000\n    hard: 40000`, `37386732810572700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">ulimits</span><span class="token punctuation">:</span>\n  <span class="token key atrule">nproc</span><span class="token punctuation">:</span> <span class="token number">65535</span>\n  <span class="token key atrule">nofile</span><span class="token punctuation">:</span>\n    <span class="token key atrule">soft</span><span class="token punctuation">:</span> <span class="token number">20000</span>\n    <span class="token key atrule">hard</span><span class="token punctuation">:</span> <span class="token number">40000</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="volumes"><a href="#volumes" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>volumes</h3>\n<p>数据卷所挂载路径设置。可以设置为宿主机路径（HOST:CONTAINER）或者数据卷名称（VOLUME:CONTAINER），并且可以设置访问模式（HOST:CONTAINER:ro）。</p>\n<p>该指令中路径支持相对路径。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49727884448122490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`volumes:\n  - /var/lib/mysql\n  - cache/:/tmp/cache\n  - ~/configs:/etc/configs/:ro`, `49727884448122490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> /var/lib/mysql\n  <span class="token punctuation">-</span> cache/<span class="token punctuation">:</span>/tmp/cache\n  <span class="token punctuation">-</span> ~/configs<span class="token punctuation">:</span>/etc/configs/<span class="token punctuation">:</span>ro</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果路径为数据卷名称，必须在文件中配置数据卷。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68617980995313870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\n\nservices:\n  my_src:\n    image: mysql:8.0\n    volumes:\n      - mysql_data:/var/lib/mysql\n\nvolumes:\n  mysql_data:`, `68617980995313870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">my_src</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">8.0</span>\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> mysql_data<span class="token punctuation">:</span>/var/lib/mysql\n\n<span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n  mysql_data<span class="token punctuation">:</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="其它指令"><a href="#%E5%85%B6%E5%AE%83%E6%8C%87%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其它指令</h3>\n<p>此外，还有包括 domainname, entrypoint, hostname, ipc, <code class="language-text">mac_address</code>, privileged, <code class="language-text">read_only</code>, <code class="language-text">shm_size</code>, restart, <code class="language-text">stdin_open</code>, tty, user, <code class="language-text">working_dir</code> 等指令，基本跟 docker run 中对应参数的功能一致。</p>\n<p>指定服务容器启动后执行的入口文件。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57712753304637874000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`entrypoint: /code/entrypoint.sh`, `57712753304637874000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">entrypoint</span><span class="token punctuation">:</span> /code/entrypoint.sh</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>指定容器中运行应用的用户名。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86221813062711410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`user: nginx`, `86221813062711410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">user</span><span class="token punctuation">:</span> nginx</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>指定容器中工作目录。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60756138569256346000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`working_dir: /code`, `60756138569256346000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">working_dir</span><span class="token punctuation">:</span> /code</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>指定容器中搜索域名、主机名、mac 地址等。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29165310062758090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`domainname: your_website.com\nhostname: test\nmac_address: 08-00-27-00-0C-0A`, `29165310062758090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">domainname</span><span class="token punctuation">:</span> your_website.com\n<span class="token key atrule">hostname</span><span class="token punctuation">:</span> test\n<span class="token key atrule">mac_address</span><span class="token punctuation">:</span> 08<span class="token punctuation">-</span>00<span class="token punctuation">-</span>27<span class="token punctuation">-</span>00<span class="token punctuation">-</span>0C<span class="token punctuation">-</span>0A</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>允许容器中运行一些特权命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66620803937012440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`privileged: true`, `66620803937012440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>指定容器退出后的重启策略为始终重启。该命令对保持服务始终运行十分有效，在生产环境中推荐配置为 always 或者 <code class="language-text">unless-stopped</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50939590918261080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`restart: always`, `50939590918261080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">restart</span><span class="token punctuation">:</span> always</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>以只读模式挂载容器的 root 文件系统，意味着不能对容器内容进行修改。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41123228493707040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`read_only: true`, `41123228493707040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">read_only</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>打开标准输入，可以接受外部输入。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46710092651328150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`stdin_open: true`, `46710092651328150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">stdin_open</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>模拟一个伪终端。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42202909090010680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`tty: true`, `42202909090010680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="读取变量"><a href="#%E8%AF%BB%E5%8F%96%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>读取变量</h3>\n<p>Compose 模板文件支持动态读取主机的系统环境变量和当前目录下的 <code class="language-text">.env</code> 文件中的变量。</p>\n<p>例如，下面的 Compose 文件将从运行它的环境中读取变量 <code class="language-text">${MONGO_VERSION}</code> 的值，并写入执行的指令中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33652181830592885000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\nservices:\n\ndb:\n  image: \'mongo:\\${MONGO_VERSION}\'`, `33652181830592885000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n\n<span class="token key atrule">db</span><span class="token punctuation">:</span>\n  <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">\'mongo:${MONGO_VERSION}\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果执行 <code class="language-text">MONGO_VERSION=3.2 docker compose up</code> 则会启动一个 <code class="language-text">mongo:3.2</code> 镜像的容器；如果执行 <code class="language-text">MONGO_VERSION=2.8 docker compose up</code> 则会启动一个 <code class="language-text">mongo:2.8</code> 镜像的容器。</p>\n<p>若当前目录存在 <code class="language-text">.env</code> 文件，执行 <code class="language-text">docker compose</code> 命令时将从该文件中读取变量。</p>\n<p>在当前目录新建 <code class="language-text">.env</code> 文件并写入以下内容。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46248609567557800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 支持 # 号注释\nMONGO_VERSION=3.6`, `46248609567557800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 支持 # 号注释</span>\n<span class="token assign-left variable">MONGO_VERSION</span><span class="token operator">=</span><span class="token number">3.6</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>执行 <code class="language-text">docker compose up</code> 则会启动一个 <code class="language-text">mongo:3.6</code> 镜像的容器。</p>\n<h2 id="使用-django"><a href="#%E4%BD%BF%E7%94%A8-django" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 Django</h2>\n<p>我们现在将使用 Docker Compose 配置并运行一个 <code class="language-text">Django/PostgreSQL</code> 应用。</p>\n<p>在一切工作开始前，需要先编辑好三个必要的文件。</p>\n<p>第一步，因为应用将要运行在一个满足所有环境依赖的 Docker 容器里面，那么我们可以通过编辑 Dockerfile 文件来指定 Docker 容器要安装内容。内容如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19078264761391784000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM python:3\nENV PYTHONUNBUFFERED 1\nRUN mkdir /code\nWORKDIR /code\nCOPY requirements.txt /code/\nRUN pip install -r requirements.txt\nCOPY . /code/`, `19078264761391784000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> python<span class="token punctuation">:</span>3\n<span class="token keyword">ENV</span> PYTHONUNBUFFERED 1\n<span class="token keyword">RUN</span> mkdir /code\n<span class="token keyword">WORKDIR</span> /code\n<span class="token keyword">COPY</span> requirements.txt /code/\n<span class="token keyword">RUN</span> pip install <span class="token punctuation">-</span>r requirements.txt\n<span class="token keyword">COPY</span> . /code/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以上内容指定应用将使用安装了 Python 以及必要依赖包的镜像。更多关于如何编写 Dockerfile 文件的信息可以查看 Dockerfile 使用。</p>\n<p>第二步，在 <code class="language-text">requirements.txt</code> 文件里面写明需要安装的具体依赖包名。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="492564414330654000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Django>=2.0,<3.0\npsycopg2>=2.7,<3.0`, `492564414330654000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">Django&gt;=2.0,&lt;3.0\npsycopg2&gt;=2.7,&lt;3.0</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>第三步，<code class="language-text">docker-compose.yml</code> 文件将把所有的东西关联起来。它描述了应用的构成（一个 web 服务和一个数据库）、使用的 Docker 镜像、镜像之间的连接、挂载到容器的卷，以及服务开放的端口。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72111715985620010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\nservices:\n  db:\n    image: postgres\n    environment:\n      POSTGRES_PASSWORD: \'postgres\'\n\n  web:\n    build: .\n    command: python manage.py runserver 0.0.0.0:8000\n    volumes:\n      - .:/code\n    ports:\n      - \'8000:8000\'`, `72111715985620010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">db</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> postgres\n    <span class="token key atrule">environment</span><span class="token punctuation">:</span>\n      <span class="token key atrule">POSTGRES_PASSWORD</span><span class="token punctuation">:</span> <span class="token string">\'postgres\'</span>\n\n  <span class="token key atrule">web</span><span class="token punctuation">:</span>\n    <span class="token key atrule">build</span><span class="token punctuation">:</span> .\n    <span class="token key atrule">command</span><span class="token punctuation">:</span> python manage.py runserver 0.0.0.0<span class="token punctuation">:</span><span class="token number">8000</span>\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> .<span class="token punctuation">:</span>/code\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">\'8000:8000\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>查看 <code class="language-text">docker-compose.yml</code> 章节 了解更多详细的工作机制。</p>\n<p>现在我们就可以使用 <code class="language-text">docker compose run</code> 命令启动一个 Django 应用了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75898415829808380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker compose run web django-admin startproject django_example .`, `75898415829808380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker compose run web django-admin startproject django_example <span class="token builtin class-name">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>由于 web 服务所使用的镜像并不存在，所以 Compose 会首先使用 Dockerfile 为 web 服务构建一个镜像，接着使用这个镜像在容器里运行 <code class="language-text">django-admin startproject django_example</code> 指令。</p>\n<p>这将在当前目录生成一个 Django 应用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84621378126262980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ ls\nDockerfile       docker-compose.yml          django_example       manage.py       requirements.txt`, `84621378126262980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">ls</span>\nDockerfile       docker-compose.yml          django_example       manage.py       requirements.txt</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果你的系统是 Linux，记得更改文件权限。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59940856573613785000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo chown -R \\$USER:\\$USER .`, `59940856573613785000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">chown</span> -R <span class="token environment constant">$USER</span><span class="token builtin class-name">:</span><span class="token environment constant">$USER</span> <span class="token builtin class-name">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>首先，我们要为应用设置好数据库的连接信息。用以下内容替换 <code class="language-text">django_example/settings.py</code> 文件中 <code class="language-text">DATABASES = ...</code> 定义的节点内容。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10968629866900593000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`DATABASES = {\n    \'default\': {\n        \'ENGINE\': \'django.db.backends.postgresql\',\n        \'NAME\': \'postgres\',\n        \'USER\': \'postgres\',\n        \'HOST\': \'db\',\n        \'PORT\': 5432,\n        \'PASSWORD\': \'postgres\',\n    }\n}`, `10968629866900593000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">DATABASES <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'default\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        <span class="token string">\'ENGINE\'</span><span class="token punctuation">:</span> <span class="token string">\'django.db.backends.postgresql\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'NAME\'</span><span class="token punctuation">:</span> <span class="token string">\'postgres\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'USER\'</span><span class="token punctuation">:</span> <span class="token string">\'postgres\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'HOST\'</span><span class="token punctuation">:</span> <span class="token string">\'db\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'PORT\'</span><span class="token punctuation">:</span> <span class="token number">5432</span><span class="token punctuation">,</span>\n        <span class="token string">\'PASSWORD\'</span><span class="token punctuation">:</span> <span class="token string">\'postgres\'</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这些信息是在 postgres 镜像固定设置好的。然后，运行 <code class="language-text">docker compose up</code>：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13929433921164458000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker compose up\n\ndjango_db_1 is up-to-date\nCreating django_web_1 ...\nCreating django_web_1 ... done\nAttaching to django_db_1, django_web_1\ndb_1   | The files belonging to this database system will be owned by user &quot;postgres&quot;.\ndb_1   | This user must also own the server process.\ndb_1   |\ndb_1   | The database cluster will be initialized with locale &quot;en_US.utf8&quot;.\ndb_1   | The default database encoding has accordingly been set to &quot;UTF8&quot;.\ndb_1   | The default text search configuration will be set to &quot;english&quot;.\n\nweb_1  | Performing system checks...\nweb_1  |\nweb_1  | System check identified no issues (0 silenced).\nweb_1  |\nweb_1  | November 23, 2017 - 06:21:19\nweb_1  | Django version 1.11.7, using settings \'django_example.settings\'\nweb_1  | Starting development server at http://0.0.0.0:8000/\nweb_1  | Quit the server with CONTROL-C.`, `13929433921164458000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker compose up\n\ndjango_db_1 is up-to-date\nCreating django_web_1 <span class="token punctuation">..</span>.\nCreating django_web_1 <span class="token punctuation">..</span>. <span class="token keyword">done</span>\nAttaching to django_db_1, django_web_1\ndb_1   <span class="token operator">|</span> The files belonging to this database system will be owned by user <span class="token string">"postgres"</span><span class="token builtin class-name">.</span>\ndb_1   <span class="token operator">|</span> This user must also own the server process.\ndb_1   <span class="token operator">|</span>\ndb_1   <span class="token operator">|</span> The database cluster will be initialized with locale <span class="token string">"en_US.utf8"</span><span class="token builtin class-name">.</span>\ndb_1   <span class="token operator">|</span> The default database encoding has accordingly been <span class="token builtin class-name">set</span> to <span class="token string">"UTF8"</span><span class="token builtin class-name">.</span>\ndb_1   <span class="token operator">|</span> The default text search configuration will be <span class="token builtin class-name">set</span> to <span class="token string">"english"</span><span class="token builtin class-name">.</span>\n\nweb_1  <span class="token operator">|</span> Performing system checks<span class="token punctuation">..</span>.\nweb_1  <span class="token operator">|</span>\nweb_1  <span class="token operator">|</span> System check identified no issues <span class="token punctuation">(</span><span class="token number">0</span> silenced<span class="token punctuation">)</span>.\nweb_1  <span class="token operator">|</span>\nweb_1  <span class="token operator">|</span> November <span class="token number">23</span>, <span class="token number">2017</span> - 06:21:19\nweb_1  <span class="token operator">|</span> Django version <span class="token number">1.11</span>.7, using settings <span class="token string">\'django_example.settings\'</span>\nweb_1  <span class="token operator">|</span> Starting development server at http://0.0.0.0:8000/\nweb_1  <span class="token operator">|</span> Quit the server with CONTROL-C.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个 Django 应用已经开始在你的 Docker 守护进程里监听着 8000 端口了。打开 <code class="language-text">127.0.0.1:8000</code> 即可看到 Django 欢迎页面。</p>\n<p>你还可以在 Docker 上运行其它的管理命令，例如对于同步数据库结构这种事，在运行完 <code class="language-text">docker compose up</code> 后，在另外一个终端进入文件夹运行以下命令即可：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1499712549510090500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ docker compose run web python manage.py syncdb`, `1499712549510090500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ docker compose run web python manage.py syncdb</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="使用-wordpress"><a href="#%E4%BD%BF%E7%94%A8-wordpress" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 WordPress</h2>\n<p>Compose 可以很便捷的让 Wordpress 运行在一个独立的环境中。</p>\n<h3 id="创建空文件夹"><a href="#%E5%88%9B%E5%BB%BA%E7%A9%BA%E6%96%87%E4%BB%B6%E5%A4%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建空文件夹</h3>\n<p>假设新建一个名为 wordpress 的文件夹，然后进入这个文件夹。</p>\n<h3 id="创建-docker-composeyml-文件"><a href="#%E5%88%9B%E5%BB%BA-docker-composeyml-%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建 docker-compose.yml 文件</h3>\n<p><code class="language-text">docker-compose.yml</code> 文件将开启一个 wordpress 服务和一个独立的 MySQL 实例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35017150824197740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version: \'3\'\nservices:\n  db:\n    image: mysql:8.0\n    command:\n      - --default_authentication_plugin=mysql_native_password\n      - --character-set-server=utf8mb4\n      - --collation-server=utf8mb4_unicode_ci\n    volumes:\n      - db_data:/var/lib/mysql\n    restart: always\n    environment:\n      MYSQL_ROOT_PASSWORD: somewordpress\n      MYSQL_DATABASE: wordpress\n      MYSQL_USER: wordpress\n      MYSQL_PASSWORD: wordpress\n\n  wordpress:\n    depends_on:\n      - db\n    image: wordpress:latest\n    ports:\n      - \'8000:80\'\n    restart: always\n    environment:\n      WORDPRESS_DB_HOST: db:3306\n      WORDPRESS_DB_USER: wordpress\n      WORDPRESS_DB_PASSWORD: wordpress\nvolumes:\n  db_data:`, `35017150824197740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="yml"\n              >\n                <span class="gatsby-code-button-language">yml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">\'3\'</span>\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n  <span class="token key atrule">db</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">8.0</span>\n    <span class="token key atrule">command</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>default_authentication_plugin=mysql_native_password\n      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>character<span class="token punctuation">-</span>set<span class="token punctuation">-</span>server=utf8mb4\n      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>collation<span class="token punctuation">-</span>server=utf8mb4_unicode_ci\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> db_data<span class="token punctuation">:</span>/var/lib/mysql\n    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always\n    <span class="token key atrule">environment</span><span class="token punctuation">:</span>\n      <span class="token key atrule">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span> somewordpress\n      <span class="token key atrule">MYSQL_DATABASE</span><span class="token punctuation">:</span> wordpress\n      <span class="token key atrule">MYSQL_USER</span><span class="token punctuation">:</span> wordpress\n      <span class="token key atrule">MYSQL_PASSWORD</span><span class="token punctuation">:</span> wordpress\n\n  <span class="token key atrule">wordpress</span><span class="token punctuation">:</span>\n    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> db\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">:</span>latest\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">\'8000:80\'</span>\n    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always\n    <span class="token key atrule">environment</span><span class="token punctuation">:</span>\n      <span class="token key atrule">WORDPRESS_DB_HOST</span><span class="token punctuation">:</span> db<span class="token punctuation">:</span><span class="token number">3306</span>\n      <span class="token key atrule">WORDPRESS_DB_USER</span><span class="token punctuation">:</span> wordpress\n      <span class="token key atrule">WORDPRESS_DB_PASSWORD</span><span class="token punctuation">:</span> wordpress\n<span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n  db_data<span class="token punctuation">:</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="构建并运行项目"><a href="#%E6%9E%84%E5%BB%BA%E5%B9%B6%E8%BF%90%E8%A1%8C%E9%A1%B9%E7%9B%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建并运行项目</h3>\n<p>运行 <code class="language-text">docker compose up -d Compose</code> 就会拉取镜像再创建我们所需要的镜像，然后启动 wordpress 和数据库容器。接着浏览器访问 <code class="language-text">127.0.0.1:8000</code> 端口就能看到 WordPress 安装界面了。</p>\n<h1 id="kubernetes"><a href="#kubernetes" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kubernetes</h1>\n<p>Kubernetes 是 Google 团队发起并维护的基于 Docker 的开源容器集群管理系统，它不仅支持常见的云平台，而且支持内部数据中心。</p>\n<p>建于 Docker 之上的 Kubernetes 可以构建一个容器的调度服务，其目的是让用户透过 Kubernetes 集群来进行云端容器集群的管理，而无需用户进行复杂的设置工作。系统会自动选取合适的工作节点来执行具体的容器集群调度处理工作。其核心概念是 Container Pod。一个 Pod 由一组工作于同一物理工作节点的容器构成。这些组容器拥有相同的网络命名空间、IP 以及存储配额，也可以根据实际情况对每一个 Pod 进行端口映射。此外，Kubernetes 工作节点会由主系统进行管理，节点包含了能够运行 Docker 容器所用到的服务。</p>\n<h2 id="项目简介"><a href="#%E9%A1%B9%E7%9B%AE%E7%AE%80%E4%BB%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>项目简介</h2>\n<p>Kubernetes 是 Google 团队发起的开源项目，它的目标是管理跨多个主机的容器，提供基本的部署，维护以及应用伸缩，主要实现语言为 Go 语言。Kubernetes 是：</p>\n<ul>\n<li>易学：轻量级，简单，容易理解</li>\n<li>便携：支持公有云，私有云，混合云，以及多种云平台</li>\n<li>可拓展：模块化，可插拔，支持钩子，可任意组合</li>\n<li>自修复：自动重调度，自动重启，自动复制</li>\n</ul>\n<p>Kubernetes 构建于 Google 数十年经验，一大半来源于 Google 生产环境规模的经验。结合了社区最佳的想法和实践。</p>\n<p>在分布式系统中，部署，调度，伸缩一直是最为重要的也最为基础的功能。Kubernetes 就是希望解决这一序列问题的。</p>\n<p>Kubernetes 目前在 GitHub 进行维护。</p>\n<p>Kubernetes 能够运行在任何地方，虽然 Kubernetes 最初是为 GCE 定制的，但是在后续版本中陆续增加了其他云平台的支持，以及本地数据中心的支持。</p>\n<h2 id="基本概念-2"><a href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基本概念</h2>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-21-13-57-53-fd3ac202ab3ce44debd1a2ecb18e11e0-14d8a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 72.9113924050633%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAACIElEQVQ4y3WUW3PaMBCF+f9/pI+dPqXtS/rQp06GduiQkAAhBHMxli+yLcuyJJ+ujA02NJrRaLSWPp2zuzACjbquB5Mi7QporZDmIe0NlOLIshx5fprWWnT3uzHqb7rRD2UixnL9G6USKGWMMAwQBAxJEp9BA2AX0Ma2s8aWcby8+whTiaLMsN5OwXNGJyvkWQzOU1RVdQM7A20L7CyrSqOQCs5QVkR4+HOH8eQbWOy50wRkiCKn0P5foQMa035E+5EWoyh//Ihd8ArvMEcSehDhEWWRU27NTb7degHa21wqKRDt18hWS1hRINtsMPv8CWLv4VJMDFSOXMS63NGL1pgGHGcSe5ZAVBQvCwTPU4iYITvssLj7gv2vnwieJtD0IOo2VW01RzXZKrwd+PIN8sga62EqsPEjpIWiB8gaTumItytsH8dID3tE3hpSSVTUVrXRPctOIVVMl1Q1UggMrZcFh794gKkKeC9j+G/T5gQ1A7nSDbAi4MVyUzecc9hVumtaSYcXEcMxz6AERyVz1A6kNCk89awD2gHQXqp8PUICfJ1N8Zdsui7RNJWiNtMnEQ6mrRkq7BrbHXCTcYF3P6QeVAQU+LGa45EFDdAQ0QmwtNF2CGty2G1sY/M0k1ziEHIIyqtTeP86xyzwnRV60DYQp8xY2/u5Xin8aDiF35+fMPF3VAjTwExPVf/+QOH1P04XL0mJlyYNuB/v3+lD/wHACZHo21IUiAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 21 13 57 53" title="" data-src="/static/2022-07-21-13-57-53-fd3ac202ab3ce44debd1a2ecb18e11e0-fee1c.png" data-srcset="/static/2022-07-21-13-57-53-fd3ac202ab3ce44debd1a2ecb18e11e0-a67b7.png 200w,\n/static/2022-07-21-13-57-53-fd3ac202ab3ce44debd1a2ecb18e11e0-0b187.png 400w,\n/static/2022-07-21-13-57-53-fd3ac202ab3ce44debd1a2ecb18e11e0-fee1c.png 800w,\n/static/2022-07-21-13-57-53-fd3ac202ab3ce44debd1a2ecb18e11e0-14d8a.png 1185w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<ul>\n<li>节点（Node）：一个节点是一个运行 Kubernetes 中的主机。</li>\n<li>容器组（Pod）：一个 Pod 对应于由若干容器组成的一个容器组，同个组内的容器共享一个存储卷(volume)。</li>\n<li>容器组生命周期（pos-states）：包含所有容器状态集合，包括容器组状态类型，容器组生命周期，事件，重启策略，以及 <code class="language-text">replication controllers</code>。</li>\n<li>Replication Controllers：主要负责指定数量的 pod 在同一时间一起运行。</li>\n<li>服务（services）：一个 Kubernetes 服务是容器组逻辑的高级抽象，同时也对外提供访问容器组的策略。</li>\n<li>卷（volumes）：一个卷就是一个目录，容器对其有访问权限。</li>\n<li>标签（labels）：标签是用来连接一组对象的，比如容器组。标签可以被用来组织和选择子对象。</li>\n<li>接口权限（<code class="language-text">accessing_the_api</code>）：端口，IP 地址和代理的防火墙规则。</li>\n<li>web 界面（ux）：用户可以通过 web 界面操作 Kubernetes。</li>\n<li>命令行操作（cli）：kubectl 命令。</li>\n</ul>\n<h3 id="节点-1"><a href="#%E8%8A%82%E7%82%B9-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>节点</h3>\n<p>在 Kubernetes 中，节点是实际工作的点，节点可以是虚拟机或者物理机器，依赖于一个集群环境。每个节点都有一些必要的服务以运行容器组，并且它们都可以通过主节点来管理。必要服务包括 Docker，kubelet 和代理服务。</p>\n<h4 id="容器状态"><a href="#%E5%AE%B9%E5%99%A8%E7%8A%B6%E6%80%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器状态</h4>\n<p>容器状态用来描述节点的当前状态。现在，其中包含三个信息：</p>\n<h5 id="主机-ip"><a href="#%E4%B8%BB%E6%9C%BA-ip" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>主机 IP</h5>\n<p>主机 IP 需要云平台来查询，Kubernetes 把它作为状态的一部分来保存。如果 Kubernetes 没有运行在云平台上，节点 ID 就是必需的。IP 地址可以变化，并且可以包含多种类型的 IP 地址，如公共 IP，私有 IP，动态 IP，ipv6 等等。</p>\n<h5 id="节点周期"><a href="#%E8%8A%82%E7%82%B9%E5%91%A8%E6%9C%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>节点周期</h5>\n<p>通常来说节点有 Pending，Running，Terminated 三个周期，如果 Kubernetes 发现了一个节点并且其可用，那么 Kubernetes 就把它标记为 Pending。然后在某个时刻，Kubernetes 将会标记其为 Running。节点的结束周期称为 Terminated。一个已经 Terminated 的节点不会接受和调度任何请求，并且已经在其上运行的容器组也会删除。</p>\n<h5 id="节点状态"><a href="#%E8%8A%82%E7%82%B9%E7%8A%B6%E6%80%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>节点状态</h5>\n<p>节点的状态主要是用来描述处于 Running 的节点。当前可用的有 NodeReachable 和 NodeReady。以后可能会增加其他状态。NodeReachable 表示集群可达。NodeReady 表示 kubelet 返回 Status Ok 并且 HTTP 状态检查健康。</p>\n<h4 id="节点管理"><a href="#%E8%8A%82%E7%82%B9%E7%AE%A1%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>节点管理</h4>\n<p>节点并非 Kubernetes 创建，而是由云平台创建，或者就是物理机器、虚拟机。在 Kubernetes 中，节点仅仅是一条记录，节点创建之后，Kubernetes 会检查其是否可用。在 Kubernetes 中，节点用如下结构保存：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90088757290788670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;id&quot;: &quot;10.1.2.3&quot;,\n  &quot;kind&quot;: &quot;Minion&quot;,\n  &quot;apiVersion&quot;: &quot;v1beta1&quot;,\n  &quot;resources&quot;: {\n    &quot;capacity&quot;: {\n      &quot;cpu&quot;: 1000,\n      &quot;memory&quot;: 1073741824\n    }\n  },\n  &quot;labels&quot;: {\n    &quot;name&quot;: &quot;my-first-k8s-node&quot;\n  }\n}`, `90088757290788670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"10.1.2.3"</span><span class="token punctuation">,</span>\n  <span class="token property">"kind"</span><span class="token operator">:</span> <span class="token string">"Minion"</span><span class="token punctuation">,</span>\n  <span class="token property">"apiVersion"</span><span class="token operator">:</span> <span class="token string">"v1beta1"</span><span class="token punctuation">,</span>\n  <span class="token property">"resources"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token property">"capacity"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"cpu"</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>\n      <span class="token property">"memory"</span><span class="token operator">:</span> <span class="token number">1073741824</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token property">"labels"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"my-first-k8s-node"</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Kubernetes 校验节点可用依赖于 ID。在当前的版本中，有两个接口可以用来管理节点：节点控制和 Kube 管理。</p>\n<h4 id="节点控制"><a href="#%E8%8A%82%E7%82%B9%E6%8E%A7%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>节点控制</h4>\n<p>在 Kubernetes 主节点中，节点控制器是用来管理节点的组件。主要包含：</p>\n<ul>\n<li>集群范围内节点同步</li>\n<li>单节点生命周期管理</li>\n</ul>\n<p>节点控制有一个同步轮询，主要监听所有云平台的虚拟实例，会根据节点状态创建和删除。可以通过 <code class="language-text">--node_sync_period</code> 标志来控制该轮询。如果一个实例已经创建，节点控制将会为其创建一个结构。同样的，如果一个节点被删除，节点控制也会删除该结构。在 Kubernetes 启动时可用通过 <code class="language-text">--machines</code> 标记来显示指定节点。同样可以使用 kubectl 来一条一条的添加节点，两者是相同的。通过设置 <code class="language-text">--sync_nodes=false</code> 标记来禁止集群之间的节点同步，你也可以使用 <code class="language-text">api/kubectl</code> 命令行来增删节点。</p>\n<h3 id="容器组"><a href="#%E5%AE%B9%E5%99%A8%E7%BB%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器组</h3>\n<p>在 Kubernetes 中，使用的最小单位是容器组，容器组是创建，调度，管理的最小单位。一个容器组使用相同的 Docker 容器并共享卷（挂载点）。一个容器组是一个特定应用的打包集合，包含一个或多个容器。</p>\n<p>和运行的容器类似，一个容器组被认为只有很短的运行周期。容器组被调度到一组节点运行，直到容器的生命周期结束或者其被删除。如果节点死掉，运行在其上的容器组将会被删除而不是重新调度。（也许在将来的版本中会添加容器组的移动）。</p>\n<h4 id="容器组设计的初衷"><a href="#%E5%AE%B9%E5%99%A8%E7%BB%84%E8%AE%BE%E8%AE%A1%E7%9A%84%E5%88%9D%E8%A1%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器组设计的初衷</h4>\n<h4 id="资源共享和通信"><a href="#%E8%B5%84%E6%BA%90%E5%85%B1%E4%BA%AB%E5%92%8C%E9%80%9A%E4%BF%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>资源共享和通信</h4>\n<p>容器组主要是为了数据共享和它们之间的通信。</p>\n<p>在一个容器组中，容器都使用相同的网络地址和端口，可以通过本地网络来相互通信。每个容器组都有独立的 IP，可用通过网络来和其他物理主机或者容器通信。</p>\n<p>容器组有一组存储卷（挂载点），主要是为了让容器在重启之后可以不丢失数据。</p>\n<h4 id="容器组管理"><a href="#%E5%AE%B9%E5%99%A8%E7%BB%84%E7%AE%A1%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器组管理</h4>\n<p>容器组是一个应用管理和部署的高层次抽象，同时也是一组容器的接口。容器组是部署、水平放缩的最小单位。</p>\n<h4 id="容器组的使用"><a href="#%E5%AE%B9%E5%99%A8%E7%BB%84%E7%9A%84%E4%BD%BF%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器组的使用</h4>\n<p>容器组可以通过组合来构建复杂的应用，其本来的意义包含：</p>\n<ul>\n<li>内容管理，文件和数据加载以及本地缓存管理等。</li>\n<li>日志和检查点备份，压缩，快照等。</li>\n<li>监听数据变化，跟踪日志，日志和监控代理，消息发布等。</li>\n<li>代理，网桥</li>\n<li>控制器，管理，配置以及更新</li>\n</ul>\n<h4 id="替代方案"><a href="#%E6%9B%BF%E4%BB%A3%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>替代方案</h4>\n<p>为什么不在一个单一的容器里运行多个程序？</p>\n<ul>\n<li>透明化。为了使容器组中的容器保持一致的基础设施和服务，比如进程管理和资源监控。这样设计是为了用户的便利性。</li>\n<li>解偶软件之间的依赖。每个容器都可能重新构建和发布，Kubernetes 必须支持热发布和热更新（将来）。</li>\n<li>方便使用。用户不必运行独立的程序管理，也不用担心每个应用程序的退出状态。</li>\n<li>高效。考虑到基础设施有更多的职责，容器必须要轻量化。</li>\n</ul>\n<h4 id="容器组的生命状态"><a href="#%E5%AE%B9%E5%99%A8%E7%BB%84%E7%9A%84%E7%94%9F%E5%91%BD%E7%8A%B6%E6%80%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器组的生命状态</h4>\n<p>包括若干状态值：pending、running、succeeded、failed。</p>\n<h5 id="pending"><a href="#pending" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pending</h5>\n<p>容器组已经被节点接受，但有一个或多个容器还没有运行起来。这将包含某些节点正在下载镜像的时间，这种情形会依赖于网络情况。</p>\n<h5 id="running"><a href="#running" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>running</h5>\n<p>容器组已经被调度到节点，并且所有的容器都已经启动。至少有一个容器处于运行状态（或者处于重启状态）。</p>\n<h5 id="succeeded"><a href="#succeeded" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>succeeded</h5>\n<p>所有的容器都正常退出。</p>\n<h5 id="failed"><a href="#failed" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>failed</h5>\n<p>容器组中所有容器都意外中断了。</p>\n<h4 id="容器组生命周期"><a href="#%E5%AE%B9%E5%99%A8%E7%BB%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>容器组生命周期</h4>\n<p>通常来说，如果容器组被创建了就不会自动销毁，除非被某种行为触发，而触发此种情况可能是人为，或者复制控制器所为。唯一例外的是容器组由 succeeded 状态成功退出，或者在一定时间内重试多次依然失败。</p>\n<p>如果某个节点死掉或者不能连接，那么节点控制器将会标记其上的容器组的状态为 failed。</p>\n<p>举例如下：</p>\n<ul>\n<li>\n<p>容器组状态 running，有 1 容器，容器正常退出</p>\n<ul>\n<li>记录完成事件</li>\n<li>\n<p>如果重启策略为：</p>\n<ul>\n<li>始终：重启容器，容器组保持 running</li>\n<li>失败时：容器组变为 succeeded</li>\n<li>从不：容器组变为 succeeded</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>容器组状态 running，有 1 容器，容器异常退出</p>\n<ul>\n<li>记录失败事件</li>\n<li>\n<p>如果重启策略为：</p>\n<ul>\n<li>始终：重启容器，容器组保持 running</li>\n<li>失败时：重启容器，容器组保持 running</li>\n<li>从不：容器组变为 failed</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>容器组状态 running，有 2 容器，有 1 容器异常退出</p>\n<ul>\n<li>记录失败事件</li>\n<li>\n<p>如果重启策略为：</p>\n<ul>\n<li>始终：重启容器，容器组保持 running</li>\n<li>失败时：重启容器，容器组保持 running</li>\n<li>从不：容器组保持 running</li>\n</ul>\n</li>\n<li>\n<p>当有 2 容器退出</p>\n<ul>\n<li>记录失败事件</li>\n<li>如果重启策略为：</li>\n<li>始终：重启容器，容器组保持 running</li>\n<li>失败时：重启容器，容器组保持 running</li>\n<li>从不：容器组变为 failed</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>容器组状态 running，容器内存不足</p>\n<ul>\n<li>标记容器错误中断</li>\n<li>记录内存不足事件</li>\n<li>\n<p>如果重启策略为：</p>\n<ul>\n<li>始终：重启容器，容器组保持 running</li>\n<li>失败时：重启容器，容器组保持 running</li>\n<li>从不：记录错误事件，容器组变为 failed</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>容器组状态 running，一块磁盘死掉</p>\n<ul>\n<li>杀死所有容器</li>\n<li>记录事件</li>\n<li>容器组变为 failed</li>\n<li>如果容器组运行在一个控制器下，容器组将会在其他地方重新创建</li>\n</ul>\n</li>\n<li>\n<p>容器组状态 running，对应的节点段溢出</p>\n<ul>\n<li>节点控制器等到超时</li>\n<li>节点控制器标记容器组 failed</li>\n<li>如果容器组运行在一个控制器下，容器组将会在其他地方重新创建</li>\n</ul>\n</li>\n</ul>\n<h3 id="replication-controllers"><a href="#replication-controllers" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Replication Controllers</h3>\n<h3 id="服务"><a href="#%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>服务</h3>\n<h3 id="卷"><a href="#%E5%8D%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>卷</h3>\n<h3 id="标签"><a href="#%E6%A0%87%E7%AD%BE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>标签</h3>\n<h3 id="接口权限"><a href="#%E6%8E%A5%E5%8F%A3%E6%9D%83%E9%99%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>接口权限</h3>\n<h3 id="web-界面"><a href="#web-%E7%95%8C%E9%9D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>web 界面</h3>\n<h3 id="命令行操作"><a href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%93%8D%E4%BD%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>命令行操作</h3>\n<h2 id="基本架构"><a href="#%E5%9F%BA%E6%9C%AC%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基本架构</h2>\n<p>任何优秀的项目都离不开优秀的架构设计。本小节将介绍 Kubernetes 在架构方面的设计考虑。</p>\n<h3 id="基本考虑"><a href="#%E5%9F%BA%E6%9C%AC%E8%80%83%E8%99%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基本考虑</h3>\n<p>如果让我们自己从头设计一套容器管理平台，有如下几个方面是很容易想到的：</p>\n<ul>\n<li>分布式架构，保证扩展性；</li>\n<li>逻辑集中式的控制平面 + 物理分布式的运行平面；</li>\n<li>一套资源调度系统，管理哪个容器该分配到哪个节点上；</li>\n<li>一套对容器内服务进行抽象和 HA 的系统。</li>\n</ul>\n<h3 id="运行原理"><a href="#%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行原理</h3>\n<p>下面这张图完整展示了 Kubernetes 的运行原理。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-21-14-00-05-3cb63ed775a330b1fee7a73fc1fb5bef-ed8e3.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 82.67736274755578%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAAC40lEQVQ4y42Uy05TURSGdwvWBJo4cWhECZBooi/gSAdgQuLYqT6FM57AARMMjVPHJAQmJISJRChKS7nfb+VSWsqtLW3PZfv9h9QUUhNWsrL3Xnuvf/3rco4xyObmZmh7e7t5a2urmTUsm+u6JpVKmXpZW1sL1v7+/gfZbDZ5dHTUp7O1Njw5OXnzaH193dyVUql06zw1NWWOj4/N6elpaH9/XwAi0bu6uvpK92dnZ6Hz83NzdXV147CxsfEMZl/QPlh+qDFcWFgwIyMjppFMT09/RrsaXuL4iPTe8ODtyspKp2yVSsUsLS0F98PDwyEYtsIsure3Fz04OGidmJhow+cxBFogFJXCOmoODw+b7gZIp9NNpBBeXFwM7ubm5p4AmKZu+XK5nPU8L8c5c3l5mSWTHMFz1Wo1WM19hLQ7qKsDgC0WixZnS70sNgu4rRdDp3qI1kP93ieTyV5YdOdyuW4Y9s7Ozr4W4MzMTBtARZoiIO/i4sLDx+ONR0O8TCYT2LQ3iiAFxJKqvb6+1tlXNAC+C3B5efk57AqUx+bzeRdnF0AXAJcSuJByAXcBds3JyYnPYx9AHwcfEL9QKFQF6DjOVwHSnHaliHOQKnZbS18iGz6BGlL0BQq6D0OfaL4i6yEs/hDoE015CoNfOKZwSgCWZA20fs+bpIbU2d3ddQB0YOcA7uDoAFRSRB7ZnZ2dFurYxFA/HBgYiEgpQ2R0dDQyODgYicVigQ4NDUXM3S7VC0zjgLxjxtqp3U8C/mY04qQcZx8nYLCnFHHZpfo+Y7CLUY8YY1DTb1z+AOyjagjbLtVNY8LcBcG4/7e/NTb3kPDY2NgLApbUOHVYHVVn1XGYupQp6Dilcg3GsP4WjZSCB1/K+Pj4S4AqgKi7AlXD/Npwaw+gpsUahtkkEolbykCb+fl5w3caEiBrB85lDbamQqACEWOlrinRdCjA//MMh/UXCgD5CXSSZllscAocG6mY/wXzi5HTlj2WkwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 21 14 00 05" title="" data-src="/static/2022-07-21-14-00-05-3cb63ed775a330b1fee7a73fc1fb5bef-fee1c.png" data-srcset="/static/2022-07-21-14-00-05-3cb63ed775a330b1fee7a73fc1fb5bef-a67b7.png 200w,\n/static/2022-07-21-14-00-05-3cb63ed775a330b1fee7a73fc1fb5bef-0b187.png 400w,\n/static/2022-07-21-14-00-05-3cb63ed775a330b1fee7a73fc1fb5bef-fee1c.png 800w,\n/static/2022-07-21-14-00-05-3cb63ed775a330b1fee7a73fc1fb5bef-b1a91.png 1200w,\n/static/2022-07-21-14-00-05-3cb63ed775a330b1fee7a73fc1fb5bef-95179.png 1600w,\n/static/2022-07-21-14-00-05-3cb63ed775a330b1fee7a73fc1fb5bef-5d5ba.png 2400w,\n/static/2022-07-21-14-00-05-3cb63ed775a330b1fee7a73fc1fb5bef-ed8e3.png 3989w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可见，Kubernetes 首先是一套分布式系统，由多个节点组成，节点分为两类：一类是属于管理平面的主节点/控制节点（Master Node）；一类是属于运行平面的工作节点（Worker Node）。</p>\n<p>显然，复杂的工作肯定都交给控制节点去做了，工作节点负责提供稳定的操作接口和能力抽象即可。</p>\n<p>从这张图上，我们没有能发现 Kubernetes 中对于控制平面的分布式实现，但是由于数据后端自身就是一套分布式的数据库 Etcd，因此可以很容易扩展到分布式实现。</p>\n<h3 id="控制平面"><a href="#%E6%8E%A7%E5%88%B6%E5%B9%B3%E9%9D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>控制平面</h3>\n<h4 id="主节点服务"><a href="#%E4%B8%BB%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>主节点服务</h4>\n<p>主节点上需要提供如下的管理服务：</p>\n<ul>\n<li>apiserver 是整个系统的对外接口，提供一套 RESTful 的 Kubernetes API，供客户端和其它组件调用；</li>\n<li>scheduler 负责对资源进行调度，分配某个 pod 到某个节点上。是 pluggable 的，意味着很容易选择其它实现方式；</li>\n<li>controller-manager 负责管理控制器，包括 endpoint-controller（刷新服务和 pod 的关联信息）和 replication-controller（维护某个 pod 的复制为配置的数值）。</li>\n</ul>\n<h4 id="etcd"><a href="#etcd" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Etcd</h4>\n<p>这里 Etcd 即作为数据后端，又作为消息中间件。</p>\n<p>通过 Etcd 来存储所有的主节点上的状态信息，很容易实现主节点的分布式扩展。</p>\n<p>组件可以自动的去侦测 Etcd 中的数值变化来获得通知，并且获得更新后的数据来执行相应的操作。</p>\n<h3 id="工作节点"><a href="#%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>工作节点</h3>\n<ul>\n<li>kubelet 是工作节点执行操作的 agent，负责具体的容器生命周期管理，根据从数据库中获取的信息来管理容器，并上报 pod 运行状态等；</li>\n<li>kube-proxy 是一个简单的网络访问代理，同时也是一个 Load Balancer。它负责将访问到某个服务的请求具体分配给工作节点上的 Pod（同一类标签）。</li>\n</ul>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-21-14-00-36-e698f3ab278a195326c9cb6bd38ace5b-80d40.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 640px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 77.1875%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAADYklEQVQ4y2MonHnQpnTZpf9Va2//r914/3/Fymv/q9bf/V+05PzhgoVn5lRvuPe/Yu2tP+Wrb/wvXnbxD5D9P2/+yVYg+yGIXbnuzr+ylVf/lwDNKF568T+DUu1s5czFZ18Vb7j3JnvZxVeF6++8bN7/8X/p8ssnMqbunV+/7RlI02+ghn91W5/+a9777n/GtL3d+QtOPa3b+uR/yfLL/yuBjmnc+Qqo7vZ/hl1zTkxcMe/U4ZULzhxeNf/M4XVLLh7qXHwh0ia+3NnILcy3YftTq4Di/lDX5Jrkmo13LYuWnHVUM3f1jW5eZle64qpN7pyjtkCXWQN9YJM5fZ8dw/X1D/5fXH4dhP9dXnnz//1NT/+enrxPlwECOBgQgBNKcwExPxAzAzEjkjp2MKshs12zLLnBpDSpzqwyrdkkI6LQTExURpeLn1vr////LN4pjnLOkVaywXkekv4ZLtLGzgYyyvqq3Hyi8jySKjo8UmoGXIIS8gLCMsp8weXTmGE2iwGxFBCLwFw1cU9GxdY3Tf+nH835v+hyyf/5F4r+zT1b+B8kNu9sYQhIDdBCBgzgbevPbGvkwColKs0jIiDKb2atzwMS796W4rX4cuna+eeKZ804lreye0vqjnlni+cvuly6smtLsiVIjZa5HDvUQWwMWIAEECsBsQI7J5s6lM8ElZMBYhYoWxToCUVuPk5BIJsXiKWBWACbgSD/MysoyLPADOqa0Kp6+cqlDafPnNp5/OSx3H0H9ub4hDmLMJAK5OUUmG7cuLH77du3/79///7/yZMnYPzv37//9+7dO3j69OmINWvWgGKawcvLixGnQdOmTYMxGa9du7b80aOHj+/fv/fuxfPn/x89fPgfSH/5+fPn/5cvX/4/ePCgIzRiGPG67tSZi6j8Gx/Fl61YWzpjzpKQuq4FMms27HCaN2++JlCKlYeHh42JiYkFmgYxDX7+/DlDsh2E3V+fxLZnXprx2RXJOuVRqpYTiqxt+kpcnXNDNa2hMSvMyMggBI0YcZAFGAaWlpYyrOqPA9vUXuQt+/JIw9eH+2r/n19f/P/kqoI/L480/n+0v+7l3iVl3ERHSFeJD9jAgng72d1z07/tX5D5f/us1P+bpiX9P7go6//m6clvajJcwGk1KdgMw5sAw+qSauVPs7gAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 21 14 00 36" title="" data-src="/static/2022-07-21-14-00-36-e698f3ab278a195326c9cb6bd38ace5b-80d40.png" data-srcset="/static/2022-07-21-14-00-36-e698f3ab278a195326c9cb6bd38ace5b-5da91.png 200w,\n/static/2022-07-21-14-00-36-e698f3ab278a195326c9cb6bd38ace5b-08121.png 400w,\n/static/2022-07-21-14-00-36-e698f3ab278a195326c9cb6bd38ace5b-80d40.png 640w" data-sizes="(max-width: 640px) 100vw, 640px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="部署-kubernetes"><a href="#%E9%83%A8%E7%BD%B2-kubernetes" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>部署 Kubernetes</h2>\n<p>目前，Kubernetes 支持在多种环境下使用，包括本地主机（Ubuntu、Debian、CentOS、Fedora 等）、云服务（腾讯云、阿里云、百度云等）。</p>\n<p>你可以使用以下几种方式部署 Kubernetes：</p>\n<ul>\n<li>kubeadm</li>\n<li>docker-desktop</li>\n<li>k3s</li>\n</ul>\n<p>接下来的小节会对以上几种方式进行详细介绍。</p>\n<h3 id="使用-kubeadm-部署-kubernetescri-使用-containerd"><a href="#%E4%BD%BF%E7%94%A8-kubeadm-%E9%83%A8%E7%BD%B2-kubernetescri-%E4%BD%BF%E7%94%A8-containerd" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 kubeadm 部署 kubernetes(CRI 使用 containerd)</h3>\n<p>kubeadm 提供了 kubeadm init 以及 kubeadm join 这两个命令作为快速创建 kubernetes 集群的最佳实践。</p>\n<h4 id="安装-containerd"><a href="#%E5%AE%89%E8%A3%85-containerd" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>安装 containerd</h4>\n<p>参考 安装 Docker 一节添加 <code class="language-text">apt/yum</code> 源，之后执行如下命令。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36592964403377160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# debian 系\n\\$ sudo apt install containerd.io\n\n# rhel 系\n\\$ sudo yum install containerd.io`, `36592964403377160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># debian 系</span>\n$ <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> containerd.io\n\n<span class="token comment"># rhel 系</span>\n$ <span class="token function">sudo</span> yum <span class="token function">install</span> containerd.io</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="配置-containerd"><a href="#%E9%85%8D%E7%BD%AE-containerd" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配置 containerd</h4>\n<p>新建 <code class="language-text">/etc/systemd/system/cri-containerd.service</code> 文件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8181174229009036000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[Unit]\nDescription=containerd container runtime for kubernetes\nDocumentation=https://containerd.io\nAfter=network.target local-fs.target\n\n[Service]\nExecStartPre=-/sbin/modprobe overlay\nExecStart=/usr/bin/containerd --config //etc/cri-containerd/config.toml\n\nType=notify\nDelegate=yes\nKillMode=process\nRestart=always\nRestartSec=5\n# Having non-zero Limit*s causes performance problems due to accounting overhead\n# in the kernel. We recommend using cgroups to do container-local accounting.\nLimitNPROC=infinity\nLimitCORE=infinity\nLimitNOFILE=infinity\n# Comment TasksMax if your systemd version does not supports it.\n# Only systemd 226 and above support this version.\nTasksMax=infinity\nOOMScoreAdjust=-999\n\n[Install]\nWantedBy=multi-user.target`, `8181174229009036000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">[Unit]\nDescription=containerd container runtime for kubernetes\nDocumentation=https://containerd.io\nAfter=network.target local-fs.target\n\n[Service]\nExecStartPre=-/sbin/modprobe overlay\nExecStart=/usr/bin/containerd --config //etc/cri-containerd/config.toml\n\nType=notify\nDelegate=yes\nKillMode=process\nRestart=always\nRestartSec=5\n# Having non-zero Limit*s causes performance problems due to accounting overhead\n# in the kernel. We recommend using cgroups to do container-local accounting.\nLimitNPROC=infinity\nLimitCORE=infinity\nLimitNOFILE=infinity\n# Comment TasksMax if your systemd version does not supports it.\n# Only systemd 226 and above support this version.\nTasksMax=infinity\nOOMScoreAdjust=-999\n\n[Install]\nWantedBy=multi-user.target</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>新建 <code class="language-text">/etc/cri-containerd/config.toml</code> containerd 配置文件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27816680713208420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`version = 2\n# persistent data location\nroot = &quot;/var/lib/cri-containerd&quot;\n# runtime state information\nstate = &quot;/run/cri-containerd&quot;\nplugin_dir = &quot;&quot;\ndisabled_plugins = []\nrequired_plugins = []\n# set containerd\'s OOM score\noom_score = 0\n\n[grpc]\n  address = &quot;/run/cri-containerd/cri-containerd.sock&quot;\n  tcp_address = &quot;&quot;\n  tcp_tls_cert = &quot;&quot;\n  tcp_tls_key = &quot;&quot;\n  # socket uid\n  uid = 0\n  # socket gid\n  gid = 0\n  max_recv_message_size = 16777216\n  max_send_message_size = 16777216\n\n[debug]\n  address = &quot;&quot;\n  format = &quot;json&quot;\n  uid = 0\n  gid = 0\n  level = &quot;&quot;\n\n[metrics]\n  address = &quot;127.0.0.1:1338&quot;\n  grpc_histogram = false\n\n[cgroup]\n  path = &quot;&quot;\n\n[timeouts]\n  &quot;io.containerd.timeout.shim.cleanup&quot; = &quot;5s&quot;\n  &quot;io.containerd.timeout.shim.load&quot; = &quot;5s&quot;\n  &quot;io.containerd.timeout.shim.shutdown&quot; = &quot;3s&quot;\n  &quot;io.containerd.timeout.task.state&quot; = &quot;2s&quot;\n\n[plugins]\n  [plugins.&quot;io.containerd.gc.v1.scheduler&quot;]\n    pause_threshold = 0.02\n    deletion_threshold = 0\n    mutation_threshold = 100\n    schedule_delay = &quot;0s&quot;\n    startup_delay = &quot;100ms&quot;\n  [plugins.&quot;io.containerd.grpc.v1.cri&quot;]\n    disable_tcp_service = true\n    stream_server_address = &quot;127.0.0.1&quot;\n    stream_server_port = &quot;0&quot;\n    stream_idle_timeout = &quot;4h0m0s&quot;\n    enable_selinux = false\n    selinux_category_range = 1024\n    sandbox_image = &quot;registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5&quot;\n    stats_collect_period = 10\n    # systemd_cgroup = false\n    enable_tls_streaming = false\n    max_container_log_line_size = 16384\n    disable_cgroup = false\n    disable_apparmor = false\n    restrict_oom_score_adj = false\n    max_concurrent_downloads = 3\n    disable_proc_mount = false\n    unset_seccomp_profile = &quot;&quot;\n    tolerate_missing_hugetlb_controller = true\n    disable_hugetlb_controller = true\n    ignore_image_defined_volumes = false\n    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd]\n      snapshotter = &quot;overlayfs&quot;\n      default_runtime_name = &quot;runc&quot;\n      no_pivot = false\n      disable_snapshot_annotations = false\n      discard_unpacked_layers = false\n      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes]\n        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc]\n          runtime_type = &quot;io.containerd.runc.v2&quot;\n          pod_annotations = []\n          container_annotations = []\n          privileged_without_host_devices = false\n          base_runtime_spec = &quot;&quot;\n          [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]\n            # SystemdCgroup enables systemd cgroups.\n            SystemdCgroup = true\n            # BinaryName is the binary name of the runc binary.\n            # BinaryName = &quot;runc&quot;\n            # BinaryName = &quot;crun&quot;\n            # NoPivotRoot disables pivot root when creating a container.\n            # NoPivotRoot = false\n\n            # NoNewKeyring disables new keyring for the container.\n            # NoNewKeyring = false\n\n            # ShimCgroup places the shim in a cgroup.\n            # ShimCgroup = &quot;&quot;\n\n            # IoUid sets the I/O\'s pipes uid.\n            # IoUid = 0\n\n            # IoGid sets the I/O\'s pipes gid.\n            # IoGid = 0\n\n            # Root is the runc root directory.\n            Root = &quot;&quot;\n\n            # CriuPath is the criu binary path.\n            # CriuPath = &quot;&quot;\n\n            # CriuImagePath is the criu image path\n            # CriuImagePath = &quot;&quot;\n\n            # CriuWorkPath is the criu work path.\n            # CriuWorkPath = &quot;&quot;\n    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.cni]\n      bin_dir = &quot;/opt/cni/bin&quot;\n      conf_dir = &quot;/etc/cni/net.d&quot;\n      max_conf_num = 1\n      conf_template = &quot;&quot;\n    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry]\n      config_path = &quot;/etc/cri-containerd/certs.d&quot;\n      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.headers]\n        # Foo = [&quot;bar&quot;]\n    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.image_decryption]\n      key_model = &quot;&quot;\n    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.x509_key_pair_streaming]\n      tls_cert_file = &quot;&quot;\n      tls_key_file = &quot;&quot;\n  [plugins.&quot;io.containerd.internal.v1.opt&quot;]\n    path = &quot;/opt/cri-containerd&quot;\n  [plugins.&quot;io.containerd.internal.v1.restart&quot;]\n    interval = &quot;10s&quot;\n  [plugins.&quot;io.containerd.metadata.v1.bolt&quot;]\n    content_sharing_policy = &quot;shared&quot;\n  [plugins.&quot;io.containerd.monitor.v1.cgroups&quot;]\n    no_prometheus = false\n  [plugins.&quot;io.containerd.runtime.v2.task&quot;]\n    platforms = [&quot;linux/amd64&quot;]\n  [plugins.&quot;io.containerd.service.v1.diff-service&quot;]\n    default = [&quot;walking&quot;]\n  [plugins.&quot;io.containerd.snapshotter.v1.devmapper&quot;]\n    root_path = &quot;&quot;\n    pool_name = &quot;&quot;\n    base_image_size = &quot;&quot;\n    async_remove = false`, `27816680713208420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="toml"\n              >\n                <span class="gatsby-code-button-language">toml</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="toml"><pre style="counter-reset: linenumber NaN" class="language-toml line-numbers"><code class="language-toml"><span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token number">2</span>\n<span class="token comment"># persistent data location</span>\n<span class="token key property">root</span> <span class="token punctuation">=</span> <span class="token string">"/var/lib/cri-containerd"</span>\n<span class="token comment"># runtime state information</span>\n<span class="token key property">state</span> <span class="token punctuation">=</span> <span class="token string">"/run/cri-containerd"</span>\n<span class="token key property">plugin_dir</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n<span class="token key property">disabled_plugins</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token key property">required_plugins</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token comment"># set containerd\'s OOM score</span>\n<span class="token key property">oom_score</span> <span class="token punctuation">=</span> <span class="token number">0</span>\n\n<span class="token punctuation">[</span><span class="token table class-name">grpc</span><span class="token punctuation">]</span>\n  <span class="token key property">address</span> <span class="token punctuation">=</span> <span class="token string">"/run/cri-containerd/cri-containerd.sock"</span>\n  <span class="token key property">tcp_address</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n  <span class="token key property">tcp_tls_cert</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n  <span class="token key property">tcp_tls_key</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n  <span class="token comment"># socket uid</span>\n  <span class="token key property">uid</span> <span class="token punctuation">=</span> <span class="token number">0</span>\n  <span class="token comment"># socket gid</span>\n  <span class="token key property">gid</span> <span class="token punctuation">=</span> <span class="token number">0</span>\n  <span class="token key property">max_recv_message_size</span> <span class="token punctuation">=</span> <span class="token number">16777216</span>\n  <span class="token key property">max_send_message_size</span> <span class="token punctuation">=</span> <span class="token number">16777216</span>\n\n<span class="token punctuation">[</span><span class="token table class-name">debug</span><span class="token punctuation">]</span>\n  <span class="token key property">address</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n  <span class="token key property">format</span> <span class="token punctuation">=</span> <span class="token string">"json"</span>\n  <span class="token key property">uid</span> <span class="token punctuation">=</span> <span class="token number">0</span>\n  <span class="token key property">gid</span> <span class="token punctuation">=</span> <span class="token number">0</span>\n  <span class="token key property">level</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n\n<span class="token punctuation">[</span><span class="token table class-name">metrics</span><span class="token punctuation">]</span>\n  <span class="token key property">address</span> <span class="token punctuation">=</span> <span class="token string">"127.0.0.1:1338"</span>\n  <span class="token key property">grpc_histogram</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n\n<span class="token punctuation">[</span><span class="token table class-name">cgroup</span><span class="token punctuation">]</span>\n  <span class="token key property">path</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n\n<span class="token punctuation">[</span><span class="token table class-name">timeouts</span><span class="token punctuation">]</span>\n  <span class="token key property">"io.containerd.timeout.shim.cleanup"</span> <span class="token punctuation">=</span> <span class="token string">"5s"</span>\n  <span class="token key property">"io.containerd.timeout.shim.load"</span> <span class="token punctuation">=</span> <span class="token string">"5s"</span>\n  <span class="token key property">"io.containerd.timeout.shim.shutdown"</span> <span class="token punctuation">=</span> <span class="token string">"3s"</span>\n  <span class="token key property">"io.containerd.timeout.task.state"</span> <span class="token punctuation">=</span> <span class="token string">"2s"</span>\n\n<span class="token punctuation">[</span><span class="token table class-name">plugins</span><span class="token punctuation">]</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.gc.v1.scheduler"</span><span class="token punctuation">]</span>\n    <span class="token key property">pause_threshold</span> <span class="token punctuation">=</span> <span class="token number">0.02</span>\n    <span class="token key property">deletion_threshold</span> <span class="token punctuation">=</span> <span class="token number">0</span>\n    <span class="token key property">mutation_threshold</span> <span class="token punctuation">=</span> <span class="token number">100</span>\n    <span class="token key property">schedule_delay</span> <span class="token punctuation">=</span> <span class="token string">"0s"</span>\n    <span class="token key property">startup_delay</span> <span class="token punctuation">=</span> <span class="token string">"100ms"</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri"</span><span class="token punctuation">]</span>\n    <span class="token key property">disable_tcp_service</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>\n    <span class="token key property">stream_server_address</span> <span class="token punctuation">=</span> <span class="token string">"127.0.0.1"</span>\n    <span class="token key property">stream_server_port</span> <span class="token punctuation">=</span> <span class="token string">"0"</span>\n    <span class="token key property">stream_idle_timeout</span> <span class="token punctuation">=</span> <span class="token string">"4h0m0s"</span>\n    <span class="token key property">enable_selinux</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n    <span class="token key property">selinux_category_range</span> <span class="token punctuation">=</span> <span class="token number">1024</span>\n    <span class="token key property">sandbox_image</span> <span class="token punctuation">=</span> <span class="token string">"registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5"</span>\n    <span class="token key property">stats_collect_period</span> <span class="token punctuation">=</span> <span class="token number">10</span>\n    <span class="token comment"># systemd_cgroup = false</span>\n    <span class="token key property">enable_tls_streaming</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n    <span class="token key property">max_container_log_line_size</span> <span class="token punctuation">=</span> <span class="token number">16384</span>\n    <span class="token key property">disable_cgroup</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n    <span class="token key property">disable_apparmor</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n    <span class="token key property">restrict_oom_score_adj</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n    <span class="token key property">max_concurrent_downloads</span> <span class="token punctuation">=</span> <span class="token number">3</span>\n    <span class="token key property">disable_proc_mount</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n    <span class="token key property">unset_seccomp_profile</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n    <span class="token key property">tolerate_missing_hugetlb_controller</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>\n    <span class="token key property">disable_hugetlb_controller</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>\n    <span class="token key property">ignore_image_defined_volumes</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n    <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".containerd</span><span class="token punctuation">]</span>\n      <span class="token key property">snapshotter</span> <span class="token punctuation">=</span> <span class="token string">"overlayfs"</span>\n      <span class="token key property">default_runtime_name</span> <span class="token punctuation">=</span> <span class="token string">"runc"</span>\n      <span class="token key property">no_pivot</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n      <span class="token key property">disable_snapshot_annotations</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n      <span class="token key property">discard_unpacked_layers</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n      <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".containerd.runtimes</span><span class="token punctuation">]</span>\n        <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc</span><span class="token punctuation">]</span>\n          <span class="token key property">runtime_type</span> <span class="token punctuation">=</span> <span class="token string">"io.containerd.runc.v2"</span>\n          <span class="token key property">pod_annotations</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n          <span class="token key property">container_annotations</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n          <span class="token key property">privileged_without_host_devices</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n          <span class="token key property">base_runtime_spec</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n          <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options</span><span class="token punctuation">]</span>\n            <span class="token comment"># SystemdCgroup enables systemd cgroups.</span>\n            <span class="token key property">SystemdCgroup</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>\n            <span class="token comment"># BinaryName is the binary name of the runc binary.</span>\n            <span class="token comment"># BinaryName = "runc"</span>\n            <span class="token comment"># BinaryName = "crun"</span>\n            <span class="token comment"># NoPivotRoot disables pivot root when creating a container.</span>\n            <span class="token comment"># NoPivotRoot = false</span>\n\n            <span class="token comment"># NoNewKeyring disables new keyring for the container.</span>\n            <span class="token comment"># NoNewKeyring = false</span>\n\n            <span class="token comment"># ShimCgroup places the shim in a cgroup.</span>\n            <span class="token comment"># ShimCgroup = ""</span>\n\n            <span class="token comment"># IoUid sets the I/O\'s pipes uid.</span>\n            <span class="token comment"># IoUid = 0</span>\n\n            <span class="token comment"># IoGid sets the I/O\'s pipes gid.</span>\n            <span class="token comment"># IoGid = 0</span>\n\n            <span class="token comment"># Root is the runc root directory.</span>\n            <span class="token key property">Root</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n\n            <span class="token comment"># CriuPath is the criu binary path.</span>\n            <span class="token comment"># CriuPath = ""</span>\n\n            <span class="token comment"># CriuImagePath is the criu image path</span>\n            <span class="token comment"># CriuImagePath = ""</span>\n\n            <span class="token comment"># CriuWorkPath is the criu work path.</span>\n            <span class="token comment"># CriuWorkPath = ""</span>\n    <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".cni</span><span class="token punctuation">]</span>\n      <span class="token key property">bin_dir</span> <span class="token punctuation">=</span> <span class="token string">"/opt/cni/bin"</span>\n      <span class="token key property">conf_dir</span> <span class="token punctuation">=</span> <span class="token string">"/etc/cni/net.d"</span>\n      <span class="token key property">max_conf_num</span> <span class="token punctuation">=</span> <span class="token number">1</span>\n      <span class="token key property">conf_template</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n    <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".registry</span><span class="token punctuation">]</span>\n      <span class="token key property">config_path</span> <span class="token punctuation">=</span> <span class="token string">"/etc/cri-containerd/certs.d"</span>\n      <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".registry.headers</span><span class="token punctuation">]</span>\n        <span class="token comment"># Foo = ["bar"]</span>\n    <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".image_decryption</span><span class="token punctuation">]</span>\n      <span class="token key property">key_model</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n    <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".x509_key_pair_streaming</span><span class="token punctuation">]</span>\n      <span class="token key property">tls_cert_file</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n      <span class="token key property">tls_key_file</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.internal.v1.opt"</span><span class="token punctuation">]</span>\n    <span class="token key property">path</span> <span class="token punctuation">=</span> <span class="token string">"/opt/cri-containerd"</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.internal.v1.restart"</span><span class="token punctuation">]</span>\n    <span class="token key property">interval</span> <span class="token punctuation">=</span> <span class="token string">"10s"</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.metadata.v1.bolt"</span><span class="token punctuation">]</span>\n    <span class="token key property">content_sharing_policy</span> <span class="token punctuation">=</span> <span class="token string">"shared"</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.monitor.v1.cgroups"</span><span class="token punctuation">]</span>\n    <span class="token key property">no_prometheus</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.runtime.v2.task"</span><span class="token punctuation">]</span>\n    <span class="token key property">platforms</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"linux/amd64"</span><span class="token punctuation">]</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.service.v1.diff-service"</span><span class="token punctuation">]</span>\n    <span class="token key property">default</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"walking"</span><span class="token punctuation">]</span>\n  <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.snapshotter.v1.devmapper"</span><span class="token punctuation">]</span>\n    <span class="token key property">root_path</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n    <span class="token key property">pool_name</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n    <span class="token key property">base_image_size</span> <span class="token punctuation">=</span> <span class="token string">""</span>\n    <span class="token key property">async_remove</span> <span class="token punctuation">=</span> <span class="token boolean">false</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="安装-kubelet-kubeadm-kubectl-cri-tools-kubernetes-cni"><a href="#%E5%AE%89%E8%A3%85-kubelet-kubeadm-kubectl-cri-tools-kubernetes-cni" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>安装 kubelet kubeadm kubectl cri-tools kubernetes-cni</h4>\n<h5 id="ubuntudebian"><a href="#ubuntudebian" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Ubuntu/Debian</h5>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38262489809795760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ apt-get update && apt-get install -y apt-transport-https\n\\$ curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -\n\n\\$ cat <<EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list\ndeb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main\nEOF\n\n\\$ apt-get update\n\\$ apt-get install -y kubelet kubeadm kubectl`, `38262489809795760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y apt-transport-https\n$ <span class="token function">curl</span> https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg <span class="token operator">|</span> apt-key <span class="token function">add</span> -\n\n$ <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/kubernetes.list\ndeb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main\nEOF\n\n$ <span class="token function">apt-get</span> update\n$ <span class="token function">apt-get</span> <span class="token function">install</span> -y kubelet kubeadm kubectl</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h5 id="centosfedora"><a href="#centosfedora" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CentOS/Fedora</h5>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43686397683793764000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo\n[kubernetes]\nname=Kubernetes\nbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\nEOF\n\n\\$ sudo yum install -y kubelet kubeadm kubectl`, `43686397683793764000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/yum.repos.d/kubernetes.repo\n<span class="token punctuation">[</span>kubernetes<span class="token punctuation">]</span>\n<span class="token assign-left variable">name</span><span class="token operator">=</span>Kubernetes\n<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/\n<span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span>\n<span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">1</span>\n<span class="token assign-left variable">repo_gpgcheck</span><span class="token operator">=</span><span class="token number">1</span>\n<span class="token assign-left variable">gpgkey</span><span class="token operator">=</span>https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\nEOF\n\n$ <span class="token function">sudo</span> yum <span class="token function">install</span> -y kubelet kubeadm kubectl</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="修改内核的运行参数"><a href="#%E4%BF%AE%E6%94%B9%E5%86%85%E6%A0%B8%E7%9A%84%E8%BF%90%E8%A1%8C%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修改内核的运行参数</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7948684347348478000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ cat <<EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf\nnet.bridge.bridge-nf-call-iptables  = 1\nnet.ipv4.ip_forward                 = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nEOF\n\n# 应用配置\n\\$ sysctl --system`, `7948684347348478000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/sysctl.d/99-kubernetes-cri.conf\nnet.bridge.bridge-nf-call-iptables  <span class="token operator">=</span> <span class="token number">1</span>\nnet.ipv4.ip_forward                 <span class="token operator">=</span> <span class="token number">1</span>\nnet.bridge.bridge-nf-call-ip6tables <span class="token operator">=</span> <span class="token number">1</span>\nEOF\n\n<span class="token comment"># 应用配置</span>\n$ sysctl --system</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="配置-kubelet"><a href="#%E9%85%8D%E7%BD%AE-kubelet" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配置 kubelet</h4>\n<h5 id="修改-kubeletservice"><a href="#%E4%BF%AE%E6%94%B9-kubeletservice" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修改 kubelet.service</h5>\n<p><code class="language-text">/etc/systemd/system/kubelet.service.d/10-proxy-ipvs.conf</code> 写入以下内容</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97621319697591070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 启用 ipvs 相关内核模块\n[Service]\nExecStartPre=-/sbin/modprobe ip_vs\nExecStartPre=-/sbin/modprobe ip_vs_rr\nExecStartPre=-/sbin/modprobe ip_vs_wrr\nExecStartPre=-/sbin/modprobe ip_vs_sh`, `97621319697591070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 启用 ipvs 相关内核模块</span>\n<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>\n<span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>-/sbin/modprobe ip_vs\n<span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>-/sbin/modprobe ip_vs_rr\n<span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>-/sbin/modprobe ip_vs_wrr\n<span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>-/sbin/modprobe ip_vs_sh</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>执行以下命令应用配置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35736053943618830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ sudo systemctl daemon-reload`, `35736053943618830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">sudo</span> systemctl daemon-reload</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="部署"><a href="#%E9%83%A8%E7%BD%B2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>部署</h4>\n<h5 id="master"><a href="#master" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>master</h5>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30621548751958080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ systemctl enable cri-containerd\n\n\\$ systemctl start cri-containerd\n\n\\$ sudo kubeadm init \\\n      --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers \\\n      --pod-network-cidr 10.244.0.0/16 \\\n      --cri-socket /run/cri-containerd/cri-containerd.sock \\\n      --v 5 \\\n      --ignore-preflight-errors=all`, `30621548751958080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ systemctl <span class="token builtin class-name">enable</span> cri-containerd\n\n$ systemctl start cri-containerd\n\n$ <span class="token function">sudo</span> kubeadm init <span class="token punctuation">\\</span>\n      --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers <span class="token punctuation">\\</span>\n      --pod-network-cidr <span class="token number">10.244</span>.0.0/16 <span class="token punctuation">\\</span>\n      --cri-socket /run/cri-containerd/cri-containerd.sock <span class="token punctuation">\\</span>\n      --v <span class="token number">5</span> <span class="token punctuation">\\</span>\n      --ignore-preflight-errors<span class="token operator">=</span>all</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">--pod-network-cidr 10.244.0.0/16</code> 参数与后续 CNI 插件有关，这里以 flannel 为例，若后续部署其他类型的网络插件请更改此参数。执行可能出现错误，例如缺少依赖包，根据提示安装即可。</p>\n<p>执行成功会输出</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85320527389863890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`...\n[addons] Applied essential addon: CoreDNS\nI1116 12:35:13.270407   86677 request.go:538] Throttling request took 181.409184ms, request: POST:https://192.168.199.100:6443/api/v1/namespaces/kube-system/serviceaccounts\nI1116 12:35:13.470292   86677 request.go:538] Throttling request took 186.088112ms, request: POST:https://192.168.199.100:6443/api/v1/namespaces/kube-system/configmaps\n[addons] Applied essential addon: kube-proxy\n\nYour Kubernetes control-plane has initialized successfully!\n\nTo start using your cluster, you need to run the following as a regular user:\n\n  mkdir -p \\$HOME/.kube\n  sudo cp -i /etc/kubernetes/admin.conf \\$HOME/.kube/config\n  sudo chown \\$(id -u):\\$(id -g) \\$HOME/.kube/config\n\nYou should now deploy a pod network to the cluster.\nRun &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nThen you can join any number of worker nodes by running the following on each as root:\n\nkubeadm join 192.168.199.100:6443 --token cz81zt.orsy9gm9v649e5lf \\\n    --discovery-token-ca-cert-hash sha256:5edb316fd0d8ea2792cba15cdf1c899a366f147aa03cba52d4e5c5884ad836fe`, `85320527389863890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token punctuation">..</span>.\n<span class="token punctuation">[</span>addons<span class="token punctuation">]</span> Applied essential addon: CoreDNS\nI1116 <span class="token number">12</span>:35:13.270407   <span class="token number">86677</span> request.go:538<span class="token punctuation">]</span> Throttling request took <span class="token number">181</span>.409184ms, request: POST:https://192.168.199.100:6443/api/v1/namespaces/kube-system/serviceaccounts\nI1116 <span class="token number">12</span>:35:13.470292   <span class="token number">86677</span> request.go:538<span class="token punctuation">]</span> Throttling request took <span class="token number">186</span>.088112ms, request: POST:https://192.168.199.100:6443/api/v1/namespaces/kube-system/configmaps\n<span class="token punctuation">[</span>addons<span class="token punctuation">]</span> Applied essential addon: kube-proxy\n\nYour Kubernetes control-plane has initialized successfully<span class="token operator">!</span>\n\nTo start using your cluster, you need to run the following as a regular user:\n\n  <span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.kube\n  <span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config\n  <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config\n\nYou should now deploy a pod network to the cluster.\nRun <span class="token string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nThen you can <span class="token function">join</span> any number of worker nodes by running the following on each as root:\n\nkubeadm <span class="token function">join</span> <span class="token number">192.168</span>.199.100:6443 --token cz81zt.orsy9gm9v649e5lf <span class="token punctuation">\\</span>\n    --discovery-token-ca-cert-hash sha256:5edb316fd0d8ea2792cba15cdf1c899a366f147aa03cba52d4e5c5884ad836fe</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h5 id="node-工作节点"><a href="#node-%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>node 工作节点</h5>\n<p>在另一主机重复部署小节以前的步骤，安装配置好 kubelet。根据提示，加入到集群。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5916660949229913000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ systemctl enable cri-containerd\n\n\\$ systemctl start cri-containerd\n\n\\$ kubeadm join 192.168.199.100:6443 \\\n    --token cz81zt.orsy9gm9v649e5lf \\\n    --discovery-token-ca-cert-hash sha256:5edb316fd0d8ea2792cba15cdf1c899a366f147aa03cba52d4e5c5884ad836fe \\\n    --cri-socket /run/cri-containerd/cri-containerd.sock`, `5916660949229913000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ systemctl <span class="token builtin class-name">enable</span> cri-containerd\n\n$ systemctl start cri-containerd\n\n$ kubeadm <span class="token function">join</span> <span class="token number">192.168</span>.199.100:6443 <span class="token punctuation">\\</span>\n    --token cz81zt.orsy9gm9v649e5lf <span class="token punctuation">\\</span>\n    --discovery-token-ca-cert-hash sha256:5edb316fd0d8ea2792cba15cdf1c899a366f147aa03cba52d4e5c5884ad836fe <span class="token punctuation">\\</span>\n    --cri-socket /run/cri-containerd/cri-containerd.sock</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="查看服务-2"><a href="#%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看服务</h4>\n<p>所有服务启动后，通过 crictl 查看本地实际运行的容器。这些服务大概分为三类：主节点服务、工作节点服务和其它服务。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77702061280751710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`CONTAINER_RUNTIME_ENDPOINT=/run/cri-containerd/cri-containerd.sock crictl ps -a`, `77702061280751710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token assign-left variable">CONTAINER_RUNTIME_ENDPOINT</span><span class="token operator">=</span>/run/cri-containerd/cri-containerd.sock crictl <span class="token function">ps</span> -a</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h5 id="主节点服务-1"><a href="#%E4%B8%BB%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>主节点服务</h5>\n<ul>\n<li>apiserver 是整个系统的对外接口，提供 RESTful 方式供客户端和其它组件调用；</li>\n<li>scheduler 负责对资源进行调度，分配某个 pod 到某个节点上；</li>\n<li>controller-manager 负责管理控制器，包括 endpoint-controller（刷新服务和 pod 的关联信息）和 replication-controller（维护某个 pod 的复制为配置的数值）。</li>\n</ul>\n<h5 id="工作节点服务"><a href="#%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>工作节点服务</h5>\n<p>proxy 为 pod 上的服务提供访问的代理。</p>\n<h5 id="其它服务"><a href="#%E5%85%B6%E5%AE%83%E6%9C%8D%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其它服务</h5>\n<p>Etcd 是所有状态的存储数据库；</p>\n<h4 id="使用-3"><a href="#%E4%BD%BF%E7%94%A8-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用</h4>\n<p>将 <code class="language-text">/etc/kubernetes/admin.conf</code> 复制到 <code class="language-text">~/.kube/config</code></p>\n<p>执行 <code class="language-text">$ kubectl get all -A</code> 查看启动的服务。</p>\n<p>由于未部署 CNI 插件，CoreDNS 未正常启动。如何使用 Kubernetes，请参考后续章节。</p>\n<h4 id="部署-cni"><a href="#%E9%83%A8%E7%BD%B2-cni" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>部署 CNI</h4>\n<p>这里以 flannel 为例进行介绍。</p>\n<h5 id="flannel"><a href="#flannel" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>flannel</h5>\n<p>检查 podCIDR 设置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82850591365223990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ kubectl get node -o yaml | grep CIDR\n\n# 输出\n    podCIDR: 10.244.0.0/16\n    podCIDRs:`, `82850591365223990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ kubectl get node -o yaml <span class="token operator">|</span> <span class="token function">grep</span> CIDR\n\n<span class="token comment"># 输出</span>\n    podCIDR: <span class="token number">10.244</span>.0.0/16\n    podCIDRs:</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7153272748560302000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/v0.11.0/Documentation/kube-flannel.yml`, `7153272748560302000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/v0.11.0/Documentation/kube-flannel.yml</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="master-节点默认不能运行-pod"><a href="#master-%E8%8A%82%E7%82%B9%E9%BB%98%E8%AE%A4%E4%B8%8D%E8%83%BD%E8%BF%90%E8%A1%8C-pod" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>master 节点默认不能运行 pod</h4>\n<p>如果用 kubeadm 部署一个单节点集群，默认情况下无法使用，请执行以下命令解除限制</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55116806093370510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ kubectl taint nodes --all node-role.kubernetes.io/master-\n\n# 恢复默认值\n# \\$ kubectl taint nodes NODE_NAME node-role.kubernetes.io/master=true:NoSchedule`, `55116806093370510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ kubectl taint nodes --all node-role.kubernetes.io/master-\n\n<span class="token comment"># 恢复默认值</span>\n<span class="token comment"># $ kubectl taint nodes NODE_NAME node-role.kubernetes.io/master=true:NoSchedule</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="docker-desktop-启用-kubernetes"><a href="#docker-desktop-%E5%90%AF%E7%94%A8-kubernetes" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker Desktop 启用 Kubernetes</h3>\n<p>使用 Docker Desktop 可以很方便的启用 Kubernetes，由于国内获取不到 k8s.gcr.io 镜像，我们必须首先解决这一问题。</p>\n<h4 id="获取-k8sgcrio-镜像"><a href="#%E8%8E%B7%E5%8F%96-k8sgcrio-%E9%95%9C%E5%83%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>获取 k8s.gcr.io 镜像</h4>\n<p>由于国内拉取不到 k8s.gcr.io 镜像，我们可以使用开源项目 <a href="https://github.com/AliyunContainerService/k8s-for-docker-desktop" target="_blank" rel="nofollow noreferrer noopener">AliyunContainerService/k8s-for-docker-desktop</a> 来获取所需的镜像。</p>\n<h4 id="启用-kubernetes"><a href="#%E5%90%AF%E7%94%A8-kubernetes" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>启用 Kubernetes</h4>\n<p>在 Docker Desktop 设置页面，点击 Kubernetes，选择 Enable Kubernetes，稍等片刻，看到左下方 Kubernetes 变为 running，Kubernetes 启动成功。</p>\n<h4 id="测试-1"><a href="#%E6%B5%8B%E8%AF%95-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>测试</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55364226421407900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ kubectl version`, `55364226421407900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ kubectl version</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果正常输出信息，则证明 Kubernetes 成功启动。</p>\n<h3 id="一步步部署-kubernetes-集群"><a href="#%E4%B8%80%E6%AD%A5%E6%AD%A5%E9%83%A8%E7%BD%B2-kubernetes-%E9%9B%86%E7%BE%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一步步部署 kubernetes 集群</h3>\n<p>可以参考 <a href="https://github.com/opsnull/follow-me-install-kubernetes-cluster" target="_blank" rel="nofollow noreferrer noopener">opsnull/follow-me-install-kubernetes-cluster</a> 项目一步步部署 kubernetes 集群。</p>\n<h3 id="kubernetes-dashboard"><a href="#kubernetes-dashboard" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kubernetes Dashboard</h3>\n<p><a href="https://github.com/kubernetes/dashboard" target="_blank" rel="nofollow noreferrer noopener">Kubernetes Dashboard</a> 是基于网页的 Kubernetes 用户界面。</p>\n<h4 id="部署-1"><a href="#%E9%83%A8%E7%BD%B2-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>部署</h4>\n<p>执行以下命令即可部署 Dashboard：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5308139799663092000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml`, `5308139799663092000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="访问"><a href="#%E8%AE%BF%E9%97%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>访问</h4>\n<p>通过命令行代理访问，执行以下命令：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17083304203807814000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ kubectl proxy`, `17083304203807814000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ kubectl proxy</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>到 <code class="language-text">http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/</code> 即可访问。</p>\n<h4 id="登录-1"><a href="#%E7%99%BB%E5%BD%95-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>登录</h4>\n<p>目前，Dashboard 仅支持使用 Bearer 令牌登录。下面教大家如何创建该令牌：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21757569656800270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ kubectl create sa dashboard-admin -n kube-system\n\n\\$ kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin\n\n\\$ ADMIN_SECRET=\\$(kubectl get secrets -n kube-system | grep dashboard-admin | awk \'{print \\$1}\')\n\n\\$ DASHBOARD_LOGIN_TOKEN=\\$(kubectl describe secret -n kube-system \\${ADMIN_SECRET} | grep -E \'^token\' | awk \'{print \\$2}\')\n\necho \\${DASHBOARD_LOGIN_TOKEN}`, `21757569656800270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ kubectl create sa dashboard-admin -n kube-system\n\n$ kubectl create clusterrolebinding dashboard-admin --clusterrole<span class="token operator">=</span>cluster-admin --serviceaccount<span class="token operator">=</span>kube-system:dashboard-admin\n\n$ <span class="token assign-left variable">ADMIN_SECRET</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get secrets -n kube-system <span class="token operator">|</span> <span class="token function">grep</span> dashboard-admin <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">\'{print <span class="token variable">$1</span>}\'</span><span class="token variable">)</span></span>\n\n$ <span class="token assign-left variable">DASHBOARD_LOGIN_TOKEN</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl describe secret -n kube-system $<span class="token punctuation">{</span>ADMIN_SECRET<span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token function">grep</span> -E <span class="token string">\'^token\'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">\'{print <span class="token variable">$2</span>}\'</span><span class="token variable">)</span></span>\n\n<span class="token builtin class-name">echo</span> <span class="token variable">${DASHBOARD_LOGIN_TOKEN}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>将结果粘贴到登录页面，即可登录。</p>\n<h2 id="kubernetes-命令行-kubectl"><a href="#kubernetes-%E5%91%BD%E4%BB%A4%E8%A1%8C-kubectl" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kubernetes 命令行 kubectl</h2>\n<h3 id="kubectl-使用"><a href="#kubectl-%E4%BD%BF%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kubectl 使用</h3>\n<p><a href="https://github.com/kubernetes/kubernetes" target="_blank" rel="nofollow noreferrer noopener">kubectl</a> 是 Kubernetes 自带的客户端，可以用它来直接操作 Kubernetes。</p>\n<p>使用格式有两种：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18918804674392355000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl [flags]\nkubectl [command]`, `18918804674392355000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>\nkubectl <span class="token punctuation">[</span>command<span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h4 id="get"><a href="#get" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>get</h4>\n<p>显示一个或多个资源</p>\n<h4 id="describe"><a href="#describe" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>describe</h4>\n<p>显示资源详情</p>\n<h4 id="create"><a href="#create" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>create</h4>\n<p>从文件或标准输入创建资源</p>\n<h4 id="update"><a href="#update" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>update</h4>\n<p>从文件或标准输入更新资源</p>\n<h4 id="delete"><a href="#delete" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>delete</h4>\n<p>通过文件名、标准输入、资源名或者 label selector 删除资源</p>\n<h4 id="log"><a href="#log" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>log</h4>\n<p>输出 pod 中一个容器的日志</p>\n<h4 id="rolling-update"><a href="#rolling-update" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>rolling-update</h4>\n<p>对指定的 replication controller 执行滚动升级</p>\n<h4 id="exec-1"><a href="#exec-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>exec</h4>\n<p>在容器内部执行命令</p>\n<h4 id="port-forward"><a href="#port-forward" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>port-forward</h4>\n<p>将本地端口转发到 Pod</p>\n<h4 id="proxy"><a href="#proxy" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>proxy</h4>\n<p>为 Kubernetes API server 启动代理服务器</p>\n<h4 id="run-2"><a href="#run-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>run</h4>\n<p>在集群中使用指定镜像启动容器</p>\n<h4 id="expose-2"><a href="#expose-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>expose</h4>\n<p>将 <code class="language-text">replication controller service</code> 或 pod 暴露为新的 <code class="language-text">kubernetes service</code></p>\n<h4 id="label-1"><a href="#label-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>label</h4>\n<p>更新资源的 label</p>\n<h4 id="config-1"><a href="#config-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>config</h4>\n<p>修改 kubernetes 配置文件</p>\n<h4 id="cluster-info"><a href="#cluster-info" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>cluster-info</h4>\n<p>显示集群信息</p>\n<h4 id="api-versions"><a href="#api-versions" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>api-versions</h4>\n<p>以 “组/版本” 的格式输出服务端支持的 API 版本</p>\n<h4 id="version-1"><a href="#version-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>version</h4>\n<p>输出服务端和客户端的版本信息</p>\n<h4 id="help-1"><a href="#help-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>help</h4>\n<p>显示各个命令的帮助信息</p>\n<h3 id="常用命令"><a href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>常用命令</h3>\n<p>使用以下示例集来帮助你熟悉运行常用 kubectl 操作：</p>\n<h4 id="kubectl-apply---以文件或标准输入为准应用或更新资源"><a href="#kubectl-apply---%E4%BB%A5%E6%96%87%E4%BB%B6%E6%88%96%E6%A0%87%E5%87%86%E8%BE%93%E5%85%A5%E4%B8%BA%E5%87%86%E5%BA%94%E7%94%A8%E6%88%96%E6%9B%B4%E6%96%B0%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kubectl apply - 以文件或标准输入为准应用或更新资源</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12409202143569998000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 使用 example-service.yaml 中的定义创建服务。\nkubectl apply -f example-service.yaml\n\n# 使用 example-controller.yaml 中的定义创建 replication controller。\nkubectl apply -f example-controller.yaml\n\n# 使用 <directory> 路径下的任意 .yaml、.yml 或 .json 文件 创建对象。\nkubectl apply -f <directory>`, `12409202143569998000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 使用 example-service.yaml 中的定义创建服务。</span>\nkubectl apply -f example-service.yaml\n\n<span class="token comment"># 使用 example-controller.yaml 中的定义创建 replication controller。</span>\nkubectl apply -f example-controller.yaml\n\n<span class="token comment"># 使用 &lt;directory> 路径下的任意 .yaml、.yml 或 .json 文件 创建对象。</span>\nkubectl apply -f <span class="token operator">&lt;</span>directory<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="kubectl-get---列出一个或多个资源"><a href="#kubectl-get---%E5%88%97%E5%87%BA%E4%B8%80%E4%B8%AA%E6%88%96%E5%A4%9A%E4%B8%AA%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kubectl get - 列出一个或多个资源</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61259243667331930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 以纯文本输出格式列出所有 Pod。\nkubectl get pods\n\n# 以纯文本输出格式列出所有 Pod，并包含附加信息(如节点名)。\nkubectl get pods -o wide\n\n# 以纯文本输出格式列出具有指定名称的副本控制器。提示：你可以使用别名 \'rc\' 缩短和替换 \'replicationcontroller\' 资源类型。\nkubectl get replicationcontroller <rc-name>\n\n# 以纯文本输出格式列出所有副本控制器和服务。\nkubectl get rc,services\n\n# 以纯文本输出格式列出所有守护程序集，包括未初始化的守护程序集。\nkubectl get ds --include-uninitialized\n\n# 列出在节点 server01 上运行的所有 Pod\nkubectl get pods --field-selector=spec.nodeName=server01`, `61259243667331930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 以纯文本输出格式列出所有 Pod。</span>\nkubectl get pods\n\n<span class="token comment"># 以纯文本输出格式列出所有 Pod，并包含附加信息(如节点名)。</span>\nkubectl get pods -o wide\n\n<span class="token comment"># 以纯文本输出格式列出具有指定名称的副本控制器。提示：你可以使用别名 \'rc\' 缩短和替换 \'replicationcontroller\' 资源类型。</span>\nkubectl get replicationcontroller <span class="token operator">&lt;</span>rc-name<span class="token operator">></span>\n\n<span class="token comment"># 以纯文本输出格式列出所有副本控制器和服务。</span>\nkubectl get rc,services\n\n<span class="token comment"># 以纯文本输出格式列出所有守护程序集，包括未初始化的守护程序集。</span>\nkubectl get ds --include-uninitialized\n\n<span class="token comment"># 列出在节点 server01 上运行的所有 Pod</span>\nkubectl get pods --field-selector<span class="token operator">=</span>spec.nodeName<span class="token operator">=</span>server01</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="kubectl-describe---显示一个或多个资源的详细状态，默认情况下包括未初始化的资源"><a href="#kubectl-describe---%E6%98%BE%E7%A4%BA%E4%B8%80%E4%B8%AA%E6%88%96%E5%A4%9A%E4%B8%AA%E8%B5%84%E6%BA%90%E7%9A%84%E8%AF%A6%E7%BB%86%E7%8A%B6%E6%80%81%EF%BC%8C%E9%BB%98%E8%AE%A4%E6%83%85%E5%86%B5%E4%B8%8B%E5%8C%85%E6%8B%AC%E6%9C%AA%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kubectl describe - 显示一个或多个资源的详细状态，默认情况下包括未初始化的资源</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25419983312441795000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 显示名为 <pod-name> 的 Pod 的详细信息。\nkubectl describe nodes <node-name>\n\n# 显示名为 <pod-name> 的 Pod 的详细信息。\nkubectl describe pods/<pod-name>\n\n# 显示由名为 <rc-name> 的副本控制器管理的所有 Pod 的详细信息。\n# 记住：副本控制器创建的任何 Pod 都以副本控制器的名称为前缀。\nkubectl describe pods <rc-name>\n\n# 描述所有的 Pod\nkubectl describe pods`, `25419983312441795000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 显示名为 &lt;pod-name> 的 Pod 的详细信息。</span>\nkubectl describe nodes <span class="token operator">&lt;</span>node-name<span class="token operator">></span>\n\n<span class="token comment"># 显示名为 &lt;pod-name> 的 Pod 的详细信息。</span>\nkubectl describe pods/<span class="token operator">&lt;</span>pod-name<span class="token operator">></span>\n\n<span class="token comment"># 显示由名为 &lt;rc-name> 的副本控制器管理的所有 Pod 的详细信息。</span>\n<span class="token comment"># 记住：副本控制器创建的任何 Pod 都以副本控制器的名称为前缀。</span>\nkubectl describe pods <span class="token operator">&lt;</span>rc-name<span class="token operator">></span>\n\n<span class="token comment"># 描述所有的 Pod</span>\nkubectl describe pods</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>说明： <code class="language-text">kubectl get</code> 命令通常用于检索同一资源类别的一个或多个资源。它具有丰富的参数，允许你使用 <code class="language-text">-o</code> 或 <code class="language-text">--output</code> 参数自定义输出格式。你可以指定 <code class="language-text">-w</code> 或 <code class="language-text">--watch</code> 参数以开始监测特定对象的更新。<code class="language-text">kubectl describe</code> 命令更侧重于描述指定资源的许多相关方面。它可以调用对 API 服务器的多个 API 调用来为用户构建视图。 例如，该 <code class="language-text">kubectl describe node</code> 命令不仅检索有关节点的信息，还检索在其上运行的 Pod 的摘要，为节点生成的事件等。</p>\n</blockquote>\n<h4 id="kubectl-delete---基于文件、标准输入或通过指定标签选择器、名称、资源选择器或资源来删除资源"><a href="#kubectl-delete---%E5%9F%BA%E4%BA%8E%E6%96%87%E4%BB%B6%E3%80%81%E6%A0%87%E5%87%86%E8%BE%93%E5%85%A5%E6%88%96%E9%80%9A%E8%BF%87%E6%8C%87%E5%AE%9A%E6%A0%87%E7%AD%BE%E9%80%89%E6%8B%A9%E5%99%A8%E3%80%81%E5%90%8D%E7%A7%B0%E3%80%81%E8%B5%84%E6%BA%90%E9%80%89%E6%8B%A9%E5%99%A8%E6%88%96%E8%B5%84%E6%BA%90%E6%9D%A5%E5%88%A0%E9%99%A4%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kubectl delete - 基于文件、标准输入或通过指定标签选择器、名称、资源选择器或资源来删除资源</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36531064249341180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 使用 pod.yaml 文件中指定的类型和名称删除 Pod。\nkubectl delete -f pod.yaml\n\n# 删除所有带有 \'<label-key>=<label-value>\' 标签的 Pod 和服务。\nkubectl delete pods,services -l <label-key>=<label-value>\n\n# 删除所有 Pod，包括未初始化的 Pod。\nkubectl delete pods --all`, `36531064249341180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 使用 pod.yaml 文件中指定的类型和名称删除 Pod。</span>\nkubectl delete -f pod.yaml\n\n<span class="token comment"># 删除所有带有 \'&lt;label-key>=&lt;label-value>\' 标签的 Pod 和服务。</span>\nkubectl delete pods,services -l <span class="token operator">&lt;</span>label-key<span class="token operator">></span><span class="token operator">=</span><span class="token operator">&lt;</span>label-value<span class="token operator">></span>\n\n<span class="token comment"># 删除所有 Pod，包括未初始化的 Pod。</span>\nkubectl delete pods --all</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="kubectl-exec---对-pod-中的容器执行命令"><a href="#kubectl-exec---%E5%AF%B9-pod-%E4%B8%AD%E7%9A%84%E5%AE%B9%E5%99%A8%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kubectl exec - 对 Pod 中的容器执行命令</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1920317398837667600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 从 Pod <pod-name> 中获取运行 \'date\' 的输出。默认情况下，输出来自第一个容器。\nkubectl exec <pod-name> -- date\n\n# 运行输出 \'date\' 获取在 Pod <pod-name> 中容器 <container-name> 的输出。\nkubectl exec <pod-name> -c <container-name> -- date\n\n# 获取一个交互 TTY 并在 Pod <pod-name> 中运行 /bin/bash。默认情况下，输出来自第一个容器。\nkubectl exec -ti <pod-name> -- /bin/bash`, `1920317398837667600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 从 Pod &lt;pod-name> 中获取运行 \'date\' 的输出。默认情况下，输出来自第一个容器。</span>\nkubectl <span class="token builtin class-name">exec</span> <span class="token operator">&lt;</span>pod-name<span class="token operator">></span> -- <span class="token function">date</span>\n\n<span class="token comment"># 运行输出 \'date\' 获取在 Pod &lt;pod-name> 中容器 &lt;container-name> 的输出。</span>\nkubectl <span class="token builtin class-name">exec</span> <span class="token operator">&lt;</span>pod-name<span class="token operator">></span> -c <span class="token operator">&lt;</span>container-name<span class="token operator">></span> -- <span class="token function">date</span>\n\n<span class="token comment"># 获取一个交互 TTY 并在 Pod &lt;pod-name> 中运行 /bin/bash。默认情况下，输出来自第一个容器。</span>\nkubectl <span class="token builtin class-name">exec</span> -ti <span class="token operator">&lt;</span>pod-name<span class="token operator">></span> -- /bin/bash</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="kubectl-logs---打印-pod-中容器的日志"><a href="#kubectl-logs---%E6%89%93%E5%8D%B0-pod-%E4%B8%AD%E5%AE%B9%E5%99%A8%E7%9A%84%E6%97%A5%E5%BF%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kubectl logs - 打印 Pod 中容器的日志</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33642522185485267000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 返回 Pod <pod-name> 的日志快照。\nkubectl logs <pod-name>\n\n# 从 Pod <pod-name> 开始流式传输日志。这类似于 \'tail -f\' Linux 命令。\nkubectl logs -f <pod-name>`, `33642522185485267000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 返回 Pod &lt;pod-name> 的日志快照。</span>\nkubectl logs <span class="token operator">&lt;</span>pod-name<span class="token operator">></span>\n\n<span class="token comment"># 从 Pod &lt;pod-name> 开始流式传输日志。这类似于 \'tail -f\' Linux 命令。</span>\nkubectl logs -f <span class="token operator">&lt;</span>pod-name<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="kubectl-diff---查看集群建议更新的差异"><a href="#kubectl-diff---%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E5%BB%BA%E8%AE%AE%E6%9B%B4%E6%96%B0%E7%9A%84%E5%B7%AE%E5%BC%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>kubectl diff - 查看集群建议更新的差异</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85113984582709510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# “pod.json”中包含的差异资源。\nkubectl diff -f pod.json\n\n# 从标准输入读取的差异文件。\ncat service.yaml | kubectl diff -f -`, `85113984582709510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># “pod.json”中包含的差异资源。</span>\nkubectl <span class="token function">diff</span> -f pod.json\n\n<span class="token comment"># 从标准输入读取的差异文件。</span>\n<span class="token function">cat</span> service.yaml <span class="token operator">|</span> kubectl <span class="token function">diff</span> -f -</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="kubectl-自动补全"><a href="#kubectl-%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kubectl 自动补全</h4>\n<h5 id="bash"><a href="#bash" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>BASH</h5>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14661963286170600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`source <(kubectl completion bash) # 在 bash 中设置当前 shell 的自动补全，要先安装 bash-completion 包。\necho &quot;source <(kubectl completion bash)&quot; >> ~/.bashrc # 在您的 bash shell 中永久的添加自动补全`, `14661963286170600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token builtin class-name">source</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>kubectl completion <span class="token function">bash</span><span class="token punctuation">)</span> <span class="token comment"># 在 bash 中设置当前 shell 的自动补全，要先安装 bash-completion 包。</span>\n<span class="token builtin class-name">echo</span> <span class="token string">"source &lt;(kubectl completion bash)"</span> <span class="token operator">>></span> ~/.bashrc <span class="token comment"># 在您的 bash shell 中永久的添加自动补全</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>您还可以为 kubectl 使用一个速记别名，该别名也可以与 completion 一起使用：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68028435622484930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`alias k=kubectl\ncomplete -o default -F __start_kubectl k`, `68028435622484930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token builtin class-name">alias</span> <span class="token assign-left variable">k</span><span class="token operator">=</span>kubectl\ncomplete -o default -F __start_kubectl k</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h5 id="zsh"><a href="#zsh" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ZSH</h5>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89138863920021830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`source <(kubectl completion zsh)  # 在 zsh 中设置当前 shell 的自动补全\necho \'[[ \\$commands[kubectl] ]] && source <(kubectl completion zsh)\' >> ~/.zshrc # 在您的 zsh shell 中永久的添加自动补全`, `89138863920021830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token builtin class-name">source</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>kubectl completion <span class="token function">zsh</span><span class="token punctuation">)</span>  <span class="token comment"># 在 zsh 中设置当前 shell 的自动补全</span>\n<span class="token builtin class-name">echo</span> <span class="token string">\'[[ <span class="token variable">$commands</span>[kubectl] ]] &amp;&amp; source &lt;(kubectl completion zsh)\'</span> <span class="token operator">>></span> ~/.zshrc <span class="token comment"># 在您的 zsh shell 中永久的添加自动补全</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h5 id="关于---all-namespaces-的一点说明"><a href="#%E5%85%B3%E4%BA%8E---all-namespaces-%E7%9A%84%E4%B8%80%E7%82%B9%E8%AF%B4%E6%98%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>关于 <code class="language-text">--all-namespaces</code> 的一点说明</h5>\n<p>我们经常用到 <code class="language-text">--all-namespaces</code> 参数，你应该要知道它的简写 <code class="language-text">kubectl -A</code></p>\n<h4 id="kubectl-上下文和配置"><a href="#kubectl-%E4%B8%8A%E4%B8%8B%E6%96%87%E5%92%8C%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kubectl 上下文和配置</h4>\n<p>设置 kubectl 与哪个 Kubernetes 集群进行通信并修改配置信息。查看使用 kubeconfig 跨集群授权访问 文档获取配置文件详细信息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60192291395881116000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl config view # 显示合并的 kubeconfig 配置。\n\n# 同时使用多个 kubeconfig 文件并查看合并的配置\nKUBECONFIG=~/.kube/config:~/.kube/kubconfig2 kubectl config view\n\n# 获取 e2e 用户的密码\nkubectl config view -o jsonpath=\'{.users[?(@.name == &quot;e2e&quot;)].user.password}\'\n\nkubectl config view -o jsonpath=\'{.users[].name}\'    # 显示第一个用户\nkubectl config view -o jsonpath=\'{.users[*].name}\'   # 获取用户列表\nkubectl config get-contexts                          # 显示上下文列表\nkubectl config current-context                       # 展示当前所处的上下文\nkubectl config use-context my-cluster-name           # 设置默认的上下文为 my-cluster-name\n\n# 添加新的用户配置到 kubeconf 中，使用 basic auth 进行身份认证\nkubectl config set-credentials kubeuser/foo.kubernetes.com --username=kubeuser --password=kubepassword\n\n# 在指定上下文中持久性地保存名字空间，供所有后续 kubectl 命令使用\nkubectl config set-context --current --namespace=ggckad-s2\n\n# 使用特定的用户名和名字空间设置上下文\nkubectl config set-context gce --user=cluster-admin --namespace=foo \\\n  && kubectl config use-context gce\n\nkubectl config unset users.foo                       # 删除用户 foo\n\n# 设置或显示 context / namespace 的短别名\n# （仅适用于 bash 和 bash 兼容的 shell，在使用 kn 设置命名空间之前要先设置 current-context）\nalias kx=\'f() { [ &quot;\\$1&quot; ] && kubectl config use-context \\$1 || kubectl config current-context ; } ; f\'\nalias kn=\'f() { [ &quot;\\$1&quot; ] && kubectl config set-context --current --namespace \\$1 || kubectl config view --minify | grep namespace | cut -d&quot; &quot; -f6 ; } ; f\'`, `60192291395881116000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl config view <span class="token comment"># 显示合并的 kubeconfig 配置。</span>\n\n<span class="token comment"># 同时使用多个 kubeconfig 文件并查看合并的配置</span>\n<span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span>~/.kube/config:~/.kube/kubconfig2 kubectl config view\n\n<span class="token comment"># 获取 e2e 用户的密码</span>\nkubectl config view -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">\'{.users[?(@.name == "e2e")].user.password}\'</span>\n\nkubectl config view -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">\'{.users[].name}\'</span>    <span class="token comment"># 显示第一个用户</span>\nkubectl config view -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">\'{.users[*].name}\'</span>   <span class="token comment"># 获取用户列表</span>\nkubectl config get-contexts                          <span class="token comment"># 显示上下文列表</span>\nkubectl config current-context                       <span class="token comment"># 展示当前所处的上下文</span>\nkubectl config use-context my-cluster-name           <span class="token comment"># 设置默认的上下文为 my-cluster-name</span>\n\n<span class="token comment"># 添加新的用户配置到 kubeconf 中，使用 basic auth 进行身份认证</span>\nkubectl config set-credentials kubeuser/foo.kubernetes.com --username<span class="token operator">=</span>kubeuser --password<span class="token operator">=</span>kubepassword\n\n<span class="token comment"># 在指定上下文中持久性地保存名字空间，供所有后续 kubectl 命令使用</span>\nkubectl config set-context --current --namespace<span class="token operator">=</span>ggckad-s2\n\n<span class="token comment"># 使用特定的用户名和名字空间设置上下文</span>\nkubectl config set-context gce --user<span class="token operator">=</span>cluster-admin --namespace<span class="token operator">=</span>foo <span class="token punctuation">\\</span>\n  <span class="token operator">&amp;&amp;</span> kubectl config use-context gce\n\nkubectl config <span class="token builtin class-name">unset</span> users.foo                       <span class="token comment"># 删除用户 foo</span>\n\n<span class="token comment"># 设置或显示 context / namespace 的短别名</span>\n<span class="token comment"># （仅适用于 bash 和 bash 兼容的 shell，在使用 kn 设置命名空间之前要先设置 current-context）</span>\n<span class="token builtin class-name">alias</span> <span class="token assign-left variable">kx</span><span class="token operator">=</span><span class="token string">\'f() { [ "<span class="token variable">$1</span>" ] &amp;&amp; kubectl config use-context <span class="token variable">$1</span> || kubectl config current-context ; } ; f\'</span>\n<span class="token builtin class-name">alias</span> <span class="token assign-left variable">kn</span><span class="token operator">=</span><span class="token string">\'f() { [ "<span class="token variable">$1</span>" ] &amp;&amp; kubectl config set-context --current --namespace <span class="token variable">$1</span> || kubectl config view --minify | grep namespace | cut -d" " -f6 ; } ; f\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="kubectl-apply"><a href="#kubectl-apply" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kubectl apply</h4>\n<p>apply 通过定义 Kubernetes 资源的文件来管理应用。它通过运行 kubectl apply 在集群中创建和更新资源。这是在生产中管理 Kubernetes 应用的推荐方法。 参见 <a href="https://kubectl.docs.kubernetes.io/zh/" target="_blank" rel="nofollow noreferrer noopener">Kubectl 文档</a>。</p>\n<h4 id="创建对象"><a href="#%E5%88%9B%E5%BB%BA%E5%AF%B9%E8%B1%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建对象</h4>\n<p>Kubernetes 配置可以用 YAML 或 JSON 定义。可以使用的文件扩展名有 <code class="language-text">.yaml</code>、<code class="language-text">.yml</code> 和 <code class="language-text">.json</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63350454563933550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl apply -f ./my-manifest.yaml           # 创建资源\nkubectl apply -f ./my1.yaml -f ./my2.yaml     # 使用多个文件创建\nkubectl apply -f ./dir                        # 基于目录下的所有清单文件创建资源\nkubectl apply -f https://git.io/vPieo         # 从 URL 中创建资源\nkubectl create deployment nginx --image=nginx # 启动单实例 nginx\n\n# 创建一个打印 “Hello World” 的 Job\nkubectl create job hello --image=busybox:1.28 -- echo &quot;Hello World&quot;\n\n# 创建一个打印 “Hello World” 间隔 1 分钟的 CronJob\nkubectl create cronjob hello --image=busybox:1.28 --schedule=&quot;*/1 * * * *&quot; -- echo &quot;Hello World&quot;\n\nkubectl explain pods                          # 获取 pod 清单的文档说明\n\n# 从标准输入创建多个 YAML 对象\ncat <<EOF | kubectl apply -f -\napiVersion: v1\nkind: Pod\nmetadata:\n  name: busybox-sleep\nspec:\n  containers:\n  - name: busybox\n    image: busybox:1.28\n    args:\n    - sleep\n    - &quot;1000000&quot;\n---\napiVersion: v1\nkind: Pod\nmetadata:\n  name: busybox-sleep-less\nspec:\n  containers:\n  - name: busybox\n    image: busybox:1.28\n    args:\n    - sleep\n    - &quot;1000&quot;\nEOF\n\n# 创建有多个 key 的 Secret\ncat <<EOF | kubectl apply -f -\napiVersion: v1\nkind: Secret\nmetadata:\n  name: mysecret\ntype: Opaque\ndata:\n  password: \\$(echo -n &quot;s33msi4&quot; | base64 -w0)\n  username: \\$(echo -n &quot;jane&quot; | base64 -w0)\nEOF`, `63350454563933550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl apply -f ./my-manifest.yaml           <span class="token comment"># 创建资源</span>\nkubectl apply -f ./my1.yaml -f ./my2.yaml     <span class="token comment"># 使用多个文件创建</span>\nkubectl apply -f ./dir                        <span class="token comment"># 基于目录下的所有清单文件创建资源</span>\nkubectl apply -f https://git.io/vPieo         <span class="token comment"># 从 URL 中创建资源</span>\nkubectl create deployment nginx --image<span class="token operator">=</span>nginx <span class="token comment"># 启动单实例 nginx</span>\n\n<span class="token comment"># 创建一个打印 “Hello World” 的 Job</span>\nkubectl create job hello --image<span class="token operator">=</span>busybox:1.28 -- <span class="token builtin class-name">echo</span> <span class="token string">"Hello World"</span>\n\n<span class="token comment"># 创建一个打印 “Hello World” 间隔 1 分钟的 CronJob</span>\nkubectl create cronjob hello --image<span class="token operator">=</span>busybox:1.28 --schedule<span class="token operator">=</span><span class="token string">"*/1 * * * *"</span> -- <span class="token builtin class-name">echo</span> <span class="token string">"Hello World"</span>\n\nkubectl explain pods                          <span class="token comment"># 获取 pod 清单的文档说明</span>\n\n<span class="token comment"># 从标准输入创建多个 YAML 对象</span>\n<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">|</span> kubectl apply -f -\napiVersion: v1\nkind: Pod\nmetadata:\n  name: busybox-sleep\nspec:\n  containers:\n  - name: busybox\n    image: busybox:1.28\n    args:\n    - <span class="token function">sleep</span>\n    - <span class="token string">"1000000"</span>\n---\napiVersion: v1\nkind: Pod\nmetadata:\n  name: busybox-sleep-less\nspec:\n  containers:\n  - name: busybox\n    image: busybox:1.28\n    args:\n    - <span class="token function">sleep</span>\n    - <span class="token string">"1000"</span>\nEOF\n\n<span class="token comment"># 创建有多个 key 的 Secret</span>\n<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">|</span> kubectl apply -f -\napiVersion: v1\nkind: Secret\nmetadata:\n  name: mysecret\ntype: Opaque\ndata:\n  password: <span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> -n <span class="token string">"s33msi4"</span> <span class="token operator">|</span> base64 -w0<span class="token variable">)</span></span>\n  username: <span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> -n <span class="token string">"jane"</span> <span class="token operator">|</span> base64 -w0<span class="token variable">)</span></span>\nEOF</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="查看和查找资源"><a href="#%E6%9F%A5%E7%9C%8B%E5%92%8C%E6%9F%A5%E6%89%BE%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>查看和查找资源</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1459014350225529300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# get 命令的基本输出\nkubectl get services                          # 列出当前命名空间下的所有 services\nkubectl get pods --all-namespaces             # 列出所有命名空间下的全部的 Pods\nkubectl get pods -o wide                      # 列出当前命名空间下的全部 Pods，并显示更详细的信息\nkubectl get deployment my-dep                 # 列出某个特定的 Deployment\nkubectl get pods                              # 列出当前命名空间下的全部 Pods\nkubectl get pod my-pod -o yaml                # 获取一个 pod 的 YAML\n\n# describe 命令的详细输出\nkubectl describe nodes my-node\nkubectl describe pods my-pod\n\n# 列出当前名字空间下所有 Services，按名称排序\nkubectl get services --sort-by=.metadata.name\n\n# 列出 Pods，按重启次数排序\nkubectl get pods --sort-by=\'.status.containerStatuses[0].restartCount\'\n\n# 列举所有 PV 持久卷，按容量排序\nkubectl get pv --sort-by=.spec.capacity.storage\n\n# 获取包含 app=cassandra 标签的所有 Pods 的 version 标签\nkubectl get pods --selector=app=cassandra -o \\\n  jsonpath=\'{.items[*].metadata.labels.version}\'\n\n# 检索带有 “.” 键值，例： \'ca.crt\'\nkubectl get configmap myconfig \\\n  -o jsonpath=\'{.data.ca\\.crt}\'\n\n# 检索一个 base64 编码的值，其中的键名应该包含减号而不是下划线。\nkubectl get secret my-secret --template=\'{{index .data &quot;key-name-with-dashes&quot;}}\'\n\n# 获取所有工作节点（使用选择器以排除标签名称为 \'node-role.kubernetes.io/control-plane\' 的结果）\nkubectl get node --selector=\'!node-role.kubernetes.io/control-plane\'\n\n# 获取当前命名空间中正在运行的 Pods\nkubectl get pods --field-selector=status.phase=Running\n\n# 获取全部节点的 ExternalIP 地址\nkubectl get nodes -o jsonpath=\'{.items[*].status.addresses[?(@.type==&quot;ExternalIP&quot;)].address}\'\n\n# 列出属于某个特定 RC 的 Pods 的名称\n# 在转换对于 jsonpath 过于复杂的场合，&quot;jq&quot; 命令很有用；可以在 https://stedolan.github.io/jq/ 找到它。\nsel=\\${\\$(kubectl get rc my-rc --output=json | jq -j \'.spec.selector | to_entries | .[] | &quot;\\(.key)=\\(.value),&quot;\')%?}\necho \\$(kubectl get pods --selector=\\$sel --output=jsonpath={.items..metadata.name})\n\n# 显示所有 Pods 的标签（或任何其他支持标签的 Kubernetes 对象）\nkubectl get pods --show-labels\n\n# 检查哪些节点处于就绪状态\nJSONPATH=\'{range .items[*]}{@.metadata.name}:{range @.status.conditions[*]}{@.type}={@.status};{end}{end}\' \\\n && kubectl get nodes -o jsonpath=&quot;\\$JSONPATH&quot; | grep &quot;Ready=True&quot;\n\n# 不使用外部工具来输出解码后的 Secret\nkubectl get secret my-secret -o go-template=\'{{range \\$k,\\$v := .data}}{{&quot;### &quot;}}{{\\$k}}{{&quot;\\n&quot;}}{{\\$v|base64decode}}{{&quot;\\n\\n&quot;}}{{end}}\'\n\n# 列出被一个 Pod 使用的全部 Secret\nkubectl get pods -o json | jq \'.items[].spec.containers[].env[]?.valueFrom.secretKeyRef.name\' | grep -v null | sort | uniq\n\n# 列举所有 Pods 中初始化容器的容器 ID（containerID）\n# 可用于在清理已停止的容器时避免删除初始化容器\nkubectl get pods --all-namespaces -o jsonpath=\'{range .items[*].status.initContainerStatuses[*]}{.containerID}{&quot;\\n&quot;}{end}\' | cut -d/ -f3\n\n# 列出事件（Events），按时间戳排序\nkubectl get events --sort-by=.metadata.creationTimestamp\n\n# 比较当前的集群状态和假定某清单被应用之后的集群状态\nkubectl diff -f ./my-manifest.yaml\n\n# 生成一个句点分隔的树，其中包含为节点返回的所有键\n# 在复杂的嵌套JSON结构中定位键时非常有用\nkubectl get nodes -o json | jq -c \'paths|join(&quot;.&quot;)\'\n\n# 生成一个句点分隔的树，其中包含为pod等返回的所有键\nkubectl get pods -o json | jq -c \'paths|join(&quot;.&quot;)\'\n\n# 假设你的 Pods 有默认的容器和默认的名字空间，并且支持 \'env\' 命令，可以使用以下脚本为所有 Pods 生成 ENV 变量。\n# 该脚本也可用于在所有的 Pods 里运行任何受支持的命令，而不仅仅是 \'env\'。\nfor pod in \\$(kubectl get po --output=jsonpath={.items..metadata.name}); do echo \\$pod && kubectl exec -it \\$pod -- env; done\n\n# 获取一个 Deployment 的 status 子资源\nkubectl get deployment nginx-deployment --subresource=status`, `1459014350225529300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># get 命令的基本输出</span>\nkubectl get services                          <span class="token comment"># 列出当前命名空间下的所有 services</span>\nkubectl get pods --all-namespaces             <span class="token comment"># 列出所有命名空间下的全部的 Pods</span>\nkubectl get pods -o wide                      <span class="token comment"># 列出当前命名空间下的全部 Pods，并显示更详细的信息</span>\nkubectl get deployment my-dep                 <span class="token comment"># 列出某个特定的 Deployment</span>\nkubectl get pods                              <span class="token comment"># 列出当前命名空间下的全部 Pods</span>\nkubectl get pod my-pod -o yaml                <span class="token comment"># 获取一个 pod 的 YAML</span>\n\n<span class="token comment"># describe 命令的详细输出</span>\nkubectl describe nodes my-node\nkubectl describe pods my-pod\n\n<span class="token comment"># 列出当前名字空间下所有 Services，按名称排序</span>\nkubectl get services --sort-by<span class="token operator">=</span>.metadata.name\n\n<span class="token comment"># 列出 Pods，按重启次数排序</span>\nkubectl get pods --sort-by<span class="token operator">=</span><span class="token string">\'.status.containerStatuses[0].restartCount\'</span>\n\n<span class="token comment"># 列举所有 PV 持久卷，按容量排序</span>\nkubectl get <span class="token function">pv</span> --sort-by<span class="token operator">=</span>.spec.capacity.storage\n\n<span class="token comment"># 获取包含 app=cassandra 标签的所有 Pods 的 version 标签</span>\nkubectl get pods --selector<span class="token operator">=</span>app<span class="token operator">=</span>cassandra -o <span class="token punctuation">\\</span>\n  <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">\'{.items[*].metadata.labels.version}\'</span>\n\n<span class="token comment"># 检索带有 “.” 键值，例： \'ca.crt\'</span>\nkubectl get configmap myconfig <span class="token punctuation">\\</span>\n  -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">\'{.data.ca\\.crt}\'</span>\n\n<span class="token comment"># 检索一个 base64 编码的值，其中的键名应该包含减号而不是下划线。</span>\nkubectl get secret my-secret --template<span class="token operator">=</span><span class="token string">\'{{index .data "key-name-with-dashes"}}\'</span>\n\n<span class="token comment"># 获取所有工作节点（使用选择器以排除标签名称为 \'node-role.kubernetes.io/control-plane\' 的结果）</span>\nkubectl get node --selector<span class="token operator">=</span><span class="token string">\'!node-role.kubernetes.io/control-plane\'</span>\n\n<span class="token comment"># 获取当前命名空间中正在运行的 Pods</span>\nkubectl get pods --field-selector<span class="token operator">=</span>status.phase<span class="token operator">=</span>Running\n\n<span class="token comment"># 获取全部节点的 ExternalIP 地址</span>\nkubectl get nodes -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">\'{.items[*].status.addresses[?(@.type=="ExternalIP")].address}\'</span>\n\n<span class="token comment"># 列出属于某个特定 RC 的 Pods 的名称</span>\n<span class="token comment"># 在转换对于 jsonpath 过于复杂的场合，"jq" 命令很有用；可以在 https://stedolan.github.io/jq/ 找到它。</span>\n<span class="token assign-left variable">sel</span><span class="token operator">=</span><span class="token variable">${$(kubectl get rc my-rc --output=json | jq -j \'.spec.selector | to_entries | .<span class="token punctuation">[</span><span class="token punctuation">]</span> | "\\(.key)=\\(.value)<span class="token operator">,</span>"\')<span class="token operator">%</span>?}</span>\n<span class="token builtin class-name">echo</span> <span class="token variable"><span class="token variable">$(</span>kubectl get pods --selector<span class="token operator">=</span>$sel --output<span class="token operator">=</span>jsonpath<span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>\n\n<span class="token comment"># 显示所有 Pods 的标签（或任何其他支持标签的 Kubernetes 对象）</span>\nkubectl get pods --show-labels\n\n<span class="token comment"># 检查哪些节点处于就绪状态</span>\n<span class="token assign-left variable">JSONPATH</span><span class="token operator">=</span><span class="token string">\'{range .items[*]}{@.metadata.name}:{range @.status.conditions[*]}{@.type}={@.status};{end}{end}\'</span> <span class="token punctuation">\\</span>\n <span class="token operator">&amp;&amp;</span> kubectl get nodes -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$JSONPATH</span>"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"Ready=True"</span>\n\n<span class="token comment"># 不使用外部工具来输出解码后的 Secret</span>\nkubectl get secret my-secret -o go-template<span class="token operator">=</span><span class="token string">\'{{range <span class="token variable">$k</span>,<span class="token variable">$v</span> := .data}}{{"### "}}{{<span class="token variable">$k</span>}}{{"<span class="token entity" title="\\n">\\n</span>"}}{{<span class="token variable">$v</span>|base64decode}}{{"<span class="token entity" title="\\n">\\n</span><span class="token entity" title="\\n">\\n</span>"}}{{end}}\'</span>\n\n<span class="token comment"># 列出被一个 Pod 使用的全部 Secret</span>\nkubectl get pods -o json <span class="token operator">|</span> jq <span class="token string">\'.items[].spec.containers[].env[]?.valueFrom.secretKeyRef.name\'</span> <span class="token operator">|</span> <span class="token function">grep</span> -v null <span class="token operator">|</span> <span class="token function">sort</span> <span class="token operator">|</span> <span class="token function">uniq</span>\n\n<span class="token comment"># 列举所有 Pods 中初始化容器的容器 ID（containerID）</span>\n<span class="token comment"># 可用于在清理已停止的容器时避免删除初始化容器</span>\nkubectl get pods --all-namespaces -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">\'{range .items[*].status.initContainerStatuses[*]}{.containerID}{"<span class="token entity" title="\\n">\\n</span>"}{end}\'</span> <span class="token operator">|</span> <span class="token function">cut</span> -d/ -f3\n\n<span class="token comment"># 列出事件（Events），按时间戳排序</span>\nkubectl get events --sort-by<span class="token operator">=</span>.metadata.creationTimestamp\n\n<span class="token comment"># 比较当前的集群状态和假定某清单被应用之后的集群状态</span>\nkubectl <span class="token function">diff</span> -f ./my-manifest.yaml\n\n<span class="token comment"># 生成一个句点分隔的树，其中包含为节点返回的所有键</span>\n<span class="token comment"># 在复杂的嵌套JSON结构中定位键时非常有用</span>\nkubectl get nodes -o json <span class="token operator">|</span> jq -c <span class="token string">\'paths|join(".")\'</span>\n\n<span class="token comment"># 生成一个句点分隔的树，其中包含为pod等返回的所有键</span>\nkubectl get pods -o json <span class="token operator">|</span> jq -c <span class="token string">\'paths|join(".")\'</span>\n\n<span class="token comment"># 假设你的 Pods 有默认的容器和默认的名字空间，并且支持 \'env\' 命令，可以使用以下脚本为所有 Pods 生成 ENV 变量。</span>\n<span class="token comment"># 该脚本也可用于在所有的 Pods 里运行任何受支持的命令，而不仅仅是 \'env\'。</span>\n<span class="token keyword">for</span> <span class="token for-or-select variable">pod</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span>kubectl get po --output<span class="token operator">=</span>jsonpath<span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token builtin class-name">echo</span> <span class="token variable">$pod</span> <span class="token operator">&amp;&amp;</span> kubectl <span class="token builtin class-name">exec</span> -it <span class="token variable">$pod</span> -- <span class="token function">env</span><span class="token punctuation">;</span> <span class="token keyword">done</span>\n\n<span class="token comment"># 获取一个 Deployment 的 status 子资源</span>\nkubectl get deployment nginx-deployment --subresource<span class="token operator">=</span>status</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="更新资源"><a href="#%E6%9B%B4%E6%96%B0%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>更新资源</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59065912045362000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl set image deployment/frontend www=image:v2               # 滚动更新 &quot;frontend&quot; Deployment 的 &quot;www&quot; 容器镜像\nkubectl rollout history deployment/frontend                      # 检查 Deployment 的历史记录，包括版本\nkubectl rollout undo deployment/frontend                         # 回滚到上次部署版本\nkubectl rollout undo deployment/frontend --to-revision=2         # 回滚到特定部署版本\nkubectl rollout status -w deployment/frontend                    # 监视 &quot;frontend&quot; Deployment 的滚动升级状态直到完成\nkubectl rollout restart deployment/frontend                      # 轮替重启 &quot;frontend&quot; Deployment\n\ncat pod.json | kubectl replace -f -                              # 通过传入到标准输入的 JSON 来替换 Pod\n\n# 强制替换，删除后重建资源。会导致服务不可用。\nkubectl replace --force -f ./pod.json\n\n# 为多副本的 nginx 创建服务，使用 80 端口提供服务，连接到容器的 8000 端口。\nkubectl expose rc nginx --port=80 --target-port=8000\n\n# 将某单容器 Pod 的镜像版本（标签）更新到 v4\nkubectl get pod mypod -o yaml | sed \'s/\\(image: myimage\\):.*\\$/\\1:v4/\' | kubectl replace -f -\n\nkubectl label pods my-pod new-label=awesome                      # 添加标签\nkubectl annotate pods my-pod icon-url=http://goo.gl/XXBTWq       # 添加注解\nkubectl autoscale deployment foo --min=2 --max=10                # 对 &quot;foo&quot; Deployment 自动伸缩容`, `59065912045362000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl <span class="token builtin class-name">set</span> image deployment/frontend <span class="token assign-left variable">www</span><span class="token operator">=</span>image:v2               <span class="token comment"># 滚动更新 "frontend" Deployment 的 "www" 容器镜像</span>\nkubectl rollout <span class="token function">history</span> deployment/frontend                      <span class="token comment"># 检查 Deployment 的历史记录，包括版本</span>\nkubectl rollout undo deployment/frontend                         <span class="token comment"># 回滚到上次部署版本</span>\nkubectl rollout undo deployment/frontend --to-revision<span class="token operator">=</span><span class="token number">2</span>         <span class="token comment"># 回滚到特定部署版本</span>\nkubectl rollout status -w deployment/frontend                    <span class="token comment"># 监视 "frontend" Deployment 的滚动升级状态直到完成</span>\nkubectl rollout restart deployment/frontend                      <span class="token comment"># 轮替重启 "frontend" Deployment</span>\n\n<span class="token function">cat</span> pod.json <span class="token operator">|</span> kubectl replace -f -                              <span class="token comment"># 通过传入到标准输入的 JSON 来替换 Pod</span>\n\n<span class="token comment"># 强制替换，删除后重建资源。会导致服务不可用。</span>\nkubectl replace --force -f ./pod.json\n\n<span class="token comment"># 为多副本的 nginx 创建服务，使用 80 端口提供服务，连接到容器的 8000 端口。</span>\nkubectl expose rc nginx --port<span class="token operator">=</span><span class="token number">80</span> --target-port<span class="token operator">=</span><span class="token number">8000</span>\n\n<span class="token comment"># 将某单容器 Pod 的镜像版本（标签）更新到 v4</span>\nkubectl get pod mypod -o yaml <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">\'s/\\(image: myimage\\):.*$/<span class="token entity" title="\\1">\\1</span>:v4/\'</span> <span class="token operator">|</span> kubectl replace -f -\n\nkubectl label pods my-pod new-label<span class="token operator">=</span>awesome                      <span class="token comment"># 添加标签</span>\nkubectl annotate pods my-pod icon-url<span class="token operator">=</span>http://goo.gl/XXBTWq       <span class="token comment"># 添加注解</span>\nkubectl autoscale deployment foo --min<span class="token operator">=</span><span class="token number">2</span> --max<span class="token operator">=</span><span class="token number">10</span>                <span class="token comment"># 对 "foo" Deployment 自动伸缩容</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="部分更新资源"><a href="#%E9%83%A8%E5%88%86%E6%9B%B4%E6%96%B0%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>部分更新资源</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="553005066478795500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 部分更新某节点\nkubectl patch node k8s-node-1 -p \'{&quot;spec&quot;:{&quot;unschedulable&quot;:true}}\'\n\n# 更新容器的镜像；spec.containers[*].name 是必须的。因为它是一个合并性质的主键。\nkubectl patch pod valid-pod -p \'{&quot;spec&quot;:{&quot;containers&quot;:[{&quot;name&quot;:&quot;kubernetes-serve-hostname&quot;,&quot;image&quot;:&quot;new image&quot;}]}}\'\n\n# 使用带位置数组的 JSON patch 更新容器的镜像\nkubectl patch pod valid-pod --type=\'json\' -p=\'[{&quot;op&quot;: &quot;replace&quot;, &quot;path&quot;: &quot;/spec/containers/0/image&quot;, &quot;value&quot;:&quot;new image&quot;}]\'\n\n# 使用带位置数组的 JSON patch 禁用某 Deployment 的 livenessProbe\nkubectl patch deployment valid-deployment  --type json   -p=\'[{&quot;op&quot;: &quot;remove&quot;, &quot;path&quot;: &quot;/spec/template/spec/containers/0/livenessProbe&quot;}]\'\n\n# 在带位置数组中添加元素\nkubectl patch sa default --type=\'json\' -p=\'[{&quot;op&quot;: &quot;add&quot;, &quot;path&quot;: &quot;/secrets/1&quot;, &quot;value&quot;: {&quot;name&quot;: &quot;whatever&quot; } }]\'\n\n# 通过修正 scale 子资源来更新 Deployment 的副本数\nkubectl patch deployment nginx-deployment --subresource=\'scale\' --type=\'merge\' -p \'{&quot;spec&quot;:{&quot;replicas&quot;:2}}\'`, `553005066478795500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 部分更新某节点</span>\nkubectl patch node k8s-node-1 -p <span class="token string">\'{"spec":{"unschedulable":true}}\'</span>\n\n<span class="token comment"># 更新容器的镜像；spec.containers[*].name 是必须的。因为它是一个合并性质的主键。</span>\nkubectl patch pod valid-pod -p <span class="token string">\'{"spec":{"containers":[{"name":"kubernetes-serve-hostname","image":"new image"}]}}\'</span>\n\n<span class="token comment"># 使用带位置数组的 JSON patch 更新容器的镜像</span>\nkubectl patch pod valid-pod --type<span class="token operator">=</span><span class="token string">\'json\'</span> -p<span class="token operator">=</span><span class="token string">\'[{"op": "replace", "path": "/spec/containers/0/image", "value":"new image"}]\'</span>\n\n<span class="token comment"># 使用带位置数组的 JSON patch 禁用某 Deployment 的 livenessProbe</span>\nkubectl patch deployment valid-deployment  --type json   -p<span class="token operator">=</span><span class="token string">\'[{"op": "remove", "path": "/spec/template/spec/containers/0/livenessProbe"}]\'</span>\n\n<span class="token comment"># 在带位置数组中添加元素</span>\nkubectl patch sa default --type<span class="token operator">=</span><span class="token string">\'json\'</span> -p<span class="token operator">=</span><span class="token string">\'[{"op": "add", "path": "/secrets/1", "value": {"name": "whatever" } }]\'</span>\n\n<span class="token comment"># 通过修正 scale 子资源来更新 Deployment 的副本数</span>\nkubectl patch deployment nginx-deployment --subresource<span class="token operator">=</span><span class="token string">\'scale\'</span> --type<span class="token operator">=</span><span class="token string">\'merge\'</span> -p <span class="token string">\'{"spec":{"replicas":2}}\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="编辑资源"><a href="#%E7%BC%96%E8%BE%91%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编辑资源</h4>\n<p>使用你偏爱的编辑器编辑 API 资源。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80216176125587850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl edit svc/docker-registry                      # 编辑名为 docker-registry 的服务\nKUBE_EDITOR=&quot;nano&quot; kubectl edit svc/docker-registry   # 使用其他编辑器`, `80216176125587850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl edit svc/docker-registry                      <span class="token comment"># 编辑名为 docker-registry 的服务</span>\n<span class="token assign-left variable">KUBE_EDITOR</span><span class="token operator">=</span><span class="token string">"nano"</span> kubectl edit svc/docker-registry   <span class="token comment"># 使用其他编辑器</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h4 id="对资源进行伸缩"><a href="#%E5%AF%B9%E8%B5%84%E6%BA%90%E8%BF%9B%E8%A1%8C%E4%BC%B8%E7%BC%A9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>对资源进行伸缩</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40552434567375960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl scale --replicas=3 rs/foo                                 # 将名为 \'foo\' 的副本集伸缩到 3 副本\nkubectl scale --replicas=3 -f foo.yaml                            # 将在 &quot;foo.yaml&quot; 中的特定资源伸缩到 3 个副本\nkubectl scale --current-replicas=2 --replicas=3 deployment/mysql  # 如果名为 mysql 的 Deployment 的副本当前是 2，那么将它伸缩到 3\nkubectl scale --replicas=5 rc/foo rc/bar rc/baz                   # 伸缩多个副本控制器`, `40552434567375960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl scale --replicas<span class="token operator">=</span><span class="token number">3</span> rs/foo                                 <span class="token comment"># 将名为 \'foo\' 的副本集伸缩到 3 副本</span>\nkubectl scale --replicas<span class="token operator">=</span><span class="token number">3</span> -f foo.yaml                            <span class="token comment"># 将在 "foo.yaml" 中的特定资源伸缩到 3 个副本</span>\nkubectl scale --current-replicas<span class="token operator">=</span><span class="token number">2</span> --replicas<span class="token operator">=</span><span class="token number">3</span> deployment/mysql  <span class="token comment"># 如果名为 mysql 的 Deployment 的副本当前是 2，那么将它伸缩到 3</span>\nkubectl scale --replicas<span class="token operator">=</span><span class="token number">5</span> rc/foo rc/bar rc/baz                   <span class="token comment"># 伸缩多个副本控制器</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="删除资源"><a href="#%E5%88%A0%E9%99%A4%E8%B5%84%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>删除资源</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79200554535341360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl delete -f ./pod.json                                              # 删除在 pod.json 中指定的类型和名称的 Pod\nkubectl delete pod,service baz foo                                        # 删除名称为 &quot;baz&quot; 和 &quot;foo&quot; 的 Pod 和服务\nkubectl delete pods,services -l name=myLabel                              # 删除包含 name=myLabel 标签的 pods 和服务\nkubectl -n my-ns delete pod,svc --all                                     # 删除在 my-ns 名字空间中全部的 Pods 和服务\n# 删除所有与 pattern1 或 pattern2 awk 模式匹配的 Pods\nkubectl get pods  -n mynamespace --no-headers=true | awk \'/pattern1|pattern2/{print \\$1}\' | xargs  kubectl delete -n mynamespace pod`, `79200554535341360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl delete -f ./pod.json                                              <span class="token comment"># 删除在 pod.json 中指定的类型和名称的 Pod</span>\nkubectl delete pod,service baz foo                                        <span class="token comment"># 删除名称为 "baz" 和 "foo" 的 Pod 和服务</span>\nkubectl delete pods,services -l <span class="token assign-left variable">name</span><span class="token operator">=</span>myLabel                              <span class="token comment"># 删除包含 name=myLabel 标签的 pods 和服务</span>\nkubectl -n my-ns delete pod,svc --all                                     <span class="token comment"># 删除在 my-ns 名字空间中全部的 Pods 和服务</span>\n<span class="token comment"># 删除所有与 pattern1 或 pattern2 awk 模式匹配的 Pods</span>\nkubectl get pods  -n mynamespace --no-headers<span class="token operator">=</span>true <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">\'/pattern1|pattern2/{print <span class="token variable">$1</span>}\'</span> <span class="token operator">|</span> <span class="token function">xargs</span>  kubectl delete -n mynamespace pod</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="与运行中的-pods-进行交互"><a href="#%E4%B8%8E%E8%BF%90%E8%A1%8C%E4%B8%AD%E7%9A%84-pods-%E8%BF%9B%E8%A1%8C%E4%BA%A4%E4%BA%92" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>与运行中的 Pods 进行交互</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69744410349744950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl logs my-pod                                 # 获取 pod 日志（标准输出）\nkubectl logs -l name=myLabel                        # 获取含 name=myLabel 标签的 Pods 的日志（标准输出）\nkubectl logs my-pod --previous                      # 获取上个容器实例的 pod 日志（标准输出）\nkubectl logs my-pod -c my-container                 # 获取 Pod 容器的日志（标准输出, 多容器场景）\nkubectl logs -l name=myLabel -c my-container        # 获取含 name=myLabel 标签的 Pod 容器日志（标准输出, 多容器场景）\nkubectl logs my-pod -c my-container --previous      # 获取 Pod 中某容器的上个实例的日志（标准输出, 多容器场景）\nkubectl logs -f my-pod                              # 流式输出 Pod 的日志（标准输出）\nkubectl logs -f my-pod -c my-container              # 流式输出 Pod 容器的日志（标准输出, 多容器场景）\nkubectl logs -f -l name=myLabel --all-containers    # 流式输出含 name=myLabel 标签的 Pod 的所有日志（标准输出）\nkubectl run -i --tty busybox --image=busybox:1.28 -- sh  # 以交互式 Shell 运行 Pod\nkubectl run nginx --image=nginx -n mynamespace      # 在 “mynamespace” 命名空间中运行单个 nginx Pod\nkubectl run nginx --image=nginx                     # 运行 ngins Pod 并将其规约写入到名为 pod.yaml 的文件\n  --dry-run=client -o yaml > pod.yaml\n\nkubectl attach my-pod -i                            # 挂接到一个运行的容器中\nkubectl port-forward my-pod 5000:6000               # 在本地计算机上侦听端口 5000 并转发到 my-pod 上的端口 6000\nkubectl exec my-pod -- ls /                         # 在已有的 Pod 中运行命令（单容器场景）\nkubectl exec --stdin --tty my-pod -- /bin/sh        # 使用交互 shell 访问正在运行的 Pod (一个容器场景)\nkubectl exec my-pod -c my-container -- ls /         # 在已有的 Pod 中运行命令（多容器场景）\nkubectl top pod POD_NAME --containers               # 显示给定 Pod 和其中容器的监控数据\nkubectl top pod POD_NAME --sort-by=cpu              # 显示给定 Pod 的指标并且按照 \'cpu\' 或者 \'memory\' 排序`, `69744410349744950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl logs my-pod                                 <span class="token comment"># 获取 pod 日志（标准输出）</span>\nkubectl logs -l <span class="token assign-left variable">name</span><span class="token operator">=</span>myLabel                        <span class="token comment"># 获取含 name=myLabel 标签的 Pods 的日志（标准输出）</span>\nkubectl logs my-pod --previous                      <span class="token comment"># 获取上个容器实例的 pod 日志（标准输出）</span>\nkubectl logs my-pod -c my-container                 <span class="token comment"># 获取 Pod 容器的日志（标准输出, 多容器场景）</span>\nkubectl logs -l <span class="token assign-left variable">name</span><span class="token operator">=</span>myLabel -c my-container        <span class="token comment"># 获取含 name=myLabel 标签的 Pod 容器日志（标准输出, 多容器场景）</span>\nkubectl logs my-pod -c my-container --previous      <span class="token comment"># 获取 Pod 中某容器的上个实例的日志（标准输出, 多容器场景）</span>\nkubectl logs -f my-pod                              <span class="token comment"># 流式输出 Pod 的日志（标准输出）</span>\nkubectl logs -f my-pod -c my-container              <span class="token comment"># 流式输出 Pod 容器的日志（标准输出, 多容器场景）</span>\nkubectl logs -f -l <span class="token assign-left variable">name</span><span class="token operator">=</span>myLabel --all-containers    <span class="token comment"># 流式输出含 name=myLabel 标签的 Pod 的所有日志（标准输出）</span>\nkubectl run -i --tty busybox --image<span class="token operator">=</span>busybox:1.28 -- <span class="token function">sh</span>  <span class="token comment"># 以交互式 Shell 运行 Pod</span>\nkubectl run nginx --image<span class="token operator">=</span>nginx -n mynamespace      <span class="token comment"># 在 “mynamespace” 命名空间中运行单个 nginx Pod</span>\nkubectl run nginx --image<span class="token operator">=</span>nginx                     <span class="token comment"># 运行 ngins Pod 并将其规约写入到名为 pod.yaml 的文件</span>\n  --dry-run<span class="token operator">=</span>client -o yaml <span class="token operator">></span> pod.yaml\n\nkubectl attach my-pod -i                            <span class="token comment"># 挂接到一个运行的容器中</span>\nkubectl port-forward my-pod <span class="token number">5000</span>:6000               <span class="token comment"># 在本地计算机上侦听端口 5000 并转发到 my-pod 上的端口 6000</span>\nkubectl <span class="token builtin class-name">exec</span> my-pod -- <span class="token function">ls</span> /                         <span class="token comment"># 在已有的 Pod 中运行命令（单容器场景）</span>\nkubectl <span class="token builtin class-name">exec</span> --stdin --tty my-pod -- /bin/sh        <span class="token comment"># 使用交互 shell 访问正在运行的 Pod (一个容器场景)</span>\nkubectl <span class="token builtin class-name">exec</span> my-pod -c my-container -- <span class="token function">ls</span> /         <span class="token comment"># 在已有的 Pod 中运行命令（多容器场景）</span>\nkubectl <span class="token function">top</span> pod POD_NAME --containers               <span class="token comment"># 显示给定 Pod 和其中容器的监控数据</span>\nkubectl <span class="token function">top</span> pod POD_NAME --sort-by<span class="token operator">=</span>cpu              <span class="token comment"># 显示给定 Pod 的指标并且按照 \'cpu\' 或者 \'memory\' 排序</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="从容器中复制文件和目录"><a href="#%E4%BB%8E%E5%AE%B9%E5%99%A8%E4%B8%AD%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>从容器中复制文件和目录</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82376120819293550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl cp /tmp/foo_dir my-pod:/tmp/bar_dir            # 将 /tmp/foo_dir 本地目录复制到远程当前命名空间中 Pod 中的 /tmp/bar_dir\nkubectl cp /tmp/foo my-pod:/tmp/bar -c my-container    # 将 /tmp/foo 本地文件复制到远程 Pod 中特定容器的 /tmp/bar 下\nkubectl cp /tmp/foo my-namespace/my-pod:/tmp/bar       # 将 /tmp/foo 本地文件复制到远程 “my-namespace” 命名空间内指定 Pod 中的 /tmp/bar\nkubectl cp my-namespace/my-pod:/tmp/foo /tmp/bar       # 将 /tmp/foo 从远程 Pod 复制到本地 /tmp/bar`, `82376120819293550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl <span class="token function">cp</span> /tmp/foo_dir my-pod:/tmp/bar_dir            <span class="token comment"># 将 /tmp/foo_dir 本地目录复制到远程当前命名空间中 Pod 中的 /tmp/bar_dir</span>\nkubectl <span class="token function">cp</span> /tmp/foo my-pod:/tmp/bar -c my-container    <span class="token comment"># 将 /tmp/foo 本地文件复制到远程 Pod 中特定容器的 /tmp/bar 下</span>\nkubectl <span class="token function">cp</span> /tmp/foo my-namespace/my-pod:/tmp/bar       <span class="token comment"># 将 /tmp/foo 本地文件复制到远程 “my-namespace” 命名空间内指定 Pod 中的 /tmp/bar</span>\nkubectl <span class="token function">cp</span> my-namespace/my-pod:/tmp/foo /tmp/bar       <span class="token comment"># 将 /tmp/foo 从远程 Pod 复制到本地 /tmp/bar</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>说明：<code class="language-text">kubectl cp</code> 要求容器镜像中存在 <code class="language-text">tar</code> 二进制文件。如果 <code class="language-text">tar</code> 不存在，<code class="language-text">kubectl cp</code> 将失败。对于进阶用例，例如符号链接、通配符扩展或保留文件权限，请考虑使用 <code class="language-text">kubectl exec</code>。</p>\n</blockquote>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73406786089459010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`tar cf - /tmp/foo | kubectl exec -i -n my-namespace my-pod -- tar xf - -C /tmp/bar  # 将 /tmp/foo 本地文件复制到远程 “my-namespace” 命名空间中 pod 中的 /tmp/bar\nkubectl exec -n my-namespace my-pod -- tar cf - /tmp/foo | tar xf - -C /tmp/bar    # 将 /tmp/foo 从远程 pod 复制到本地 /tmp/bar`, `73406786089459010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token function">tar</span> cf - /tmp/foo <span class="token operator">|</span> kubectl <span class="token builtin class-name">exec</span> -i -n my-namespace my-pod -- <span class="token function">tar</span> xf - -C /tmp/bar  <span class="token comment"># 将 /tmp/foo 本地文件复制到远程 “my-namespace” 命名空间中 pod 中的 /tmp/bar</span>\nkubectl <span class="token builtin class-name">exec</span> -n my-namespace my-pod -- <span class="token function">tar</span> cf - /tmp/foo <span class="token operator">|</span> <span class="token function">tar</span> xf - -C /tmp/bar    <span class="token comment"># 将 /tmp/foo 从远程 pod 复制到本地 /tmp/bar</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h4 id="与-deployments-和-services-进行交互"><a href="#%E4%B8%8E-deployments-%E5%92%8C-services-%E8%BF%9B%E8%A1%8C%E4%BA%A4%E4%BA%92" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>与 Deployments 和 Services 进行交互</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77339361000164870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl logs deploy/my-deployment                         # 获取一个 Deployment 的 Pod 的日志（单容器例子）\nkubectl logs deploy/my-deployment -c my-container         # 获取一个 Deployment 的 Pod 的日志（多容器例子）\n\nkubectl port-forward svc/my-service 5000                  # 侦听本地端口 5000 并转发到 Service 后端端口 5000\nkubectl port-forward svc/my-service 5000:my-service-port  # 侦听本地端口 5000 并转发到名字为 <my-service-port> 的 Service 目标端口\n\nkubectl port-forward deploy/my-deployment 5000:6000       # 侦听本地端口 5000 并转发到 <my-deployment> 创建的 Pod 里的端口 6000\nkubectl exec deploy/my-deployment -- ls                   # 在 Deployment 里的第一个 Pod 的第一个容器里运行命令（单容器和多容器例子）`, `77339361000164870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl logs deploy/my-deployment                         <span class="token comment"># 获取一个 Deployment 的 Pod 的日志（单容器例子）</span>\nkubectl logs deploy/my-deployment -c my-container         <span class="token comment"># 获取一个 Deployment 的 Pod 的日志（多容器例子）</span>\n\nkubectl port-forward svc/my-service <span class="token number">5000</span>                  <span class="token comment"># 侦听本地端口 5000 并转发到 Service 后端端口 5000</span>\nkubectl port-forward svc/my-service <span class="token number">5000</span>:my-service-port  <span class="token comment"># 侦听本地端口 5000 并转发到名字为 &lt;my-service-port> 的 Service 目标端口</span>\n\nkubectl port-forward deploy/my-deployment <span class="token number">5000</span>:6000       <span class="token comment"># 侦听本地端口 5000 并转发到 &lt;my-deployment> 创建的 Pod 里的端口 6000</span>\nkubectl <span class="token builtin class-name">exec</span> deploy/my-deployment -- <span class="token function">ls</span>                   <span class="token comment"># 在 Deployment 里的第一个 Pod 的第一个容器里运行命令（单容器和多容器例子）</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="与节点和集群进行交互"><a href="#%E4%B8%8E%E8%8A%82%E7%82%B9%E5%92%8C%E9%9B%86%E7%BE%A4%E8%BF%9B%E8%A1%8C%E4%BA%A4%E4%BA%92" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>与节点和集群进行交互</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70363376463974150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl cordon my-node                                                # 标记 my-node 节点为不可调度\nkubectl drain my-node                                                 # 对 my-node 节点进行清空操作，为节点维护做准备\nkubectl uncordon my-node                                              # 标记 my-node 节点为可以调度\nkubectl top node my-node                                              # 显示给定节点的度量值\nkubectl cluster-info                                                  # 显示主控节点和服务的地址\nkubectl cluster-info dump                                             # 将当前集群状态转储到标准输出\nkubectl cluster-info dump --output-directory=/path/to/cluster-state   # 将当前集群状态输出到 /path/to/cluster-state\n\n# 如果已存在具有指定键和效果的污点，则替换其值为指定值。\nkubectl taint nodes foo dedicated=special-user:NoSchedule`, `70363376463974150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl cordon my-node                                                <span class="token comment"># 标记 my-node 节点为不可调度</span>\nkubectl drain my-node                                                 <span class="token comment"># 对 my-node 节点进行清空操作，为节点维护做准备</span>\nkubectl uncordon my-node                                              <span class="token comment"># 标记 my-node 节点为可以调度</span>\nkubectl <span class="token function">top</span> node my-node                                              <span class="token comment"># 显示给定节点的度量值</span>\nkubectl cluster-info                                                  <span class="token comment"># 显示主控节点和服务的地址</span>\nkubectl cluster-info dump                                             <span class="token comment"># 将当前集群状态转储到标准输出</span>\nkubectl cluster-info dump --output-directory<span class="token operator">=</span>/path/to/cluster-state   <span class="token comment"># 将当前集群状态输出到 /path/to/cluster-state</span>\n\n<span class="token comment"># 如果已存在具有指定键和效果的污点，则替换其值为指定值。</span>\nkubectl taint nodes foo <span class="token assign-left variable">dedicated</span><span class="token operator">=</span>special-user:NoSchedule</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h5 id="资源类型"><a href="#%E8%B5%84%E6%BA%90%E7%B1%BB%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>资源类型</h5>\n<p>列出所支持的全部资源类型和它们的简称、API 组, 是否是名字空间作用域和 Kind。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91093625321154990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl api-resources`, `91093625321154990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl api-resources</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>用于探索 API 资源的其他操作：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6862191487196511000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kubectl api-resources --namespaced=true      # 所有命名空间作用域的资源\nkubectl api-resources --namespaced=false     # 所有非命名空间作用域的资源\nkubectl api-resources -o name                # 用简单格式列举所有资源（仅显示资源名称）\nkubectl api-resources -o wide                # 用扩展格式列举所有资源（又称 &quot;wide&quot; 格式）\nkubectl api-resources --verbs=list,get       # 支持 &quot;list&quot; 和 &quot;get&quot; 请求动词的所有资源\nkubectl api-resources --api-group=extensions # &quot;extensions&quot; API 组中的所有资源`, `6862191487196511000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">kubectl api-resources --namespaced<span class="token operator">=</span>true      <span class="token comment"># 所有命名空间作用域的资源</span>\nkubectl api-resources --namespaced<span class="token operator">=</span>false     <span class="token comment"># 所有非命名空间作用域的资源</span>\nkubectl api-resources -o name                <span class="token comment"># 用简单格式列举所有资源（仅显示资源名称）</span>\nkubectl api-resources -o wide                <span class="token comment"># 用扩展格式列举所有资源（又称 "wide" 格式）</span>\nkubectl api-resources --verbs<span class="token operator">=</span>list,get       <span class="token comment"># 支持 "list" 和 "get" 请求动词的所有资源</span>\nkubectl api-resources --api-group<span class="token operator">=</span>extensions <span class="token comment"># "extensions" API 组中的所有资源</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h5 id="格式化输出"><a href="#%E6%A0%BC%E5%BC%8F%E5%8C%96%E8%BE%93%E5%87%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>格式化输出</h5>\n<p>要以特定格式将详细信息输出到终端窗口，将 <code class="language-text">-o</code>（或者 <code class="language-text">--output</code>）参数添加到支持的 kubectl 命令中。</p>\n<table>\n<thead>\n<tr>\n<th align="left">输出格式</th>\n<th align="left">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left"><code class="language-text">-o=custom-columns=&lt;spec&gt;</code></td>\n<td align="left">使用逗号分隔的自定义列来打印表格</td>\n</tr>\n<tr>\n<td align="left"><code class="language-text">-o=custom-columns-file=&lt;filename&gt;</code></td>\n<td align="left">使用 \n<code class="language-text">&lt;filename&gt;</code>\n 文件中的自定义列模板打印表格</td>\n</tr>\n<tr>\n<td align="left">-o=json</td>\n<td align="left">输出 JSON 格式的 API 对象</td>\n</tr>\n<tr>\n<td align="left"><code class="language-text">-o=jsonpath=&lt;template&gt;</code></td>\n<td align="left">打印 jsonpath 表达式中定义的字段</td>\n</tr>\n<tr>\n<td align="left"><code class="language-text">-o=jsonpath-file=&lt;filename&gt;</code></td>\n<td align="left">打印在 \n<code class="language-text">&lt;filename&gt;</code>\n 文件中定义的 jsonpath 表达式所指定的字段。</td>\n</tr>\n<tr>\n<td align="left">-o=name</td>\n<td align="left">仅打印资源名称而不打印其他内容</td>\n</tr>\n<tr>\n<td align="left">-o=wide</td>\n<td align="left">以纯文本格式输出额外信息，对于 Pod 来说，输出中包含了节点名称</td>\n</tr>\n<tr>\n<td align="left">-o=yaml</td>\n<td align="left">输出 YAML 格式的 API 对象</td>\n</tr>\n</tbody>\n</table>\n<p>使用 <code class="language-text">-o=custom-columns</code> 的示例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68325811452749140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 集群中运行着的所有镜像\nkubectl get pods -A -o=custom-columns=\'DATA:spec.containers[*].image\'\n\n# 列举 default 名字空间中运行的所有镜像，按 Pod 分组\nkubectl get pods --namespace default --output=custom-columns=&quot;NAME:.metadata.name,IMAGE:.spec.containers[*].image&quot;\n\n# 除 &quot;k8s.gcr.io/coredns:1.6.2&quot; 之外的所有镜像\nkubectl get pods -A -o=custom-columns=\'DATA:spec.containers[?(@.image!=&quot;k8s.gcr.io/coredns:1.6.2&quot;)].image\'\n\n# 输出 metadata 下面的所有字段，无论 Pod 名字为何\nkubectl get pods -A -o=custom-columns=\'DATA:metadata.*\'`, `68325811452749140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 集群中运行着的所有镜像</span>\nkubectl get pods -A -o<span class="token operator">=</span>custom-columns<span class="token operator">=</span><span class="token string">\'DATA:spec.containers[*].image\'</span>\n\n<span class="token comment"># 列举 default 名字空间中运行的所有镜像，按 Pod 分组</span>\nkubectl get pods --namespace default --output<span class="token operator">=</span>custom-columns<span class="token operator">=</span><span class="token string">"NAME:.metadata.name,IMAGE:.spec.containers[*].image"</span>\n\n<span class="token comment"># 除 "k8s.gcr.io/coredns:1.6.2" 之外的所有镜像</span>\nkubectl get pods -A -o<span class="token operator">=</span>custom-columns<span class="token operator">=</span><span class="token string">\'DATA:spec.containers[?(@.image!="k8s.gcr.io/coredns:1.6.2")].image\'</span>\n\n<span class="token comment"># 输出 metadata 下面的所有字段，无论 Pod 名字为何</span>\nkubectl get pods -A -o<span class="token operator">=</span>custom-columns<span class="token operator">=</span><span class="token string">\'DATA:metadata.*\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有关更多示例，请参看 <a href="https://kubernetes.io/zh-cn/docs/reference/kubectl/#custom-columns" target="_blank" rel="nofollow noreferrer noopener">kubectl 参考文档</a>。</p>\n<h5 id="kubectl-日志输出详细程度和调试"><a href="#kubectl-%E6%97%A5%E5%BF%97%E8%BE%93%E5%87%BA%E8%AF%A6%E7%BB%86%E7%A8%8B%E5%BA%A6%E5%92%8C%E8%B0%83%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kubectl 日志输出详细程度和调试</h5>\n<p>Kubectl 日志输出详细程度是通过 <code class="language-text">-v</code> 或者 <code class="language-text">--v</code> 来控制的，参数后跟一个数字表示日志的级别。Kubernetes 通用的日志习惯和相关的日志级别在 <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-instrumentation/logging.md" target="_blank" rel="nofollow noreferrer noopener">这里</a> 有相应的描述。</p>\n<table>\n<thead>\n<tr>\n<th align="left">详细程度</th>\n<th align="left">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">—v=0</td>\n<td align="left">用于那些应该 始终 对运维人员可见的信息，因为这些信息一般很有用。</td>\n</tr>\n<tr>\n<td align="left">—v=1</td>\n<td align="left">如果您不想要看到冗余信息，此值是一个合理的默认日志级别。</td>\n</tr>\n<tr>\n<td align="left">—v=2</td>\n<td align="left">输出有关服务的稳定状态的信息以及重要的日志消息，这些信息可能与系统中的重大变化有关。这是建议大多数系统设置的默认日志级别。</td>\n</tr>\n<tr>\n<td align="left">—v=3</td>\n<td align="left">包含有关系统状态变化的扩展信息。</td>\n</tr>\n<tr>\n<td align="left">—v=4</td>\n<td align="left">包含调试级别的冗余信息。</td>\n</tr>\n<tr>\n<td align="left">—v=5</td>\n<td align="left">跟踪级别的详细程度。</td>\n</tr>\n<tr>\n<td align="left">—v=6</td>\n<td align="left">显示所请求的资源。</td>\n</tr>\n<tr>\n<td align="left">—v=7</td>\n<td align="left">显示 HTTP 请求头。</td>\n</tr>\n<tr>\n<td align="left">—v=8</td>\n<td align="left">显示 HTTP 请求内容。</td>\n</tr>\n<tr>\n<td align="left">—v=9</td>\n<td align="left">显示 HTTP 请求内容而且不截断内容。</td>\n</tr>\n</tbody>\n</table>\n<p>// TODO <a href="https://vuepress.mirror.docker-practice.com/security/" target="_blank" rel="nofollow noreferrer noopener">https://vuepress.mirror.docker-practice.com/security/</a></p>',
excerpt:"基本概念 镜像 Docker…",timeToRead:164,tableOfContents:'<ul>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5">基本概念</a></p>\n<ul>\n<li>\n<p><a href="/docker-introduce-learning/#%E9%95%9C%E5%83%8F">镜像</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E5%88%86%E5%B1%82%E5%AD%98%E5%82%A8">分层存储</a></li>\n</ul>\n</li>\n<li><a href="/docker-introduce-learning/#%E5%AE%B9%E5%99%A8">容器</a></li>\n<li>\n<p><a href="/docker-introduce-learning/#%E4%BB%93%E5%BA%93">仓库</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#docker-registry-%E5%85%AC%E5%BC%80%E6%9C%8D%E5%8A%A1">Docker Registry 公开服务</a></li>\n<li><a href="/docker-introduce-learning/#%E7%A7%81%E6%9C%89-docker-registry">私有 Docker Registry</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E4%BD%BF%E7%94%A8%E9%95%9C%E5%83%8F">使用镜像</a></p>\n<ul>\n<li>\n<p><a href="/docker-introduce-learning/#%E8%8E%B7%E5%8F%96%E9%95%9C%E5%83%8F">获取镜像</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E8%BF%90%E8%A1%8C">运行</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%88%97%E5%87%BA%E9%95%9C%E5%83%8F">列出镜像</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E9%95%9C%E5%83%8F%E4%BD%93%E7%A7%AF">镜像体积</a></li>\n<li><a href="/docker-introduce-learning/#%E8%99%9A%E6%82%AC%E9%95%9C%E5%83%8F">虚悬镜像</a></li>\n<li><a href="/docker-introduce-learning/#%E4%B8%AD%E9%97%B4%E5%B1%82%E9%95%9C%E5%83%8F">中间层镜像</a></li>\n<li><a href="/docker-introduce-learning/#%E5%88%97%E5%87%BA%E9%83%A8%E5%88%86%E9%95%9C%E5%83%8F">列出部分镜像</a></li>\n<li><a href="/docker-introduce-learning/#%E4%BB%A5%E7%89%B9%E5%AE%9A%E6%A0%BC%E5%BC%8F%E6%98%BE%E7%A4%BA">以特定格式显示</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%88%A0%E9%99%A4%E6%9C%AC%E5%9C%B0%E9%95%9C%E5%83%8F">删除本地镜像</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E7%94%A8-id%E3%80%81%E9%95%9C%E5%83%8F%E5%90%8D%E3%80%81%E6%91%98%E8%A6%81%E5%88%A0%E9%99%A4%E9%95%9C%E5%83%8F">用 ID、镜像名、摘要删除镜像</a></li>\n<li><a href="/docker-introduce-learning/#untagged-%E5%92%8C-deleted">Untagged 和 Deleted</a></li>\n<li><a href="/docker-introduce-learning/#%E7%94%A8-docker-image-ls-%E5%91%BD%E4%BB%A4%E6%9D%A5%E9%85%8D%E5%90%88">用 docker image ls 命令来配合</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%88%A9%E7%94%A8-commit-%E7%90%86%E8%A7%A3%E9%95%9C%E5%83%8F%E6%9E%84%E6%88%90">利用 commit 理解镜像构成</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E6%85%8E%E7%94%A8-docker-commit">慎用 docker commit</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E4%BD%BF%E7%94%A8-dockerfile-%E5%AE%9A%E5%88%B6%E9%95%9C%E5%83%8F">使用 Dockerfile 定制镜像</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#from-%E6%8C%87%E5%AE%9A%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F">FROM 指定基础镜像</a></li>\n<li><a href="/docker-introduce-learning/#run-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4">RUN 执行命令</a></li>\n<li><a href="/docker-introduce-learning/#%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F">构建镜像</a></li>\n<li><a href="/docker-introduce-learning/#%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E4%B8%8A%E4%B8%8B%E6%96%87%EF%BC%88context%EF%BC%89">镜像构建上下文（Context）</a></li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%85%B6%E5%AE%83-docker-build-%E7%9A%84%E7%94%A8%E6%B3%95">其它 docker build 的用法</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E7%9B%B4%E6%8E%A5%E7%94%A8-git-repo-%E8%BF%9B%E8%A1%8C%E6%9E%84%E5%BB%BA">直接用 Git repo 进行构建</a></li>\n<li><a href="/docker-introduce-learning/#%E7%94%A8%E7%BB%99%E5%AE%9A%E7%9A%84-tar-%E5%8E%8B%E7%BC%A9%E5%8C%85%E6%9E%84%E5%BB%BA">用给定的 tar 压缩包构建</a></li>\n<li><a href="/docker-introduce-learning/#%E4%BB%8E%E6%A0%87%E5%87%86%E8%BE%93%E5%85%A5%E4%B8%AD%E8%AF%BB%E5%8F%96-dockerfile-%E8%BF%9B%E8%A1%8C%E6%9E%84%E5%BB%BA">从标准输入中读取 Dockerfile 进行构建</a></li>\n<li><a href="/docker-introduce-learning/#%E4%BB%8E%E6%A0%87%E5%87%86%E8%BE%93%E5%85%A5%E4%B8%AD%E8%AF%BB%E5%8F%96%E4%B8%8A%E4%B8%8B%E6%96%87%E5%8E%8B%E7%BC%A9%E5%8C%85%E8%BF%9B%E8%A1%8C%E6%9E%84%E5%BB%BA">从标准输入中读取上下文压缩包进行构建</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%85%B6%E5%AE%83%E5%88%B6%E4%BD%9C%E9%95%9C%E5%83%8F%E7%9A%84%E6%96%B9%E5%BC%8F">其它制作镜像的方式</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E4%BB%8E-rootfs-%E5%8E%8B%E7%BC%A9%E5%8C%85%E5%AF%BC%E5%85%A5">从 rootfs 压缩包导入</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#docker-%E9%95%9C%E5%83%8F%E7%9A%84%E5%AF%BC%E5%85%A5%E5%92%8C%E5%AF%BC%E5%87%BA-docker-save-%E5%92%8C-docker-load">Docker 镜像的导入和导出 docker save 和 docker load</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E4%BF%9D%E5%AD%98%E9%95%9C%E5%83%8F">保存镜像</a></li>\n</ul>\n</li>\n<li><a href="/docker-introduce-learning/#%E9%95%9C%E5%83%8F%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86">镜像的实现原理</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#dockerfile">Dockerfile</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#copy-%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6">COPY 复制文件</a></li>\n<li><a href="/docker-introduce-learning/#add-%E6%9B%B4%E9%AB%98%E7%BA%A7%E7%9A%84%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6">ADD 更高级的复制文件</a></li>\n<li><a href="/docker-introduce-learning/#cmd-%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4">CMD 容器启动命令</a></li>\n<li>\n<p><a href="/docker-introduce-learning/#entrypoint-%E5%85%A5%E5%8F%A3%E7%82%B9">ENTRYPOINT 入口点</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E5%9C%BA%E6%99%AF%E4%B8%80%EF%BC%9A%E8%AE%A9%E9%95%9C%E5%83%8F%E5%8F%98%E6%88%90%E5%83%8F%E5%91%BD%E4%BB%A4%E4%B8%80%E6%A0%B7%E4%BD%BF%E7%94%A8">场景一：让镜像变成像命令一样使用</a></li>\n<li><a href="/docker-introduce-learning/#%E5%9C%BA%E6%99%AF%E4%BA%8C%EF%BC%9A%E5%BA%94%E7%94%A8%E8%BF%90%E8%A1%8C%E5%89%8D%E7%9A%84%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C">场景二：应用运行前的准备工作</a></li>\n</ul>\n</li>\n<li><a href="/docker-introduce-learning/#env-%E8%AE%BE%E7%BD%AE%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F">ENV 设置环境变量</a></li>\n<li><a href="/docker-introduce-learning/#arg-%E6%9E%84%E5%BB%BA%E5%8F%82%E6%95%B0">ARG 构建参数</a></li>\n<li><a href="/docker-introduce-learning/#volume-%E5%AE%9A%E4%B9%89%E5%8C%BF%E5%90%8D%E5%8D%B7">VOLUME 定义匿名卷</a></li>\n<li><a href="/docker-introduce-learning/#expose-%E5%A3%B0%E6%98%8E%E7%AB%AF%E5%8F%A3">EXPOSE 声明端口</a></li>\n<li><a href="/docker-introduce-learning/#workdir-%E6%8C%87%E5%AE%9A%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95">WORKDIR 指定工作目录</a></li>\n<li><a href="/docker-introduce-learning/#user-%E6%8C%87%E5%AE%9A%E5%BD%93%E5%89%8D%E7%94%A8%E6%88%B7">USER 指定当前用户</a></li>\n<li><a href="/docker-introduce-learning/#healthcheck-%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5">HEALTHCHECK 健康检查</a></li>\n<li><a href="/docker-introduce-learning/#label-%E6%8C%87%E4%BB%A4">LABEL 指令</a></li>\n<li><a href="/docker-introduce-learning/#shell-%E6%8C%87%E4%BB%A4">SHELL 指令</a></li>\n<li><a href="/docker-introduce-learning/#onbuild-%E4%B8%BA%E4%BB%96%E4%BA%BA%E5%81%9A%E5%AB%81%E8%A1%A3%E8%A3%B3">ONBUILD 为他人做嫁衣裳</a></li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%9E%84%E5%BB%BA">多阶段构建</a></p>\n<ul>\n<li>\n<p><a href="/docker-introduce-learning/#%E4%B9%8B%E5%89%8D%E7%9A%84%E5%81%9A%E6%B3%95">之前的做法</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E5%85%A8%E9%83%A8%E6%94%BE%E5%85%A5%E4%B8%80%E4%B8%AA-dockerfile">全部放入一个 Dockerfile</a></li>\n<li><a href="/docker-introduce-learning/#%E5%88%86%E6%95%A3%E5%88%B0%E5%A4%9A%E4%B8%AA-dockerfile">分散到多个 Dockerfile</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E4%BD%BF%E7%94%A8%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%9E%84%E5%BB%BA">使用多阶段构建</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E5%8F%AA%E6%9E%84%E5%BB%BA%E6%9F%90%E4%B8%80%E9%98%B6%E6%AE%B5%E7%9A%84%E9%95%9C%E5%83%8F">只构建某一阶段的镜像</a></li>\n<li><a href="/docker-introduce-learning/#%E6%9E%84%E5%BB%BA%E6%97%B6%E4%BB%8E%E5%85%B6%E4%BB%96%E9%95%9C%E5%83%8F%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6">构建时从其他镜像复制文件</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E6%9E%84%E5%BB%BA%E5%A4%9A%E7%A7%8D%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E6%94%AF%E6%8C%81%E7%9A%84-docker-%E9%95%9C%E5%83%8F----docker-manifest-%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3">构建多种系统架构支持的 Docker 镜像 — docker manifest 命令详解</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F-1">构建镜像</a></li>\n<li><a href="/docker-introduce-learning/#%E5%88%9B%E5%BB%BA-manifest-%E5%88%97%E8%A1%A8">创建 manifest 列表</a></li>\n<li><a href="/docker-introduce-learning/#%E8%AE%BE%E7%BD%AE-manifest-%E5%88%97%E8%A1%A8">设置 manifest 列表</a></li>\n<li><a href="/docker-introduce-learning/#%E6%9F%A5%E7%9C%8B-manifest-%E5%88%97%E8%A1%A8">查看 manifest 列表</a></li>\n<li><a href="/docker-introduce-learning/#%E6%8E%A8%E9%80%81-manifest-%E5%88%97%E8%A1%A8">推送 manifest 列表</a></li>\n<li><a href="/docker-introduce-learning/#%E6%B5%8B%E8%AF%95">测试</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E6%93%8D%E4%BD%9C%E5%AE%B9%E5%99%A8">操作容器</a></p>\n<ul>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8">启动容器</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E6%96%B0%E5%BB%BA%E5%B9%B6%E5%90%AF%E5%8A%A8">新建并启动</a></li>\n<li><a href="/docker-introduce-learning/#%E5%90%AF%E5%8A%A8%E5%B7%B2%E7%BB%88%E6%AD%A2%E5%AE%B9%E5%99%A8">启动已终止容器</a></li>\n</ul>\n</li>\n<li><a href="/docker-introduce-learning/#%E5%90%8E%E5%8F%B0%E8%BF%90%E8%A1%8C">后台运行</a></li>\n<li><a href="/docker-introduce-learning/#%E7%BB%88%E6%AD%A2%E5%AE%B9%E5%99%A8">终止容器</a></li>\n<li>\n<p><a href="/docker-introduce-learning/#%E8%BF%9B%E5%85%A5%E5%AE%B9%E5%99%A8">进入容器</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#attach-%E5%91%BD%E4%BB%A4">attach 命令</a></li>\n<li><a href="/docker-introduce-learning/#exec-%E5%91%BD%E4%BB%A4--i--t-%E5%8F%82%E6%95%B0">exec 命令 -i -t 参数</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%AF%BC%E5%87%BA%E5%92%8C%E5%AF%BC%E5%85%A5%E5%AE%B9%E5%99%A8">导出和导入容器</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E5%AF%BC%E5%87%BA%E5%AE%B9%E5%99%A8">导出容器</a></li>\n<li><a href="/docker-introduce-learning/#%E5%AF%BC%E5%85%A5%E5%AE%B9%E5%99%A8%E5%BF%AB%E7%85%A7">导入容器快照</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%88%A0%E9%99%A4%E5%AE%B9%E5%99%A8">删除容器</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E6%B8%85%E7%90%86%E6%89%80%E6%9C%89%E5%A4%84%E4%BA%8E%E7%BB%88%E6%AD%A2%E7%8A%B6%E6%80%81%E7%9A%84%E5%AE%B9%E5%99%A8">清理所有处于终止状态的容器</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#docker-%E4%BB%93%E5%BA%93">Docker 仓库</a></p>\n<ul>\n<li>\n<p><a href="/docker-introduce-learning/#docker-hub">Docker Hub</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E6%B3%A8%E5%86%8C">注册</a></li>\n<li><a href="/docker-introduce-learning/#%E7%99%BB%E5%BD%95">登录</a></li>\n<li><a href="/docker-introduce-learning/#%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F">拉取镜像</a></li>\n<li><a href="/docker-introduce-learning/#%E6%8E%A8%E9%80%81%E9%95%9C%E5%83%8F">推送镜像</a></li>\n<li><a href="/docker-introduce-learning/#%E8%87%AA%E5%8A%A8%E6%9E%84%E5%BB%BA">自动构建</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86">数据管理</a></p>\n<ul>\n<li>\n<p><a href="/docker-introduce-learning/#%E6%95%B0%E6%8D%AE%E5%8D%B7">数据卷</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%8D%B7">创建一个数据卷</a></li>\n<li><a href="/docker-introduce-learning/#%E5%90%AF%E5%8A%A8%E4%B8%80%E4%B8%AA%E6%8C%82%E8%BD%BD%E6%95%B0%E6%8D%AE%E5%8D%B7%E7%9A%84%E5%AE%B9%E5%99%A8">启动一个挂载数据卷的容器</a></li>\n<li><a href="/docker-introduce-learning/#%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE%E5%8D%B7%E7%9A%84%E5%85%B7%E4%BD%93%E4%BF%A1%E6%81%AF">查看数据卷的具体信息</a></li>\n<li><a href="/docker-introduce-learning/#%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE%E5%8D%B7">删除数据卷</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E6%8C%82%E8%BD%BD%E4%B8%BB%E6%9C%BA%E7%9B%AE%E5%BD%95">挂载主机目录</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E6%8C%82%E8%BD%BD%E4%B8%80%E4%B8%AA%E4%B8%BB%E6%9C%BA%E7%9B%AE%E5%BD%95%E4%BD%9C%E4%B8%BA%E6%95%B0%E6%8D%AE%E5%8D%B7">挂载一个主机目录作为数据卷</a></li>\n<li><a href="/docker-introduce-learning/#%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE%E5%8D%B7%E7%9A%84%E5%85%B7%E4%BD%93%E4%BF%A1%E6%81%AF-1">查看数据卷的具体信息</a></li>\n<li><a href="/docker-introduce-learning/#%E6%8C%82%E8%BD%BD%E4%B8%80%E4%B8%AA%E6%9C%AC%E5%9C%B0%E4%B8%BB%E6%9C%BA%E6%96%87%E4%BB%B6%E4%BD%9C%E4%B8%BA%E6%95%B0%E6%8D%AE%E5%8D%B7">挂载一个本地主机文件作为数据卷</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E7%BD%91%E7%BB%9C">网络</a></p>\n<ul>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%A4%96%E9%83%A8%E8%AE%BF%E9%97%AE%E5%AE%B9%E5%99%A8">外部访问容器</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E6%98%A0%E5%B0%84%E6%89%80%E6%9C%89%E6%8E%A5%E5%8F%A3%E5%9C%B0%E5%9D%80">映射所有接口地址</a></li>\n<li><a href="/docker-introduce-learning/#%E6%98%A0%E5%B0%84%E5%88%B0%E6%8C%87%E5%AE%9A%E5%9C%B0%E5%9D%80%E7%9A%84%E6%8C%87%E5%AE%9A%E7%AB%AF%E5%8F%A3">映射到指定地址的指定端口</a></li>\n<li><a href="/docker-introduce-learning/#%E6%98%A0%E5%B0%84%E5%88%B0%E6%8C%87%E5%AE%9A%E5%9C%B0%E5%9D%80%E7%9A%84%E4%BB%BB%E6%84%8F%E7%AB%AF%E5%8F%A3">映射到指定地址的任意端口</a></li>\n<li><a href="/docker-introduce-learning/#%E6%9F%A5%E7%9C%8B%E6%98%A0%E5%B0%84%E7%AB%AF%E5%8F%A3%E9%85%8D%E7%BD%AE">查看映射端口配置</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%AE%B9%E5%99%A8%E4%BA%92%E8%81%94">容器互联</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E6%96%B0%E5%BB%BA%E7%BD%91%E7%BB%9C">新建网络</a></li>\n<li><a href="/docker-introduce-learning/#%E8%BF%9E%E6%8E%A5%E5%AE%B9%E5%99%A8">连接容器</a></li>\n<li><a href="/docker-introduce-learning/#docker-compose">Docker Compose</a></li>\n</ul>\n</li>\n<li><a href="/docker-introduce-learning/#%E9%85%8D%E7%BD%AE-dns">配置 DNS</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE">高级网络配置</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E5%BF%AB%E9%80%9F%E9%85%8D%E7%BD%AE%E6%8C%87%E5%8D%97">快速配置指南</a></li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%AE%B9%E5%99%A8%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6">容器访问控制</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E5%AE%B9%E5%99%A8%E8%AE%BF%E9%97%AE%E5%A4%96%E9%83%A8%E7%BD%91%E7%BB%9C">容器访问外部网络</a></li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%AE%B9%E5%99%A8%E4%B9%8B%E9%97%B4%E8%AE%BF%E9%97%AE">容器之间访问</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E8%AE%BF%E9%97%AE%E6%89%80%E6%9C%89%E7%AB%AF%E5%8F%A3">访问所有端口</a></li>\n<li><a href="/docker-introduce-learning/#%E8%AE%BF%E9%97%AE%E6%8C%87%E5%AE%9A%E7%AB%AF%E5%8F%A3">访问指定端口</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E6%98%A0%E5%B0%84%E5%AE%B9%E5%99%A8%E7%AB%AF%E5%8F%A3%E5%88%B0%E5%AE%BF%E4%B8%BB%E4%B8%BB%E6%9C%BA%E7%9A%84%E5%AE%9E%E7%8E%B0">映射容器端口到宿主主机的实现</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E5%AE%B9%E5%99%A8%E8%AE%BF%E9%97%AE%E5%A4%96%E9%83%A8%E5%AE%9E%E7%8E%B0">容器访问外部实现</a></li>\n<li><a href="/docker-introduce-learning/#%E5%A4%96%E9%83%A8%E8%AE%BF%E9%97%AE%E5%AE%B9%E5%99%A8%E5%AE%9E%E7%8E%B0">外部访问容器实现</a></li>\n</ul>\n</li>\n<li><a href="/docker-introduce-learning/#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E6%A1%A5">自定义网桥</a></li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%B7%A5%E5%85%B7%E5%92%8C%E7%A4%BA%E4%BE%8B">工具和示例</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#pipework">pipework</a></li>\n<li><a href="/docker-introduce-learning/#playground">playground</a></li>\n</ul>\n</li>\n<li><a href="/docker-introduce-learning/#%E7%BC%96%E8%BE%91%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">编辑网络配置文件</a></li>\n<li><a href="/docker-introduce-learning/#%E7%A4%BA%E4%BE%8B%EF%BC%9A%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%82%B9%E5%88%B0%E7%82%B9%E8%BF%9E%E6%8E%A5">示例：创建一个点到点连接</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#swarm-mode">Swarm mode</a></p>\n<ul>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-1">基本概念</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E8%8A%82%E7%82%B9">节点</a></li>\n<li><a href="/docker-introduce-learning/#%E6%9C%8D%E5%8A%A1%E5%92%8C%E4%BB%BB%E5%8A%A1">服务和任务</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%88%9B%E5%BB%BA-swarm-%E9%9B%86%E7%BE%A4">创建 Swarm 集群</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4">初始化集群</a></li>\n<li><a href="/docker-introduce-learning/#%E5%A2%9E%E5%8A%A0%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9">增加工作节点</a></li>\n<li><a href="/docker-introduce-learning/#%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4">查看集群</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E9%83%A8%E7%BD%B2%E6%9C%8D%E5%8A%A1">部署服务</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E6%96%B0%E5%BB%BA%E6%9C%8D%E5%8A%A1">新建服务</a></li>\n<li><a href="/docker-introduce-learning/#%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1">查看服务</a></li>\n<li><a href="/docker-introduce-learning/#%E6%9C%8D%E5%8A%A1%E4%BC%B8%E7%BC%A9">服务伸缩</a></li>\n<li><a href="/docker-introduce-learning/#%E5%88%A0%E9%99%A4%E6%9C%8D%E5%8A%A1">删除服务</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%9C%A8-swarm-%E9%9B%86%E7%BE%A4%E4%B8%AD%E4%BD%BF%E7%94%A8-compose-%E6%96%87%E4%BB%B6">在 Swarm 集群中使用 compose 文件</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E9%83%A8%E7%BD%B2%E6%9C%8D%E5%8A%A1-1">部署服务</a></li>\n<li><a href="/docker-introduce-learning/#%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1-1">查看服务</a></li>\n<li><a href="/docker-introduce-learning/#%E7%A7%BB%E9%99%A4%E6%9C%8D%E5%8A%A1">移除服务</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%9C%A8-swarm-%E9%9B%86%E7%BE%A4%E4%B8%AD%E7%AE%A1%E7%90%86%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE">在 Swarm 集群中管理敏感数据</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E5%88%9B%E5%BB%BA-secret">创建 secret</a></li>\n<li><a href="/docker-introduce-learning/#%E6%9F%A5%E7%9C%8B-secret">查看 secret</a></li>\n<li><a href="/docker-introduce-learning/#%E5%88%9B%E5%BB%BA-mysql-%E6%9C%8D%E5%8A%A1">创建 MySQL 服务</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%9C%A8-swarm-%E9%9B%86%E7%BE%A4%E4%B8%AD%E7%AE%A1%E7%90%86%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE">在 Swarm 集群中管理配置数据</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E5%88%9B%E5%BB%BA-config">创建 config</a></li>\n<li><a href="/docker-introduce-learning/#%E6%9F%A5%E7%9C%8B-config">查看 config</a></li>\n<li><a href="/docker-introduce-learning/#%E5%88%9B%E5%BB%BA-redis-%E6%9C%8D%E5%8A%A1">创建 redis 服务</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#swarm-mode-%E4%B8%8E%E6%BB%9A%E5%8A%A8%E5%8D%87%E7%BA%A7">Swarm mode 与滚动升级</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E6%9C%8D%E5%8A%A1%E5%9B%9E%E9%80%80">服务回退</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#docker-buildx">Docker Buildx</a></p>\n<ul>\n<li>\n<p><a href="/docker-introduce-learning/#%E4%BD%BF%E7%94%A8-buildkit-%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F">使用 BuildKit 构建镜像</a></p>\n<ul>\n<li>\n<p><a href="/docker-introduce-learning/#dockerfile-%E6%96%B0%E5%A2%9E%E6%8C%87%E4%BB%A4%E8%AF%A6%E8%A7%A3">Dockerfile 新增指令详解</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#run---mounttypecache">RUN —mount=type=cache</a></li>\n<li><a href="/docker-introduce-learning/#run---mounttypebind">RUN —mount=type=bind</a></li>\n<li><a href="/docker-introduce-learning/#run---mounttypetmpfs">RUN —mount=type=tmpfs</a></li>\n<li><a href="/docker-introduce-learning/#run---mounttypesecret">RUN —mount=type=secret</a></li>\n<li><a href="/docker-introduce-learning/#run---mounttypessh">RUN —mount=type=ssh</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E4%BD%BF%E7%94%A8-buildx-%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F">使用 Buildx 构建镜像</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E4%BD%BF%E7%94%A8">使用</a></li>\n<li><a href="/docker-introduce-learning/#%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3">官方文档</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E4%BD%BF%E7%94%A8-buildx-%E6%9E%84%E5%BB%BA%E5%A4%9A%E7%A7%8D%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E6%94%AF%E6%8C%81%E7%9A%84-docker-%E9%95%9C%E5%83%8F">使用 buildx 构建多种系统架构支持的 Docker 镜像</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E6%96%B0%E5%BB%BA-builder-%E5%AE%9E%E4%BE%8B">新建 builder 实例</a></li>\n<li><a href="/docker-introduce-learning/#%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F-2">构建镜像</a></li>\n<li>\n<p><a href="/docker-introduce-learning/#%E6%9E%B6%E6%9E%84%E7%9B%B8%E5%85%B3%E5%8F%98%E9%87%8F">架构相关变量</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E4%BD%BF%E7%94%A8%E4%B8%BE%E4%BE%8B">使用举例</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#podman">podman</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E5%AE%89%E8%A3%85">安装</a></li>\n<li><a href="/docker-introduce-learning/#%E4%BD%BF%E7%94%A8-1">使用</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93">常见问题总结</a></p>\n<ul>\n<li>\n<p><a href="/docker-introduce-learning/#%E9%95%9C%E5%83%8F%E7%9B%B8%E5%85%B3">镜像相关</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E5%A6%82%E4%BD%95%E6%89%B9%E9%87%8F%E6%B8%85%E7%90%86%E4%B8%B4%E6%97%B6%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6%EF%BC%9F">如何批量清理临时镜像文件？</a></li>\n<li><a href="/docker-introduce-learning/#%E5%A6%82%E4%BD%95%E6%9F%A5%E7%9C%8B%E9%95%9C%E5%83%8F%E6%94%AF%E6%8C%81%E7%9A%84%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%EF%BC%9F">如何查看镜像支持的环境变量？</a></li>\n<li><a href="/docker-introduce-learning/#%E6%9C%AC%E5%9C%B0%E7%9A%84%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6%E9%83%BD%E5%AD%98%E6%94%BE%E5%9C%A8%E5%93%AA%E9%87%8C%EF%BC%9F">本地的镜像文件都存放在哪里？</a></li>\n<li><a href="/docker-introduce-learning/#%E6%9E%84%E5%BB%BA-docker-%E9%95%9C%E5%83%8F%E5%BA%94%E8%AF%A5%E9%81%B5%E5%BE%AA%E5%93%AA%E4%BA%9B%E5%8E%9F%E5%88%99%EF%BC%9F">构建 Docker 镜像应该遵循哪些原则？</a></li>\n<li><a href="/docker-introduce-learning/#%E7%A2%B0%E5%88%B0%E7%BD%91%E7%BB%9C%E9%97%AE%E9%A2%98%EF%BC%8C%E6%97%A0%E6%B3%95-pull-%E9%95%9C%E5%83%8F%EF%BC%8C%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%8C%87%E5%AE%9A-http_proxy-%E6%97%A0%E6%95%88%EF%BC%9F">碰到网络问题，无法 pull 镜像，命令行指定 &#x3C;code class="language-text">http_proxy&#x3C;/code> 无效？</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%AE%B9%E5%99%A8%E7%9B%B8%E5%85%B3">容器相关</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E5%AE%B9%E5%99%A8%E9%80%80%E5%87%BA%E5%90%8E%EF%BC%8C%E9%80%9A%E8%BF%87-docker-container-ls-%E5%91%BD%E4%BB%A4%E6%9F%A5%E7%9C%8B%E4%B8%8D%E5%88%B0%EF%BC%8C%E6%95%B0%E6%8D%AE%E4%BC%9A%E4%B8%A2%E5%A4%B1%E4%B9%88%EF%BC%9F">容器退出后，通过 &#x3C;code class="language-text">docker container ls&#x3C;/code> 命令查看不到，数据会丢失么？</a></li>\n<li><a href="/docker-introduce-learning/#%E5%A6%82%E4%BD%95%E5%81%9C%E6%AD%A2%E6%89%80%E6%9C%89%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E7%9A%84%E5%AE%B9%E5%99%A8%EF%BC%9F">如何停止所有正在运行的容器？</a></li>\n<li><a href="/docker-introduce-learning/#%E5%A6%82%E4%BD%95%E6%89%B9%E9%87%8F%E6%B8%85%E7%90%86%E5%B7%B2%E7%BB%8F%E5%81%9C%E6%AD%A2%E7%9A%84%E5%AE%B9%E5%99%A8%EF%BC%9F">如何批量清理已经停止的容器？</a></li>\n<li><a href="/docker-introduce-learning/#%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E6%9F%90%E4%B8%AA%E5%AE%B9%E5%99%A8%E7%9A%84-pid-%E4%BF%A1%E6%81%AF%EF%BC%9F">如何获取某个容器的 PID 信息？</a></li>\n<li><a href="/docker-introduce-learning/#%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E6%9F%90%E4%B8%AA%E5%AE%B9%E5%99%A8%E7%9A%84-ip-%E5%9C%B0%E5%9D%80%EF%BC%9F">如何获取某个容器的 IP 地址？</a></li>\n<li><a href="/docker-introduce-learning/#%E5%A6%82%E4%BD%95%E7%BB%99%E5%AE%B9%E5%99%A8%E6%8C%87%E5%AE%9A%E4%B8%80%E4%B8%AA%E5%9B%BA%E5%AE%9A-ip-%E5%9C%B0%E5%9D%80%EF%BC%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E6%AF%8F%E6%AC%A1%E9%87%8D%E5%90%AF%E5%AE%B9%E5%99%A8-ip-%E5%9C%B0%E5%9D%80%E9%83%BD%E4%BC%9A%E5%8F%98%EF%BC%9F">如何给容器指定一个固定 IP 地址，而不是每次重启容器 IP 地址都会变？</a></li>\n<li><a href="/docker-introduce-learning/#%E5%A6%82%E4%BD%95%E4%B8%B4%E6%97%B6%E9%80%80%E5%87%BA%E4%B8%80%E4%B8%AA%E6%AD%A3%E5%9C%A8%E4%BA%A4%E4%BA%92%E7%9A%84%E5%AE%B9%E5%99%A8%E7%9A%84%E7%BB%88%E7%AB%AF%EF%BC%8C%E8%80%8C%E4%B8%8D%E7%BB%88%E6%AD%A2%E5%AE%83%EF%BC%9F">如何临时退出一个正在交互的容器的终端，而不终止它？</a></li>\n<li><a href="/docker-introduce-learning/#%E4%BD%BF%E7%94%A8-docker-port-%E5%91%BD%E4%BB%A4%E6%98%A0%E5%B0%84%E5%AE%B9%E5%99%A8%E7%9A%84%E7%AB%AF%E5%8F%A3%E6%97%B6%EF%BC%8C%E7%B3%BB%E7%BB%9F%E6%8A%A5%E9%94%99-error-no-public-port-80-published-for-xxx%EF%BC%9F">使用 docker port 命令映射容器的端口时，系统报错 “Error: No public port ‘80’ published for xxx”？</a></li>\n<li><a href="/docker-introduce-learning/#%E5%8F%AF%E4%BB%A5%E5%9C%A8%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A8%E4%B8%AD%E5%90%8C%E6%97%B6%E8%BF%90%E8%A1%8C%E5%A4%9A%E4%B8%AA%E5%BA%94%E7%94%A8%E8%BF%9B%E7%A8%8B%E4%B9%88%EF%BC%9F">可以在一个容器中同时运行多个应用进程么？</a></li>\n<li><a href="/docker-introduce-learning/#%E5%A6%82%E4%BD%95%E6%8E%A7%E5%88%B6%E5%AE%B9%E5%99%A8%E5%8D%A0%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%B5%84%E6%BA%90%EF%BC%88cpu%E3%80%81%E5%86%85%E5%AD%98%EF%BC%89%E7%9A%84%E4%BB%BD%E9%A2%9D%EF%BC%9F">如何控制容器占用系统资源（CPU、内存）的份额？</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E4%BB%93%E5%BA%93%E7%9B%B8%E5%85%B3">仓库相关</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E4%BB%93%E5%BA%93%EF%BC%88repository%EF%BC%89%E3%80%81%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88registry%EF%BC%89%E3%80%81%E6%B3%A8%E5%86%8C%E7%B4%A2%E5%BC%95%EF%BC%88index%EF%BC%89%E6%9C%89%E4%BD%95%E5%85%B3%E7%B3%BB%EF%BC%9F">仓库（Repository）、注册服务器（Registry）、注册索引（Index）有何关系？</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E9%85%8D%E7%BD%AE%E7%9B%B8%E5%85%B3">配置相关</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#docker-%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%94%BE%E5%9C%A8%E5%93%AA%E9%87%8C%EF%BC%8C%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%EF%BC%9F">Docker 的配置文件放在哪里，如何修改配置？</a></li>\n<li><a href="/docker-introduce-learning/#%E5%A6%82%E4%BD%95%E6%9B%B4%E6%94%B9-docker-%E7%9A%84%E9%BB%98%E8%AE%A4%E5%AD%98%E5%82%A8%E4%BD%8D%E7%BD%AE%EF%BC%9F">如何更改 Docker 的默认存储位置？</a></li>\n<li><a href="/docker-introduce-learning/#%E4%BD%BF%E7%94%A8%E5%86%85%E5%AD%98%E5%92%8C-swap-%E9%99%90%E5%88%B6%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8%E6%97%B6%E5%80%99%E6%8A%A5%E8%AD%A6%E5%91%8A%EF%BC%9Awarning-your-kernel-does-not-support-cgroup-swap-limit-warning-your-kernel-does-not-support-swap-limit-capabilities-limitation-discarded%EF%BC%9F">使用内存和 swap 限制启动容器时候报警告：“WARNING: Your kernel does not support cgroup swap limit. WARNING: Your kernel does not support swap limit capabilities. Limitation discarded.“？</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#docker-%E4%B8%8E%E8%99%9A%E6%8B%9F%E5%8C%96">Docker 与虚拟化</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#docker-%E4%B8%8E-lxc%EF%BC%88linux-container%EF%BC%89%E6%9C%89%E4%BD%95%E4%B8%8D%E5%90%8C%EF%BC%9F">Docker 与 LXC（Linux Container）有何不同？</a></li>\n<li><a href="/docker-introduce-learning/#docker-%E4%B8%8E-vagrant-%E6%9C%89%E4%BD%95%E4%B8%8D%E5%90%8C%EF%BC%9F">Docker 与 Vagrant 有何不同？</a></li>\n<li><a href="/docker-introduce-learning/#%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E4%B8%AD-docker-%E5%92%8C-vagrant-%E8%AF%A5%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%EF%BC%9F">开发环境中 Docker 和 Vagrant 该如何选择？</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%85%B6%E5%AE%83">其它</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#docker-%E8%83%BD%E5%9C%A8%E9%9D%9E-linux-%E5%B9%B3%E5%8F%B0%EF%BC%88%E6%AF%94%E5%A6%82-windows-%E6%88%96-macos-%EF%BC%89%E4%B8%8A%E8%BF%90%E8%A1%8C%E4%B9%88%EF%BC%9F">Docker 能在非 Linux 平台（比如 Windows 或 macOS ）上运行么？</a></li>\n<li><a href="/docker-introduce-learning/#%E5%A6%82%E4%BD%95%E5%B0%86%E4%B8%80%E5%8F%B0%E5%AE%BF%E4%B8%BB%E4%B8%BB%E6%9C%BA%E7%9A%84-docker-%E7%8E%AF%E5%A2%83%E8%BF%81%E7%A7%BB%E5%88%B0%E5%8F%A6%E5%A4%96%E4%B8%80%E5%8F%B0%E5%AE%BF%E4%B8%BB%E4%B8%BB%E6%9C%BA%EF%BC%9F">如何将一台宿主主机的 Docker 环境迁移到另外一台宿主主机？</a></li>\n<li><a href="/docker-introduce-learning/#%E5%A6%82%E4%BD%95%E8%BF%9B%E5%85%A5-docker-%E5%AE%B9%E5%99%A8%E7%9A%84%E7%BD%91%E7%BB%9C%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%EF%BC%9F">如何进入 Docker 容器的网络命名空间？</a></li>\n<li><a href="/docker-introduce-learning/#%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E5%AE%B9%E5%99%A8%E7%BB%91%E5%AE%9A%E5%88%B0%E6%9C%AC%E5%9C%B0%E9%82%A3%E4%B8%AA-veth-%E6%8E%A5%E5%8F%A3%E4%B8%8A%EF%BC%9F">如何获取容器绑定到本地那个 veth 接口上？</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#docker-%E5%91%BD%E4%BB%A4">Docker 命令</a></p>\n<ul>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4docker">客户端命令(docker)</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4%E9%80%89%E9%A1%B9">客户端命令选项</a></li>\n<li><a href="/docker-introduce-learning/#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4">客户端命令</a></li>\n<li><a href="/docker-introduce-learning/#%E4%B8%80%E5%BC%A0%E5%9B%BE%E6%80%BB%E7%BB%93-docker-%E7%9A%84%E5%91%BD%E4%BB%A4">一张图总结 Docker 的命令</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%91%BD%E4%BB%A4dockerd">服务端命令(dockerd)</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#dockerd-%E5%91%BD%E4%BB%A4%E9%80%89%E9%A1%B9">dockerd 命令选项</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#dockerfile-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">Dockerfile 最佳实践</a></p>\n<ul>\n<li>\n<p><a href="/docker-introduce-learning/#%E4%B8%80%E8%88%AC%E6%80%A7%E7%9A%84%E6%8C%87%E5%8D%97%E5%92%8C%E5%BB%BA%E8%AE%AE">一般性的指南和建议</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E5%AE%B9%E5%99%A8%E5%BA%94%E8%AF%A5%E6%98%AF%E7%9F%AD%E6%9A%82%E7%9A%84">容器应该是短暂的</a></li>\n<li><a href="/docker-introduce-learning/#%E4%BD%BF%E7%94%A8-dockerignore-%E6%96%87%E4%BB%B6">使用 .dockerignore 文件</a></li>\n<li><a href="/docker-introduce-learning/#%E4%BD%BF%E7%94%A8%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%9E%84%E5%BB%BA-1">使用多阶段构建</a></li>\n<li><a href="/docker-introduce-learning/#%E9%81%BF%E5%85%8D%E5%AE%89%E8%A3%85%E4%B8%8D%E5%BF%85%E8%A6%81%E7%9A%84%E5%8C%85">避免安装不必要的包</a></li>\n<li><a href="/docker-introduce-learning/#%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A8%E5%8F%AA%E8%BF%90%E8%A1%8C%E4%B8%80%E4%B8%AA%E8%BF%9B%E7%A8%8B">一个容器只运行一个进程</a></li>\n<li><a href="/docker-introduce-learning/#%E9%95%9C%E5%83%8F%E5%B1%82%E6%95%B0%E5%B0%BD%E5%8F%AF%E8%83%BD%E5%B0%91">镜像层数尽可能少</a></li>\n<li><a href="/docker-introduce-learning/#%E5%B0%86%E5%A4%9A%E8%A1%8C%E5%8F%82%E6%95%B0%E6%8E%92%E5%BA%8F">将多行参数排序</a></li>\n<li><a href="/docker-introduce-learning/#%E6%9E%84%E5%BB%BA%E7%BC%93%E5%AD%98">构建缓存</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#dockerfile-%E6%8C%87%E4%BB%A4">Dockerfile 指令</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#from">FROM</a></li>\n<li><a href="/docker-introduce-learning/#label">LABEL</a></li>\n<li>\n<p><a href="/docker-introduce-learning/#run">RUN</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#apt-get">apt-get</a></li>\n</ul>\n</li>\n<li><a href="/docker-introduce-learning/#cmd">CMD</a></li>\n<li><a href="/docker-introduce-learning/#expose">EXPOSE</a></li>\n<li><a href="/docker-introduce-learning/#env">ENV</a></li>\n<li><a href="/docker-introduce-learning/#add-%E5%92%8C-copy">ADD 和 COPY</a></li>\n<li><a href="/docker-introduce-learning/#entrypoint">ENTRYPOINT</a></li>\n<li><a href="/docker-introduce-learning/#volume">VOLUME</a></li>\n<li><a href="/docker-introduce-learning/#user">USER</a></li>\n<li><a href="/docker-introduce-learning/#workdir">WORKDIR</a></li>\n</ul>\n</li>\n<li><a href="/docker-introduce-learning/#%E5%AE%98%E6%96%B9%E9%95%9C%E5%83%8F%E7%A4%BA%E4%BE%8B">官方镜像示例</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%A6%82%E4%BD%95%E8%B0%83%E8%AF%95-docker">如何调试 Docker</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E5%BC%80%E5%90%AF-debug-%E6%A8%A1%E5%BC%8F">开启 Debug 模式</a></li>\n<li><a href="/docker-introduce-learning/#%E6%A3%80%E6%9F%A5%E5%86%85%E6%A0%B8%E6%97%A5%E5%BF%97">检查内核日志</a></li>\n<li><a href="/docker-introduce-learning/#docker-%E4%B8%8D%E5%93%8D%E5%BA%94%E6%97%B6%E5%A4%84%E7%90%86">Docker 不响应时处理</a></li>\n<li><a href="/docker-introduce-learning/#%E9%87%8D%E7%BD%AE-docker-%E6%9C%AC%E5%9C%B0%E6%95%B0%E6%8D%AE">重置 Docker 本地数据</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#compose">Compose</a></p>\n<ul>\n<li>\n<p><a href="/docker-introduce-learning/#%E4%BD%BF%E7%94%A8-2">使用</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E6%9C%AF%E8%AF%AD">术语</a></li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%9C%BA%E6%99%AF">场景</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#web-%E5%BA%94%E7%94%A8">web 应用</a></li>\n<li><a href="/docker-introduce-learning/#dockerfile-1">Dockerfile</a></li>\n<li><a href="/docker-introduce-learning/#docker-composeyml">docker-compose.yml</a></li>\n<li><a href="/docker-introduce-learning/#%E8%BF%90%E8%A1%8C-compose-%E9%A1%B9%E7%9B%AE">运行 compose 项目</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#compose-%E5%91%BD%E4%BB%A4%E8%AF%B4%E6%98%8E">Compose 命令说明</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E5%91%BD%E4%BB%A4%E5%AF%B9%E8%B1%A1%E4%B8%8E%E6%A0%BC%E5%BC%8F">命令对象与格式</a></li>\n<li><a href="/docker-introduce-learning/#%E5%91%BD%E4%BB%A4%E9%80%89%E9%A1%B9">命令选项</a></li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%91%BD%E4%BB%A4%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E">命令使用说明</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#build">build</a></li>\n<li><a href="/docker-introduce-learning/#config">config</a></li>\n<li><a href="/docker-introduce-learning/#down">down</a></li>\n<li><a href="/docker-introduce-learning/#exec">exec</a></li>\n<li><a href="/docker-introduce-learning/#help">help</a></li>\n<li><a href="/docker-introduce-learning/#images">images</a></li>\n<li><a href="/docker-introduce-learning/#kill">kill</a></li>\n<li><a href="/docker-introduce-learning/#logs">logs</a></li>\n<li><a href="/docker-introduce-learning/#pause">pause</a></li>\n<li><a href="/docker-introduce-learning/#port">port</a></li>\n<li><a href="/docker-introduce-learning/#ps">ps</a></li>\n<li><a href="/docker-introduce-learning/#pull">pull</a></li>\n<li><a href="/docker-introduce-learning/#push">push</a></li>\n<li><a href="/docker-introduce-learning/#restart">restart</a></li>\n<li><a href="/docker-introduce-learning/#rm">rm</a></li>\n<li><a href="/docker-introduce-learning/#run-1">run</a></li>\n<li><a href="/docker-introduce-learning/#start">start</a></li>\n<li><a href="/docker-introduce-learning/#stop">stop</a></li>\n<li><a href="/docker-introduce-learning/#top">top</a></li>\n<li><a href="/docker-introduce-learning/#unpause">unpause</a></li>\n<li><a href="/docker-introduce-learning/#up">up</a></li>\n<li><a href="/docker-introduce-learning/#version">version</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#compose-%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6">Compose 模板文件</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#build-1">build</a></li>\n<li><a href="/docker-introduce-learning/#cap_add-cap_drop">&#x3C;code class="language-text">cap_add&#x3C;/code>, &#x3C;code class="language-text">cap_drop&#x3C;/code></a></li>\n<li><a href="/docker-introduce-learning/#command">command</a></li>\n<li><a href="/docker-introduce-learning/#configs">configs</a></li>\n<li><a href="/docker-introduce-learning/#cgroup_parent">cgroup_parent</a></li>\n<li><a href="/docker-introduce-learning/#container_name">container_name</a></li>\n<li><a href="/docker-introduce-learning/#deploy">deploy</a></li>\n<li><a href="/docker-introduce-learning/#devices">devices</a></li>\n<li><a href="/docker-introduce-learning/#depends_on">depends_on</a></li>\n<li><a href="/docker-introduce-learning/#dns">dns</a></li>\n<li><a href="/docker-introduce-learning/#dns_search">dns_search</a></li>\n<li><a href="/docker-introduce-learning/#tmpfs">tmpfs</a></li>\n<li><a href="/docker-introduce-learning/#env_file">env_file</a></li>\n<li><a href="/docker-introduce-learning/#environment">environment</a></li>\n<li><a href="/docker-introduce-learning/#expose-1">expose</a></li>\n<li><a href="/docker-introduce-learning/#external_links">external_links</a></li>\n<li><a href="/docker-introduce-learning/#extra_hosts">extra_hosts</a></li>\n<li><a href="/docker-introduce-learning/#healthcheck">healthcheck</a></li>\n<li><a href="/docker-introduce-learning/#image">image</a></li>\n<li><a href="/docker-introduce-learning/#labels">labels</a></li>\n<li><a href="/docker-introduce-learning/#links">links</a></li>\n<li><a href="/docker-introduce-learning/#logging">logging</a></li>\n<li><a href="/docker-introduce-learning/#network_mode">network_mode</a></li>\n<li><a href="/docker-introduce-learning/#networks">networks</a></li>\n<li><a href="/docker-introduce-learning/#pid">pid</a></li>\n<li><a href="/docker-introduce-learning/#ports">ports</a></li>\n<li><a href="/docker-introduce-learning/#secrets">secrets</a></li>\n<li><a href="/docker-introduce-learning/#security_opt">security_opt</a></li>\n<li><a href="/docker-introduce-learning/#stop_signal">stop_signal</a></li>\n<li><a href="/docker-introduce-learning/#sysctls">sysctls</a></li>\n<li><a href="/docker-introduce-learning/#ulimits">ulimits</a></li>\n<li><a href="/docker-introduce-learning/#volumes">volumes</a></li>\n<li><a href="/docker-introduce-learning/#%E5%85%B6%E5%AE%83%E6%8C%87%E4%BB%A4">其它指令</a></li>\n<li><a href="/docker-introduce-learning/#%E8%AF%BB%E5%8F%96%E5%8F%98%E9%87%8F">读取变量</a></li>\n</ul>\n</li>\n<li><a href="/docker-introduce-learning/#%E4%BD%BF%E7%94%A8-django">使用 Django</a></li>\n<li>\n<p><a href="/docker-introduce-learning/#%E4%BD%BF%E7%94%A8-wordpress">使用 WordPress</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E5%88%9B%E5%BB%BA%E7%A9%BA%E6%96%87%E4%BB%B6%E5%A4%B9">创建空文件夹</a></li>\n<li><a href="/docker-introduce-learning/#%E5%88%9B%E5%BB%BA-docker-composeyml-%E6%96%87%E4%BB%B6">创建 docker-compose.yml 文件</a></li>\n<li><a href="/docker-introduce-learning/#%E6%9E%84%E5%BB%BA%E5%B9%B6%E8%BF%90%E8%A1%8C%E9%A1%B9%E7%9B%AE">构建并运行项目</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#kubernetes">Kubernetes</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E9%A1%B9%E7%9B%AE%E7%AE%80%E4%BB%8B">项目简介</a></li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-2">基本概念</a></p>\n<ul>\n<li>\n<p><a href="/docker-introduce-learning/#%E8%8A%82%E7%82%B9-1">节点</a></p>\n<ul>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%AE%B9%E5%99%A8%E7%8A%B6%E6%80%81">容器状态</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E4%B8%BB%E6%9C%BA-ip">主机 IP</a></li>\n<li><a href="/docker-introduce-learning/#%E8%8A%82%E7%82%B9%E5%91%A8%E6%9C%9F">节点周期</a></li>\n<li><a href="/docker-introduce-learning/#%E8%8A%82%E7%82%B9%E7%8A%B6%E6%80%81">节点状态</a></li>\n</ul>\n</li>\n<li><a href="/docker-introduce-learning/#%E8%8A%82%E7%82%B9%E7%AE%A1%E7%90%86">节点管理</a></li>\n<li><a href="/docker-introduce-learning/#%E8%8A%82%E7%82%B9%E6%8E%A7%E5%88%B6">节点控制</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%AE%B9%E5%99%A8%E7%BB%84">容器组</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E5%AE%B9%E5%99%A8%E7%BB%84%E8%AE%BE%E8%AE%A1%E7%9A%84%E5%88%9D%E8%A1%B7">容器组设计的初衷</a></li>\n<li><a href="/docker-introduce-learning/#%E8%B5%84%E6%BA%90%E5%85%B1%E4%BA%AB%E5%92%8C%E9%80%9A%E4%BF%A1">资源共享和通信</a></li>\n<li><a href="/docker-introduce-learning/#%E5%AE%B9%E5%99%A8%E7%BB%84%E7%AE%A1%E7%90%86">容器组管理</a></li>\n<li><a href="/docker-introduce-learning/#%E5%AE%B9%E5%99%A8%E7%BB%84%E7%9A%84%E4%BD%BF%E7%94%A8">容器组的使用</a></li>\n<li><a href="/docker-introduce-learning/#%E6%9B%BF%E4%BB%A3%E6%96%B9%E6%A1%88">替代方案</a></li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%AE%B9%E5%99%A8%E7%BB%84%E7%9A%84%E7%94%9F%E5%91%BD%E7%8A%B6%E6%80%81">容器组的生命状态</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#pending">pending</a></li>\n<li><a href="/docker-introduce-learning/#running">running</a></li>\n<li><a href="/docker-introduce-learning/#succeeded">succeeded</a></li>\n<li><a href="/docker-introduce-learning/#failed">failed</a></li>\n</ul>\n</li>\n<li><a href="/docker-introduce-learning/#%E5%AE%B9%E5%99%A8%E7%BB%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">容器组生命周期</a></li>\n</ul>\n</li>\n<li><a href="/docker-introduce-learning/#replication-controllers">Replication Controllers</a></li>\n<li><a href="/docker-introduce-learning/#%E6%9C%8D%E5%8A%A1">服务</a></li>\n<li><a href="/docker-introduce-learning/#%E5%8D%B7">卷</a></li>\n<li><a href="/docker-introduce-learning/#%E6%A0%87%E7%AD%BE">标签</a></li>\n<li><a href="/docker-introduce-learning/#%E6%8E%A5%E5%8F%A3%E6%9D%83%E9%99%90">接口权限</a></li>\n<li><a href="/docker-introduce-learning/#web-%E7%95%8C%E9%9D%A2">web 界面</a></li>\n<li><a href="/docker-introduce-learning/#%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%93%8D%E4%BD%9C">命令行操作</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%9F%BA%E6%9C%AC%E6%9E%B6%E6%9E%84">基本架构</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E5%9F%BA%E6%9C%AC%E8%80%83%E8%99%91">基本考虑</a></li>\n<li><a href="/docker-introduce-learning/#%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86">运行原理</a></li>\n<li>\n<p><a href="/docker-introduce-learning/#%E6%8E%A7%E5%88%B6%E5%B9%B3%E9%9D%A2">控制平面</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E4%B8%BB%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1">主节点服务</a></li>\n<li><a href="/docker-introduce-learning/#etcd">Etcd</a></li>\n</ul>\n</li>\n<li><a href="/docker-introduce-learning/#%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9">工作节点</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E9%83%A8%E7%BD%B2-kubernetes">部署 Kubernetes</a></p>\n<ul>\n<li>\n<p><a href="/docker-introduce-learning/#%E4%BD%BF%E7%94%A8-kubeadm-%E9%83%A8%E7%BD%B2-kubernetescri-%E4%BD%BF%E7%94%A8-containerd">使用 kubeadm 部署 kubernetes(CRI 使用 containerd)</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E5%AE%89%E8%A3%85-containerd">安装 containerd</a></li>\n<li><a href="/docker-introduce-learning/#%E9%85%8D%E7%BD%AE-containerd">配置 containerd</a></li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%AE%89%E8%A3%85-kubelet-kubeadm-kubectl-cri-tools-kubernetes-cni">安装 kubelet kubeadm kubectl cri-tools kubernetes-cni</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#ubuntudebian">Ubuntu/Debian</a></li>\n<li><a href="/docker-introduce-learning/#centosfedora">CentOS/Fedora</a></li>\n</ul>\n</li>\n<li><a href="/docker-introduce-learning/#%E4%BF%AE%E6%94%B9%E5%86%85%E6%A0%B8%E7%9A%84%E8%BF%90%E8%A1%8C%E5%8F%82%E6%95%B0">修改内核的运行参数</a></li>\n<li>\n<p><a href="/docker-introduce-learning/#%E9%85%8D%E7%BD%AE-kubelet">配置 kubelet</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E4%BF%AE%E6%94%B9-kubeletservice">修改 kubelet.service</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E9%83%A8%E7%BD%B2">部署</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#master">master</a></li>\n<li><a href="/docker-introduce-learning/#node-%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9">node 工作节点</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1-2">查看服务</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E4%B8%BB%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1-1">主节点服务</a></li>\n<li><a href="/docker-introduce-learning/#%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1">工作节点服务</a></li>\n<li><a href="/docker-introduce-learning/#%E5%85%B6%E5%AE%83%E6%9C%8D%E5%8A%A1">其它服务</a></li>\n</ul>\n</li>\n<li><a href="/docker-introduce-learning/#%E4%BD%BF%E7%94%A8-3">使用</a></li>\n<li>\n<p><a href="/docker-introduce-learning/#%E9%83%A8%E7%BD%B2-cni">部署 CNI</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#flannel">flannel</a></li>\n</ul>\n</li>\n<li><a href="/docker-introduce-learning/#master-%E8%8A%82%E7%82%B9%E9%BB%98%E8%AE%A4%E4%B8%8D%E8%83%BD%E8%BF%90%E8%A1%8C-pod">master 节点默认不能运行 pod</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#docker-desktop-%E5%90%AF%E7%94%A8-kubernetes">Docker Desktop 启用 Kubernetes</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E8%8E%B7%E5%8F%96-k8sgcrio-%E9%95%9C%E5%83%8F">获取 k8s.gcr.io 镜像</a></li>\n<li><a href="/docker-introduce-learning/#%E5%90%AF%E7%94%A8-kubernetes">启用 Kubernetes</a></li>\n<li><a href="/docker-introduce-learning/#%E6%B5%8B%E8%AF%95-1">测试</a></li>\n</ul>\n</li>\n<li><a href="/docker-introduce-learning/#%E4%B8%80%E6%AD%A5%E6%AD%A5%E9%83%A8%E7%BD%B2-kubernetes-%E9%9B%86%E7%BE%A4">一步步部署 kubernetes 集群</a></li>\n<li>\n<p><a href="/docker-introduce-learning/#kubernetes-dashboard">Kubernetes Dashboard</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E9%83%A8%E7%BD%B2-1">部署</a></li>\n<li><a href="/docker-introduce-learning/#%E8%AE%BF%E9%97%AE">访问</a></li>\n<li><a href="/docker-introduce-learning/#%E7%99%BB%E5%BD%95-1">登录</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#kubernetes-%E5%91%BD%E4%BB%A4%E8%A1%8C-kubectl">Kubernetes 命令行 kubectl</a></p>\n<ul>\n<li>\n<p><a href="/docker-introduce-learning/#kubectl-%E4%BD%BF%E7%94%A8">kubectl 使用</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#get">get</a></li>\n<li><a href="/docker-introduce-learning/#describe">describe</a></li>\n<li><a href="/docker-introduce-learning/#create">create</a></li>\n<li><a href="/docker-introduce-learning/#update">update</a></li>\n<li><a href="/docker-introduce-learning/#delete">delete</a></li>\n<li><a href="/docker-introduce-learning/#log">log</a></li>\n<li><a href="/docker-introduce-learning/#rolling-update">rolling-update</a></li>\n<li><a href="/docker-introduce-learning/#exec-1">exec</a></li>\n<li><a href="/docker-introduce-learning/#port-forward">port-forward</a></li>\n<li><a href="/docker-introduce-learning/#proxy">proxy</a></li>\n<li><a href="/docker-introduce-learning/#run-2">run</a></li>\n<li><a href="/docker-introduce-learning/#expose-2">expose</a></li>\n<li><a href="/docker-introduce-learning/#label-1">label</a></li>\n<li><a href="/docker-introduce-learning/#config-1">config</a></li>\n<li><a href="/docker-introduce-learning/#cluster-info">cluster-info</a></li>\n<li><a href="/docker-introduce-learning/#api-versions">api-versions</a></li>\n<li><a href="/docker-introduce-learning/#version-1">version</a></li>\n<li><a href="/docker-introduce-learning/#help-1">help</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/docker-introduce-learning/#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4">常用命令</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#kubectl-apply---%E4%BB%A5%E6%96%87%E4%BB%B6%E6%88%96%E6%A0%87%E5%87%86%E8%BE%93%E5%85%A5%E4%B8%BA%E5%87%86%E5%BA%94%E7%94%A8%E6%88%96%E6%9B%B4%E6%96%B0%E8%B5%84%E6%BA%90">kubectl apply - 以文件或标准输入为准应用或更新资源</a></li>\n<li><a href="/docker-introduce-learning/#kubectl-get---%E5%88%97%E5%87%BA%E4%B8%80%E4%B8%AA%E6%88%96%E5%A4%9A%E4%B8%AA%E8%B5%84%E6%BA%90">kubectl get - 列出一个或多个资源</a></li>\n<li><a href="/docker-introduce-learning/#kubectl-describe---%E6%98%BE%E7%A4%BA%E4%B8%80%E4%B8%AA%E6%88%96%E5%A4%9A%E4%B8%AA%E8%B5%84%E6%BA%90%E7%9A%84%E8%AF%A6%E7%BB%86%E7%8A%B6%E6%80%81%EF%BC%8C%E9%BB%98%E8%AE%A4%E6%83%85%E5%86%B5%E4%B8%8B%E5%8C%85%E6%8B%AC%E6%9C%AA%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E8%B5%84%E6%BA%90">kubectl describe - 显示一个或多个资源的详细状态，默认情况下包括未初始化的资源</a></li>\n<li><a href="/docker-introduce-learning/#kubectl-delete---%E5%9F%BA%E4%BA%8E%E6%96%87%E4%BB%B6%E3%80%81%E6%A0%87%E5%87%86%E8%BE%93%E5%85%A5%E6%88%96%E9%80%9A%E8%BF%87%E6%8C%87%E5%AE%9A%E6%A0%87%E7%AD%BE%E9%80%89%E6%8B%A9%E5%99%A8%E3%80%81%E5%90%8D%E7%A7%B0%E3%80%81%E8%B5%84%E6%BA%90%E9%80%89%E6%8B%A9%E5%99%A8%E6%88%96%E8%B5%84%E6%BA%90%E6%9D%A5%E5%88%A0%E9%99%A4%E8%B5%84%E6%BA%90">kubectl delete - 基于文件、标准输入或通过指定标签选择器、名称、资源选择器或资源来删除资源</a></li>\n<li><a href="/docker-introduce-learning/#kubectl-exec---%E5%AF%B9-pod-%E4%B8%AD%E7%9A%84%E5%AE%B9%E5%99%A8%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4">kubectl exec - 对 Pod 中的容器执行命令</a></li>\n<li><a href="/docker-introduce-learning/#kubectl-logs---%E6%89%93%E5%8D%B0-pod-%E4%B8%AD%E5%AE%B9%E5%99%A8%E7%9A%84%E6%97%A5%E5%BF%97">kubectl logs - 打印 Pod 中容器的日志</a></li>\n<li><a href="/docker-introduce-learning/#kubectl-diff---%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E5%BB%BA%E8%AE%AE%E6%9B%B4%E6%96%B0%E7%9A%84%E5%B7%AE%E5%BC%82">kubectl diff - 查看集群建议更新的差异</a></li>\n<li>\n<p><a href="/docker-introduce-learning/#kubectl-%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8">Kubectl 自动补全</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#bash">BASH</a></li>\n<li><a href="/docker-introduce-learning/#zsh">ZSH</a></li>\n<li><a href="/docker-introduce-learning/#%E5%85%B3%E4%BA%8E---all-namespaces-%E7%9A%84%E4%B8%80%E7%82%B9%E8%AF%B4%E6%98%8E">关于 &#x3C;code class="language-text">--all-namespaces&#x3C;/code> 的一点说明</a></li>\n</ul>\n</li>\n<li><a href="/docker-introduce-learning/#kubectl-%E4%B8%8A%E4%B8%8B%E6%96%87%E5%92%8C%E9%85%8D%E7%BD%AE">Kubectl 上下文和配置</a></li>\n<li><a href="/docker-introduce-learning/#kubectl-apply">Kubectl apply</a></li>\n<li><a href="/docker-introduce-learning/#%E5%88%9B%E5%BB%BA%E5%AF%B9%E8%B1%A1">创建对象</a></li>\n<li><a href="/docker-introduce-learning/#%E6%9F%A5%E7%9C%8B%E5%92%8C%E6%9F%A5%E6%89%BE%E8%B5%84%E6%BA%90">查看和查找资源</a></li>\n<li><a href="/docker-introduce-learning/#%E6%9B%B4%E6%96%B0%E8%B5%84%E6%BA%90">更新资源</a></li>\n<li><a href="/docker-introduce-learning/#%E9%83%A8%E5%88%86%E6%9B%B4%E6%96%B0%E8%B5%84%E6%BA%90">部分更新资源</a></li>\n<li><a href="/docker-introduce-learning/#%E7%BC%96%E8%BE%91%E8%B5%84%E6%BA%90">编辑资源</a></li>\n<li><a href="/docker-introduce-learning/#%E5%AF%B9%E8%B5%84%E6%BA%90%E8%BF%9B%E8%A1%8C%E4%BC%B8%E7%BC%A9">对资源进行伸缩</a></li>\n<li><a href="/docker-introduce-learning/#%E5%88%A0%E9%99%A4%E8%B5%84%E6%BA%90">删除资源</a></li>\n<li><a href="/docker-introduce-learning/#%E4%B8%8E%E8%BF%90%E8%A1%8C%E4%B8%AD%E7%9A%84-pods-%E8%BF%9B%E8%A1%8C%E4%BA%A4%E4%BA%92">与运行中的 Pods 进行交互</a></li>\n<li><a href="/docker-introduce-learning/#%E4%BB%8E%E5%AE%B9%E5%99%A8%E4%B8%AD%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95">从容器中复制文件和目录</a></li>\n<li><a href="/docker-introduce-learning/#%E4%B8%8E-deployments-%E5%92%8C-services-%E8%BF%9B%E8%A1%8C%E4%BA%A4%E4%BA%92">与 Deployments 和 Services 进行交互</a></li>\n<li>\n<p><a href="/docker-introduce-learning/#%E4%B8%8E%E8%8A%82%E7%82%B9%E5%92%8C%E9%9B%86%E7%BE%A4%E8%BF%9B%E8%A1%8C%E4%BA%A4%E4%BA%92">与节点和集群进行交互</a></p>\n<ul>\n<li><a href="/docker-introduce-learning/#%E8%B5%84%E6%BA%90%E7%B1%BB%E5%9E%8B">资源类型</a></li>\n<li><a href="/docker-introduce-learning/#%E6%A0%BC%E5%BC%8F%E5%8C%96%E8%BE%93%E5%87%BA">格式化输出</a></li>\n<li><a href="/docker-introduce-learning/#kubectl-%E6%97%A5%E5%BF%97%E8%BE%93%E5%87%BA%E8%AF%A6%E7%BB%86%E7%A8%8B%E5%BA%A6%E5%92%8C%E8%B0%83%E8%AF%95">Kubectl 日志输出详细程度和调试</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>',
wordCount:{words:8470},frontmatter:{date:"2022-07-14 13:53:03",path:"/docker-introduce-learning/",tags:"后端, Docker, 读书笔记",title:"Docker入门学习",draft:null,catalog_number:null}},nextPost:{html:'<h1 id="webgl-三维几何加工"><a href="#webgl-%E4%B8%89%E7%BB%B4%E5%87%A0%E4%BD%95%E5%8A%A0%E5%B7%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 三维几何加工</h1>\n<p>有人问我怎么在 WebGL 中制作一个保龄球瓶，聪明的回答是<code class="language-text">使用一个三维建模工具例如 Blender, Maya, 3D Studio Max, Cinema 4D, 等等</code>。使用它创建一个保龄球瓶，导出，读取点坐标(OBJ 格式相对简单些)。</p>\n<p>但是，这让我想到，如果他们想做一个模型库该怎么办？</p>\n<p>这有几种方法，一种方法是将圆柱体按照正弦函数放置在合适位置上，但这样表面并不平滑。一个标准的圆柱需要一些间距相等的圆环，但当曲线变得锐利的时候所需圆环的数量就会很多。</p>\n<p>在模型库中你需要制作一个二维轮廓或者是一个符合边缘的曲线，然后将他们加工成三维图形。这里加工的意思就是将生成的二维点按照某些轴旋转。这样就可以很轻松的做出一些圆的物体，例如碗，棒球棒，瓶子，灯泡之类的物体。</p>\n<p>那么该怎么做呢？首先我们要通过某种方式生成一个曲线，计算曲线上的点。然后使用矩阵运算将这些点按照某个轴旋转，构建出三角形网格。</p>\n<h2 id="贝塞尔曲线"><a href="#%E8%B4%9D%E5%A1%9E%E5%B0%94%E6%9B%B2%E7%BA%BF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>贝塞尔曲线</h2>\n<p>计算机中常用的曲线就是贝塞尔曲线，你可能在一些编辑器例如 Adobe Illustrator 或 Inkscape 或 Affinity Designer 中编辑过贝塞尔曲线。</p>\n<p>贝塞尔曲线或三次贝塞尔曲线由 4 个点组成，2 个端点，2 个“控制点”。</p>\n<p>这就是四个点</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=0" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=0) -->\n<p>从 0 到 1 之间选一个数（叫做 t），其中 0 是起点，1 是终点。然后在每个线段中计算出与 t 相关的点，<code class="language-text">P1 P2</code>, <code class="language-text">P2 P3</code>, <code class="language-text">P3 P4</code>。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=1" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=1) -->\n<p>换句话说如果 <code class="language-text">t = .25</code> 那么就计算出 P1 到 P2 距离为 25% 的点，从 P2 到 P3 距离为 25% 的点，从 P3 到 P4 距离为 25% 的点。</p>\n<p>你可以拖动滑块调整 t 的值，也可以拖动 <code class="language-text">P1, P2, P3</code> 和 P4 调整位置。</p>\n<p>对这些结果点做同样的操作，计算 t 对应的 <code class="language-text">Q1 Q2</code> 和 <code class="language-text">Q2 Q3</code> 之间的点。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=2" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=2) -->\n<p>最后在 <code class="language-text">R1 R2</code> 中计算出与 t 相关的点。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=3" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=3) -->\n<p>红点的位置就构成了一个曲线。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=4" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=4) -->\n<p>这就是三次贝塞尔曲线。</p>\n<p>注意到在上述差值过程中通过 4 个点差出 3 个点，3 个点差出 2 个点，最后从 2 个点差出 1 个点，这并不是常用的做法，有人将这些数学运算简化成了一个公式，像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5529077700093321000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`invT = (1 - t)\nP = P1 * invT^3 +\n    P2 * 3 * t * invT^2 +\n    P3 * 3 * invT * t^2 +\n    P4 * t^3`, `5529077700093321000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">invT = (1 - t)\nP = P1 * invT^3 +\n    P2 * 3 * t * invT^2 +\n    P3 * 3 * invT * t^2 +\n    P4 * t^3</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其中 P1, P2, P3, P4 就像上例中的四个点，P 就是那个红点。</p>\n<p>在二维美术应用例如 Adobe Illustrator 中，当你制作一个较长的曲线时通常是由一些小的四点片段组成的。默认情况下应用将控制点沿着起/终点方向锁死，确保在公共点部分方向相反。</p>\n<p>看这个例子，移动 P3 或 P5 会同时移动另一个。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/xbsn5w?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>注意这个曲线是两段，<code class="language-text">P1,P2,P3,P4</code> 和 <code class="language-text">P4,P5,P6,P7</code>。只有在 P3，P5 与 P4 的连线方向相反时曲线在这一点才会连续。大多数应用可以让你断开连接，并获得一个锐利的拐点。取消选中复选框然后拖拽 P3 或 P5 就会清晰看到独立的曲线。</p>\n<p>接下来我们需要获得生成曲线上的点，通过给上方的公式提供 t 就可以生成一个点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28869499643628106000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function getPointOnBezierCurve(points, offset, t) {\n  const invT = 1 - t;\n  return v2.add(\n    v2.mult(points[offset + 0], invT * invT * invT),\n    v2.mult(points[offset + 1], 3 * t * invT * invT),\n    v2.mult(points[offset + 2], 3 * invT * t * t),\n    v2.mult(points[offset + 3], t * t * t)\n  );\n}`, `28869499643628106000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getPointOnBezierCurve</span><span class="token punctuation">(</span><span class="token parameter">points<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> t</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> invT <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> t<span class="token punctuation">;</span>\n  <span class="token keyword">return</span> v2<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>\n    v2<span class="token punctuation">.</span><span class="token function">mult</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> invT <span class="token operator">*</span> invT <span class="token operator">*</span> invT<span class="token punctuation">)</span><span class="token punctuation">,</span>\n    v2<span class="token punctuation">.</span><span class="token function">mult</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">*</span> t <span class="token operator">*</span> invT <span class="token operator">*</span> invT<span class="token punctuation">)</span><span class="token punctuation">,</span>\n    v2<span class="token punctuation">.</span><span class="token function">mult</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">*</span> invT <span class="token operator">*</span> t <span class="token operator">*</span> t<span class="token punctuation">)</span><span class="token punctuation">,</span>\n    v2<span class="token punctuation">.</span><span class="token function">mult</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t <span class="token operator">*</span> t <span class="token operator">*</span> t<span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后可以计算一系列点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58489815041258275000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function getPointsOnBezierCurve(points, offset, numPoints) {\n  const points = [];\n  for (let i = 0; i < numPoints; ++i) {\n    const t = i / (numPoints - 1);\n    points.push(getPointOnBezierCurve(points, offset, t));\n  }\n  return points;\n}`, `58489815041258275000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getPointsOnBezierCurve</span><span class="token punctuation">(</span><span class="token parameter">points<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> numPoints</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> points <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numPoints<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> t <span class="token operator">=</span> i <span class="token operator">/</span> <span class="token punctuation">(</span>numPoints <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    points<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">getPointOnBezierCurve</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> points<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意：<code class="language-text">v2.mult</code> 和 <code class="language-text">v2.add</code> 是我加入的二维点运算辅助方法。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=0%26showCurve=true%26showPoints=true" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=0%26showCurve=true%26showPoints=true) -->\n<p>在图示中你可以选择点的个数，如果曲线比较锐利就可以多差值一些点，如果曲线比较平缓就可以少插值一些点。一个解决办法是检查曲线的锐利程度，如果过于锐利就拆分成两个曲线。</p>\n<p>拆分的部分比较简单，如果我们再看看不同级别的拆分，对于任意值的 <code class="language-text">t, P1, Q1, R1</code>, 红点构成一个曲线，终点是红点。<code class="language-text">红点, R2, Q3, P4</code> 构成一个曲线。换句话说我们可以将曲线从任意位置分成两段，并且和原曲线相同。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=4%26show2Curves=true" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=4%26show2Curves=true) -->\n<p>第二个部分是如何决定曲线是否需要拆分，从网上查找后我发现了<a href="https://seant23.wordpress.com/2010/11/12/offset-bezier-curves/" target="_blank" rel="nofollow noreferrer noopener">这个方法</a>，对于给定的曲线可以求出平滑程度。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73848420044681630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function flatness(points, offset) {\n  const p1 = points[offset + 0];\n  const p2 = points[offset + 1];\n  const p3 = points[offset + 2];\n  const p4 = points[offset + 3];\n\n  let ux = 3 * p2[0] - 2 * p1[0] - p4[0];\n  ux *= ux;\n  let uy = 3 * p2[1] - 2 * p1[1] - p4[1];\n  uy *= uy;\n  let vx = 3 * p3[0] - 2 * p4[0] - p1[0];\n  vx *= vx;\n  let vy = 3 * p3[1] - 2 * p4[1] - p1[1];\n  vy *= vy;\n\n  if (ux < vx) {\n    ux = vx;\n  }\n\n  if (uy < vy) {\n    uy = vy;\n  }\n\n  return ux + uy;\n}`, `73848420044681630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">flatness</span><span class="token punctuation">(</span><span class="token parameter">points<span class="token punctuation">,</span> offset</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> p1 <span class="token operator">=</span> points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> p2 <span class="token operator">=</span> points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> p3 <span class="token operator">=</span> points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> p4 <span class="token operator">=</span> points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">let</span> ux <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">*</span> p2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> p1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> p4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  ux <span class="token operator">*=</span> ux<span class="token punctuation">;</span>\n  <span class="token keyword">let</span> uy <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">*</span> p2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> p4<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  uy <span class="token operator">*=</span> uy<span class="token punctuation">;</span>\n  <span class="token keyword">let</span> vx <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">*</span> p3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> p4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> p1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  vx <span class="token operator">*=</span> vx<span class="token punctuation">;</span>\n  <span class="token keyword">let</span> vy <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">*</span> p3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> p4<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  vy <span class="token operator">*=</span> vy<span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>ux <span class="token operator">&lt;</span> vx<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    ux <span class="token operator">=</span> vx<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>uy <span class="token operator">&lt;</span> vy<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    uy <span class="token operator">=</span> vy<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> ux <span class="token operator">+</span> uy<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以用它获取曲线上的点，首先检查曲线是否太锐利，如果是就拆分，不是就将点加入列表。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2868933979168231000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function getPointsOnBezierCurveWithSplitting(points, offset, tolerance, newPoints) {\n  const outPoints = newPoints || [];\n  if (flatness(points, offset) < tolerance) {\n    // 将它加入点队列中\n    outPoints.push(points[offset + 0]);\n    outPoints.push(points[offset + 3]);\n  } else {\n    // 拆分\n    const t = 0.5;\n    const p1 = points[offset + 0];\n    const p2 = points[offset + 1];\n    const p3 = points[offset + 2];\n    const p4 = points[offset + 3];\n\n    const q1 = v2.lerp(p1, p2, t);\n    const q2 = v2.lerp(p2, p3, t);\n    const q3 = v2.lerp(p3, p4, t);\n\n    const r1 = v2.lerp(q1, q2, t);\n    const r2 = v2.lerp(q2, q3, t);\n\n    const red = v2.lerp(r1, r2, t);\n\n    // 求前半段的点\n    getPointsOnBezierCurveWithSplitting([p1, q1, r1, red], 0, tolerance, outPoints);\n    // 求后半段的点\n    getPointsOnBezierCurveWithSplitting([red, r2, q3, p4], 0, tolerance, outPoints);\n  }\n  return outPoints;\n}`, `2868933979168231000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getPointsOnBezierCurveWithSplitting</span><span class="token punctuation">(</span><span class="token parameter">points<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> tolerance<span class="token punctuation">,</span> newPoints</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> outPoints <span class="token operator">=</span> newPoints <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">flatness</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> offset<span class="token punctuation">)</span> <span class="token operator">&lt;</span> tolerance<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 将它加入点队列中</span>\n    outPoints<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    outPoints<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 拆分</span>\n    <span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> p1 <span class="token operator">=</span> points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> p2 <span class="token operator">=</span> points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> p3 <span class="token operator">=</span> points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> p4 <span class="token operator">=</span> points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> q1 <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> q2 <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>p2<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> q3 <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>p3<span class="token punctuation">,</span> p4<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> r1 <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>q1<span class="token punctuation">,</span> q2<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> r2 <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>q2<span class="token punctuation">,</span> q3<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> red <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>r1<span class="token punctuation">,</span> r2<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 求前半段的点</span>\n    <span class="token function">getPointsOnBezierCurveWithSplitting</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span> q1<span class="token punctuation">,</span> r1<span class="token punctuation">,</span> red<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> tolerance<span class="token punctuation">,</span> outPoints<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 求后半段的点</span>\n    <span class="token function">getPointsOnBezierCurveWithSplitting</span><span class="token punctuation">(</span><span class="token punctuation">[</span>red<span class="token punctuation">,</span> r2<span class="token punctuation">,</span> q3<span class="token punctuation">,</span> p4<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> tolerance<span class="token punctuation">,</span> outPoints<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> outPoints<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=0%26showCurve=true%26showTolerance=true" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=0%26showCurve=true%26showTolerance=true) -->\n<p>这个算法在获取曲线点的过程中确保了点的数量比较充足，但是不能很好的排除不必要的点。</p>\n<p>由于这个原因我们将使用我在网上找到的 <a href="https://en.wikipedia.org/wiki/Ramer%E2%80%93Douglas%E2%80%93Peucker_algorithm" target="_blank" rel="nofollow noreferrer noopener">Ramer Douglas Peucker 算法</a>。</p>\n<p>在这个算法中我们提供一系列点，找到离最后两点构成的直线距离最远的点，然后将这个距离和一个定值进行比较，如果小于那个值就保留最后两个点然后丢弃其他的点，大于则将曲线沿那个最远点分成两份，分别对每一份再做一次这个运算。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42224048131135560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function simplifyPoints(points, start, end, epsilon, newPoints) {\n  const outPoints = newPoints || [];\n\n  // 找到离最后两点距离最远的点\n  const s = points[start];\n  const e = points[end - 1];\n  let maxDistSq = 0;\n  let maxNdx = 1;\n  for (let i = start + 1; i < end - 1; ++i) {\n    const distSq = v2.distanceToSegmentSq(points[i], s, e);\n    if (distSq > maxDistSq) {\n      maxDistSq = distSq;\n      maxNdx = i;\n    }\n  }\n\n  // 如果距离太远\n  if (Math.sqrt(maxDistSq) > epsilon) {\n    // 拆分\n    simplifyPoints(points, start, maxNdx + 1, epsilon, outPoints);\n    simplifyPoints(points, maxNdx, end, epsilon, outPoints);\n  } else {\n    // 添加最后两个点\n    outPoints.push(s, e);\n  }\n\n  return outPoints;\n}`, `42224048131135560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">simplifyPoints</span><span class="token punctuation">(</span><span class="token parameter">points<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">,</span> epsilon<span class="token punctuation">,</span> newPoints</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> outPoints <span class="token operator">=</span> newPoints <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 找到离最后两点距离最远的点</span>\n  <span class="token keyword">const</span> s <span class="token operator">=</span> points<span class="token punctuation">[</span>start<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> e <span class="token operator">=</span> points<span class="token punctuation">[</span>end <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> maxDistSq <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> maxNdx <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> start <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> end <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> distSq <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">distanceToSegmentSq</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>distSq <span class="token operator">></span> maxDistSq<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      maxDistSq <span class="token operator">=</span> distSq<span class="token punctuation">;</span>\n      maxNdx <span class="token operator">=</span> i<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 如果距离太远</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>maxDistSq<span class="token punctuation">)</span> <span class="token operator">></span> epsilon<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 拆分</span>\n    <span class="token function">simplifyPoints</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> start<span class="token punctuation">,</span> maxNdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> epsilon<span class="token punctuation">,</span> outPoints<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">simplifyPoints</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> maxNdx<span class="token punctuation">,</span> end<span class="token punctuation">,</span> epsilon<span class="token punctuation">,</span> outPoints<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 添加最后两个点</span>\n    outPoints<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> outPoints<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">v2.distanceToSegmentSq</code> 是计算点到线段距离平方的一个方法，使用距离平方的原因是比使用实际距离要快一些，因为我们值管线最远距离所以和实际距离的效果相同。</p>\n<p>这是结果，调整距离查看添加或删除的点。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=0%26showCurve=true%26showDistance=true" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=0%26showCurve=true%26showDistance=true) -->\n<h2 id="保龄球"><a href="#%E4%BF%9D%E9%BE%84%E7%90%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>保龄球</h2>\n<p>回到保龄球瓶，我们可以将上方的代码整理一下，需要添加和移除点，锁定和解锁控制点， 撤销等等。但是这有一个简单的方式，我们可以使用一个上方提到的编辑器，我使用这个在线编辑器。</p>\n<p>这是保龄球的半边轮廓的 svg。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-06-23-11-00-19-5c6116e919354caf873d05089e175041-80d40.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 640px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAAAZUlEQVQ4y2NgwA9YgJiVgUqACYh1gJiPWgbyALEylM1IDQO5gFiFgcoAZCAHNQyCeVEZ6nUGahmqBsTM1DKQH4iVqBEpyN7lHZQRAsshytR0HRPUQGZqJhlVIOampis5qZlkyAYA9fACRaHh3QoAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 06 23 11 00 19" title="" data-src="/static/2022-06-23-11-00-19-5c6116e919354caf873d05089e175041-80d40.png" data-srcset="/static/2022-06-23-11-00-19-5c6116e919354caf873d05089e175041-5da91.png 200w,\n/static/2022-06-23-11-00-19-5c6116e919354caf873d05089e175041-08121.png 400w,\n/static/2022-06-23-11-00-19-5c6116e919354caf873d05089e175041-80d40.png 640w" data-sizes="(max-width: 640px) 100vw, 640px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>由 4 个曲线制成，路径的数据像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55866863645119260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<path\n  fill=&quot;none&quot;\n  stroke-width=&quot;5&quot;\n  d=&quot;\n   m44,434\n   c18,-33 19,-66 15,-111\n   c-4,-45 -37,-104 -39,-132\n   c-2,-28 11,-51 16,-81\n   c5,-30 3,-63 -36,-63\n  &quot;\n/>`, `55866863645119260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="svg"\n              >\n                <span class="gatsby-code-button-language">svg</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="svg"><pre style="counter-reset: linenumber NaN" class="language-svg line-numbers"><code class="language-svg"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>path</span>\n  <span class="token attr-name">fill</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>none<span class="token punctuation">"</span></span>\n  <span class="token attr-name">stroke-width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span>\n  <span class="token attr-name">d</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>\n   m44,434\n   c18,-33 19,-66 15,-111\n   c-4,-45 -37,-104 -39,-132\n   c-2,-28 11,-51 16,-81\n   c5,-30 3,-63 -36,-63\n  <span class="token punctuation">"</span></span>\n<span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Tutorial/Paths" target="_blank" rel="nofollow noreferrer noopener">解译</a>这些数据得到这些点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68144793522733390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`        ___\n44, 371,   |\n62, 338,   | 第一个曲线\n63, 305,___|__\n59, 260,___|  |\n55, 215,      | 第二个曲线\n22, 156,______|__\n20, 128,______|  |\n18, 100,         | 第三个曲线\n31,  77,_________|__\n36,  47,_________|  |\n41,  17,            | 第四个曲线\n39, -16,            |\n 0, -16,____________|`, `68144793522733390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">        ___\n44, 371,   |\n62, 338,   | 第一个曲线\n63, 305,___|__\n59, 260,___|  |\n55, 215,      | 第二个曲线\n22, 156,______|__\n20, 128,______|  |\n18, 100,         | 第三个曲线\n31,  77,_________|__\n36,  47,_________|  |\n41,  17,            | 第四个曲线\n39, -16,            |\n 0, -16,____________|</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在有了曲线数据，需要计算出曲线上的点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37622931596065980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 获取所有片段的点\nfunction getPointsOnBezierCurves(points, tolerance) {\n  const newPoints = [];\n  const numSegments = (points.length - 1) / 3;\n  for (let i = 0; i < numSegments; ++i) {\n    const offset = i * 3;\n    getPointsOnBezierCurveWithSplitting(points, offset, tolerance, newPoints);\n  }\n  return newPoints;\n}`, `37622931596065980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 获取所有片段的点</span>\n<span class="token keyword">function</span> <span class="token function">getPointsOnBezierCurves</span><span class="token punctuation">(</span><span class="token parameter">points<span class="token punctuation">,</span> tolerance</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> newPoints <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> numSegments <span class="token operator">=</span> <span class="token punctuation">(</span>points<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numSegments<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> offset <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>\n    <span class="token function">getPointsOnBezierCurveWithSplitting</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> tolerance<span class="token punctuation">,</span> newPoints<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> newPoints<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用 simplifyPoints 处理结果。</p>\n<p>现在要旋转它们了，需要决定分多少个部分，对于每个部分都用矩阵运算绕 Y 轴转动一定角度获得，一旦获得所有点就用索引连接它们。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92862817623912420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 绕 Y 轴旋转\nfunction lathePoints(\n  points,\n  startAngle, // 起始角 (例如 0)\n  endAngle, // 终止角 (例如 Math.PI * 2)\n  numDivisions, // 这中间生成多少块\n  capStart, // true 就封闭起点\n  capEnd\n) {\n  // true 就封闭重点\n  const positions = [];\n  const texcoords = [];\n  const indices = [];\n\n  const vOffset = capStart ? 1 : 0;\n  const pointsPerColumn = points.length + vOffset + (capEnd ? 1 : 0);\n  const quadsDown = pointsPerColumn - 1;\n\n  // 生成点\n  for (let division = 0; division <= numDivisions; ++division) {\n    const u = division / numDivisions;\n    const angle = lerp(startAngle, endAngle, u) % (Math.PI * 2);\n    const mat = m4.yRotation(angle);\n    if (capStart) {\n      // 在开始处添加一个 Y 轴上的点\n      positions.push(0, points[0][1], 0);\n      texcoords.push(u, 0);\n    }\n    points.forEach((p, ndx) => {\n      const tp = m4.transformPoint(mat, [...p, 0]);\n      positions.push(tp[0], tp[1], tp[2]);\n      const v = (ndx + vOffset) / quadsDown;\n      texcoords.push(u, v);\n    });\n    if (capEnd) {\n      // 在终点处添加一个 Y 轴上的点\n      positions.push(0, points[points.length - 1][1], 0);\n      texcoords.push(u, 1);\n    }\n  }\n\n  // 创建索引\n  for (let division = 0; division < numDivisions; ++division) {\n    const column1Offset = division * pointsPerColumn;\n    const column2Offset = column1Offset + pointsPerColumn;\n    for (let quad = 0; quad < quadsDown; ++quad) {\n      indices.push(column1Offset + quad, column2Offset + quad, column1Offset + quad + 1);\n      indices.push(column1Offset + quad + 1, column2Offset + quad, column2Offset + quad + 1);\n    }\n  }\n\n  return {\n    position: positions,\n    texcoord: texcoords,\n    indices: indices\n  };\n}`, `92862817623912420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 绕 Y 轴旋转</span>\n<span class="token keyword">function</span> <span class="token function">lathePoints</span><span class="token punctuation">(</span>\n  points<span class="token punctuation">,</span>\n  startAngle<span class="token punctuation">,</span> <span class="token comment">// 起始角 (例如 0)</span>\n  endAngle<span class="token punctuation">,</span> <span class="token comment">// 终止角 (例如 Math.PI * 2)</span>\n  numDivisions<span class="token punctuation">,</span> <span class="token comment">// 这中间生成多少块</span>\n  capStart<span class="token punctuation">,</span> <span class="token comment">// true 就封闭起点</span>\n  capEnd\n<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// true 就封闭重点</span>\n  <span class="token keyword">const</span> positions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> texcoords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> indices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> vOffset <span class="token operator">=</span> capStart <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> pointsPerColumn <span class="token operator">=</span> points<span class="token punctuation">.</span>length <span class="token operator">+</span> vOffset <span class="token operator">+</span> <span class="token punctuation">(</span>capEnd <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> quadsDown <span class="token operator">=</span> pointsPerColumn <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 生成点</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> division <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> division <span class="token operator">&lt;=</span> numDivisions<span class="token punctuation">;</span> <span class="token operator">++</span>division<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> u <span class="token operator">=</span> division <span class="token operator">/</span> numDivisions<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> angle <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>startAngle<span class="token punctuation">,</span> endAngle<span class="token punctuation">,</span> u<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> mat <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">yRotation</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>capStart<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 在开始处添加一个 Y 轴上的点</span>\n      positions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> points<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      texcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    points<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p<span class="token punctuation">,</span> ndx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> tp <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">transformPoint</span><span class="token punctuation">(</span>mat<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">...</span>p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      positions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>tp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tp<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> v <span class="token operator">=</span> <span class="token punctuation">(</span>ndx <span class="token operator">+</span> vOffset<span class="token punctuation">)</span> <span class="token operator">/</span> quadsDown<span class="token punctuation">;</span>\n      texcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>capEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 在终点处添加一个 Y 轴上的点</span>\n      positions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> points<span class="token punctuation">[</span>points<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      texcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 创建索引</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> division <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> division <span class="token operator">&lt;</span> numDivisions<span class="token punctuation">;</span> <span class="token operator">++</span>division<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> column1Offset <span class="token operator">=</span> division <span class="token operator">*</span> pointsPerColumn<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> column2Offset <span class="token operator">=</span> column1Offset <span class="token operator">+</span> pointsPerColumn<span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> quad <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> quad <span class="token operator">&lt;</span> quadsDown<span class="token punctuation">;</span> <span class="token operator">++</span>quad<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      indices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>column1Offset <span class="token operator">+</span> quad<span class="token punctuation">,</span> column2Offset <span class="token operator">+</span> quad<span class="token punctuation">,</span> column1Offset <span class="token operator">+</span> quad <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      indices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>column1Offset <span class="token operator">+</span> quad <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> column2Offset <span class="token operator">+</span> quad<span class="token punctuation">,</span> column2Offset <span class="token operator">+</span> quad <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    position<span class="token punctuation">:</span> positions<span class="token punctuation">,</span>\n    texcoord<span class="token punctuation">:</span> texcoords<span class="token punctuation">,</span>\n    indices<span class="token punctuation">:</span> indices\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上方的代码创建了位置点和纹理坐标，然后创建索引生成三角网。capStart 和 capEnd 确定是都生成闭合点，假设我们在做一个罐头，这些选项指明是否需要闭合顶面和底面。</p>\n<p>使用我们的简化代码就可以用哪些数据生成这样的 WebGL 缓冲</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24553625928527876000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const tolerance = 0.15;\nconst distance = 0.4;\nconst divisions = 16;\nconst startAngle = 0;\nconst endAngle = Math.PI * 2;\nconst capStart = true;\nconst capEnd = true;\n\nconst tempPoints = getPointsOnBezierCurves(curvePoints, tolerance);\nconst points = simplifyPoints(tempPoints, 0, tempPoints.length, distance);\nconst arrays = lathePoints(points, startAngle, endAngle, divisions, capStart, capEnd);\nconst extents = getExtents(arrays.position);\nif (!bufferInfo) {\n  bufferInfo = webglUtils.createBufferInfoFromArrays(gl, arrays);\n}`, `24553625928527876000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> tolerance <span class="token operator">=</span> <span class="token number">0.15</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> distance <span class="token operator">=</span> <span class="token number">0.4</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> divisions <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> startAngle <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> endAngle <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> capStart <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> capEnd <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> tempPoints <span class="token operator">=</span> <span class="token function">getPointsOnBezierCurves</span><span class="token punctuation">(</span>curvePoints<span class="token punctuation">,</span> tolerance<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> points <span class="token operator">=</span> <span class="token function">simplifyPoints</span><span class="token punctuation">(</span>tempPoints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> tempPoints<span class="token punctuation">.</span>length<span class="token punctuation">,</span> distance<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> arrays <span class="token operator">=</span> <span class="token function">lathePoints</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> startAngle<span class="token punctuation">,</span> endAngle<span class="token punctuation">,</span> divisions<span class="token punctuation">,</span> capStart<span class="token punctuation">,</span> capEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> extents <span class="token operator">=</span> <span class="token function">getExtents</span><span class="token punctuation">(</span>arrays<span class="token punctuation">.</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bufferInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  bufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> arrays<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/lfvcxq?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>拖动滑块观察对结果的影响。</p>\n<p>这还有一个问题，开启三角形你会看到纹理不是均匀分布的，这是因为我们将纹理坐标的 v 值赋为曲线点的索引，如果曲线上的点距离相等那就没问题，但是它们距离并不相等。</p>\n<p>我们可以遍历曲线上的点并计算出每一点对应曲线长度，最后将这个长度除以曲线总长度赋值给 v。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78063887558328030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 绕 Y 轴旋转\nfunction lathePoints(\n  points,\n  startAngle, // 起始角 (例如 0)\n  endAngle, // 终止角 (例如 Math.PI * 2)\n  numDivisions, // 这中间生成多少块\n  capStart, // true 就封闭起点\n  capEnd\n) {\n  // true 就封闭重点\n  const positions = [];\n  const texcoords = [];\n  const indices = [];\n\n  const vOffset = capStart ? 1 : 0;\n  const pointsPerColumn = points.length + vOffset + (capEnd ? 1 : 0);\n  const quadsDown = pointsPerColumn - 1;\n\n  // 生成 v 值\n  let vcoords = [];\n\n  // 先计算出每一点对应的长度\n  let length = 0;\n  for (let i = 0; i < points.length - 1; ++i) {\n    vcoords.push(length);\n    length += v2.distance(points[i], points[i + 1]);\n  }\n  vcoords.push(length); // 最后一个点\n\n  // 除以总长\n  vcoords = vcoords.map((v) => v / length);\n\n  // 生成点\n  for (let division = 0; division <= numDivisions; ++division) {\n    const u = division / numDivisions;\n    const angle = lerp(startAngle, endAngle, u) % (Math.PI * 2);\n    const mat = m4.yRotation(angle);\n    if (capStart) {\n      // 在开始处添加一个 Y 轴上的点\n      positions.push(0, points[0][1], 0);\n      texcoords.push(u, 0);\n    }\n    points.forEach((p, ndx) => {\n      const tp = m4.transformPoint(mat, [...p, 0]);\n      positions.push(tp[0], tp[1], tp[2]);\n      texcoords.push(u, vcoords[ndx]);\n    });\n    if (capEnd) {\n      // 在终点处添加一个 Y 轴上的点\n      positions.push(0, points[points.length - 1][1], 0);\n      texcoords.push(u, 1);\n    }\n  }\n\n  // 创建索引\n  for (let division = 0; division < numDivisions; ++division) {\n    const column1Offset = division * pointsPerColumn;\n    const column2Offset = column1Offset + pointsPerColumn;\n    for (let quad = 0; quad < quadsDown; ++quad) {\n      indices.push(column1Offset + quad, column1Offset + quad + 1, column2Offset + quad);\n      indices.push(column1Offset + quad + 1, column2Offset + quad + 1, column2Offset + quad);\n    }\n  }\n\n  return {\n    position: positions,\n    texcoord: texcoords,\n    indices: indices\n  };\n}`, `78063887558328030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{19-31,46}"\n              >\n                <span class="gatsby-code-button-language">js{19-31,46}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 绕 Y 轴旋转</span>\n<span class="token keyword">function</span> <span class="token function">lathePoints</span><span class="token punctuation">(</span>\n  points<span class="token punctuation">,</span>\n  startAngle<span class="token punctuation">,</span> <span class="token comment">// 起始角 (例如 0)</span>\n  endAngle<span class="token punctuation">,</span> <span class="token comment">// 终止角 (例如 Math.PI * 2)</span>\n  numDivisions<span class="token punctuation">,</span> <span class="token comment">// 这中间生成多少块</span>\n  capStart<span class="token punctuation">,</span> <span class="token comment">// true 就封闭起点</span>\n  capEnd\n<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// true 就封闭重点</span>\n  <span class="token keyword">const</span> positions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> texcoords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> indices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> vOffset <span class="token operator">=</span> capStart <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> pointsPerColumn <span class="token operator">=</span> points<span class="token punctuation">.</span>length <span class="token operator">+</span> vOffset <span class="token operator">+</span> <span class="token punctuation">(</span>capEnd <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> quadsDown <span class="token operator">=</span> pointsPerColumn <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 生成 v 值</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">let</span> vcoords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 先计算出每一点对应的长度</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">let</span> length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> points<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    vcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    length <span class="token operator">+=</span> v2<span class="token punctuation">.</span><span class="token function">distance</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> points<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">  vcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 最后一个点</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 除以总长</span></span><span class="gatsby-highlight-code-line">  vcoords <span class="token operator">=</span> vcoords<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=></span> v <span class="token operator">/</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// 生成点</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> division <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> division <span class="token operator">&lt;=</span> numDivisions<span class="token punctuation">;</span> <span class="token operator">++</span>division<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> u <span class="token operator">=</span> division <span class="token operator">/</span> numDivisions<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> angle <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>startAngle<span class="token punctuation">,</span> endAngle<span class="token punctuation">,</span> u<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> mat <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">yRotation</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>capStart<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 在开始处添加一个 Y 轴上的点</span>\n      positions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> points<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      texcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    points<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p<span class="token punctuation">,</span> ndx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> tp <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">transformPoint</span><span class="token punctuation">(</span>mat<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">...</span>p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      positions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>tp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tp<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">      texcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> vcoords<span class="token punctuation">[</span>ndx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>capEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 在终点处添加一个 Y 轴上的点</span>\n      positions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> points<span class="token punctuation">[</span>points<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      texcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 创建索引</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> division <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> division <span class="token operator">&lt;</span> numDivisions<span class="token punctuation">;</span> <span class="token operator">++</span>division<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> column1Offset <span class="token operator">=</span> division <span class="token operator">*</span> pointsPerColumn<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> column2Offset <span class="token operator">=</span> column1Offset <span class="token operator">+</span> pointsPerColumn<span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> quad <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> quad <span class="token operator">&lt;</span> quadsDown<span class="token punctuation">;</span> <span class="token operator">++</span>quad<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      indices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>column1Offset <span class="token operator">+</span> quad<span class="token punctuation">,</span> column1Offset <span class="token operator">+</span> quad <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> column2Offset <span class="token operator">+</span> quad<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      indices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>column1Offset <span class="token operator">+</span> quad <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> column2Offset <span class="token operator">+</span> quad <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> column2Offset <span class="token operator">+</span> quad<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    position<span class="token punctuation">:</span> positions<span class="token punctuation">,</span>\n    texcoord<span class="token punctuation">:</span> texcoords<span class="token punctuation">,</span>\n    indices<span class="token punctuation">:</span> indices\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/92oji1?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>这些纹理坐标还是不完美，因为我们还没决定怎么处理闭合部分的纹理。这也是使用建模软件的一个原因。我们可以总结出很多计算闭合处 uv 值的方法，但并不是很有意义。如果你谷歌一下 UV map a barrel，你会发现完美的 UV 坐标是不需要太多数学运算的，只需要生成合适的点数据，这时你就需要一个合适工具创建点数据。</p>\n<p>还有一个事情要做，就是添加法向量。</p>\n<p>我们可以计算每一个曲线点的法向量，事实上如果你会看这节中的例子，你会发现 R1 和 R2 构成的线段切曲线于红点处。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-06-23-11-22-57-631a2d99eff9d2020be562eb0b50246d-70a78.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 610px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 75.08196721311475%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsSAAALEgHS3X78AAAB1klEQVQoz41Si26bMBTl3/cD+5BqSipF1TZpK1GrhlBSIEAjLWhZOhLyAptHMH7OEEoT1kk7lqzra59zH76K+G/QGucepbU453Jfr9cAgOrMRIYzMzIZo5xVVxBC0zTP+V3y4XCYGAah1UIlGm+1H/GcYsI5liq+7+d5/g65zQ2VpTRKjiIaMSkqyCKOLA9LJ7nM/IIsY1OGVoGY/y42bJfu8tT0waqIgmykgzBNqieEv0+WqoySTQaebnfwI0JbxCAkJaMlFfiI4H6Z/XJjt0tmnOU0Rxjt822ehiIh4oMQ6Smf141yBPb3m7sEJ7WHt5G5FduzvUshkI9kqUwTAvGG2oowjmFCCHmLzGs/PAIQBW3b+TchiouPaOw8x1nWSZvjGJCipExWwAkjYiFYWR9emY0oY2UUXZBLKVYUc9//dHX1NJl8/fxFvbt9NB51XR8MBr1er9/vq6qKEJI5u5Z1rIMrssNFUZCk6sHPxWJsGN/VoWGajvesjUaapsmpuq5h2/YpeBAEYRg2kR3b2gRVtavl8tkwpg8P5nA4n07Huu44zmw28zzPdV1pd+pXTkObpdW38JcX0e8LTRM3N8Kymrn5N5RzMdkMLudEglLpZH+hQ/4DDD9XhIqloaYAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 06 23 11 22 57" title="" data-src="/static/2022-06-23-11-22-57-631a2d99eff9d2020be562eb0b50246d-70a78.png" data-srcset="/static/2022-06-23-11-22-57-631a2d99eff9d2020be562eb0b50246d-1dff0.png 200w,\n/static/2022-06-23-11-22-57-631a2d99eff9d2020be562eb0b50246d-8ee4c.png 400w,\n/static/2022-06-23-11-22-57-631a2d99eff9d2020be562eb0b50246d-70a78.png 610w" data-sizes="(max-width: 610px) 100vw, 610px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>法向量和切线垂直所以从切线很容易求出法向量。</p>\n<h2 id="烛台"><a href="#%E7%83%9B%E5%8F%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>烛台</h2>\n<p>但是，假设我们想要做一个烛台，有这样一个框架。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-06-23-11-23-38-4e8802f5b3ead11806aafc04547b812d-a27d0.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 150px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAABC0lEQVQ4y2NgIA8wkqqBCUrnAHEFkngQEPeSYygzlC4E4vVI4g1AvBDKZiHHwG4gno0kngbEW9F8QZKXPYH4MRAnALEPEF8D4lI0S0kO+CQgfgfEf4C4iYFKYDEQnwViNnJjGdlLjUD8H4o3kRN+2MAMID4AxNyUGgRLGqC0uJzcyMDmbVBkrKWGgbCw2gjEdyn1Lswwe6RIyaLElTBNiUgGTqDEQFhaE4YmbJCBlpQYCPOyNxB/hhqYR410aADEl4D4FTQ/kw2EgNgNiMuA+BEQfwPiFiAOAGIpUg0rBuJzQPwcatALIH4CZb8B4stA3A/E7MQaCIoIQWhhwAzFLNCwYwVifiAWwxaWAANRLzimc03lAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 06 23 11 23 38" title="" data-src="/static/2022-06-23-11-23-38-4e8802f5b3ead11806aafc04547b812d-a27d0.png" data-srcset="/static/2022-06-23-11-23-38-4e8802f5b3ead11806aafc04547b812d-a27d0.png 150w" data-sizes="(max-width: 150px) 100vw, 150px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这有很多平滑区域也有很多锐利角，如何决定使用法向量的方向呢？当需要锐利边缘时就要使用多余的顶点，因为一个顶点有一个位置和一个法向量，如果需要多个法向量就需要不同的顶点，这也是制作立方体需要至少 24 个顶点的原因，虽然立方体只有 8 个顶点，但每个面在那个顶点处都需要不同的法向量。</p>\n<p>创建立方体的时候很容易确定法向量，但是形状复杂的时候就没那么容易了。</p>\n<p>所有的建模软件都有不同的方式创建法向量，一个常用的做法就是将该点邻接的三角面的法向量求平均。另外，还允许用户选择一个最大角度，如果邻接的多边形的法向量的夹角大于最大角度，就会创建一个新顶点。</p>\n<p>我们来实现这个。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52421128549345950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function generateNormals(arrays, maxAngle) {\n  const positions = arrays.position;\n  const texcoords = arrays.texcoord;\n\n  // 首先计算出每个面的法向量\n  let getNextIndex = makeIndiceIterator(arrays);\n  const numFaceVerts = getNextIndex.numElements;\n  const numVerts = arrays.position.length;\n  const numFaces = numFaceVerts / 3;\n  const faceNormals = [];\n\n  // 计算每个面的法向量\n  // 计算过程中为每个面新建顶点\n  for (let i = 0; i < numFaces; ++i) {\n    const n1 = getNextIndex() * 3;\n    const n2 = getNextIndex() * 3;\n    const n3 = getNextIndex() * 3;\n\n    const v1 = positions.slice(n1, n1 + 3);\n    const v2 = positions.slice(n2, n2 + 3);\n    const v3 = positions.slice(n3, n3 + 3);\n\n    faceNormals.push(m4.normalize(m4.cross(m4.subtractVectors(v1, v2), m4.subtractVectors(v3, v2))));\n  }\n\n  let tempVerts = {};\n  let tempVertNdx = 0;\n\n  // 假设顶点位置精确匹配\n\n  function getVertIndex(x, y, z) {\n    const vertId = x + \',\' + y + \',\' + z;\n    const ndx = tempVerts[vertId];\n    if (ndx !== undefined) {\n      return ndx;\n    }\n    const newNdx = tempVertNdx++;\n    tempVerts[vertId] = newNdx;\n    return newNdx;\n  }\n\n  // 我们需要算出共享的顶点\n  // 这并不像我们看着面那么简单 (三角形)\n  // 因为假如我们有一个标准的圆柱\n  //\n  //\n  //      3-4\n  //     /   \\\n  //    2     5   从上往下看，从 S 走到 E, E 和 S\n  //    1     6   是不同的点，因为它们不共享UV坐标。\n  //     \\   /\n  //      S/E\n  //\n  // 顶点在起始和结束位置并不是共享的\n  // 由于它们有不同的 UV 坐标，但如果不\n  // 把它们看作共享顶点就会得到错误结果\n\n  const vertIndices = [];\n  for (let i = 0; i < numVerts; ++i) {\n    const offset = i * 3;\n    const vert = positions.slice(offset, offset + 3);\n    vertIndices.push(getVertIndex(vert));\n  }\n\n  // 遍历所有顶点记录所在的面\n  const vertFaces = [];\n  getNextIndex.reset();\n  for (let i = 0; i < numFaces; ++i) {\n    for (let j = 0; j < 3; ++j) {\n      const ndx = getNextIndex();\n      const sharedNdx = vertIndices[ndx];\n      let faces = vertFaces[sharedNdx];\n      if (!faces) {\n        faces = [];\n        vertFaces[sharedNdx] = faces;\n      }\n      faces.push(i);\n    }\n  }\n\n  // 遍历面上的顶点计算每个顶点的法向量\n  // 只计算两面角度不大于 maxAngle 面\n  // 将结果写入 newPositions, newTexcoords 和 newNormals\n  // 丢弃相同的顶点\n  tempVerts = {};\n  tempVertNdx = 0;\n  const newPositions = [];\n  const newTexcoords = [];\n  const newNormals = [];\n\n  function getNewVertIndex(x, y, z, nx, ny, nz, u, v) {\n    const vertId = x + \',\' + y + \',\' + z + \',\' + nx + \',\' + ny + \',\' + nz + \',\' + u + \',\' + v;\n\n    const ndx = tempVerts[vertId];\n    if (ndx !== undefined) {\n      return ndx;\n    }\n    const newNdx = tempVertNdx++;\n    tempVerts[vertId] = newNdx;\n    newPositions.push(x, y, z);\n    newNormals.push(nx, ny, nz);\n    newTexcoords.push(u, v);\n    return newNdx;\n  }\n\n  const newVertIndices = [];\n  getNextIndex.reset();\n  const maxAngleCos = Math.cos(maxAngle);\n  // 对每个面\n  for (let i = 0; i < numFaces; ++i) {\n    // 获取该面的法向量\n    const thisFaceNormal = faceNormals[i];\n    // 对于面上的每一点\n    for (let j = 0; j < 3; ++j) {\n      const ndx = getNextIndex();\n      const sharedNdx = vertIndices[ndx];\n      const faces = vertFaces[sharedNdx];\n      const norm = [0, 0, 0];\n      faces.forEach((faceNdx) => {\n        // 面的法向量是否相同\n        const otherFaceNormal = faceNormals[faceNdx];\n        const dot = m4.dot(thisFaceNormal, otherFaceNormal);\n        if (dot > maxAngleCos) {\n          m4.addVectors(norm, otherFaceNormal, norm);\n        }\n      });\n      m4.normalize(norm, norm);\n      const poffset = ndx * 3;\n      const toffset = ndx * 2;\n      newVertIndices.push(\n        getNewVertIndex(\n          positions[poffset + 0],\n          positions[poffset + 1],\n          positions[poffset + 2],\n          norm[0],\n          norm[1],\n          norm[2],\n          texcoords[toffset + 0],\n          texcoords[toffset + 1]\n        )\n      );\n    }\n  }\n\n  return {\n    position: newPositions,\n    texcoord: newTexcoords,\n    normal: newNormals,\n    indices: newVertIndices\n  };\n}\n\nfunction makeIndexedIndicesFn(arrays) {\n  const indices = arrays.indices;\n  let ndx = 0;\n  const fn = function () {\n    return indices[ndx++];\n  };\n  fn.reset = function () {\n    ndx = 0;\n  };\n  fn.numElements = indices.length;\n  return fn;\n}\n\nfunction makeUnindexedIndicesFn(arrays) {\n  let ndx = 0;\n  const fn = function () {\n    return ndx++;\n  };\n  fn.reset = function () {\n    ndx = 0;\n  };\n  fn.numElements = arrays.positions.length / 3;\n  return fn;\n}\n\nfunction makeIndiceIterator(arrays) {\n  return arrays.indices ? makeIndexedIndicesFn(arrays) : makeUnindexedIndicesFn(arrays);\n}`, `52421128549345950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">generateNormals</span><span class="token punctuation">(</span><span class="token parameter">arrays<span class="token punctuation">,</span> maxAngle</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> positions <span class="token operator">=</span> arrays<span class="token punctuation">.</span>position<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> texcoords <span class="token operator">=</span> arrays<span class="token punctuation">.</span>texcoord<span class="token punctuation">;</span>\n\n  <span class="token comment">// 首先计算出每个面的法向量</span>\n  <span class="token keyword">let</span> getNextIndex <span class="token operator">=</span> <span class="token function">makeIndiceIterator</span><span class="token punctuation">(</span>arrays<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> numFaceVerts <span class="token operator">=</span> getNextIndex<span class="token punctuation">.</span>numElements<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> numVerts <span class="token operator">=</span> arrays<span class="token punctuation">.</span>position<span class="token punctuation">.</span>length<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> numFaces <span class="token operator">=</span> numFaceVerts <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> faceNormals <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 计算每个面的法向量</span>\n  <span class="token comment">// 计算过程中为每个面新建顶点</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numFaces<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> n1 <span class="token operator">=</span> <span class="token function">getNextIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> n2 <span class="token operator">=</span> <span class="token function">getNextIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> n3 <span class="token operator">=</span> <span class="token function">getNextIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> v1 <span class="token operator">=</span> positions<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n1 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> v2 <span class="token operator">=</span> positions<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>n2<span class="token punctuation">,</span> n2 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> v3 <span class="token operator">=</span> positions<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>n3<span class="token punctuation">,</span> n3 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    faceNormals<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>m4<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span>m4<span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span>m4<span class="token punctuation">.</span><span class="token function">subtractVectors</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">subtractVectors</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">let</span> tempVerts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> tempVertNdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 假设顶点位置精确匹配</span>\n\n  <span class="token keyword">function</span> <span class="token function">getVertIndex</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> vertId <span class="token operator">=</span> x <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> y <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> z<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> ndx <span class="token operator">=</span> tempVerts<span class="token punctuation">[</span>vertId<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>ndx <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> ndx<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> newNdx <span class="token operator">=</span> tempVertNdx<span class="token operator">++</span><span class="token punctuation">;</span>\n    tempVerts<span class="token punctuation">[</span>vertId<span class="token punctuation">]</span> <span class="token operator">=</span> newNdx<span class="token punctuation">;</span>\n    <span class="token keyword">return</span> newNdx<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 我们需要算出共享的顶点</span>\n  <span class="token comment">// 这并不像我们看着面那么简单 (三角形)</span>\n  <span class="token comment">// 因为假如我们有一个标准的圆柱</span>\n  <span class="token comment">//</span>\n  <span class="token comment">//</span>\n  <span class="token comment">//      3-4</span>\n  <span class="token comment">//     /   \\</span>\n  <span class="token comment">//    2     5   从上往下看，从 S 走到 E, E 和 S</span>\n  <span class="token comment">//    1     6   是不同的点，因为它们不共享UV坐标。</span>\n  <span class="token comment">//     \\   /</span>\n  <span class="token comment">//      S/E</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// 顶点在起始和结束位置并不是共享的</span>\n  <span class="token comment">// 由于它们有不同的 UV 坐标，但如果不</span>\n  <span class="token comment">// 把它们看作共享顶点就会得到错误结果</span>\n\n  <span class="token keyword">const</span> vertIndices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numVerts<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> offset <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> vert <span class="token operator">=</span> positions<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> offset <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    vertIndices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">getVertIndex</span><span class="token punctuation">(</span>vert<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 遍历所有顶点记录所在的面</span>\n  <span class="token keyword">const</span> vertFaces <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  getNextIndex<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numFaces<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> ndx <span class="token operator">=</span> <span class="token function">getNextIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> sharedNdx <span class="token operator">=</span> vertIndices<span class="token punctuation">[</span>ndx<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">let</span> faces <span class="token operator">=</span> vertFaces<span class="token punctuation">[</span>sharedNdx<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>faces<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        faces <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n        vertFaces<span class="token punctuation">[</span>sharedNdx<span class="token punctuation">]</span> <span class="token operator">=</span> faces<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      faces<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 遍历面上的顶点计算每个顶点的法向量</span>\n  <span class="token comment">// 只计算两面角度不大于 maxAngle 面</span>\n  <span class="token comment">// 将结果写入 newPositions, newTexcoords 和 newNormals</span>\n  <span class="token comment">// 丢弃相同的顶点</span>\n  tempVerts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  tempVertNdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> newPositions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> newTexcoords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> newNormals <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">function</span> <span class="token function">getNewVertIndex</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> nx<span class="token punctuation">,</span> ny<span class="token punctuation">,</span> nz<span class="token punctuation">,</span> u<span class="token punctuation">,</span> v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> vertId <span class="token operator">=</span> x <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> y <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> z <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> nx <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> ny <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> nz <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> u <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> v<span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> ndx <span class="token operator">=</span> tempVerts<span class="token punctuation">[</span>vertId<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>ndx <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> ndx<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> newNdx <span class="token operator">=</span> tempVertNdx<span class="token operator">++</span><span class="token punctuation">;</span>\n    tempVerts<span class="token punctuation">[</span>vertId<span class="token punctuation">]</span> <span class="token operator">=</span> newNdx<span class="token punctuation">;</span>\n    newPositions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    newNormals<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>nx<span class="token punctuation">,</span> ny<span class="token punctuation">,</span> nz<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    newTexcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> newNdx<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> newVertIndices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  getNextIndex<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> maxAngleCos <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>maxAngle<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 对每个面</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numFaces<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 获取该面的法向量</span>\n    <span class="token keyword">const</span> thisFaceNormal <span class="token operator">=</span> faceNormals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token comment">// 对于面上的每一点</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> ndx <span class="token operator">=</span> <span class="token function">getNextIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> sharedNdx <span class="token operator">=</span> vertIndices<span class="token punctuation">[</span>ndx<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> faces <span class="token operator">=</span> vertFaces<span class="token punctuation">[</span>sharedNdx<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> norm <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      faces<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">faceNdx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token comment">// 面的法向量是否相同</span>\n        <span class="token keyword">const</span> otherFaceNormal <span class="token operator">=</span> faceNormals<span class="token punctuation">[</span>faceNdx<span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> dot <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>thisFaceNormal<span class="token punctuation">,</span> otherFaceNormal<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>dot <span class="token operator">></span> maxAngleCos<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          m4<span class="token punctuation">.</span><span class="token function">addVectors</span><span class="token punctuation">(</span>norm<span class="token punctuation">,</span> otherFaceNormal<span class="token punctuation">,</span> norm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      m4<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span>norm<span class="token punctuation">,</span> norm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> poffset <span class="token operator">=</span> ndx <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> toffset <span class="token operator">=</span> ndx <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>\n      newVertIndices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>\n        <span class="token function">getNewVertIndex</span><span class="token punctuation">(</span>\n          positions<span class="token punctuation">[</span>poffset <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          positions<span class="token punctuation">[</span>poffset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          positions<span class="token punctuation">[</span>poffset <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          norm<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          norm<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          norm<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          texcoords<span class="token punctuation">[</span>toffset <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          texcoords<span class="token punctuation">[</span>toffset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>\n        <span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    position<span class="token punctuation">:</span> newPositions<span class="token punctuation">,</span>\n    texcoord<span class="token punctuation">:</span> newTexcoords<span class="token punctuation">,</span>\n    normal<span class="token punctuation">:</span> newNormals<span class="token punctuation">,</span>\n    indices<span class="token punctuation">:</span> newVertIndices\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">makeIndexedIndicesFn</span><span class="token punctuation">(</span><span class="token parameter">arrays</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> indices <span class="token operator">=</span> arrays<span class="token punctuation">.</span>indices<span class="token punctuation">;</span>\n  <span class="token keyword">let</span> ndx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> indices<span class="token punctuation">[</span>ndx<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  fn<span class="token punctuation">.</span><span class="token function-variable function">reset</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    ndx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  fn<span class="token punctuation">.</span>numElements <span class="token operator">=</span> indices<span class="token punctuation">.</span>length<span class="token punctuation">;</span>\n  <span class="token keyword">return</span> fn<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">makeUnindexedIndicesFn</span><span class="token punctuation">(</span><span class="token parameter">arrays</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> ndx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> ndx<span class="token operator">++</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  fn<span class="token punctuation">.</span><span class="token function-variable function">reset</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    ndx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  fn<span class="token punctuation">.</span>numElements <span class="token operator">=</span> arrays<span class="token punctuation">.</span>positions<span class="token punctuation">.</span>length <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> fn<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">makeIndiceIterator</span><span class="token punctuation">(</span><span class="token parameter">arrays</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> arrays<span class="token punctuation">.</span>indices <span class="token operator">?</span> <span class="token function">makeIndexedIndicesFn</span><span class="token punctuation">(</span>arrays<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">makeUnindexedIndicesFn</span><span class="token punctuation">(</span>arrays<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上方的代码首先通过原始顶点计算每个面（三角形）的法向量，然后创建一个顶点索引集寻找相同的顶点，那是因为我们旋转后的起始和终止点应该是同一个点，但 UV 坐标不同所以要单独处理，计算顶点法向量时要将它们看作相同点。</p>\n<p>这些做完之后，对于每个顶点，生成了一个包含它的面的集合。</p>\n<p>最后将所有除了差值大于 maxAngle 的面的法向量求平均，获得一个新的顶点集合。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/phpk6p?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>注意到在期望的位置得到了锐利的边缘，调大 maxAngle 的值就会将相邻的面加入计算，得到平滑的边缘。试试调整 divisions 为 5 或者 6 然后调整 maxAngle 的值让该平滑的地方平滑，该锐利的地方锐利，你也可以设置 mode 为 lit 查看光照效果，这是我们需要法向量的原因。</p>\n<p>由此得到的结论是：如果想做三维模型就用三维建模库</p>\n<p>你可能需要一个 UV 编辑器，帮助完成封闭问题也是三维编辑器提供的功能。代替使用有限的组合处理闭合处问题，可以使用其他编辑器提供的特性处理闭合处并轻松的获取 UV 值，三维编辑器还支持拉伸面和沿路径拉伸，你看了之后就会发现它们是基于上方的加工方式。</p>\n<h2 id="参考"><a href="#%E5%8F%82%E8%80%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>参考</h2>\n<p><a href="https://pomax.github.io/bezierinfo/" target="_blank" rel="nofollow noreferrer noopener">贝塞尔曲线</a></p>\n<h2 id="这里的模运算符是做什么的"><a href="#%E8%BF%99%E9%87%8C%E7%9A%84%E6%A8%A1%E8%BF%90%E7%AE%97%E7%AC%A6%E6%98%AF%E5%81%9A%E4%BB%80%E4%B9%88%E7%9A%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>这里的模运算符是做什么的?</h2>\n<p>如果你仔细看了 lathePoints 方法就会看到计算角度时使用了模运算符。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94336554959459580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for (let division = 0; division <= numDivisions; ++division) {\n  const u = division / numDivisions;\n  const angle = lerp(startAngle, endAngle, u) % (Math.PI * 2);\n}`, `94336554959459580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> division <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> division <span class="token operator">&lt;=</span> numDivisions<span class="token punctuation">;</span> <span class="token operator">++</span>division<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> u <span class="token operator">=</span> division <span class="token operator">/</span> numDivisions<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> angle <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>startAngle<span class="token punctuation">,</span> endAngle<span class="token punctuation">,</span> u<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为什么这么做?</p>\n<p>当我们将点旋转成一个圆形时我们希望起点和终点是匹配的。<code class="language-text">Math.sin(0)</code> 和 <code class="language-text">Math.sin(Math.PI * 2)</code> 应该相等，但是浮点运算并不精确，所以通常它们并不是 100% 的相等。</p>\n<p>这在计算法向量的时候十分重要，我们想知道到一个顶点共享的所有面，我们比较顶点，如果相同就认为是同一点，那么如果不被认为是同一点就会计算出错误的法向量。</p>\n<p>这是这种情况发生时的样子</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-06-23-11-38-12-498c9bfc963626bc2a16cb52c976b5df-1e4d6.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 420px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 140.47619047619048%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAIAAADuuAg3AAAACXBIWXMAAAsSAAALEgHS3X78AAADIUlEQVQ4y2P4jwP8+v3ny7cfv379/o8bMCBz/v37ByQv3/yS23PeNneTXlqLfV5hcVfd1Wtn4bLYNUOkfn37H5L8iMVvF1PSYoaMPNZULwF/+cRE3T/fv2LqR7H573+QXN2cj0Itxzj7V7D2F/NNCJRuUW2fFwaXxan5D9jgnv0fuRsOcDYtY6su4q0PFq5X7d6ZBdL87y8+zX//gjTn9r0W8dsnFLCU36tE3CdE3l8vr8UR7i8Cmqd1v1fSOSxvt0zavFzZJkJHV3FOVx5Y9i/+0AaR71/9zbQ6Zckyx5G/1o7ZL9fU8/3zhyBZ/Joh+oEm/H3+Y0XbPQ2f8mVNvf+efvsHCuZ/BOIZpBkcrE9+fc+5d0J2e3nmtfKHP+/8/weGBDX/AXu7f+ETHofF6n71Qhb6nTPzsXoYq7NBml/f/jo1+YKZduXUuNqXNx5hTV5YNIPjE6Tu1pP/8gU1l+4ewhrDeDSDbLr54r9ke/25BwdI1QzSffX5f9HO2pP3d5OmGZJI9z3+xTS3aP2dBWCRP0Rp/vcfGivJZ24ybi0JOx7y68/H//+JjCqwtYfv/xCct49naZ3QbI3N12bishx7PG8/+Z0rZT9ncS1vksbynd1g8d+ENYP1/n/y7K96yimm6CqVGP1rNw4Tm0jg6SFyyh2G3DKfHtd/v78R62eIkmXXn9kc2StxqMb8sNvsC7X//v4mENpABwNjGBJgW4+9Dm8+IONWFlyct/7AMqBjgGXQ33+//6IGGxZn//zz58//bysfPJDvK592te3H/3c//nzAcBxMM4T34cfvY2/eLHh5q+bl0bAXq9w+TfX+U+/+MSH4hU/Fy4i5L3KPvJ765utVZP8zQOjX33+nXLnhdfOYw50d5ndXmj2YY/dyqvndcvO76ZYPYmzvurvfMQm9pZJ2Serm2yPwBMsAyWov3/72W3RZbctOhcOrFC7MU789zeDZRJlTOdInY5Uvhaud91Y/ZG2wTd9vnv7dJ+cRmuFF1/OnPxduf5y95KT3wm32S1ebrJir0VVu0FdkNaPYd355wZLWOVsWPHn0CNnZAAmynWVSCotdAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 06 23 11 38 12" title="" data-src="/static/2022-06-23-11-38-12-498c9bfc963626bc2a16cb52c976b5df-1e4d6.png" data-srcset="/static/2022-06-23-11-38-12-498c9bfc963626bc2a16cb52c976b5df-5f5a6.png 200w,\n/static/2022-06-23-11-38-12-498c9bfc963626bc2a16cb52c976b5df-fe3d6.png 400w,\n/static/2022-06-23-11-38-12-498c9bfc963626bc2a16cb52c976b5df-1e4d6.png 420w" data-sizes="(max-width: 420px) 100vw, 420px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>你可以看到它们在共享处没有被当作相同点，因为它们不是 100% 的相等。</p>\n<p>起初我想通过提供一个误差范围，检查顶点的距离是否在范围内，如果小于误差范围就认为是同一点，就像这样。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4952914993475233000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const epsilon = 0.0001;\nconst tempVerts = [];\nfunction getVertIndex(position) {\n  if (tempVerts.length) {\n    // 找到最近的点\n    let closestNdx = 0;\n    let closestDistSq = v2.distanceSq(position, tempVerts[0]);\n    for (let i = 1; i < tempVerts.length; ++i) {\n      let distSq = v2.distanceSq(position, tempVerts[i]);\n      if (distSq < closestDistSq) {\n        closestDistSq = distSq;\n        closestNdx = i;\n      }\n    }\n    // 是否在误差范围内\n    if (closestDistSq < epsilon) {\n      // 是就返回那个点\n      return closestNdx;\n    }\n  }\n  // 不是就将它添加到序列中并返回索引\n  tempVerts.push(position);\n  return tempVerts.length - 1;\n}`, `4952914993475233000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> epsilon <span class="token operator">=</span> <span class="token number">0.0001</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> tempVerts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">function</span> <span class="token function">getVertIndex</span><span class="token punctuation">(</span><span class="token parameter">position</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>tempVerts<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 找到最近的点</span>\n    <span class="token keyword">let</span> closestNdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> closestDistSq <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">distanceSq</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> tempVerts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tempVerts<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> distSq <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">distanceSq</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> tempVerts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>distSq <span class="token operator">&lt;</span> closestDistSq<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        closestDistSq <span class="token operator">=</span> distSq<span class="token punctuation">;</span>\n        closestNdx <span class="token operator">=</span> i<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// 是否在误差范围内</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>closestDistSq <span class="token operator">&lt;</span> epsilon<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 是就返回那个点</span>\n      <span class="token keyword">return</span> closestNdx<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// 不是就将它添加到序列中并返回索引</span>\n  tempVerts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> tempVerts<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>它成功解决了接缝问题，但是它消耗的时间太长，导致 UI 交互不稳定。这是因为它是一个复杂度为 O^2 的解决方法，如果你滑动滑块在最多的情况下就会创建大约 20000 个点，再加上 O^2 的复杂度就是 3 亿次迭代。</p>\n<p>我在网上寻找简单的方法但没找到，我想过将所有点都放到<a href="https://en.wikipedia.org/wiki/Octree" target="_blank" rel="nofollow noreferrer noopener">八叉树</a>中，让寻找匹配点速度快一些，但那似乎远离了本章的范围。</p>\n<p>然后我就想到既然只是终点问题我就可以进行模运算，让结果相等，原始代码像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50696833896941950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const angle = lerp(startAngle, endAngle, u);`, `50696833896941950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> angle <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>startAngle<span class="token punctuation">,</span> endAngle<span class="token punctuation">,</span> u<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>新代码像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85442288352003690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const angle = lerp(startAngle, endAngle, u) % (Math.PI * 2);`, `85442288352003690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> angle <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>startAngle<span class="token punctuation">,</span> endAngle<span class="token punctuation">,</span> u<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>由于模运算 endAngle 为 <code class="language-text">Math.PI * 2</code> 时 angle 就为 0，和起始点相同，接缝消失了，问题解决了！</p>\n<p>但是，即使这样当设置 distance 为 0.001 并且 divisions 为 60 时，在我的机子上还要几乎 1 秒钟的运算。这可能还有很多可以优化的地方，但创建复杂的网格是一个耗时的工作，这就是我的三维游戏可以以 60fps 运行，但是三维建模工具通常都是很低的帧率。</p>\n<h2 id="使用矩阵运算是不是大材小用了"><a href="#%E4%BD%BF%E7%94%A8%E7%9F%A9%E9%98%B5%E8%BF%90%E7%AE%97%E6%98%AF%E4%B8%8D%E6%98%AF%E5%A4%A7%E6%9D%90%E5%B0%8F%E7%94%A8%E4%BA%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用矩阵运算是不是大材小用了?</h2>\n<p>当我们旋转点的时候使用这样的代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15725652131016776000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const mat = m4.yRotation(angle);\n// ...\npoints.forEach((p, ndx) => {\n  const tp = m4.transformPoint(mat, [...p, 0]);\n  // ...\n});`, `15725652131016776000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> mat <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">yRotation</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// ...</span>\npoints<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p<span class="token punctuation">,</span> ndx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> tp <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">transformPoint</span><span class="token punctuation">(</span>mat<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">...</span>p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 4x4 矩阵转换一个任意三维点需要 16 次乘法，12 次加法，和 3 次除法。我们可以只使用单位圆形式的旋转运算。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44993581138552780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const s = Math.sin(angle);\nconst c = Math.cos(angle);\n//...\npoints.forEach((p, ndx) => {\n  const x = p[0];\n  const y = p[1];\n  const z = p[2];\n  const tp = [x * c - z * s, y, x * s + z * c];\n  //...\n});`, `44993581138552780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> s <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> c <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">//...</span>\npoints<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p<span class="token punctuation">,</span> ndx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> x <span class="token operator">=</span> p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> y <span class="token operator">=</span> p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> z <span class="token operator">=</span> p<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> tp <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token operator">*</span> c <span class="token operator">-</span> z <span class="token operator">*</span> s<span class="token punctuation">,</span> y<span class="token punctuation">,</span> x <span class="token operator">*</span> s <span class="token operator">+</span> z <span class="token operator">*</span> c<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token comment">//...</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样就只有 4 次乘法和 2 次加法，没有方法调用，应该至少要快 6 倍。</p>\n<p>这个优化值得么？当然，对于这个特殊的例子，我不认为这个有什么意义，我认为你可能需要让用户决定绕那个轴旋转，使用矩阵就可以让用户传入一个轴，像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4041233197652749300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const mat = m4.axisRotation(userSuppliedAxis, angle);`, `4041233197652749300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> mat <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">axisRotation</span><span class="token punctuation">(</span>userSuppliedAxis<span class="token punctuation">,</span> angle<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>哪种方式更好其实取决于你自己和你的需求，我认为我会优先选择灵活的方式，然后运行太慢时再去考虑优化。</p>\n<h1 id="webgl-加载-obj-文件"><a href="#webgl-%E5%8A%A0%E8%BD%BD-obj-%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 加载 .obj 文件</h1>\n<p>Wavefront 的 .obj 文件是网上最常用的 3D 文件格式。它们并不是难以解析的格式，所以让我们试试。这能够提供一个解析 3D 文件的有用例子。</p>\n<blockquote>\n<p>该 .obj 解析器不会面面俱到或者完美，也不保证能够处理所有 .obj 文件。这只是一个练习。如果你使用该程序并遇到问题，下面的链接可能会对你有帮助。</p>\n<p>我找到的有关 .obj 文件的<a href="http://paulbourke.net/dataformats/obj/" target="_blank" rel="nofollow noreferrer noopener">文档</a>。不过<a href="https://www.loc.gov/preservation/digital/formats/fdd/fdd000507.shtml" target="_blank" rel="nofollow noreferrer noopener">这里</a>链接了很多其它相关文档。</p>\n</blockquote>\n<h2 id="立方体"><a href="#%E7%AB%8B%E6%96%B9%E4%BD%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>立方体</h2>\n<p>让我们看一个简单的例子。下面是从 blender 默认场景中导出的 cube.obj：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48866917301880775000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# Blender v2.80 (sub 75) OBJ File: \'\'\n# www.blender.org\nmtllib cube.mtl\no Cube\nv 1.000000 1.000000 -1.000000\nv 1.000000 -1.000000 -1.000000\nv 1.000000 1.000000 1.000000\nv 1.000000 -1.000000 1.000000\nv -1.000000 1.000000 -1.000000\nv -1.000000 -1.000000 -1.000000\nv -1.000000 1.000000 1.000000\nv -1.000000 -1.000000 1.000000\nvt 0.375000 0.000000\nvt 0.625000 0.000000\nvt 0.625000 0.250000\nvt 0.375000 0.250000\nvt 0.375000 0.250000\nvt 0.625000 0.250000\nvt 0.625000 0.500000\nvt 0.375000 0.500000\nvt 0.625000 0.750000\nvt 0.375000 0.750000\nvt 0.625000 0.750000\nvt 0.625000 1.000000\nvt 0.375000 1.000000\nvt 0.125000 0.500000\nvt 0.375000 0.500000\nvt 0.375000 0.750000\nvt 0.125000 0.750000\nvt 0.625000 0.500000\nvt 0.875000 0.500000\nvt 0.875000 0.750000\nvn 0.0000 1.0000 0.0000\nvn 0.0000 0.0000 1.0000\nvn -1.0000 0.0000 0.0000\nvn 0.0000 -1.0000 0.0000\nvn 1.0000 0.0000 0.0000\nvn 0.0000 0.0000 -1.0000\nusemtl Material\ns off\nf 1/1/1 5/2/1 7/3/1 3/4/1\nf 4/5/2 3/6/2 7/7/2 8/8/2\nf 8/8/3 7/7/3 5/9/3 6/10/3\nf 6/10/4 2/11/4 4/12/4 8/13/4\nf 2/14/5 1/15/5 3/16/5 4/17/5\nf 6/18/6 5/19/6 1/20/6 2/11/6`, `48866917301880775000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="obj"\n              >\n                <span class="gatsby-code-button-language">obj</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="obj"><pre style="counter-reset: linenumber NaN" class="language-obj line-numbers"><code class="language-obj"># Blender v2.80 (sub 75) OBJ File: &#39;&#39;\n# www.blender.org\nmtllib cube.mtl\no Cube\nv 1.000000 1.000000 -1.000000\nv 1.000000 -1.000000 -1.000000\nv 1.000000 1.000000 1.000000\nv 1.000000 -1.000000 1.000000\nv -1.000000 1.000000 -1.000000\nv -1.000000 -1.000000 -1.000000\nv -1.000000 1.000000 1.000000\nv -1.000000 -1.000000 1.000000\nvt 0.375000 0.000000\nvt 0.625000 0.000000\nvt 0.625000 0.250000\nvt 0.375000 0.250000\nvt 0.375000 0.250000\nvt 0.625000 0.250000\nvt 0.625000 0.500000\nvt 0.375000 0.500000\nvt 0.625000 0.750000\nvt 0.375000 0.750000\nvt 0.625000 0.750000\nvt 0.625000 1.000000\nvt 0.375000 1.000000\nvt 0.125000 0.500000\nvt 0.375000 0.500000\nvt 0.375000 0.750000\nvt 0.125000 0.750000\nvt 0.625000 0.500000\nvt 0.875000 0.500000\nvt 0.875000 0.750000\nvn 0.0000 1.0000 0.0000\nvn 0.0000 0.0000 1.0000\nvn -1.0000 0.0000 0.0000\nvn 0.0000 -1.0000 0.0000\nvn 1.0000 0.0000 0.0000\nvn 0.0000 0.0000 -1.0000\nusemtl Material\ns off\nf 1/1/1 5/2/1 7/3/1 3/4/1\nf 4/5/2 3/6/2 7/7/2 8/8/2\nf 8/8/3 7/7/3 5/9/3 6/10/3\nf 6/10/4 2/11/4 4/12/4 8/13/4\nf 2/14/5 1/15/5 3/16/5 4/17/5\nf 6/18/6 5/19/6 1/20/6 2/11/6</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>即使不看文档我们也能发现 v 开始的行表示顶点，vt 开始的行表示纹理坐标，vn 开始的行表示法线。接下来就是理解剩下的代表什么。</p>\n<p>看起来 .obj 文件是文本文件，所以我们要做的第一件事就是加载文本文件。幸运的是，如果使用 async/await 这将是一件很简单的事。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34395469810867230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`async function main() {\n  // ...\n\n  const response = await fetch(\'resources/models/cube/cube.obj\');\n  const text = await response.text();\n}`, `34395469810867230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">\'resources/models/cube/cube.obj\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> text <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接着，我们可以一行一行地解析，每行都是下面的形式:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12714788050241888000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`keyword data data data ...`, `12714788050241888000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">keyword data data data ...</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>每行的开头是 keyword，data 由空格隔开。以 <code class="language-text">#</code> 开头的行是注释。</p>\n<p>接着，用代码来解析每一行，跳过空白行和注释，然后根据 keyword 调用对应的函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22187549415993920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseOBJ(text) {\n  const keywords = {};\n\n  const keywordRE = /(\\w*)(?: )*(.*)/;\n  const lines = text.split(\'\\n\');\n  for (let lineNo = 0; lineNo < lines.length; ++lineNo) {\n    const line = lines[lineNo].trim();\n    if (line === \'\' || line.startsWith(\'#\')) {\n      continue;\n    }\n    const m = keywordRE.exec(line);\n    if (!m) {\n      continue;\n    }\n    const [, keyword, unparsedArgs] = m;\n    const parts = line.split(/\\s+/).slice(1);\n    const handler = keywords[keyword];\n    if (!handler) {\n      console.warn(\'unhandled keyword:\', keyword, \' at line\', lineNo + 1);\n      continue;\n    }\n    handler(parts, unparsedArgs);\n  }\n}`, `22187549415993920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> keywordRE <span class="token operator">=</span> <span class="token regex">/(\\w*)(?: )*(.*)/</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> lines <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'\\n\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> lineNo <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> lineNo <span class="token operator">&lt;</span> lines<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>lineNo<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> line <span class="token operator">=</span> lines<span class="token punctuation">[</span>lineNo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>line <span class="token operator">===</span> <span class="token string">\'\'</span> <span class="token operator">||</span> line<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">\'#\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">continue</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> m <span class="token operator">=</span> keywordRE<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">continue</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> keyword<span class="token punctuation">,</span> unparsedArgs<span class="token punctuation">]</span> <span class="token operator">=</span> m<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> parts <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex">/\\s+/</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> handler <span class="token operator">=</span> keywords<span class="token punctuation">[</span>keyword<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">\'unhandled keyword:\'</span><span class="token punctuation">,</span> keyword<span class="token punctuation">,</span> <span class="token string">\' at line\'</span><span class="token punctuation">,</span> lineNo <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">continue</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token function">handler</span><span class="token punctuation">(</span>parts<span class="token punctuation">,</span> unparsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意：我们去除了每行开头和结尾的空格。我不知道这是否有必要，但是我觉得没有坏处。我们用 <code class="language-text">/\\s+/</code> 将每行以空格分割。同样地我不知道这是否有必要，data 之间会有多于一个空格吗？是否可以是制表符？不知道，但是这样看起来更安全。</p>\n<p>另外，我们将每行的第一部分作为 keyword，然后找到对应的函数调用，并将 keyword 后面的 data 传给该函数。所以接下来我们只要完成这些函数。</p>\n<p>之前，我们猜测了 v，vt 和 vn 的含义。文档表明 f 代表“面”或多边形，每部分数据代表了顶点、纹理坐标以及法线。</p>\n<p>如果一个索引是正数，表示从序列 1 开始的偏移。如果索引是负数，表示从序列结尾开始的偏移。索引的顺序是：顶点/纹理坐标/法线，只有顶点是必要的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70692466282814760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`f 1 2 3             # 只包含顶点索引\nf 1/1 2/2 3/3       # 包含顶点索引和纹理坐标索引\nf 1/1/1 2/2/2 3/3/3 # 包含顶点索引、纹理坐标索引和法线索引\nf 1//1 2//2 3//3    # 包含顶点索引和法线索引`, `70692466282814760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">f 1 2 3             # 只包含顶点索引\nf 1/1 2/2 3/3       # 包含顶点索引和纹理坐标索引\nf 1/1/1 2/2/2 3/3/3 # 包含顶点索引、纹理坐标索引和法线索引\nf 1//1 2//2 3//3    # 包含顶点索引和法线索引</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>f 可以有多于 3 个顶点，比如 4 个顶点代表四边形。WebGL 只能绘制三角形，所以需要将数据转换成三角形。标准并没有规定说一个面可以有多于 4 个顶点，也没有说面必须是凹的或凸的。但暂时让我们假设面是凹的。</p>\n<p>通常在 WebGL 中，我们不单独说明顶点、纹理坐标和法线，<code class="language-text">WebGL 顶点</code> 代表了包含了代表该顶点的顶点坐标、纹理坐标、法线的数据集合。例如，要绘制一个立方体，WebGL 需要 36 个顶点，每个面是两个三角形，每个三角形是 3 个顶点，6 个面每个面 2 个三角形，每个三角形 3 个顶点 = 36 个顶点。尽管一个立方体只有 8 个不重复的顶点和 6 条不重复的法线。所以，我们需要读取面的顶点索引来生成包含了顶点位置、纹理坐标、法线的 <code class="language-text">WebGL 顶点</code>。</p>\n<p>所以，根据上面的描述，我们可以像下面这样解析：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27699490237396374000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseOBJ(text) {\n  // 因为索引是从 1 开始的，所以填充索引为 0 的位置\n  const objPositions = [[0, 0, 0]];\n  const objTexcoords = [[0, 0]];\n  const objNormals = [[0, 0, 0]];\n\n  // 和 \\`f\\` 一样的索引顺序\n  const objVertexData = [objPositions, objTexcoords, objNormals];\n\n  // 和 \\`f\\` 一样的索引顺序\n  let webglVertexData = [\n    [], // 顶点\n    [], // 纹理坐标\n    [] // 法线\n  ];\n\n  function addVertex(vert) {\n    const ptn = vert.split(\'/\');\n    ptn.forEach((objIndexStr, i) => {\n      if (!objIndexStr) {\n        return;\n      }\n      const objIndex = parseInt(objIndexStr);\n      const index = objIndex + (objIndex >= 0 ? 0 : objVertexData[i].length);\n      webglVertexData[i].push(...objVertexData[i][index]);\n    });\n  }\n\n  const keywords = {\n    v(parts) {\n      objPositions.push(parts.map(parseFloat));\n    },\n    vn(parts) {\n      objNormals.push(parts.map(parseFloat));\n    },\n    vt(parts) {\n      objTexcoords.push(parts.map(parseFloat));\n    },\n    f(parts) {\n      const numTriangles = parts.length - 2;\n      for (let tri = 0; tri < numTriangles; ++tri) {\n        addVertex(parts[0]);\n        addVertex(parts[tri + 1]);\n        addVertex(parts[tri + 2]);\n      }\n    }\n  };\n}`, `27699490237396374000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 因为索引是从 1 开始的，所以填充索引为 0 的位置</span>\n  <span class="token keyword">const</span> objPositions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> objTexcoords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> objNormals <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 和 `f` 一样的索引顺序</span>\n  <span class="token keyword">const</span> objVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>objPositions<span class="token punctuation">,</span> objTexcoords<span class="token punctuation">,</span> objNormals<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 和 `f` 一样的索引顺序</span>\n  <span class="token keyword">let</span> webglVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 顶点</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 纹理坐标</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 法线</span>\n  <span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">function</span> <span class="token function">addVertex</span><span class="token punctuation">(</span><span class="token parameter">vert</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> ptn <span class="token operator">=</span> vert<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    ptn<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">objIndexStr<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>objIndexStr<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">const</span> objIndex <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>objIndexStr<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> index <span class="token operator">=</span> objIndex <span class="token operator">+</span> <span class="token punctuation">(</span>objIndex <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> objVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      webglVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>objVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token function">v</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      objPositions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">vn</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      objNormals<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">vt</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      objTexcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> numTriangles <span class="token operator">=</span> parts<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> tri <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> tri <span class="token operator">&lt;</span> numTriangles<span class="token punctuation">;</span> <span class="token operator">++</span>tri<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">addVertex</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token function">addVertex</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span>tri <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token function">addVertex</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span>tri <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的代码创建了 3 个数组来保存从 object 文件中解析出来的顶点位置、纹理坐标和法线。同时创建了 3 个数组来保存 WebGL 的顶点。为了方便引用，数组的顺序和 f 中索引的顺序是一样的。</p>\n<p>例如下面的 f 行</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72621716754375434000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`f 1/2/3/ 4/5/6 7/8/9`, `72621716754375434000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">f 1/2/3/ 4/5/6 7/8/9</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>像 4/5/6 表示对这个面的一个顶点使用“顶点 4”，“纹理坐标 5”，“法线 6”。我们将顶点、纹理坐标、法线数据放进 objVertexData 数组，这样就能简单的表示为：对 webglData 的第 i 项，使用 objData 第 i 个数组中的第 n 个元素。 这样会简化我们的代码。</p>\n<p>在函数的结尾返回我们构建的数据</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65839114291640090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n\nreturn {\n  position: webglVertexData[0],\n  texcoord: webglVertexData[1],\n  normal: webglVertexData[2]\n};`, `65839114291640090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n\n<span class="token keyword">return</span> <span class="token punctuation">{</span>\n  position<span class="token punctuation">:</span> webglVertexData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  texcoord<span class="token punctuation">:</span> webglVertexData<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  normal<span class="token punctuation">:</span> webglVertexData<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接下来要做的就是将数据绘制出来。首先我们使用三维方向光源中着色器的变体。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97841084183973740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const vs = \\`\n   attribute vec4 a_position;\n   attribute vec3 a_normal;\n   \n   uniform mat4 u_projection;\n   uniform mat4 u_view;\n   uniform mat4 u_world;\n   \n   varying vec3 v_normal;\n   \n   void main() {\n      gl_Position = u_projection * u_view * u_world * a_position;\n      v_normal = mat3(u_world) * a_normal;\n   }\n\\`;\n\nconst fs = \\`\n   precision mediump float;\n   \n   varying vec3 v_normal;\n   \n   uniform vec4 u_diffuse;\n   uniform vec3 u_lightDirection;\n   \n   void main () {\n      vec3 normal = normalize(v_normal);\n      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;\n      gl_FragColor = vec4(u_diffuse.rgb * fakeLight, u_diffuse.a);\n   }\n\\`;`, `97841084183973740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> vs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n   attribute vec4 a_position;\n   attribute vec3 a_normal;\n   \n   uniform mat4 u_projection;\n   uniform mat4 u_view;\n   uniform mat4 u_world;\n   \n   varying vec3 v_normal;\n   \n   void main() {\n      gl_Position = u_projection * u_view * u_world * a_position;\n      v_normal = mat3(u_world) * a_normal;\n   }\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n   precision mediump float;\n   \n   varying vec3 v_normal;\n   \n   uniform vec4 u_diffuse;\n   uniform vec3 u_lightDirection;\n   \n   void main () {\n      vec3 normal = normalize(v_normal);\n      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;\n      gl_FragColor = vec4(u_diffuse.rgb * fakeLight, u_diffuse.a);\n   }\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后使用来自码少趣多中的代码加载模型</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30746733706850790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`async function main() {\n  // 获取 WebGL 渲染上下文\n  /** @type {HTMLCanvasElement} */\n  const canvas = document.querySelector(\'#canvas\');\n  const gl = canvas.getContext(\'webgl\');\n  if (!gl) {\n    return;\n  }\n\n  // ... shaders ...\n\n  // 编译、链接着色器，查找属性和全局变量位置\n  const meshProgramInfo = webglUtils.createProgramInfo(gl, [vs, fs]);\n\n  const data = await loadOBJ(\'resources/models/cube/cube.obj\');\n\n  // 数据是像这样命名的：\n  //\n  // {\n  //   position: [...],\n  //   texcoord: [...],\n  //   normal: [...],\n  // }\n  //\n  // 因为这些数组的名称和顶点着色器中的属性对应，所以我们可以将数据直接传进\n  // 来自“码少趣多”文章中的 \\`createBufferInfoFromArrays\\`。\n\n  // 通过调用 gl.createBuffer, gl.bindBuffer, gl.bufferData 为每个数组创建缓冲\n  const bufferInfo = webglUtils.createBufferInfoFromArrays(gl, data);\n}`, `30746733706850790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 获取 WebGL 渲染上下文</span>\n  <span class="token comment">/** @type {HTMLCanvasElement} */</span>\n  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'#canvas\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">\'webgl\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>gl<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// ... shaders ...</span>\n\n  <span class="token comment">// 编译、链接着色器，查找属性和全局变量位置</span>\n  <span class="token keyword">const</span> meshProgramInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createProgramInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">[</span>vs<span class="token punctuation">,</span> fs<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadOBJ</span><span class="token punctuation">(</span><span class="token string">\'resources/models/cube/cube.obj\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 数据是像这样命名的：</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// {</span>\n  <span class="token comment">//   position: [...],</span>\n  <span class="token comment">//   texcoord: [...],</span>\n  <span class="token comment">//   normal: [...],</span>\n  <span class="token comment">// }</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// 因为这些数组的名称和顶点着色器中的属性对应，所以我们可以将数据直接传进</span>\n  <span class="token comment">// 来自“码少趣多”文章中的 `createBufferInfoFromArrays`。</span>\n\n  <span class="token comment">// 通过调用 gl.createBuffer, gl.bindBuffer, gl.bufferData 为每个数组创建缓冲</span>\n  <span class="token keyword">const</span> bufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后绘制数据</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97084828251495870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const cameraTarget = [0, 0, 0];\nconst cameraPosition = [0, 0, 4];\nconst zNear = 0.1;\nconst zFar = 50;\n\nfunction degToRad(deg) {\n  return (deg * Math.PI) / 180;\n}\n\nfunction render(time) {\n  time *= 0.001; // 转成秒\n\n  webglUtils.resizeCanvasToDisplaySize(gl.canvas);\n  gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);\n  gl.enable(gl.DEPTH_TEST);\n  gl.enable(gl.CULL_FACE);\n\n  const fieldOfViewRadians = degToRad(60);\n  const aspect = gl.canvas.clientWidth / gl.canvas.clientHeight;\n  const projection = m4.perspective(fieldOfViewRadians, aspect, zNear, zFar);\n\n  const up = [0, 1, 0];\n  // 通过 lookAt 计算 camera 矩阵\n  const camera = m4.lookAt(cameraPosition, cameraTarget, up);\n\n  // 通过 camera 矩阵创建 view 矩阵\n  const view = m4.inverse(camera);\n\n  const sharedUniforms = {\n    u_lightDirection: m4.normalize([-1, 3, 5]),\n    u_view: view,\n    u_projection: projection\n  };\n\n  gl.useProgram(meshProgramInfo.program);\n\n  // 调用 gl.uniform\n  webglUtils.setUniforms(meshProgramInfo, sharedUniforms);\n\n  // 调用 gl.bindBuffer, gl.enableVertexAttribArray, gl.vertexAttribPointer\n  webglUtils.setBuffersAndAttributes(gl, meshProgramInfo, bufferInfo);\n\n  // 调用 gl.uniform\n  webglUtils.setUniforms(meshProgramInfo, {\n    u_world: m4.yRotation(time),\n    u_diffuse: [1, 0.7, 0.5, 1]\n  });\n\n  // 调用 gl.drawArrays or gl.drawElements\n  webglUtils.drawBufferInfo(gl, bufferInfo);\n\n  requestAnimationFrame(render);\n}\nrequestAnimationFrame(render);`, `97084828251495870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> cameraTarget <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> cameraPosition <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> zNear <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> zFar <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">degToRad</span><span class="token punctuation">(</span><span class="token parameter">deg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>deg <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  time <span class="token operator">*=</span> <span class="token number">0.001</span><span class="token punctuation">;</span> <span class="token comment">// 转成秒</span>\n\n  webglUtils<span class="token punctuation">.</span><span class="token function">resizeCanvasToDisplaySize</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">DEPTH_TEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">CULL_FACE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> fieldOfViewRadians <span class="token operator">=</span> <span class="token function">degToRad</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> aspect <span class="token operator">=</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientWidth <span class="token operator">/</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> projection <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">perspective</span><span class="token punctuation">(</span>fieldOfViewRadians<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> zNear<span class="token punctuation">,</span> zFar<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> up <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token comment">// 通过 lookAt 计算 camera 矩阵</span>\n  <span class="token keyword">const</span> camera <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>cameraPosition<span class="token punctuation">,</span> cameraTarget<span class="token punctuation">,</span> up<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 通过 camera 矩阵创建 view 矩阵</span>\n  <span class="token keyword">const</span> view <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>camera<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> sharedUniforms <span class="token operator">=</span> <span class="token punctuation">{</span>\n    u_lightDirection<span class="token punctuation">:</span> m4<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    u_view<span class="token punctuation">:</span> view<span class="token punctuation">,</span>\n    u_projection<span class="token punctuation">:</span> projection\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>meshProgramInfo<span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 调用 gl.uniform</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>meshProgramInfo<span class="token punctuation">,</span> sharedUniforms<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 调用 gl.bindBuffer, gl.enableVertexAttribArray, gl.vertexAttribPointer</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setBuffersAndAttributes</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> meshProgramInfo<span class="token punctuation">,</span> bufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 调用 gl.uniform</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>meshProgramInfo<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    u_world<span class="token punctuation">:</span> m4<span class="token punctuation">.</span><span class="token function">yRotation</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">,</span>\n    u_diffuse<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 调用 gl.drawArrays or gl.drawElements</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">drawBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> bufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样，我们就能看到模型被加载和绘制。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/5o1eof?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="椅子"><a href="#%E6%A4%85%E5%AD%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>椅子</h2>\n<p>关于未处理 keyword 的信息，它们是什么作用呢？</p>\n<p>usemtl 是这之中最重要的。它指明了后面出现的所有几何体都使用指定的材质。例如，你有一个车辆的模型，你可能会希望车窗是透明的，保险杠是金属反光的。窗是透明的，保险杠是反光的，所以它们需要和车体不一样的绘制方法。usemtl 标签标记了这部分信息。</p>\n<p>因为我们需要单独绘制这些部分，所以我们需要修改代码，每次遇到 usemtl 我们就创建一个新的 webgl 数据集。</p>\n<p>首先，添加代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78575705050448600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseOBJ(text) {\n  // 因为索引是从 1 开始的，所以填充索引为 0 的位置\n  const objPositions = [[0, 0, 0]];\n  const objTexcoords = [[0, 0]];\n  const objNormals = [[0, 0, 0]];\n\n  // 和 \\`f\\` 一样的索引顺序\n  const objVertexData = [objPositions, objTexcoords, objNormals];\n\n  // 和 \\`f\\` 一样的索引顺序\n  let webglVertexData = [\n    [], // 顶点\n    [], // 纹理坐标\n    [] // 法线\n  ];\n\n  const geometries = [];\n  let geometry;\n  let material = \'default\';\n\n  function newGeometry() {\n    // 如果有存在的几何体并且不是空的，销毁\n    if (geometry && geometry.data.position.length) {\n      geometry = undefined;\n    }\n  }\n\n  function setGeometry() {\n    if (!geometry) {\n      const position = [];\n      const texcoord = [];\n      const normal = [];\n      webglVertexData = [position, texcoord, normal];\n      geometry = {\n        material,\n        data: {\n          position,\n          texcoord,\n          normal\n        }\n      };\n      geometries.push(geometry);\n    }\n  }\n\n  // ...\n}`, `78575705050448600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{17-44}"\n              >\n                <span class="gatsby-code-button-language">js{17-44}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 因为索引是从 1 开始的，所以填充索引为 0 的位置</span>\n  <span class="token keyword">const</span> objPositions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> objTexcoords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> objNormals <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 和 `f` 一样的索引顺序</span>\n  <span class="token keyword">const</span> objVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>objPositions<span class="token punctuation">,</span> objTexcoords<span class="token punctuation">,</span> objNormals<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 和 `f` 一样的索引顺序</span>\n  <span class="token keyword">let</span> webglVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 顶点</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 纹理坐标</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 法线</span>\n  <span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> geometries <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">let</span> geometry<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">let</span> material <span class="token operator">=</span> <span class="token string">\'default\'</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">function</span> <span class="token function">newGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">// 如果有存在的几何体并且不是空的，销毁</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>geometry <span class="token operator">&amp;&amp;</span> geometry<span class="token punctuation">.</span>data<span class="token punctuation">.</span>position<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      geometry <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">function</span> <span class="token function">setGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>geometry<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">const</span> position <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">const</span> texcoord <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">const</span> normal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      webglVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>position<span class="token punctuation">,</span> texcoord<span class="token punctuation">,</span> normal<span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      geometry <span class="token operator">=</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        material<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        data<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          position<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">          texcoord<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">          normal</span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      geometries<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>geometry<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接着当我们在处理 keywords 的时候，在合适的地方调用它们，包括添加 o keyword 的函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26283382631166718000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n\nconst keywords = {\n  v(parts) {\n    objPositions.push(parts.map(parseFloat));\n  },\n  vn(parts) {\n    objNormals.push(parts.map(parseFloat));\n  },\n  vt(parts) {\n    objTexcoords.push(parts.map(parseFloat));\n  },\n  f(parts) {\n    setGeometry();\n    const numTriangles = parts.length - 2;\n    for (let tri = 0; tri < numTriangles; ++tri) {\n      addVertex(parts[0]);\n      addVertex(parts[tri + 1]);\n      addVertex(parts[tri + 2]);\n    }\n  },\n  usemtl(parts, unparsedArgs) {\n    material = unparsedArgs;\n    newGeometry();\n  }\n};\n\n// ...`, `26283382631166718000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{14,22-25}"\n              >\n                <span class="gatsby-code-button-language">js{14,22-25}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n\n<span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function">v</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    objPositions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token function">vn</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    objNormals<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token function">vt</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    objTexcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">    <span class="token function">setGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>    <span class="token keyword">const</span> numTriangles <span class="token operator">=</span> parts<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> tri <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> tri <span class="token operator">&lt;</span> numTriangles<span class="token punctuation">;</span> <span class="token operator">++</span>tri<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">addVertex</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">addVertex</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span>tri <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">addVertex</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span>tri <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  <span class="token function">usemtl</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    material <span class="token operator">=</span> unparsedArgs<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token function">newGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>usemtl 不是必要的，如果在文件中没有 usemtl，我们想要有默认的几何体。所以在 f 函数中我们调用了 setGeometry 来创建。</p>\n<p>最后我们返回 geometries 对象数组，每个对象包含 name 和 data。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24391963159575660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n\n// return {\n//   position: webglVertexData[0],\n//   texcoord: webglVertexData[1],\n//   normal: webglVertexData[2]\n// };\nreturn geometries;`, `24391963159575660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n\n<span class="token comment">// return {</span>\n<span class="token comment">//   position: webglVertexData[0],</span>\n<span class="token comment">//   texcoord: webglVertexData[1],</span>\n<span class="token comment">//   normal: webglVertexData[2]</span>\n<span class="token comment">// };</span>\n<span class="token keyword">return</span> geometries<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同时，我们需要处理纹理坐标或法线缺失的情况。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1283180543224382500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 移除空数组\nfor (const geometry of geometries) {\n  geometry.data = Object.fromEntries(Object.entries(geometry.data).filter(([, array]) => array.length > 0));\n}\n\nreturn {\n  materialLibs,\n  geometries\n};`, `1283180543224382500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1-4}"\n              >\n                <span class="gatsby-code-button-language">js{1-4}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token comment">// 移除空数组</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> geometry <span class="token keyword">of</span> geometries<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  geometry<span class="token punctuation">.</span>data <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">fromEntries</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>geometry<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span><span class="token punctuation">,</span> array<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> array<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span></span>\n<span class="token keyword">return</span> <span class="token punctuation">{</span>\n  materialLibs<span class="token punctuation">,</span>\n  geometries\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>让我们继续 keywords，根据官方规范，mtllib 指定了包含材质信息的独立的一个或多个文件。不幸的是，在实际应用中，文件名中可以包含空格，但 .obj 格式中并没有提供逃逸字符来使用空格或引号。理想情况应该使用能解决这些问题的、良好定义的格式，比如 json、xml 或 yaml 等，但 .obj 格式诞生的比它们都早。</p>\n<p>稍后我们在处理加载文件。先让我们把它加到加载器里以便之后可以使用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46761682961595820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseOBJ(text) {\n  // ...\n  const materialLibs = [];\n\n  // ...\n\n  const keywords = {\n    // ...\n    mtllib(parts, unparsedArgs) {\n      materialLibs.push(unparsedArgs);\n    }\n    // ...\n  };\n\n  // return geometries;\n  return {\n    materialLibs,\n    geometries\n  };\n}`, `46761682961595820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3,9-11,15-19}"\n              >\n                <span class="gatsby-code-button-language">js{3,9-11,15-19}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> materialLibs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// ...</span>\n\n  <span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token comment">// ...</span>\n<span class="gatsby-highlight-code-line">    <span class="token function">mtllib</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      materialLibs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>unparsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span>    <span class="token comment">// ...</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// return geometries;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    materialLibs<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    geometries</span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>o 指定表明了接下来的条目属于命名为 “object” 的对象。但我们并不清楚如何使用它。文件中能只包含 o 而没有 usemtl 吗？先假设可以。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29814551116727420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseOBJ(text) {\n  // ...\n  let material = \'default\';\n  let object = \'default\';\n\n  // ...\n\n  function setGeometry() {\n    if (!geometry) {\n      const position = [];\n      const texcoord = [];\n      const normal = [];\n      webglVertexData = [position, texcoord, normal];\n      geometry = {\n        object,\n        material,\n        data: {\n          position,\n          texcoord,\n          normal\n        }\n      };\n      geometries.push(geometry);\n    }\n  }\n\n  const keywords = {\n    // ...\n    o(parts, unparsedArgs) {\n      object = unparsedArgs;\n      newGeometry();\n    }\n    // ...\n  };\n}`, `29814551116727420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4,15,29-32}"\n              >\n                <span class="gatsby-code-button-language">js{4,15,29-32}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n  <span class="token keyword">let</span> material <span class="token operator">=</span> <span class="token string">\'default\'</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">let</span> object <span class="token operator">=</span> <span class="token string">\'default\'</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// ...</span>\n\n  <span class="token keyword">function</span> <span class="token function">setGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>geometry<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> position <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> texcoord <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> normal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      webglVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>position<span class="token punctuation">,</span> texcoord<span class="token punctuation">,</span> normal<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      geometry <span class="token operator">=</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">        object<span class="token punctuation">,</span></span>        material<span class="token punctuation">,</span>\n        data<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n          position<span class="token punctuation">,</span>\n          texcoord<span class="token punctuation">,</span>\n          normal\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      geometries<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>geometry<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token comment">// ...</span>\n<span class="gatsby-highlight-code-line">    <span class="token function">o</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      object <span class="token operator">=</span> unparsedArgs<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      <span class="token function">newGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span>    <span class="token comment">// ...</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>s 指定了一个 smoothing group。我觉得这是我们可以忽略的。它们通常在建模程序中用来自动生成顶点法线。顶点法线的计算，需要先计算每个面的法线，而每个面的法线可以很容易使用叉乘得到，这部分已经在三维相机中提到了。对于任意顶点，我们可以对该顶点所在的面取均值。但是有时我们想要一条边时，我们需要能够告诉程序忽略一些面。Smoothing groups 让我们指定计算顶点法线时哪些面需要被包含。关于如何计算几何体的顶点法线，可以看 <code class="language-text">WebGL 三维几何加工</code> 作为例子。</p>\n<p>在我们的例子中，我们先忽略它。假设大部分 .obj 文件内部都包含法线，所以一般不需要 smoothing groups。一般在模型库中才会有它，以便你想要编辑或重新生成法线。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44506019527901405000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const noop = () => {};\n\nconst keywords = {\n  // ...\n  s: noop\n  // ...\n};`, `44506019527901405000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1,5}"\n              >\n                <span class="gatsby-code-button-language">js{1,5}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> <span class="token function-variable function">noop</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>\n<span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n<span class="gatsby-highlight-code-line">  s<span class="token punctuation">:</span> noop</span>  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>目前为止我们还剩一个 keyword：g 代表组 (group)。通常它只是一些元数据。Objects 可以存在于多个 group 中。因为它会出现在我们接下来的文件中，所以我们先添加支持代码，尽管现在并不使用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20140148063428653000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseOBJ(text) {\n  // ...\n  let groups = [\'default\'];\n  // ...\n  function setGeometry() {\n    if (!geometry) {\n      const position = [];\n      const texcoord = [];\n      const normal = [];\n      webglVertexData = [position, texcoord, normal];\n      geometry = {\n        object,\n        groups,\n        material,\n        data: {\n          position,\n          texcoord,\n          normal\n        }\n      };\n      geometries.push(geometry);\n    }\n  }\n\n  // ...\n\n  const keywords = {\n    // ...\n    g(parts) {\n      groups = parts;\n      newGeometry();\n    }\n    // ...\n  };\n}`, `20140148063428653000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3,13,29-32}"\n              >\n                <span class="gatsby-code-button-language">js{3,13,29-32}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">let</span> groups <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'default\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>  <span class="token comment">// ...</span>\n  <span class="token keyword">function</span> <span class="token function">setGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>geometry<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> position <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> texcoord <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> normal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      webglVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>position<span class="token punctuation">,</span> texcoord<span class="token punctuation">,</span> normal<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      geometry <span class="token operator">=</span> <span class="token punctuation">{</span>\n        object<span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">        groups<span class="token punctuation">,</span></span>        material<span class="token punctuation">,</span>\n        data<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n          position<span class="token punctuation">,</span>\n          texcoord<span class="token punctuation">,</span>\n          normal\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      geometries<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>geometry<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// ...</span>\n\n  <span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token comment">// ...</span>\n<span class="gatsby-highlight-code-line">    <span class="token function">g</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      groups <span class="token operator">=</span> parts<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      <span class="token function">newGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span>    <span class="token comment">// ...</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在我们创建了多个几何体的集合，我们需要改变我们的初始化代码来为每一个几何体创建 WebGLBuffers。同时我们也会创建一个随机的颜色，这样就能方便地分辨不同的部分。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53243456422518505000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// const response = await fetch(\'resources/models/cube/cube.obj\');\nconst response = await fetch(\'resources/models/chair/chair.obj\');\nconst text = await response.text();\n// const data = parseOBJ(text);\nconst obj = parseOBJ(text);\n\nconst parts = obj.geometries.map(({ data }) => {\n  // 数据是像这样命名的：\n  //\n  // {\n  //   position: [...],\n  //   texcoord: [...],\n  //   normal: [...],\n  // }\n  //\n  // 因为这些数组的名称和顶点着色器中的属性对应，所以我们可以将数据直接传进\n  // 来自“码少趣多”文章中的 \\`createBufferInfoFromArrays\\`。\n\n  // 通过调用 gl.createBuffer, gl.bindBuffer, gl.bufferData 为每个数组创建缓冲\n  const bufferInfo = webglUtils.createBufferInfoFromArrays(gl, data);\n  return {\n    material: {\n      u_diffuse: [Math.random(), Math.random(), Math.random(), 1]\n    },\n    bufferInfo\n  };\n});`, `53243456422518505000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1-2,4-5,7,21-26}"\n              >\n                <span class="gatsby-code-button-language">js{1-2,4-5,7,21-26}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token comment">// const response = await fetch(\'resources/models/cube/cube.obj\');</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">\'resources/models/chair/chair.obj\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token keyword">const</span> text <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// const data = parseOBJ(text);</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> parts <span class="token operator">=</span> obj<span class="token punctuation">.</span>geometries<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>  <span class="token comment">// 数据是像这样命名的：</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// {</span>\n  <span class="token comment">//   position: [...],</span>\n  <span class="token comment">//   texcoord: [...],</span>\n  <span class="token comment">//   normal: [...],</span>\n  <span class="token comment">// }</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// 因为这些数组的名称和顶点着色器中的属性对应，所以我们可以将数据直接传进</span>\n  <span class="token comment">// 来自“码少趣多”文章中的 `createBufferInfoFromArrays`。</span>\n\n  <span class="token comment">// 通过调用 gl.createBuffer, gl.bindBuffer, gl.bufferData 为每个数组创建缓冲</span>\n  <span class="token keyword">const</span> bufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    material<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      u_diffuse<span class="token punctuation">:</span> <span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    bufferInfo</span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们从加载一个立方体换成了椅子</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-06-28-14-35-39-9324f3fe917e357a9d20161d5f6aace9-2c25a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 55.86283185840708%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAACsUlEQVQozy2S224TVxSG/S6ovUCCyomKgDgBYjsnJxkGxyGOj8GO7bE98YzHnoPHHh9iCCJULaVS1RsQFyBxi7jmqpX6BBWPwFt8XeNw8WvvLf37W/9ae0fW1xMoispxNk/lpIpWb3LW7mB2ulhGD7vbv5LZk7OFeWagt3TxaQt//rjAwaMM25s7xFbWiBw9zlJ5corePMOSS67tMfRGBP6Y+WhC7vJ3ErMXuLKf+kNGno/veLg9m57RlXs6p5XaAqwqj4jUqnWMMxOn7zLyA2bBjPlkzkUwwf/lFVsfPrH07Fcezy54NgqYBmOmso4FPnQHuJZNV+5rtQbFfIlI2F4ICwR2LrCnk3PmU1mHQ9yXr0j98YZop8fWQEDegLEknPojpsPRAjryrqCm3qFRrREJZzWwB0ykxZmkmn1PENgOwflT1l685prhcHf+EicE2H182yZwvQU8kJSDfti+SbuhCVDiej13MZuwYmgaCswzTWzHJXn5muvOmJgAy5Uq+smJJLLwRL6A/L54rT5Wx6BVbxDRtRa9jimmPgMZtGfJyxoGrtGRmeRRzi958Pw39v98R+nLv1TF57SaC48jRR3ToCcv32m2qUvBSLV8siAbrTbddhtL1G1qWC2NciZN6q/3JD7/Teqfr+z/943j+QWtfBa9VsNsNjFEer1OQ2DlfEG+zUGGUi7PaalMQ9ppPgkV7otouSyt8Zzs24+ogwkrqT2Wl5aIr94lndqmeJjhtFikUihQODoio8q32U5uoO7ucaiq5A7SFCVV8fBKOVUReJWSFDW0NncEduPHH7gVvcn2+n0yeymyaZWM8hBlZ4fNeJzIcjTK6p3bxNdW2RLTbmKdveSVlGSch1sbxH6Okt7dIR5bYfNejFT8Pspmkv2NhIAfSOJVYrdvsfzTTf4HbwfozfGzl/sAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 06 28 14 35 39" title="" data-src="/static/2022-06-28-14-35-39-9324f3fe917e357a9d20161d5f6aace9-fee1c.png" data-srcset="/static/2022-06-28-14-35-39-9324f3fe917e357a9d20161d5f6aace9-a67b7.png 200w,\n/static/2022-06-28-14-35-39-9324f3fe917e357a9d20161d5f6aace9-0b187.png 400w,\n/static/2022-06-28-14-35-39-9324f3fe917e357a9d20161d5f6aace9-fee1c.png 800w,\n/static/2022-06-28-14-35-39-9324f3fe917e357a9d20161d5f6aace9-2c25a.png 904w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>要渲染，我们只需要循环绘制每个部分</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88101297809861250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function render(time) {\n  // ...\n\n  gl.useProgram(meshProgramInfo.program);\n\n  // 调用 gl.uniform\n  webglUtils.setUniforms(meshProgramInfo, sharedUniforms);\n\n  // 对整个空间矩阵进行一次计算\n  const u_world = m4.yRotation(time);\n\n  for (const { bufferInfo, material } of parts) {\n    // 调用 gl.bindBuffer, gl.enableVertexAttribArray, gl.vertexAttribPointer\n    webglUtils.setBuffersAndAttributes(gl, meshProgramInfo, bufferInfo);\n    // 调用 gl.uniform\n    webglUtils.setUniforms(meshProgramInfo, {\n      // u_world: m4.yRotation(time),\n      // u_diffuse: [1, 0.7, 0.5, 1],\n      u_world,\n      u_diffuse: material.u_diffuse\n    });\n    // 调用 gl.drawArrays or gl.drawElements\n    webglUtils.drawBufferInfo(gl, bufferInfo);\n  }\n\n  // ...\n}`, `88101297809861250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{9-10,12,17-20}"\n              >\n                <span class="gatsby-code-button-language">js{9-10,12,17-20}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>meshProgramInfo<span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 调用 gl.uniform</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>meshProgramInfo<span class="token punctuation">,</span> sharedUniforms<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 对整个空间矩阵进行一次计算</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> u_world <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">yRotation</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">{</span> bufferInfo<span class="token punctuation">,</span> material <span class="token punctuation">}</span> <span class="token keyword">of</span> parts<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>    <span class="token comment">// 调用 gl.bindBuffer, gl.enableVertexAttribArray, gl.vertexAttribPointer</span>\n    webglUtils<span class="token punctuation">.</span><span class="token function">setBuffersAndAttributes</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> meshProgramInfo<span class="token punctuation">,</span> bufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 调用 gl.uniform</span>\n    webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>meshProgramInfo<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">      <span class="token comment">// u_world: m4.yRotation(time),</span></span><span class="gatsby-highlight-code-line">      <span class="token comment">// u_diffuse: [1, 0.7, 0.5, 1],</span></span><span class="gatsby-highlight-code-line">      u_world<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      u_diffuse<span class="token punctuation">:</span> material<span class="token punctuation">.</span>u_diffuse</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 调用 gl.drawArrays or gl.drawElements</span>\n    webglUtils<span class="token punctuation">.</span><span class="token function">drawBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> bufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/3qq063?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>如果我们试着把物体放中间是不是更好？</p>\n<p>为了把物体放中间我们需要计算物体的范围，即顶点的最小和最大位置。首先我们需要一个函数，计算给定多个位置中的最小和最大位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50722974772014570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function getExtents(positions) {\n  const min = positions.slice(0, 3);\n  const max = positions.slice(0, 3);\n  for (let i = 3; i < positions.length; i += 3) {\n    for (let j = 0; j < 3; ++j) {\n      const v = positions[i + j];\n      min[j] = Math.min(v, min[j]);\n      max[j] = Math.max(v, max[j]);\n    }\n  }\n  return { min, max };\n}`, `50722974772014570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getExtents</span><span class="token punctuation">(</span><span class="token parameter">positions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> min <span class="token operator">=</span> positions<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> max <span class="token operator">=</span> positions<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> positions<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> v <span class="token operator">=</span> positions<span class="token punctuation">[</span>i <span class="token operator">+</span> j<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      min<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> min<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      max<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> max<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span> min<span class="token punctuation">,</span> max <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后我们遍历几何体的每个部分，并且得到对应的范围</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50043895073987430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function getGeometriesExtents(geometries) {\n  return geometries.reduce(\n    ({ min, max }, { data }) => {\n      const minMax = getExtents(data.position);\n      return {\n        min: min.map((min, ndx) => Math.min(minMax.min[ndx], min)),\n        max: max.map((max, ndx) => Math.max(minMax.max[ndx], max))\n      };\n    },\n    {\n      min: Array(3).fill(Number.POSITIVE_INFINITY),\n      max: Array(3).fill(Number.NEGATIVE_INFINITY)\n    }\n  );\n}`, `50043895073987430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getGeometriesExtents</span><span class="token punctuation">(</span><span class="token parameter">geometries</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> geometries<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>\n    <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> min<span class="token punctuation">,</span> max <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> minMax <span class="token operator">=</span> <span class="token function">getExtents</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> <span class="token punctuation">{</span>\n        min<span class="token punctuation">:</span> min<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">min<span class="token punctuation">,</span> ndx</span><span class="token punctuation">)</span> <span class="token operator">=></span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>minMax<span class="token punctuation">.</span>min<span class="token punctuation">[</span>ndx<span class="token punctuation">]</span><span class="token punctuation">,</span> min<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        max<span class="token punctuation">:</span> max<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">max<span class="token punctuation">,</span> ndx</span><span class="token punctuation">)</span> <span class="token operator">=></span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>minMax<span class="token punctuation">.</span>max<span class="token punctuation">[</span>ndx<span class="token punctuation">]</span><span class="token punctuation">,</span> max<span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      min<span class="token punctuation">:</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token constant">POSITIVE_INFINITY</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      max<span class="token punctuation">:</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token constant">NEGATIVE_INFINITY</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接着，我们需要计算物体的平移距离，以便能将它的中心放在原点，同时计算原点和 camera 的距离，保证能完全看到物体。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70619193305755100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// const cameraTarget = [0, 0, 0];\n// const cameraPosition = [0, 0, 4];\n// const zNear = 0.1;\n// const zFar = 50;\nconst extents = getGeometriesExtents(obj.geometries);\nconst range = m4.subtractVectors(extents.max, extents.min);\n// 移动物体的距离，使得其中心在原点\nconst objOffset = m4.scaleVector(m4.addVectors(extents.min, m4.scaleVector(range, 0.5)), -1);\nconst cameraTarget = [0, 0, 0];\n// 计算移动 camera 的距离，以便我们能完全看到物体\nconst radius = m4.length(range) * 1.2;\nconst cameraPosition = m4.addVectors(cameraTarget, [0, 0, radius]);\n// 设置合适于物体大小的 zNear 和 zFar 值\nconst zNear = radius / 100;\nconst zFar = radius * 3;`, `70619193305755100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// const cameraTarget = [0, 0, 0];</span>\n<span class="token comment">// const cameraPosition = [0, 0, 4];</span>\n<span class="token comment">// const zNear = 0.1;</span>\n<span class="token comment">// const zFar = 50;</span>\n<span class="token keyword">const</span> extents <span class="token operator">=</span> <span class="token function">getGeometriesExtents</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>geometries<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> range <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">subtractVectors</span><span class="token punctuation">(</span>extents<span class="token punctuation">.</span>max<span class="token punctuation">,</span> extents<span class="token punctuation">.</span>min<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 移动物体的距离，使得其中心在原点</span>\n<span class="token keyword">const</span> objOffset <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scaleVector</span><span class="token punctuation">(</span>m4<span class="token punctuation">.</span><span class="token function">addVectors</span><span class="token punctuation">(</span>extents<span class="token punctuation">.</span>min<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">scaleVector</span><span class="token punctuation">(</span>range<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> cameraTarget <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token comment">// 计算移动 camera 的距离，以便我们能完全看到物体</span>\n<span class="token keyword">const</span> radius <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.2</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> cameraPosition <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">addVectors</span><span class="token punctuation">(</span>cameraTarget<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> radius<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 设置合适于物体大小的 zNear 和 zFar 值</span>\n<span class="token keyword">const</span> zNear <span class="token operator">=</span> radius <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> zFar <span class="token operator">=</span> radius <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面，我们也设置了适合显示物体的 zNear 和 zFar 值。</p>\n<p>只需要使用 objOffset 来将物体平移到原点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82745753219633140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 将整个空间矩阵重新计算一次\nconst u_world = m4.yRotation(time);\nlet u_world = m4.yRotation(time);\nu_world = m4.translate(u_world, ...objOffset);`, `82745753219633140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 将整个空间矩阵重新计算一次</span>\n<span class="token keyword">const</span> u_world <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">yRotation</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> u_world <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">yRotation</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>\nu_world <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>u_world<span class="token punctuation">,</span> <span class="token operator">...</span>objOffset<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/zbrpfw?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="书"><a href="#%E4%B9%A6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>书</h2>\n<p>有些非标准的 .obj 文件包含了顶点的颜色值，它们将额外的值放在了每个顶点位置的后面</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63565844680046756000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 标准\nv <x> <y> <z>\n// 非标准\nv <x> <y> <z> <red> <green> <blue>`, `63565844680046756000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">// 标准\nv &lt;x&gt; &lt;y&gt; &lt;z&gt;\n// 非标准\nv &lt;x&gt; &lt;y&gt; &lt;z&gt; &lt;red&gt; &lt;green&gt; &lt;blue&gt;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>由 <a href="https://sketchfab.com/homkahom0" target="_blank" rel="nofollow noreferrer noopener">Oleaf</a> 创建的 <a href="https://sketchfab.com/3d-models/book-vertex-chameleon-study-51b0b3bdcd844a9e951a9ede6f192da8" target="_blank" rel="nofollow noreferrer noopener">Book - Vertex chameleon study by CC-BY-NC</a> 使用了顶点颜色。</p>\n<p>让我们看看能不能添加代码来支持显示顶点颜色。</p>\n<p>我们需要在有顶点位置、法线和纹理坐标的地方添加一些代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25138170520941960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseOBJ(text) {\n  // 因为索引是从 1 开始的，所以填充索引为 0 的位置\n  const objPositions = [[0, 0, 0]];\n  const objTexcoords = [[0, 0]];\n  const objNormals = [[0, 0, 0]];\n  const objColors = [[0, 0, 0]];\n\n  // 和 \\`f\\` 一样的索引顺序\n  const objVertexData = [objPositions, objTexcoords, objNormals, objColors];\n\n  // 和 \\`f\\` 一样的索引顺序\n  let webglVertexData = [\n    [], // 顶点\n    [], // 纹理坐标\n    [], // 法线\n    [] // 颜色\n  ];\n\n  // ...\n\n  function setGeometry() {\n    if (!geometry) {\n      const position = [];\n      const texcoord = [];\n      const normal = [];\n      const color = [];\n      webglVertexData = [position, texcoord, normal, color];\n      geometry = {\n        object,\n        groups,\n        material,\n        data: {\n          position,\n          texcoord,\n          normal,\n          color\n        }\n      };\n      geometries.push(geometry);\n    }\n  }\n}`, `25138170520941960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{6,9,16,26-27,36}"\n              >\n                <span class="gatsby-code-button-language">js{6,9,16,26-27,36}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 因为索引是从 1 开始的，所以填充索引为 0 的位置</span>\n  <span class="token keyword">const</span> objPositions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> objTexcoords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> objNormals <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> objColors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// 和 `f` 一样的索引顺序</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> objVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>objPositions<span class="token punctuation">,</span> objTexcoords<span class="token punctuation">,</span> objNormals<span class="token punctuation">,</span> objColors<span class="token punctuation">]</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// 和 `f` 一样的索引顺序</span>\n  <span class="token keyword">let</span> webglVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 顶点</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 纹理坐标</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 法线</span>\n<span class="gatsby-highlight-code-line">    <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 颜色</span></span>  <span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n\n  <span class="token keyword">function</span> <span class="token function">setGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>geometry<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> position <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> texcoord <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> normal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">      <span class="token keyword">const</span> color <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      webglVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>position<span class="token punctuation">,</span> texcoord<span class="token punctuation">,</span> normal<span class="token punctuation">,</span> color<span class="token punctuation">]</span><span class="token punctuation">;</span></span>      geometry <span class="token operator">=</span> <span class="token punctuation">{</span>\n        object<span class="token punctuation">,</span>\n        groups<span class="token punctuation">,</span>\n        material<span class="token punctuation">,</span>\n        data<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n          position<span class="token punctuation">,</span>\n          texcoord<span class="token punctuation">,</span>\n          normal<span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">          color</span>        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      geometries<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>geometry<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这使得我们的代码有一点不通用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89185681646162300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const keywords = {\n  v(parts) {\n    // objPositions.push(parts.map(parseFloat));\n    // 如果超过 3 个值，就是顶点颜色\n    if (parts.length > 3) {\n      objPositions.push(parts.slice(0, 3).map(parseFloat));\n      objColors.push(parts.slice(3).map(parseFloat));\n    } else {\n      objPositions.push(parts.map(parseFloat));\n    }\n  }\n  // ...\n};`, `89185681646162300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3-10}"\n              >\n                <span class="gatsby-code-button-language">js{3-10}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function">v</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">    <span class="token comment">// objPositions.push(parts.map(parseFloat));</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">// 如果超过 3 个值，就是顶点颜色</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>parts<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      objPositions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      objColors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      objPositions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span>  <span class="token punctuation">}</span>\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后当我们读取到 f 面的时候，调用 addVertex，我们需要获取顶点的颜色</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12824612734814767000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function addVertex(vert) {\n  const ptn = vert.split(\'/\');\n  ptn.forEach((objIndexStr, i) => {\n    if (!objIndexStr) {\n      return;\n    }\n    const objIndex = parseInt(objIndexStr);\n    const index = objIndex + (objIndex >= 0 ? 0 : objVertexData[i].length);\n    webglVertexData[i].push(...objVertexData[i][index]);\n    // 如果这是位置索引并且解析到了颜色值，将顶点的颜色值复制到 webgl 顶点的颜色中\n    if (i === 0 && objColors.length > 1) {\n      geometry.data.color.push(...objColors[index]);\n    }\n  });\n}`, `12824612734814767000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{10-13}"\n              >\n                <span class="gatsby-code-button-language">js{10-13}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">addVertex</span><span class="token punctuation">(</span><span class="token parameter">vert</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> ptn <span class="token operator">=</span> vert<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  ptn<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">objIndexStr<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>objIndexStr<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> objIndex <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>objIndexStr<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> index <span class="token operator">=</span> objIndex <span class="token operator">+</span> <span class="token punctuation">(</span>objIndex <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> objVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    webglVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>objVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">    <span class="token comment">// 如果这是位置索引并且解析到了颜色值，将顶点的颜色值复制到 webgl 顶点的颜色中</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> objColors<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      geometry<span class="token punctuation">.</span>data<span class="token punctuation">.</span>color<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>objColors<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接着，我们需要更改我们的着色器来使用顶点颜色</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46011421408608450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const vs = \\`\n   attribute vec4 a_position;\n   attribute vec3 a_normal;\n   attribute vec4 a_color;\n   \n   uniform mat4 u_projection;\n   uniform mat4 u_view;\n   uniform mat4 u_world;\n   \n   varying vec3 v_normal;\n   varying vec4 v_color;\n   \n   void main() {\n      gl_Position = u_projection * u_view * u_world * a_position;\n      v_normal = mat3(u_world) * a_normal;\n      v_color = a_color;\n   }\n\\`;\n\nconst fs = \\`\n   precision mediump float;\n   \n   varying vec3 v_normal;\n   varying vec4 v_color;\n   \n   uniform vec4 u_diffuse;\n   uniform vec3 u_lightDirection;\n   \n   void main () {\n      vec3 normal = normalize(v_normal);\n      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;\n      // gl_FragColor = vec4(u_diffuse.rgb * fakeLight, u_diffuse.a);\n      vec4 diffuse = u_diffuse * v_color;\n      gl_FragColor = vec4(diffuse.rgb * fakeLight, diffuse.a);\n   }\n\\`;`, `46011421408608450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4,11,16,24,32-34}"\n              >\n                <span class="gatsby-code-button-language">js{4,11,16,24,32-34}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> vs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   attribute vec4 a_position;</span>\n<span class="token string">   attribute vec3 a_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   attribute vec4 a_color;</span></span><span class="token string">   </span>\n<span class="token string">   uniform mat4 u_projection;</span>\n<span class="token string">   uniform mat4 u_view;</span>\n<span class="token string">   uniform mat4 u_world;</span>\n<span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   varying vec4 v_color;</span></span><span class="token string">   </span>\n<span class="token string">   void main() {</span>\n<span class="token string">      gl_Position = u_projection * u_view * u_world * a_position;</span>\n<span class="token string">      v_normal = mat3(u_world) * a_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">      v_color = a_color;</span></span><span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   precision mediump float;</span>\n<span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   varying vec4 v_color;</span></span><span class="token string">   </span>\n<span class="token string">   uniform vec4 u_diffuse;</span>\n<span class="token string">   uniform vec3 u_lightDirection;</span>\n<span class="token string">   </span>\n<span class="token string">   void main () {</span>\n<span class="token string">      vec3 normal = normalize(v_normal);</span>\n<span class="token string">      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">      // gl_FragColor = vec4(u_diffuse.rgb * fakeLight, u_diffuse.a);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      vec4 diffuse = u_diffuse * v_color;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      gl_FragColor = vec4(diffuse.rgb * fakeLight, diffuse.a);</span></span><span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>就如上面提到的，我不确定这个非标准版本的 .obj 文件能否在每个顶点颜色中包含 alpha 值。我们的 helper library 根据我们传入的数据自动创建缓冲区。它假设每个元素有多少个组成部分。对于名字中包含 position 或 normal 的，默认每个元素包含 3 个组成部分。对于名字中包含 texcoord 的，默认每个元素 2 个组成部分。其它的每个元素默认 4 个组成部分。这样的话，如果我们的颜色仅包含 r、g、b，每个元素三个组成部分，我们需要传参给它。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83272546375129270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const parts = obj.geometries.map(({ data }) => {\n  // 数据是像这样命名的：\n  //\n  // {\n  //   position: [...],\n  //   texcoord: [...],\n  //   normal: [...],\n  // }\n  //\n  // 因为这些数组的名称和顶点着色器中的属性对应，所以我们可以将数据直接传进\n  // 来自“码少趣多”文章中的 \\`createBufferInfoFromArrays\\`。\n\n  if (data.position.length === data.color.length) {\n    // 是 3，helper library 默认是 4 所以我们需要告诉程序只有 3 个\n    data.color = { numComponents: 3, data: data.color };\n  }\n\n  // 通过调用 gl.createBuffer, gl.bindBuffer, gl.bufferData 为每个数组创建缓冲\n  const bufferInfo = webglUtils.createBufferInfoFromArrays(gl, data);\n  return {\n    material: {\n      u_diffuse: [Math.random(), Math.random(), Math.random(), 1]\n    },\n    bufferInfo\n  };\n});`, `83272546375129270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{13-16}"\n              >\n                <span class="gatsby-code-button-language">js{13-16}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> parts <span class="token operator">=</span> obj<span class="token punctuation">.</span>geometries<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 数据是像这样命名的：</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// {</span>\n  <span class="token comment">//   position: [...],</span>\n  <span class="token comment">//   texcoord: [...],</span>\n  <span class="token comment">//   normal: [...],</span>\n  <span class="token comment">// }</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// 因为这些数组的名称和顶点着色器中的属性对应，所以我们可以将数据直接传进</span>\n  <span class="token comment">// 来自“码少趣多”文章中的 `createBufferInfoFromArrays`。</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>position<span class="token punctuation">.</span>length <span class="token operator">===</span> data<span class="token punctuation">.</span>color<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">// 是 3，helper library 默认是 4 所以我们需要告诉程序只有 3 个</span></span><span class="gatsby-highlight-code-line">    data<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token punctuation">{</span> numComponents<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> data<span class="token punctuation">.</span>color <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  <span class="token comment">// 通过调用 gl.createBuffer, gl.bindBuffer, gl.bufferData 为每个数组创建缓冲</span>\n  <span class="token keyword">const</span> bufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    material<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      u_diffuse<span class="token punctuation">:</span> <span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    bufferInfo\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们也希望能够处理更常见的没有顶点颜色的情况。在 WebGL 基础概念和 WebGL 属性中我们提到了属性通常从缓冲中获取值。但我们也可以将属性设置成常量。没有的值使用默认常量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69523226438109450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gl.disableVertexAttribArray(someAttributeLocation); // 使用常量\nconst value = [1, 2, 3, 4];\ngl.vertexAttrib4fv(someAttributeLocation, value); // 使用给定的值`, `69523226438109450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gl<span class="token punctuation">.</span><span class="token function">disableVertexAttribArray</span><span class="token punctuation">(</span>someAttributeLocation<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使用常量</span>\n<span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">vertexAttrib4fv</span><span class="token punctuation">(</span>someAttributeLocation<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使用给定的值</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>如果将属性的值设为 <code class="language-text">{value:[1, 2, 3, 4]}</code>，我们的 helper library 为我们处理了这种情况。当检查到没有顶点颜色时，默认将顶点颜色属性设置成白色。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64829919807193080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const parts = obj.geometries.map(({ data }) => {\n  // 数据是像这样命名的：\n  //\n  // {\n  //   position: [...],\n  //   texcoord: [...],\n  //   normal: [...],\n  // }\n  //\n  // 因为这些数组的名称和顶点着色器中的属性对应，所以我们可以将数据直接传进\n  // 来自“码少趣多”文章中的 \\`createBufferInfoFromArrays\\`。\n\n  if (data.color) {\n    if (data.position.length === data.color.length) {\n      // 是 3，helper library 默认是 4 所以我们需要告诉程序只有 3 个\n      data.color = { numComponents: 3, data: data.color };\n    }\n  } else {\n    // 没有顶点颜色，使用白色\n    data.color = { value: [1, 1, 1, 1] };\n  }\n\n  // ...\n});`, `64829919807193080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{13,18-21}"\n              >\n                <span class="gatsby-code-button-language">js{13,18-21}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> parts <span class="token operator">=</span> obj<span class="token punctuation">.</span>geometries<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 数据是像这样命名的：</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// {</span>\n  <span class="token comment">//   position: [...],</span>\n  <span class="token comment">//   texcoord: [...],</span>\n  <span class="token comment">//   normal: [...],</span>\n  <span class="token comment">// }</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// 因为这些数组的名称和顶点着色器中的属性对应，所以我们可以将数据直接传进</span>\n  <span class="token comment">// 来自“码少趣多”文章中的 `createBufferInfoFromArrays`。</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>color<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>position<span class="token punctuation">.</span>length <span class="token operator">===</span> data<span class="token punctuation">.</span>color<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 是 3，helper library 默认是 4 所以我们需要告诉程序只有 3 个</span>\n      data<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token punctuation">{</span> numComponents<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> data<span class="token punctuation">.</span>color <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">// 没有顶点颜色，使用白色</span></span><span class="gatsby-highlight-code-line">    data<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们也不能使用随机颜色</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95965599941949160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const parts = obj.geometries.map(({ data }) => {\n  // ...\n\n  // 通过调用 gl.createBuffer, gl.bindBuffer, gl.bufferData 为每个数组创建缓冲\n  const bufferInfo = webglUtils.createBufferInfoFromArrays(gl, data);\n  return {\n    material: {\n      // u_diffuse: [Math.random(), Math.random(), Math.random(), 1],\n      u_diffuse: [1, 1, 1, 1]\n    },\n    bufferInfo\n  };\n});`, `95965599941949160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{8-9}"\n              >\n                <span class="gatsby-code-button-language">js{8-9}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> parts <span class="token operator">=</span> obj<span class="token punctuation">.</span>geometries<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 通过调用 gl.createBuffer, gl.bindBuffer, gl.bufferData 为每个数组创建缓冲</span>\n  <span class="token keyword">const</span> bufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    material<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">      <span class="token comment">// u_diffuse: [Math.random(), Math.random(), Math.random(), 1],</span></span><span class="gatsby-highlight-code-line">      u_diffuse<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span></span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    bufferInfo\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样，我们就能带顶点颜色的 .obj 文件了。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/761hg3?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>至于解析和使用材质，看下一篇。</p>\n<h2 id="一些注意点"><a href="#%E4%B8%80%E4%BA%9B%E6%B3%A8%E6%84%8F%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一些注意点</h2>\n<ul>\n<li>\n<p>这个加载器是不完整的</p>\n<p>你可以阅读更多关于 .obj 格式。有大量的功能上面的代码是不支持的。同时，代码也没有经过大量 .obj 文件的测试，所以可能有很多未知的 bug。也就是说，我假设了大多数在线的 .obj 文件只使用了上面提到的功能，所以这部分代码说不定是一个有用的例子。</p>\n</li>\n<li>\n<p>这个加载器没有进行错误检查</p>\n<p>例如：vt 可以有 3 个值而不仅仅是 2 个。3 个值是给 3D 纹理使用的，不普遍所以我没有处理。如果你确实想要用它解析 3D 纹理座标，你需要修改着色器来处理 3D 纹理，修改生成 WebGLBuffers (调用 createBufferInfoFromArrays)的代码，告诉它每个 UV 座标有 3 个组成部分。</p>\n</li>\n<li>\n<p>假设数据是一致的</p>\n<p>我不知道是否会出现同一个文件中一些 f 有 3 个条目而另一些只有 2 个条目会。如果有可能，上面的代码没有处理这种情况。</p>\n<p>这段代码同样假设了所有顶点座标都有 x、y、z。如果出现有些顶点座标有 x、y、z，有些顶点座标只有 x、y，而有些则有 x、y、z、r、g、b，我们需要重构代码。</p>\n</li>\n<li>\n<p>可以将所有数据放进一个缓冲里</p>\n<p>上面的代码将顶点位置、纹理座标、法线放进了不同的缓冲。你也可以将它们交错的放进一个缓冲中：pos, uv, nrm, pos, uv, nrm, … 这样的话就需要改变设置属性的方式。</p>\n<p>更进一步，你甚至可以将所有部分的所有数据放进同一个缓冲里，而不是每个部分、每个类型的数据一个缓冲。</p>\n<p>我不考虑这些因为我觉得它们没有那么重要，同时它们也会使得代码变得复杂。</p>\n</li>\n<li>\n<p>可以重建顶点的索引</p>\n<p>上面的代码将顶点展开放进了三个数组中。我们可以重建顶点的索引。尤其当我们将所有顶点数据放进一个共享的缓冲中，或至少每个类型有一个单独的共享缓冲时，对于每个 f 面，可以将索引转换到一个正数（负数变换到正确的正数），那么对于每个顶点，数据集就变成了一个或多个 id。所以，只要记下 id 到索引的映射关系就能查找到对应的索引。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69412951097239620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const idToIndexMap = {};\nconst webglIndices = [];\n\nfunction addVertex(vert) {\n  const ptn = vert.split(\'/\');\n  // 首先将所有索引转换成正数\n  const indices = ptn.forEach((objIndexStr, i) => {\n     if (!objIndexStr) {\n        return;\n     }\n     const objIndex = parseInt(objIndexStr);\n     return objIndex + (objIndex >= 0 ? 0 : objVertexData[i].length);\n  });\n  // 现在检查已存在的顶点位置、纹理座标、法线组合\n  const id = indices.join(\',\');\n  let vertIndex = idToIndexMap[id];\n  if (!vertIndex) {\n     vertIndex = webglVertexData[0].length / 3;\n     idToIndexMap[id] = vertexIndex;\n     indices.forEach((index, i) => {\n        if (index !== undefined) {\n        webglVertexData[i].push(...objVertexData[i][index]);\n        }\n     })\n  }\n  webglIndices.push(vertexIndex);\n}`, `69412951097239620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> idToIndexMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> webglIndices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">addVertex</span><span class="token punctuation">(</span><span class="token parameter">vert</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> ptn <span class="token operator">=</span> vert<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 首先将所有索引转换成正数</span>\n  <span class="token keyword">const</span> indices <span class="token operator">=</span> ptn<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">objIndexStr<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>objIndexStr<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span><span class="token punctuation">;</span>\n     <span class="token punctuation">}</span>\n     <span class="token keyword">const</span> objIndex <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>objIndexStr<span class="token punctuation">)</span><span class="token punctuation">;</span>\n     <span class="token keyword">return</span> objIndex <span class="token operator">+</span> <span class="token punctuation">(</span>objIndex <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> objVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 现在检查已存在的顶点位置、纹理座标、法线组合</span>\n  <span class="token keyword">const</span> id <span class="token operator">=</span> indices<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\',\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> vertIndex <span class="token operator">=</span> idToIndexMap<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vertIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n     vertIndex <span class="token operator">=</span> webglVertexData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">;</span>\n     idToIndexMap<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> vertexIndex<span class="token punctuation">;</span>\n     indices<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">index<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        webglVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>objVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n     <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n  webglIndices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>vertexIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>或者，如果你觉得重要你可以重排索引。</p>\n</li>\n<li>\n<p>这段代码没有处理只有顶点座标，或只有顶点座标和纹理座标的情况</p>\n<p>这段代码假设法线存在。就像我们在三维几何加工里做的，如果法线不存在，我们可以生成它，考虑到如果我们需要 smoothing group。或者我们也可以不使用也不计算法线的不同着色器。</p>\n</li>\n<li>\n<p>你不应该使用 .obj 文件</p>\n<p>老实说，我认为你不应该使用 .obj 文件。我写这篇文章是作为一个例子。如果你可以从一个文件中获取顶点数据，你可以为任意格式的文件写导入器。</p>\n<p>.obj 文件的问题包括：</p>\n<ul>\n<li>\n<p>不支持光线或视角</p>\n<p>如果你加载大量部件（比如景观中的树、灌木、石头），你不需要视角或光线，这可能没问题。但文件如果提供选项让你能够原样导入作者创建的整个场景会更好。</p>\n</li>\n<li>\n<p>没有层级，没有场景图</p>\n<p>如果你想要导入一辆车，你会希望车轮能够转向，并能够绕着中心点旋转。这对 .obj 文件来说是不可能的，因为 .obj 不包含场景图。更好的文件格式包含这些数据，如果你想要能够旋转的部件、滑动窗户、开门、移动角色的腿等，这会很有用。</p>\n</li>\n<li>\n<p>不支持动画或蒙皮</p>\n<p>相比于其它的，我们更想要蒙皮，但 .obj 并没有蒙皮或者动画相关内容。如果你不需要这些，可能没什么问题。但我更偏向一种能包含更多内容的格式。</p>\n</li>\n<li>\n<p>.obj 不支持更多现代的材质</p>\n<p>材质一般来说针对于特定的引擎，但至少对于一些基于物理的材质渲染各引擎是共通的，据我所知 .obj 文件并不支持。</p>\n</li>\n<li>\n<p>.obj 需要解析</p>\n<p>除非你在写一个通用的查看器让用户上传 .obj 文件，通常最佳的做法是使用一个不太需要解析的文件格式。.gltf 是一种为 WebGL 设计的文件格式。它使用 JSON，你可以轻松地加载。对于二进制数据，它使用能直接加载进 GPU 的格式，一般不需要将数字解析成数组。</p>\n<p>如果你想使用 .obj 文件，最佳实践是先将它转换成其它文件格式，然后在你的页面中使用。</p>\n</li>\n</ul>\n</li>\n</ul>\n<h1 id="webgl-加载带-mtl-的-obj"><a href="#webgl-%E5%8A%A0%E8%BD%BD%E5%B8%A6-mtl-%E7%9A%84-obj" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 加载带 Mtl 的 Obj</h1>\n<p>在上一节我们解析了 .obj 文件，在本节让我们解析它的补充文件：.mtl 材质文件。</p>\n<h2 id="椅子-1"><a href="#%E6%A4%85%E5%AD%90-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>椅子</h2>\n<blockquote>\n<p>该 .mtl 解析器不会面面俱到或者完美，也不保证能够处理所有 .mtl 文件。这只是一个练习。如果你使用该程序并遇到问题，下面的链接可能会对你有帮助。</p>\n</blockquote>\n<p>我们加载了我在 <a href="https://sketchfab.com/" target="_blank" rel="nofollow noreferrer noopener">Sketchfab</a> 上找到的，由 haytonm 创建的<a href="https://sketchfab.com/3d-models/chair-aa2acddb218646a59ece132bf95aa558" target="_blank" rel="nofollow noreferrer noopener">椅子</a>。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-06-28-14-35-39-9324f3fe917e357a9d20161d5f6aace9-2c25a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 55.86283185840708%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAACsUlEQVQozy2S224TVxSG/S6ovUCCyomKgDgBYjsnJxkGxyGOj8GO7bE98YzHnoPHHh9iCCJULaVS1RsQFyBxi7jmqpX6BBWPwFt8XeNw8WvvLf37W/9ae0fW1xMoispxNk/lpIpWb3LW7mB2ulhGD7vbv5LZk7OFeWagt3TxaQt//rjAwaMM25s7xFbWiBw9zlJ5corePMOSS67tMfRGBP6Y+WhC7vJ3ErMXuLKf+kNGno/veLg9m57RlXs6p5XaAqwqj4jUqnWMMxOn7zLyA2bBjPlkzkUwwf/lFVsfPrH07Fcezy54NgqYBmOmso4FPnQHuJZNV+5rtQbFfIlI2F4ICwR2LrCnk3PmU1mHQ9yXr0j98YZop8fWQEDegLEknPojpsPRAjryrqCm3qFRrREJZzWwB0ykxZmkmn1PENgOwflT1l685prhcHf+EicE2H182yZwvQU8kJSDfti+SbuhCVDiej13MZuwYmgaCswzTWzHJXn5muvOmJgAy5Uq+smJJLLwRL6A/L54rT5Wx6BVbxDRtRa9jimmPgMZtGfJyxoGrtGRmeRRzi958Pw39v98R+nLv1TF57SaC48jRR3ToCcv32m2qUvBSLV8siAbrTbddhtL1G1qWC2NciZN6q/3JD7/Teqfr+z/943j+QWtfBa9VsNsNjFEer1OQ2DlfEG+zUGGUi7PaalMQ9ppPgkV7otouSyt8Zzs24+ogwkrqT2Wl5aIr94lndqmeJjhtFikUihQODoio8q32U5uoO7ucaiq5A7SFCVV8fBKOVUReJWSFDW0NncEduPHH7gVvcn2+n0yeymyaZWM8hBlZ4fNeJzIcjTK6p3bxNdW2RLTbmKdveSVlGSch1sbxH6Okt7dIR5bYfNejFT8Pspmkv2NhIAfSOJVYrdvsfzTTf4HbwfozfGzl/sAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 06 28 14 35 39" title="" data-src="/static/2022-06-28-14-35-39-9324f3fe917e357a9d20161d5f6aace9-fee1c.png" data-srcset="/static/2022-06-28-14-35-39-9324f3fe917e357a9d20161d5f6aace9-a67b7.png 200w,\n/static/2022-06-28-14-35-39-9324f3fe917e357a9d20161d5f6aace9-0b187.png 400w,\n/static/2022-06-28-14-35-39-9324f3fe917e357a9d20161d5f6aace9-fee1c.png 800w,\n/static/2022-06-28-14-35-39-9324f3fe917e357a9d20161d5f6aace9-2c25a.png 904w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>它有一个相应的 .mtl 文件，看起来是这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19495760425770324000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# Blender MTL File: \'None\'\n# Material Count: 11\n\nnewmtl D1blinn1SG\nNs 323.999994\nKa 1.000000 1.000000 1.000000\nKd 0.500000 0.500000 0.500000\nKs 0.500000 0.500000 0.500000\nKe 0.0 0.0 0.0\nNi 1.000000\nd 1.000000\nillum 2\n\nnewmtl D1lambert2SG\nNs 323.999994\nKa 1.000000 1.000000 1.000000\nKd 0.020000 0.020000 0.020000\nKs 0.500000 0.500000 0.500000\nKe 0.0 0.0 0.0\nNi 1.000000\nd 1.000000\nillum 2\n\nnewmtl D1lambert3SG\nNs 323.999994\nKa 1.000000 1.000000 1.000000\nKd 1.000000 1.000000 1.000000\nKs 0.500000 0.500000 0.500000\nKe 0.0 0.0 0.0\nNi 1.000000\nd 1.000000\nillum 2\n\n# ... 更多类似的 8 个材质`, `19495760425770324000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="mtl"\n              >\n                <span class="gatsby-code-button-language">mtl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="mtl"><pre style="counter-reset: linenumber NaN" class="language-mtl line-numbers"><code class="language-mtl"># Blender MTL File: &#39;None&#39;\n# Material Count: 11\n\nnewmtl D1blinn1SG\nNs 323.999994\nKa 1.000000 1.000000 1.000000\nKd 0.500000 0.500000 0.500000\nKs 0.500000 0.500000 0.500000\nKe 0.0 0.0 0.0\nNi 1.000000\nd 1.000000\nillum 2\n\nnewmtl D1lambert2SG\nNs 323.999994\nKa 1.000000 1.000000 1.000000\nKd 0.020000 0.020000 0.020000\nKs 0.500000 0.500000 0.500000\nKe 0.0 0.0 0.0\nNi 1.000000\nd 1.000000\nillum 2\n\nnewmtl D1lambert3SG\nNs 323.999994\nKa 1.000000 1.000000 1.000000\nKd 1.000000 1.000000 1.000000\nKs 0.500000 0.500000 0.500000\nKe 0.0 0.0 0.0\nNi 1.000000\nd 1.000000\nillum 2\n\n# ... 更多类似的 8 个材质</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>查看对 <a href="http://paulbourke.net/dataformats/mtl/" target="_blank" rel="nofollow noreferrer noopener">.mtl 文件格式</a>的描述，我们可以看到以关键词 newmtl 和给定名字开头的新材质，下面是该材质的所有设置。每行都以关键词开始，这和 .obj 文件类似，所以我们可以用类似的方法来开始解析。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46843295052764480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseMTL(text) {\n  const materials = {};\n  let material;\n\n  const keywords = {\n    newmtl(parts, unparsedArgs) {\n      material = {};\n      materials[unparsedArgs] = material;\n    }\n  };\n\n  const keywordRE = /(\\w*)(?: )*(.*)/;\n  const lines = text.split(\'\\n\');\n  for (let lineNo = 0; lineNo < lines.length; ++lineNo) {\n    const line = lines[lineNo].trim();\n    if (line === \'\' || line.startsWith(\'#\')) {\n      continue;\n    }\n    const m = keywordRE.exec(line);\n    if (!m) {\n      continue;\n    }\n    const [, keyword, unparsedArgs] = m;\n    const parts = line.split(/\\s+/).slice(1);\n    const handler = keywords[keyword];\n    if (!handler) {\n      console.warn(\'unhandled keyword:\', keyword);\n      continue;\n    }\n    handler(parts, unparsedArgs);\n  }\n\n  return materials;\n}`, `46843295052764480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseMTL</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> materials <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> material<span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token function">newmtl</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n      materials<span class="token punctuation">[</span>unparsedArgs<span class="token punctuation">]</span> <span class="token operator">=</span> material<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> keywordRE <span class="token operator">=</span> <span class="token regex">/(\\w*)(?: )*(.*)/</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> lines <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'\\n\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> lineNo <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> lineNo <span class="token operator">&lt;</span> lines<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>lineNo<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> line <span class="token operator">=</span> lines<span class="token punctuation">[</span>lineNo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>line <span class="token operator">===</span> <span class="token string">\'\'</span> <span class="token operator">||</span> line<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">\'#\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">continue</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> m <span class="token operator">=</span> keywordRE<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">continue</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> keyword<span class="token punctuation">,</span> unparsedArgs<span class="token punctuation">]</span> <span class="token operator">=</span> m<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> parts <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex">/\\s+/</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> handler <span class="token operator">=</span> keywords<span class="token punctuation">[</span>keyword<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">\'unhandled keyword:\'</span><span class="token punctuation">,</span> keyword<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">continue</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token function">handler</span><span class="token punctuation">(</span>parts<span class="token punctuation">,</span> unparsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> materials<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接着，我们只需要为每个关键词添加对应的方法。文档指出：</p>\n<ul>\n<li>Ns 是关于点光源的文章中提到的镜面光泽设置</li>\n<li>Ka 是材质的环境光</li>\n<li>Kd 是散射光，这是在关于点光源的文章中的颜色</li>\n<li>Ks 是镜面光</li>\n<li>Ke 是放射光</li>\n<li>Ni 是光学密度。我们这里不使用</li>\n<li>d 代表“溶解”，代表透明度</li>\n<li>illum 指定了材质的光照模型。文档中列出了 11 种类型。我们先忽略它</li>\n</ul>\n<p>我在犹豫是否要保持这些名字的原样。我想一个数学人喜欢简短的名字。但是大多数代码风格指南都喜欢描述性的名字，所以我决定这么做。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84081668385900920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseMTL(text) {\n  const materials = {};\n  let material;\n\n  const keywords = {\n    newmtl(parts, unparsedArgs) {\n      material = {};\n      materials[unparsedArgs] = material;\n    },\n    Ns(parts) {\n      material.shininess = parseFloat(parts[0]);\n    },\n    Ka(parts) {\n      material.ambient = parts.map(parseFloat);\n    },\n    Kd(parts) {\n      material.diffuse = parts.map(parseFloat);\n    },\n    Ks(parts) {\n      material.specular = parts.map(parseFloat);\n    },\n    Ke(parts) {\n      material.emissive = parts.map(parseFloat);\n    },\n    Ni(parts) {\n      material.opticalDensity = parseFloat(parts[0]);\n    },\n    d(parts) {\n      material.opacity = parseFloat(parts[0]);\n    },\n    illum(parts) {\n      material.illum = parseInt(parts[0]);\n    }\n  };\n\n  //  ...\n\n  return materials;\n}`, `84081668385900920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{10-33}"\n              >\n                <span class="gatsby-code-button-language">js{10-33}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseMTL</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> materials <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> material<span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token function">newmtl</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n      materials<span class="token punctuation">[</span>unparsedArgs<span class="token punctuation">]</span> <span class="token operator">=</span> material<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">    <span class="token function">Ns</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>shininess <span class="token operator">=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">Ka</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>ambient <span class="token operator">=</span> parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">Kd</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>diffuse <span class="token operator">=</span> parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">Ks</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>specular <span class="token operator">=</span> parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">Ke</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>emissive <span class="token operator">=</span> parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">Ni</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>opticalDensity <span class="token operator">=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">d</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>opacity <span class="token operator">=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">illum</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>illum <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">//  ...</span>\n\n  <span class="token keyword">return</span> materials<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我也在犹豫要不要推测每个 .mtl 文件的路径，或者手动指定。我们可以这样做：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98138148868960010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 伪代码 - 手动指定 .obj 文件和 .mtl 文件的路径\nconst obj = downloadAndParseObj(pathToOBJFile);\nconst materials = downloadAndParseMtl(pathToMTLFile);`, `98138148868960010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 伪代码 - 手动指定 .obj 文件和 .mtl 文件的路径</span>\n<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">downloadAndParseObj</span><span class="token punctuation">(</span>pathToOBJFile<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> materials <span class="token operator">=</span> <span class="token function">downloadAndParseMtl</span><span class="token punctuation">(</span>pathToMTLFile<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>或者这样:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35538390026244770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 伪代码 - 根据 .obj 文件推测 .mtl 文件的的路径\nconst obj = downloadAndParseObj(pathToOBJFile);\nconst materials = downloadAndParseMtl(pathToOBJFile, obj);`, `35538390026244770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 伪代码 - 根据 .obj 文件推测 .mtl 文件的的路径</span>\n<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">downloadAndParseObj</span><span class="token punctuation">(</span>pathToOBJFile<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> materials <span class="token operator">=</span> <span class="token function">downloadAndParseMtl</span><span class="token punctuation">(</span>pathToOBJFile<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>我选择后者，但是我也不确定是好是坏。根据文档一个 .obj 文件可以包含多个 .mtl 文件的引用。我从没见过这样的例子，但我想文档的作者是这么做的。</p>\n<p>并且我也没有见过 .mtl 文件与 .obj 文件命名不同的。换句话说，如果 .obj 文件是 bananas.obj，那么 .mtl 文件几乎总是 bananas.mtl。</p>\n<p>也就是说，规范指出 .mtl 文件是在 .obj 文件中指定的，所以我决定试着计算 .mtl 文件的路径。</p>\n<p>从上节的代码开始, 我们将 .obj 文件的 URL 提取出来，然后构建 .obj 相关的 .mtl 文件的 URL。最后我们将它们全部加载，连接起来（因为它们都是文本文件），然后传给解析器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54109208627903290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// const response = await fetch(\'resources/models/chair/chair.obj\');\nconst objHref = \'resources/models/chair/chair.obj\';\nconst response = await fetch(objHref);\nconst text = await response.text();\nconst obj = parseOBJ(text);\nconst baseHref = new URL(objHref, window.location.href);\nconst matTexts = await Promise.all(\n  obj.materialLibs.map(async (filename) => {\n    const matHref = new URL(filename, baseHref).href;\n    const response = await fetch(matHref);\n    return await response.text();\n  })\n);\nconst materials = parseMTL(matTexts.join(\'\\n\'));`, `54109208627903290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1-3,6-14}"\n              >\n                <span class="gatsby-code-button-language">js{1-3,6-14}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token comment">// const response = await fetch(\'resources/models/chair/chair.obj\');</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> objHref <span class="token operator">=</span> <span class="token string">\'resources/models/chair/chair.obj\'</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>objHref<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token keyword">const</span> text <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> baseHref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>objHref<span class="token punctuation">,</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> matTexts <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">  obj<span class="token punctuation">.</span>materialLibs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">const</span> matHref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> baseHref<span class="token punctuation">)</span><span class="token punctuation">.</span>href<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>matHref<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">return</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> materials <span class="token operator">=</span> <span class="token function">parseMTL</span><span class="token punctuation">(</span>matTexts<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'\\n\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，我们来使用材质。首先，当我们在设置每个部分的时候，我们需要使用从 .obj 文件中提取出来的材质名称，然后从刚才加载的材质中查找。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5346645263144789000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// const parts = obj.geometries.map(({data}) => {\nconst parts = obj.geometries.map(({ material, data }) => {\n  // ...\n\n  // create a buffer for each array by calling\n  // gl.createBuffer, gl.bindBuffer, gl.bufferData\n  const bufferInfo = webglUtils.createBufferInfoFromArrays(gl, data);\n  return {\n    //  material: {\n    //    u_diffuse: [1, 1, 1, 1],\n    //  },\n    material: materials[material],\n    bufferInfo\n  };\n});`, `5346645263144789000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1-2,9-12}"\n              >\n                <span class="gatsby-code-button-language">js{1-2,9-12}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token comment">// const parts = obj.geometries.map(({data}) => {</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> parts <span class="token operator">=</span> obj<span class="token punctuation">.</span>geometries<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> material<span class="token punctuation">,</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>  <span class="token comment">// ...</span>\n\n  <span class="token comment">// create a buffer for each array by calling</span>\n  <span class="token comment">// gl.createBuffer, gl.bindBuffer, gl.bufferData</span>\n  <span class="token keyword">const</span> bufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">    <span class="token comment">//  material: {</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//    u_diffuse: [1, 1, 1, 1],</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//  },</span></span><span class="gatsby-highlight-code-line">    material<span class="token punctuation">:</span> materials<span class="token punctuation">[</span>material<span class="token punctuation">]</span><span class="token punctuation">,</span></span>    bufferInfo\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当我们在渲染时，我们需要传不止一组全局变量值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97560076519730710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function render(time) {\n  // ...\n\n  for (const { bufferInfo, material } of parts) {\n    // calls gl.bindBuffer, gl.enableVertexAttribArray, gl.vertexAttribPointer\n    webglUtils.setBuffersAndAttributes(gl, meshProgramInfo, bufferInfo);\n    // calls gl.uniform\n    webglUtils.setUniforms(\n      meshProgramInfo,\n      {\n        u_world\n        // u_diffuse: material.u_diffuse,\n        //  });\n      },\n      material\n    );\n    // calls gl.drawArrays or gl.drawElements\n    webglUtils.drawBufferInfo(gl, bufferInfo);\n  }\n\n  requestAnimationFrame(render);\n}`, `97560076519730710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{12-16}"\n              >\n                <span class="gatsby-code-button-language">js{12-16}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">{</span> bufferInfo<span class="token punctuation">,</span> material <span class="token punctuation">}</span> <span class="token keyword">of</span> parts<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// calls gl.bindBuffer, gl.enableVertexAttribArray, gl.vertexAttribPointer</span>\n    webglUtils<span class="token punctuation">.</span><span class="token function">setBuffersAndAttributes</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> meshProgramInfo<span class="token punctuation">,</span> bufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// calls gl.uniform</span>\n    webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>\n      meshProgramInfo<span class="token punctuation">,</span>\n      <span class="token punctuation">{</span>\n        u_world\n<span class="gatsby-highlight-code-line">        <span class="token comment">// u_diffuse: material.u_diffuse,</span></span><span class="gatsby-highlight-code-line">        <span class="token comment">//  });</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      material</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>    <span class="token comment">// calls gl.drawArrays or gl.drawElements</span>\n    webglUtils<span class="token punctuation">.</span><span class="token function">drawBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> bufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后我们需要修改着色器。因为材质有镜面设置，我们添加像关于点光源的文章中一样的镜面计算，除了一点不同，我们计算镜面光是根据方向光源，而不是点光源。</p>\n<p>ambient 和 emissive 可能需要解释一下。ambient 是材质在无方向光源下的反射颜色。如果我们想看到它，我们可以乘上 <code class="language-text">u_ambientLight</code> 并设置黑色以外的颜色。这像把东西冲洗干净。</p>\n<p>emissive 是材质自身发光的颜色，与所有光照无关，所以我们只要加上它就好。如果你想有块地方发光，你可能会用到 emissive。</p>\n<p>这是新的着色器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28151770242629850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const vs = \\`\n   attribute vec4 a_position;\n   attribute vec3 a_normal;\n   attribute vec4 a_color;\n   \n   uniform mat4 u_projection;\n   uniform mat4 u_view;\n   uniform mat4 u_world;\n   uniform vec3 u_viewWorldPosition;\n   \n   varying vec3 v_normal;\n   varying vec3 v_surfaceToView;\n   varying vec4 v_color;\n   \n   void main() {\n      // gl_Position = u_projection * u_view * a_position;\n      vec4 worldPostion = u_world * a_position;\n      gl_Position = u_projection * u_view * worldPosition;\n      v_surfaceToView = u_viewWorldPosition - worldPosition.xyz;\n      v_normal = mat3(u_world) * a_normal;\n      v_color = a_color;\n   }\n\\`;\n\nconst fs = \\`\n   precision highp float;\n   \n   varying vec3 v_normal;\n   varying vec3 v_surfaceToView;\n   varying vec4 v_color;\n   \n   // uniform vec4 u_diffuse;\n   uniform vec3 diffuse;\n   uniform vec3 ambient;\n   uniform vec3 emissive;\n   uniform vec3 specular;\n   uniform float shininess;\n   uniform float opacity;\n   uniform vec3 u_lightDirection;\n   uniform vec3 u_ambientLight;\n   \n   void main () {\n      vec3 normal = normalize(v_normal);\n      \n      vec3 surfaceToViewDirection = normalize(v_surfaceToView);\n      vec3 halfVector = normalize(u_lightDirection + surfaceToViewDirection);\n      \n      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;\n      float specularLight = clamp(dot(normal, halfVector), 0.0, 1.0);\n      \n      // vec4 diffuse = u_diffuse * v_color;\n      vec3 effectiveDiffuse = diffuse * v_color.rgb;\n      float effectiveOpacity = opacity * v_color.a;\n      \n      // gl_FragColor = vec4(diffuse.rgb * fakeLight, diffuse.a);\n      gl_FragColor = vec4(\n            emissive +\n            ambient * u_ambientLight +\n            effectiveDiffuse * fakeLight +\n            specular * pow(specularLight, shininess),\n            effectiveOpacity);\n   }\n\\`;`, `28151770242629850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{9,12,16-19,29,32-38,40,45-46,49,51-53,55-61}"\n              >\n                <span class="gatsby-code-button-language">js{9,12,16-19,29,32-38,40,45-46,49,51-53,55-61}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> vs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   attribute vec4 a_position;</span>\n<span class="token string">   attribute vec3 a_normal;</span>\n<span class="token string">   attribute vec4 a_color;</span>\n<span class="token string">   </span>\n<span class="token string">   uniform mat4 u_projection;</span>\n<span class="token string">   uniform mat4 u_view;</span>\n<span class="token string">   uniform mat4 u_world;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   uniform vec3 u_viewWorldPosition;</span></span><span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   varying vec3 v_surfaceToView;</span></span><span class="token string">   varying vec4 v_color;</span>\n<span class="token string">   </span>\n<span class="token string">   void main() {</span>\n<span class="gatsby-highlight-code-line"><span class="token string">      // gl_Position = u_projection * u_view * a_position;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      vec4 worldPostion = u_world * a_position;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      gl_Position = u_projection * u_view * worldPosition;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      v_surfaceToView = u_viewWorldPosition - worldPosition.xyz;</span></span><span class="token string">      v_normal = mat3(u_world) * a_normal;</span>\n<span class="token string">      v_color = a_color;</span>\n<span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   precision highp float;</span>\n<span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   varying vec3 v_surfaceToView;</span></span><span class="token string">   varying vec4 v_color;</span>\n<span class="token string">   </span>\n<span class="gatsby-highlight-code-line"><span class="token string">   // uniform vec4 u_diffuse;</span></span><span class="gatsby-highlight-code-line"><span class="token string">   uniform vec3 diffuse;</span></span><span class="gatsby-highlight-code-line"><span class="token string">   uniform vec3 ambient;</span></span><span class="gatsby-highlight-code-line"><span class="token string">   uniform vec3 emissive;</span></span><span class="gatsby-highlight-code-line"><span class="token string">   uniform vec3 specular;</span></span><span class="gatsby-highlight-code-line"><span class="token string">   uniform float shininess;</span></span><span class="gatsby-highlight-code-line"><span class="token string">   uniform float opacity;</span></span><span class="token string">   uniform vec3 u_lightDirection;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   uniform vec3 u_ambientLight;</span></span><span class="token string">   </span>\n<span class="token string">   void main () {</span>\n<span class="token string">      vec3 normal = normalize(v_normal);</span>\n<span class="token string">      </span>\n<span class="gatsby-highlight-code-line"><span class="token string">      vec3 surfaceToViewDirection = normalize(v_surfaceToView);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      vec3 halfVector = normalize(u_lightDirection + surfaceToViewDirection);</span></span><span class="token string">      </span>\n<span class="token string">      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">      float specularLight = clamp(dot(normal, halfVector), 0.0, 1.0);</span></span><span class="token string">      </span>\n<span class="gatsby-highlight-code-line"><span class="token string">      // vec4 diffuse = u_diffuse * v_color;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      vec3 effectiveDiffuse = diffuse * v_color.rgb;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      float effectiveOpacity = opacity * v_color.a;</span></span><span class="token string">      </span>\n<span class="gatsby-highlight-code-line"><span class="token string">      // gl_FragColor = vec4(diffuse.rgb * fakeLight, diffuse.a);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      gl_FragColor = vec4(</span></span><span class="gatsby-highlight-code-line"><span class="token string">            emissive +</span></span><span class="gatsby-highlight-code-line"><span class="token string">            ambient * u_ambientLight +</span></span><span class="gatsby-highlight-code-line"><span class="token string">            effectiveDiffuse * fakeLight +</span></span><span class="gatsby-highlight-code-line"><span class="token string">            specular * pow(specularLight, shininess),</span></span><span class="gatsby-highlight-code-line"><span class="token string">            effectiveOpacity);</span></span><span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样，我们得到了和上面图片看起来差不多的效果。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/e8w4o8?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="风车"><a href="#%E9%A3%8E%E8%BD%A6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>风车</h2>\n<p>让我们来加载 .mtl 文件中引用纹理的 .obj 文件。</p>\n<p>我发现了由 <a href="https://www.blendswap.com/user/ahedov" target="_blank" rel="nofollow noreferrer noopener">ahedov</a> 创建的<a href="https://blendswap.com/blend/9755" target="_blank" rel="nofollow noreferrer noopener">风车</a> 3D 模型。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-06-30-11-25-00-fc00ae82f04d4b160e38db261867b4e6-124ef.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 440px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAAB/klEQVQ4y41Uy5LSQBTll9y48FE15chYw8tBCA6BGQKBEEKSSSAh9AuSTneD47jQhZaWCy1/1PZRlpKA3EUvuuvcc+4993YhPRhciCSJEYhSxrKvhf1AyjhHy4Vx2ZhoVzKLvDkaTCnnHESLkVJzh5pMdDzzD5FCHowBx4TelFLKMspzwUyw5E6gzXpGljfIt5A7kcwYQc+2pH6ZaB+YURqn2EuhgwPTHnfUZtnovmRiYw/7rn7NuNjPzBiNMfCNyDOWvhG4w3ajrLUVHIVO75KEs7/bniNb1oaCiWeqM7vvW72LcrHZqAeOlWC4Y1hezYynyGZwFANzbqu1Zw8r52cQQpFxq5ClXceJbQ1goFcrp4Za01sXvmOjcJ51K4c5oalpaNNBs/L0xOkp4bQPotDUur/8+w9YGvFmi1eeZrWb2NXfvkYEo0GrTiDYIc+RLWu+sUfEv8aW/u3D9vN7QTD2+p0VjA6BJZIQAgBo1Ktap6Yqja+fNl8+bghCcO5xvl+2nBvZzzAMKufFsyePS8VHvSvl3R16xReEoD9TdbjmpFo6fXD/3ot6aeaPMfZvb2Mh8hdgFyyluVP9ebXY7SoAeIKjlJF1HOetc7ZhKUVLr99Tmy1lbJmzMFjiNRfb7DLvsSrBCVkAhNE6WSU/By49Tvbv+WTyJ8hV+k98B4aURrgdGswMAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 06 30 11 25 00" title="" data-src="/static/2022-06-30-11-25-00-fc00ae82f04d4b160e38db261867b4e6-124ef.png" data-srcset="/static/2022-06-30-11-25-00-fc00ae82f04d4b160e38db261867b4e6-add0a.png 200w,\n/static/2022-06-30-11-25-00-fc00ae82f04d4b160e38db261867b4e6-7a35e.png 400w,\n/static/2022-06-30-11-25-00-fc00ae82f04d4b160e38db261867b4e6-124ef.png 440w" data-sizes="(max-width: 440px) 100vw, 440px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>它的 .mtl 文件看起来是这样的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35998314063720403000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# Blender MTL File: \'windmill_001.blend\'\n# Material Count: 2\n\nnewmtl Material\nNs 0.000000\nKa 1.000000 1.000000 1.000000\nKd 0.800000 0.800000 0.800000\nKs 0.000000 0.000000 0.000000\nKe 0.000000 0.000000 0.000000\nNi 1.000000\nd 1.000000\nillum 1\nmap_Kd windmill_001_lopatky_COL.jpg\nmap_Bump windmill_001_lopatky_NOR.jpg\n\nnewmtl windmill\nNs 0.000000\nKa 1.000000 1.000000 1.000000\nKd 0.800000 0.800000 0.800000\nKs 0.000000 0.000000 0.000000\nKe 0.000000 0.000000 0.000000\nNi 1.000000\nd 1.000000\nillum 1\nmap_Kd windmill_001_base_COL.jpg\nmap_Bump windmill_001_base_NOR.jpg\nmap_Ns windmill_001_base_SPEC.jpg`, `35998314063720403000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="mtl"\n              >\n                <span class="gatsby-code-button-language">mtl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="mtl"><pre style="counter-reset: linenumber NaN" class="language-mtl line-numbers"><code class="language-mtl"># Blender MTL File: &#39;windmill_001.blend&#39;\n# Material Count: 2\n\nnewmtl Material\nNs 0.000000\nKa 1.000000 1.000000 1.000000\nKd 0.800000 0.800000 0.800000\nKs 0.000000 0.000000 0.000000\nKe 0.000000 0.000000 0.000000\nNi 1.000000\nd 1.000000\nillum 1\nmap_Kd windmill_001_lopatky_COL.jpg\nmap_Bump windmill_001_lopatky_NOR.jpg\n\nnewmtl windmill\nNs 0.000000\nKa 1.000000 1.000000 1.000000\nKd 0.800000 0.800000 0.800000\nKs 0.000000 0.000000 0.000000\nKe 0.000000 0.000000 0.000000\nNi 1.000000\nd 1.000000\nillum 1\nmap_Kd windmill_001_base_COL.jpg\nmap_Bump windmill_001_base_NOR.jpg\nmap_Ns windmill_001_base_SPEC.jpg</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以看到 <code class="language-text">map_Kd</code>，<code class="language-text">map_Bump</code> 和 <code class="language-text">map_Ns</code> 都指定了图片文件。让我们把它们加入到我们的 <code class="language-text">.mtl</code> 解析器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26972427527155716000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseMapArgs(unparsedArgs) {\n  // 处理可选项\n  return unparsedArgs;\n}\n\nfunction parseMTL(text) {\n  const materials = {};\n  let material;\n\n  const keywords = {\n    newmtl(parts, unparsedArgs) {\n      material = {};\n      materials[unparsedArgs] = material;\n    },\n    Ns(parts) {\n      material.shininess = parseFloat(parts[0]);\n    },\n    Ka(parts) {\n      material.ambient = parts.map(parseFloat);\n    },\n    Kd(parts) {\n      material.diffuse = parts.map(parseFloat);\n    },\n    Ks(parts) {\n      material.specular = parts.map(parseFloat);\n    },\n    Ke(parts) {\n      material.emissive = parts.map(parseFloat);\n    },\n    map_Kd(parts, unparsedArgs) {\n      material.diffuseMap = parseMapArgs(unparsedArgs);\n    },\n    map_Ns(parts, unparsedArgs) {\n      material.specularMap = parseMapArgs(unparsedArgs);\n    },\n    map_Bump(parts, unparsedArgs) {\n      material.normalMap = parseMapArgs(unparsedArgs);\n    },\n    Ni(parts) {\n      material.opticalDensity = parseFloat(parts[0]);\n    },\n    d(parts) {\n      material.opacity = parseFloat(parts[0]);\n    },\n    illum(parts) {\n      material.illum = parseInt(parts[0]);\n    }\n  };\n\n  // ...\n}`, `26972427527155716000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{30-38}"\n              >\n                <span class="gatsby-code-button-language">js{30-38}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseMapArgs</span><span class="token punctuation">(</span><span class="token parameter">unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 处理可选项</span>\n  <span class="token keyword">return</span> unparsedArgs<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">parseMTL</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> materials <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> material<span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token function">newmtl</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n      materials<span class="token punctuation">[</span>unparsedArgs<span class="token punctuation">]</span> <span class="token operator">=</span> material<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">Ns</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material<span class="token punctuation">.</span>shininess <span class="token operator">=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">Ka</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material<span class="token punctuation">.</span>ambient <span class="token operator">=</span> parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">Kd</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material<span class="token punctuation">.</span>diffuse <span class="token operator">=</span> parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">Ks</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material<span class="token punctuation">.</span>specular <span class="token operator">=</span> parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">Ke</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material<span class="token punctuation">.</span>emissive <span class="token operator">=</span> parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">    <span class="token function">map_Kd</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>diffuseMap <span class="token operator">=</span> <span class="token function">parseMapArgs</span><span class="token punctuation">(</span>unparsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">map_Ns</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>specularMap <span class="token operator">=</span> <span class="token function">parseMapArgs</span><span class="token punctuation">(</span>unparsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">map_Bump</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>normalMap <span class="token operator">=</span> <span class="token function">parseMapArgs</span><span class="token punctuation">(</span>unparsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>    <span class="token function">Ni</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material<span class="token punctuation">.</span>opticalDensity <span class="token operator">=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">d</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material<span class="token punctuation">.</span>opacity <span class="token operator">=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">illum</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material<span class="token punctuation">.</span>illum <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意：我写了 parseMapArgs，因为根据这份<a href="http://paulbourke.net/dataformats/mtl" target="_blank" rel="nofollow noreferrer noopener">规范</a>，还有很多额外的可选项我们没有在这个文件中看到。我们需要重构代码才能使用它们。但现在我们只处理带空格的文件名，不处理可选项。</p>\n<p>为了加载所有的纹理，我们会使用来自关于纹理的文章的代码，稍作修改。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64334044944114700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function create1PixelTexture(gl, pixel) {\n  const texture = gl.createTexture();\n  gl.bindTexture(gl.TEXTURE_2D, texture);\n  gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE, new Uint8Array(pixel));\n  return texture;\n}\n\nfunction createTexture(gl, url) {\n  const texture = create1PixelTexture(gl, [128, 192, 255, 255]);\n  // 异步加载图片\n  const image = new Image();\n  image.src = url;\n  image.addEventListener(\'load\', function () {\n    // 图片加载完成后复制到纹理\n    gl.bindTexture(gl.TEXTURE_2D, texture);\n    gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);\n    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);\n\n    // 检查图片在每个维度都为 2 的幂\n    if (isPowerOf2(image.width) && isPowerOf2(image.height)) {\n      // Yes, it\'s a power of 2. Generate mips.\n      gl.generateMipmap(gl.TEXTURE_2D);\n    } else {\n      // No, it\'s not a power of 2. Turn of mips and set wrapping to clamp to edge\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n    }\n  });\n  return texture;\n}`, `64334044944114700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">create1PixelTexture</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span> pixel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>pixel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> texture<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span> url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> texture <span class="token operator">=</span> <span class="token function">create1PixelTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 异步加载图片</span>\n  <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  image<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span>\n  image<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'load\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 图片加载完成后复制到纹理</span>\n    gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    gl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_FLIP_Y_WEBGL</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 检查图片在每个维度都为 2 的幂</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPowerOf2</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span>width<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isPowerOf2</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// Yes, it\'s a power of 2. Generate mips.</span>\n      gl<span class="token punctuation">.</span><span class="token function">generateMipmap</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// No, it\'s not a power of 2. Turn of mips and set wrapping to clamp to edge</span>\n      gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> texture<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>两个材质可能引用同一张图片，所以我们将所有的纹理根据名字保存在对象中，这样就不用加载两次了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40086210124241895000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const textures = {};\n\n// 为材质加载纹理\nfor (const material of Object.values(materials)) {\n  Object.entries(material)\n    .filter(([key]) => key.endsWith(\'Map\'))\n    .forEach(([key, filename]) => {\n      let texture = textures[filename];\n      if (!texture) {\n        const textureHref = new URL(filename, baseHref).href;\n        texture = createTexture(gl, textureHref);\n        textures[filename] = texture;\n      }\n      material[key] = texture;\n    });\n}`, `40086210124241895000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> textures <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 为材质加载纹理</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> material <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>materials<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>material<span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>key<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> key<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">\'Map\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>key<span class="token punctuation">,</span> filename<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> texture <span class="token operator">=</span> textures<span class="token punctuation">[</span>filename<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>texture<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> textureHref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> baseHref<span class="token punctuation">)</span><span class="token punctuation">.</span>href<span class="token punctuation">;</span>\n        texture <span class="token operator">=</span> <span class="token function">createTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> textureHref<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        textures<span class="token punctuation">[</span>filename<span class="token punctuation">]</span> <span class="token operator">=</span> texture<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      material<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> texture<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的代码遍历了每个材质的每个属性。如果属性以 “Map” 结尾，就创建相对 URL，创建纹理，然后分配材质，我们将异步加载图片到纹理中。</p>\n<p>我们也会放一个单独的白像素纹理，给那些没有引用纹理的材质。这样我们就可以使用同一个着色器了。否则，我们需要不同的着色器，一个处理带纹理的材质，一个处理不带纹理的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10563902593493470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// const textures = {};\nconst textures = {\n  defaultWhite: create1PixelTexture(gl, [255, 255, 255, 255])\n};`, `10563902593493470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// const textures = {};</span>\n<span class="token keyword">const</span> textures <span class="token operator">=</span> <span class="token punctuation">{</span>\n  defaultWhite<span class="token punctuation">:</span> <span class="token function">create1PixelTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们也给材质的其它参数设置默认值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55747084975615975000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const defaultMaterial = {\n  diffuse: [1, 1, 1],\n  diffuseMap: textures.defaultWhite,\n  ambient: [0, 0, 0],\n  specular: [1, 1, 1],\n  shininess: 400,\n  opacity: 1\n};\n\nconst parts = obj.geometries.map(({ material, data }) => {\n  // ...\n\n  // create a buffer for each array by calling\n  // gl.createBuffer, gl.bindBuffer, gl.bufferData\n  const bufferInfo = webglUtils.createBufferInfoFromArrays(gl, data);\n  return {\n    // material: materials[material],\n    material: {\n      ...defaultMaterial,\n      ...materials[material]\n    },\n    bufferInfo\n  };\n});`, `55747084975615975000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1-8,17-21}"\n              >\n                <span class="gatsby-code-button-language">js{1-8,17-21}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> defaultMaterial <span class="token operator">=</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  diffuse<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  diffuseMap<span class="token punctuation">:</span> textures<span class="token punctuation">.</span>defaultWhite<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  ambient<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  specular<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  shininess<span class="token punctuation">:</span> <span class="token number">400</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  opacity<span class="token punctuation">:</span> <span class="token number">1</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>\n<span class="token keyword">const</span> parts <span class="token operator">=</span> obj<span class="token punctuation">.</span>geometries<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> material<span class="token punctuation">,</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// create a buffer for each array by calling</span>\n  <span class="token comment">// gl.createBuffer, gl.bindBuffer, gl.bufferData</span>\n  <span class="token keyword">const</span> bufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">    <span class="token comment">// material: materials[material],</span></span><span class="gatsby-highlight-code-line">    material<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      <span class="token operator">...</span>defaultMaterial<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token operator">...</span>materials<span class="token punctuation">[</span>material<span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>    bufferInfo\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要使用纹理，我们要修改着色器。我们一个一个来处理。我们先来使用漫反射贴图。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86401556296351020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const vs = \\`\n   attribute vec4 a_position;\n   attribute vec3 a_normal;\n   attribute vec2 a_texcoord;\n   attribute vec4 a_color;\n   \n   uniform mat4 u_projection;\n   uniform mat4 u_view;\n   uniform mat4 u_world;\n   uniform vec3 u_viewWorldPosition;\n   \n   varying vec3 v_normal;\n   varying vec3 v_surfaceToView;\n   varying vec2 v_texcoord;\n   varying vec4 v_color;\n   \n   void main() {\n      vec4 worldPosition = u_world * a_position;\n      gl_Position = u_projection * u_view * worldPosition;\n      v_surfaceToView = u_viewWorldPosition - worldPosition.xyz;\n      v_normal = mat3(u_world) * a_normal;\n      v_texcoord = a_texcoord;\n      v_color = a_color;\n   }\n\\`;\n\nconst fs = \\`\n   # version 300 es\n   precision highp float;\n   \n   varying vec3 v_normal;\n   varying vec3 v_surfaceToView;\n   varying vec2 v_texcoord;\n   varying vec4 v_color;\n   \n   uniform vec3 diffuse;\n   uniform sampler2D diffuseMap;\n   uniform vec3 ambient;\n   uniform vec3 emissive;\n   uniform vec3 specular;\n   uniform float shininess;\n   uniform float opacity;\n   uniform vec3 u_lightDirection;\n   uniform vec3 u_ambientLight;\n   \n   void main () {\n      vec3 normal = normalize(v_normal);\n      \n      vec3 surfaceToViewDirection = normalize(v_surfaceToView);\n      vec3 halfVector = normalize(u_lightDirection + surfaceToViewDirection);\n      \n      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;\n      float specularLight = clamp(dot(normal, halfVector), 0.0, 1.0);\n      \n      // vec3 effectiveDiffuse = diffuse.rgb * v_color.rgb;\n      // float effectiveOpacity = v_color.a * opacity;\n      vec4 diffuseMapColor = texture2D(diffuseMap, v_texcoord);\n      vec3 effectiveDiffuse = diffuse * diffuseMapColor.rgb * v_color.rgb;\n      float effectiveOpacity = opacity * diffuseMapColor.a * v_color.a;\n      \n      gl_FragColor = vec4(\n         emissive +\n         ambient * u_ambientLight +\n         effectiveDiffuse * fakeLight +\n         specular * pow(specularLight, shininess),\n         effectiveOpacity\n      );\n   }\n\\`;`, `86401556296351020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4,14,22,33,37,55-59}"\n              >\n                <span class="gatsby-code-button-language">js{4,14,22,33,37,55-59}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> vs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   attribute vec4 a_position;</span>\n<span class="token string">   attribute vec3 a_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   attribute vec2 a_texcoord;</span></span><span class="token string">   attribute vec4 a_color;</span>\n<span class="token string">   </span>\n<span class="token string">   uniform mat4 u_projection;</span>\n<span class="token string">   uniform mat4 u_view;</span>\n<span class="token string">   uniform mat4 u_world;</span>\n<span class="token string">   uniform vec3 u_viewWorldPosition;</span>\n<span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="token string">   varying vec3 v_surfaceToView;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   varying vec2 v_texcoord;</span></span><span class="token string">   varying vec4 v_color;</span>\n<span class="token string">   </span>\n<span class="token string">   void main() {</span>\n<span class="token string">      vec4 worldPosition = u_world * a_position;</span>\n<span class="token string">      gl_Position = u_projection * u_view * worldPosition;</span>\n<span class="token string">      v_surfaceToView = u_viewWorldPosition - worldPosition.xyz;</span>\n<span class="token string">      v_normal = mat3(u_world) * a_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">      v_texcoord = a_texcoord;</span></span><span class="token string">      v_color = a_color;</span>\n<span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   # version 300 es</span>\n<span class="token string">   precision highp float;</span>\n<span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="token string">   varying vec3 v_surfaceToView;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   varying vec2 v_texcoord;</span></span><span class="token string">   varying vec4 v_color;</span>\n<span class="token string">   </span>\n<span class="token string">   uniform vec3 diffuse;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   uniform sampler2D diffuseMap;</span></span><span class="token string">   uniform vec3 ambient;</span>\n<span class="token string">   uniform vec3 emissive;</span>\n<span class="token string">   uniform vec3 specular;</span>\n<span class="token string">   uniform float shininess;</span>\n<span class="token string">   uniform float opacity;</span>\n<span class="token string">   uniform vec3 u_lightDirection;</span>\n<span class="token string">   uniform vec3 u_ambientLight;</span>\n<span class="token string">   </span>\n<span class="token string">   void main () {</span>\n<span class="token string">      vec3 normal = normalize(v_normal);</span>\n<span class="token string">      </span>\n<span class="token string">      vec3 surfaceToViewDirection = normalize(v_surfaceToView);</span>\n<span class="token string">      vec3 halfVector = normalize(u_lightDirection + surfaceToViewDirection);</span>\n<span class="token string">      </span>\n<span class="token string">      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;</span>\n<span class="token string">      float specularLight = clamp(dot(normal, halfVector), 0.0, 1.0);</span>\n<span class="token string">      </span>\n<span class="gatsby-highlight-code-line"><span class="token string">      // vec3 effectiveDiffuse = diffuse.rgb * v_color.rgb;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      // float effectiveOpacity = v_color.a * opacity;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      vec4 diffuseMapColor = texture2D(diffuseMap, v_texcoord);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      vec3 effectiveDiffuse = diffuse * diffuseMapColor.rgb * v_color.rgb;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      float effectiveOpacity = opacity * diffuseMapColor.a * v_color.a;</span></span><span class="token string">      </span>\n<span class="token string">      gl_FragColor = vec4(</span>\n<span class="token string">         emissive +</span>\n<span class="token string">         ambient * u_ambientLight +</span>\n<span class="token string">         effectiveDiffuse * fakeLight +</span>\n<span class="token string">         specular * pow(specularLight, shininess),</span>\n<span class="token string">         effectiveOpacity</span>\n<span class="token string">      );</span>\n<span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/0227gc?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>回头看 .mtl 文件，我们看到 <code class="language-text">map_Ks</code> 基本是黑白的纹理，它指定了特定表面的光泽度，或者也可以说是多少镜面反射的效果。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-04-17-41-33-d476971e528d932c5e2c41676aa99dda-9cb4a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 510px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100.19607843137254%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAABMElEQVQ4y51UOY6EQAzkvna5xJUgkZFAgkiQCPn/n6YaN5bVo4HZrQCZxuXy1VhN08Rx/CPwe+LdplfpaSVJYv0bTLZtG0/E7rrOvvCJ5TiO+mqQsywbhuEbVeWvUr+YLGVovqeA7CCuya7rUp7OBabB9jwPDjLQPM9osyJzhe4JXY8g07nMblmWfd+1MjyCIPB93zvBfsSUfPo0TdO2bbphnJVRqqFJ4WCv63och1KWBUPcKJjJzIfRtu04jmqwpEBdQfJMJkO2wAQpg/mn1dIppGlKsWlCwQk++aSpyTQq8pONoVoelFHzzQI/lENzpm7xbsmFeb5VYRjySHkrMLavriSTZQgc3txKhTzPoyii3SQ1vBIZhw/kqqrwJyqKgoZUlmXf9+gigtZ1fdNw4AX2BRFN5YBDrgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 04 17 41 33" title="" data-src="/static/2022-07-04-17-41-33-d476971e528d932c5e2c41676aa99dda-9cb4a.png" data-srcset="/static/2022-07-04-17-41-33-d476971e528d932c5e2c41676aa99dda-931d4.png 200w,\n/static/2022-07-04-17-41-33-d476971e528d932c5e2c41676aa99dda-3a665.png 400w,\n/static/2022-07-04-17-41-33-d476971e528d932c5e2c41676aa99dda-9cb4a.png 510w" data-sizes="(max-width: 510px) 100vw, 510px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>为了使用它，只需要更新着色器，因为我们已经加载了全部的纹理。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94852836925661660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const fs = \\`\n   precision highp float;\n   \n   varying vec3 v_normal;\n   varying vec3 v_surfaceToView;\n   varying vec2 v_texcoord;\n   varying vec4 v_color;\n   \n   uniform vec3 diffuse;\n   uniform sampler2D diffuseMap;\n   uniform vec3 ambient;\n   uniform vec3 emissive;\n   uniform vec3 specular;\n   uniform sampler2D specularMap;\n   uniform float shininess;\n   uniform float opacity;\n   uniform vec3 u_lightDirection;\n   uniform vec3 u_ambientLight;\n   \n   void main () {\n      vec3 normal = normalize(v_normal);\n      \n      vec3 surfaceToViewDirection = normalize(v_surfaceToView);\n      vec3 halfVector = normalize(u_lightDirection + surfaceToViewDirection);\n      \n      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;\n      float specularLight = clamp(dot(normal, halfVector), 0.0, 1.0);\n      vec4 specularMapColor = texture2D(specularMap, v_texcoord);\n      vec3 effectiveSpecular = specular * specularMapColor.rgb;\n      \n      vec4 diffuseMapColor = texture2D(diffuseMap, v_texcoord);\n      vec3 effectiveDiffuse = diffuse * diffuseMapColor.rgb * v_color.rgb;\n      float effectiveOpacity = opacity * diffuseMapColor.a * v_color.a;\n      \n      gl_FragColor = vec4(\n         emissive +\n         ambient * u_ambientLight +\n         effectiveDiffuse * fakeLight +\n         // specular * pow(specularLight, shininess),\n         effectiveSpecular * pow(specularLight, shininess),\n         effectiveOpacity\n      );\n   }\n\\`;`, `94852836925661660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{14,28-29,39-40}"\n              >\n                <span class="gatsby-code-button-language">js{14,28-29,39-40}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   precision highp float;</span>\n<span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="token string">   varying vec3 v_surfaceToView;</span>\n<span class="token string">   varying vec2 v_texcoord;</span>\n<span class="token string">   varying vec4 v_color;</span>\n<span class="token string">   </span>\n<span class="token string">   uniform vec3 diffuse;</span>\n<span class="token string">   uniform sampler2D diffuseMap;</span>\n<span class="token string">   uniform vec3 ambient;</span>\n<span class="token string">   uniform vec3 emissive;</span>\n<span class="token string">   uniform vec3 specular;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   uniform sampler2D specularMap;</span></span><span class="token string">   uniform float shininess;</span>\n<span class="token string">   uniform float opacity;</span>\n<span class="token string">   uniform vec3 u_lightDirection;</span>\n<span class="token string">   uniform vec3 u_ambientLight;</span>\n<span class="token string">   </span>\n<span class="token string">   void main () {</span>\n<span class="token string">      vec3 normal = normalize(v_normal);</span>\n<span class="token string">      </span>\n<span class="token string">      vec3 surfaceToViewDirection = normalize(v_surfaceToView);</span>\n<span class="token string">      vec3 halfVector = normalize(u_lightDirection + surfaceToViewDirection);</span>\n<span class="token string">      </span>\n<span class="token string">      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;</span>\n<span class="token string">      float specularLight = clamp(dot(normal, halfVector), 0.0, 1.0);</span>\n<span class="gatsby-highlight-code-line"><span class="token string">      vec4 specularMapColor = texture2D(specularMap, v_texcoord);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      vec3 effectiveSpecular = specular * specularMapColor.rgb;</span></span><span class="token string">      </span>\n<span class="token string">      vec4 diffuseMapColor = texture2D(diffuseMap, v_texcoord);</span>\n<span class="token string">      vec3 effectiveDiffuse = diffuse * diffuseMapColor.rgb * v_color.rgb;</span>\n<span class="token string">      float effectiveOpacity = opacity * diffuseMapColor.a * v_color.a;</span>\n<span class="token string">      </span>\n<span class="token string">      gl_FragColor = vec4(</span>\n<span class="token string">         emissive +</span>\n<span class="token string">         ambient * u_ambientLight +</span>\n<span class="token string">         effectiveDiffuse * fakeLight +</span>\n<span class="gatsby-highlight-code-line"><span class="token string">         // specular * pow(specularLight, shininess),</span></span><span class="gatsby-highlight-code-line"><span class="token string">         effectiveSpecular * pow(specularLight, shininess),</span></span><span class="token string">         effectiveOpacity</span>\n<span class="token string">      );</span>\n<span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们也给没有高光贴图的材质设置默认值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62706750432184920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const defaultMaterial = {\n  diffuse: [1, 1, 1],\n  diffuseMap: textures.defaultWhite,\n  ambient: [0, 0, 0],\n  specular: [1, 1, 1],\n  specularMap: textures.defaultWhite,\n  shininess: 400,\n  opacity: 1\n};`, `62706750432184920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{6}"\n              >\n                <span class="gatsby-code-button-language">js{6}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> defaultMaterial <span class="token operator">=</span> <span class="token punctuation">{</span>\n  diffuse<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  diffuseMap<span class="token punctuation">:</span> textures<span class="token punctuation">.</span>defaultWhite<span class="token punctuation">,</span>\n  ambient<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  specular<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  specularMap<span class="token punctuation">:</span> textures<span class="token punctuation">.</span>defaultWhite<span class="token punctuation">,</span></span>  shininess<span class="token punctuation">:</span> <span class="token number">400</span><span class="token punctuation">,</span>\n  opacity<span class="token punctuation">:</span> <span class="token number">1</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>根据 <code class="language-text">.mtl</code> 文件中的材质设置，很难看到什么效果。让我们来修改下镜面设置，这样就好了</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47671851423414410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// hack the materials so we can see the specular map\nObject.values(materials).forEach((m) => {\n  m.shininess = 25;\n  m.specular = [3, 2, 1];\n});`, `47671851423414410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// hack the materials so we can see the specular map</span>\nObject<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>materials<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  m<span class="token punctuation">.</span>shininess <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>\n  m<span class="token punctuation">.</span>specular <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样，只有窗和叶片被设置成反射高光了。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/i4ui4n?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>我很奇怪叶片被设置成了反光。如果你检查 .mtl 文件，你会发现光泽度 Ns 被设置成了 0.0，也就是几乎不反光。但同时，所有材质的 illum 被设置成了 1。根据文档，照度模型为 1 意味着：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69766400438834440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`颜色 = KaIa + Kd { SUM j=1...ls, (N * Lj)Ij }`, `69766400438834440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">颜色 = KaIa + Kd { SUM j=1...ls, (N * Lj)Ij }</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>更通俗的说：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71909028386498820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`颜色 = 环境色 * 环境光 + 漫反射色 * 光照计算和`, `71909028386498820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">颜色 = 环境色 * 环境光 + 漫反射色 * 光照计算和</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>你可以看到并没有用到镜面反射，但文件里却有镜面贴图！镜面高光需要照度模型为 2 或以上。这是一些关于 <code class="language-text">.obj/.mtl</code> 文件的经验，你总是需要对材质做一些手动调整。如何解决这些问题取决于你。你可以编辑 .mtl 文件，或者添加代码。而我们现在会添加一些代码。</p>\n<p>最后一个 .mtl 文件使用贴图的是凹凸贴图：map_Bump。这又是一个可以看出 <code class="language-text">.obj/.mtl</code> 文件古老的地方。引用的只是法线贴图，并不是凹凸贴图。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-04-18-04-45-0fe2f374e025dc6527f9befccfd30379-5d925.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 508px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 99.60629921259843%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAACa0lEQVQ4y31UyXbkIAz0ZxsMSQzY35pJejIvvXjpC1MlyUsOM4d6YDBSqUrQ+DzXrszVA122Ub4XjA+MUw1AB3gbg+G8t6HpMg4SxcYz0qwBMqEJA9YVs/03yboCAT0WfZ6M4bRvSHbO0ySBgyU5j6GsOhcyFjDkp2WyLFLGIglCOTNad3TEvrdako3hAAajgTrkTS/qdxeWYZNkuAO3Gob5SFBWZWgVNm2+4+A3yr4CDyv7IXOPvSisl9qWa3X5grUPBPhd4zAdJZuWYTPFv001pqU6sOrKTdwNpmHMXL8BfySYz+/AL+x/yZ4wF4kY8FGbCA2ZyQ0IllBSz9GAH+KAPTAlu47B0qW6/hP7F0usbntheIcp5YlgKA2BYlprxDdBs3yvpbB8l7+E4UuGhmm1ddN90HkAoaalFumGIMgyoqFHMBuvNcCkODDzogYl6Jw+UCaNWXbjhKUEnrVk6TNstnDPZxzqceDtitLvYgoP0KTIVknbt90YaX6ym62drG3oYGDJPdlab6Esj4Z2wki17KC1NzaqmTa3z9Y2gLRNSFcwoBbz3ovBBHei3ze0m3bxfdIbRW0DOoAEnEhAU6wUaWCwi6cbwW8vjt8QUG/IxnC7GUKGxsocGlLYSEFR0g+UY+5NcHV/3a+ctFx+7gRIpmFGoUuHB4WUDm3doOvdOMuN4eGtrSR4YZudWg2Qxm6TvTT9pK4lTRI4Jn2+XuTePn9IEnd2z4MhI7dkVuyBMGZba7Q2f6WjwlAPnpme0UiJfAj6g6Hrp/1hdb0yjfLuGZN/BJOATl6To+PJVDRlqcZWDVGGofw/4F/hE52zqm4A9QAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 04 18 04 45" title="" data-src="/static/2022-07-04-18-04-45-0fe2f374e025dc6527f9befccfd30379-5d925.png" data-srcset="/static/2022-07-04-18-04-45-0fe2f374e025dc6527f9befccfd30379-7e12f.png 200w,\n/static/2022-07-04-18-04-45-0fe2f374e025dc6527f9befccfd30379-6877e.png 400w,\n/static/2022-07-04-18-04-45-0fe2f374e025dc6527f9befccfd30379-5d925.png 508w" data-sizes="(max-width: 508px) 100vw, 508px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>.mtl 文件中并没有选项指定将凹凸贴图用作法线贴图。我们可以启发性的假设文件名中有个 <code class="language-text">nor</code> 呢？或者我们可以假设 2020 及以后，所有 <code class="language-text">map_Bump</code> 引用的文件都是法线贴图，因为我不确定在过去的几年中看到过 <code class="language-text">.obj</code> 文件中引用的确实是凹凸贴图。 我们先沿着这个假设做。</p>\n<p>我们会用到来自关于法线贴图的文章的代码来生成切线。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61481529390746380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const parts = obj.geometries.map(({ material, data }) => {\n  // ...\n\n  // 如果数据满足，生成切线\n  if (data.texcoord && data.normal) {\n    data.tangent = generateTangents(data.position, data.texcoord);\n  } else {\n    // 没有切线\n    data.tangent = { value: [1, 0, 0] };\n  }\n\n  // create a buffer for each array by calling\n  // gl.createBuffer, gl.bindBuffer, gl.bufferData\n  const bufferInfo = twgl.createBufferInfoFromArrays(gl, data);\n  const vao = twgl.createVAOFromBufferInfo(gl, meshProgramInfo, bufferInfo);\n  return {\n    material: {\n      ...defaultMaterial,\n      ...materials[material]\n    },\n    bufferInfo,\n    vao\n  };\n});`, `61481529390746380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4-10}"\n              >\n                <span class="gatsby-code-button-language">js{4-10}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> parts <span class="token operator">=</span> obj<span class="token punctuation">.</span>geometries<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> material<span class="token punctuation">,</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 如果数据满足，生成切线</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>texcoord <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">.</span>normal<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    data<span class="token punctuation">.</span>tangent <span class="token operator">=</span> <span class="token function">generateTangents</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>position<span class="token punctuation">,</span> data<span class="token punctuation">.</span>texcoord<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">// 没有切线</span></span><span class="gatsby-highlight-code-line">    data<span class="token punctuation">.</span>tangent <span class="token operator">=</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  <span class="token comment">// create a buffer for each array by calling</span>\n  <span class="token comment">// gl.createBuffer, gl.bindBuffer, gl.bufferData</span>\n  <span class="token keyword">const</span> bufferInfo <span class="token operator">=</span> twgl<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> vao <span class="token operator">=</span> twgl<span class="token punctuation">.</span><span class="token function">createVAOFromBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> meshProgramInfo<span class="token punctuation">,</span> bufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    material<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      <span class="token operator">...</span>defaultMaterial<span class="token punctuation">,</span>\n      <span class="token operator">...</span>materials<span class="token punctuation">[</span>material<span class="token punctuation">]</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    bufferInfo<span class="token punctuation">,</span>\n    vao\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同样的，为没有法线贴图的材质添加默认值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27927510745465065000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const textures = {\n  defaultWhite: create1PixelTexture(gl, [255, 255, 255, 255]),\n  defaultNormal: create1PixelTexture(gl, [127, 127, 255, 0])\n};\n\n// ...\n\nconst defaultMaterial = {\n  diffuse: [1, 1, 1],\n  diffuseMap: textures.defaultWhite,\n  normalMap: textures.defaultNormal,\n  ambient: [0, 0, 0],\n  specular: [1, 1, 1],\n  specularMap: textures.defaultWhite,\n  shininess: 400,\n  opacity: 1\n};\n\n// ...`, `27927510745465065000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3,11}"\n              >\n                <span class="gatsby-code-button-language">js{3,11}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> textures <span class="token operator">=</span> <span class="token punctuation">{</span>\n  defaultWhite<span class="token punctuation">:</span> <span class="token function">create1PixelTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  defaultNormal<span class="token punctuation">:</span> <span class="token function">create1PixelTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">127</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token keyword">const</span> defaultMaterial <span class="token operator">=</span> <span class="token punctuation">{</span>\n  diffuse<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  diffuseMap<span class="token punctuation">:</span> textures<span class="token punctuation">.</span>defaultWhite<span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  normalMap<span class="token punctuation">:</span> textures<span class="token punctuation">.</span>defaultNormal<span class="token punctuation">,</span></span>  ambient<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  specular<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  specularMap<span class="token punctuation">:</span> textures<span class="token punctuation">.</span>defaultWhite<span class="token punctuation">,</span>\n  shininess<span class="token punctuation">:</span> <span class="token number">400</span><span class="token punctuation">,</span>\n  opacity<span class="token punctuation">:</span> <span class="token number">1</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后我们需要将关于法线贴图的文章中对着色器的修改合并：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27507524244639183000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const vs = \\`\n   attribute vec4 a_position;\n   attribute vec3 a_normal;\n   attribute vec3 a_tangent;\n   attribute vec2 a_texcoord;\n   attribute vec4 a_color;\n   \n   uniform mat4 u_projection;\n   uniform mat4 u_view;\n   uniform mat4 u_world;\n   uniform vec3 u_viewWorldPosition;\n   \n   varying vec3 v_normal;\n   varying vec3 v_tangent;\n   varying vec3 v_surfaceToView;\n   varying vec2 v_texcoord;\n   varying vec4 v_color;\n   \n   void main() {\n      vec4 worldPosition = u_world * a_position;\n      gl_Position = u_projection * u_view * worldPosition;\n      v_surfaceToView = u_viewWorldPosition - worldPosition.xyz;\n      \n      // v_normal = mat3(u_world) * a_normal;\n      mat3 normalMat = mat3(u_world);\n      v_normal = normalize(normalMat * a_normal);\n      v_tangent = normalize(normalMat * a_tangent);\n      \n      v_texcoord = a_texcoord;\n      v_color = a_color;\n   }\n\\`;\n\nconst fs = \\`\n   precision highp float;\n   \n   varying vec3 v_normal;\n   varying vec3 v_tangent;\n   varying vec3 v_surfaceToView;\n   varying vec2 v_texcoord;\n   varying vec4 v_color;\n   \n   uniform vec3 diffuse;\n   uniform sampler2D diffuseMap;\n   uniform vec3 ambient;\n   uniform vec3 emissive;\n   uniform vec3 specular;\n   uniform sampler2D specularMap;\n   uniform float shininess;\n   uniform sampler2D normalMap;\n   uniform float opacity;\n   uniform vec3 u_lightDirection;\n   uniform vec3 u_ambientLight;\n   \n   void main () {\n      vec3 normal = normalize(v_normal);\n      vec3 tangent = normalize(v_tangent);\n      vec3 bitangent = normalize(cross(normal, tangent));\n      \n      mat3 tbn = mat3(tangent, bitangent, normal);\n      normal = texture2D(normalMap, v_texcoord).rgb * 2. - 1.;\n      normal = normalize(tbn * normal);\n      \n      vec3 surfaceToViewDirection = normalize(v_surfaceToView);\n      vec3 halfVector = normalize(u_lightDirection + surfaceToViewDirection);\n      \n      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;\n      float specularLight = clamp(dot(normal, halfVector), 0.0, 1.0);\n      vec4 specularMapColor = texture2D(specularMap, v_texcoord);\n      vec3 effectiveSpecular = specular * specularMapColor.rgb;\n      \n      vec4 diffuseMapColor = texture2D(diffuseMap, v_texcoord);\n      vec3 effectiveDiffuse = diffuse * diffuseMapColor.rgb * v_color.rgb;\n      float effectiveOpacity = opacity * diffuseMapColor.a * v_color.a;\n      \n      gl_FragColor = vec4(\n         emissive +\n         ambient * u_ambientLight +\n         effectiveDiffuse * fakeLight +\n         effectiveSpecular * pow(specularLight, shininess),\n         effectiveOpacity); // * 0.0 + vec4(normal * 0.5 + 0.5 + effectiveSpecular * pow(specularLight, shininess), 1\n      );\n   }\n\\`;`, `27507524244639183000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4,14,24-27,38,57-62}"\n              >\n                <span class="gatsby-code-button-language">js{4,14,24-27,38,57-62}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> vs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   attribute vec4 a_position;</span>\n<span class="token string">   attribute vec3 a_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   attribute vec3 a_tangent;</span></span><span class="token string">   attribute vec2 a_texcoord;</span>\n<span class="token string">   attribute vec4 a_color;</span>\n<span class="token string">   </span>\n<span class="token string">   uniform mat4 u_projection;</span>\n<span class="token string">   uniform mat4 u_view;</span>\n<span class="token string">   uniform mat4 u_world;</span>\n<span class="token string">   uniform vec3 u_viewWorldPosition;</span>\n<span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   varying vec3 v_tangent;</span></span><span class="token string">   varying vec3 v_surfaceToView;</span>\n<span class="token string">   varying vec2 v_texcoord;</span>\n<span class="token string">   varying vec4 v_color;</span>\n<span class="token string">   </span>\n<span class="token string">   void main() {</span>\n<span class="token string">      vec4 worldPosition = u_world * a_position;</span>\n<span class="token string">      gl_Position = u_projection * u_view * worldPosition;</span>\n<span class="token string">      v_surfaceToView = u_viewWorldPosition - worldPosition.xyz;</span>\n<span class="token string">      </span>\n<span class="gatsby-highlight-code-line"><span class="token string">      // v_normal = mat3(u_world) * a_normal;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      mat3 normalMat = mat3(u_world);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      v_normal = normalize(normalMat * a_normal);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      v_tangent = normalize(normalMat * a_tangent);</span></span><span class="token string">      </span>\n<span class="token string">      v_texcoord = a_texcoord;</span>\n<span class="token string">      v_color = a_color;</span>\n<span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   precision highp float;</span>\n<span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   varying vec3 v_tangent;</span></span><span class="token string">   varying vec3 v_surfaceToView;</span>\n<span class="token string">   varying vec2 v_texcoord;</span>\n<span class="token string">   varying vec4 v_color;</span>\n<span class="token string">   </span>\n<span class="token string">   uniform vec3 diffuse;</span>\n<span class="token string">   uniform sampler2D diffuseMap;</span>\n<span class="token string">   uniform vec3 ambient;</span>\n<span class="token string">   uniform vec3 emissive;</span>\n<span class="token string">   uniform vec3 specular;</span>\n<span class="token string">   uniform sampler2D specularMap;</span>\n<span class="token string">   uniform float shininess;</span>\n<span class="token string">   uniform sampler2D normalMap;</span>\n<span class="token string">   uniform float opacity;</span>\n<span class="token string">   uniform vec3 u_lightDirection;</span>\n<span class="token string">   uniform vec3 u_ambientLight;</span>\n<span class="token string">   </span>\n<span class="token string">   void main () {</span>\n<span class="token string">      vec3 normal = normalize(v_normal);</span>\n<span class="gatsby-highlight-code-line"><span class="token string">      vec3 tangent = normalize(v_tangent);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      vec3 bitangent = normalize(cross(normal, tangent));</span></span><span class="gatsby-highlight-code-line"><span class="token string">      </span></span><span class="gatsby-highlight-code-line"><span class="token string">      mat3 tbn = mat3(tangent, bitangent, normal);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      normal = texture2D(normalMap, v_texcoord).rgb * 2. - 1.;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      normal = normalize(tbn * normal);</span></span><span class="token string">      </span>\n<span class="token string">      vec3 surfaceToViewDirection = normalize(v_surfaceToView);</span>\n<span class="token string">      vec3 halfVector = normalize(u_lightDirection + surfaceToViewDirection);</span>\n<span class="token string">      </span>\n<span class="token string">      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;</span>\n<span class="token string">      float specularLight = clamp(dot(normal, halfVector), 0.0, 1.0);</span>\n<span class="token string">      vec4 specularMapColor = texture2D(specularMap, v_texcoord);</span>\n<span class="token string">      vec3 effectiveSpecular = specular * specularMapColor.rgb;</span>\n<span class="token string">      </span>\n<span class="token string">      vec4 diffuseMapColor = texture2D(diffuseMap, v_texcoord);</span>\n<span class="token string">      vec3 effectiveDiffuse = diffuse * diffuseMapColor.rgb * v_color.rgb;</span>\n<span class="token string">      float effectiveOpacity = opacity * diffuseMapColor.a * v_color.a;</span>\n<span class="token string">      </span>\n<span class="token string">      gl_FragColor = vec4(</span>\n<span class="token string">         emissive +</span>\n<span class="token string">         ambient * u_ambientLight +</span>\n<span class="token string">         effectiveDiffuse * fakeLight +</span>\n<span class="token string">         effectiveSpecular * pow(specularLight, shininess),</span>\n<span class="token string">         effectiveOpacity); // * 0.0 + vec4(normal * 0.5 + 0.5 + effectiveSpecular * pow(specularLight, shininess), 1</span>\n<span class="token string">      );</span>\n<span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样，我们就得到了法线贴图。注意：我移近了摄像头，这样能看的更清楚。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/j09plh?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>我确信我们还可以支持更多的 <code class="language-text">.mtl</code> 文件的的特性。比如 refl 关键词指定了反射贴图，也就是环境贴图。同样还有很多 <code class="language-text">map_</code> 加各种选项参数的关键词。比如：</p>\n<ul>\n<li><code class="language-text">-clamp on | off</code> 指定纹理是否重复</li>\n<li><code class="language-text">-mm base gain</code> 指定纹理值的偏移和倍数</li>\n<li><code class="language-text">-o u v w</code> 指定纹理坐标的偏移。可以像关于 drawImage 的文章中那样放进纹理矩阵中来使用</li>\n<li><code class="language-text">-s u v w</code> 指定纹理坐标的缩放。像上面一样，这些需要放进纹理矩阵中</li>\n</ul>\n<p>我不知道有多少 .mtl 文件使用了这些设置，或用了多少。例如，要支持 -o 和 -s，我们就要假设所有的贴图都有区别，并支持全部的纹理。这就需要我们为每个纹理传不同的纹理矩阵，而这又需要我们从顶点着色器为每个纹理传不同的纹理坐标到片段着色器，或者在片段着色器中进行纹理矩阵乘法（而不是传统方法那样在顶点着色器中做）。</p>\n<p>更重要的是，如果支持所有特性，会让着色器变得又大又复杂。上面的代码是一种超级着色器的样子，一个试图处理所有情况的着色器。通过传默认值来让它正常工作。例如，我们将 diffuseMap 默认设置成白色纹理，这样如果我们加载了没有纹理的模型，也可以显示出来。漫反射的颜色会被乘上白色，也就是 1.0，所以我们就能得到漫反射颜色。类似的，我们将顶点颜色默认设置为白色。</p>\n<p>这是一种常用的方式。如果它效果不错，满足了你的要求，就没有理由去改动它。更常见的做法是生成一个可以开/关这些特性的着色器。如果没有顶点颜色，就通过操作字符串，生成一个着色器，着色器里没有 <code class="language-text">a_color</code> 属性和其它相关代码。类似的，如果一个材质没有漫反射贴图，就生成一个没有 <code class="language-text">uniform sampler2D diffuseMap</code> 的着色器，并移除相关代码。如果不包含任何贴图，就不需要纹理坐标，我们就可以把它们全部移除。</p>\n<p>如果将这些组合都加上，可能会有 1000 多种着色器。我们上面有的特性就有：</p>\n<ul>\n<li>漫反射贴图</li>\n<li>有/无镜面贴图</li>\n<li>有/无法线贴图</li>\n<li>有/无顶点颜色</li>\n<li>有/无环境贴图</li>\n<li>有/无（我们不支持，但 .mtl 文件中有）</li>\n<li>反射贴图，有/无（我们不支持，但 .mtl 文件中有）</li>\n</ul>\n<p>仅这些就有 64 种组合。如果再加上 1 到 4 种光线（点光源、方向光源等），那么就会有 8192 种可能的着色器组合。</p>\n<p>管理这些就会有很多工作。这就是为什么很多人选择像 three.js 这样的 3D 引擎而不是自己开发的原因。但至少这篇文章介绍了一些展示任意 3D 内容的相关的知识。</p>\n<h2 id="尽可能避免在着色器中使用条件语句"><a href="#%E5%B0%BD%E5%8F%AF%E8%83%BD%E9%81%BF%E5%85%8D%E5%9C%A8%E7%9D%80%E8%89%B2%E5%99%A8%E4%B8%AD%E4%BD%BF%E7%94%A8%E6%9D%A1%E4%BB%B6%E8%AF%AD%E5%8F%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>尽可能避免在着色器中使用条件语句</h2>\n<p>通常的建议是避免在着色器中使用条件语句。比如我们可能写这样的代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88867111593333110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`uniform bool hasDiffuseMap;\nuniform vec4 diffuse;\nuniform sampler2D diffuseMap\n\n// ...\nvec4 effectiveDiffuse = diffuse;\nif (hasDiffuseMap) {\n   effectiveDiffuse \\*= texture2D(diffuseMap, texcoord);\n}\n// ...`, `88867111593333110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">uniform</span> <span class="token keyword">bool</span> hasDiffuseMap<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> diffuse<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> diffuseMap\n\n<span class="token comment">// ...</span>\n<span class="token keyword">vec4</span> effectiveDiffuse <span class="token operator">=</span> diffuse<span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>hasDiffuseMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   effectiveDiffuse \\<span class="token operator">*</span><span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>diffuseMap<span class="token punctuation">,</span> texcoord<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// ...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样的条件语句一般是不鼓励的，因为依赖于 GPU 或者驱动，它们没有很好的性能。</p>\n<p>当没有纹理时我们用一个 1x1 像素的白点纹理，这样就不用考虑条件语句了。</p>\n<p>或者，使用不同的着色器。一个带有该特性，一个没有，根据情况选择使用正确的着色器。</p>',
excerpt:"WebGL 三维几何加工 有人问我怎么在 WebGL 中制作一个保龄球瓶，聪明的回答是 。使用它创建一个保龄球瓶，导出，读取点坐标(OBJ…",frontmatter:{date:"2022-06-21 18:20:05",path:"/webgl-fundamental-geometry/",tags:"前端, 可视化, WebGL, 读书笔记",title:"WebGL 理论基础——几何",draft:null}},prePost:{html:'<h1 id="webgl-三维纹理"><a href="#webgl-%E4%B8%89%E7%BB%B4%E7%BA%B9%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 三维纹理</h1>\n<p>在 WebGL 中如何使用纹理？你可能会从二维图像处理的文章中得到启发，如果我们讲的再深入一点可能更好理解。</p>\n<p>首先需要调整着色器以便使用纹理，这里是顶点着色器的修改部分，我们需要传递纹理坐标，在这个例子中直接将它们传到片断着色器中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24645070295377480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\nattribute vec2 a_texcoord;\n\nuniform mat4 u_matrix;\n\nvarying vec2 v_texcoord;\n\nvoid main() {\n  // 将位置和矩阵相乘\n  gl_Position = u_matrix * a_position;\n\n  // 传递纹理坐标到片断着色器\n  v_texcoord = a_texcoord;\n}`, `24645070295377480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{2,6,12-13}"\n              >\n                <span class="gatsby-code-button-language">glsl{2,6,12-13}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">attribute</span> <span class="token keyword">vec2</span> a_texcoord<span class="token punctuation">;</span></span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_matrix<span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 将位置和矩阵相乘</span>\n  gl_Position <span class="token operator">=</span> u_matrix <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 传递纹理坐标到片断着色器</span></span><span class="gatsby-highlight-code-line">  v_texcoord <span class="token operator">=</span> a_texcoord<span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在片断着色器中声明一个 sampler2D 类型的全局变量，可以让我们引用一个纹理，然后使用从顶点着色器传入的纹理坐标调用 texture2D 方法，在纹理上找到对应的颜色。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53870266818547250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 从顶点着色器中传入的值\nvarying vec2 v_texcoord;\n\n// 纹理\nuniform sampler2D u_texture;\n\nvoid main() {\n   gl_FragColor = texture2D(u_texture, v_texcoord);\n}`, `53870266818547250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{4,6-7,10}"\n              >\n                <span class="gatsby-code-button-language">glsl{4,6-7,10}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器中传入的值</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// 纹理</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_texture<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">   gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们需要设置纹理坐标</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5969074234609706000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 找到顶点坐标中的属性\nvar positionLocation = gl.getAttribLocation(program, \'a_position\');\nvar texcoordLocation = gl.getAttribLocation(program, \'a_texcoord\');\n\n// ...\n\n// 为纹理坐标创建一个缓冲\nvar buffer = gl.createBuffer();\ngl.bindBuffer(gl.ARRAY_BUFFER, buffer);\ngl.enableVertexAttribArray(texcoordLocation);\n\n// 以浮点型格式传递纹理坐标\ngl.vertexAttribPointer(texcoordLocation, 2, gl.FLOAT, false, 0, 0);\n\n// 设置纹理坐标\nsetTexcoords(gl);`, `5969074234609706000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3,7,10,12-13,15-16}"\n              >\n                <span class="gatsby-code-button-language">js{3,7,10,12-13,15-16}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 找到顶点坐标中的属性</span>\n<span class="token keyword">var</span> positionLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'a_position\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> texcoordLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'a_texcoord\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="token comment">// ...</span>\n\n<span class="gatsby-highlight-code-line"><span class="token comment">// 为纹理坐标创建一个缓冲</span></span><span class="token keyword">var</span> buffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>texcoordLocation<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// 以浮点型格式传递纹理坐标</span></span><span class="gatsby-highlight-code-line">gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>texcoordLocation<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// 设置纹理坐标</span></span><span class="gatsby-highlight-code-line"><span class="token function">setTexcoords</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="f"><a href="#f" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>F</h2>\n<p>如你所见，我们将图像映射到 F 中的每个矩形面上。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32498649391492250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 为 F 设置纹理坐标缓冲\nfunction setTexcoords(gl) {\n  gl.bufferData(\n    gl.ARRAY_BUFFER,\n    new Float32Array([\n      // 正面左竖\n      0,\n      0,\n      0,\n      1,\n      1,\n      0,\n      0,\n      1,\n      1,\n      1,\n      1,\n      0,\n\n      // 正面上横\n      0,\n      0,\n      0,\n      1,\n      1,\n      0,\n      0,\n      1,\n      1,\n      1,\n      1,\n      0\n\n      //  ...\n    ]),\n    gl.STATIC_DRAW\n  );\n}`, `32498649391492250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 为 F 设置纹理坐标缓冲</span>\n<span class="token keyword">function</span> <span class="token function">setTexcoords</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>\n    gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span>\n    <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n      <span class="token comment">// 正面左竖</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n\n      <span class="token comment">// 正面上横</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">0</span>\n\n      <span class="token comment">//  ...</span>\n    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>事实上使用一个带有 F 的图像能够在结果中清楚的分辨出纹理的方向。</p>\n<p>我们还需要一个纹理，我们可以从头做一个但在这个例子中就直接加载一个图像，因为那可能是常用的做法。</p>\n<p>这是我们将要使用的图像</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-06-11-32-56-443726b38fe61fd3f4f35878e1ccd41d-34a30.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 256px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAADQElEQVQ4y53Se0wURxwH8O/svVzUAy14R9SkcmrLcXCXAzGBayGmxEeMQhFJjQWixpjYCmo0PojhIbZqaGurRCMhZ1R8lNaYaP/w0dqcxEj/qFUBQcWGcjlB5OEDFXfn5+yKxkTSGJNPJjs7v+9OfjMLmoD3Bl44RPlKUnVcw94ytKqVrRqKgK7o/gG1gm69g9uga6C/tRQecgwQ7j/FyTpvXc0np/1JZ/yeC/74gN9ZfyBWEA9/+l3n/J7f/Ikn/KkHq71tITwlLYjjHL8SavowL3bdEpTvlL78GTMvIvkqnK2YLFxD7EUk/oKMSrZoJYq9WFt8HqcIxxQgiyObMKcfSxJydyP7rDHhpmTvY7JiYCSa0nFY7iHqLxZXi/n5WJByFjmETBEO42wkMXO/tDp+9jmktEn2AZhpFOpt+GIaClJRkIwCLxZ7pM89coYnKtYdbW7QImEqE591M3KjP77MldYKxyPJolghXuz2GdDuNJAHihuqkAA1XvMsTpuSjqmlEm1F/+YfXGk9+ECxMGUqo1zULpatgeXj76yJbimMbimy3yiKbl49pqWIKeWMl70kdm5k1IIHDftcMwYxgkeAp4LW4skh8736mO7Lju46R3epozPHMRg3adeUj9EVkMSt8kZQE9DL2UNCR1+1M0OFkUeCfwbaAvod9AD0GHQJ9C2ez2I0GjUjrWgOGh4TelT0iaM8xNkR7a72xcwchEXsrPpAG3C9UiopjtpWZqv42laRZStPslfaIzPtH6HqLjtKIoXDIpzOWTohvXeXbW4vrKqFPRc952PP7Ah8eMXg6oSrA54gkoKYHkRKCGkKtHqdycTNRoLcWxGx8BYmDECcNqNkVLvHwtQ5KoxkmcsjSLaQbCaLiUxvgA/8U1CSsWdD+NLz8P4L2wBMFI6asWOcCKaDfFB8Wiuv0Wv4kalVoG9M3UXh6/cjM4DEO5hITK5ltk0stJeRKPiJ8WGhHTwEumrsmmPdmIO8EsyohusPjCuFLYBgF0gU/AcalvhvOwihZ6xtq1SyAsvWYekm5G1Bbgnye9BEuKsXBIcl4tt1OwjfESr1Ufhet+PV6vBE2CFwOFR95No0RuDa6Ph/LwDyagrEe1kcagAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 06 11 32 56" title="" data-src="/static/2022-07-06-11-32-56-443726b38fe61fd3f4f35878e1ccd41d-34a30.png" data-srcset="/static/2022-07-06-11-32-56-443726b38fe61fd3f4f35878e1ccd41d-b25ce.png 200w,\n/static/2022-07-06-11-32-56-443726b38fe61fd3f4f35878e1ccd41d-34a30.png 256w" data-sizes="(max-width: 256px) 100vw, 256px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>加载图像的过程是异步的，我们请求图像资源后浏览器需要一段时间去下载。通常有两种处理方法，一种是等纹理下载完成后再开始绘制，另一种是在图像加载前使用生成的纹理，这种方式可以立即启动渲染，一旦图像下载完成就拷贝到纹理。我们将使用下方的方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74906557834803640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建一个纹理\nvar texture = gl.createTexture();\ngl.bindTexture(gl.TEXTURE_2D, texture);\n\n// 用 1x1 个蓝色像素填充纹理\ngl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE, new Uint8Array([0, 0, 255, 255]));\n\n// 异步加载图像\nvar image = new Image();\nimage.src = \'resources/f-texture.png\';\nimage.addEventListener(\'load\', function () {\n  // 现在图像加载完成，拷贝到纹理中\n  gl.bindTexture(gl.TEXTURE_2D, texture);\n  gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);\n  gl.generateMipmap(gl.TEXTURE_2D);\n});`, `74906557834803640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建一个纹理</span>\n<span class="token keyword">var</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 用 1x1 个蓝色像素填充纹理</span>\ngl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 异步加载图像</span>\n<span class="token keyword">var</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nimage<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">\'resources/f-texture.png\'</span><span class="token punctuation">;</span>\nimage<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'load\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 现在图像加载完成，拷贝到纹理中</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">generateMipmap</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/7x6dzh?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>如果我只想使用一部分图像覆盖 ‘F’ 的正面怎么办，纹理是通过“纹理坐标”来引用的，纹理坐标 0.0 到 1.0 对应纹理从左到右，0.0 到 1.0 对应第一个像素所在行到最后一行。注意我没有使用上或者下，上下在纹理坐标空间中是没有意义的，因为绘制一些东西后再重定向后，是没有上下的概念的，主要是依据传递给 WebGL 的纹理数据，纹理数据的开头对应纹理坐标 0, 0，结尾对应纹理坐标 1, 1</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-26-17-11-32-49fe858cf403919acb339e59c7cb21bf-be424.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 169px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 88.75739644970415%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsSAAALEgHS3X78AAADOUlEQVQ4y62UbWhTVxjH/09iFW60NDFK1Oa2iTGtFtsK9i2iotJbWxBk+sUvsi9jF0RkU1ah6OwHkeqXbWiHH6ZuICjiBzesCOLwrb7MopujtqG2VXGuIooOanNzc5499yY2cQiOsQM/zsk9//PjOTfnXOi6DqdJHyzTwyH8x9btyQ3ywnBZuKw8fhbwdEyBb48X2pf/Asn5PveiyHHs9RYIm+ZGZqLRV9zrrdn0BPVjf6Ih+RR1Q39g6Xtx5p6iYVByY7eodqvj+AtNnknhyjn1M7ECxbdweAvjMr/GOZ7Az5zG1RzXCujlFC7xK/Qwy9wd+q7Tcdi46J0UNobWlqAF2kFKmj3E/CNx6gc8sw/hN7sb9+xuuiPcdTlEffZRemifIZ44L9nDntFdjuM8OF9hNGT4Pa3QqqnfbARzApwOYpuSKQaKpC8Wpgsl7rMZ+Fg1gS2BazC0231thcJQ1PC3Ahpq+00kZCfLZGdzdyqSxTRvu6LEa0V1I4rqHwsPFRqeKzQqS3KMJVmhjAuECcNviJCOJU26IqEbItzUka3w0y6FQc7gpnBb6BOuCRfYkmdMx0ezwuuFQmN5Vnj/tEn8OxMPptG+OSuMxRUZ6xStalHU3CaVrlT0/X5F3G8RDzAN/5QV8kChMO5vc7Z8f40J/ojBG0UYywoTUxXa5f1t9Sl8Jv0n0xR6FivJWOANjKHmnHBjXqgbIf88NGvhfq85X3QxRrrkC7hCf1eRivH0TIR9megkUzNRG5bkWH/gcYWyLi+sEyHQou0bIPO4hE6KsK0jK1zfCXWKkTmSgjqWycEuluT4wAi5whOFwubVjtDQ7vXClFPN6gVSD36BfeEE7JE+2PLbtsaEZ++Q4nFw8ja555DfFAiNJY6wVRvYQVv4GzlcXcLXwrfCV8J+4cA/cDIHwcPt5N6Ul53e/E1pKQ8VI7DK92vMs3l8EV5aVRidWIhH45V45PSpqvcykq7Ci2SctrkVyhVA6ds/JRwOhCNlgRp4iirg1+MIfJAKBEoXILggNmV2oLQiMk0vDWuT3zOpNCFUO+NgbSwwu3p+8EPMklxoYVSfUxmZIWsrhMUoz1X4f7W/Aa9CwjdT6tEOAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 26 17 11 32" title="" data-src="/static/2022-07-26-17-11-32-49fe858cf403919acb339e59c7cb21bf-be424.png" data-srcset="/static/2022-07-26-17-11-32-49fe858cf403919acb339e59c7cb21bf-be424.png 169w" data-sizes="(max-width: 169px) 100vw, 169px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>我将纹理载入到 Photoshop 中得到一些点的坐标。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-26-17-11-52-5c0670c8439afe89e59a410f13ea4237-bb96f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 512px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAAEcUlEQVQ4y32Ue0zWZRTHz3uFl4uIJLx4m/CKyE0CucwEFVErs+nWMNcmLm1TSc1bJjITxUrTmpeykLAWmiXVXP2RzSA0tGxi6sJU1MJk0jBRCUV5f++n83txtTnrj89znvM85/n+zu/3nPOTswNtHBrmpHWglYZEJ11uAcX3f0RrTKTwS6ydA3FOmmNsnPbYOae+nFpgo3ppIHVz7exf4eJmkRXmWzCe78HnR/7BXPPqPkVCfZGTqvkuauY72L/YyY9LHQjH9Gk/6eZ7grde578qTcr5ezTdx/n7OC4c2qH2WA9y3RBuq+6JC0JFeTr7Ksfy1Y5saivSOVKewuHKRL7bmUC9ic7NtbryNI3J4guN3b55BLVHhS7VMLVkrw6fqfPhX8KUYcuYGvkMz6WOZL17JCtHJfJpnzhNeogm46EuIJ7FGfEUp41g6aDxzMzNJ03mUVpr5UvV+KRbBZ9UwSnqTLwuPJs0jdcd49kTMZiasHAqUqw0ReiryL+cC7JzytWb6uABlA2N52lnPtlfC1NVY7JPBYMMC8HqOG9YWJT8GDWSw28SjU+c3O4t7MwVCrOFWSOF2RnCvGS1iVamJwQzLiGM3IJAXA1W1bAS0mHRZxopKjccuZHM2qQxnJVYOqwO7vbSjFKErdk2pDlJYx5GulMRI7VnfjWBzFfcZBX3YeC+fmRsjCTr/X6m4BoslOntlLA5eTTXJBxvgNAdp4LThd2FLkIOzyH60hKimhYRdX6R3/ZtWobn4HQyq8dgu7wSZ8cqHJ2rzK/yswqeQW4e5d3kPO5IAIa+qu8RFVyiFbDLwR/1g2n7Poa2vcrqGFqfiqErMYatsR6krVYzvqA0KqdV8LqBpVO/d0s7FYnj8Yod4yEVzNciXqWiNYpWAF3KD8oG5XElVKhyhSBnWrHdwqw//Ww+FaxSwY90obKd8tgJmqHTn6ExSg+tEE5tsrK6JJJ1a6IoW6BMjWJthpuN7r4UuPthefssskfP7/IqpmCeKufpQl47m6OeoF164XVauDtU22um8Nak3sjg40jKFaUZSbuEZKhNv0lQzgHiJ1ehhYGMoUfHYTdwavtK4DXWhRVodw2gU7P0mrecqd0zvA9iv0qQCwIDISBArZIzagk5uTOIif2AERlzycxagM2q/ZIjBqPNs/Y/eSlsFt9ImnZGpIo6IEzrMDycJGlhrMbkSDdmfK7aR0NOMCG4gfygRiaEHFdO6t4dZJsGbNfg9fY2FoYtp1ymcFDSuaiZoje+29KXYkuLrsM28So+P1vUN9l6z27x7+uRZh2uKCdVcFKvYqZJIaUyjkpJ5lvNtEz6c0Su0mrp+RGZ8ZeU3x+Aua7Nd1nHK9yVi6yzlDJHZvOizNILnqFihSwPnUhj9MdmXfjjemj5T8Qnr2nfvqrOeuUNZdM9+ya3bJs46l5IXWwBLYEvc6T/CzSHlvhjDT3jewAq6NGAIZjW0D428Sqofy7UzTupwXzuiaR6aDgbRjuoHRShe3Ea5/GfuZ+/AUj1ih5wg07pAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 26 17 11 52" title="" data-src="/static/2022-07-26-17-11-52-5c0670c8439afe89e59a410f13ea4237-bb96f.png" data-srcset="/static/2022-07-26-17-11-52-5c0670c8439afe89e59a410f13ea4237-7728b.png 200w,\n/static/2022-07-26-17-11-52-5c0670c8439afe89e59a410f13ea4237-23f96.png 400w,\n/static/2022-07-26-17-11-52-5c0670c8439afe89e59a410f13ea4237-bb96f.png 512w" data-sizes="(max-width: 512px) 100vw, 512px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>可以像这样将像素坐标转换到纹理坐标</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15196440169330616000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`texcoordX = pixelCoordX / (width - 1);\ntexcoordY = pixelCoordY / (height - 1);`, `15196440169330616000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">texcoordX <span class="token operator">=</span> pixelCoordX <span class="token operator">/</span> <span class="token punctuation">(</span>width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ntexcoordY <span class="token operator">=</span> pixelCoordY <span class="token operator">/</span> <span class="token punctuation">(</span>height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这是正面的纹理坐标</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73601119164542460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 正面左竖\n 38 / 255,  44 / 255,\n 38 / 255, 223 / 255,\n113 / 255,  44 / 255,\n 38 / 255, 223 / 255,\n113 / 255, 223 / 255,\n113 / 255,  44 / 255,\n\n// 正面上横\n113 / 255, 44 / 255,\n113 / 255, 85 / 255,\n218 / 255, 44 / 255,\n113 / 255, 85 / 255,\n218 / 255, 85 / 255,\n218 / 255, 44 / 255,\n\n// 正面中横\n113 / 255, 112 / 255,\n113 / 255, 151 / 255,\n203 / 255, 112 / 255,\n113 / 255, 151 / 255,\n203 / 255, 151 / 255,\n203 / 255, 112 / 255,`, `73601119164542460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">// 正面左竖\n 38 / 255,  44 / 255,\n 38 / 255, 223 / 255,\n113 / 255,  44 / 255,\n 38 / 255, 223 / 255,\n113 / 255, 223 / 255,\n113 / 255,  44 / 255,\n\n// 正面上横\n113 / 255, 44 / 255,\n113 / 255, 85 / 255,\n218 / 255, 44 / 255,\n113 / 255, 85 / 255,\n218 / 255, 85 / 255,\n218 / 255, 44 / 255,\n\n// 正面中横\n113 / 255, 112 / 255,\n113 / 255, 151 / 255,\n203 / 255, 112 / 255,\n113 / 255, 151 / 255,\n203 / 255, 151 / 255,\n203 / 255, 112 / 255,</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对背面也使用相同的纹理坐标，得到这样的结果。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/x9ilbj?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>并不是非常好看，但是希望这样能展示出纹理坐标的用法。如果你使用代码生成几何体（立方体，球体，等等），通常情况下计算期望的纹理坐标也是比较容易的。另一方面如果通过软件例如 Blender, Maya, 3D Studio Max 制作几何体，那么你的美术（或者你自己）就会用软件调整纹理坐标。</p>\n<p>如果纹理坐标再 0.0 到 1.0 之外会怎样？WebGL 默认会重复纹理，0.0 到 1.0 是一份纹理的“拷贝”，1.0 到 2.0 是另外一份拷贝，-4.0 到 -3.0 也是另外一份拷贝。让我们在一个平面上使用这些纹理坐标。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66052453916450360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`-3, -1,\n 2, -1,\n-3,  4,\n-3,  4,\n 2, -1,\n 2,  4,`, `66052453916450360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">-3, -1,\n 2, -1,\n-3,  4,\n-3,  4,\n 2, -1,\n 2,  4,</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是结果</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/2mkgm4?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>你可以使用 <code class="language-text">CLAMP_TO_EDGE</code> 告诉 WebGL 再某个方向不需要重复，例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83386742859938460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);`, `83386742859938460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>点击上方示例中的按钮，观察结果。</p>\n<p>你可能注意到在加载纹理时调用了 <code class="language-text">gl.generateMipmap</code>，那是干什么的？</p>\n<p>假设我们有这样一个 16×16 像素的纹理。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-26-18-15-32-8c4576eaf7e5e96d1a2bd07869a8ce07-34a30.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 256px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAADHUlEQVQ4y3WU+UtUURTHz31v3oxjOq6j45vnkmtqOvCyQlKwoHAX0dFsEUzBnyzGcd8CKfsLgoh+lUqK/EHzByvX3JdAQSNQfxAsIVApc3nv3e57b9IZpcOXw134cO69nO8FTCI7GwNgvV7OACKiSJ4OiY1p62I7ekbDE8l0x9Og7v5BGpLHtCxwjYAlCS8tYatV3tNqMUL/4HPRLa/Yxz0jERYyPWAYkveBJvmdW6QloBTMtYBFUS4+Po6LimSeohxwMIFfHsGHZB0QGfTpw68E3IbgFspsB5k8OJDzwgKOi8M6nagcT6l8DAsUJQD6ojUmk5pcM2OuBnONApMQBDlvb2OLRUToNLxPadZpT1/WBlw9TWoS8hgmQS6/t4c3N8W0NBmOtKgP9imCl19IZ+ZMlVrWhlRMlXQqhK/fcJF1yt0Y3fra1NE7Gx4/igLi2AoU9hCFNCKuBnF2VU6V1RCVBxwZnKtrjWnvCn/SfT/aeoMpANMjKrANjC3g3wj+DbL8GmB4YsVFkyuDQ0uTi9+fD62ay19EtHTH3Km/mFV8Lac4NVvVTYdybgE43+FIQdVgeqA/bztr7xyfTcRbIGxSeAOcROEfegCvqpPyqQJdFWOpuPomY2XJiH9S0m/Au4B3nIXwLxr6BpZP6H3/wsfP68+mRlL6rtun+azavNS8kqzi/PTCAicVpluL/vNgM3OLT+su92TFfsgv4W8kQRn4tiNDExiaXXR4KLpIFPfX1nBJ6YwJkvuyE4byFi5496OwqOByKtSuCal2lmtlpc/EzAzSFfO8Kbk3M2Ewd5gPJNMBPcewNtLPLk3iwEh7k/NubUk8L2plA83H+6rwBO9Ppru0ZlXj5RNURRiGrXaCVWMsL0upqcTVqjFOwCKFBKAGdMF84D1iKcZsU2DVknNzUlmZRDDiZwqdhgUKSYol37pFJRnvAtekWJLAGxu4okJSPxOaFhn5r5hP9HfASfKdBbJI0/s0gxF0esSFsZWOY0s5OTLp54cNBiLR2wvrzsxf4mR4IHciJRRr3AWyqOweGLyxh3bMK4x8Q38BmzUwlIDtkJwAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 26 18 15 32" title="" data-src="/static/2022-07-26-18-15-32-8c4576eaf7e5e96d1a2bd07869a8ce07-34a30.png" data-srcset="/static/2022-07-26-18-15-32-8c4576eaf7e5e96d1a2bd07869a8ce07-b25ce.png 200w,\n/static/2022-07-26-18-15-32-8c4576eaf7e5e96d1a2bd07869a8ce07-34a30.png 256w" data-sizes="(max-width: 256px) 100vw, 256px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>假设我们要将它绘制在屏幕的 2×2 个像素上，那么这 4 个像素应该使用什么颜色？这里有 256 个像素可以选择，如果在 Photoshop 中将 16×16 的图像缩放到 2×2，它会将每个角 8×8 的像素的平均值赋给这四个像素。不幸的是绘制 64 个像素再求平均在 GPU 中是非常慢的。假设你有一个 2048x2048 像素的纹理想要绘制成 2x2 个像素，就需要对 1024x1024 或 100 万个像素求平均 4 次，这需要很多运算同时速度要快。</p>\n<p>事实上 GPU 使用的是一个纹理贴图（mipmap），纹理贴图是一个逐渐缩小的图像集合，每一个是前一个的四分之一大小，16×16 纹理的纹理贴图看起来像这样。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-26-18-24-47-bc31dae316644e46d87d7becef503a8e-49396.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 526px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 49.80988593155894%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAACn0lEQVQoz32SXUiTURjHn80tv0bqzNaasq2cLsWP0C5UKGdqNpdZ6pwlpNB0pmgTl9bmhWkl9kEISmlDzVZ+ZOit4kXCLr0IQiIsIp2ubGS9e31nbu/Tu4lIEP5unv+Bc36cw//Ah4mJNYdAsLEK4NwEIKtU1aT2nI4kmPyTBc4F8N9IFZc65ju7bN9EQtfDZIXzPS+cuhyc/uNJQ9vXwRPZzorjuUt3L2q2imLi3oKDIDZwbg6Ruw8RAPWlBqxTG3x5i83BPH4JsqSNm58/flonzC+wO60Ym2NUGCa96hroGXVbjA2oyspdvFNYpMuOFItgZdnmRAZqZpZGFtC1Sh1tUDfQjJBWCEtpkJgwUFxDNbePONoG5rGis8Vd35GF11syiDFd2eBkosii5ifoYQf3HyeJ29BonUFT431UKU2YBSUI/C4agozMNFDz7xZ/LY++wf4qOTZlZOLhBK0TQCDa8TwqLOCkCaUsKKzsJTW1L1FdPUSX17/C+PJnWPmgBsct0Tg6JKfHh2VoNidRtv4+myv+CGVWCokFfqhLHZBrB2lFtFd2PirfzzuxIx+g4EoPqa6xYLHWTJdox/FMdx32zR7FsedyfD0s80yOxOJgv+y7BkB+E0CckyaRmnkgfcwBMRxM53hFqYERvlu2RYYAbFK/d588Z8V7vWexTJ+Op6AMIbzdAyEmhP1Nq8CRcOF/hOb9u161rfiErulppgguttQfw9vGZF/Lpw8Ve0DSitzIWntY8AGed78iLpr9lMdmXeJGsYCf6XOIAmW7wjWCINFqRU+Av7dZbDWmYvOtFJ+QYvt5ciI0CCK9PRYg2HcgRAF78mVqinQJBLjOfBOv5EZjIhqaktDNZBeAZ4kdhCnhF+wgvBa0LTy5p+8v8/lJy1AQEzkAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 26 18 24 47" title="" data-src="/static/2022-07-26-18-24-47-bc31dae316644e46d87d7becef503a8e-49396.png" data-srcset="/static/2022-07-26-18-24-47-bc31dae316644e46d87d7becef503a8e-68c83.png 200w,\n/static/2022-07-26-18-24-47-bc31dae316644e46d87d7becef503a8e-d339c.png 400w,\n/static/2022-07-26-18-24-47-bc31dae316644e46d87d7becef503a8e-49396.png 526w" data-sizes="(max-width: 526px) 100vw, 526px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>通常每个子图都是前一级的双线性插值，这就是 <code class="language-text">gl.generateMipmap</code> 做的事情，它根据原始图像创建所有的缩小级别，你也可以自己提供缩小级别的图像。</p>\n<p>现在如果你想将 16x16 像素的纹理绘制到屏幕的 2×2 个像素上，WebGL 会从创建的贴图中找到从之前级别贴图插值出的 2×2 贴图来使用。</p>\n<p>你可以为纹理选择不同的贴图筛选条件来控制 WebGL 的插值，一共有这 6 种模式</p>\n<ol>\n<li><code class="language-text">NEAREST</code> 从最大的贴图中选择 1 个像素</li>\n<li><code class="language-text">LINEAR</code> 从最大的贴图中选择 4 个像素然后混合</li>\n<li><code class="language-text">NEAREST_MIPMAP_NEAREST</code> 选择最合适的贴图，然后从上面找到一个像素</li>\n<li><code class="language-text">LINEAR_MIPMAP_NEAREST</code> 选择最合适的贴图，然后取出 4 个像素进行混合</li>\n<li><code class="language-text">NEAREST_MIPMAP_LINEAR</code> 选择最合适的两个贴图，从每个上面选择 1 个像素然后混合</li>\n<li><code class="language-text">LINEAR_MIPMAP_LINEAR</code> 选择最合适的两个贴图，从每个上选择 4 个像素然后混合</li>\n</ol>\n<p>你可以通过这两个例子看到贴图的重要性，第一个显示的是使用 NEAREST 或 LINEAR，只从最大的贴图上选择像素，当物体运动时就会出现抖动。由于每个像素都从最大的图上选择，随着位置和大小的改变，可能会在不同的时间选择不同的像素，从而出现抖动。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/vqm8in?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>观察发现左边和中间的抖动会多于右边。由于右边的使用多级贴图并且混合颜色，绘制的越小 WebGL 挑选的像素离原图关系越远。相反的中间的小图虽然使用了 LINEAR 混合 4 个像素的颜色，但这 4 个像素是从大图中选出来，不同的选择会有较大的差别，所以还是抖动明显。右下角的图保持颜色一致是从右中图中挑选的像素。</p>\n<p>第二个例子显示了一些深入屏幕中的多边形。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/b83r9o?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>6 个深入屏幕的横梁使用的是之前 6 种不同的筛选模式。</p>\n<ol>\n<li>左上使用的是 NEAREST，你会感受到明显的块状感；</li>\n<li>中上使用的是 LINEAR 也没有好到哪里去；</li>\n<li>右上使用的是 <code class="language-text">NEAREST_MIPMAP_NEAREST</code>，点击图像切换纹理，每个贴图都是不同的颜色，就可以清除的看出它使用的是哪个贴图；</li>\n<li>左下使用的是 <code class="language-text">LINEAR_MIPMAP_NEAREST</code>，意思是挑选最合适贴图种的 4 个像素进行混合，你会发现贴图切换的部分非常突兀；</li>\n<li>中下使用的是 <code class="language-text">NEAREST_MIPMAP_LINEAR</code>，也就是找到最合适的两个贴图各取一点进行混合，如果仔细看会发现仍然有块状感，尤其是水平方向；</li>\n<li>右下使用的是 <code class="language-text">LINEAR_MIPMAP_LINEAR</code>，也就是选出最合适的两个贴图各取 4 个点进行混合。</li>\n</ol>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-26-18-34-03-6c7c1846ba421cf1738ee8da2c7aeac3-d1477.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 536px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.50746268656717%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAACFklEQVQoz4WSTWgTURDHZ5MYSbWpscSPJiD21IOiN0HwKl578vPgsQcpQgKpbWzTtGXbID15aA8ieBOhHlq9FC9eA2ov9SCil2iyKc2y2feR3eybvskaRCp0luHtvn3zm//MPCiC5EUQ7jQIVh4UzLYE6/iCMSZc35eiVtu3Uql9C0CKfI67iB1uWU6rDvDTe/7CbeBurWnlxOyn8urkxrubUAbEee1z2pcHEb02/mN7e4IBkCMWCv3djt/e2vSxPI/OvYfVX5gbxwk4BmQEKxlKzYJSZlIpYSuFqFTQpRXRbrF2ocCcfF4nnVPdygqiudThXxFX5YO7678BbhMH9bP++mUUSBnBinpdGtC53b6KECg9rjVzTu+VCiIpBQi4ZiTgj3VfXYuNYyb8oDJJGcGenUd0aiGUlPp6bTV4u9nUrULFTLPraJhIJLzG9Rsfz1H8NlyKhgoBrHgcgHpGwQQhGEEJrpMEKzrZ4inRWHuyfaH67e3wo4n3Z5PJrTPZ7Gb6ytXlCIHuZO73hH1Ip8EcG6MC/pZHUIIVwzYE1N8ZEPXLsBuH/1gm++bwJoHCAYQDofKpp6WIChb036dRUZ+6+OUknZ269T1iGDvG6eHPxujoWi9+ZGTjMLBvVD71lAZV0r5IwIi0Hg/tnKCz0zEbjjQpJedcuHSZ6VIvDAmmy2Ramath3kzM/jGZqg70FB6vH8k7ABn0sfdqxp2tAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 26 18 34 03" title="" data-src="/static/2022-07-26-18-34-03-6c7c1846ba421cf1738ee8da2c7aeac3-d1477.png" data-srcset="/static/2022-07-26-18-34-03-6c7c1846ba421cf1738ee8da2c7aeac3-bb263.png 200w,\n/static/2022-07-26-18-34-03-6c7c1846ba421cf1738ee8da2c7aeac3-9a78f.png 400w,\n/static/2022-07-26-18-34-03-6c7c1846ba421cf1738ee8da2c7aeac3-d1477.png 536w" data-sizes="(max-width: 536px) 100vw, 536px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>你可能会想既然理论上 <code class="language-text">LINEAR_MIPMAP_LINEAR</code> 是最好的选择为什么还要有其他选择</p>\n<ol>\n<li><code class="language-text">LINEAR_MIPMAP_LINEAR</code> 是最慢的，读 8 个像素比读 1 个像素慢一些，在现代的 GPU 上如果一次使用一个贴图可能没什么问题，但是现在的游戏可能一次就需要 2 到 4 个贴图，4 贴图 * 8 像素每贴图 = 绘制每个像素需要读取 32 个像素，那就会慢很多了。</li>\n<li>如果想实现特定的效果，比如做一些复古的东西可能就需要使用 NEAREST。贴图也占用内存，事实上它占用额外 33% 的内存，那是非常多的内存，尤其是使用很大的纹理例如想要在游戏的标题屏幕上绘制的东西。如果你不会绘制比最大的贴图要小的东西，为什么要把内存浪费在贴图上，直接使用 NEAREST 或 LINEAR 就只使用第一个贴图。</li>\n</ol>\n<p>设置筛选器可以调用 <code class="language-text">gl.texParameter</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49899443426773615000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_LINEAR);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);`, `49899443426773615000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR_MIPMAP_LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<ul>\n<li><code class="language-text">TEXTURE_MIN_FILTER</code> 是当绘制的比最大贴图小的时候。</li>\n<li><code class="language-text">TEXTURE_MAG_FILTER</code> 是绘制的比最大的贴图大的时候。</li>\n<li>对于 <code class="language-text">TEXTURE_MAG_FILTER</code> 只有 NEAREST 和 LINEAR 两个可选设置。</li>\n</ul>\n<p>假设我们想使用这个纹理。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-27-11-18-57-ed68bb1d941ff88c000e39ce803fc505-4493b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 320px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsSAAALEgHS3X78AAADaElEQVQozxVRaVcaZxh9Z4CZgRlmnMyArLLIolhlcaWIrFG2pmg8LohoNcegLUEhCG5piFZjBRPSaM7pMamk1Hh6mn7ol35p+9v6+u2e5973Pve5L5jPLLQRouiDqYNiDgCQ3cxHImEIdvaf7ZWfCgDoUClkUpIUIo3z08ZJdcSinot4cysLj772AwxFRJi4XN65P+yCb8IhX4ec5Rjm5vbTeGCsTYK/u77qULSTmPDXm98yi2moMXcaWFJCCgUgExpZnYq1Xh+HB3rMGoWckeIIMur1335qsXcLUWefjUKB3d77379/93VbxAAkJ+N6jQaDNlaeGtLLN9eWW9WN76L9xWn/esJ98WK79fal26ZzdpvUfBuGgIXUXPP6ZxGKihFA4xgpQDmGAl2WTmgxu7j8/VYWuiqlhFUm7Tdpa9WdP2qljdhAZT5UmA3evv2h+eY46LIE3E6LXsNT4k6TARjVMlpCnp+9DPbbWEqSLz7RtvMIAPXG68rWt9BXw9JWFdejUx6Vc//8cpp7MFya8RZmRo/zd/eDPufgq+eVexiqU8mXlmYVDGnU6//6fON22CgRmoiNKzkWysqlfO3kEAWAE+MqKdGlkYH7zq7dx5n97KIEw2CFKApZEInFmxd1lhDJadJu62JwISMhrq/eraZmIe3zeDzuMQLGS/sc1cdz5/n5vRnPk6Tnm5jHY7ee7G7t57MoglASEpYEizUZjJ9bzcE+OwFAPBqfmpqHnQHIcYyUI0Rzk9HfX6wtjdk2k6NXh9uXexu5+GA6NJjwDnQbtF9Fwh8uGpREiqOIRIhSQgGNCcD0w0mrTg0jZNezhZUUzEwTRHsbbVIqUrHwn2elymyoMO1/f1z6+OZkOTISG7Y5u4xGrYqjpcDvHZVRBHdPdn54MNZrpnHhRDBk0evgbYHx+M3HJs/yuEDEs5zL7kj4hurF1avt9MFStDgXBgIUFQIwOPTlWWmdF4sULJNKrXS0y+CdpUrl6NkBCpAOtcrpcIkxHOYqlJ4eVZ+zDNdrNYNgr1krl2WS8dXkBOQoAZBRJIsLeY6/uLxMzy/Aodfr3zuswf1SSvqqcZ5O3Q1JTATWJjw7D/2NR4ndaV+gR+fqtalVSvi9JrP1p/qPX/Q4oK6NZnm5EgKtwVirn3q8PoiDwcD/9JnJ+bKL33UAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 27 11 18 57" title="" data-src="/static/2022-07-27-11-18-57-ed68bb1d941ff88c000e39ce803fc505-4493b.png" data-srcset="/static/2022-07-27-11-18-57-ed68bb1d941ff88c000e39ce803fc505-102e5.png 200w,\n/static/2022-07-27-11-18-57-ed68bb1d941ff88c000e39ce803fc505-4493b.png 320w" data-sizes="(max-width: 320px) 100vw, 320px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这是结果。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/ibn1oh?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>为什么键盘的纹理没有出现？那是因为 WebGL 限制了纹理的维度必须是 2 的整数次幂，2 的幂有 <code class="language-text">1, 2, 4, 8, 16, 32, 64, 128, 256, 512, 1024, 2048</code> 等等。<code class="language-text">F</code> 纹理是 256 × 256，256 是 2 的幂。键盘纹理是 320x240，都不是 2 的幂，所以显示纹理失败，在着色器中当 texture2D 被调用的时候由于纹理没有正确设置，就会使用颜色 <code class="language-text">(0, 0, 0, 1)</code> 也就是黑色。如果打开 JavaScript 控制台或者浏览器控制台，根据浏览器不同可能会显示不同的错误信息，像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34796229613504460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`WebGL: INVALID_OPERATION: generateMipmap: level 0 not power of 2\n   or not all the same size\nWebGL: drawArrays: texture bound to texture unit 0 is not renderable.\n   It maybe non-power-of-2 and have incompatible texture filtering or\n   is not \'texture complete\'.`, `34796229613504460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">WebGL: INVALID_OPERATION: generateMipmap: level 0 not power of 2\n   or not all the same size\nWebGL: drawArrays: texture bound to texture unit 0 is not renderable.\n   It maybe non-power-of-2 and have incompatible texture filtering or\n   is not &#39;texture complete&#39;.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>解决这个问题只需要将包裹模式设置为 <code class="language-text">CLAMP_TO_EDGE</code> 并且通过设置过滤器为 <code class="language-text">LINEAR or NEAREST</code> 来关闭贴图映射。</p>\n<p>让我们来更新图像加载的代码解决这个问题，首先需要一个方法判断一个数是不是 2 的幂。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61365315273793450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function isPowerOf2(value) {\n  return (value & (value - 1)) == 0;\n}`, `61365315273793450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">isPowerOf2</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>value <span class="token operator">&amp;</span> <span class="token punctuation">(</span>value <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>我不准备深入讲解二进制运算，以及它的的原理。有了它后，就可以这样使用。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/g387je?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="6-个面"><a href="#6-%E4%B8%AA%E9%9D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6 个面</h2>\n<p>一个常见的问题是 <code class="language-text">如何为立方体的每个面设置不同的图像？</code>，假设我们有 6 个这样的图片。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-27-11-25-05-5de944cbd03733d24939020a6120f6c2-ad3a8.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 396px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 69.1919191919192%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAAEAElEQVQ4yxWRW0yTBwCF/2SOxagM5pQoq4CuoKiASpGGu2i5CBStglWGXIWyf4AKAwq0Ugad0mq1SFELTDaYiAoIiJepRLwEAph5QUFFnXFuS3zcEh+Wb+zhPJ7z5Zwj3Ou289hezHitivGqBO5q4xipFxnvsDB4UMPtGjW/95bx4bmdkZOlTDXtZ/LKj1w5+wONubuwqRQcVcdi1Ru42N2HMKZXMpi4iAn9Jh6IMkZS3BkI+oTB8h10ZocyVhDAr21h3GyR87SpmOEDCdxpKKF9exTtG32xBHmhXelK8jwH4uVyhFuaMM6XyjAX+VO1YwUm5UrawhdyIyOIF7Xx/NmZT59xI816OW+v1THRUkjH7khGNdFM/HSU232HqS+Oo3XzGso8XBCGxGC0qR4klXmSJa4gJ0aKNlxKz4zpb1sM7wYqmbxu4fFlM6+GTjFYl8aZzE3c3elPty6NoR4LHSXJNKx3x+K/DOFO6UYqIpeQlezN5q0eJKu8SVi3BL06lOFvQxipSpypupdHnbX8UpdKof9C2tKjGFP50BDogTklHnOEDIPLHMok8/8PjKRZ9jHNKg9EuROqtXPx83XimCGLXrUv9oBZjCY6ciHSGeua2RySzWXEpmPgayX1rg7YAlw4KHWkxPEjWjRpCP+8HOX9tWZedegZPVrE/RYzr4cHeHzjEk9OmnjbcYRpewW/2St5d/YwTxu/Z6znHNMvJpjobefRaRM3G0zc6+/h/t0bCMYaA9k5uewTRcpLSygoKmKbajv2Bgvvb7by7PRBnvx8hKk+Oy8Hz/HH8/uMDvbxorWRWzYr79+9Zur2df6aGmegqREhyFOCsyAgmZHcxRl1iA+m6ly6WowY4mZmSFnKXs1aNCpfCn0W0Kz0o8tawfgZC5NNBbxp2sn0CTUP6tO5pEtBSFntzWonR9YucsZ38WzyYlaxWyEnY3ssplOp5FTFUKJVkhYhJ0HqSrtGybNbfUwcT+ZDayRXLeHsS/VCFyXBmr8eoeWraJQL5pC0QcbVRh3D3SL9x9U0GTPp70rncus3bF7tScSihWwLkmKIl9JZlMW0LZZH1cHUZIURHPwloQFuKDZ4Izw0ZjBWoeZencjDNhun87cwad1B/7E8KgoisFWq0WZuIXyxK6KPhPLFs+gqzuB1r40hwx6M+4PJF/3ISfKiukCGcKE2j39H7LxpFLmYF4lJ5oLVx5G63Qq0M8TqdV9glrlR7Sehevmn6NwdqN+TjH7XVmrVCvap/SjZ4kqbKOV8gR/C8qXuhKxww56toCw+kANxq9ArZs5Iiua7wGXols3D6Ps5hS4OlPtLuFSTi+2QDrf5n5EZ6IU5I4zK9FBO7FpHdsgq/gPV0ZSNWhnZqgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 27 11 25 05" title="" data-src="/static/2022-07-27-11-25-05-5de944cbd03733d24939020a6120f6c2-ad3a8.png" data-srcset="/static/2022-07-27-11-25-05-5de944cbd03733d24939020a6120f6c2-2a85e.png 200w,\n/static/2022-07-27-11-25-05-5de944cbd03733d24939020a6120f6c2-ad3a8.png 396w" data-sizes="(max-width: 396px) 100vw, 396px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>脑中出现了 3 个答案</p>\n<ol>\n<li>\n<p>制作一个复杂的着色器，引用 6 个纹理，传入一些额外的顶点信息表明使用的纹理是什么。不要这样做！稍微一想就知道你要写一大堆不同的着色器应用于不同面数量的图形之类。</p>\n</li>\n<li>\n<p>绘制 6 个面代替立方体，这是常用的解决办法，不错但是只能用在简单的图形例如立方体。如果有一个包含 1000 个方形的图形就要绘制 1000 个面，会非常慢。</p>\n</li>\n<li>\n<p>我敢说，最好的方法就是将图像放在一个纹理中，然后利用纹理坐标映射不同的图像到每个面，这是很多高性能应用（读作游戏）使用的技术。例如我们将所有的图像放入这样一个纹理中</p>\n</li>\n</ol>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-27-11-25-42-8e1dad0514f14feaa56c6d74c490f512-bb96f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 512px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAACFElEQVQoz2PYWJN+uCP33saOqysaV1QkzosyO9vh8PZk6rm5WRd7I7aXOczJNplZ4Lgs32drTxEfHw8DAwMjIyMDBJyam/l5jdemVv0JiSrTMnT2FJvdnO6+vEPyyvLcU93BNRXmmY12SZFWoepiC7J8hISFUDRfmOR3qdMiI87Q1FLG21b0dr/l0911J9bVPjo6eXW156wJDjO6Yu2kZcPMFNp8tbhZWEGaGWBga2fx0tLoiky1+lS5GbkK27JUz9Y53FyQs7nUpdpGuDJEoz/RIdVEPV+Zp0SCkR2sBaHZ0VCvyM+0JFxrSprehGj9eQG6a/1EN/oKzLAXnuKu2uag2mEh02Yi0emgOifDm4eLA+xsmOZ19RH78yzOlVvsSdaak+Jgpy5rLCkYYKgc6WqanxyyoKmo21GvVkO4xMWmqaGRg4MDxc+HkhS3l2quzNFdGyS2wYnbUZxPnotdW5i1IMQiO8pjSZD56eashZXBjZZyYZKCLMzMDMhgTbxicrFMfKZMjofSdHflJlOZcAOl5V35R1amzCtz2OyvfGBS4bal9fOD9FtVBdH9vDpCrNRHLjpc3sdd2kNf+EJ/4ruVVUc7cxdGm2/Js1rvrTjdXGpCqGOTLHeZkhgXBzuK5hNNvpuipCf7ixe7KpZn+yX4Wa2tDp2XbN3vKl7lorR6Yt1KP6OZlhKdtgbL2qt5eVESCQBl2rROD+pDJwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 27 11 25 42" title="" data-src="/static/2022-07-27-11-25-42-8e1dad0514f14feaa56c6d74c490f512-bb96f.png" data-srcset="/static/2022-07-27-11-25-42-8e1dad0514f14feaa56c6d74c490f512-7728b.png 200w,\n/static/2022-07-27-11-25-42-8e1dad0514f14feaa56c6d74c490f512-23f96.png 400w,\n/static/2022-07-27-11-25-42-8e1dad0514f14feaa56c6d74c490f512-bb96f.png 512w" data-sizes="(max-width: 512px) 100vw, 512px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>然后为立方体的每个面设置不同的纹理坐标。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37969039411497570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 选择左下图\n0   , 0  ,\n0   , 0.5,\n0.25, 0  ,\n0   , 0.5,\n0.25, 0.5,\n0.25, 0  ,\n// 选择中下图\n0.25, 0  ,\n0.5 , 0  ,\n0.25, 0.5,\n0.25, 0.5,\n0.5 , 0  ,\n0.5 , 0.5,\n// 选择中右图\n0.5 , 0  ,\n0.5 , 0.5,\n0.75, 0  ,\n0.5 , 0.5,\n0.75, 0.5,\n0.75, 0  ,\n// 选择左上图\n0   , 0.5,\n0.25, 0.5,\n0   , 1  ,\n0   , 1  ,\n0.25, 0.5,\n0.25, 1  ,\n// 选择中上图\n0.25, 0.5,\n0.25, 1  ,\n0.5 , 0.5,\n0.25, 1  ,\n0.5 , 1  ,\n0.5 , 0.5,\n// 选择右上图\n0.5 , 0.5,\n0.75, 0.5,\n0.5 , 1  ,\n0.5 , 1  ,\n0.75, 0.5,\n0.75, 1  ,`, `37969039411497570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">// 选择左下图\n0   , 0  ,\n0   , 0.5,\n0.25, 0  ,\n0   , 0.5,\n0.25, 0.5,\n0.25, 0  ,\n// 选择中下图\n0.25, 0  ,\n0.5 , 0  ,\n0.25, 0.5,\n0.25, 0.5,\n0.5 , 0  ,\n0.5 , 0.5,\n// 选择中右图\n0.5 , 0  ,\n0.5 , 0.5,\n0.75, 0  ,\n0.5 , 0.5,\n0.75, 0.5,\n0.75, 0  ,\n// 选择左上图\n0   , 0.5,\n0.25, 0.5,\n0   , 1  ,\n0   , 1  ,\n0.25, 0.5,\n0.25, 1  ,\n// 选择中上图\n0.25, 0.5,\n0.25, 1  ,\n0.5 , 0.5,\n0.25, 1  ,\n0.5 , 1  ,\n0.5 , 0.5,\n// 选择右上图\n0.5 , 0.5,\n0.75, 0.5,\n0.5 , 1  ,\n0.5 , 1  ,\n0.75, 0.5,\n0.75, 1  ,</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/7he08e?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>这种将多个图像通过一个纹理提供的方法通常被叫做纹理图集，它是最好的方式，因为只需要加载一个贴图，着色器也会因为只用一个贴图而保持简单，不同于多个平面需要多次调用绘制，这样只需要调用一次绘制。</p>\n<h2 id="uvs-vs-纹理坐标"><a href="#uvs-vs-%E7%BA%B9%E7%90%86%E5%9D%90%E6%A0%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>UVs vs. 纹理坐标</h2>\n<p>纹理坐标经常被简写为 <code class="language-text">texture coords</code>，<code class="language-text">texcoords</code> 或 UVs(发音为 Ew-Vees)，我不知道术语 UVs 是从哪来的，除了一点那就是顶点位置使用 <code class="language-text">x, y, z, w</code>，所以对于纹理坐标他们决定使用 <code class="language-text">s, t, u, v</code>，好让你清楚使用的两个类型的区别。有了这些你可能会想它应该读作 Es-Tees，因为纹理包裹的设置被叫做 <code class="language-text">TEXTURE_WRAP_S</code> 和 <code class="language-text">TEXTURE_WRAP_T</code>，但是出于某些原因我的图形相关的同事都叫它 Ew-Vees。</p>\n<p>所以现在你就知道了如果有人说 UVs 其实就是再说纹理坐标。</p>\n<h1 id="webgl-数据纹理"><a href="#webgl-%E6%95%B0%E6%8D%AE%E7%BA%B9%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 数据纹理</h1>\n<p>上节中讲到了纹理的工作原理以及如何使用，我们用下载的图像创建纹理，在这篇文章中我们将直接用 JavaScript 创建数据。</p>\n<p>用 JavaScript 为纹理创建数据是比较直接的，默认情况下 WebGL1 只支持少量数据类型的纹理</p>\n<table>\n<thead>\n<tr>\n<th align="left">格式</th>\n<th align="left">数据类型</th>\n<th align="left">通道数</th>\n<th align="left">单像素字节数</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">RGBA</td>\n<td align="left">UNSIGNED_BYTE</td>\n<td align="left">4</td>\n<td align="left">4</td>\n</tr>\n<tr>\n<td align="left">RGB</td>\n<td align="left">UNSIGNED_BYTE</td>\n<td align="left">3</td>\n<td align="left">3</td>\n</tr>\n<tr>\n<td align="left">RGBA</td>\n<td align="left"><code class="language-text">UNSIGNED_SHORT_4_4_4_4</code></td>\n<td align="left">4</td>\n<td align="left">2</td>\n</tr>\n<tr>\n<td align="left">RGBA</td>\n<td align="left"><code class="language-text">UNSIGNED_SHORT_5_5_5_1</code></td>\n<td align="left">4</td>\n<td align="left">2</td>\n</tr>\n<tr>\n<td align="left">RGB</td>\n<td align="left"><code class="language-text">UNSIGNED_SHORT_5_6_5</code></td>\n<td align="left">3</td>\n<td align="left">2</td>\n</tr>\n<tr>\n<td align="left">LUMINANCE_ALPHA</td>\n<td align="left">UNSIGNED_BYTE</td>\n<td align="left">2</td>\n<td align="left">2</td>\n</tr>\n<tr>\n<td align="left">LUMINANCE</td>\n<td align="left">UNSIGNED_BYTE</td>\n<td align="left">1</td>\n<td align="left">1</td>\n</tr>\n<tr>\n<td align="left">ALPHA</td>\n<td align="left">UNSIGNED_BYTE</td>\n<td align="left">1</td>\n<td align="left">1</td>\n</tr>\n</tbody>\n</table>\n<p>让我们创建一个 3×2 像素的 LUMINANCE（亮度/黑白）纹理，由于它是 LUMINANCE 纹理，所以每个像素只有一个值，在 R，G，B 通道是相同的。</p>\n<p>我们继续使用上篇文章中的例子，首先修改纹理坐标，每个面使用整个纹理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4409745075314308600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 填充立方体纹理坐标的缓冲\nfunction setTexcoords(gl) {\n  gl.bufferData(\n    gl.ARRAY_BUFFER,\n    new Float32Array([\n      // 正面\n      0,\n      0,\n      0,\n      1,\n      1,\n      0,\n      1,\n      0,\n      0,\n      1,\n      1,\n      1\n      // ...\n    ])\n  );\n}`, `4409745075314308600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 填充立方体纹理坐标的缓冲</span>\n<span class="token keyword">function</span> <span class="token function">setTexcoords</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>\n    gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span>\n    <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n      <span class="token comment">// 正面</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span><span class="token punctuation">,</span>\n      <span class="token number">1</span>\n      <span class="token comment">// ...</span>\n    <span class="token punctuation">]</span><span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后修改代码创建一个纹理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32930893798384497000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建一个纹理\nvar texture = gl.createTexture();\ngl.bindTexture(gl.TEXTURE_2D, texture);\n\n// // 用 1x1 的蓝色像素填充纹理\n// gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE,\n//               new Uint8Array([0, 0, 255, 255]));\n\n// 用 3x2 的像素填充纹理\nconst level = 0;\nconst internalFormat = gl.LUMINANCE;\nconst width = 3;\nconst height = 2;\nconst border = 0;\nconst format = gl.LUMINANCE;\nconst type = gl.UNSIGNED_BYTE;\nconst data = new Uint8Array([128, 64, 128, 0, 192, 0]);\ngl.texImage2D(gl.TEXTURE_2D, level, internalFormat, width, height, border, format, type, data);\n\n// 设置筛选器，我们不需要使用贴图所以就不用筛选器了\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n\n// // 异步加载图像\n// ...`, `32930893798384497000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建一个纹理</span>\n<span class="token keyword">var</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// // 用 1x1 的蓝色像素填充纹理</span>\n<span class="token comment">// gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE,</span>\n<span class="token comment">//               new Uint8Array([0, 0, 255, 255]));</span>\n\n<span class="token comment">// 用 3x2 的像素填充纹理</span>\n<span class="token keyword">const</span> level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> internalFormat <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> width <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> height <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> border <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> format <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> type <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> level<span class="token punctuation">,</span> internalFormat<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> border<span class="token punctuation">,</span> format<span class="token punctuation">,</span> type<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 设置筛选器，我们不需要使用贴图所以就不用筛选器了</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// // 异步加载图像</span>\n<span class="token comment">// ...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/h9ssxi?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>发现不生效，查看 JavaScript 控制台看到这样的错误信息</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10542688466442240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`WebGL: INVALID_OPERATION: texImage2D: ArrayBufferView not big enough for request`, `10542688466442240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">WebGL: INVALID_OPERATION: texImage2D: ArrayBufferView not big enough for request</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>结果是 WebGL 中有一种首次创建 OpenGL 后的模糊设定，计算机有时在数据为某些特定大小时速度会快一些，例如一次拷贝 2，4 或 8 个字节比一次拷贝 1 个字节要快，WebGL 默认使用 4 字节长度，所以它期望每一行数据是多个 4 字节数据（最后一行除外）。</p>\n<p>我们之前的数据每行只有 3 个字节，总共为 6 字节，但是 WebGL 试图在第一行获取 4 个字节，第二行获取 3 个字节，总共 7 个字节，所以会出现这样的报错。</p>\n<p>我们可以告诉 WebGL 一次处理 1 个字节</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92421330762618490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const alignment = 1;\ngl.pixelStorei(gl.UNPACK_ALIGNMENT, alignment);`, `92421330762618490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> alignment <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_ALIGNMENT</span><span class="token punctuation">,</span> alignment<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>有效参数为 1，2，4 和 8</p>\n<p>我觉得你可能无法计算出对齐数据和非对齐数据的速度区别，所以希望默认值是 1 而不是 4，这样这个问题就不会困扰新手，但是为了适配 OpenGL，所以要保留相同的默认设置，这样移植应用就不用改变行数，然后可以为新的应用在需要的地方设置属性为 1。</p>\n<p>有了这个设置后就能正常运行了</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/25tn1o?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="webgl-渲染到纹理"><a href="#webgl-%E6%B8%B2%E6%9F%93%E5%88%B0%E7%BA%B9%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 渲染到纹理</h1>\n<p>上篇讲到如何利用 JavaScript 向纹理提供数据，这篇文章我们会使用 WebGL 渲染内容到纹理上，这个话题在图像处理中简单讲到过，但这里将详细介绍。</p>\n<p>渲染到纹理非常简单，创建一个确定大小的纹理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20327346017191240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建渲染对象\nconst targetTextureWidth = 256;\nconst targetTextureHeight = 256;\nconst targetTexture = gl.createTexture();\ngl.bindTexture(gl.TEXTURE_2D, targetTexture);\n\n{\n  // 定义 0 级的大小和格式\n  const level = 0;\n  const internalFormat = gl.RGBA;\n  const border = 0;\n  const format = gl.RGBA;\n  const type = gl.UNSIGNED_BYTE;\n  const data = null;\n  gl.texImage2D(\n    gl.TEXTURE_2D,\n    level,\n    internalFormat,\n    targetTextureWidth,\n    targetTextureHeight,\n    border,\n    format,\n    type,\n    data\n  );\n\n  // 设置筛选器，不需要使用贴图\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n}`, `20327346017191240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建渲染对象</span>\n<span class="token keyword">const</span> targetTextureWidth <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> targetTextureHeight <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> targetTexture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> targetTexture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token punctuation">{</span>\n  <span class="token comment">// 定义 0 级的大小和格式</span>\n  <span class="token keyword">const</span> level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> internalFormat <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> border <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> format <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> type <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>\n    gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>\n    level<span class="token punctuation">,</span>\n    internalFormat<span class="token punctuation">,</span>\n    targetTextureWidth<span class="token punctuation">,</span>\n    targetTextureHeight<span class="token punctuation">,</span>\n    border<span class="token punctuation">,</span>\n    format<span class="token punctuation">,</span>\n    type<span class="token punctuation">,</span>\n    data\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置筛选器，不需要使用贴图</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意 data 是 null，我们不需要提供数据，只需要让 WebGL 分配一个纹理。</p>\n<p>接下来创建一个帧缓冲（framebuffer），帧缓冲只是一个附件集，附件是纹理或者 renderbuffers，我们之前讲过纹理，Renderbuffers 和纹理很像但是支持纹理不支持的格式和可选项，同时不能像纹理那样直接将 renderbuffer 提供给着色器。</p>\n<p>让我们来创建一个帧缓冲并和纹理绑定</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43611622905326430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建并绑定帧缓冲\nconst fb = gl.createFramebuffer();\ngl.bindFramebuffer(gl.FRAMEBUFFER, fb);\n\n// 附加纹理为第一个颜色附件\nconst attachmentPoint = gl.COLOR_ATTACHMENT0;\ngl.framebufferTexture2D(gl.FRAMEBUFFER, attachmentPoint, gl.TEXTURE_2D, targetTexture, level);`, `43611622905326430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建并绑定帧缓冲</span>\n<span class="token keyword">const</span> fb <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createFramebuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindFramebuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> fb<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 附加纹理为第一个颜色附件</span>\n<span class="token keyword">const</span> attachmentPoint <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">COLOR_ATTACHMENT0</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">framebufferTexture2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> attachmentPoint<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> targetTexture<span class="token punctuation">,</span> level<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>与纹理和缓冲相似，在创建完帧缓冲后我们需要将它绑定到 FRAMEBUFFER 绑定点，那样所有的方法都会作用到绑定的帧缓冲，无论是哪个帧缓冲。</p>\n<p>绑定帧缓冲后，每次调用 <code class="language-text">gl.clear</code>, <code class="language-text">gl.drawArrays</code> 或 <code class="language-text">gl.drawElements</code> WebGL 都会渲染到纹理上而不是画布上。</p>\n<p>将原来的渲染代码构造成一个方法，就可以调用两次，一次渲染到纹理，一次渲染到画布。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39649415809925360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function drawCube(aspect) {\n  // 告诉它使用的程序（着色器对）\n  gl.useProgram(program);\n\n  // 启用位置属性\n  gl.enableVertexAttribArray(positionLocation);\n\n  // 绑定到位置缓冲\n  gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);\n\n  // 告诉位置属性如何从 positionBuffer (ARRAY_BUFFER) 中读取数据\n  var size = 3; // 每次迭代需要三个单位数据\n  var type = gl.FLOAT; // 单位数据类型为 32 位浮点型\n  var normalize = false; // 不需要单位化\n  var stride = 0; // 每次迭代移动的距离\n  var offset = 0; // 从缓冲起始处开始\n  gl.vertexAttribPointer(positionLocation, size, type, normalize, stride, offset);\n\n  // 启用纹理坐标属性\n  gl.enableVertexAttribArray(texcoordLocation);\n\n  // 绑定纹理坐标缓冲\n  gl.bindBuffer(gl.ARRAY_BUFFER, texcoordBuffer);\n\n  // 告诉纹理坐标属性如何从 texcoordBuffer 读取数据\n  var size = 2; // 每次迭代两个单位数据\n  var type = gl.FLOAT; // 单位数据类型是 32 位浮点型\n  var normalize = false; // 不需要单位化数据\n  var stride = 0; // 每次迭代移动的数据\n  var offset = 0; // 从缓冲起始处开始\n  gl.vertexAttribPointer(texcoordLocation, size, type, normalize, stride, offset);\n\n  // 计算投影矩阵\n\n  // var aspect = gl.canvas.clientWidth / gl.canvas.clientHeight;\n  var projectionMatrix = m4.perspective(fieldOfViewRadians, aspect, 1, 2000);\n\n  var cameraPosition = [0, 0, 2];\n  var up = [0, 1, 0];\n  var target = [0, 0, 0];\n\n  // 计算相机矩阵\n  var cameraMatrix = m4.lookAt(cameraPosition, target, up);\n\n  // 根据相机矩阵计算视图矩阵\n  var viewMatrix = m4.inverse(cameraMatrix);\n\n  var viewProjectionMatrix = m4.multiply(projectionMatrix, viewMatrix);\n\n  var matrix = m4.xRotate(viewProjectionMatrix, modelXRotationRadians);\n  matrix = m4.yRotate(matrix, modelYRotationRadians);\n\n  // 设置矩阵\n  gl.uniformMatrix4fv(matrixLocation, false, matrix);\n\n  // 使用纹理单元 0\n  gl.uniform1i(textureLocation, 0);\n\n  // 绘制几何体\n  gl.drawArrays(gl.TRIANGLES, 0, 6 * 6);\n}`, `39649415809925360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">drawCube</span><span class="token punctuation">(</span><span class="token parameter">aspect</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 告诉它使用的程序（着色器对）</span>\n  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 启用位置属性</span>\n  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>positionLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绑定到位置缓冲</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> positionBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 告诉位置属性如何从 positionBuffer (ARRAY_BUFFER) 中读取数据</span>\n  <span class="token keyword">var</span> size <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 每次迭代需要三个单位数据</span>\n  <span class="token keyword">var</span> type <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">;</span> <span class="token comment">// 单位数据类型为 32 位浮点型</span>\n  <span class="token keyword">var</span> normalize <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 不需要单位化</span>\n  <span class="token keyword">var</span> stride <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 每次迭代移动的距离</span>\n  <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 从缓冲起始处开始</span>\n  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>positionLocation<span class="token punctuation">,</span> size<span class="token punctuation">,</span> type<span class="token punctuation">,</span> normalize<span class="token punctuation">,</span> stride<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 启用纹理坐标属性</span>\n  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>texcoordLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绑定纹理坐标缓冲</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> texcoordBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 告诉纹理坐标属性如何从 texcoordBuffer 读取数据</span>\n  <span class="token keyword">var</span> size <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 每次迭代两个单位数据</span>\n  <span class="token keyword">var</span> type <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">;</span> <span class="token comment">// 单位数据类型是 32 位浮点型</span>\n  <span class="token keyword">var</span> normalize <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 不需要单位化数据</span>\n  <span class="token keyword">var</span> stride <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 每次迭代移动的数据</span>\n  <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 从缓冲起始处开始</span>\n  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>texcoordLocation<span class="token punctuation">,</span> size<span class="token punctuation">,</span> type<span class="token punctuation">,</span> normalize<span class="token punctuation">,</span> stride<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 计算投影矩阵</span>\n\n  <span class="token comment">// var aspect = gl.canvas.clientWidth / gl.canvas.clientHeight;</span>\n  <span class="token keyword">var</span> projectionMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">perspective</span><span class="token punctuation">(</span>fieldOfViewRadians<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> cameraPosition <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> up <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> target <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 计算相机矩阵</span>\n  <span class="token keyword">var</span> cameraMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>cameraPosition<span class="token punctuation">,</span> target<span class="token punctuation">,</span> up<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 根据相机矩阵计算视图矩阵</span>\n  <span class="token keyword">var</span> viewMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>cameraMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> viewProjectionMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>projectionMatrix<span class="token punctuation">,</span> viewMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">xRotate</span><span class="token punctuation">(</span>viewProjectionMatrix<span class="token punctuation">,</span> modelXRotationRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  matrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">yRotate</span><span class="token punctuation">(</span>matrix<span class="token punctuation">,</span> modelYRotationRadians<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置矩阵</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>matrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 使用纹理单元 0</span>\n  gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>textureLocation<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 绘制几何体</span>\n  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意到我们需要传入 aspect 计算投影矩阵，因为目标纹理的比例和画布不同。</p>\n<p>然后这样调用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26699652046197973000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 绘制场景\nfunction drawScene(time) {\n  // ...\n\n  {\n    // 通过绑定帧缓冲绘制到纹理\n    gl.bindFramebuffer(gl.FRAMEBUFFER, fb);\n\n    // 使用 3×2 的纹理渲染立方体\n    gl.bindTexture(gl.TEXTURE_2D, texture);\n\n    // 告诉 WebGL 如何从裁剪空间映射到像素空间\n    gl.viewport(0, 0, targetTextureWidth, targetTextureHeight);\n\n    // 清空画布和深度缓冲\n    gl.clearColor(0, 0, 1, 1); // clear to blue\n    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);\n\n    const aspect = targetTextureWidth / targetTextureHeight;\n    drawCube(aspect);\n  }\n\n  {\n    // 渲染到画布\n    gl.bindFramebuffer(gl.FRAMEBUFFER, null);\n\n    // 立方体使用刚才渲染的纹理\n    gl.bindTexture(gl.TEXTURE_2D, targetTexture);\n\n    // 告诉 WebGL 如何从裁剪空间映射到像素空间\n    gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);\n\n    // 清空画布和深度缓冲\n    gl.clearColor(1, 1, 1, 1); // clear to white\n    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);\n\n    const aspect = gl.canvas.clientWidth / gl.canvas.clientHeight;\n    drawCube(aspect);\n  }\n\n  requestAnimationFrame(drawScene);\n}`, `26699652046197973000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 绘制场景</span>\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token punctuation">{</span>\n    <span class="token comment">// 通过绑定帧缓冲绘制到纹理</span>\n    gl<span class="token punctuation">.</span><span class="token function">bindFramebuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> fb<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 使用 3×2 的纹理渲染立方体</span>\n    gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 告诉 WebGL 如何从裁剪空间映射到像素空间</span>\n    gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> targetTextureWidth<span class="token punctuation">,</span> targetTextureHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 清空画布和深度缓冲</span>\n    gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// clear to blue</span>\n    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span> <span class="token operator">|</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> aspect <span class="token operator">=</span> targetTextureWidth <span class="token operator">/</span> targetTextureHeight<span class="token punctuation">;</span>\n    <span class="token function">drawCube</span><span class="token punctuation">(</span>aspect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token punctuation">{</span>\n    <span class="token comment">// 渲染到画布</span>\n    gl<span class="token punctuation">.</span><span class="token function">bindFramebuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 立方体使用刚才渲染的纹理</span>\n    gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> targetTexture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 告诉 WebGL 如何从裁剪空间映射到像素空间</span>\n    gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 清空画布和深度缓冲</span>\n    gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// clear to white</span>\n    gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span> <span class="token operator">|</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> aspect <span class="token operator">=</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientWidth <span class="token operator">/</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>\n    <span class="token function">drawCube</span><span class="token punctuation">(</span>aspect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>drawScene<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/r4pvwu?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>十分重要的是要记得调用 gl.viewport 设置要绘制的对象的大小，在这个例子中第一次渲染到纹理，所以设置视图大小覆盖纹理，第二次渲染到画布所以设置视图大小覆盖画布。</p>\n<p>同样的当我们计算投影矩阵的时候需要使用正确的比例，我花了无数个小时调试，寻找出现搞笑的渲染结果的原因，最后发现是少调用了一个 gl.viewport 或者都忘了，并使用正确的比例，由于在代码中很少直接调用 gl.bindFramebuffer 所以就容易忘掉这些。所以我把这个方法调用放在一个方法里，像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71836002396272410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function bindFrambufferAndSetViewport(fb, width, height) {\n  gl.bindFramebuffer(gl.FRAMEBUFFER, fb);\n  gl.viewport(0, 0, width, height);\n}`, `71836002396272410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">bindFrambufferAndSetViewport</span><span class="token punctuation">(</span><span class="token parameter">fb<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindFramebuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> fb<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后使用这个方法改变渲染对象，就不容易忘记了。</p>\n<p>还有一个需要注意的事情是我们的帧缓冲没有深度缓冲，只有纹理。这意味着没有深度检测，所以三维就不能正常体现，如果我们绘制三个立方体就会看到这样。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/ybyek1?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>如果仔细看中间的立方体，会看到 3 个垂直绘制的立方体，一个在后面，一个在中间另一个在前面，但是我们绘制的三个立方体是相同深度的，观察画布上水平方向的 3 个立方体就会发现他们是正确相交的。那是因为在帧缓冲中没有深度缓冲，但是画布有。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-28-14-10-24-b7eda206d15b87b9241ff3c5945aa2d2-eb890.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 47.25568942436412%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAAB4UlEQVQoz2P4DwP//iExwZwfn95e29h0Y/eUR0cX/vn97cfvD2C5v//+Q5UygPhg1suf/6NPfJ1w8MHLb/9//fn5/uPHT99f3Dg2886VXd8/PV6wYW7hLOkHHzYDVYP1/4Vq/gvS/Tfr+n+G6XcZcpWl1rYErJ5g0WgTs5LbM5bHo083cEeFwGRhy4kM5WsYdt/N+fXnK8SBDH9AOv9te/GHYe1/FotglnwGhgYGqQleignmUhYMQCAW6iQ7OY1fncEghUnTn9kplWH6cd1nH09BbX78/a/isf8MvQuYHPkZvaWAGthbtNiiPEUi+IWTeC2zZZI2a9pWMuilMZhFMLk7sCRVM5y5tRaqefa1TwyFS5h74piStBkT1RmUdTWXz9dbFyAcyi0YK2C2yKxis3TdVgYVGyYGBpa4OIarl7L//gbq+8MAcvXv38v27RacOIlBmZep3IFh0S255Uu4W/UYMmUZFBk4u9z0Z0XFNzAULGLyjGaoqVb/8/ctJEogAQYy4eHb9x693QwTDvhc/L/t0vGmWRN67+/on1fRf3bbjmdXN+ztnrRLrX0j4/37O8E6/0CdDXLB378QU+Y9+PPw2z9IrP95fuvNmbXfr+78/fwWyH1/fjz/eBkcydB4BgDHYVtYhhduXQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 28 14 10 24" title="" data-src="/static/2022-07-28-14-10-24-b7eda206d15b87b9241ff3c5945aa2d2-fee1c.png" data-srcset="/static/2022-07-28-14-10-24-b7eda206d15b87b9241ff3c5945aa2d2-a67b7.png 200w,\n/static/2022-07-28-14-10-24-b7eda206d15b87b9241ff3c5945aa2d2-0b187.png 400w,\n/static/2022-07-28-14-10-24-b7eda206d15b87b9241ff3c5945aa2d2-fee1c.png 800w,\n/static/2022-07-28-14-10-24-b7eda206d15b87b9241ff3c5945aa2d2-b1a91.png 1200w,\n/static/2022-07-28-14-10-24-b7eda206d15b87b9241ff3c5945aa2d2-eb890.png 1494w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>想要加深度缓冲就需要创建一个，然后附加到帧缓冲中</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36797138208212710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建一个深度缓冲\nconst depthBuffer = gl.createRenderbuffer();\ngl.bindRenderbuffer(gl.RENDERBUFFER, depthBuffer);\n\n// 设置深度缓冲的大小和 targetTexture 相同\ngl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16, targetTextureWidth, targetTextureHeight);\ngl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.RENDERBUFFER, depthBuffer);`, `36797138208212710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建一个深度缓冲</span>\n<span class="token keyword">const</span> depthBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createRenderbuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindRenderbuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">RENDERBUFFER</span><span class="token punctuation">,</span> depthBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 设置深度缓冲的大小和 targetTexture 相同</span>\ngl<span class="token punctuation">.</span><span class="token function">renderbufferStorage</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">RENDERBUFFER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_COMPONENT16</span><span class="token punctuation">,</span> targetTextureWidth<span class="token punctuation">,</span> targetTextureHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">framebufferRenderbuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_ATTACHMENT</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RENDERBUFFER</span><span class="token punctuation">,</span> depthBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了这个以后的结果。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/6lvkt6?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>现在帧缓冲附加了深度缓冲以后内部的立方体也能正确相交了。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-28-14-11-01-de07cce6dec3e423b4321a8a4721ba21-eb890.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 47.18875502008032%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAAB60lEQVQoz2P4DwZ//oEAmPnvz///P398u7ip69KGput7pt/cPeXMmvpTy0o/3j0Lkv739z8MMECof/9BOq/ev1+1ZYfZni/n3v/6/P7Ww9tHr53c8fTRpQ/vnz2+sefi9Un33h9/8/Ua0C64ZpCNSx58celsY01OZMhyYVi8U235WlUXMY9sYb8gDqMm5+gdLc5Z8mbVDBHLGCpXcD58cR7iBJDNP/7+U9/+j6G5kinXgCVdn8HYRnPrUgFTNeVIRt0oBkEve60lobqVDJlLmRK6WESkGM6fXwrU9ffvb4a/IPf+ib/2n6F2DYsaD+McfQY1BnYXD46CLuF0Dp4UIetUwdJNnLWbGJzSGKVVWQLCGGZMKwBr/sPwG6T5X8+D/wxTX7DriTBHMjFU2YtPrdVcEiYcxy+YIuGwzNxvk6tuGYNaJKNHI5u7F0NBqSHY2f8Y/oA173v9n2HFN4aieIbIBIakFMUlZby9NrxZ4oqeLAz5hvwzA7njGQyzGFXcGH2LGOYfdP/z9ycowCDx8+n3/+Irf2LXbfHsSOzZsHrniztTTuyatH7OhPldMy4caD2+WK2BuXWn3K4bua9/nfj//x9KVEHjCxgH4Nj++/Hdp/MbPl3Z/v7K1v93j90/NHvP9vjP726hxTMAHENVlUPBr4gAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 28 14 11 01" title="" data-src="/static/2022-07-28-14-11-01-de07cce6dec3e423b4321a8a4721ba21-fee1c.png" data-srcset="/static/2022-07-28-14-11-01-de07cce6dec3e423b4321a8a4721ba21-a67b7.png 200w,\n/static/2022-07-28-14-11-01-de07cce6dec3e423b4321a8a4721ba21-0b187.png 400w,\n/static/2022-07-28-14-11-01-de07cce6dec3e423b4321a8a4721ba21-fee1c.png 800w,\n/static/2022-07-28-14-11-01-de07cce6dec3e423b4321a8a4721ba21-b1a91.png 1200w,\n/static/2022-07-28-14-11-01-de07cce6dec3e423b4321a8a4721ba21-eb890.png 1494w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>需要特别注意的是 WebGL 只允许三种附件组合形式。根据 <a href="https://registry.khronos.org/webgl/specs/latest/1.0/#FBO_ATTACHMENTS" target="_blank" rel="nofollow noreferrer noopener">规范</a> 一定能正确运行的附件组合是：</p>\n<ul>\n<li><code class="language-text">COLOR_ATTACHMENT0</code> = <code class="language-text">RGBA/UNSIGNED_BYTE</code> texture</li>\n<li><code class="language-text">COLOR_ATTACHMENT0</code> = <code class="language-text">RGBA/UNSIGNED_BYTE</code> texture + <code class="language-text">DEPTH_ATTACHMENT</code> = <code class="language-text">DEPTH_COMPONENT16</code> renderbuffer</li>\n<li><code class="language-text">COLOR_ATTACHMENT0</code> = <code class="language-text">RGBA/UNSIGNED_BYTE</code> texture + <code class="language-text">DEPTH_STENCIL_ATTACHMENT</code> = <code class="language-text">DEPTH_STENCIL</code> renderbuffer</li>\n</ul>\n<p>对于其他的组合就需要检查用户系统/gpu/驱动/浏览器的支持情况。要检查的话需要创建帧缓冲，附加附件，然后调用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45968708055547290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var status = gl.checkFramebufferStatus(gl.FRAMEBUFFER);`, `45968708055547290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> status <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">checkFramebufferStatus</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果状态是 <code class="language-text">FRAMEBUFFER_COMPLETE</code> 那这种组合就能使用，反之不能使用。你就需要告诉用户他们不走运或者撤销一些方法。</p>\n<blockquote>\n<p><strong>其实 Canvas 本身就是一个纹理</strong></p>\n<p>只是一点小事，浏览器使用上方的技术实现的画布，在背后它们创建了一个颜色纹理，一个深度缓冲，一个帧缓冲，然后绑定到当前的帧缓冲，当你调用你的渲染方法时就会绘制到那个纹理上，然后再用那个纹理将画布渲染到网页中。</p>\n</blockquote>\n<h1 id="webgl-使用多个纹理"><a href="#webgl-%E4%BD%BF%E7%94%A8%E5%A4%9A%E4%B8%AA%E7%BA%B9%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 使用多个纹理</h1>\n<p>现在可能是一个合适的时机去回答“如何使用 2 个或多个纹理？”。</p>\n<p>非常简单，回到几节之前绘制一个图像的着色器，将它升级到使用两个纹理。</p>\n<p>首先改变代码加载两个图像，这其实不是 WebGL 的事情，是 HTML5 和 JavaScript 的事情，但是我也会涉及到。图像加载是异步的，可能需要适应一下。</p>\n<p>基本上有两种方式来处理图像的加载，一种是重构代码，让它在没有纹理的时候运行，当图像加载后，再更新程序。我们会在以后的文章中用到这个方法。</p>\n<p>这个例子中就等两个图像都加载完成后再开始绘制。</p>\n<p>首先修改加载单个图像的方法，非常简单，先创建一个新的 Image 对象，设置加载的 url，然后设置回调函数在图像加载完成后调用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12606645405953510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function loadImage(url, callback) {\n  var image = new Image();\n  image.src = url;\n  image.onload = callback;\n  return image;\n}`, `12606645405953510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">loadImage</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  image<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span>\n  image<span class="token punctuation">.</span>onload <span class="token operator">=</span> callback<span class="token punctuation">;</span>\n  <span class="token keyword">return</span> image<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在来创建一个方法加载一个 URL 序列，并且创建一个图像序列。首先设置 imagesToLoad 为加载图像的个数，然后为每个图像调用 loadImage，当 imagesToLoad 递减到 0 的时候说明所有图像加载完成，调用回调函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63156667777322295000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function loadImages(urls, callback) {\n  var images = [];\n  var imagesToLoad = urls.length;\n\n  // 每个图像加载完成后调用一次\n  var onImageLoad = function () {\n    --imagesToLoad;\n    // 如果所有图像都加载完成就调用回调函数\n    if (imagesToLoad == 0) {\n      callback(images);\n    }\n  };\n\n  for (var ii = 0; ii < imagesToLoad; ++ii) {\n    var image = loadImage(urls[ii], onImageLoad);\n    images.push(image);\n  }\n}`, `63156667777322295000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">loadImages</span><span class="token punctuation">(</span><span class="token parameter">urls<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> images <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> imagesToLoad <span class="token operator">=</span> urls<span class="token punctuation">.</span>length<span class="token punctuation">;</span>\n\n  <span class="token comment">// 每个图像加载完成后调用一次</span>\n  <span class="token keyword">var</span> <span class="token function-variable function">onImageLoad</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token operator">--</span>imagesToLoad<span class="token punctuation">;</span>\n    <span class="token comment">// 如果所有图像都加载完成就调用回调函数</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>imagesToLoad <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">callback</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> imagesToLoad<span class="token punctuation">;</span> <span class="token operator">++</span>ii<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> image <span class="token operator">=</span> <span class="token function">loadImage</span><span class="token punctuation">(</span>urls<span class="token punctuation">[</span>ii<span class="token punctuation">]</span><span class="token punctuation">,</span> onImageLoad<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    images<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后就可以像这样调用 loadImages</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30461480091692495000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function main() {\n  loadImages([\'resources/leaves.jpg\', \'resources/star.jpg\'], render);\n}`, `30461480091692495000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">loadImages</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'resources/leaves.jpg\'</span><span class="token punctuation">,</span> <span class="token string">\'resources/star.jpg\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> render<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>接下来修改着色器使用两个纹理，在这个例子中我们将两个纹理相乘。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4142202592136956400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;fragment-shader-2d&quot; type=&quot;x-shader/x-fragment&quot;>\n  precision mediump float;\n\n  // 纹理\n  uniform sampler2D u_image0;\n  uniform sampler2D u_image1;\n\n  // 从顶点着色器传入的 texCoords\n  varying vec2 v_texCoord;\n\n  void main() {\n     vec4 color0 = texture2D(u_image0, v_texCoord);\n     vec4 color1 = texture2D(u_image1, v_texCoord);\n     gl_FragColor = color0 * color1;\n  }\n</script>`, `4142202592136956400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="html"\n              >\n                <span class="gatsby-code-button-language">html</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fragment-shader-2d<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>x-shader/x-fragment<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">\n  precision mediump float<span class="token punctuation">;</span>\n\n  <span class="token comment">// 纹理</span>\n  uniform sampler2D u_image0<span class="token punctuation">;</span>\n  uniform sampler2D u_image1<span class="token punctuation">;</span>\n\n  <span class="token comment">// 从顶点着色器传入的 texCoords</span>\n  varying vec2 v_texCoord<span class="token punctuation">;</span>\n\n  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n     vec4 color0 <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_image0<span class="token punctuation">,</span> v_texCoord<span class="token punctuation">)</span><span class="token punctuation">;</span>\n     vec4 color1 <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_image1<span class="token punctuation">,</span> v_texCoord<span class="token punctuation">)</span><span class="token punctuation">;</span>\n     gl_FragColor <span class="token operator">=</span> color0 <span class="token operator">*</span> color1<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>需要创建两个 WebGL 纹理对象。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45617657593682350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建两个纹理\nvar textures = [];\nfor (var ii = 0; ii < 2; ++ii) {\n  var texture = gl.createTexture();\n  gl.bindTexture(gl.TEXTURE_2D, texture);\n\n  // 设置参数以便使用任意尺的影像\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\n\n  // 上传图像到纹理\n  gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, images[ii]);\n\n  // 将纹理添加到纹理序列\n  textures.push(texture);\n}`, `45617657593682350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建两个纹理</span>\n<span class="token keyword">var</span> textures <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token operator">++</span>ii<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置参数以便使用任意尺的影像</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 上传图像到纹理</span>\n  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> images<span class="token punctuation">[</span>ii<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 将纹理添加到纹理序列</span>\n  textures<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>WebGL 有一个叫做 <code class="language-text">texture units</code> 的对象，你可以把它看成是一个纹理引用的序列，你需要告诉着色器每个 sampler（取样器）使用哪一个 <code class="language-text">texture unit</code>（纹理单元）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3111894531315995000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 寻找取样器的位置\nvar u_image0Location = gl.getUniformLocation(program, \'u_image0\');\nvar u_image1Location = gl.getUniformLocation(program, \'u_image1\');\n\n// ...\n\n// 设置使用的纹理单元\ngl.uniform1i(u_image0Location, 0); // 纹理单元 0\ngl.uniform1i(u_image1Location, 1); // 纹理单元 1`, `3111894531315995000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 寻找取样器的位置</span>\n<span class="token keyword">var</span> u_image0Location <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_image0\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> u_image1Location <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_image1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 设置使用的纹理单元</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_image0Location<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 纹理单元 0</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_image1Location<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 纹理单元 1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后将每个纹理单元绑定纹理。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20762769914121003000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 设置每个纹理单元对应一个纹理\ngl.activeTexture(gl.TEXTURE0);\ngl.bindTexture(gl.TEXTURE_2D, textures[0]);\n\ngl.activeTexture(gl.TEXTURE1);\ngl.bindTexture(gl.TEXTURE_2D, textures[1]);`, `20762769914121003000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 设置每个纹理单元对应一个纹理</span>\ngl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> textures<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> textures<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用的两个图像像这样</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-29-11-32-39-15dd733961bec34b104f61d9ee1ae05b-32662.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 490px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 37.55102040816327%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAAB80lEQVQY0wHoARf+AJpMW6F2ibVqdNJRTrI7NqJJU5lYYKBQVKNbMY9tTBwgJhUUExoZGRQWFicdH+VhM/9hJ/5gKv9gKf9jLAC1JyTKRSy9UjjKSjfPUkuqYXOyU2OoVleOXjp+YVAGCg0AAAACAgIAAABsbXV9fjrc/TrZ+T7a9D3a7z8AxykhvjEaxUIV01oo13Rgp3donVMrvGpvt5SYkoqNAQMDEhISPD08iIGHosGoAkwJHnoaIMIvHuozIv8+ALMjFcEqGeR0NOtrN9hePJ5bOnxBBqc+I8lmR4xzVgABBSgnJuTm5YF5fQ8uHwDjiAGNZwAeFgDYigP/nwCxFAi1NR7WQh/SPxzXQyK/PiSqQCesU0TBbGuVdW8FCQoAAABERUWVkY4ACBMEs/kFW3ABeLEAw/8Dsf0AskojklYcvCAPxiwU03A2xVwzkDsZck8Vs2o/l2hZBQwOAAAAHR0eu7u6XV9kDiiXAAtKGC7bGSz/HC/3ALFGGYhJD6UqB8AwFuWqT+iDPYs5CmVICZNFDJBWNwQNEQAAACMiI7u/unJfcokRgzkDN6cayNIj/ckk8QC7XkKvdD2xcjnJa0HVg0DAg2qSd2SCYj6WZjGOcVQqLjIhIB8vLS4lKigrFB7xMJD5LoX2LX//LYn/MImAGrQ0ZjSHtgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 29 11 32 39" title="" data-src="/static/2022-07-29-11-32-39-15dd733961bec34b104f61d9ee1ae05b-32662.png" data-srcset="/static/2022-07-29-11-32-39-15dd733961bec34b104f61d9ee1ae05b-ee8ca.png 200w,\n/static/2022-07-29-11-32-39-15dd733961bec34b104f61d9ee1ae05b-15948.png 400w,\n/static/2022-07-29-11-32-39-15dd733961bec34b104f61d9ee1ae05b-32662.png 490w" data-sizes="(max-width: 490px) 100vw, 490px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这就是使用 WebGL 将它们相乘的结果。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/plcqlr?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>有些需要回顾的部分。</p>\n<p>理解纹理单元的简单方式是：所有的纹理方法可以在 <code class="language-text">激活的纹理单元</code> 上使用，<code class="language-text">激活的纹理单元</code> 就是一个全局变量指向你想使用的所有纹理单元，每个纹理单元有两个目标对象，<code class="language-text">TEXTURE_2D</code> 目标和 <code class="language-text">TEXTURE_CUBE_MAP</code> 目标。每个纹理方法针对激活纹理单元上的一个目标，如果用 JavaScript 表示 WebGL 方法可能像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94945201143729460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var getContext = function() {\n  var textureUnits = [\n    { TEXTURE_2D: ??, TEXTURE_CUBE_MAP: ?? },\n    { TEXTURE_2D: ??, TEXTURE_CUBE_MAP: ?? },\n    { TEXTURE_2D: ??, TEXTURE_CUBE_MAP: ?? },\n    { TEXTURE_2D: ??, TEXTURE_CUBE_MAP: ?? },\n    { TEXTURE_2D: ??, TEXTURE_CUBE_MAP: ?? },\n    // ...\n   ];\n  var activeTextureUnit = 0;\n\n  var activeTexture = function(unit) {\n    // 将纹理单元枚举转换成索引\n    var index = unit - gl.TEXTURE0;\n    // 设置激活纹理单元\n    activeTextureUnit = index;\n  };\n\n  var bindTexture = function(target, texture) {\n    // 设置激活纹理单元的目标对象纹理\n    textureUnits[activeTextureUnit][target] = texture;\n  };\n\n  var texImage2D = function(target, ... args ...) {\n    // 绑定对应纹理单元调用相应的方法\n    var texture = textureUnits[activeTextureUnit][target];\n    texture.image2D(...args...);\n  };\n\n  // 返回 WebGL API\n  return {\n    activeTexture: activeTexture,\n    bindTexture: bindTexture,\n    texImage2D: texImage2D,\n  }\n};`, `94945201143729460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">getContext</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> textureUnits <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span> <span class="token constant">TEXTURE_2D</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token constant">TEXTURE_CUBE_MAP</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span> <span class="token constant">TEXTURE_2D</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token constant">TEXTURE_CUBE_MAP</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span> <span class="token constant">TEXTURE_2D</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token constant">TEXTURE_CUBE_MAP</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span> <span class="token constant">TEXTURE_2D</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token constant">TEXTURE_CUBE_MAP</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span> <span class="token constant">TEXTURE_2D</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token constant">TEXTURE_CUBE_MAP</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token comment">// ...</span>\n   <span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> activeTextureUnit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> <span class="token function-variable function">activeTexture</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">unit</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 将纹理单元枚举转换成索引</span>\n    <span class="token keyword">var</span> index <span class="token operator">=</span> unit <span class="token operator">-</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span><span class="token punctuation">;</span>\n    <span class="token comment">// 设置激活纹理单元</span>\n    activeTextureUnit <span class="token operator">=</span> index<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> <span class="token function-variable function">bindTexture</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> texture</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 设置激活纹理单元的目标对象纹理</span>\n    textureUnits<span class="token punctuation">[</span>activeTextureUnit<span class="token punctuation">]</span><span class="token punctuation">[</span>target<span class="token punctuation">]</span> <span class="token operator">=</span> texture<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> <span class="token function-variable function">texImage2D</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> <span class="token operator">...</span> args <span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 绑定对应纹理单元调用相应的方法</span>\n    <span class="token keyword">var</span> texture <span class="token operator">=</span> textureUnits<span class="token punctuation">[</span>activeTextureUnit<span class="token punctuation">]</span><span class="token punctuation">[</span>target<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    texture<span class="token punctuation">.</span><span class="token function">image2D</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 返回 WebGL API</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    activeTexture<span class="token punctuation">:</span> activeTexture<span class="token punctuation">,</span>\n    bindTexture<span class="token punctuation">:</span> bindTexture<span class="token punctuation">,</span>\n    texImage2D<span class="token punctuation">:</span> texImage2D<span class="token punctuation">,</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>着色器获得纹理单元</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81328889912629480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gl.uniform1i(u_image0Location, 0); // 纹理单元 0\ngl.uniform1i(u_image1Location, 1); // 纹理单元 1`, `81328889912629480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_image0Location<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 纹理单元 0</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>u_image1Location<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 纹理单元 1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>需要注意的是，设置全局变量的时候使用索引代替纹理单元，但是调用 <code class="language-text">gl.activeTexture</code> 的时候你需要传递特殊的常量 <code class="language-text">gl.TEXTURE0</code>, <code class="language-text">gl.TEXTURE1</code> 之类。幸运的是这些常量是连续的，所以这些代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17868993257595656000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gl.activeTexture(gl.TEXTURE0);\ngl.bindTexture(gl.TEXTURE_2D, textures[0]);\n\ngl.activeTexture(gl.TEXTURE1);\ngl.bindTexture(gl.TEXTURE_2D, textures[1]);`, `17868993257595656000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> textures<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> textures<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以写成这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55196311471365960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gl.activeTexture(gl.TEXTURE0 + 0);\ngl.bindTexture(gl.TEXTURE_2D, textures[0]);\n\ngl.activeTexture(gl.TEXTURE0 + 1);\ngl.bindTexture(gl.TEXTURE_2D, textures[1]);`, `55196311471365960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> textures<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> textures<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>或这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97554446867456490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for (var ii = 0; ii < 2; ++ii) {\n  gl.activeTexture(gl.TEXTURE0 + ii);\n  gl.bindTexture(gl.TEXTURE_2D, textures[ii]);\n}`, `97554446867456490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token operator">++</span>ii<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span> <span class="token operator">+</span> ii<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> textures<span class="token punctuation">[</span>ii<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>希望这样能够帮助你理解 WebGL 单次绘制中如何使用多个纹理。</p>\n<h1 id="webgl-纹理映射的透视纠正"><a href="#webgl-%E7%BA%B9%E7%90%86%E6%98%A0%E5%B0%84%E7%9A%84%E9%80%8F%E8%A7%86%E7%BA%A0%E6%AD%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 纹理映射的透视纠正</h1>\n<p>这篇文章讲纹理映射的透视纠正，要理解它你可能需要先看看透视投影和纹理，你也需要知道可变量以及它的用处，但是我还会简短的介绍一下。</p>\n<p>在工作原理中我们讲过了可变量的工作原理，顶点着色器可以声明可变量并给它赋值，一旦顶点着色器被引用 3 次就会画一个三角形。绘制这个三角形的每个像素都会调用片断着色器获得像素颜色，在三个顶点之间的点会得到差之后的可变量。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/zi15x?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [fragment-shader-anim](embedded-codesandbox://webgl-fundamental-base-concept/fragment-shader-anim?view=preview) -->\n<h2 id="矩形"><a href="#%E7%9F%A9%E5%BD%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>矩形</h2>\n<p>回到我们的第一篇文章，在裁剪空间中绘制一个三角形，没有数学运算，只是传入裁剪空间坐标到一个简单的顶点着色器，像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59560296926079530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 属性从缓冲中获取数据\nattribute vec4 a_position;\n\n// 所有的着色器都有一个 main 函数\nvoid main() {\n\n   // gl_Position 是着色器需要设置的一个特殊的变量\n   gl_Position = a_position;\n}`, `59560296926079530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// 属性从缓冲中获取数据</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n\n<span class="token comment">// 所有的着色器都有一个 main 函数</span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\n   <span class="token comment">// gl_Position 是着色器需要设置的一个特殊的变量</span>\n   gl_Position <span class="token operator">=</span> a_position<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还有一个简单的片断着色器提供固定的颜色</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44626939038647050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 片断着色器没有默认的精度，\n// 中等精度是个不错的默认值\nprecision mediump float;\n\nvoid main() {\n   // gl_FragColor 是片断着色器需要设置的一个特殊变量\n   gl_FragColor = vec4(1, 0, 0.5, 1); // 返回红紫色\n}`, `44626939038647050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// 片断着色器没有默认的精度，</span>\n<span class="token comment">// 中等精度是个不错的默认值</span>\n<span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// gl_FragColor 是片断着色器需要设置的一个特殊变量</span>\n   gl_FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回红紫色</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>让我们在裁剪空间绘制两个矩形，为每个顶点传递 X, Y, Z 和 W。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79125452604106000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var positions = [\n  // 第一个矩形的第一个三角形\n  -0.8,\n  -0.8,\n  0,\n  1,\n  0.8,\n  -0.8,\n  0,\n  1,\n  -0.8,\n  -0.2,\n  0,\n  1,\n\n  // 第一个矩形的第二个三角形\n  -0.8,\n  -0.2,\n  0,\n  1,\n  0.8,\n  -0.8,\n  0,\n  1,\n  0.8,\n  -0.2,\n  0,\n  1,\n\n  // 第二个矩形的第一个三角形\n  -0.8,\n  0.2,\n  0,\n  1,\n  0.8,\n  0.2,\n  0,\n  1,\n  -0.8,\n  0.8,\n  0,\n  1,\n\n  // 第二个矩形的第二个三角形\n  -0.8,\n  0.8,\n  0,\n  1,\n  0.8,\n  0.2,\n  0,\n  1,\n  0.8,\n  0.8,\n  0,\n  1\n];`, `79125452604106000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> positions <span class="token operator">=</span> <span class="token punctuation">[</span>\n  <span class="token comment">// 第一个矩形的第一个三角形</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第一个矩形的第二个三角形</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第二个矩形的第一个三角形</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第二个矩形的第二个三角形</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是结果</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/oqzsfs?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>再添加一个浮点型可变量，并把它从顶点着色器直接传递到片断着色器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60957446573183580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\nattribute float a_brightness;\n\nvarying float v_brightness;\n\nvoid main() {\n   gl_Position = a_position;\n\n   // 直接传递亮度到片断着色器\n   v_brightness = a_brightness;\n}`, `60957446573183580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{2,4,9-10}"\n              >\n                <span class="gatsby-code-button-language">glsl{2,4,9-10}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">attribute</span> <span class="token keyword">float</span> a_brightness<span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">varying</span> <span class="token keyword">float</span> v_brightness<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   gl_Position <span class="token operator">=</span> a_position<span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">   <span class="token comment">// 直接传递亮度到片断着色器</span></span><span class="gatsby-highlight-code-line">   v_brightness <span class="token operator">=</span> a_brightness<span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在片断着色器中使用可变量设置颜色</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70143966429938430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 顶点着色器的值插值后传入这里\nvarying float v_brightness;\n\nvoid main() {\n   gl_FragColor = vec4(v_brightness, 0, 0, 1);  // 红色\n}`, `70143966429938430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{3-4,7}"\n              >\n                <span class="gatsby-code-button-language">glsl{3-4,7}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line"><span class="token comment">// 顶点着色器的值插值后传入这里</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">varying</span> <span class="token keyword">float</span> v_brightness<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">   gl_FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>v_brightness<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 红色</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们需要给可变量提供数据，创建一个缓冲放入一些数据，每个顶点一个值，我们将设置左边亮度为 0，右边亮度为 1。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34693024953923346000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建缓冲并放入 12 个亮度值\nvar brightnessBuffer = gl.createBuffer();\n\n// 绑定到 ARRAY_BUFFER\ngl.bindBuffer(gl.ARRAY_BUFFER, brightnessBuffer);\n\nvar brightness = [\n  // 第一个矩形的第一个三角形\n  0,\n  1,\n  0,\n\n  // 第一个矩形的第二个三角形\n  0,\n  1,\n  1,\n\n  // 第二个矩形的第一个三角形\n  0,\n  1,\n  0,\n\n  // 第二个矩形的第二个三角形\n  0,\n  1,\n  1\n];\n\ngl.bufferData(gl.ARRAY_BUFFER, new Float32Array(brightness), gl.STATIC_DRAW);`, `34693024953923346000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建缓冲并放入 12 个亮度值</span>\n<span class="token keyword">var</span> brightnessBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 绑定到 ARRAY_BUFFER</span>\ngl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> brightnessBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">var</span> brightness <span class="token operator">=</span> <span class="token punctuation">[</span>\n  <span class="token comment">// 第一个矩形的第一个三角形</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第一个矩形的第二个三角形</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第二个矩形的第一个三角形</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第二个矩形的第二个三角形</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">1</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\ngl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>brightness<span class="token punctuation">)</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还需要在初始化阶段找到 <code class="language-text">a_brightness</code> 的位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="811319267302246300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 找到顶点数据的输入位置\nvar positionAttributeLocation = gl.getAttribLocation(program, \'a_position\');\nvar brightnessAttributeLocation = gl.getAttribLocation(program, \'a_brightness\');`, `811319267302246300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3}"\n              >\n                <span class="gatsby-code-button-language">js{3}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 找到顶点数据的输入位置</span>\n<span class="token keyword">var</span> positionAttributeLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'a_position\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> brightnessAttributeLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'a_brightness\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后在渲染阶段设置属性</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47419706946734694000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 启用属性\ngl.enableVertexAttribArray(brightnessAttributeLocation);\n\n// 绑定位置缓冲\ngl.bindBuffer(gl.ARRAY_BUFFER, brightnessBuffer);\n\n// 告诉属性如何从缓冲中读取数据\nvar size = 1; // 每次迭代读取一个单位数据\nvar type = gl.FLOAT; // 数据类型是 32 位浮点型\nvar normalize = false; // 不用单位化\nvar stride = 0; // 每次迭代需要移动的距离\nvar offset = 0; // 从缓冲的起始处开始\ngl.vertexAttribPointer(brightnessAttributeLocation, size, type, normalize, stride, offset);`, `47419706946734694000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 启用属性</span>\ngl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>brightnessAttributeLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 绑定位置缓冲</span>\ngl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> brightnessBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 告诉属性如何从缓冲中读取数据</span>\n<span class="token keyword">var</span> size <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 每次迭代读取一个单位数据</span>\n<span class="token keyword">var</span> type <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">;</span> <span class="token comment">// 数据类型是 32 位浮点型</span>\n<span class="token keyword">var</span> normalize <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 不用单位化</span>\n<span class="token keyword">var</span> stride <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 每次迭代需要移动的距离</span>\n<span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 从缓冲的起始处开始</span>\ngl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>brightnessAttributeLocation<span class="token punctuation">,</span> size<span class="token punctuation">,</span> type<span class="token punctuation">,</span> normalize<span class="token punctuation">,</span> stride<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在渲染后得到会得到两个矩形，左边 brightness 是 0 右边是 1，中间的部分是插值（或可变量）。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/cfvjcf?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>在透视投影的文章中我们知道 WebGL 会将放入 <code class="language-text">gl_Position</code> 的值除以 <code class="language-text">gl_Position.w</code>。</p>\n<p>在上方的顶点中我们提供的 W 值为 1，但是我们知道 WebGL 会除以 W，所以做如下修改应该结果不变。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58926545117985186000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var mult = 20;\nvar positions = [\n  // 第一个矩形的第一个三角形\n  -0.8,\n  0.8,\n  0,\n  1,\n  0.8,\n  0.8,\n  0,\n  1,\n  -0.8,\n  0.2,\n  0,\n  1,\n\n  // 第一个矩形的第二个三角形\n  -0.8,\n  0.2,\n  0,\n  1,\n  0.8,\n  0.8,\n  0,\n  1,\n  0.8,\n  0.2,\n  0,\n  1,\n\n  // 第二个矩形的第一个三角形\n  -0.8,\n  -0.2,\n  0,\n  1,\n  0.8 * mult,\n  -0.2 * mult,\n  0,\n  mult,\n  -0.8,\n  -0.8,\n  0,\n  1,\n\n  // 第二个矩形的第二个三角形\n  -0.8,\n  -0.8,\n  0,\n  1,\n  0.8 * mult,\n  -0.2 * mult,\n  0,\n  mult,\n  0.8 * mult,\n  -0.8 * mult,\n  0,\n  mult\n];`, `58926545117985186000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> mult <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> positions <span class="token operator">=</span> <span class="token punctuation">[</span>\n  <span class="token comment">// 第一个矩形的第一个三角形</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第一个矩形的第二个三角形</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第二个矩形的第一个三角形</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span> <span class="token operator">*</span> mult<span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.2</span> <span class="token operator">*</span> mult<span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  mult<span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n\n  <span class="token comment">// 第二个矩形的第二个三角形</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span>\n  <span class="token number">0.8</span> <span class="token operator">*</span> mult<span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.2</span> <span class="token operator">*</span> mult<span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  mult<span class="token punctuation">,</span>\n  <span class="token number">0.8</span> <span class="token operator">*</span> mult<span class="token punctuation">,</span>\n  <span class="token operator">-</span><span class="token number">0.8</span> <span class="token operator">*</span> mult<span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span>\n  mult\n<span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如上所示我们将第二个矩形右边的点的 X 和 Y 都乘以 mult，同时设置 W 为 mult。由于 WebGL 会除以 W 所以我们应该得到相同的结果对么？</p>\n<p>这是结果</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/51qz0x?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>注意两个矩形和上一个例子位置相同，事实是 <code class="language-text">X * MULT / MULT(W)</code> 还是 X，Y 也一样，但颜色却不同，为什么？</p>\n<p>事实是 WebGL 使用 W 实现纹理映射或者可变量插值的透视投影。</p>\n<p>如果将片断着色器改成这样就更容易看出效果</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53858797911599930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gl_FragColor = vec4(fract(v_brightness * 10), 0, 0, 1); // 红色`, `53858797911599930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token function">fract</span><span class="token punctuation">(</span>v_brightness <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 红色</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>将 <code class="language-text">v_brightness</code> 乘以 10 就会是值的范围为 0 到 10，fract 会保留小数部分所以结果还是 0 到 1 之间，但是总共是 10 次 0 到 1 了。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/yiilg8?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>现在应该更容易看出透视效果。</p>\n<p>线性插值应该是这样的公式</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32739074845539440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`result = (1 - t) * a + t * b;`, `32739074845539440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> t<span class="token punctuation">)</span> <span class="token operator">*</span> a <span class="token operator">+</span> t <span class="token operator">*</span> b<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>t 的范围是 0 到 1，表示 a 到 b 之间的位置，0 表示在 a 点，1 表示在 b 点。</p>\n<p>可变量经过 WebGL 的插值时使用这个公式</p>\n<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>e</mi><mi>s</mi><mi>u</mi><mi>l</mi><mi>t</mi><mo>=</mo><mfrac><mrow><mo>(</mo><mn>1</mn><mo>−</mo><mi>t</mi><mo>)</mo><mo>∗</mo><mi>a</mi><mi mathvariant="normal">/</mi><mi>a</mi><mi>W</mi><mo>+</mo><mi>t</mi><mo>∗</mo><mi>b</mi><mi mathvariant="normal">/</mi><mi>b</mi><mi>W</mi></mrow><mrow><mo>(</mo><mn>1</mn><mo>−</mo><mi>t</mi><mo>)</mo><mi mathvariant="normal">/</mi><mi>a</mi><mi>W</mi><mo>+</mo><mi>t</mi><mi mathvariant="normal">/</mi><mi>b</mi><mi>W</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">result=\\frac{(1 - t) * a / aW + t * b / bW}{(1 - t) / aW + t / bW}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.01em;"></span><span class="strut bottom" style="height:1.53em;vertical-align:-0.52em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit">s</span><span class="mord mathit">u</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">t</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mathit mtight">t</span><span class="mclose mtight">)</span><span class="mord mtight">/</span><span class="mord mathit mtight">a</span><span class="mord mathit mtight" style="margin-right:0.13889em;">W</span><span class="mbin mtight">+</span><span class="mord mathit mtight">t</span><span class="mord mtight">/</span><span class="mord mathit mtight">b</span><span class="mord mathit mtight" style="margin-right:0.13889em;">W</span></span></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.2em;"><svg width=\'400em\' height=\'0.2em\' viewBox=\'0 0 400000 200\' preserveAspectRatio=\'xMinYMin slice\'><path d=\'M0 80H400000 v40H0z M0 80H400000 v40H0z\'/></svg></span></span><span style="top:-3.485em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mathit mtight">t</span><span class="mclose mtight">)</span><span class="mbin mtight">∗</span><span class="mord mathit mtight">a</span><span class="mord mtight">/</span><span class="mord mathit mtight">a</span><span class="mord mathit mtight" style="margin-right:0.13889em;">W</span><span class="mbin mtight">+</span><span class="mord mathit mtight">t</span><span class="mbin mtight">∗</span><span class="mord mathit mtight">b</span><span class="mord mtight">/</span><span class="mord mathit mtight">b</span><span class="mord mathit mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em;"></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></p>\n<p>aW 表示 a 点的 W 值，也就是 <code class="language-text">gl_Position.w</code> 的值，而不一定等于缓冲中的值， 同理 bW 是设置在 b 点的 <code class="language-text">gl_Position.w</code>。</p>\n<h2 id="正方体"><a href="#%E6%AD%A3%E6%96%B9%E4%BD%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>正方体</h2>\n<p>为什么这个很重要？这有一个简单的纹理，使用纹理文章的例子，并调整了 UV，每个面使用整张纹理，是一个 4×4 像素的纹理。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/7rjd5e?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>现在将例子中的顶点着色器做一些修改，手工除以 W，只增加了一行代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51517964536137330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\nattribute vec2 a_texcoord;\n\nuniform mat4 u_matrix;\n\nvarying vec2 v_texcoord;\n\nvoid main() {\n  // 将位置和矩阵相乘\n  gl_Position = u_matrix * a_position;\n\n  // 手工除以 W\n  gl_Position /= gl_Position.w;\n\n  // 将纹理坐标传到片断着色器\n  v_texcoord = a_texcoord;\n}`, `51517964536137330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec2</span> a_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_matrix<span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 将位置和矩阵相乘</span>\n  gl_Position <span class="token operator">=</span> u_matrix <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n\n  <span class="token comment">// 手工除以 W</span>\n  gl_Position <span class="token operator">/</span><span class="token operator">=</span> gl_Position<span class="token punctuation">.</span>w<span class="token punctuation">;</span>\n\n  <span class="token comment">// 将纹理坐标传到片断着色器</span>\n  v_texcoord <span class="token operator">=</span> a_texcoord<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>除以 W 意味值 <code class="language-text">gl_Position.w</code> 始终为 1，X, Y 和 Z 不会有什么影响，因为 WebGL 也会默认做除法，这是结果。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/mneucd?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>我们还是得到了一个立方体，但是纹理变得扭曲了，这是因为没有传入 W WebGL 就不能正确的实现纹理的透视纠正，或者更准确地说，WebGL 就不能正确的对可变量的插值实现透视。</p>\n<p>如果你还记得的话 W 就是透视矩阵中的 Z，当 W 始终为 1 时 WebGL 做的就是一个简单的线性插值，事实上如果你拿着上述的等式</p>\n<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>e</mi><mi>s</mi><mi>u</mi><mi>l</mi><mi>t</mi><mo>=</mo><mfrac><mrow><mo>(</mo><mn>1</mn><mo>−</mo><mi>t</mi><mo>)</mo><mo>∗</mo><mi>a</mi><mi mathvariant="normal">/</mi><mi>a</mi><mi>W</mi><mo>+</mo><mi>t</mi><mo>∗</mo><mi>b</mi><mi mathvariant="normal">/</mi><mi>b</mi><mi>W</mi></mrow><mrow><mo>(</mo><mn>1</mn><mo>−</mo><mi>t</mi><mo>)</mo><mi mathvariant="normal">/</mi><mi>a</mi><mi>W</mi><mo>+</mo><mi>t</mi><mi mathvariant="normal">/</mi><mi>b</mi><mi>W</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">result=\\frac{(1 - t) * a / aW + t * b / bW}{(1 - t) / aW + t / bW}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.01em;"></span><span class="strut bottom" style="height:1.53em;vertical-align:-0.52em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit">s</span><span class="mord mathit">u</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">t</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mathit mtight">t</span><span class="mclose mtight">)</span><span class="mord mtight">/</span><span class="mord mathit mtight">a</span><span class="mord mathit mtight" style="margin-right:0.13889em;">W</span><span class="mbin mtight">+</span><span class="mord mathit mtight">t</span><span class="mord mtight">/</span><span class="mord mathit mtight">b</span><span class="mord mathit mtight" style="margin-right:0.13889em;">W</span></span></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.2em;"><svg width=\'400em\' height=\'0.2em\' viewBox=\'0 0 400000 200\' preserveAspectRatio=\'xMinYMin slice\'><path d=\'M0 80H400000 v40H0z M0 80H400000 v40H0z\'/></svg></span></span><span style="top:-3.485em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mathit mtight">t</span><span class="mclose mtight">)</span><span class="mbin mtight">∗</span><span class="mord mathit mtight">a</span><span class="mord mtight">/</span><span class="mord mathit mtight">a</span><span class="mord mathit mtight" style="margin-right:0.13889em;">W</span><span class="mbin mtight">+</span><span class="mord mathit mtight">t</span><span class="mbin mtight">∗</span><span class="mord mathit mtight">b</span><span class="mord mtight">/</span><span class="mord mathit mtight">b</span><span class="mord mathit mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em;"></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></p>\n<p>设置所有的 W 为 1 就会得到</p>\n<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>e</mi><mi>s</mi><mi>u</mi><mi>l</mi><mi>t</mi><mo>=</mo><mo>(</mo><mn>1</mn><mo>−</mo><mi>t</mi><mo>)</mo><mo>∗</mo><mi>a</mi><mo>+</mo><mi>t</mi><mo>∗</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">result=(1 - t) * a + t * b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit">s</span><span class="mord mathit">u</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">t</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit">t</span><span class="mclose">)</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit">a</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit">t</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit">b</span></span></span></span></p>\n<p>就和上方提到的线性插值一样了。</p>\n<p>现在就清楚为什么 WebGL 要使用 4x4 的矩阵和包含 X, Y, Z 和 W 四个值的向量了吧。X 和 Y 除以 W 得到裁剪空间坐标，Z 除以 W 也得到裁剪空间的 Z 坐标，W 同时还为纹理映射的透视纠正提供了帮助。</p>\n<blockquote>\n<p><strong>二十世纪中叶的游戏机</strong></p>\n<p>一点小事，Playstation 1 和其他同一时代的游戏机都没有做纹理映射的透视纠正，根据以上的信息你就能看出为什么路面是这样的了。</p>\n</blockquote>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-02-16-00-44-0962b01e201a35ee0dd40a12c237c0b5-0208c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 493px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 82.55578093306288%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAAECElEQVQ4y0WUSW8jdRTE23Ziu+Ml7d2O7fbSdmzH2bwmjuNxPFkmq5NRxmEmZGOYRYwEDswiEAcQQkLihOAwFyQkrtw4cIYPwYkP8+O1DZpDqdWt7vpX1avXSq3oYtGYJuVTRlg0ggxqBudpjeNGho9aPt6s5znJRjlIBki6FSJTCiGngvYf/AKPwCdQjrZ0+ls17lRzJDSFZtbH60qe14UIrxo5dotTfH+9ye3pPg/bDbIhO0u5CLN6iLJdYUm1kVOtdBzm1YKyszrPdnuB1YUUlUKUaszBpe5lkNF4mtMoRxVenRZ576RHS96tlvzs92psrlfZNsKcVEp05wt8ttVjzYiidMXe4PgulVKMTFwlE7KSDljQ/QpG2Eo+YuFhw009aSOkKqQllohLIeAQqy4LvikrEbeVgNeGf0oU3uTj9Gaj9KIqA7+dOSFKBy0YgqwgHVDYm1c5WvQQEMK410JQrAWdllGOQSEOyvOY20JSs6IclBK0CzEOmwXOagWykmM2NCYzkZIDqqJuvzxFfNpCQmAqDYuaoAwn5rHS1J1UEg4Mvw2lnw3xMCm5COl8MTwiMIkywXekOTmgk3eM7ZoTFsKgqJsNTVKK2kfqImLfL8NROksp1kpieTnFnUp6VB1DcjRJDIEulqPTCnPxSfIJjZDbRjlmZz3v5HzFw2nVRS5g486sk/s1D4qujfsX88rJErapzBxIWO5nhKgyY2MjM8lKysFGNStNiLBZcrEza6ehT7CSsfOo4+dBS+NUoCT9kol8nA/a6Oh20nK/ELHxxZqXn3Z9vGx52MxOsr/g5ajsFCIHW6Jmu6iykXPQNSbZK6uCKe6VVJRm3M6w7uaPszB/P53h90GYnw8DvGy76QqROdmm4eG6HeJ4XmzWPezPOdktOTleULlohRjUNQ6qbo4XXSh/nmn88yLOb2dBvt2a5nXHw/yMFZ9rvEo5UX57mKSZltyydrYLY5Vdw8njwxWGl9t82m8wzLjZLDpRfvlkk73iBLnwODeTKCr7qks9wjLR4YHOs7th2ukJ9kXVodg7mrPzvL/Mh/0mO2WN82acvzQvn0u2SqNVJz76MVhGJAkpri4F1WRPB6sRfriZo5uZELsq5zU3l00v1ytevrre4HE3wUCsnt5N87aS4+uEKCwbM1JWcwPGW/B/cZeTTn4d1hnuJNiQLHfF6pUQPVvXeL7m4ZubHrf9IsPjDDedJCeSZc8cSjmfYsYzJjTVxUy7ovDHJ4u86etspG30Jfz3ZXAftKa5Wp3msuHixT2D7z4+YO8iS+8kzpNBncMFB0pCs71TJwhJbi+Psnx5P8OabpPMnAyWVM4qLiH1jnDR8PJoWeX2IM/VVpgHbR/na7K+0oJ/AeLI7QPA18vhAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 02 16 00 44" title="" data-src="/static/2022-08-02-16-00-44-0962b01e201a35ee0dd40a12c237c0b5-0208c.png" data-srcset="/static/2022-08-02-16-00-44-0962b01e201a35ee0dd40a12c237c0b5-1777c.png 200w,\n/static/2022-08-02-16-00-44-0962b01e201a35ee0dd40a12c237c0b5-1db89.png 400w,\n/static/2022-08-02-16-00-44-0962b01e201a35ee0dd40a12c237c0b5-0208c.png 493w" data-sizes="(max-width: 493px) 100vw, 493px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-02-16-00-59-3a15d53be2198486311047d3a723932d-0208c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 493px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 82.55578093306288%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAAEW0lEQVQ4y02T+0/TVxjGv/GnXTKzLTFbpqJGGZVLlYEB5U7LpbRcLNIhYikIvdEbQkEolAoFWgpykYsoUMS5LQY102nUHxxbjJoZY6ZkWzTbD8v2DyzZkv1gPjstuuwkT875vuc8z/u87zlfSdvmQF5vxjsd4Ien9/CHFlDnNqLdW0limpV3dpjoqKzGrsilSr4HeXIqNUfrMLS4OOxyMT5zhkSFBynGxoaddqSBARMObzcdISfhz0e5NNbFlVAdl4LHcTmcvL/XTW2VgRaDHof+CCqVGrPFgm8ogN3QiLNBT+1hF/s+rOKD7U1I88MBFiaHGDjuYGwgxNm5C8xNBAjPjHLlwhjnTozQ3tRKrbkFrU5PeUUFZqsVj3+I/s4e+jwn0Na0sWOznvdENdJksJ9lXy+jTisn3Q58ThsjXe1MBQZYmF1kZXyJa+MznJouoqy6kCxlGQZDA75gkGavF09oEJ3Zj7TdwRsyF9Jlm5Fws5HTRz7lrLaUqTYTg/ZjDLnM+B0GQt42hn3duI8bsbbpMTir0Dc04RseodsfYHhshBpzPxu2NSNttSDlxMUSnprl8e3b3FpY4ML4BGd8HQQ9btGGVvqsevqbG/BbLfRabKICI51WE27Rd7u3l+7gIGWGHjYluzF1LiLtfvMtVnp7+fOP33nx7Clr167x65Mn/LT2jAd37vDt6irXv7rK+cV5wrMTzAX6mDxhI9juYrjfx6nTIxy2DOIdvUpgtAfp3Y0bubi0xF8vX3JvcIhzb7zNpQQ5j8R6tbWNB11d3LVYeTwxyUOBx8th3A4bavGMDNpyjPV6Onq8uD0e1JX5SGIwOzPDP8B3fX6+n55j7foNrqtKWG3v4KI8mRviEm7qDdzt7OJpKIRNrFvcbnw+H9U6HeryLApKs0krVKwLzs3O8rcQvON08XB8kuf37/PlxzK+zszmZlExz1cus7awyKrNzo9T09hMZtKzhEhJKQeUhWSXaUjKLSI2s2BdcElcRmT8LIi/fLPKb89f8Oj8MrcmT/PF/CLz4WVOBkcwWJziAowkF2rYmpzOjvRc9io1QkjJ5kwF8UI0Ktjl6+OzlSv0Tkxj9/mptjpR1DWRpqtFpihhc2omH32yny0pGWwV8870HORKtXh/dupa2jlab8GQkklcvgqpov4YsVlKtqXlRAkx+7KIEQIxKQfYLrBLxOMy84nPKSQhr5gkhRqZcHKw3kRlg5nEgjKy1Ie4uWkLlcn7kfI0pcTnqcQPXhLNGrG9SziIy1CwW4jEC5GE/BIBVfTcbrEfQZWxmTTNIVKLikitrqVfnDElpCDtych5RRKE3PU5giTRm9cCkSTRMwKRORLTmZwUVNegrtWSUapDXnYQmTAkpeTkR4kJEZcRJ3mqKOl1kihexdZdFhOXXUBGhY7GVieJpmJijyrRNNZH96QEkS1SbgT/J//3nb/eDll24XpCgci+TLQjo1xHklqNvFRDuroymuhfJf3i+UrsKnIAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 02 16 00 59" title="" data-src="/static/2022-08-02-16-00-59-3a15d53be2198486311047d3a723932d-0208c.png" data-srcset="/static/2022-08-02-16-00-59-3a15d53be2198486311047d3a723932d-1777c.png 200w,\n/static/2022-08-02-16-00-59-3a15d53be2198486311047d3a723932d-1db89.png 400w,\n/static/2022-08-02-16-00-59-3a15d53be2198486311047d3a723932d-0208c.png 493w" data-sizes="(max-width: 493px) 100vw, 493px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="webgl-平面的和透视的投影映射"><a href="#webgl-%E5%B9%B3%E9%9D%A2%E7%9A%84%E5%92%8C%E9%80%8F%E8%A7%86%E7%9A%84%E6%8A%95%E5%BD%B1%E6%98%A0%E5%B0%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 平面的和透视的投影映射</h1>\n<p>投影映射是投影一张图像的过程，就像一个电影放映机对准一个屏幕，然后将电影投影到屏幕上。电影放映机投影的是一个透视的平面。屏幕离放映机越远，则图像就会越大。如果你将屏幕旋转使其不与电影放映机垂直，那么结果将会是一个梯形或者是任意的四边形。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-03-13-45-50-99314fd827fe61803987de8ca93490d5-b4b51.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 200px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAAB+0lEQVQ4y2M42HiTcVLiEnYGBgZGBmqAdSVH5BflbCsAMjmMlSy5gTQLRQauKNirvLJwfxGIHWIRB3IpFxCDDOYEYmaSDVxddEBxWf6uYhC7yKeBFUmKBWo4CHOgG954cztDwZ55jEUHFjEU7pvPUrB3AWvBvgWMDGtLDisuzt1eCjJAX96UF+o6EGaDhisz1HBOqOFsgjIScMML9sxnRPey0qrC/YUg9v9z/5mghoBodqjBXFDDQK5kZWZlAbs4d8ds7sJ9C1RA+oAurAC6sBXoQi2GlYX7lICGgsOwOXwyrggBiYOCg4uDj4cHxM/eMl0YaOC9gr3zkwv3zv/bcGPbf6Ch0cBYhnuZTU/eBNnLIMyDFEFgV3ILC4DppKXdPEAD/5QdWw40aP47oOv+AQ0MQnFhQ9gEVhwuhIUjO9yFW2dgdyEoDFfCwvDBf0akiGBFC0MwBoYhiObO2DCFp3A/ljCExPIOcCyjeZkDajgs/GCxzC6qLMeEiOV5jDjTYY5HJSuaN5ETOQsjE0JvaH8lQ8ycZiZgbANduACYDudD0uHygj3Kq4ogOSXBIYcN2SVE529GJGXrSxF5WVfOmBfqMhBtCMRGQGwKxBZArAvE6kBsDMSWUHEdaJpFgEs9bxg7omeyoxUKrNAkwwM1HJawuaF8fiifA92xAE2frjDrTavnAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 03 13 45 50" title="" data-src="/static/2022-08-03-13-45-50-99314fd827fe61803987de8ca93490d5-b4b51.png" data-srcset="/static/2022-08-03-13-45-50-99314fd827fe61803987de8ca93490d5-b4b51.png 200w" data-sizes="(max-width: 200px) 100vw, 200px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>当然，投影映射并不只能投影到平面。还有圆柱型的投影映射、球形的投影映射，等等。</p>\n<p>我们先来介绍下平面的投影映射。在这种情况下，你需要将电影放映机想象成和屏幕一样大，这样即使屏幕离电影放映机很远，电影的图像也不会变得很大，它会保持原来的尺寸。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-03-15-05-08-04c29ea8d9c64a24a2ac398c12f83a8d-a74f3.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 176px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 85.22727272727273%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAACXklEQVQ4y62UzWsTURTF35uZzEwyySRp2mprk4UudFFEikV071qoO5GWggWRmsykNlXcKKKCGxXcKZlQ+5lIBQVR20zTktqC4MZN3emitf4DCn4wnjtJYyAdY8GBH/fO4+XMufe9GzZx8SV/MrLsY7t8bm8s1XLDtkJAN4qWjxXSpc7J5OtzWI9FtVadMR5E7omkyBTVofzdiGnnrqSKVtSwc2UIfoXgaTZjFBOzhm3Ql0rX1nkzZ5bzyY0QU8yi9Q1iK2Dz6rs5xyjmBlg+XYpPpeaT9NV9LYkA51yl3AtVD/oR5cGJOypEN8fWZh3Ttn6OlichaPWzvLmYmDYWUrTpwJ6DqsAFmXIvtNYIRXGocI8Et9KlcQcOv2feTJPD/krJpk0OmeM4/3woI8uPFTj6gkiCP0jQJIckCFzBpesfmvYw63ys9XBHwUKlh1RySyzYpvMmpywH1BBi4OzDG34quUEQ5dYcjp26KUS12F8dnhjsc6tIzWcVCO5c8n/tITnEKZMg7473yAIXJeSehDvbaaqE808fuA4bTjn/p4ehdr0jiB4GqEdeKFpAo/s4kLtF12YjszpDzn6NrkxV7mF9ybt5cJFlozIp6+Dz5bcFCLsOF8nhMPZoeyNdGhz66ybDX6U2KXBI72JqIRuGw/uY5QQE32dWqWTrDHuWWROtC891EvSJMk2Br05se0LoXalDPtJ3svYPBaE42A80r4oOg6OgBxwDx8Eh0A16q+u9kuzravjl3KUyGx9+4eYhVd9eFukkqwfhr7oW69xKgiRJ4Y422sOSrx5xuCPYb+P6MUJdLQ/8AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 03 15 05 08" title="" data-src="/static/2022-08-03-15-05-08-04c29ea8d9c64a24a2ac398c12f83a8d-a74f3.png" data-srcset="/static/2022-08-03-15-05-08-04c29ea8d9c64a24a2ac398c12f83a8d-a74f3.png 176w" data-sizes="(max-width: 176px) 100vw, 176px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>首先，让我们创建一个场景，该场景会绘制一个平面和一个球体。我们将用一个简单的 8x8 棋盘纹理对它们进行贴图。</p>\n<p>这些着色器和纹理文章中的那些着色器是类似的，只是各个矩阵是分开的，这样我们就不需要在 JavaScript 中把它们乘在一起了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48993815519695995000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 顶点着色器\nattribute vec4 a_position;\nattribute vec2 a_texcoord;\n\nuniform mat4 u_projection;\nuniform mat4 u_view;\nuniform mat4 u_world;\n\nvarying vec2 v_texcoord;\n\nvoid main() {\n  gl_Position = u_projection * u_view * u_world * a_position;\n\n  // 把纹理坐标传给片段着色器\n  v_texcoord = a_texcoord;\n}`, `48993815519695995000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// 顶点着色器</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec2</span> a_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_projection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_view<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_world<span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl_Position <span class="token operator">=</span> u_projection <span class="token operator">*</span> u_view <span class="token operator">*</span> u_world <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n\n  <span class="token comment">// 把纹理坐标传给片段着色器</span>\n  v_texcoord <span class="token operator">=</span> a_texcoord<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>另外，我还添加了一个 <code class="language-text">u_colorMult</code> uniform 来乘以纹理颜色。这样我们就可以通过制作一个单色纹理（monochrome texture）来改变它的颜色。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52574759349470265000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 片段着色器\nprecision mediump float;\n\n// 从顶点着色器传来的\nvarying vec2 v_texcoord;\n\nuniform vec4 u_colorMult;\nuniform sampler2D u_texture;\n\nvoid main() {\n  gl_FragColor = texture2D(u_texture, v_texcoord) * u_colorMult;\n}`, `52574759349470265000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// 片段着色器</span>\n<span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器传来的</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_colorMult<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_texture<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span> <span class="token operator">*</span> u_colorMult<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面是设置程序、球体 buffers 和平面 buffers 的代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32084067565223530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 设置 GLSL 程序\n// 编译着色器、链接程序、查找 locations\nconst textureProgramInfo = webglUtils.createProgramInfo(gl, [\'vertex-shader-3d\', \'fragment-shader-3d\']);\n\nconst sphereBufferInfo = primitives.createSphereBufferInfo(\n  gl,\n  1, // 半径\n  12, // 横轴细分数\n  6 // 纵轴细分数\n);\n\nconst planeBufferInfo = primitives.createPlaneBufferInfo(\n  gl,\n  20, // 宽\n  20, // 高\n  1, // 横轴细分数\n  1 // 纵轴细分数\n);`, `32084067565223530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 设置 GLSL 程序</span>\n<span class="token comment">// 编译着色器、链接程序、查找 locations</span>\n<span class="token keyword">const</span> textureProgramInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createProgramInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'vertex-shader-3d\'</span><span class="token punctuation">,</span> <span class="token string">\'fragment-shader-3d\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> sphereBufferInfo <span class="token operator">=</span> primitives<span class="token punctuation">.</span><span class="token function">createSphereBufferInfo</span><span class="token punctuation">(</span>\n  gl<span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 半径</span>\n  <span class="token number">12</span><span class="token punctuation">,</span> <span class="token comment">// 横轴细分数</span>\n  <span class="token number">6</span> <span class="token comment">// 纵轴细分数</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> planeBufferInfo <span class="token operator">=</span> primitives<span class="token punctuation">.</span><span class="token function">createPlaneBufferInfo</span><span class="token punctuation">(</span>\n  gl<span class="token punctuation">,</span>\n  <span class="token number">20</span><span class="token punctuation">,</span> <span class="token comment">// 宽</span>\n  <span class="token number">20</span><span class="token punctuation">,</span> <span class="token comment">// 高</span>\n  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 横轴细分数</span>\n  <span class="token number">1</span> <span class="token comment">// 纵轴细分数</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>和创建一个 8x8 棋盘纹理的代码，使用了我们在数据纹理文章中介绍过的技术。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87978944371765350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建一个 8x8 棋盘纹理\nconst checkerboardTexture = gl.createTexture();\ngl.bindTexture(gl.TEXTURE_2D, checkerboardTexture);\ngl.texImage2D(\n  gl.TEXTURE_2D,\n  0, // mip level\n  gl.LUMINANCE, // internal format\n  8, // width\n  8, // height\n  0, // border\n  gl.LUMINANCE, // format\n  gl.UNSIGNED_BYTE, // type\n  new Uint8Array([\n    // data\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff,\n    0xcc,\n    0xff\n  ])\n);\ngl.generateMipmap(gl.TEXTURE_2D);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);`, `87978944371765350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建一个 8x8 棋盘纹理</span>\n<span class="token keyword">const</span> checkerboardTexture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> checkerboardTexture<span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>\n  gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>\n  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// mip level</span>\n  gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> <span class="token comment">// internal format</span>\n  <span class="token number">8</span><span class="token punctuation">,</span> <span class="token comment">// width</span>\n  <span class="token number">8</span><span class="token punctuation">,</span> <span class="token comment">// height</span>\n  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// border</span>\n  gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> <span class="token comment">// format</span>\n  gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token comment">// type</span>\n  <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n    <span class="token comment">// data</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span><span class="token punctuation">,</span>\n    <span class="token number">0xcc</span><span class="token punctuation">,</span>\n    <span class="token number">0xff</span>\n  <span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">generateMipmap</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了绘制，我们将会创建一个函数，该函数需要一个投影矩阵和一个相机矩阵作为参数，以便从相机矩阵中计算出视图矩阵，然后绘制球体和立方体</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22380239575590633000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 每个物体的 uniforms\nconst planeUniforms = {\n  u_colorMult: [0.5, 0.5, 1, 1], // 浅蓝色\n  u_texture: checkerboardTexture,\n  u_world: m4.translation(0, 0, 0)\n};\n\nconst sphereUniforms = {\n  u_colorMult: [1, 0.5, 0.5, 1], // 粉红色\n  u_texture: checkerboardTexture,\n  u_world: m4.translation(2, 3, 4)\n};\n\nfunction drawScene(projectionMatrix, cameraMatrix) {\n  // 从相机矩阵中计算出视图矩阵\n  const viewMatrix = m4.inverse(cameraMatrix);\n\n  gl.useProgram(textureProgramInfo.program);\n\n  // 设置球体和平面共享的 uniforms\n  webglUtils.setUniforms(textureProgramInfo, {\n    u_view: viewMatrix,\n    u_projection: projectionMatrix\n  });\n\n  // ------ 绘制球体 --------\n\n  // 设置所有需要的 attributes\n  webglUtils.setBuffersAndAttributes(gl, textureProgramInfo, sphereBufferInfo);\n\n  // 设置球体特有的 uniforms\n  webglUtils.setUniforms(textureProgramInfo, sphereUniforms);\n\n  // 调用 gl.drawArrays 或 gl.drawElements\n  webglUtils.drawBufferInfo(gl, sphereBufferInfo);\n\n  // ------ 绘制平面 --------\n\n  // 设置所有需要的 attributes\n  webglUtils.setBuffersAndAttributes(gl, textureProgramInfo, planeBufferInfo);\n\n  // 设置平面特有的 uniforms\n  webglUtils.setUniforms(textureProgramInfo, planeUniforms);\n\n  // 调用 gl.drawArrays 或 gl.drawElements\n  webglUtils.drawBufferInfo(gl, planeBufferInfo);\n}`, `22380239575590633000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 每个物体的 uniforms</span>\n<span class="token keyword">const</span> planeUniforms <span class="token operator">=</span> <span class="token punctuation">{</span>\n  u_colorMult<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 浅蓝色</span>\n  u_texture<span class="token punctuation">:</span> checkerboardTexture<span class="token punctuation">,</span>\n  u_world<span class="token punctuation">:</span> m4<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> sphereUniforms <span class="token operator">=</span> <span class="token punctuation">{</span>\n  u_colorMult<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 粉红色</span>\n  u_texture<span class="token punctuation">:</span> checkerboardTexture<span class="token punctuation">,</span>\n  u_world<span class="token punctuation">:</span> m4<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token parameter">projectionMatrix<span class="token punctuation">,</span> cameraMatrix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 从相机矩阵中计算出视图矩阵</span>\n  <span class="token keyword">const</span> viewMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>cameraMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>textureProgramInfo<span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置球体和平面共享的 uniforms</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>textureProgramInfo<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    u_view<span class="token punctuation">:</span> viewMatrix<span class="token punctuation">,</span>\n    u_projection<span class="token punctuation">:</span> projectionMatrix\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ------ 绘制球体 --------</span>\n\n  <span class="token comment">// 设置所有需要的 attributes</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setBuffersAndAttributes</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> textureProgramInfo<span class="token punctuation">,</span> sphereBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置球体特有的 uniforms</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>textureProgramInfo<span class="token punctuation">,</span> sphereUniforms<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 调用 gl.drawArrays 或 gl.drawElements</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">drawBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> sphereBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ------ 绘制平面 --------</span>\n\n  <span class="token comment">// 设置所有需要的 attributes</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setBuffersAndAttributes</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> textureProgramInfo<span class="token punctuation">,</span> planeBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置平面特有的 uniforms</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>textureProgramInfo<span class="token punctuation">,</span> planeUniforms<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 调用 gl.drawArrays 或 gl.drawElements</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">drawBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> planeBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以在一个 render 函数中使用这份代码，就像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65398613111815900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const settings = {\n  cameraX: 2.75,\n  cameraY: 5\n};\n\nconst fieldOfViewRadians = degToRad(60);\n\nfunction render() {\n  webglUtils.resizeCanvasToDisplaySize(gl.canvas);\n\n  // 告诉 WebGL 如何从裁剪空间转换为像素\n  gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);\n\n  gl.enable(gl.CULL_FACE);\n  gl.enable(gl.DEPTH_TEST);\n\n  // 清除 canvas 和深度缓冲区\n  gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);\n\n  // 计算投影矩阵\n  const aspect = gl.canvas.clientWidth / gl.canvas.clientHeight;\n  const projectionMatrix = m4.perspective(fieldOfViewRadians, aspect, 1, 2000);\n\n  // 使用 look at 计算相机的矩阵\n  const cameraPosition = [settings.cameraX, settings.cameraY, 7];\n  const target = [0, 0, 0];\n  const up = [0, 1, 0];\n  const cameraMatrix = m4.lookAt(cameraPosition, target, up);\n\n  drawScene(projectionMatrix, cameraMatrix);\n}\n\nrender();`, `65398613111815900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> settings <span class="token operator">=</span> <span class="token punctuation">{</span>\n  cameraX<span class="token punctuation">:</span> <span class="token number">2.75</span><span class="token punctuation">,</span>\n  cameraY<span class="token punctuation">:</span> <span class="token number">5</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> fieldOfViewRadians <span class="token operator">=</span> <span class="token function">degToRad</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">resizeCanvasToDisplaySize</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 告诉 WebGL 如何从裁剪空间转换为像素</span>\n  gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">CULL_FACE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">DEPTH_TEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 清除 canvas 和深度缓冲区</span>\n  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span> <span class="token operator">|</span> gl<span class="token punctuation">.</span><span class="token constant">DEPTH_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 计算投影矩阵</span>\n  <span class="token keyword">const</span> aspect <span class="token operator">=</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientWidth <span class="token operator">/</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> projectionMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">perspective</span><span class="token punctuation">(</span>fieldOfViewRadians<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 使用 look at 计算相机的矩阵</span>\n  <span class="token keyword">const</span> cameraPosition <span class="token operator">=</span> <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>cameraX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>cameraY<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> up <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> cameraMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>cameraPosition<span class="token punctuation">,</span> target<span class="token punctuation">,</span> up<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">drawScene</span><span class="token punctuation">(</span>projectionMatrix<span class="token punctuation">,</span> cameraMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所以，现在我们有了一个简单的场景，场景内有一个平面和一个球体。我添加了一对滑块来让你改变相机的位置，以便你理解该场景。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/7gmu66?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>现在，让我们使用平面投影的方式将一个纹理投影到该球体和平面上。</p>\n<p>首先要做的是，加载一个纹理。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1175507177723034000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function loadImageTexture(url) {\n  // 创建一个纹理\n  const texture = gl.createTexture();\n  gl.bindTexture(gl.TEXTURE_2D, texture);\n  // 用一个 1x1 蓝色像素填充该纹理\n  gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE, new Uint8Array([0, 0, 255, 255]));\n  // 异步加载一张图片\n  const image = new Image();\n  image.src = url;\n  image.addEventListener(\'load\', function () {\n    // 现在图片加载完了，把它拷贝到纹理中\n    gl.bindTexture(gl.TEXTURE_2D, texture);\n    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);\n    // 假设该纹理的宽高是 2 的整次幂\n    gl.generateMipmap(gl.TEXTURE_2D);\n    render();\n  });\n  return texture;\n}\n\nconst imageTexture = loadImageTexture(\'resources/f-texture.png\');`, `1175507177723034000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">loadImageTexture</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 创建一个纹理</span>\n  <span class="token keyword">const</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 用一个 1x1 蓝色像素填充该纹理</span>\n  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 异步加载一张图片</span>\n  <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  image<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span>\n  image<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'load\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 现在图片加载完了，把它拷贝到纹理中</span>\n    gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 假设该纹理的宽高是 2 的整次幂</span>\n    gl<span class="token punctuation">.</span><span class="token function">generateMipmap</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> texture<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> imageTexture <span class="token operator">=</span> <span class="token function">loadImageTexture</span><span class="token punctuation">(</span><span class="token string">\'resources/f-texture.png\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>回想一下可视化相机的文章。我们创建了一个 -1 到 +1 的立方体，然后把它绘制出来表示相机的视椎体。我们的矩阵使得视椎体内的空间表示的是世界空间中一些锥体形状的区域，这些区域从世界空间中被转换到了 -1 到 +1 的裁剪空间。我们可以在这里做类似的事。</p>\n<p>让我们来试试吧。首先，在我们的片段着色器中，我们会在 0.0 到 1.0 之间的纹理坐标上绘制投影的纹理。而在这个范围外的纹理坐标，我们将会使用棋盘纹理。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10561528950785370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 从顶点着色器传来的\nvarying vec2 v_texcoord;\nvarying vec4 v_projectedTexcoord;\n\nuniform vec4 u_colorMult;\nuniform sampler2D u_texture;\nuniform sampler2D u_projectedTexture;\n\nvoid main() {\n  // gl_FragColor = texture2D(u_texture, v_texcoord) * u_colorMult;\n  // 除以 w 得到正确的值，详见透视投影的文章\n  vec3 projectedTexcoord = v_projectedTexcoord.xyz / v_projectedTexcoord.w;\n\n  bool inRange =\n      projectedTexcoord.x >= 0.0 &&\n      projectedTexcoord.x <= 1.0 &&\n      projectedTexcoord.y >= 0.0 &&\n      projectedTexcoord.y <= 1.0;\n\n  vec4 projectedTexColor = texture2D(u_projectedTexture, projectedTexcoord.xy);\n  vec4 texColor = texture2D(u_texture, v_texcoord) * u_colorMult;\n\n  float projectedAmount = inRange ? 1.0 : 0.0;\n  gl_FragColor = mix(texColor, projectedTexColor, projectedAmount);\n}`, `10561528950785370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{5,9,12-26}"\n              >\n                <span class="gatsby-code-button-language">glsl{5,9,12-26}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器传来的</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">varying</span> <span class="token keyword">vec4</span> v_projectedTexcoord<span class="token punctuation">;</span></span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_colorMult<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_texture<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_projectedTexture<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">  <span class="token comment">// gl_FragColor = texture2D(u_texture, v_texcoord) * u_colorMult;</span></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 除以 w 得到正确的值，详见透视投影的文章</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec3</span> projectedTexcoord <span class="token operator">=</span> v_projectedTexcoord<span class="token punctuation">.</span>xyz <span class="token operator">/</span> v_projectedTexcoord<span class="token punctuation">.</span>w<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">bool</span> inRange <span class="token operator">=</span></span><span class="gatsby-highlight-code-line">      projectedTexcoord<span class="token punctuation">.</span>x <span class="token operator">>=</span> <span class="token number">0.0</span> <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">      projectedTexcoord<span class="token punctuation">.</span>x <span class="token operator">&lt;=</span> <span class="token number">1.0</span> <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">      projectedTexcoord<span class="token punctuation">.</span>y <span class="token operator">>=</span> <span class="token number">0.0</span> <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">      projectedTexcoord<span class="token punctuation">.</span>y <span class="token operator">&lt;=</span> <span class="token number">1.0</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec4</span> projectedTexColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_projectedTexture<span class="token punctuation">,</span> projectedTexcoord<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec4</span> texColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span> <span class="token operator">*</span> u_colorMult<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">float</span> projectedAmount <span class="token operator">=</span> inRange <span class="token operator">?</span> <span class="token number">1.0</span> <span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  gl_FragColor <span class="token operator">=</span> <span class="token function">mix</span><span class="token punctuation">(</span>texColor<span class="token punctuation">,</span> projectedTexColor<span class="token punctuation">,</span> projectedAmount<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了计算投影的纹理坐标，我们会创建一个矩阵，该矩阵表示 3D 空间中一个确切方向的方位和位置，就像可视化相机文章中的相机那样。然后我们会通过那个 3D 空间投影球体顶点和平面顶点的世界坐标。使用我们刚刚写的代码，那些位于 0 到 1 的投影纹理坐标就会显示该投影纹理。</p>\n<p>让我们添加代码到顶点着色器，通过该空间投影球体和平面的世界坐标</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23635097231791026000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\nattribute vec2 a_texcoord;\n\nuniform mat4 u_projection;\nuniform mat4 u_view;\nuniform mat4 u_world;\nuniform mat4 u_textureMatrix;\n\nvarying vec2 v_texcoord;\nvarying vec4 v_projectedTexcoord;\n\nvoid main() {\n  vec4 worldPosition = u_world * a_position;\n\n  // gl_Position = u_projection * u_view * u_world * a_position;\n  gl_Position = u_projection * u_view * worldPosition;\n\n  // 将纹理坐标传给片段着色器\n  v_texcoord = a_texcoord;\n\n  v_projectedTexcoord = u_textureMatrix * worldPosition;\n}`, `23635097231791026000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{7,10,13,15-16,21}"\n              >\n                <span class="gatsby-code-button-language">glsl{7,10,13,15-16,21}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec2</span> a_texcoord<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_projection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_view<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_world<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_textureMatrix<span class="token punctuation">;</span></span>\n<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texcoord<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">varying</span> <span class="token keyword">vec4</span> v_projectedTexcoord<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">vec4</span> worldPosition <span class="token operator">=</span> u_world <span class="token operator">*</span> a_position<span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line">  <span class="token comment">// gl_Position = u_projection * u_view * u_world * a_position;</span></span><span class="gatsby-highlight-code-line">  gl_Position <span class="token operator">=</span> u_projection <span class="token operator">*</span> u_view <span class="token operator">*</span> worldPosition<span class="token punctuation">;</span></span>\n  <span class="token comment">// 将纹理坐标传给片段着色器</span>\n  v_texcoord <span class="token operator">=</span> a_texcoord<span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  v_projectedTexcoord <span class="token operator">=</span> u_textureMatrix <span class="token operator">*</span> worldPosition<span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，剩下要做的就是计算定义了该方位空间的矩阵。我们要做的就是计算出一个世界矩阵，就像我们对其他物体做的那样，然后取它的逆矩阵。这样我们就得到了一个矩阵，该矩阵可以让我们将其他物体的世界坐标转换为相对于该空间的坐标。这和相机文章中的视图矩阵做的事情是完全一样的。</p>\n<p>我们会使用创建的 lookAt 函数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54932815995238180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const settings = {\n  cameraX: 2.75,\n  cameraY: 5,\n  posX: 3.5,\n  posY: 4.4,\n  posZ: 4.7,\n  targetX: 0.8,\n  targetY: 0,\n  targetZ: 4.7\n};\n\nfunction drawScene(projectionMatrix, cameraMatrix) {\n  // 从相机矩阵中创建一个视图矩阵\n  const viewMatrix = m4.inverse(cameraMatrix);\n\n  let textureWorldMatrix = m4.lookAt(\n    [settings.posX, settings.posY, settings.posZ], // position\n    [settings.targetX, settings.targetY, settings.targetZ], // target\n    [0, 1, 0] // up\n  );\n\n  // 使用这个世界矩阵的逆矩阵来创建\n  // 一个矩阵，该矩阵会变换其他世界坐标\n  // 为相对于这个空间的坐标。\n  const textureMatrix = m4.inverse(textureWorldMatrix);\n\n  // 设置对球体和平面都一样的 uniforms\n  webglUtils.setUniforms(textureProgramInfo, {\n    u_view: viewMatrix,\n    u_projection: projectionMatrix,\n    u_textureMatrix: textureMatrix,\n    u_projectedTexture: imageTexture\n  });\n\n  // ...\n}`, `54932815995238180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4-9,31-32}"\n              >\n                <span class="gatsby-code-button-language">js{4-9,31-32}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> settings <span class="token operator">=</span> <span class="token punctuation">{</span>\n  cameraX<span class="token punctuation">:</span> <span class="token number">2.75</span><span class="token punctuation">,</span>\n  cameraY<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  posX<span class="token punctuation">:</span> <span class="token number">3.5</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  posY<span class="token punctuation">:</span> <span class="token number">4.4</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  posZ<span class="token punctuation">:</span> <span class="token number">4.7</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  targetX<span class="token punctuation">:</span> <span class="token number">0.8</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  targetY<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  targetZ<span class="token punctuation">:</span> <span class="token number">4.7</span></span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token parameter">projectionMatrix<span class="token punctuation">,</span> cameraMatrix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 从相机矩阵中创建一个视图矩阵</span>\n  <span class="token keyword">const</span> viewMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>cameraMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">let</span> textureWorldMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>\n    <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>posX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>posY<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>posZ<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// position</span>\n    <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>targetX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>targetY<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>targetZ<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// target</span>\n    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// up</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 使用这个世界矩阵的逆矩阵来创建</span>\n  <span class="token comment">// 一个矩阵，该矩阵会变换其他世界坐标</span>\n  <span class="token comment">// 为相对于这个空间的坐标。</span>\n  <span class="token keyword">const</span> textureMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>textureWorldMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置对球体和平面都一样的 uniforms</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>textureProgramInfo<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    u_view<span class="token punctuation">:</span> viewMatrix<span class="token punctuation">,</span>\n    u_projection<span class="token punctuation">:</span> projectionMatrix<span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">    u_textureMatrix<span class="token punctuation">:</span> textureMatrix<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    u_projectedTexture<span class="token punctuation">:</span> imageTexture</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当然，你不一定要用 lookAt。你可以任选一种方法来创建一个世界矩阵，例如使用一个场景图或矩阵栈。</p>\n<p>在我们运行之前，让我们添加一些缩放比例</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93393035186216930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const settings = {\n  cameraX: 2.75,\n  cameraY: 5,\n  posX: 3.5,\n  posY: 4.4,\n  posZ: 4.7,\n  targetX: 0.8,\n  targetY: 0,\n  targetZ: 4.7,\n  projWidth: 2,\n  projHeight: 2\n};\n\nfunction drawScene(projectionMatrix, cameraMatrix) {\n  // 从相机矩阵中创建一个视图矩阵\n  const viewMatrix = m4.inverse(cameraMatrix);\n\n  let textureWorldMatrix = m4.lookAt(\n    [settings.posX, settings.posY, settings.posZ], // position\n    [settings.targetX, settings.targetY, settings.targetZ], // target\n    [0, 1, 0] // up\n  );\n  textureWorldMatrix = m4.scale(textureWorldMatrix, settings.projWidth, settings.projHeight, 1);\n\n  // 使用这个世界矩阵的逆矩阵来创建\n  // 一个矩阵，该矩阵会变换其他世界坐标\n  // 为相对于这个空间的坐标。\n  const textureMatrix = m4.inverse(textureWorldMatrix);\n\n  // ...\n}`, `93393035186216930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{10-11,23}"\n              >\n                <span class="gatsby-code-button-language">js{10-11,23}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> settings <span class="token operator">=</span> <span class="token punctuation">{</span>\n  cameraX<span class="token punctuation">:</span> <span class="token number">2.75</span><span class="token punctuation">,</span>\n  cameraY<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>\n  posX<span class="token punctuation">:</span> <span class="token number">3.5</span><span class="token punctuation">,</span>\n  posY<span class="token punctuation">:</span> <span class="token number">4.4</span><span class="token punctuation">,</span>\n  posZ<span class="token punctuation">:</span> <span class="token number">4.7</span><span class="token punctuation">,</span>\n  targetX<span class="token punctuation">:</span> <span class="token number">0.8</span><span class="token punctuation">,</span>\n  targetY<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n  targetZ<span class="token punctuation">:</span> <span class="token number">4.7</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  projWidth<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  projHeight<span class="token punctuation">:</span> <span class="token number">2</span></span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token parameter">projectionMatrix<span class="token punctuation">,</span> cameraMatrix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 从相机矩阵中创建一个视图矩阵</span>\n  <span class="token keyword">const</span> viewMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>cameraMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">let</span> textureWorldMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>\n    <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>posX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>posY<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>posZ<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// position</span>\n    <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>targetX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>targetY<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>targetZ<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// target</span>\n    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// up</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  textureWorldMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>textureWorldMatrix<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>projWidth<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>projHeight<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// 使用这个世界矩阵的逆矩阵来创建</span>\n  <span class="token comment">// 一个矩阵，该矩阵会变换其他世界坐标</span>\n  <span class="token comment">// 为相对于这个空间的坐标。</span>\n  <span class="token keyword">const</span> textureMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>textureWorldMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样我们就得到了一个投影的纹理。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/k0k2q1?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>但我觉得这样很难看到该纹理所处的空间。让我们添加一个线框立方体来帮助可视化。</p>\n<p>首先，我们需要一个单独的着色器集合。这些着色器只能绘制纯色，没有纹理。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75295491373858180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script id=&quot;color-vertex-shader&quot; type=&quot;x-shader/x-vertex&quot;>\n  attribute vec4 a_position;\n\n  uniform mat4 u_projection;\n  uniform mat4 u_view;\n  uniform mat4 u_world;\n\n  void main() {\n    // 将 position 乘以矩阵\n    gl_Position = u_projection * u_view * u_world * a_position;\n  }\n</script>\n\n<script id=&quot;color-fragment-shader&quot; type=&quot;x-shader/x-fragment&quot;>\n  precision mediump float;\n\n  uniform vec4 u_color;\n  void main() {\n    gl_FragColor = u_color;\n  }\n</script>`, `75295491373858180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="html"\n              >\n                <span class="gatsby-code-button-language">html</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>color-vertex-shader<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>x-shader/x-vertex<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">\n  attribute vec4 a_position<span class="token punctuation">;</span>\n\n  uniform mat4 u_projection<span class="token punctuation">;</span>\n  uniform mat4 u_view<span class="token punctuation">;</span>\n  uniform mat4 u_world<span class="token punctuation">;</span>\n\n  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 将 position 乘以矩阵</span>\n    gl_Position <span class="token operator">=</span> u_projection <span class="token operator">*</span> u_view <span class="token operator">*</span> u_world <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>\n\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>color-fragment-shader<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>x-shader/x-fragment<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">\n  precision mediump float<span class="token punctuation">;</span>\n\n  uniform vec4 u_color<span class="token punctuation">;</span>\n  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    gl_FragColor <span class="token operator">=</span> u_color<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后我们还需要编译和链接这些着色器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89669089427098570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 设置 GLSL 程序\nconst textureProgramInfo = webglUtils.createProgramInfo(gl, [\'vertex-shader-3d\', \'fragment-shader-3d\']);\nconst colorProgramInfo = webglUtils.createProgramInfo(gl, [\'color-vertex-shader\', \'color-fragment-shader\']);`, `89669089427098570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3}"\n              >\n                <span class="gatsby-code-button-language">js{3}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 设置 GLSL 程序</span>\n<span class="token keyword">const</span> textureProgramInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createProgramInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'vertex-shader-3d\'</span><span class="token punctuation">,</span> <span class="token string">\'fragment-shader-3d\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> colorProgramInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createProgramInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'color-vertex-shader\'</span><span class="token punctuation">,</span> <span class="token string">\'color-fragment-shader\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后我们需要一些数据来绘制线框立方体</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17635202926686145000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const sphereBufferInfo = primitives.createSphereBufferInfo(\n  gl,\n  1, // 半径\n  12, // 横轴细分数\n  6 // 纵轴细分数\n);\n\nconst planeBufferInfo = primitives.createPlaneBufferInfo(\n  gl,\n  20, // 宽度\n  20, // 高度\n  1, // 横轴细分数\n  1 // 纵轴细分数\n);\n\nconst cubeLinesBufferInfo = webglUtils.createBufferInfoFromArrays(gl, {\n  position: [0, 0, -1, 1, 0, -1, 0, 1, -1, 1, 1, -1, 0, 0, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1],\n  indices: [0, 1, 1, 3, 3, 2, 2, 0, 4, 5, 5, 7, 7, 6, 6, 4, 0, 4, 1, 5, 3, 7, 2, 6]\n});`, `17635202926686145000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{16-19}"\n              >\n                <span class="gatsby-code-button-language">js{16-19}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> sphereBufferInfo <span class="token operator">=</span> primitives<span class="token punctuation">.</span><span class="token function">createSphereBufferInfo</span><span class="token punctuation">(</span>\n  gl<span class="token punctuation">,</span>\n  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 半径</span>\n  <span class="token number">12</span><span class="token punctuation">,</span> <span class="token comment">// 横轴细分数</span>\n  <span class="token number">6</span> <span class="token comment">// 纵轴细分数</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> planeBufferInfo <span class="token operator">=</span> primitives<span class="token punctuation">.</span><span class="token function">createPlaneBufferInfo</span><span class="token punctuation">(</span>\n  gl<span class="token punctuation">,</span>\n  <span class="token number">20</span><span class="token punctuation">,</span> <span class="token comment">// 宽度</span>\n  <span class="token number">20</span><span class="token punctuation">,</span> <span class="token comment">// 高度</span>\n  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 横轴细分数</span>\n  <span class="token number">1</span> <span class="token comment">// 纵轴细分数</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> cubeLinesBufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  indices<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意，为了匹配纹理坐标，该立方体在 X 轴和 Y 轴上的范围是 0 到 1。而在 Z 轴上，它的范围是 -1 到 1。这样我们缩放它的时候就能使其在两个方向上都拉伸了。</p>\n<p>要使用该立方体的话，我们只需要使用之前的 textureWorldMatrix 就可以了，因为我们要做的是绘制表示那个空间的立方体。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85501940026991000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function drawScene(projectionMatrix, cameraMatrix) {\n  //...\n  // ------ 绘制立方体 ------\n\n  gl.useProgram(colorProgramInfo.program);\n\n  // 设置所有需要的 attributes\n  webglUtils.setBuffersAndAttributes(gl, colorProgramInfo, cubeLinesBufferInfo);\n\n  // 在 Z 轴上缩放该立方体，\n  // 以便表示该纹理是被投影到无限远的。\n  const mat = m4.scale(textureWorldMatrix, 1, 1, 1000);\n\n  // 设置我们计算出来的 unifroms\n  webglUtils.setUniforms(colorProgramInfo, {\n    u_color: [0, 0, 0, 1],\n    u_view: viewMatrix,\n    u_projection: projectionMatrix,\n    u_world: mat\n  });\n\n  // 调用 gl.drawArrays 或者 gl.drawElements\n  webglUtils.drawBufferInfo(gl, cubeLinesBufferInfo, gl.LINES);\n}`, `85501940026991000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token parameter">projectionMatrix<span class="token punctuation">,</span> cameraMatrix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">//...</span>\n  <span class="token comment">// ------ 绘制立方体 ------</span>\n\n  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>colorProgramInfo<span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置所有需要的 attributes</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setBuffersAndAttributes</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> colorProgramInfo<span class="token punctuation">,</span> cubeLinesBufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 在 Z 轴上缩放该立方体，</span>\n  <span class="token comment">// 以便表示该纹理是被投影到无限远的。</span>\n  <span class="token keyword">const</span> mat <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>textureWorldMatrix<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 设置我们计算出来的 unifroms</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>colorProgramInfo<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    u_color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    u_view<span class="token punctuation">:</span> viewMatrix<span class="token punctuation">,</span>\n    u_projection<span class="token punctuation">:</span> projectionMatrix<span class="token punctuation">,</span>\n    u_world<span class="token punctuation">:</span> mat\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 调用 gl.drawArrays 或者 gl.drawElements</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">drawBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> cubeLinesBufferInfo<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了这些，现在我们可以更加容易地看到投影位于哪里了。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/7n5fyf?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>有一点需要注意的是，我们并没有真正地投影该纹理。我们在做的是相反的事情。即对被渲染物体的每一个像素，我们判断纹理的哪一部分是被投影到该像素上的，然后再查找该部分纹理上的颜色。</p>\n<p>既然我们在上面提到了电影放映机，那么我们如何模拟一台电影放映机呢？我们只需要简单地使用一个投影矩阵来乘以它（即上面的纹理矩阵）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58771862996050770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const settings = {\n  cameraX: 2.75,\n  cameraY: 5,\n  posX: 2.5,\n  posY: 4.8,\n  posZ: 4.3,\n  targetX: 2.5,\n  targetY: 0,\n  targetZ: 3.5,\n  projWidth: 1,\n  projHeight: 1,\n  perspective: true,\n  fieldOfView: 45\n};\n\n// ...\n\nfunction drawScene(projectionMatrix, cameraMatrix) {\n  // 从相机矩阵中创建一个视图矩阵\n  const viewMatrix = m4.inverse(cameraMatrix);\n\n  const textureWorldMatrix = m4.lookAt(\n    [settings.posX, settings.posY, settings.posZ], // position\n    [settings.targetX, settings.targetY, settings.targetZ], // target\n    [0, 1, 0] // up\n  );\n  // textureWorldMatrix = m4.scale(textureWorldMatrix, settings.projWidth, settings.projHeight, 1);\n\n  const textureProjectionMatrix = settings.perspective\n    ? m4.perspective(\n        degToRad(settings.fieldOfView),\n        settings.projWidth / settings.projHeight,\n        0.1, // near\n        200\n      ) // far\n    : m4.orthographic(\n        -settings.projWidth / 2, // left\n        settings.projWidth / 2, // right\n        -settings.projHeight / 2, // bottom\n        settings.projHeight / 2, // top\n        0.1, // near\n        200\n      ); // far\n\n  // 使用这个世界矩阵的逆矩阵来创建\n  // 一个矩阵，该矩阵会变换其他世界坐标\n  // 为相对于这个空间的坐标。\n  // const textureMatrix = m4.inverse(textureWorldMatrix);\n  const textureMatrix = m4.multiply(textureProjectionMatrix, m4.inverse(textureWorldMatrix));\n}`, `58771862996050770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{12-13,27,29-43,48-49}"\n              >\n                <span class="gatsby-code-button-language">js{12-13,27,29-43,48-49}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> settings <span class="token operator">=</span> <span class="token punctuation">{</span>\n  cameraX<span class="token punctuation">:</span> <span class="token number">2.75</span><span class="token punctuation">,</span>\n  cameraY<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>\n  posX<span class="token punctuation">:</span> <span class="token number">2.5</span><span class="token punctuation">,</span>\n  posY<span class="token punctuation">:</span> <span class="token number">4.8</span><span class="token punctuation">,</span>\n  posZ<span class="token punctuation">:</span> <span class="token number">4.3</span><span class="token punctuation">,</span>\n  targetX<span class="token punctuation">:</span> <span class="token number">2.5</span><span class="token punctuation">,</span>\n  targetY<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n  targetZ<span class="token punctuation">:</span> <span class="token number">3.5</span><span class="token punctuation">,</span>\n  projWidth<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n  projHeight<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  perspective<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  fieldOfView<span class="token punctuation">:</span> <span class="token number">45</span></span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token keyword">function</span> <span class="token function">drawScene</span><span class="token punctuation">(</span><span class="token parameter">projectionMatrix<span class="token punctuation">,</span> cameraMatrix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 从相机矩阵中创建一个视图矩阵</span>\n  <span class="token keyword">const</span> viewMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>cameraMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> textureWorldMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>\n    <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>posX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>posY<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>posZ<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// position</span>\n    <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>targetX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>targetY<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>targetZ<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// target</span>\n    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// up</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  <span class="token comment">// textureWorldMatrix = m4.scale(textureWorldMatrix, settings.projWidth, settings.projHeight, 1);</span></span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> textureProjectionMatrix <span class="token operator">=</span> settings<span class="token punctuation">.</span>perspective</span><span class="gatsby-highlight-code-line">    <span class="token operator">?</span> m4<span class="token punctuation">.</span><span class="token function">perspective</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">        <span class="token function">degToRad</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span>fieldOfView<span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        settings<span class="token punctuation">.</span>projWidth <span class="token operator">/</span> settings<span class="token punctuation">.</span>projHeight<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token comment">// near</span></span><span class="gatsby-highlight-code-line">        <span class="token number">200</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">)</span> <span class="token comment">// far</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">:</span> m4<span class="token punctuation">.</span><span class="token function">orthographic</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">        <span class="token operator">-</span>settings<span class="token punctuation">.</span>projWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// left</span></span><span class="gatsby-highlight-code-line">        settings<span class="token punctuation">.</span>projWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// right</span></span><span class="gatsby-highlight-code-line">        <span class="token operator">-</span>settings<span class="token punctuation">.</span>projHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// bottom</span></span><span class="gatsby-highlight-code-line">        settings<span class="token punctuation">.</span>projHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// top</span></span><span class="gatsby-highlight-code-line">        <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token comment">// near</span></span><span class="gatsby-highlight-code-line">        <span class="token number">200</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// far</span></span>\n  <span class="token comment">// 使用这个世界矩阵的逆矩阵来创建</span>\n  <span class="token comment">// 一个矩阵，该矩阵会变换其他世界坐标</span>\n  <span class="token comment">// 为相对于这个空间的坐标。</span>\n<span class="gatsby-highlight-code-line">  <span class="token comment">// const textureMatrix = m4.inverse(textureWorldMatrix);</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> textureMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>textureProjectionMatrix<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>textureWorldMatrix<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意，我添加了一个选项，可以选择是使用透视投影矩阵还是使用正交投影矩阵。</p>\n<p>在绘制线框的时候我们也需要使用那个投影矩阵</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27577251388549050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ------ 绘制立方体 ------\n\n// ...\n\n// // 在 Z 轴上缩放该立方体，\n// // 以便表示该纹理是被投影到无限远的。\n// const mat = m4.scale(textureWorldMatrix, 1, 1, 1000);\n\n// 调整立方体使其匹配该投影\nconst mat = m4.multiply(textureWorldMatrix, m4.inverse(textureProjectionMatrix));`, `27577251388549050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ------ 绘制立方体 ------</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token comment">// // 在 Z 轴上缩放该立方体，</span>\n<span class="token comment">// // 以便表示该纹理是被投影到无限远的。</span>\n<span class="token comment">// const mat = m4.scale(textureWorldMatrix, 1, 1, 1000);</span>\n\n<span class="token comment">// 调整立方体使其匹配该投影</span>\n<span class="token keyword">const</span> mat <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>textureWorldMatrix<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>textureProjectionMatrix<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了这些，我们就得到了</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/1co2ct?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>它已经正常工作了，但我们的投影和我们的线框立方体都只是使用了 0 到 1 的空间，所以它只使用到了投影视椎体的 1/4。</p>\n<p>要修复这个问题，首先让我们的立方体在所有方向上都是 -1 到 +1</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78526531964075000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const cubeLinesBufferInfo = webglUtils.createBufferInfoFromArrays(gl, {\n  position: [\n    //   0,  0, -1,\n    //   1,  0, -1,\n    //   0,  1, -1,\n    //   1,  1, -1,\n    //   0,  0,  1,\n    //   1,  0,  1,\n    //   0,  1,  1,\n    //   1,  1,  1,\n    -1,\n    -1,\n    -1,\n    1,\n    -1,\n    -1,\n    -1,\n    1,\n    -1,\n    1,\n    1,\n    -1,\n    -1,\n    -1,\n    1,\n    1,\n    -1,\n    1,\n    -1,\n    1,\n    1,\n    1,\n    1,\n    1\n  ],\n  indices: [0, 1, 1, 3, 3, 2, 2, 0, 4, 5, 5, 7, 7, 6, 6, 4, 0, 4, 1, 5, 3, 7, 2, 6]\n});`, `78526531964075000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3-34}"\n              >\n                <span class="gatsby-code-button-language">js{3-34}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> cubeLinesBufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  position<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n<span class="gatsby-highlight-code-line">    <span class="token comment">//   0,  0, -1,</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//   1,  0, -1,</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//   0,  1, -1,</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//   1,  1, -1,</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//   0,  0,  1,</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//   1,  0,  1,</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//   0,  1,  1,</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//   1,  1,  1,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token number">1</span></span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>\n  indices<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后当将其用于纹理矩阵时，我们需要使视椎体内的空间范围是 0 到 1。这可以通过使空间偏移 0.5 然后将其缩放 0.5 倍来实现。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19499454613670265000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const textureWorldMatrix = m4.lookAt(\n  [settings.posX, settings.posY, settings.posZ], // position\n  [settings.targetX, settings.targetY, settings.targetZ], // target\n  [0, 1, 0] // up\n);\n\nconst textureProjectionMatrix = settings.perspective\n  ? m4.perspective(\n      degToRad(settings.fieldOfView),\n      settings.projWidth / settings.projHeight,\n      0.1, // near\n      200\n    ) // far\n  : m4.orthographic(\n      -settings.projWidth / 2, // left\n      settings.projWidth / 2, // right\n      -settings.projHeight / 2, // bottom\n      settings.projHeight / 2, // top\n      0.1, // near\n      200\n    ); // far\n\n// // 使用这个世界矩阵的逆矩阵来创建\n// // 一个矩阵，该矩阵会变换其他世界坐标\n// // 为相对于这个空间的坐标。\n// const textureMatrix = m4.multiply(textureProjectionMatrix, m4.inverse(textureWorldMatrix));\n\nlet textureMatrix = m4.identity();\ntextureMatrix = m4.translate(textureMatrix, 0.5, 0.5, 0.5);\ntextureMatrix = m4.scale(textureMatrix, 0.5, 0.5, 0.5);\ntextureMatrix = m4.multiply(textureMatrix, textureProjectionMatrix);\n// 使用这个世界矩阵的逆矩阵来创建\n// 一个矩阵，该矩阵会变换其他世界坐标\n// 为相对于这个空间的坐标。\ntextureMatrix = m4.multiply(textureMatrix, m4.inverse(textureWorldMatrix));`, `19499454613670265000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{23-26,28-35}"\n              >\n                <span class="gatsby-code-button-language">js{23-26,28-35}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> textureWorldMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>\n  <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>posX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>posY<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>posZ<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// position</span>\n  <span class="token punctuation">[</span>settings<span class="token punctuation">.</span>targetX<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>targetY<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>targetZ<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// target</span>\n  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// up</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> textureProjectionMatrix <span class="token operator">=</span> settings<span class="token punctuation">.</span>perspective\n  <span class="token operator">?</span> m4<span class="token punctuation">.</span><span class="token function">perspective</span><span class="token punctuation">(</span>\n      <span class="token function">degToRad</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span>fieldOfView<span class="token punctuation">)</span><span class="token punctuation">,</span>\n      settings<span class="token punctuation">.</span>projWidth <span class="token operator">/</span> settings<span class="token punctuation">.</span>projHeight<span class="token punctuation">,</span>\n      <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token comment">// near</span>\n      <span class="token number">200</span>\n    <span class="token punctuation">)</span> <span class="token comment">// far</span>\n  <span class="token punctuation">:</span> m4<span class="token punctuation">.</span><span class="token function">orthographic</span><span class="token punctuation">(</span>\n      <span class="token operator">-</span>settings<span class="token punctuation">.</span>projWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// left</span>\n      settings<span class="token punctuation">.</span>projWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// right</span>\n      <span class="token operator">-</span>settings<span class="token punctuation">.</span>projHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// bottom</span>\n      settings<span class="token punctuation">.</span>projHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// top</span>\n      <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token comment">// near</span>\n      <span class="token number">200</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// far</span>\n\n<span class="gatsby-highlight-code-line"><span class="token comment">// // 使用这个世界矩阵的逆矩阵来创建</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// // 一个矩阵，该矩阵会变换其他世界坐标</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// // 为相对于这个空间的坐标。</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// const textureMatrix = m4.multiply(textureProjectionMatrix, m4.inverse(textureWorldMatrix));</span></span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">let</span> textureMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">textureMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>textureMatrix<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">textureMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>textureMatrix<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">textureMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>textureMatrix<span class="token punctuation">,</span> textureProjectionMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// 使用这个世界矩阵的逆矩阵来创建</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// 一个矩阵，该矩阵会变换其他世界坐标</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// 为相对于这个空间的坐标。</span></span><span class="gatsby-highlight-code-line">textureMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>textureMatrix<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>textureWorldMatrix<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，它看起来可以正常工作了</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/1b2dir?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>那么，平面投影一个纹理有什么作用呢？</p>\n<ol>\n<li>\n<p>因为你想要这么做，大多数 3D 建模软件都提供了一种将一个纹理进行平面投影的方法。</p>\n</li>\n<li>\n<p>另一个作用是贴花（decal）。贴花是一种在物体表面上放置溅射的油漆或爆炸痕迹的方式。要实现贴花，通常不会使用上面着色器的那种做法。相反，你需要写一些函数来遍历需要应用贴花的模型的几何。对于每一个三角形，你需要检查该三角形是否位于该贴花的范围内，这与 JavaScript 的着色器例子中的 inRange 检查一样。对于在贴花范围内的每个三角形，你把该三角形和投影的纹理坐标添加到某个新的几何中。然后你把该贴花添加到你的绘制列表中。</p>\n<p>为贴花生成几何是对的，否则你就需要为 2 个贴花、3 个贴、4 个贴花等等提供不同的着色器，然后你的着色器很快就会变得很复杂，并达到 GPUs 着色器的纹理限制。</p>\n</li>\n<li>\n<p>还有另一个作用是模拟真实世界的投影映射。你对一个物体进行了 3D 建模，你将会把视频投影到该模型上，你使用了类似上面那样的代码来实现投影，除了你的纹理是视频外。然后你可以编辑并完善该视频，使其匹配该模型，而不用在实际现场中使用一个真正的投影仪。</p>\n</li>\n<li>\n<p>这种投影的另一个用处就是用阴影映射来计算阴影。</p>\n</li>\n</ol>\n<h2 id="在条件语句内的纹理引用"><a href="#%E5%9C%A8%E6%9D%A1%E4%BB%B6%E8%AF%AD%E5%8F%A5%E5%86%85%E7%9A%84%E7%BA%B9%E7%90%86%E5%BC%95%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>在条件语句内的纹理引用</h2>\n<p>在上面的片段着色器中，在所有的情况下我们都对两个纹理进行了读取</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41502011023003200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`  vec4 projectedTexColor = texture2D(u_projectedTexture, projectedTexcoord.xy);\n  vec4 texColor = texture2D(u_texture, v_texcoord) * u_colorMult;\n\n  float projectedAmount = inRange ? 1.0 : 0.0;\n  gl_FragColor = mix(texColor, projectedTexColor, projectedAmount);`, `41502011023003200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl">  <span class="token keyword">vec4</span> projectedTexColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_projectedTexture<span class="token punctuation">,</span> projectedTexcoord<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">vec4</span> texColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span> <span class="token operator">*</span> u_colorMult<span class="token punctuation">;</span>\n\n  <span class="token keyword">float</span> projectedAmount <span class="token operator">=</span> inRange <span class="token operator">?</span> <span class="token number">1.0</span> <span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">;</span>\n  gl_FragColor <span class="token operator">=</span> <span class="token function">mix</span><span class="token punctuation">(</span>texColor<span class="token punctuation">,</span> projectedTexColor<span class="token punctuation">,</span> projectedAmount<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为什么我们不像下面这样做呢？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79268796024493130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (inRange) {\n   gl_FragColor = texture2D(u_projectedTexture, projectedTexcoord.xy);\n} else {\n   gl_FragColor = texture2D(u_texture, v_texcoord) * u_colorMult;\n}`, `79268796024493130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">if</span> <span class="token punctuation">(</span>inRange<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_projectedTexture<span class="token punctuation">,</span> projectedTexcoord<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n   gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span> <span class="token operator">*</span> u_colorMult<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>摘自 <a href="https://www.khronos.org/files/opengles_shading_language.pdf" target="_blank" rel="nofollow noreferrer noopener">GLSL ES 1.0 spec Appendix A, Section 6</a></p>\n<p>Texture Accesses</p>\n<p>Accessing mip-mapped textures within the body of a non-uniform conditional block gives an undefined value. A non-uniform conditional block is a block whose execution cannot be determined at compile time.</p>\n<p>换句话说，如果我们要使用 mip-mapped 的纹理，那我们就必须确保总是能够访问到它们。我们可以在条件语句内使用访问纹理的结果。例如我们可以写成这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31448008859132260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`vec4 projectedTexColor = texture2D(u_projectedTexture, projectedTexcoord.xy);\nvec4 texColor = texture2D(u_texture, v_texcoord) * u_colorMult;\n\nif (inRange) {\n   gl_FragColor = projectedTexColor;\n} else {\n   gl_FragColor = texColor;\n}`, `31448008859132260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">vec4</span> projectedTexColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_projectedTexture<span class="token punctuation">,</span> projectedTexcoord<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">vec4</span> texColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span> <span class="token operator">*</span> u_colorMult<span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>inRange<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   gl_FragColor <span class="token operator">=</span> projectedTexColor<span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n   gl_FragColor <span class="token operator">=</span> texColor<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>或者这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55927493379015480"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`vec4 projectedTexColor = texture2D(u_projectedTexture, projectedTexcoord.xy);\nvec4 texColor = texture2D(u_texture, v_texcoord) * u_colorMult;\n\ngl_FragColor = inRange ? projectedTexColor : texColor;`, `55927493379015480`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">vec4</span> projectedTexColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_projectedTexture<span class="token punctuation">,</span> projectedTexcoord<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">vec4</span> texColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_texture<span class="token punctuation">,</span> v_texcoord<span class="token punctuation">)</span> <span class="token operator">*</span> u_colorMult<span class="token punctuation">;</span>\n\ngl_FragColor <span class="token operator">=</span> inRange <span class="token operator">?</span> projectedTexColor <span class="token punctuation">:</span> texColor<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是我们不能在条件语句内访问 mip-mapped 的纹理本身。这样做在你的 GPU 上可能是可行的，但并不是在所有的 GPUs 上都能行。注意，规范没有说明能否在条件语句内访问 non-mipmapped 的纹理，所以，如果你确定你的纹理是 non-mipmapped 的，那就没什么问题。</p>\n<p>无论如何，重要的是你要知道有这么个东西</p>\n<p>至于我为什么使用 mix 而不使用基于 inRange 的三元运算符，则只是一个个人喜好。mix 更加灵活，所以我通常这样写。</p>\n<h1 id="webgl-渐变纹理"><a href="#webgl-%E6%B8%90%E5%8F%98%E7%BA%B9%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 渐变纹理</h1>\n<p>WebGL 中的一个重要认识是纹理不仅仅是直接应用于三角形的东西，正如我们在纹理文章中所介绍的那样。纹理是随机访问数据的数组，通常是二维数据数组。因此，使用随机访问数据数组的任何解决方案都是我们可以使用纹理的地方。</p>\n<p>在关于定向光的文章中，我们介绍了如何使用点积来计算 2 个向量之间的角度。在那里 ​ 我们计算了光的方向与模型表面法线的点积，这提供了 2 个向量之间角度的余弦值。余弦是从 -1 到 +1 的值，我们将其用作颜色的直接乘数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18957883320809832000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`float light = dot(normal, u_reverseLightDirection);\n\ngl_FragColor = u_color;\ngl_FragColor.rgb *= light;`, `18957883320809832000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">float</span> light <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> u_reverseLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngl_FragColor <span class="token operator">=</span> u_color<span class="token punctuation">;</span>\ngl_FragColor<span class="token punctuation">.</span>rgb <span class="token operator">*</span><span class="token operator">=</span> light<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这会使颜色变暗，使其远离光线。</p>\n<p>如果我们不直接使用该点积，而是使用它从一维纹理中查找值，该怎么办？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27547181138791620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 从顶点着色器传入\nvarying vec3 v_normal;\n\nuniform vec3 u_reverseLightDirection;\nuniform vec4 u_color;\nuniform sampler2D u_ramp;\n\nvoid main() {\n  // 因为 v_normal 是一个变量，所以它是插值的\n  // 所以它不会是单位向量。规范化它\n  // 将再次使其成为单位向量\n  vec3 normal = normalize(v_normal);\n\n  // float light = dot(normal, u_reverseLightDirection);\n  float cosAngle = dot(normal, u_reverseLightDirection);\n\n  // 从 -1 <-> 1 转换为 0 <-> 1\n  float u = cosAngle * 0.5 + 0.5;\n\n  // 创建一个纹理坐标\n  vec2 uv = vec2(u, 0.5);\n\n  // 从一维纹理中查找一个值\n  vec4 rampColor = texture2D(u_ramp, uv);\n\n  gl_FragColor = u_color;\n  // gl_FragColor.rgb *= light;\n  gl_FragColor *= rampColor;\n}`, `27547181138791620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{8,16-26,29-30}"\n              >\n                <span class="gatsby-code-button-language">glsl{8,16-26,29-30}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器传入</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_reverseLightDirection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_color<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_ramp<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 因为 v_normal 是一个变量，所以它是插值的</span>\n  <span class="token comment">// 所以它不会是单位向量。规范化它</span>\n  <span class="token comment">// 将再次使其成为单位向量</span>\n  <span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_normal<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// float light = dot(normal, u_reverseLightDirection);</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">float</span> cosAngle <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> u_reverseLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 从 -1 &lt;-> 1 转换为 0 &lt;-> 1</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">float</span> u <span class="token operator">=</span> cosAngle <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 创建一个纹理坐标</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec2</span> uv <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 从一维纹理中查找一个值</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec4</span> rampColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_ramp<span class="token punctuation">,</span> uv<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  gl_FragColor <span class="token operator">=</span> u_color<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  <span class="token comment">// gl_FragColor.rgb *= light;</span></span><span class="gatsby-highlight-code-line">  gl_FragColor <span class="token operator">*</span><span class="token operator">=</span> rampColor<span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们需要制作纹理，让我们从 2x1 纹理开始，我们将使用 LUMINANCE 为我们提供单色纹理的格式，每个纹理像素仅使用 1 个字节。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13250123285342140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var tex = gl.createTexture();\ngl.bindTexture(gl.TEXTURE_2D, tex);\ngl.texImage2D(\n  gl.TEXTURE_2D, // 目标\n  0, // mip 级别\n  gl.LUMINANCE, // 内部格式\n  2, // 宽度\n  1, // 高度\n  0, // 边界\n  gl.LUMINANCE, // 格式\n  gl.UNSIGNED_BYTE, // 类型\n  new Uint8Array([90, 255])\n);\n\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);`, `13250123285342140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> tex <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>\n  gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token comment">// 目标</span>\n  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// mip 级别</span>\n  gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> <span class="token comment">// 内部格式</span>\n  <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// 宽度</span>\n  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 高度</span>\n  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 边界</span>\n  gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> <span class="token comment">// 格式</span>\n  gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token comment">// 类型</span>\n  <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面 2 个像素的颜色是深灰色（90）和白色（255）。我们还设置了纹理参数，因此不会有过滤。</p>\n<p>修改新纹理的样本，我们需要查找 <code class="language-text">u_ramp</code> 变量</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31702012141166215000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var worldViewProjectionLocation = gl.getUniformLocation(program, \'u_worldViewProjection\');\nvar worldInverseTransposeLocation = gl.getUniformLocation(program, \'u_worldInverseTranspose\');\nvar colorLocation = gl.getUniformLocation(program, \'u_color\');\nvar rampLocation = gl.getUniformLocation(program, \'u_ramp\');\nvar reverseLightDirectionLocation = gl.getUniformLocation(program, \'u_reverseLightDirection\');`, `31702012141166215000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4}"\n              >\n                <span class="gatsby-code-button-language">js{4}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> worldViewProjectionLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_worldViewProjection\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> worldInverseTransposeLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_worldInverseTranspose\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> colorLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_color\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> rampLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_ramp\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token keyword">var</span> reverseLightDirectionLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_reverseLightDirection\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们需要在渲染时设置纹理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1863572687400849700"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 将纹理绑定到活动纹理单元 0\ngl.activeTexture(gl.TEXTURE0 + 0);\ngl.bindTexture(gl.TEXTURE_2D, tex);\n// 告诉着色器 u_ramp 应该使用纹理单元 0 上的纹理\ngl.uniform1i(rampLocation, 0);`, `1863572687400849700`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 将纹理绑定到活动纹理单元 0</span>\ngl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 告诉着色器 u_ramp 应该使用纹理单元 0 上的纹理</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>rampLocation<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我将 3D 的 F 数据换成了低多边形头部的数据。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/kcp967?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>如果您旋转模型，您会看到它看起来类似于卡通着色</p>\n<p>在上面的示例中，我们设置了纹理过滤，NEAREST 这意味着我们只需从纹理中选择最近的纹理元作为我们的颜色。只有 2 个纹理元，所以如果表面背对光，我们得到第一种颜色（深灰色），如果表面朝向光，我们得到第二种颜色（白色），那种颜色乘以以前的 <code class="language-text">gl_FragColor</code> 颜色 light。</p>\n<p>考虑一下，如果我们切换到 LINEAR 过滤，我们应该得到与使用纹理之前相同的结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34025983624313730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\n// gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\ngl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);`, `34025983624313730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);</span>\n<span class="token comment">// gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/l4glzu?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>这看起来很相似，但如果我们真的将它们并排比较…</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-04-11-29-57-14a5e68319db0e0b4c46b1ff79381961-21746.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 449px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 64.3652561247216%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAADBUlEQVQozzWSWUhUYRiGv3NmsiKjaBPKbCNHs8lyKzNnierCii5aKDLaLiL0JkxpIb1pY4o0GbIizcqxKTemUrIy7aIgQtRWg8ql6ejoWf4zc5Y5e0ei7/bjeV94eIFDkQgKnxVvJqn5icK+g8OlQfJPlBNphkH/T0NSM+pIH8q3fdie82Jv54+3qqAwDANBlsiTikHLwPQcnM+GPltye173YJ8Q4WmGZhDDo8gFrhYfXwtf7VjnCniwcNrVZbe77oucCDf4BtBXW9WNuO7G2A0x3VlwZ/bxpiKNV0iGEhDXz/6awbtgJNPyJQvrsFsfJEPZnKUnU0OhEHj4OtAzLZobdCcIuZbudKiIO1RbIHOSCYuI/8h+jwm7gFgHvWnw2o4/TIJTcUuO2weHB+Eh1w5aDqY4QXJgPWnWppVwbXZp4LIR1cdp0jQyxAYTRnZAjx17ZQe/bdL5xXBiVkaxQwjzEOC6QMsF1Qm6C9pXWj9mwatFl1rLDckwYdMlER5NDO2G9yvw39l4Y3LM5SVQG59dtlnmovA88hY0B2hOMFzY0xTrMzN+wbWA11Am4DBiQ2jMTu2H4TW44cafpkwuioerce7TWyfgPrZ/sroJ1Fww3JY6m/XCIqiY73vt1yWNpKl/tjdSBUCkWiQX/ihp6q65UDgj/+IRRZBhmP0zU80DfQMmO/FAClZvwz0J7e9fyqJM0TSFKAMpO9EpGFtlGVqP31k+pTgBCmOLKks0SQWR4bdJJRPCZTf+PQtaltmurycIIhwOmzOgEK0j5Qb1GIKrLJ8ysZZka/lSODYz0PVEkRTgycg7pjdWdkN0Hf4tA67Pu/umToqIlNmKkLkzkiTpMdoxdBQ+2yY1p8DJafuuHOZZbpwch4jAGZx+X26bb+ya/tVxrtNjyIYQFVmWNZvNfl7k9ajWzw1k/jwQ25q+5dYeYpTQVE0QBPD7/RWVFV1tHcWeM5575fV3fV6vt6amJhgMmu+BgYGqqqpKb2XgcUtDU8OxssLGhsZ6X311dbWvzvcXek/OY1qTglsAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 04 11 29 57" title="" data-src="/static/2022-08-04-11-29-57-14a5e68319db0e0b4c46b1ff79381961-21746.png" data-srcset="/static/2022-08-04-11-29-57-14a5e68319db0e0b4c46b1ff79381961-17e1d.png 200w,\n/static/2022-08-04-11-29-57-14a5e68319db0e0b4c46b1ff79381961-f4f9f.png 400w,\n/static/2022-08-04-11-29-57-14a5e68319db0e0b4c46b1ff79381961-21746.png 449w" data-sizes="(max-width: 449px) 100vw, 449px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>我们可以看到它们并不相同。这是怎么回事？</p>\n<p>LINEAR 过滤像素之间的混合。如果我们使用线性过滤放大 2 像素纹理，我们会看到问题</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-08-04-11-30-56-8770bb457ba3f3deaef88cc5339f1648-cf56a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 353px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 141.07648725212462%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAIAAADuuAg3AAAACXBIWXMAAAsSAAALEgHS3X78AAADz0lEQVQ4y9WU/09bVRTAz3t9lNKWbVW+StjMTCZqBhpggFtbYMyYmGjMYL/qzyJC8AcT/wLdYrb94H9gRCPQ0v02ddCaEDu3BXBz2BYKhX6BAhPoe+9+eb3X+/qAH8z8aT8YTz4575x37sm5556bC/fu33u08DunVJB4/Ph+NPqHcBljhDycm3uwMI8ZLXIWW47PPZwXGJwVuZFMLc9GfwMd6To/EML5HmPo0EWMMxFjhzFcoiSsyAgmQFUVBUNoPIgmgjgwpU8ESCCkC3s8WAgGQ3vT4zg8oc0EcHhcnZ5E4Ql9xmIH74K2ukrtdg7AJUloKgwAJpl6zyV7cm8APyfRdjDaAbWDZQhI25y6CHoqZTg9XHbyskquuA3FLTQrc3PJtXf8WNWGD/jFMtqrGL0K7lEsw+i1kZ4FNQb6asqwV3Kwc6mCg8MAh9BMErp8z+X0bJwH3i1RPxh+wD6wDAHxzWv/3+RnO7BV419GtWuOqgV4m0RawWgF3Aq0DYwSpLU0qlxO630bey9iX59A8/URrwnv6tvvvfTW9kedfNiHh/x4yFsY9GmDPv1jgVcdjGspoBijeIIklizUxcX9pdiTVCyfTaRzsdx6LLu5tLKzHNtPLhaSCbSWwCZxlNKIbvaMnB5DdtKySqq4VcWZqnfMdrp+uOz5aqhu5ItT/d80Nd9pUWId8q5PQT0WNq376JK4OZTx0glTyZ6rs9/tdAb6T9wcrh29dnLguzNnf2mWVzpA80LRfwA9GlX5MZFmHrhUQWRHtr482uWaHPDcGK4bvXrqytjLzZEWW7ITVJ9kdFsA8T9lzkQqz9bZo53Oyf4TNz6pHb16cmDszNlIs5zsANV7MGRrzup/mixumOO4SOM2l2ib2CqyDY5ol3ty4LmbI/WfXnvxylhTS+R1JdklqX7Z6LGQSPdRz6KmxCWFg42CnKuW77bbJ953Xx96fuTLFy5/+9KrkdfklTbQ3oTihQPo+XntT9DX06jhtFHVQGsbaU2jWt2w9kr9r5caAx+c/vqzps+vN3/4/bkLEW9NvK/qr3dq0HsW1dq7j7QlMAhB6QzJZAU4ndHX1lEuo25k9reyT7bSWzuZrf2NnPDR5jraTOPNDMkLhIEIgqIQZj6QrKTX0umNfJ4YBkJY03QBRpgSur21vbaaOlomNKUUTKdYPIAxrVDQVJUQbAoSopsGwaqmFdQCMx/tQ1gR+DPIP5PFRoqlLYiPqCOqWn9K9YkZemqy1Uw+v3n79o/BqVA4EpkJh2/dCv30853p6ZnZ2dmpqdBycuVopZC/AT4yAzC0BuxdAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 08 04 11 30 56" title="" data-src="/static/2022-08-04-11-30-56-8770bb457ba3f3deaef88cc5339f1648-cf56a.png" data-srcset="/static/2022-08-04-11-30-56-8770bb457ba3f3deaef88cc5339f1648-da624.png 200w,\n/static/2022-08-04-11-30-56-8770bb457ba3f3deaef88cc5339f1648-cf56a.png 353w" data-sizes="(max-width: 353px) 100vw, 353px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>每边有半个像素，没有插值。想象一下，如果纹理设置 <code class="language-text">TEXTURE_WRAP_S</code> 为 REPEAT，然后我们期望红色像素的最左半部分线性地向绿色混合，就好像绿色向左重复一样。但是左边的颜色更红，因为我们使用的是 <code class="language-text">CLAMP_TO_EDGE</code></p>\n<p>要真正获得渐变，我们只想从该中心范围中选择值。我们可以通过着色器中的一些数学运算来做到这一点</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17515117473784736000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 从顶点着色器传入\nvarying vec3 v_normal;\n\nuniform vec3 u_reverseLightDirection;\nuniform vec4 u_color;\nuniform sampler2D u_ramp;\nuniform vec2 u_rampSize;\n\nvoid main() {\n  // 因为 v_normal 是一个变量，所以它是插值的\n  // 所以它不会是单位向量。规范化它\n  // 将再次使其成为单位向量\n  vec3 normal = normalize(v_normal);\n\n  float cosAngle = dot(normal, u_reverseLightDirection);\n\n  // 从 -1 <-> 1 转换为 0 <-> 1\n  float u = cosAngle * 0.5 + 0.5;\n\n  // 制作纹理坐标\n  vec2 uv = vec2(u, 0.5);\n\n  // 缩放到渐变的大小\n  vec2 texelRange = uv * (u_rampSize - 1.0);\n\n  // 偏移半个纹理元并转换为纹理坐标\n  vec2 rampUV = (texelRange + 0.5) / u_rampSize;\n\n  // vec4 rampColor = texture2D(u_ramp, uv);\n  vec4 rampColor = texture2D(u_ramp, rampUV);\n\n  gl_FragColor = u_color;\n  gl_FragColor *= rampColor;\n}`, `17515117473784736000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{9,25-29,31-32}"\n              >\n                <span class="gatsby-code-button-language">glsl{9,25-29,31-32}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器传入</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_reverseLightDirection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_color<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_ramp<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">vec2</span> u_rampSize<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 因为 v_normal 是一个变量，所以它是插值的</span>\n  <span class="token comment">// 所以它不会是单位向量。规范化它</span>\n  <span class="token comment">// 将再次使其成为单位向量</span>\n  <span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_normal<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">float</span> cosAngle <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> u_reverseLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 从 -1 &lt;-> 1 转换为 0 &lt;-> 1</span>\n  <span class="token keyword">float</span> u <span class="token operator">=</span> cosAngle <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 制作纹理坐标</span>\n  <span class="token keyword">vec2</span> uv <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 缩放到渐变的大小</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec2</span> texelRange <span class="token operator">=</span> uv <span class="token operator">*</span> <span class="token punctuation">(</span>u_rampSize <span class="token operator">-</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 偏移半个纹理元并转换为纹理坐标</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec2</span> rampUV <span class="token operator">=</span> <span class="token punctuation">(</span>texelRange <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">/</span> u_rampSize<span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line">  <span class="token comment">// vec4 rampColor = texture2D(u_ramp, uv);</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec4</span> rampColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_ramp<span class="token punctuation">,</span> rampUV<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  gl_FragColor <span class="token operator">=</span> u_color<span class="token punctuation">;</span>\n  gl_FragColor <span class="token operator">*</span><span class="token operator">=</span> rampColor<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面我们基本上是在缩放我们的 uv 坐标，所以它从 0 到 1 比纹理的宽度小 1。然后添加半个像素并转换回标准化纹理坐标。</p>\n<p>我们需要查找位置 <code class="language-text">u_rampSize</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33293396077412307000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var colorLocation = gl.getUniformLocation(program, \'u_color\');\nvar rampLocation = gl.getUniformLocation(program, \'u_ramp\');\nvar rampSizeLocation = gl.getUniformLocation(program, \'u_rampSize\');`, `33293396077412307000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> colorLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_color\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> rampLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_ramp\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> rampSizeLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_rampSize\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>我们需要在渲染时设置它</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35725154937602710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 将纹理绑定到活动纹理单元 0\ngl.activeTexture(gl.TEXTURE0 + 0);\ngl.bindTexture(gl.TEXTURE_2D, tex);\n// 告诉着色器 u_ramp 应该使用纹理单元 0 上的纹理\ngl.uniform1i(rampLocation, 0);\ngl.uniform2fv(rampSizeLocation, [2, 1]);`, `35725154937602710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 将纹理绑定到活动纹理单元 0</span>\ngl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 告诉着色器 u_ramp 应该使用纹理单元 0 上的纹理</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>rampLocation<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>rampSizeLocation<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在我们运行它之前，让我们添加一个标志，以便我们可以比较有无渐变纹理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18124975773821240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 从顶点着色器传入\nvarying vec3 v_normal;\n\nuniform vec3 u_reverseLightDirection;\nuniform vec4 u_color;\nuniform sampler2D u_ramp;\nuniform vec2 u_rampSize;\nuniform bool u_useRampTexture;\n\nvoid main() {\n  // 因为 v_normal 是一个变量，所以它是插值的\n  // 所以它不会是单位向量。规范化它\n  // 将再次使其成为单位向量\n  vec3 normal = normalize(v_normal);\n\n  float cosAngle = dot(normal, u_reverseLightDirection);\n\n  // 从 -1 <-> 1 转换为 0 <-> 1\n  float u = cosAngle * 0.5 + 0.5;\n\n  // 制作纹理坐标\n  vec2 uv = vec2(u, 0.5);\n\n  // 缩放到渐变的大小\n  vec2 texelRange = uv * (u_rampSize - 1.0);\n\n  // 偏移半个纹理元并转换为纹理坐标\n  vec2 rampUV = (texelRange + 0.5) / u_rampSize;\n\n  vec4 rampColor = texture2D(u_ramp, rampUV);\n\n  if (!u_useRampTexture) {\n    rampColor = vec4(u, u, u, 1);\n  }\n\n  gl_FragColor = u_color;\n  gl_FragColor *= rampColor;\n}`, `18124975773821240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{10,34-36}"\n              >\n                <span class="gatsby-code-button-language">glsl{10,34-36}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器传入</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_reverseLightDirection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_color<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_ramp<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec2</span> u_rampSize<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">bool</span> u_useRampTexture<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 因为 v_normal 是一个变量，所以它是插值的</span>\n  <span class="token comment">// 所以它不会是单位向量。规范化它</span>\n  <span class="token comment">// 将再次使其成为单位向量</span>\n  <span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_normal<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">float</span> cosAngle <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> u_reverseLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 从 -1 &lt;-> 1 转换为 0 &lt;-> 1</span>\n  <span class="token keyword">float</span> u <span class="token operator">=</span> cosAngle <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 制作纹理坐标</span>\n  <span class="token keyword">vec2</span> uv <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 缩放到渐变的大小</span>\n  <span class="token keyword">vec2</span> texelRange <span class="token operator">=</span> uv <span class="token operator">*</span> <span class="token punctuation">(</span>u_rampSize <span class="token operator">-</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 偏移半个纹理元并转换为纹理坐标</span>\n  <span class="token keyword">vec2</span> rampUV <span class="token operator">=</span> <span class="token punctuation">(</span>texelRange <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">/</span> u_rampSize<span class="token punctuation">;</span>\n\n  <span class="token keyword">vec4</span> rampColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_ramp<span class="token punctuation">,</span> rampUV<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>u_useRampTexture<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    rampColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> u<span class="token punctuation">,</span> u<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  gl_FragColor <span class="token operator">=</span> u_color<span class="token punctuation">;</span>\n  gl_FragColor <span class="token operator">*</span><span class="token operator">=</span> rampColor<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们也会查找 uniform 的位置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28105216478758720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var rampLocation = gl.getUniformLocation(program, \'u_ramp\');\nvar rampSizeLocation = gl.getUniformLocation(program, \'u_rampSize\');\nvar useRampTextureLocation = gl.getUniformLocation(program, \'u_useRampTexture\');`, `28105216478758720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3}"\n              >\n                <span class="gatsby-code-button-language">js{3}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> rampLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_ramp\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> rampSizeLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_rampSize\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> useRampTextureLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_useRampTexture\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>并设置它</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72145371122258400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var data = {\n  useRampTexture: true\n};\n\n// ...\n\n// 将纹理绑定到活动纹理单元 0\ngl.activeTexture(gl.TEXTURE0 + 0);\ngl.bindTexture(gl.TEXTURE_2D, tex);\n// 告诉着色器 u_ramp 应该使用纹理单元 0 上的纹理\ngl.uniform1i(rampLocation, 0);\ngl.uniform2fv(rampSizeLocation, [2, 1]);\n\ngl.uniform1i(useRampTextureLocation, data.useRampTexture);`, `72145371122258400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{14}"\n              >\n                <span class="gatsby-code-button-language">js{14}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>\n  useRampTexture<span class="token punctuation">:</span> <span class="token boolean">true</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 将纹理绑定到活动纹理单元 0</span>\ngl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 告诉着色器 u_ramp 应该使用纹理单元 0 上的纹理</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>rampLocation<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>rampSizeLocation<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>useRampTextureLocation<span class="token punctuation">,</span> data<span class="token punctuation">.</span>useRampTexture<span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>并且我们可以看到旧的光照方式和新的渐变纹理方式匹配</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/hhj00m?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>单击 useRampTexture 复选框，我们看不到任何变化，因为这两种技术现在匹配。</p>\n<blockquote>\n<p>注意：我通常不建议 <code class="language-text">u_useRampTexture</code> 在着色器中使用条件。相反，我建议制作 2 个着色器程序，一个使用普通光照，一个使用渐变纹理。不幸的是，由于代码没有使用类似于 out helper 库的东西，因此支持 2 个着色器程序将进行相当大的更改。每个程序都需要自己的一组位置。做出如此大的改变会分散本文的重点，因此在这种情况下，我决定使用条件。一般来说，虽然我尽量避免使用条件来选择着色器中的特征，而是为不同的特征创建不同的着色器。</p>\n</blockquote>\n<blockquote>\n<p>注意：这个数学只有在我们使用 LINEAR 过滤时才重要。如果我们使用 NEAREST 过滤，我们需要原始数学。</p>\n</blockquote>\n<p>现在我们知道渐变数学是正确的，让我们制作一堆不同的渐变纹理。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67860058188079410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建一个 256 数组，其中元素 0 到 127\n// 从 64 到 191 和元素 128 到 255\n// 都是 255\nconst smoothSolid = new Array(256).fill(255);\nfor (let i = 0; i < 128; ++i) {\n  smoothSolid[i] = 64 + i;\n}\n\nconst ramps = [\n  { name: \'dark-white\', color: [0.2, 1, 0.2, 1], format: gl.LUMINANCE, filter: false, data: [80, 255] },\n  {\n    name: \'dark-white-skewed\',\n    color: [0.2, 1, 0.2, 1],\n    format: gl.LUMINANCE,\n    filter: false,\n    data: [80, 80, 80, 255, 255]\n  },\n  { name: \'normal\', color: [0.2, 1, 0.2, 1], format: gl.LUMINANCE, filter: true, data: [0, 255] },\n  { name: \'3-step\', color: [0.2, 1, 0.2, 1], format: gl.LUMINANCE, filter: false, data: [80, 160, 255] },\n  { name: \'4-step\', color: [0.2, 1, 0.2, 1], format: gl.LUMINANCE, filter: false, data: [80, 140, 200, 255] },\n  {\n    name: \'4-step skewed\',\n    color: [0.2, 1, 0.2, 1],\n    format: gl.LUMINANCE,\n    filter: false,\n    data: [80, 80, 80, 80, 140, 200, 255]\n  },\n  { name: \'black-white-black\', color: [0.2, 1, 0.2, 1], format: gl.LUMINANCE, filter: false, data: [80, 255, 80] },\n  {\n    name: \'stripes\',\n    color: [0.2, 1, 0.2, 1],\n    format: gl.LUMINANCE,\n    filter: false,\n    data: [\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255,\n      80,\n      255\n    ]\n  },\n  {\n    name: \'stripe\',\n    color: [0.2, 1, 0.2, 1],\n    format: gl.LUMINANCE,\n    filter: false,\n    data: [\n      80,\n      80,\n      80,\n      80,\n      80,\n      80,\n      80,\n      80,\n      80,\n      80,\n      80,\n      80,\n      0,\n      0,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255,\n      255\n    ]\n  },\n  { name: \'smooth-solid\', color: [0.2, 1, 0.2, 1], format: gl.LUMINANCE, filter: false, data: smoothSolid },\n  { name: \'rgb\', color: [1, 1, 1, 1], format: gl.RGB, filter: true, data: [255, 0, 0, 0, 255, 0, 0, 0, 255] }\n];\n\nvar elementsForFormat = {};\nelementsForFormat[gl.LUMINANCE] = 1;\nelementsForFormat[gl.RGB] = 3;\n\nramps.forEach((ramp) => {\n  const { name, format, filter, data } = ramp;\n  var tex = gl.createTexture();\n  gl.bindTexture(gl.TEXTURE_2D, tex);\n  gl.pixelStorei(gl.UNPACK_ALIGNMENT, 1);\n  const width = data.length / elementsForFormat[format];\n  gl.texImage2D(\n    gl.TEXTURE_2D, // 目标\n    0, // mip 级别\n    format, // 内部格式\n    width,\n    1, // 高度\n    0, // 边界\n    format, // 格式\n    gl.UNSIGNED_BYTE, // 类型\n    new Uint8Array(data)\n  );\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, filter ? gl.LINEAR : gl.NEAREST);\n  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, filter ? gl.LINEAR : gl.NEAREST);\n  ramp.texture = tex;\n  ramp.size = [width, 1];\n});`, `67860058188079410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建一个 256 数组，其中元素 0 到 127</span>\n<span class="token comment">// 从 64 到 191 和元素 128 到 255</span>\n<span class="token comment">// 都是 255</span>\n<span class="token keyword">const</span> smoothSolid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">128</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  smoothSolid<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">64</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> ramps <span class="token operator">=</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'dark-white\'</span><span class="token punctuation">,</span> color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'dark-white-skewed\'</span><span class="token punctuation">,</span>\n    color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span>\n    filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'normal\'</span><span class="token punctuation">,</span> color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> filter<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'3-step\'</span><span class="token punctuation">,</span> color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">160</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'4-step\'</span><span class="token punctuation">,</span> color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'4-step skewed\'</span><span class="token punctuation">,</span>\n    color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span>\n    filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'black-white-black\'</span><span class="token punctuation">,</span> color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'stripes\'</span><span class="token punctuation">,</span>\n    color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span>\n    filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    data<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">255</span>\n    <span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'stripe\'</span><span class="token punctuation">,</span>\n    color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span>\n    filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    data<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">80</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">0</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span><span class="token punctuation">,</span>\n      <span class="token number">255</span>\n    <span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'smooth-solid\'</span><span class="token punctuation">,</span> color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">,</span> filter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> smoothSolid <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'rgb\'</span><span class="token punctuation">,</span> color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format<span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> filter<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">var</span> elementsForFormat <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\nelementsForFormat<span class="token punctuation">[</span>gl<span class="token punctuation">.</span><span class="token constant">LUMINANCE</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\nelementsForFormat<span class="token punctuation">[</span>gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>\n\nramps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ramp</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> format<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> ramp<span class="token punctuation">;</span>\n  <span class="token keyword">var</span> tex <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> tex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_ALIGNMENT</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> width <span class="token operator">=</span> data<span class="token punctuation">.</span>length <span class="token operator">/</span> elementsForFormat<span class="token punctuation">[</span>format<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>\n    gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token comment">// 目标</span>\n    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// mip 级别</span>\n    format<span class="token punctuation">,</span> <span class="token comment">// 内部格式</span>\n    width<span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 高度</span>\n    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 边界</span>\n    format<span class="token punctuation">,</span> <span class="token comment">// 格式</span>\n    gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token comment">// 类型</span>\n    <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> filter <span class="token operator">?</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span> <span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span> filter <span class="token operator">?</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span> <span class="token punctuation">:</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  ramp<span class="token punctuation">.</span>texture <span class="token operator">=</span> tex<span class="token punctuation">;</span>\n  ramp<span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token punctuation">[</span>width<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>让我们制作着色器，这样我们就可以同时处理 NEAREST 和 LINEAR。就像我上面提到的，我通常不在着色器中使用布尔 if 语句，但如果区别很简单并且我可以在没有条件的情况下做到这一点，那么我会考虑使用一个着色器。为此，我们可以添加一个 <code class="language-text">u_linearAdjust</code>，我们将其设置为 0.0 或 1.0</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39870792169298650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 从顶点着色器传入\nvarying vec3 v_normal;\n\nuniform vec3 u_reverseLightDirection;\nuniform vec4 u_color;\nuniform sampler2D u_ramp;\nuniform vec2 u_rampSize;\n// uniform bool u_useRampTexture;\n// uniform float u_linearAdjust; // 如果是线性的，则为 1.0，如果是最近的，则为 0.0\n\nvoid main() {\n  // 因为 v_normal 是一个变量，所以它是插值的\n  // 所以它不会是单位向量，规范化它\n  // 将再次使其成为单位向量\n  vec3 normal = normalize(v_normal);\n\n  float cosAngle = dot(normal, u_reverseLightDirection);\n\n  // 从 -1 <-> 1 转换为 0 <-> 1\n  float u = cosAngle * 0.5 + 0.5;\n\n  // 制作纹理坐标\n  vec2 uv = vec2(u, 0.5);\n\n  // 缩放到渐变的大小\n  // vec2 texelRange = uv * (u_rampSize - 1.0);\n  vec2 texelRange = uv * (u_rampSize - u_linearAdjust);\n\n  // // 偏移半个纹理元并转换为纹理坐标\n  // vec2 rampUV = (texelRange + 0.5) / u_rampSize;\n  // 如果是线性的，则偏移半个纹理元并转换为纹理坐标\n  vec2 rampUV = (texelRange + 0.5 * u_linearAdjust) / u_rampSize;\n\n  vec4 rampColor = texture2D(u_ramp, rampUV);\n\n  // if (!u_useRampTexture) {\n  //   rampColor = vec4(u, u, u, 1);\n  // }\n\n  gl_FragColor = u_color;\n  gl_FragColor *= rampColor;\n}`, `39870792169298650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{10-11,28-29,31-34,38-40}"\n              >\n                <span class="gatsby-code-button-language">glsl{10-11,28-29,31-34,38-40}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器传入</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_reverseLightDirection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_color<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_ramp<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec2</span> u_rampSize<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// uniform bool u_useRampTexture;</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// uniform float u_linearAdjust; // 如果是线性的，则为 1.0，如果是最近的，则为 0.0</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 因为 v_normal 是一个变量，所以它是插值的</span>\n  <span class="token comment">// 所以它不会是单位向量，规范化它</span>\n  <span class="token comment">// 将再次使其成为单位向量</span>\n  <span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_normal<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">float</span> cosAngle <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> u_reverseLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 从 -1 &lt;-> 1 转换为 0 &lt;-> 1</span>\n  <span class="token keyword">float</span> u <span class="token operator">=</span> cosAngle <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 制作纹理坐标</span>\n  <span class="token keyword">vec2</span> uv <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 缩放到渐变的大小</span>\n<span class="gatsby-highlight-code-line">  <span class="token comment">// vec2 texelRange = uv * (u_rampSize - 1.0);</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec2</span> texelRange <span class="token operator">=</span> uv <span class="token operator">*</span> <span class="token punctuation">(</span>u_rampSize <span class="token operator">-</span> u_linearAdjust<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line">  <span class="token comment">// // 偏移半个纹理元并转换为纹理坐标</span></span><span class="gatsby-highlight-code-line">  <span class="token comment">// vec2 rampUV = (texelRange + 0.5) / u_rampSize;</span></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 如果是线性的，则偏移半个纹理元并转换为纹理坐标</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec2</span> rampUV <span class="token operator">=</span> <span class="token punctuation">(</span>texelRange <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> u_linearAdjust<span class="token punctuation">)</span> <span class="token operator">/</span> u_rampSize<span class="token punctuation">;</span></span>\n  <span class="token keyword">vec4</span> rampColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_ramp<span class="token punctuation">,</span> rampUV<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// if (!u_useRampTexture) {</span></span><span class="gatsby-highlight-code-line">  <span class="token comment">//   rampColor = vec4(u, u, u, 1);</span></span><span class="gatsby-highlight-code-line">  <span class="token comment">// }</span></span>\n  gl_FragColor <span class="token operator">=</span> u_color<span class="token punctuation">;</span>\n  gl_FragColor <span class="token operator">*</span><span class="token operator">=</span> rampColor<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在初始化时查找位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49701873008433070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var colorLocation = gl.getUniformLocation(program, \'u_color\');\nvar rampLocation = gl.getUniformLocation(program, \'u_ramp\');\nvar rampSizeLocation = gl.getUniformLocation(program, \'u_rampSize\');\nvar linearAdjustLocation = gl.getUniformLocation(program, \'u_linearAdjust\');`, `49701873008433070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4}"\n              >\n                <span class="gatsby-code-button-language">js{4}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> colorLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_color\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> rampLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_ramp\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> rampSizeLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_rampSize\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> linearAdjustLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_linearAdjust\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>并在渲染时选择其中一个纹理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65857034139535970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var data = {\n  ramp: 0\n};\n\n// ...\n\nconst { texture, color, size, filter } = ramps[data.ramp];\n\n// 设置要使用的颜色\n// gl.uniform4fv(colorLocation, [0.2, 1, 0.2, 1]);\ngl.uniform4fv(colorLocation, color);\n\n// 设置光照方向\ngl.uniform3fv(reverseLightDirectionLocation, m4.normalize([-1.75, 0.7, 1]));\n\n// 将纹理绑定到活动纹理单元 0\ngl.activeTexture(gl.TEXTURE0 + 0);\n// gl.bindTexture(gl.TEXTURE_2D, tex);\ngl.bindTexture(gl.TEXTURE_2D, texture);\n\n// 告诉着色器 u_ramp 应该使用纹理单元 0 上的纹理\ngl.uniform1i(rampLocation, 0);\n// gl.uniform2fv(rampSizeLocation, [2, 1]);\ngl.uniform2fv(rampSizeLocation, size);\n\n// 如果是线性调整\ngl.uniform1f(linearAdjustLocation, filter ? 1 : 0);`, `65857034139535970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{7,10-11,18-19,23-24,26-27}"\n              >\n                <span class="gatsby-code-button-language">js{7,10-11,18-19,23-24,26-27}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>\n  ramp<span class="token punctuation">:</span> <span class="token number">0</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> <span class="token punctuation">{</span> texture<span class="token punctuation">,</span> color<span class="token punctuation">,</span> size<span class="token punctuation">,</span> filter <span class="token punctuation">}</span> <span class="token operator">=</span> ramps<span class="token punctuation">[</span>data<span class="token punctuation">.</span>ramp<span class="token punctuation">]</span><span class="token punctuation">;</span></span>\n<span class="token comment">// 设置要使用的颜色</span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// gl.uniform4fv(colorLocation, [0.2, 1, 0.2, 1]);</span></span><span class="gatsby-highlight-code-line">gl<span class="token punctuation">.</span><span class="token function">uniform4fv</span><span class="token punctuation">(</span>colorLocation<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="token comment">// 设置光照方向</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform3fv</span><span class="token punctuation">(</span>reverseLightDirectionLocation<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1.75</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 将纹理绑定到活动纹理单元 0</span>\ngl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// gl.bindTexture(gl.TEXTURE_2D, tex);</span></span><span class="gatsby-highlight-code-line">gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="token comment">// 告诉着色器 u_ramp 应该使用纹理单元 0 上的纹理</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>rampLocation<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// gl.uniform2fv(rampSizeLocation, [2, 1]);</span></span><span class="gatsby-highlight-code-line">gl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>rampSizeLocation<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// 如果是线性调整</span></span><span class="gatsby-highlight-code-line">gl<span class="token punctuation">.</span><span class="token function">uniform1f</span><span class="token punctuation">(</span>linearAdjustLocation<span class="token punctuation">,</span> filter <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/zgif20?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>尝试不同的渐变纹理，你会看到很多奇怪的效果。这是制作通用调整着色器的一种方法。您可以通过设置 2 种颜色和像这样的阈值来制作进行 2 种颜色卡通着色的着色器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65838676583353830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`uniform vec4 color1;\nuniform vec4 color2;\nuniform float threshold;\n\n// ...\n\nfloat cosAngle = dot(normal, u_reverseLightDirection);\n\n// 从 -1 <-> 1 转换为 0 <-> 1\nfloat u = cosAngle * 0.5 + 0.5;\n\ngl_FragColor = mix(color1, color2, step(cosAngle, threshold));`, `65838676583353830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">uniform</span> <span class="token keyword">vec4</span> color1<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> color2<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">float</span> threshold<span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token keyword">float</span> cosAngle <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> u_reverseLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从 -1 &lt;-> 1 转换为 0 &lt;-> 1</span>\n<span class="token keyword">float</span> u <span class="token operator">=</span> cosAngle <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">;</span>\n\ngl_FragColor <span class="token operator">=</span> <span class="token function">mix</span><span class="token punctuation">(</span>color1<span class="token punctuation">,</span> color2<span class="token punctuation">,</span> <span class="token function">step</span><span class="token punctuation">(</span>cosAngle<span class="token punctuation">,</span> threshold<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>它会起作用。但是，如果您想要 3 步或 4 步版本，则需要编写另一个着色器。使用渐变纹理，您可以提供不同的纹理。此外，请注意上面，即使您想要一个 2 步色调着色器，您仍然可以通过在纹理中放置更多或更少的数据来调整步进发生的位置。例如纹理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2701879047140876000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[dark, light]`, `2701879047140876000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">[dark, light]</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>为您提供 2 步纹理，其中它在面向或远离光线的中间分裂。但质地像</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26862981011113660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[dark, dark, dark, light, light]`, `26862981011113660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">[dark, dark, dark, light, light]</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>无需更改着色器即可将拆分移动到背对光和朝向光之间的 60% 标记。</p>\n<p>这个使用渐变纹理进行卡通着色或奇怪效果的具体示例可能对您有用也可能不那么有用，但更重要的结论只是使用一些值在纹理中查找数据的基本概念。使用这样的纹理不仅仅是为了转换光照计算。您可以使用渐变纹理进行后期处理，以实现与 Photoshop 中的渐变贴图相同的效果</p>\n<p>您还可以将渐变纹理用于基于 GPU 的动画。您将关键值存储在纹理中，并使用时间作为在纹理上移动的值。这种技术有很多用途。</p>',
excerpt:"WebGL 三维纹理 在 WebGL…",frontmatter:{date:"2022-07-27 14:35:19",path:"/webgl-fundamental-textures/",tags:"前端, 可视化, WebGL, 读书笔记",title:"WebGL 理论基础——纹理",draft:null}}},pathContext:{mainPostPath:"/docker-introduce-learning/",nextPostPath:"/webgl-fundamental-geometry/",prePostPath:"/webgl-fundamental-textures/"}}}});