webpackJsonp([33668472382135],{1480:function(n,a){n.exports={data:{site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}}},pathContext:{posts:[{excerpt:"…",html:'<h1 id="语法综述"><a href="#%E8%AF%AD%E6%B3%95%E7%BB%BC%E8%BF%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>语法综述</h1>\n<p>语言中的标识符一般可以分为两类，一类用于命名语法、符号等抽象概念，另一类用于命名数据（的存储位置）。前者被称为“语法关键字”，后者则被称为“变量”和“常量”。</p>\n<p>由此引入了一个概念：绑定。从标识符的角度来说，绑定分为语法关键字与语义逻辑的绑定，以及变量与它所存储数据和位置性质的绑定。</p>\n<p>其中，语法关键字对语义逻辑的绑定结果，是对作用域的限定；变量对位置性质的绑定结果，则是对变量生存周期的限定</p>\n<h2 id="标识符所绑定的语义"><a href="#%E6%A0%87%E8%AF%86%E7%AC%A6%E6%89%80%E7%BB%91%E5%AE%9A%E7%9A%84%E8%AF%AD%E4%B9%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>标识符所绑定的语义</h2>\n<p>所谓声明，即约定数据的生存周期和逻辑的作用域</p>\n<ul>\n<li>纯粹陈述“数据”的过程，被称为变量和类型声明</li>\n<li>纯粹陈述“逻辑”的过程，被称为语句（含流程控制子句）。</li>\n<li>陈述“数据与（算法的）逻辑”的关系的过程，被称为表达式。</li>\n</ul>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-27-20-18-23-e74e56622481acc0c3632ceed54cba74-00ca1.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 79.97601918465229%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAAAsSAAALEgHS3X78AAAB60lEQVQoz1WTC4/BQBSF5///p7UkVCphSbQlinqsxdKipd72Mydrs5Pgztxz7j33zDD3+/12uz0ej49m0w+Cfr/vVKuO45QrlVKp5NZq9UbjrVB4LxbLjuO6ruf7gKFANI/fdTqd2F+v1zzPL5cL2/1+fzgczufzIc+Jc7tIvShmMpmMx2O+u92u7/ufdgVBwPbLrl4YdjodtrPZjK3neagDP5/PDZ84jlerFQpJEEyn0yiKRqPRYrEg2+v1Wq1WvV5vt9vEg8GAw2+7zHa73Ww2aNvtdqhiGGJKrNdrztGWpiniUctEStFsOBxS2ojDKWgKAYGP8uPxqMEoAQGYfGKbZRnlYBl+OAUKk5gAbxhPckCoM2T5RyFSDAXmKZsEqpbLJQkppDOW6ArpAx8CZLacA4OVJInBwDAM0SwxdCbAEqDEdBYttYsAO2UqzQx7nFC3YRShghJYCk1DZlYthS524RY91czwAaEHAFqPBFVnu3gqQGkuMinRYrv+Oqs88Gf5JDnZgLqQmYJCKq0puGTwhgGIgDIDHuqSGAkvdHlplnEi8/imIZ0pQcpILeTXxRLjDU301HFBXsIkpZlhET9n1t+A/ughpgp3qJhzOijWFoH/XhhoCiMVMaQpR445lZI3chQYc5ECzOEPQe6C8347q6QAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 27 20 18 23" title="" data-src="/static/2021-09-27-20-18-23-e74e56622481acc0c3632ceed54cba74-fee1c.png" data-srcset="/static/2021-09-27-20-18-23-e74e56622481acc0c3632ceed54cba74-a67b7.png 200w,\n/static/2021-09-27-20-18-23-e74e56622481acc0c3632ceed54cba74-0b187.png 400w,\n/static/2021-09-27-20-18-23-e74e56622481acc0c3632ceed54cba74-fee1c.png 800w,\n/static/2021-09-27-20-18-23-e74e56622481acc0c3632ceed54cba74-00ca1.png 834w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<ul>\n<li>“符号（Symbol）”是 ES6 添加的新数据类型，可以同其他数据一样绑定给变量或标识符。</li>\n<li>表达式首先是与数据相关的，但因为存在运算的先后顺序，所以也有逻辑相关的含义。</li>\n<li>JavaScript 中的逻辑语句是有值的，因此它也是数据相关的。这一点与其他多数语言不一样。</li>\n<li>一些模块的实现方案与逻辑（例如流程控制）相关，例如 Node.js。但一些实现方案则是逻辑无关的，例如 ECMAScript 的静态模块机制就是如此，它只描述模块之间的依赖关系。</li>\n</ul>\n<p>除了“声明”在语义上对绑定内容的限制之外，当一个被声明的标识符（变量、常量或符号等）去绑定一个数据时，事实上还有其他两个方面的语义：数据（受作用域限制）的生存周期及可写性。这三者是 JavaScript 在</p>\n<ul>\n<li>用于显式数据声明的语句 let/var/const、函数声明与类声明</li>\n<li>for 语句、<code class="language-text">try...catch</code> 语句、赋值语句</li>\n<li>在函数调用和 new 运算符等语法中通过形式参数传入值</li>\n</ul>\n<p>这些语义中都存在着隐式或显式数据声明的原因：它们有着各自在“作用域、值和可写性”三方面的不同性质。</p>\n<p>从 ES6 开始提供了一些新的具有绑定标识符语义的语法，尽管在这几类绑定操作上存在着处理细节上的不同，但总体还是围绕上述三种性质来设计的，如表 2-2 所示</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-27-20-24-53-2acbc2f5dd068cd2ee7766a181d59700-68451.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 46.03550295857988%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAABPUlEQVQoz1WQWWuDUBSE/f8/Jg8hD6FQCQbzUC+IpEFISI1Z3KLiRt2y9Iu3Kekgh/HcmbMp9ydutxvREMLZ7WzbfldVdTbT5nNN0z6EgHyuVn8yCeX+H23bdl1H/B4gf5u2resa/trmYfZ933Xdw+FA3O/3xOPxeDqdyBAZwTRNx3E8z0MpZev1erlchmGobLdb+wVCiLcBlmXBR6PRZDJBulgsILquG4YxHo+n0+lms3l0/nIcuhHjOKYeDSFFUQRBQKskSeBykDRNoyhCQxKuoGNKUjyfz+c8z8mihmRZdhnA2lVV9X1/vV55Yn8IGQWbXJIR2I3InXhumgYdheDYZFGqUJE8mbIsFYbYuS5mLsE8j/P2PV9/ueQD5MGZUzbHjO3XTBYbx2RsVsDTDsCfFwWKbsDrCNJcleUPGzPtQZzzD6sAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 27 20 24 53" title="" data-src="/static/2021-09-27-20-24-53-2acbc2f5dd068cd2ee7766a181d59700-fee1c.png" data-srcset="/static/2021-09-27-20-24-53-2acbc2f5dd068cd2ee7766a181d59700-a67b7.png 200w,\n/static/2021-09-27-20-24-53-2acbc2f5dd068cd2ee7766a181d59700-0b187.png 400w,\n/static/2021-09-27-20-24-53-2acbc2f5dd068cd2ee7766a181d59700-fee1c.png 800w,\n/static/2021-09-27-20-24-53-2acbc2f5dd068cd2ee7766a181d59700-68451.png 845w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<ul>\n<li>在实参中传入 undefined 值，表明对应的形参使用参数默认值</li>\n<li>使用 const/let/var 时可以理解为“标识符声明+一般赋值运算”两个步骤。但在一般赋值运算过程中，其左侧操作数尽管可以使用赋值模板和剩余参数的语法，但是不具有标识符声明的语义（变量的隐式声明除外）</li>\n</ul>\n<p>表 2-2 意味着其实只有“展开运算”是作为运算符来使用的，其他所有特性都是声明语法中的绑定，它们在词法阶段就决定了标识符的那些性质，例如它与（将来的）值之间的关系。</p>\n<h2 id="识别语法错误与运行错误"><a href="#%E8%AF%86%E5%88%AB%E8%AF%AD%E6%B3%95%E9%94%99%E8%AF%AF%E4%B8%8E%E8%BF%90%E8%A1%8C%E9%94%99%E8%AF%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>识别语法错误与运行错误</h2>\n<p>一般来说，JavaScript 引擎会在代码装入时先进行语法分析，如果语法分析通不过，整个脚本代码块都不执行；当语法分析通过时，脚本代码才会执行。若在执行过程中出错，那么在同一代码上下文中、出错点之后的代码将不再执行。</p>\n<p>不同引擎处理这两类错误的提示的策略并不相同，在 Node.js 中可以方便地使用 <code class="language-text">require()</code> 将脚本文件作为一个模块来装载，并有效地识别、提示这两类错误信息。例如</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-27-20-28-05-9f63a00aab5384dbbe6a18d4fae0ff7a-fac45.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 34.944237918215606%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAAApklEQVQY04WQUQ6DIBBEuf+hQEQDKiBCiban6QvGv2rnY7Pqzs5bhTHGORdj7LrOe/9qqrXu+/5pet9LDMOgtbbWSilp2EUzTVPOuTYdx3FrJmFZlnmet22jAeGsCJBSypM5pRRCIIfpdV2ZprKIb/+xTRPJSqlxHAHu+55HLsdJLGh34YK/hZmb8XA/fi6nAZ6XIMDCot9mtp4XMkRlOl2Cn9gH7C8I0ljXSuALgAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 27 20 28 05" title="" data-src="/static/2021-09-27-20-28-05-9f63a00aab5384dbbe6a18d4fae0ff7a-fee1c.png" data-srcset="/static/2021-09-27-20-28-05-9f63a00aab5384dbbe6a18d4fae0ff7a-a67b7.png 200w,\n/static/2021-09-27-20-28-05-9f63a00aab5384dbbe6a18d4fae0ff7a-0b187.png 400w,\n/static/2021-09-27-20-28-05-9f63a00aab5384dbbe6a18d4fae0ff7a-fee1c.png 800w,\n/static/2021-09-27-20-28-05-9f63a00aab5384dbbe6a18d4fae0ff7a-fac45.png 807w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>事实上，Node.js 命令行上传入的主文件也是作为模块加载的，因此下面的示例与上述效果相同：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-27-20-28-38-2bc4fd7dbd9a49acb166385ab9f35471-6ec11.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 23.739237392373923%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAAAdElEQVQY04WPSQrAIBAE/f+nBHHB5WCMW3xNGicegoHUYWjE6lGmtY4xcs6llOei93696Rs4ZMYYay0qENCC7JyrtV5/jDGYUopkOKWUnDPmWNClH1kI4b2HRs9urdUJhf0XjxxCSCnRhHZMsD9NqA4Vn/INoaj4nr1Yv8wAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 27 20 28 38" title="" data-src="/static/2021-09-27-20-28-38-2bc4fd7dbd9a49acb166385ab9f35471-fee1c.png" data-srcset="/static/2021-09-27-20-28-38-2bc4fd7dbd9a49acb166385ab9f35471-a67b7.png 200w,\n/static/2021-09-27-20-28-38-2bc4fd7dbd9a49acb166385ab9f35471-0b187.png 400w,\n/static/2021-09-27-20-28-38-2bc4fd7dbd9a49acb166385ab9f35471-fee1c.png 800w,\n/static/2021-09-27-20-28-38-2bc4fd7dbd9a49acb166385ab9f35471-6ec11.png 813w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>或者，也可以直接使用 Node.js 在命令行上做语法检测：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-27-20-29-04-1a8fb5e93f15cc99d1f0508fb5d3d3d7-6ec11.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 19.68019680196802%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAXElEQVQI142OwQ3AIAwD2X+oPIiAEKCiSCD6YZZaTJB7WP6cbEdEtVZkjFFVc84iUkr5DLje+5zzvaCstfbe5xyTjB2s6eW54Ai6SWbmlFIIwXuPtyittTGGRf4BQo3Ganpe4G8AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 27 20 29 04" title="" data-src="/static/2021-09-27-20-29-04-1a8fb5e93f15cc99d1f0508fb5d3d3d7-fee1c.png" data-srcset="/static/2021-09-27-20-29-04-1a8fb5e93f15cc99d1f0508fb5d3d3d7-a67b7.png 200w,\n/static/2021-09-27-20-29-04-1a8fb5e93f15cc99d1f0508fb5d3d3d7-0b187.png 400w,\n/static/2021-09-27-20-29-04-1a8fb5e93f15cc99d1f0508fb5d3d3d7-fee1c.png 800w,\n/static/2021-09-27-20-29-04-1a8fb5e93f15cc99d1f0508fb5d3d3d7-6ec11.png 813w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="声明"><a href="#%E5%A3%B0%E6%98%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>声明</h1>\n<p>JavaScript 是弱类型语言。但所谓弱类型语言，只表明该语言在表达式运算中不强制校验操作数的数据类型，而并不表明该语言是否具有类型系统。</p>\n<h2 id="变量的数据类型"><a href="#%E5%8F%98%E9%87%8F%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>变量的数据类型</h2>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-27-20-32-49-5b6657c9e25ce7dd743dba8ce31a209e-3f6d7.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 53.26215895610914%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABe0lEQVQoz1WR527CQBCE7/0fKkKhSBFS4AfC5VwptgF3MC4U5+OsKGEEqznf7s7snng8Hn3fbzabxXIZRpFlWYZh6Lqu6frXfP69WIwnk8l0+jkef4xG09msrmvyqXo+n6JX6LquaRrOt9utbVv4+XzOi4LULM/haZrGSZJm2f1+738hTNMMwxBB3/chHHFxPB4Ph8MQT6fTwAcSBMF+vydGUSQM04St12vquVsq4JwvmCeuVisppeM4cM/zXNdFZhATmLxer1VVEbGNPXptt1uawyFkIxvHMcrkMCDOiWVZiqIomJNrBoOQjQ4KLC8IQ9txKObv+T7izIUMxWRmWSb4c2YAPNOYYtu2mQXneJOWZUrpei8wRZIkaNQKcEEzDLADrqvLhbUgyK9QyPO8VIAjk6vN/xUzDA9DC+4gfBqWSSR1eLnuHa0CGxGsgWak4pxKjtgelsmQPBuEW0Zr3vEq3u12WCKDPAQZj2Jem0qiVNA0DWtolP+AzA+G8VnzluMFFwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 27 20 32 49" title="" data-src="/static/2021-09-27-20-32-49-5b6657c9e25ce7dd743dba8ce31a209e-fee1c.png" data-srcset="/static/2021-09-27-20-32-49-5b6657c9e25ce7dd743dba8ce31a209e-a67b7.png 200w,\n/static/2021-09-27-20-32-49-5b6657c9e25ce7dd743dba8ce31a209e-0b187.png 400w,\n/static/2021-09-27-20-32-49-5b6657c9e25ce7dd743dba8ce31a209e-fee1c.png 800w,\n/static/2021-09-27-20-32-49-5b6657c9e25ce7dd743dba8ce31a209e-3f6d7.png 843w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<ul>\n<li>直到 JavaScript 1.3/ES3 时，字符串都是不能通过下标来索引单个字符的。在 ES5 之后，规范约定将字符串下标索引理解为属性存取；在 ES6 之后，字符串被映射为可迭代对象，因此也可以用 <code class="language-text">for...of</code> 来列举单个字符，但这种情况下得到的字符是迭代成员（而不是属性描述符）</li>\n<li>在 JavaScript 中，函数的多重含义包括函数、方法、构造器、生成器、类以及函数对象等</li>\n<li>在 ES6 以前，因为不具备对象系统的全部特性，因此 JavaScript 通常被称为基于对象而非面向对象的语言。而在 ES6 中标准化了 class 和 super 等关键字以支持基于类继承的面向</li>\n</ul>\n<h3 id="基本数据类型"><a href="#%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基本数据类型</h3>\n<p>任何一个变量或值的类型都可以（而且应当首先）使用 typeof 运算得到。typeof 是 JavaScript 内部保留的一个关键字，它是一个运算符而不是一个函数。尽管它看起来可以像函数调用一样在后面跟上一对括号，例如</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-28-13-51-58-6f8ec63dd47cc38f7b68ba5235d88eaa-167f8.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 755px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 22.649006622516556%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAAAX0lEQVQY05WPyQ3AIAwE6b8pQOIUEBseHN1kRRpw5uHfaMcqhJBzNsZorUspvfc555GhiAgCXcYYzLz3lsq11tZaSinGiLvWOmLUc0Ew4r/sHzLWoHnvrbXOOezLf34BI/L5KyNjYkoAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 28 13 51 58" title="" data-src="/static/2021-09-28-13-51-58-6f8ec63dd47cc38f7b68ba5235d88eaa-167f8.png" data-srcset="/static/2021-09-28-13-51-58-6f8ec63dd47cc38f7b68ba5235d88eaa-acd3d.png 200w,\n/static/2021-09-28-13-51-58-6f8ec63dd47cc38f7b68ba5235d88eaa-69d76.png 400w,\n/static/2021-09-28-13-51-58-6f8ec63dd47cc38f7b68ba5235d88eaa-167f8.png 755w" data-sizes="(max-width: 755px) 100vw, 755px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="宿主定义的其他对象类型"><a href="#%E5%AE%BF%E4%B8%BB%E5%AE%9A%E4%B9%89%E7%9A%84%E5%85%B6%E4%BB%96%E5%AF%B9%E8%B1%A1%E7%B1%BB%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>宿主定义的其他对象类型</h3>\n<p>在具体宿主的实现上，ECMAScript 规范接受（但不推荐）typeof 返回上述 7 种类型之外的值。在这种情况下，该变量或值应该是一个宿主自定义的对象（是引用类型，而非其他值类型），并且不能实现对象的 <code class="language-text">[[call]]</code> 内部方法。因为一旦实现该方法，那么该对象的行为就与函数类型一致了。</p>\n<p>在早期的 JavaScript 语言中，正则表达式对象是可执行的，因此兼容这一早期特性（而又不得不遵循 ECMAScript 规范）的 JavaScript 引擎就只能为正则表达式对象的 typeof 值返回为 <code class="language-text">function</code>。</p>\n<h3 id="值类型与引用类型"><a href="#%E5%80%BC%E7%B1%BB%E5%9E%8B%E4%B8%8E%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>值类型与引用类型</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-28-13-57-18-1c57ff2947cd4b76f1feb2c3a535927c-87be2.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 774px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 47.02842377260982%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAABNUlEQVQoz22Q226CQBRF5///pfGh1sbUpJr6UkOCMCRFDQJVEKoSrxUtF1dnUl/qCiHnvs8ZUZZlXdfvg4E5HEZR9OG6lm1Lx+Hr9nrP7fZTq/XYbL52u2/9/kun89BoDC2LlqqqRK0oikJP0VGcSvFT/FKqLKHyD10pXNc1DCMMw8ViMRqNHMexpYzjeDweB0FAML7HbDZL01RMJhPLsnzfXy6X0rZN08QmIaX0PG+1WmF/3YN6kWXZZrO5KJIkYSrb5nl+Op30LXAzbhChQOjFdrvd4XDwgwA1DNz1es1clDOFdjUEKdjv90Knz+czarz2fD5nBWyGfipCBbfw96ZTIhzyrRCpAjUcngHl7XZ7PB456abDhYm6nEriKLEzLULfTic+ajTTgE0/K1B3+QdZVqPgCuIs78jD0dD4AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 28 13 57 18" title="" data-src="/static/2021-09-28-13-57-18-1c57ff2947cd4b76f1feb2c3a535927c-87be2.png" data-srcset="/static/2021-09-28-13-57-18-1c57ff2947cd4b76f1feb2c3a535927c-7e637.png 200w,\n/static/2021-09-28-13-57-18-1c57ff2947cd4b76f1feb2c3a535927c-40c63.png 400w,\n/static/2021-09-28-13-57-18-1c57ff2947cd4b76f1feb2c3a535927c-87be2.png 774w" data-sizes="(max-width: 774px) 100vw, 774px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>在 JavaScript 中，严格相等（===）运算符用来对值类型/引用类型的实际数据进行比较和检查。按照约定，在基于上述类型系统的运算中</p>\n<ul>\n<li>一般表达式运算的结果总是值</li>\n<li>函数/方法调用的结果可以返回值类型或者引用</li>\n<li>值与引用、值与值之间即使相等（==），也不一定严格相等（===）</li>\n<li>两个引用之间如果相等（==），则一定严格相等（===）</li>\n</ul>\n<p>同其他语言一样，在 JavaScript 中，值类型与引用类型也用于表明运算时使用数据的方式：参与运算的是其值还是其引用。因此，在下面的示例中，当两次调用函数 <code class="language-text">func()</code> 时，各自传入的数据采用了不同的方式：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79934662768162210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var str = \'abcde\';\nvar obj = new String(str);\n\nfunction newToString() {\n  return \'hello, world!\';\n}\n\nfunction func(val) {\n  val.toString = newToString;\n}\n\n// 示例 1：传入值\nfunc(str);\nconsole.log(str); // \'abcde\'\n\n// 示例 2：传入引用\nfunc(obj);\nconsole.log(String(obj)); // \'hello, world!\'`, `79934662768162210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">\'abcde\'</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">newToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token string">\'hello, world!\'</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  val<span class="token punctuation">.</span>toString <span class="token operator">=</span> newToString<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 示例 1：传入值</span>\n<span class="token function">func</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \'abcde\'</span>\n\n<span class="token comment">// 示例 2：传入引用</span>\n<span class="token function">func</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \'hello, world!\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从语义上来说，由于在示例 1 中实际只传入了 str 的值，因此对它的 toString 属性的修改是无意义的；而在示例 2 中传入了 obj 的引用，因此对它的 toString 属性的修改将会影响到后来调用 <code class="language-text">obj.toString()</code> 的效果。因此两个示例返回的结果不同</p>\n<h3 id="讨论：ecmascript-的类型系统"><a href="#%E8%AE%A8%E8%AE%BA%EF%BC%9Aecmascript-%E7%9A%84%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>讨论：ECMAScript 的类型系统</h3>\n<p>JavaScript 存在如下两套类型系统。</p>\n<ul>\n<li>类型系统 1: 7 种基本数据类型</li>\n<li>类型系统 2：值类型与引用类型</li>\n</ul>\n<p>然而 ECMAScript 规范又对类型系统做了另外的约定。</p>\n<ul>\n<li>类型系统 3：ECMAScript 语言类型（ECMAScript language types）</li>\n<li>类型系统 4：ECMAScript 规范类型（ECMAScript specification types）</li>\n<li>类型系统 5：对象类型（参见“3.4 JavaScript 的对象系统”）</li>\n<li>类型系统 6：原子对象类型系统（Atom objecttype）</li>\n</ul>\n<p>首先，ECMAScript 语言类型并不是“典型的” JavaScript 语言类型。试图使用 ECMAScript language types 来直接映射 JavaScript language types 是徒劳的，并且将会引入更多的混淆和不可解释的特例。</p>\n<p>ECMAScript 语言类型的存在，就是为了撰写 ECMAScript 规范本身，以明确叙述该语言的规范。这些数据类型与 JavaScript 对数据类型的约定有如下三点不同</p>\n<ul>\n<li>ECMAScript 语言类型用首字符大写的单词作为类型名，例如 Undefined；而 JavaScript 语言类型使用字符串作为类型名，且首字符小写，例如 undefined，并且叙述中通常在不混淆的情况下也可以省掉单/双引号来直接作为类型名，例如 undefined。</li>\n<li>ECMAScript 语言类型中的 Null 是一个类型，并且有一个唯一值 null；而在 JavaScript 语言类型中没有 Null 类型，null 值是对象类型的一个特殊实例</li>\n<li>ECMAScript 语言类型中没有函数类型，函数是对象类型的一个变体（Exotic Object），即对象类型的一种实现；而 JavaScript 语言类型中函数是第一类类型（First class type），即能用 typeof 关键字检查的、与 string、object 等同级别的基本类型</li>\n</ul>\n<p>ECMAScript 的这种类型定义极大地方便了它的规范制定。由于 Null 值是特殊的、在语言层面就被解释的（而不是作为对象类型的特例），因此它被广泛用于各种结构、定义和逻辑中的识别条件；反过来，由于 function 是对象的实例，因此大多数时候它就只需要按对象的特性来操作和处理。后者的典型表现，就是在 ECMAScript 中有一个专门的过程来判断“是/不是对象”，而无须用这一方式来判断“是/不是函数”</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65372191161725620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`... Type(v) is Object`, `65372191161725620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">... Type(v) is Object</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>基于此，ECMAScript 约定它的类型也可以归纳成两类：对象（Object）和基础类型（即除开 Object 之外的其他 6 种类型）。这两种类型是可以转换的，这些内部过程称为抽象操作（Abstract Operations），包括 <code class="language-text">ToPrimitive()</code> 和 <code class="language-text">ToObject()</code> 等</p>\n<p>我们接下来讨论“类型系统 4”，即 ECMAScript 规范类型。</p>\n<p>在 ECMAScript 规范类型中没有与上述两种语言类型（ECMAScript 或 JavaScript 的语言类型）重合的任何类型或语义。准确地说，所谓 ECMAScript 规范类型，就是为了在规范的行文中实现 ECMAScript 语言类型而存在的。总共约定了 10 种规范类型，包括：</p>\n<ul>\n<li>List、Record、Set、Relation，其中主要的是 List 和 Record 类型，是整个 ECMAScript 规范实现中采用最多的数据类型</li>\n<li>Completion Record、Reference、PropertyDescriptor，主要用来作为运算的结果（Result）或中间结果，其中属性描述符（Property Descriptor）是实现 JavaScript 对象时使用的核心组件</li>\n<li>Data Blocks，主要用在内存、共享数据等的描述中</li>\n<li>Lexical Environment、Environment Record，主要用在词法和运行期环境等的描述中。</li>\n</ul>\n<p>最后，重点地、再次总结一下上述内容，即</p>\n<ul>\n<li>ECMAScript 规范类型是为了实现 ECMAScript 语言类型而存在的。</li>\n<li>ECMAScript 语言类型是为了叙述 JavaScript 语言的规范而存在的。</li>\n</ul>\n<p>因此后文中将尽量避免使用和讨论 ECMAScript 规范类型，并且在多数情况下不会对 ECMAScript 语言类型的特殊性再作说明。</p>\n<h2 id="变量声明"><a href="#%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>变量声明</h2>\n<p>JavaScript 中的变量声明有两种方法：</p>\n<ul>\n<li>显式声明</li>\n<li>隐式声明（即用即声明）</li>\n</ul>\n<p>所谓显式声明，一般是指使用 var 等关键字进行的声明。一般语法为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92029146036532560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var variable1 [ = value1 ] [, variable2 [ = value2 ], ... ]\nlet variable2 = ...`, `92029146036532560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> variable1 <span class="token punctuation">[</span> <span class="token operator">=</span> value1 <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> variable2 <span class="token punctuation">[</span> <span class="token operator">=</span> value2 <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">...</span> <span class="token punctuation">]</span>\n<span class="token keyword">let</span> variable2 <span class="token operator">=</span> <span class="token operator">...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62878401772821820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 声明变量 str、num，以及 x、y\nvar str = \'test\';\nvar x,\n  y,\n  num = 3 + 2 - 5;`, `62878401772821820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 声明变量 str、num，以及 x、y</span>\n<span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">\'test\'</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> x<span class="token punctuation">,</span>\n  y<span class="token punctuation">,</span>\n  num <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>也包括在一些语句中使用 var 等关键字进行声明，例如 for 语句：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34986935111635400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 声明变量 n\nfor (var n in Object) {\n  // ...\n}\n// 声明变量 i, j, k\nfor (let i, j, k = 0; k < 100; k++) {\n  // ...\n}`, `34986935111635400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 声明变量 n</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> n <span class="token keyword">in</span> Object<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// 声明变量 i, j, k</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还有两种情况是具名函数声明和异常捕获子句中声明的异常对象。例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36286546693880672000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 声明函数 foo\nfunction foo() {\n  str = \'test\';\n}\n\n// 声明异常对象 e\ntry {\n  // ...\n} catch (e) {\n  // ...\n}`, `36286546693880672000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 声明函数 foo</span>\n<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  str <span class="token operator">=</span> <span class="token string">\'test\'</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 声明异常对象 e</span>\n<span class="token keyword">try</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>而隐式声明则发生在一般的赋值语句中。例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87940977852929160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 当 aVar 未被声明时，以下语句将隐式声明它\naVar = 100;`, `87940977852929160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 当 aVar 未被声明时，以下语句将隐式声明它</span>\naVar <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>解释器总是将显式声明理解为“变量声明”，而对隐式声明则不一定，如图 2-1 所示。</p>\n<ul>\n<li>如果变量未被声明，则先声明该变量并立即给它赋值</li>\n<li>如果变量已经声明过，则该语句是赋值语句</li>\n</ul>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-28-16-51-45-b8ae0277937b67e769cfe900630e81a9-5032e.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 438px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 69.40639269406392%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAACLUlEQVQoz31S62vacBTNP+0nQRBXpEVlWrbVt1EZ6xpQP/nED+pkTQaaxFhNFHUqRuNjPlqdTrPTxI5+2HYgl5tf7vnde88Jsd1uV6vVZrN5esHjKzw9nl9fn/85JMBUVXU4HPp8PpIkw+FwLBaLx+MURWWzWXwdjUbdbrfVavV6ve8akOBElmVisVjgc7vdttvtDofD6XS63W5c5PV6cQUaDgYDSZIqlco3DRzH1et1QRAURSF+aBBF0Ww2W61Wm80GcjQa9fv9iUTidDqhFaoZhgG/3++jeDqdzufz8XhMrNdrjD2bzVKpVKlU+vKCYrHIsizIu91urQFTIP+p4XA4QCYCz/F4RJH6N6BI5+z3e0iLXI9gQY5zZ0ySz+fRrVAoICLP5XLlcnm5XEKeugYkGBv7I+KuyWRyJnc6HYPBYDQaTSaTy+WCWh6PR98Z60FYbDjTAJ1wAp+QP6sNnyAYOJAaEbSgBpAxHqrRBGRFAxJZA4Y9q41hLBYLrNLbRiIRaA6rsR7P81COoRmappEjwrBarYbhnztDD/gBV7Enfox0Op3JZJLJJMTHUrgXpTAWDjcaDd3kZrMJCQjo+S+p/w94RKjqieU4luNHsqxMlcGgf0/TTUnieA4Jy1Yr1SrL8+gpPDxIksijr1D7ek8vV2vidPzlC/jfXr+rstxoPC6XS9arS28wdHt395miAsHAxeXVx9tPH9w31+9vQmQoFAkHSdL85kJstX8Dh0zBcapJPv4AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 28 16 51 45" title="" data-src="/static/2021-09-28-16-51-45-b8ae0277937b67e769cfe900630e81a9-5032e.png" data-srcset="/static/2021-09-28-16-51-45-b8ae0277937b67e769cfe900630e81a9-86481.png 200w,\n/static/2021-09-28-16-51-45-b8ae0277937b67e769cfe900630e81a9-1ca59.png 400w,\n/static/2021-09-28-16-51-45-b8ae0277937b67e769cfe900630e81a9-5032e.png 438w" data-sizes="(max-width: 438px) 100vw, 438px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="块级作用域的变量声明与一般-var-声明"><a href="#%E5%9D%97%E7%BA%A7%E4%BD%9C%E7%94%A8%E5%9F%9F%E7%9A%84%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E4%B8%8E%E4%B8%80%E8%88%AC-var-%E5%A3%B0%E6%98%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>块级作用域的变量声明与一般 var 声明</h3>\n<p>除了以下三点不同，let 的语法以及使用场景都与 var 一致：</p>\n<ul>\n<li>var 声明的变量，其作用域为当前函数、模块或全局；let 声明的变量，其作用域总是在当前的代码块，例如语句块</li>\n<li>在同一个代码块中，可以用 var 来多次声明变量名，这在语法分析中与声明一次没有区别；而用 let 却只能声明一次，覆盖一个已经声明的 let 变量（或者用 let 去覆盖一个已声明过的标识符）会导致语法错误</li>\n<li>用户代码可以在声明语句之前使用所声明的 var 变量，这时该变量的值是 undefined；而 let 声明的变量必须先声明后使用，声明语句之前的代码引用了 let 变量会触发异常，这也会导致 typeof 成为一个不安全的运算</li>\n</ul>\n<p>当 let 声明发生在全局代码块时，它与 var 声明存在细微的差别。这是因为按照早期 JavaScript 的约定，在全局代码块使用 var 声明（和具名函数声明语法）时，相当于在全局对象 global 上声明了一个属性，进而使所有代码都能将这些声明作为全局变量来访问。</p>\n<p>而 let 声明与其他一些较新的语法元素遵从“块级作用域”规则，因此即使出现在全局代码块中，它们也只是声明为“全局作用域”中的标识符，而不作为对象 global 上的属性，例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91500945097874330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var x = 100;\nlet y = 200;\nconsole.log(Object.getOwnPropertyDescriptor(global, \'x\').value); // 100\nconsole.log(Object.getOwnPropertyDescriptor(global, \'y\')); // undefined`, `91500945097874330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>global<span class="token punctuation">,</span> <span class="token string">\'x\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 100</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>global<span class="token punctuation">,</span> <span class="token string">\'y\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>常量声明 const、类声明 class 在块级作用域上的特性与 let 声明是类似的。</p>\n<h3 id="用赋值模板声明一批变量"><a href="#%E7%94%A8%E8%B5%8B%E5%80%BC%E6%A8%A1%E6%9D%BF%E5%A3%B0%E6%98%8E%E4%B8%80%E6%89%B9%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>用赋值模板声明一批变量</h3>\n<p>JavaScript 声明一批变量的传统方法是用 var 关键字，即在一个 var 中声明多个变量名。而 ES6 开始支持更为灵活的解构赋值语法，这个表达式的左侧操作数称为“赋值模板（AssignmentPattern）”：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39573855565836060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`AssignmentPattern = expression`, `39573855565836060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">AssignmentPattern = expression</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>当这个模板使用在 var 等变量声明中时，也可以成批地声明变量。例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40712462401899850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 使用数组解构赋值，声明变量 x, y\nvar [x, y] = [1, 2];\n// 使用对象解构赋值，声明变量 height, width\nlet { clientHeight: height, clientWidth: width } = window.document.body;`, `40712462401899850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 使用数组解构赋值，声明变量 x, y</span>\n<span class="token keyword">var</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token comment">// 使用对象解构赋值，声明变量 height, width</span>\n<span class="token keyword">let</span> <span class="token punctuation">{</span> clientHeight<span class="token punctuation">:</span> height<span class="token punctuation">,</span> clientWidth<span class="token punctuation">:</span> width <span class="token punctuation">}</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>document<span class="token punctuation">.</span>body<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在赋值模板中可以使用剩余参数语法来声明数组或对象。例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85557271105582730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 在变量声明的赋值模板中使用剩余参数，可以声明数组变量 more\nvar [x, y, ...more] = [1, 2, 3, 4, 5];\n\n// 在对象解构赋值中使用剩余参数，可以声明对象变量 moreProps\nlet [x, y, ...moreProps] = { x: 100, y: 200, z: 300 };`, `85557271105582730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 在变量声明的赋值模板中使用剩余参数，可以声明数组变量 more</span>\n<span class="token keyword">var</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">...</span>more<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 在对象解构赋值中使用剩余参数，可以声明对象变量 moreProps</span>\n<span class="token keyword">let</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">...</span>moreProps<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token number">300</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="使用字面量风格的值"><a href="#%E4%BD%BF%E7%94%A8%E5%AD%97%E9%9D%A2%E9%87%8F%E9%A3%8E%E6%A0%BC%E7%9A%84%E5%80%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用字面量风格的值</h2>\n<p>除了定义一个可用的标识符，变量声明通常还具有两方面的功能，一是声明类型，二是声明初值。但 JavaScript 中没有类型声明的概念，因此这时变量声明就只用来说明一个变量的初值。在声明中，等号右边既可以是表达式，这意味着将表达式运算的结果作为该变量的初值，也可以是更为强大和灵活的字面量声明。例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3340155964621294000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var num = 3 + 2 - 5; // 3 + 2 - 5 是一个表达式\nvar str = \'test\'; // \'test\' 是字面量`, `3340155964621294000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> num <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// 3 + 2 - 5 是一个表达式</span>\n<span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">\'test\'</span><span class="token punctuation">;</span> <span class="token comment">// \'test\' 是字面量</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>字面量类似汇编语言中的立即值—无须声明就可以立即使用的常值。从它的语法形式来说，也被称为或翻译为直接量。表 2-5 简要说明了 JavaScript 中能用字面量风格来声明的数据类型和对象</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-30-16-44-32-9f06c85e7feb4cce5b97a6172bd8fd54-d152b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 71.2085308056872%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAABr0lEQVQoz02S62rCQBCF9/1fqIiSNhpBaCIoilTNBdtq1CRGTc3FRPq5U4vnxzI7c87Z2dlVQRDYw2G43S5ddzKdfsznk+nk3Xa6ltXt9dqdTscwXk3z9a3bsyziVrvN+tJqfX59q6Zpao2qqq4aZVmylfg/eb3WMKsnwFHj8di27cVi0e/3DcMYjUae5y01fN9na5qm4ziDwWA2m5HxHgh8X201drsd62azWa/XaZpmWXY+ny+XC8n9fk9mtVolSXI6nQ6HQ6oRx7GCl+d5URSwaZh+brdbo0Hwo0EeX2RYuK4rdmwVBlEUocRYziwewIgqTVFFBo2VzjmfC5NUiQZ7lPAI0JQaBNhzDklMydAjd2ElJqkiDSIsMHs+GQYnU0IQhiFGuOMlpbsYNu/AxRAfj0eC/AEYcj3EKCllGmINWcmc0Evzcs6zmPmTlLFJiRgxq2LDVBHjJFeSruTOOKKXmVOlCxktKzRFlleRxqjJ5IWKXp6UqgxSOpJXvE9b+pQ7o5cOpTEY3JAYgjwYXTDC+1+t67+25dPKYGETyPcCBPBK3X8Sx3w4xo4FfEq/QGwOSbwxiCgAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 30 16 44 32" title="" data-src="/static/2021-09-30-16-44-32-9f06c85e7feb4cce5b97a6172bd8fd54-fee1c.png" data-srcset="/static/2021-09-30-16-44-32-9f06c85e7feb4cce5b97a6172bd8fd54-a67b7.png 200w,\n/static/2021-09-30-16-44-32-9f06c85e7feb4cce5b97a6172bd8fd54-0b187.png 400w,\n/static/2021-09-30-16-44-32-9f06c85e7feb4cce5b97a6172bd8fd54-fee1c.png 800w,\n/static/2021-09-30-16-44-32-9f06c85e7feb4cce5b97a6172bd8fd54-d152b.png 844w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<ol>\n<li>undefined 并没有被称为字面量，这可能是有着其历史原因的：在早期的 JavaScript 中，undefined 既不是关键字，也不能直接声明。</li>\n</ol>\n<h3 id="字符串字面量、转义符"><a href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AD%97%E9%9D%A2%E9%87%8F%E3%80%81%E8%BD%AC%E4%B9%89%E7%AC%A6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>字符串字面量、转义符</h3>\n<p>你总是可以用一对双引号或一对单引号来表示字符串字面量。早期 Netscape 的 JavaScript 中允许出现非 Unicode 的字符，但现在 ECMAScript 标准统一要求字符串必须是 Unicode 字符序列。</p>\n<p>转义符主要用于在字符串中包含控制字符，以及当前操作系统语言和字符集中不能直接输入的字符；也可以用于在字符串中嵌套引号（可以在单引号声明的字符串中直接使用双引号，或反过来在双引号中使用单引号）。转义符总是用一个反斜线字符“\\”引导，包括表 2-6 中所示的转义序列。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-09-30-16-46-28-8d9e3b9fe5e931ea89a97b51008bb74f-31afd.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 39.35790725326992%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABKElEQVQY02WPWW/CMBCE/f//UHmqaMshkfCSEJxQrlyIhEOhJOQgDf1qiydGljW7O+Mdi8fj0XUdt2Vblm1Hcex63ly6zlzOZvZgOHzv9wej0VuvZ5jmaDz++Pz6VXogOoW2bZv7nVPXdVmWdd1Aqqq602wa3awU4O0TwnGcyWTi+75hGPAoisIgmCpsNhvTnLquGwSB/wKaIo7jw+GQZZmcS8xJksCxHY/H0+mEc7Va5Xl+uVx+FLInzuezQFEq8Bjm7XZLtt1ud7vdiqKgZMN+v/cDnyach7SeqWBtrrBer/FrTxiG9K/XKxGWy6WrAPE8jxH7kTH9N6Om+FbQHIX+DpkXiwVOQsG5pZSMkLFPkJ4MGEjF5jRNKfkLY/1JRIWCDqVjassf9X2z+42hvSAAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 09 30 16 46 28" title="" data-src="/static/2021-09-30-16-46-28-8d9e3b9fe5e931ea89a97b51008bb74f-fee1c.png" data-srcset="/static/2021-09-30-16-46-28-8d9e3b9fe5e931ea89a97b51008bb74f-a67b7.png 200w,\n/static/2021-09-30-16-46-28-8d9e3b9fe5e931ea89a97b51008bb74f-0b187.png 400w,\n/static/2021-09-30-16-46-28-8d9e3b9fe5e931ea89a97b51008bb74f-fee1c.png 800w,\n/static/2021-09-30-16-46-28-8d9e3b9fe5e931ea89a97b51008bb74f-31afd.png 841w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<ol>\n<li>将被转换为 Unicode 字符存储</li>\n</ol>\n<p>除了定义转义符之外，当反斜线字符“\\”位于一行的末尾（其后立即是代码文本中的换行）时，也用于表示连续的字符串声明。这在声明大段文本块时很有用。例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76387230440953720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var aTextBlock =\n  \'\\\nabcde\\\n \\\n123456789\\\n \\\n+-*/\';`, `76387230440953720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> aTextBlock <span class="token operator">=</span>\n  <span class="token string">\'\\\nabcde\\\n \\\n123456789\\\n \\\n+-*/\'</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>该示例第 4 行与第 6 行中各包括了一个空格，因此输出时第 3、5、7 行将用一个空格分开。显示为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9001935455396537000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`abcde 123456789 +-*/`, `9001935455396537000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">abcde 123456789 +-*/</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>在各行中仍然可以使用其他转义符—只要它们出现在文本行最后的这个“\\”字符之前即可。不过与某些语言的语法不同的是，不能在这种表示法的文本行末使用注释。</p>\n<p>另外一个需要特别说明的是“\\0”，它表示 NUL 字符。在某些语言中，NUL 用于说明一种“以＃0 字符结束的字符串”（这也是 Windows 操作系统直接支持的一种字符串形式），在这种情况下，字符串是不能包括该 NUL 字符串的。但在 JavaScript 中，这是允许存在的。这时，NUL 字符是一个真实存在于字符序列中的字符。下例说明了 NUL 字符在 JavaScript 中的真实性：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43781419080823050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 示例\nstr1 = String.fromCharCode(0, 0, 0, 0, 0);\nstr2 = \'\\0\\0\\0\\0\\0\';\n\n// 显示字符串长&quot;5&quot;，表明 NUL 字符在字符串中是真实存在的\nconsole.log(str1.length);\nconsole.log(str2.length);`, `43781419080823050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 示例</span>\nstr1 <span class="token operator">=</span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nstr2 <span class="token operator">=</span> <span class="token string">\'\\0\\0\\0\\0\\0\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 显示字符串长"5"，表明 NUL 字符在字符串中是真实存在的</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str1<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str2<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 ES6 中增加了“\\u{nnnnn}”来表示码点大于 0xFFFF 的 Unicode 字符的语法，这意味着它支持直接声明和使用 UTF-16 字符。所以在这种情况下，在当前字符集使用 UTF-8 时，一个用“\\u{nnnnn}”表达的 Unicode 字符的长度将是 2。例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51989947889720934000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 如果当前字符集为 UTF-8，则将显示字符串长“2”\nconsole.log(\'\\u{20BB7}\'.length);`, `51989947889720934000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 如果当前字符集为 UTF-8，则将显示字符串长“2”</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'\\u{20BB7}\'</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>在 JavaScript 中也可以用一对不包含任意字符的单引号或双引号来表示一个空字符串（Null String），其长度值总是为 0。比较容易被忽视的是，空字符串与其他字符串一样也可以用作对象成员名。例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30813654830940516000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`obj = {\n  \'\': 100\n};\n\n// 显示该成员的值：100\nconsole.log(obj[\'\']);`, `30813654830940516000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">obj <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token string">\'\'</span><span class="token punctuation">:</span> <span class="token number">100</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 显示该成员的值：100</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="模板字面量"><a href="#%E6%A8%A1%E6%9D%BF%E5%AD%97%E9%9D%A2%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模板字面量</h3>\n<p>从 ES6 开始出现的模板字面量（template literal）用一对反引号（`）来标识，可以将其理解为一种增强的字符串声明。在使用反引号声明的字符串中，可以使用 <code class="language-text">${...}</code> 这样的语法来捕获当前上下文中的变量、常量、字面量或对象成员属性：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44023023178872860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var message = \'Hello world\';\nconsole.log(\\`The message is: \\${message}\\`);`, `44023023178872860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> message <span class="token operator">=</span> <span class="token string">\'Hello world\'</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The message is: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>以及计算一个表达式并将结果转换为字符串值—这也意味着这样的字符串其实是动态的。例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96228924827227520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`console.log(\\`The null is \\${typeof null} type.\\`); // The null is object type.`, `96228924827227520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The null is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">typeof</span> <span class="token keyword">null</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> type.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// The null is object type.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>模板字面量本质上来说是一个字面量的引用—该字面量在 JavaScript 内部表达为一个对象（array-like object）或数组：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25308397343782187000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`foo = (tpl) => console.log(typeof tpl, tpl instanceof Array, (ref = tpl));\nfoo\\`xyz\\`; // object true [\'xyz\']`, `25308397343782187000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">tpl</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> tpl<span class="token punctuation">,</span> tpl <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ref <span class="token operator">=</span> tpl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nfoo<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">xyz</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span> <span class="token comment">// object true [\'xyz\']</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>用户代码也可以使用一个带 .raw 属性的类数组对象来替代它，这个 .raw 属性指向该“表达该模板字面量的内部数组”的一个原始的、未经转义的格式。例如，用在 String.raw() 中</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86603479878117460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`console.log(String.raw({ raw: [\'\', \',\\nworld\'] }, \'Hi\'));\n// Hi,\n// world`, `86603479878117460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token punctuation">{</span> raw<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">,</span> <span class="token string">\',\\nworld\'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'Hi\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// Hi,</span>\n<span class="token comment">// world</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>它等义于：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13973111142231632000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`foo = (tpl) => String.raw(tpl, \'Hi\');\nconsole.log(foo\\`\\${1},\\nworld\\`);`, `13973111142231632000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">tpl</span><span class="token punctuation">)</span> <span class="token operator">=></span> String<span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span>tpl<span class="token punctuation">,</span> <span class="token string">\'Hi\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,\\nworld</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>另外，模板也可以用于多行字符串的声明</p>\n<h3 id="数值字面量"><a href="#%E6%95%B0%E5%80%BC%E5%AD%97%E9%9D%A2%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数值字面量</h3>\n<p>数值字面量总是以一个数字字符，或一个点字符“.”，以及不多于一个的正值符号“+”或负值符号“-”开始。当以数字字符开始时，它有四条规则：</p>\n<ol>\n<li>如果以 0x 或 0X 开始，则表明是一个十六进制数值。</li>\n<li>如果以 0o 或 0O 开始，则表明是一个八进制数值。</li>\n<li>如果以 0b 或 0B 开始，则表明是一个二进制数值。</li>\n<li>在其他情况下，表明是一个十进制整数或浮点数。</li>\n</ol>\n<p>当以点字符“.”开始时，它总是表明一个十进制浮点数。正值符号“+”、负值符号“-”总是可以出现在上述两种表示法（以数字字符或以点字符）的前面。例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4718139794546472000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`1234 // 十进制整数\n0x1234 // 十六进制整数\n0o1234 // 八进制整数\n0b1101 // 二进制整数`, `4718139794546472000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">1234 // 十进制整数\n0x1234 // 十六进制整数\n0o1234 // 八进制整数\n0b1101 // 二进制整数</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当一个字面量被识别为十六进制数值时，该字面量由 0 ～ 9 和 A ～ F 字符构成；当被识别为八进制数值时，该字面量由 0 ～ 7 字符构成—类似地，如果在语法分析中发现其他字符，则出现语法分析错误。</p>\n<p>当一个字面量被识别为十进制整型数时，它内部的存放格式可能是浮点数，也可能是整型数，这取决于不同引擎的实现。因此不能指望 JavaScript 中的整型数会有较高的运算性能。但是你可以用位运算来替代算术运算，这时引擎总是以整型数的形式来运算的—即使操作数是一个浮点数。</p>\n<p>当一个字面量被识别为十进制数时，它可以由 0 ～ 9，以及（不多于一个的）点字符“.”或字符 e、E 组成。当包括点字符“.”、字符 e 或 E 时，该字面量总被识别为浮点数（注意，某些引擎会优化一些字面量的内部存储形式）。例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84823776282104800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`3.1415926\n12.345\n.1234\n.0e8\n1.02E30`, `84823776282104800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">3.1415926\n12.345\n.1234\n.0e8\n1.02E30</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当使用带字符 e、E 的指数法表示时，也可以使用正、负符号来表示正、负整数指数。例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13221098021668510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`1.555E+30\n1.555E-30`, `13221098021668510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">1.555E+30\n1.555E-30</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h2 id="其他声明"><a href="#%E5%85%B6%E4%BB%96%E5%A3%B0%E6%98%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其他声明</h2>\n<h3 id="常量声明"><a href="#%E5%B8%B8%E9%87%8F%E5%A3%B0%E6%98%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>常量声明</h3>\n<p>const 关键字用于常量声明。常量声明与变量声明都是用来将一个标识符（变量名/常量名）与其对应的数据存储绑定起来，这在本质上并没有不同。但是从语义上来讲，变量表明相应的数据是可修改的，而常量表明它不可修改。除了这一点语义上的不同之外，所有与变量声明相关的特性（例如，数据的类型、字面量声明、字符串转义等）也都体现在常量声明上。例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61390181913986154000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 使用字面量的常量声明\nconst stringValue = \'abcd\\nefg\';\n\n// 正则表达式常量\nconst regexpInstace = /./;`, `61390181913986154000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 使用字面量的常量声明</span>\n<span class="token keyword">const</span> stringValue <span class="token operator">=</span> <span class="token string">\'abcd\\nefg\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 正则表达式常量</span>\n<span class="token keyword">const</span> regexpInstace <span class="token operator">=</span> <span class="token regex">/./</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>const 与 let 对作用域的理解类似，也是块级作用域的，因此也同样有别于 var 声明：既不能覆盖一个已经声明的常量，也不可能在它的声明语句之前访问它：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="236481886537376350"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const i = 100;\nconst i = 100; // Uncaught SyntaxError: Identifier \'i\' has already been declared`, `236481886537376350`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> i <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> i <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span> <span class="token comment">// Uncaught SyntaxError: Identifier \'i\' has already been declared</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>而对常量进行重新赋值的操作通常会无效或触发异常：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33575368674874982000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 续上例\ni = 300; // 尝试修改常量的值\n\nconsole.log(i); // 100，显示上述修改无效`, `33575368674874982000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 续上例</span>\ni <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">;</span> <span class="token comment">// 尝试修改常量的值</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 100，显示上述修改无效</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="符号声明"><a href="#%E7%AC%A6%E5%8F%B7%E5%A3%B0%E6%98%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>符号声明</h3>\n<p>符号是从 ES6 开始支持的一种数据类型，它可以使用一般形式的变量声明或常量声明（const/var/let），与其他数据类型在声明上并没有特别的不同：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39765763983539995000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var aSymbol = Symbol();\nconst aSymbolConst = Symbol();`, `39765763983539995000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> aSymbol <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> aSymbolConst <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>符号没有字面量声明形式。由于符号是值而非对象（我称之为“近似对象的”一种值类型数据），所以也不能使用 new 运算符来创建它。</p>\n<h3 id="函数声明"><a href="#%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>函数声明</h3>\n<p>在 JavaScript 中，函数是一种数据类型，所以函数声明是变量声明的一种特殊形式：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10126388355971127000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function functionName() {\n  // ...\n}`, `10126388355971127000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">functionName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>当 functionName 是一个有效标识符时，表示声明的是一个具名函数。functionName 后使用一对不能省略的“()”来表示形式参数列表。所谓形式参数，是指可以在函数体内部使用的、有效的标识符名。可以声明零至多个形式参数，即使在函数体内部并不使用它们。或者也可以不声明形式参数，这时也可以在函数体内使用一个名为 arguments 的内部对象来存取函数调用时的传入值。在函数体中，可以有零至任意多行代码、内嵌函数。在函数体内出现的使用 var 进行的显式变量声明，或者隐式的变量声明，都将被视为函数体内部的局部变量；该函数的内嵌函数的名字，也将作为局部变量。</p>\n<p>不同于早期的 JScript，在 ES5 以后的规范中，明确规定了在表达式中出现的具名函数名只影响该函数内的代码，而不会影响该表达式所在的作用域，示例如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64006208654566740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 在 if 语句的条件表达式中使用具名函数 foo\nif (function foo() {});\n\n// 在早期的 JScript 中，会显示有效的类型名 function\n// 这是因为上述 foo 函数会声明在全局，这是不规范的实现\nconsole.log(typeof foo);`, `64006208654566740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 在 if 语句的条件表达式中使用具名函数 foo</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 在早期的 JScript 中，会显示有效的类型名 function</span>\n<span class="token comment">// 这是因为上述 foo 函数会声明在全局，这是不规范的实现</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> foo<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在声明函数的形式参数时，可以为参数指定默认值“（default parameters）”：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57931255496732190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function foo(x, y = 100) {\n  console.log([x, y]);\n}\n\n// 示例\nfoo(\'abc\'); // abc,100`, `57931255496732190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">100</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 示例</span>\n<span class="token function">foo</span><span class="token punctuation">(</span><span class="token string">\'abc\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// abc,100</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果默认值并没有放在参数列表的尾部，那么可以使用 undefined，在传参时表明该参数使用默认值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77095439109499400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function foo(x = \'abc\', y) {\n  console.log([x, y]);\n}\n\n// 示例\nfoo(undefined, \'abc\'); // abc,abc`, `77095439109499400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span>x <span class="token operator">=</span> <span class="token string">\'abc\'</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 示例</span>\n<span class="token function">foo</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token string">\'abc\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// abc,abc</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以在参数列表尾部使用“剩余参数（rest parameter）”，它用一个带 <code class="language-text">...</code> 前缀的参数名（形参）来捕获所有未被声明的实参。在这种情况下，该形参总是一个包含所有剩余参数的数组，例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97631389329714070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function foo(x, y, ...z) {\n  console.log(z);\n}\n\n// 示例\nfoo(\'a\', \'b\', \'c\', \'d\'); // [\'c\', \'d\']`, `97631389329714070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">...</span>z</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 示例</span>\n<span class="token function">foo</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [\'c\', \'d\']</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>也可以在剩余参数中使用赋值模板。例如，下面用一个数组赋值模板替代了上例中的形参 z：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79677001973188210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function foo(x, y, ...[m, n]) {\n  console.log(m);\n}\n\n// 示例\nfoo(\'a\', \'b\', \'c\', \'d\'); // \'c\'`, `79677001973188210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">[</span>m<span class="token punctuation">,</span> n<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 示例</span>\n<span class="token function">foo</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \'c\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>并且反过来，也可以在赋值模板中使用剩余参数语法。例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46922918238580040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var [x, y, ...more] = [1, 2, 3, 4, 5];\n\n// 示例\nconsole.log(more); // [3, 4, 5]`, `46922918238580040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">...</span>more<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 示例</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>more<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [3, 4, 5]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 class 关键字来声明的类，也是一个函数。因此可以将类声明理解为函数声明的一种特殊语法。但是类声明得到的函数只能使用 new 运算来创建对象实例，而不能直接作为函数调用。而如果在语法关键字 function 之后加 * 字符，则会声明一个特殊的函数：生成器。</p>\n<p>// TODO js 精髓待完成</p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/JavaScript语言精髓与编程实践——语法/index.md absPath of file >>> MarkdownRemark",timeToRead:12,frontmatter:{date:"2021-09-26 17:45:33",path:"/javascript-essence-practice-grammar/",tags:"前端, JS, 读书笔记",title:"JavaScript语言精髓与编程实践——语法",draft:null}},{excerpt:"随着 Javascript 语言的发展，ES6 规范为我们带来了许多新的内容，其中生成器 Generators 是一项重要的特性。利用这一特性，我们可以简化迭代器的创建，更加令人兴奋的，是 Generators 允许我们在函数执行过程中暂停、并在将来某一时刻恢复执行。这一特性改变了以往函数必须执行完成才返回的特点，将这一特性应用到异步代码编写中，可以有效的简化异步方法的写法，同时避免陷入回调地狱。 本文将对 Generators 进行简单介绍，然后结合笔者在 C…",html:'<p>随着 Javascript 语言的发展，ES6 规范为我们带来了许多新的内容，其中生成器 Generators 是一项重要的特性。利用这一特性，我们可以简化迭代器的创建，更加令人兴奋的，是 Generators 允许我们在函数执行过程中暂停、并在将来某一时刻恢复执行。这一特性改变了以往函数必须执行完成才返回的特点，将这一特性应用到异步代码编写中，可以有效的简化异步方法的写法，同时避免陷入回调地狱。</p>\n<p>本文将对 Generators 进行简单介绍，然后结合笔者在 C# 上的一点经验，重点探讨 Generators 运行机制及在 ES5 的实现原理。</p>\n<h1 id="介绍"><a href="#%E4%BB%8B%E7%BB%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>介绍</h1>\n<p>一个简单的 Generator 函数示例</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24372729006734463000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function* example() {\n  yield 1;\n  yield 2;\n  yield 3;\n}\nvar iter = example();\niter.next(); // {value:1，done:false}\niter.next(); // {value:2，done:false}\niter.next(); // {value:3，done:false}\niter.next(); // {value:undefined，done:true}`, `24372729006734463000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">yield</span> <span class="token number">1</span><span class="token punctuation">;</span>\n  <span class="token keyword">yield</span> <span class="token number">2</span><span class="token punctuation">;</span>\n  <span class="token keyword">yield</span> <span class="token number">3</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">var</span> iter <span class="token operator">=</span> <span class="token function">example</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\niter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// {value:1，done:false}</span>\niter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// {value:2，done:false}</span>\niter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// {value:3，done:false}</span>\niter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// {value:undefined，done:true}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上述代码中定义了一个生成器函数，当调用生成器函数 example() 时，并非立即执行该函数，而是返回一个生成器对象。每当调用生成器对象的 .next() 方法时，函数将运行到下一个 yield 表达式，返回表达式结果并暂停自身。当抵达生成器函数的末尾时，返回结果中 done 的值为 true，value 的值为 undefined。我们将上述 example() 函数称之为生成器函数，与普通函数相比二者有如下区别</p>\n<ul>\n<li>普通函数使用 function 声明，生成器函数用 function* 声明</li>\n<li>普通函数使用 return 返回值，生成器函数使用 yield 返回值</li>\n<li>普通函数是 run to completion 模式，即普通函数开始执行后，会一直执行到该函数所有语句完成，在此期间别的代码语句是不会被执行的；生成器函数是 run-pause-run 模式，即生成器函数可以在函数运行中被暂停一次或多次，并且在后面再恢复执行，在暂停期间允许其他代码语句被执行</li>\n</ul>\n<h1 id="generators-in-c"><a href="#generators-in-c" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Generators in C</h1>\n<p>生成器不是一个新的概念，我最初接触这一概念是在学习使用 C# 时。C# 从 2.0 版本便引入了 yield 关键字，使得我们可以更简单的创建枚举数和可枚举类型。不同的是 C# 中未将其命名为生成器 Generators，而将其称之为迭代器。</p>\n<p>本文不会介绍 C# 中可枚举类 IEnumerable 和枚举数 IEnumerator 内容，如需了解推荐阅读《C#4.0 图解教程》相关章节。</p>\n<h2 id="c-迭代器介绍"><a href="#c-%E8%BF%AD%E4%BB%A3%E5%99%A8%E4%BB%8B%E7%BB%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>C# 迭代器介绍</h2>\n<p>让我们先看一个示例，下面方法声明实现了一个产生和返回枚举数的迭代器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9053423975175678000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`public IEnumerable <int> Example() {\n  yield return 1;\n  yield return 2;\n  yield return 3;\n}`, `9053423975175678000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="cs"\n              >\n                <span class="gatsby-code-button-language">cs</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="cs"><pre style="counter-reset: linenumber NaN" class="language-cs line-numbers"><code class="language-cs"><span class="token keyword">public</span> IEnumerable <span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">Example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>\n  <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>\n  <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token number">3</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>方法定义与 ES6 Generators 定义很接近，定义中声明返回了一个 int 类型的泛型可枚举类型，方法体内通过 yield return 语句返回值并将自身暂停执行。</p>\n<p>使用迭代器来创建可枚举类型的类</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98836265384985510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class YieldClass {\n  public IEnumerable<int> Example() { // 迭代器\n    yield return 1;\n    yield return 2;\n    yield return 3;\n  }\n}\n\nclass Program {\n  static void Main() {\n    YieldClass yc = new YieldClass();\n    foreach(var a in yc.Example())\n      Console.WriteLine(a);\n  }\n}`, `98836265384985510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="cs"\n              >\n                <span class="gatsby-code-button-language">cs</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="cs"><pre style="counter-reset: linenumber NaN" class="language-cs line-numbers"><code class="language-cs"><span class="token keyword">class</span> <span class="token class-name">YieldClass</span> <span class="token punctuation">{</span>\n  <span class="token keyword">public</span> IEnumerable<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">Example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 迭代器</span>\n    <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>\n    <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token number">3</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Program</span> <span class="token punctuation">{</span>\n  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token class-name">YieldClass</span> yc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">YieldClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token keyword">var</span> a <span class="token keyword">in</span> yc<span class="token punctuation">.</span><span class="token function">Example</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上述代码会产生如下输入</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50048487992227160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`1\n2\n3`, `50048487992227160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">1\n2\n3</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h2 id="c-迭代器原理"><a href="#c-%E8%BF%AD%E4%BB%A3%E5%99%A8%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>C# 迭代器原理</h2>\n<p>在 .Net 中，yield 并不是 .Net runtime 的特性，而是一个语法糖，代码编译时，这一语法糖会被 C# 编译器编译成简单的 IL 代码。</p>\n<p>继续研究上述示例，通过 Reflector 反编译工具可以看到，编译器为我们生成了一个带有如下声明的内部类</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33943202326950670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[CompilerGenerated]\nprivate sealed class YieldEnumerator :\n   IEnumerable<object>, IEnumerator<object>\n{\n    // Fields字段\n    private int state;\n    private int current;\n    public YieldClass owner;\n    private int initialThreadId;\n\n    // Methods方法\n    [DebuggerHidden]\n    public YieldEnumerator(int state);\n    private bool MoveNext();\n    [DebuggerHidden]\n    IEnumerator<int> IEnumerable<int>.GetEnumerator();\n    [DebuggerHidden]\n    IEnumerator IEnumerable.GetEnumerator();\n    [DebuggerHidden]\n    void IEnumerator.Reset();\n    void IDisposable.Dispose();\n\n    // Properties属性\n    object IEnumerator<object>.Current\n    { [DebuggerHidden] get; }\n\n    object IEnumerator.Current\n    { [DebuggerHidden] get; }\n}`, `33943202326950670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="cs"\n              >\n                <span class="gatsby-code-button-language">cs</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="cs"><pre style="counter-reset: linenumber NaN" class="language-cs line-numbers"><code class="language-cs"><span class="token punctuation">[</span><span class="token class-name">CompilerGenerated</span><span class="token punctuation">]</span>\n<span class="token keyword">private</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">YieldEnumerator</span> <span class="token punctuation">:</span>\n   <span class="token class-name">IEnumerable</span><span class="token operator">&lt;</span><span class="token keyword">object</span><span class="token operator">></span><span class="token punctuation">,</span> IEnumerator<span class="token operator">&lt;</span><span class="token keyword">object</span><span class="token operator">></span>\n<span class="token punctuation">{</span>\n    <span class="token comment">// Fields字段</span>\n    <span class="token keyword">private</span> <span class="token keyword">int</span> state<span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token keyword">int</span> current<span class="token punctuation">;</span>\n    <span class="token keyword">public</span> <span class="token class-name">YieldClass</span> owner<span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token keyword">int</span> initialThreadId<span class="token punctuation">;</span>\n\n    <span class="token comment">// Methods方法</span>\n    <span class="token punctuation">[</span><span class="token class-name">DebuggerHidden</span><span class="token punctuation">]</span>\n    <span class="token keyword">public</span> <span class="token function">YieldEnumerator</span><span class="token punctuation">(</span><span class="token keyword">int</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token keyword">bool</span> <span class="token function">MoveNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">[</span><span class="token class-name">DebuggerHidden</span><span class="token punctuation">]</span>\n    IEnumerator<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> IEnumerable<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token punctuation">.</span><span class="token function">GetEnumerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">[</span><span class="token class-name">DebuggerHidden</span><span class="token punctuation">]</span>\n    <span class="token class-name">IEnumerator</span> IEnumerable<span class="token punctuation">.</span><span class="token function">GetEnumerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">[</span><span class="token class-name">DebuggerHidden</span><span class="token punctuation">]</span>\n    <span class="token keyword">void</span> IEnumerator<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">void</span> IDisposable<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// Properties属性</span>\n    <span class="token keyword">object</span> IEnumerator<span class="token operator">&lt;</span><span class="token keyword">object</span><span class="token operator">></span><span class="token punctuation">.</span>Current\n    <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token class-name">DebuggerHidden</span><span class="token punctuation">]</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>\n\n    <span class="token keyword">object</span> IEnumerator<span class="token punctuation">.</span>Current\n    <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token class-name">DebuggerHidden</span><span class="token punctuation">]</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>原始的 Example() 方法仅返回一个 YieldEnumerator 的实例，并将初始状态 -2 传递给它自身和其引用者，每一个迭代器保存一个状态指示</p>\n<ul>\n<li>-2：初始化为可迭代类 Enumerable</li>\n<li>-1: 迭代结束</li>\n<li>0: 初始化为迭代器 Enumerator</li>\n<li>1-n: 原始 Example() 方法中的 yield return 索引值</li>\n</ul>\n<p>Example() 方法中代码被转换为 YieldingEnumerator.MoveNext()，在我们的示例中转换后代码如下</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27137868809450880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`bool MoveNext() {\n  switch (state) {\n    case 0:\n      state = -1;\n      current = 1;\n      state = 1;\n      return true;\n    case 1:\n      state = -1;\n      current = 2;\n      state = 2;\n      return true;\n    case 2:\n      state = -1;\n      current = 3;\n      state = 3;\n      return true;\n    case 3:\n      state = -1;\n      break;\n  }\n  return false;\n}`, `27137868809450880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="cs"\n              >\n                <span class="gatsby-code-button-language">cs</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="cs"><pre style="counter-reset: linenumber NaN" class="language-cs line-numbers"><code class="language-cs"><span class="token keyword">bool</span> <span class="token function">MoveNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">case</span> <span class="token number">0</span><span class="token punctuation">:</span>\n      state <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>\n      current <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n      state <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>\n    <span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span>\n      state <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>\n      current <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>\n      state <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>\n    <span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span>\n      state <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>\n      current <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>\n      state <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>\n    <span class="token keyword">case</span> <span class="token number">3</span><span class="token punctuation">:</span>\n      state <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>\n      <span class="token keyword">break</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>利用上述的代码转换，编译器为我们生成了一个状态机，正是基于这一状态机模型，实现了 yield 关键字的特性。</p>\n<p>迭代器状态机模型可如下图所示</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-06-25-11-35-01-87a46401be28e7d54f3cf41b75301946-6de41.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 327px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 107.95107033639144%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAIAAABPIytRAAAACXBIWXMAAAsSAAALEgHS3X78AAABsklEQVQ4y42UzY6CQBCE5/0finjxaFBj5EQUf6IRQRFQEYT9lnINu250OnHStFPd1dUzY5qmSdM0juPD4RC3hnO73RoLMyBPp1M3VFVVFEX3+/0zWHXqup5MJsPhcL/fi0ue5zjE34Epm2UZ3uVywSnLEh/ycj5UJneSJNQvigKq4OFMIquexQ0Dtt1u5Td2ZrSVDheLhe/7m83GUupHZQzCkAd5vV5RW8H6t/0PBglgt9sheNna6z7AMGIKx+MRjcXOgEQtvsGQAtmo73kegs/n89lsxoqEBIFJVHYmrRl+5/OZNEVr4oxyBPnUCowCKs4nrZECmYxGyve4tel0ChiMpqVWAbNyfthAa67rrtdr8IYJ8V9XD3JTGXDaGhXYA/+uFiBBGc0JVuImSVips1wuqcAIYRcEARG1qp1k/xZMapMeVdQkvb1eDNhVPyamhtxUID3Eer1ev98fjUaO46xWK9HTkOX8nbOi9MOcUYKs6s3mkD4uBm3QOZrrYbC9GM8r+TyDrOjxPKTvwNRBITyaHAwGegNIZ/UYwBPa3crUZCpWz5AenTAMOcCw0Gp5K78AsFf/Ie7wPLUAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 06 25 11 35 01" title="" data-src="/static/2021-06-25-11-35-01-87a46401be28e7d54f3cf41b75301946-6de41.png" data-srcset="/static/2021-06-25-11-35-01-87a46401be28e7d54f3cf41b75301946-e9163.png 200w,\n/static/2021-06-25-11-35-01-87a46401be28e7d54f3cf41b75301946-6de41.png 327w" data-sizes="(max-width: 327px) 100vw, 327px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<ul>\n<li>Before 为迭代器初始状态</li>\n<li>Running 为调用 MoveNext 后进入这个状态。在这个状态，枚举数检测并设置下一项的位置。遇到 yield return、yield break 或者迭代结束时，退出该状态</li>\n<li>Suspended 为状态机等待下次调用 MoveNext 的状态</li>\n<li>After 为迭代结束的状态</li>\n</ul>\n<h1 id="generators-in-javascript"><a href="#generators-in-javascript" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Generators in Javascript</h1>\n<p>通过阅读上文，我们了解了 Generator 在 C# 中的使用，并且通过查看编译器生成的 IL 代码，得知编译器会生成一个内部类来保存上下文信息，然后将 yield return 表达式转换成 switch case，通过状态机模式实现 yield 关键字的特性。</p>\n<h2 id="javascript-generators-原理浅析"><a href="#javascript-generators-%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Javascript Generators 原理浅析</h2>\n<p>yield 关键字在 Javascript 中如何实现呢？</p>\n<p>首先，生成器不是线程。支持线程的语言中，多段不同的代码可以在同一时候运行，这经常会导致资源竞争，使用得当会有不错的性能提升。生成器则完全不同，Javascript 执行引擎仍然是一个基于事件循环的单线程环境，当生成器运行的时候，它会在叫做 caller 的同一个线程中运行。执行的顺序是有序、确定的，并且永远不会产生并发。不同于系统的线程，生成器只会在其内部用到 yield 的时候才会被挂起。</p>\n<p>既然生成器并非由引擎从底层提供额外的支持，我们可以沿用上文在 C# 中对 yield 特性的原理探究的经验，将生成器视为一个语法糖，用一个辅助工具将生成器函数转换为普通的 Javascript 代码，在经过转换的代码中，有两个关键点，一是要保存函数的上下文信息，二是实现一个完善的迭代方法，使得多个 yield 表达式按序执行，从而实现生成器的特性。</p>\n<h2 id="how-generators-work-in-es5"><a href="#how-generators-work-in-es5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How Generators work in ES5</h2>\n<p>Regenerator 工具已经实现了上述思路，借助 Regenerator 工具，我们已经可以在原生 ES5 中使用生成器函数，本节我们来分析 Regenerator 实现方式以深入理解 Generators 运行原理。</p>\n<p>通过这个<a href="http://babeljs.io/repl/" target="_blank" rel="nofollow noreferrer noopener">在线地址</a>可以方便的查看经过转换后的代码，仍然以文章初始为例</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58786528262474146000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function* example() {\n  yield 1;\n  yield 2;\n  yield 3;\n}\nvar iter = example();\niter.next();`, `58786528262474146000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">yield</span> <span class="token number">1</span><span class="token punctuation">;</span>\n  <span class="token keyword">yield</span> <span class="token number">2</span><span class="token punctuation">;</span>\n  <span class="token keyword">yield</span> <span class="token number">3</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">var</span> iter <span class="token operator">=</span> <span class="token function">example</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\niter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>经过转换后为</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78545635696875700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var marked0\\$0 = [example].map(regeneratorRuntime.mark);\nfunction example() {\n  return regeneratorRuntime.wrap(\n    function example\\$(context\\$1\\$0) {\n      while (1)\n        switch ((context\\$1\\$0.prev = context\\$1\\$0.next)) {\n          case 0:\n            context\\$1\\$0.next = 2;\n            return 1;\n\n          case 2:\n            context\\$1\\$0.next = 4;\n            return 2;\n\n          case 4:\n            context\\$1\\$0.next = 6;\n            return 3;\n\n          case 6:\n          case \'end\':\n            return context\\$1\\$0.stop();\n        }\n    },\n    marked0\\$0[0],\n    this\n  );\n}\nvar iter = example();\niter.next();`, `78545635696875700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> marked0$<span class="token number">0</span> <span class="token operator">=</span> <span class="token punctuation">[</span>example<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>regeneratorRuntime<span class="token punctuation">.</span>mark<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">function</span> <span class="token function">example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> regeneratorRuntime<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>\n    <span class="token keyword">function</span> <span class="token function">example$</span><span class="token punctuation">(</span><span class="token parameter">context$<span class="token number">1</span>$<span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n        <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>context$<span class="token number">1</span>$<span class="token number">0.</span>prev <span class="token operator">=</span> context$<span class="token number">1</span>$<span class="token number">0.</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">case</span> <span class="token number">0</span><span class="token punctuation">:</span>\n            context$<span class="token number">1</span>$<span class="token number">0.</span>next <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>\n            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>\n\n          <span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span>\n            context$<span class="token number">1</span>$<span class="token number">0.</span>next <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>\n            <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>\n\n          <span class="token keyword">case</span> <span class="token number">4</span><span class="token punctuation">:</span>\n            context$<span class="token number">1</span>$<span class="token number">0.</span>next <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>\n            <span class="token keyword">return</span> <span class="token number">3</span><span class="token punctuation">;</span>\n\n          <span class="token keyword">case</span> <span class="token number">6</span><span class="token punctuation">:</span>\n          <span class="token keyword">case</span> <span class="token string">\'end\'</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> context$<span class="token number">1</span>$<span class="token number">0.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    marked0$<span class="token number">0</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    <span class="token keyword">this</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">var</span> iter <span class="token operator">=</span> <span class="token function">example</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\niter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从转换后的代码中可以看到，与 C# 编译器对 yield return 表达式的转换相似，Regenerator 将生成器函数中的 yield 表达式重写为 switch case，同时，在每个 case 中使用 context<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.64444em;vertical-align:0em;"></span><span class="base"><span class="mord">1</span></span></span></span>0 来保存函数当前的上下文状态。</p>\n<p>switch case 之外，迭代器函数 example 被 regeneratorRuntime.mark 包装，返回一个被 regeneratorRuntime.wrap 包装的迭代器对象。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74142330220861670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`runtime.mark = function(genFun) {\n  if (Object.setPrototypeOf) {\n    Object.setPrototypeOf(genFun, GeneratorFunctionPrototype);\n  } else {\n    genFun.__proto__ = GeneratorFunctionPrototype;\n  }\n  genFun.prototype = Object.create(Gp);\n  return genFun;\n};`, `74142330220861670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">runtime<span class="token punctuation">.</span><span class="token function-variable function">mark</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">genFun</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span>setPrototypeOf<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    Object<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>genFun<span class="token punctuation">,</span> GeneratorFunctionPrototype<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    genFun<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> GeneratorFunctionPrototype<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  genFun<span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>Gp<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> genFun<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>通过 mark 包装，将 example 包装成如下对象</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-06-25-13-35-30-1d2be8abceeada9e26023e3a1603b22d-bee38.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 404px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 62.37623762376238%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABf0lEQVQoz4WSDW/jIAyG8///3um0tWqbJmEhYL7BTtKG5Ei7ne6mTbNAskAPvH7tap5npZVSoLU2xpSMc962DKS73+/buq3fR5XX7AaLPJZlwXaMDcMghIgxSSl3/vuoyl6XddQjCkwGY0pIVOTsx8tSnv8BLkF6TBIx0Ixjgf5ef9L5BTzPEykiQ7OyqWkd6277zz/HA54m7+LkbwkmpPl8vbasGKaMsRJUMUACcCGKpUvOxYW85FJRzrnaHlqSVrHux06NDYwdYD3o33U4vpm66Y9HebkMp5M4n3Xfl6aovTlFKhV4p9PA4bX3rachxIOm2kE3tM31Ns3P0p9/bN5v/1T+DpNSltnAETURR2Ipysh4P30qPsYv4NS/qRdmX8EcwJ2KbJNO2tVysil7ukNaNN4SZWf/h7ctr+tkLXaSGj0yE2vR/Tryw4W4IqFwAOoBe4hCTN6XEVg+Jqd6aAnFbQM+uJQ8md6iwmCD9tZ670JwMZSkLOMcACDiE/4DiZOxbvf8jeIAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 06 25 13 35 30" title="" data-src="/static/2021-06-25-13-35-30-1d2be8abceeada9e26023e3a1603b22d-bee38.png" data-srcset="/static/2021-06-25-13-35-30-1d2be8abceeada9e26023e3a1603b22d-3ac6c.png 200w,\n/static/2021-06-25-13-35-30-1d2be8abceeada9e26023e3a1603b22d-b7ce3.png 400w,\n/static/2021-06-25-13-35-30-1d2be8abceeada9e26023e3a1603b22d-bee38.png 404w" data-sizes="(max-width: 404px) 100vw, 404px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>当调用生成器函数 example() 时，返回一个被 wrap 函数包装后的迭代器对象</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98688125066304880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`runtime.wrap = function(innerFn, outerFn, self, tryLocsList) {\n  // If outerFn provided, then outerFn.prototype instanceof Generator.\n  var generator = Object.create((outerFn || Generator).prototype);\n  var context = new Context(tryLocsList || []);\n\n  // The ._invoke method unifies the implementations of the .next,\n  // .throw, and .return methods.\n  generator._invoke = makeInvokeMethod(innerFn, self, context);\n\n  return generator;\n};`, `98688125066304880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">runtime<span class="token punctuation">.</span><span class="token function-variable function">wrap</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">innerFn<span class="token punctuation">,</span> outerFn<span class="token punctuation">,</span> self<span class="token punctuation">,</span> tryLocsList</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// If outerFn provided, then outerFn.prototype instanceof Generator.</span>\n  <span class="token keyword">var</span> generator <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">(</span>outerFn <span class="token operator">||</span> Generator<span class="token punctuation">)</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span>tryLocsList <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// The ._invoke method unifies the implementations of the .next,</span>\n  <span class="token comment">// .throw, and .return methods.</span>\n  generator<span class="token punctuation">.</span>_invoke <span class="token operator">=</span> <span class="token function">makeInvokeMethod</span><span class="token punctuation">(</span>innerFn<span class="token punctuation">,</span> self<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> generator<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>返回的迭代器对象如下所示</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-06-25-13-36-06-2b2520ee679b8802d526ca76fb1320be-f72ce.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 419px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 44.391408114558466%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABH0lEQVQoz4WRiW7CMAyG+/6PODGghaVtDifN6RxtZxhIMGnar1+5v8R2uuS91VpLaTRopZTgzi5ba/u2/TYtvrvLORMynPuJSQmpRCyxtFwRMT6VS6Hpuq7bvr+6a62llGACx3yElFSQZ265CTGYp4h0zhG8v6srpVDnFhcgICB6vHxd+ssAXBllBBfjOM7zzBgTQtBhirTcRXc94FKLESYBJhVvlgEGZa5A/MxnwiTlBEAJ3usjaVBrfcKtzKcZjiYI5z60Pxhg6nA6UsD733rAtVUYtb06x31gLl29n+w0Tj+7/8AUNu+F/jR6WPRRL72xw2IuBn0uNqOMmWoZ00Yf9gpTAW4v1xpswAXRYPI4skkK2Upb27pSezdpe9c3WCsGpxyVjn8AAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 06 25 13 36 06" title="" data-src="/static/2021-06-25-13-36-06-2b2520ee679b8802d526ca76fb1320be-f72ce.png" data-srcset="/static/2021-06-25-13-36-06-2b2520ee679b8802d526ca76fb1320be-58799.png 200w,\n/static/2021-06-25-13-36-06-2b2520ee679b8802d526ca76fb1320be-69db4.png 400w,\n/static/2021-06-25-13-36-06-2b2520ee679b8802d526ca76fb1320be-f72ce.png 419w" data-sizes="(max-width: 419px) 100vw, 419px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>当调用迭代器对象 iter.next() 方法时，因为有如下代码，所以会执行 _invoke 方法，而根据前面 wrap 方法代码可知，最终是调用了迭代器对象的 makeInvokeMethod(innerFn, self, context); 方法</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85258405354550800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Helper for defining the .next, .throw, and .return methods of the\n// Iterator interface in terms of a single ._invoke method.\nfunction defineIteratorMethods(prototype) {\n  [\'next\', \'throw\', \'return\'].forEach(function(method) {\n    prototype[method] = function(arg) {\n      return this._invoke(method, arg);\n    };\n  });\n}`, `85258405354550800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// Helper for defining the .next, .throw, and .return methods of the</span>\n<span class="token comment">// Iterator interface in terms of a single ._invoke method.</span>\n<span class="token keyword">function</span> <span class="token function">defineIteratorMethods</span><span class="token punctuation">(</span><span class="token parameter">prototype</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token punctuation">[</span><span class="token string">\'next\'</span><span class="token punctuation">,</span> <span class="token string">\'throw\'</span><span class="token punctuation">,</span> <span class="token string">\'return\'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    prototype<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_invoke</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>makeInvokeMethod 方法内容较多，这里选取部分分析。首先，我们发现生成器将自身状态初始化为“Suspended Start”</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76947127822758170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function makeInvokeMethod(innerFn, self, context) {\n  var state = GenStateSuspendedStart;\n\n  return function invoke(method, arg) {`, `76947127822758170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">makeInvokeMethod</span><span class="token punctuation">(</span><span class="token parameter">innerFn<span class="token punctuation">,</span> self<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> state <span class="token operator">=</span> GenStateSuspendedStart<span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>makeInvokeMethod 返回 invoke 函数，当我们执行 .next 方法时，实际调用的是 invoke 方法中的下面语句</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95854162689429620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var record = tryCatch(innerFn, self, context);`, `95854162689429620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> record <span class="token operator">=</span> <span class="token function">tryCatch</span><span class="token punctuation">(</span>innerFn<span class="token punctuation">,</span> self<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这里 tryCatch 方法中 fn 为经过转换后的 example$ 方法，arg 为上下文对象 context, 因为 invoke 函数内部对 context 的引用形成闭包引用，所以 context 上下文得以在迭代期间一直保持。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75136727678615130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function tryCatch(fn, obj, arg) {\n  try {\n    return { type: \'normal\', arg: fn.call(obj, arg) };\n  } catch (err) {\n    return { type: \'throw\', arg: err };\n  }\n}`, `75136727678615130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">tryCatch</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">\'normal\'</span><span class="token punctuation">,</span> arg<span class="token punctuation">:</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> arg<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">\'throw\'</span><span class="token punctuation">,</span> arg<span class="token punctuation">:</span> err <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>tryCatch 方法会实际调用 example$ 方法，进入转换后的 switch case, 执行代码逻辑。如果得到的结果是一个普通类型的值，我们将它包装成一个可迭代对象格式，并且更新生成器状态至 GenStateCompleted 或者 GenStateSuspendedYield</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53453597310413770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var record = tryCatch(innerFn, self, context);\nif (record.type === &quot;normal&quot;) {\n  // If an exception is thrown from innerFn, we leave state ===\n  // GenStateExecuting and loop back for another invocation.\n  state = context.done\n    ? GenStateCompleted\n    : GenStateSuspendedYield;\n\n  var info = {\n    value: record.arg,\n    done: context.done\n  };`, `53453597310413770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> record <span class="token operator">=</span> <span class="token function">tryCatch</span><span class="token punctuation">(</span>innerFn<span class="token punctuation">,</span> self<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>record<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"normal"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// If an exception is thrown from innerFn, we leave state ===</span>\n  <span class="token comment">// GenStateExecuting and loop back for another invocation.</span>\n  state <span class="token operator">=</span> context<span class="token punctuation">.</span>done\n    <span class="token operator">?</span> GenStateCompleted\n    <span class="token punctuation">:</span> GenStateSuspendedYield<span class="token punctuation">;</span>\n\n  <span class="token keyword">var</span> info <span class="token operator">=</span> <span class="token punctuation">{</span>\n    value<span class="token punctuation">:</span> record<span class="token punctuation">.</span>arg<span class="token punctuation">,</span>\n    done<span class="token punctuation">:</span> context<span class="token punctuation">.</span>done\n  <span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="总结"><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h1>\n<p>通过对 Regenerator 转换后的生成器代码及工具源码分析，我们探究了生成器的运行原理。Regenerator 通过工具函数将生成器函数包装，为其添加如 next/return 等方法。同时也对返回的生成器对象进行包装，使得对 next 等方法的调用，最终进入由 switch case 组成的状态机模型中。除此之外，利用闭包技巧，保存生成器函数上下文信息。</p>\n<p>上述过程与 C# 中 yield 关键字的实现原理基本一致，都采用了编译转换思路，运用状态机模型，同时保存函数上下文信息，最终实现了新的 yield 关键字带来的新的语言特性。</p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/深入理解 Generators/index.md absPath of file >>> MarkdownRemark",timeToRead:5,frontmatter:{date:"2021-06-25 11:14:53",path:"/deep-learn-generators/",tags:"前端, JS, 高级前端",title:"深入理解 Generators",draft:null}},{excerpt:"前言 前端中的库很多，开发这些库的作者会尽可能的覆盖到大家在业务中千奇百怪的需求，但是总有无法预料到的，所以优秀的库就需要提供一种机制，让开发者可以干预插件中间的一些环节，从而完成自己的一些需求。 本文将从 koa、axios、vuex 和 redux 的实现来教你怎么编写属于自己的插件机制。 axios 首先我们模拟一个简单的 axios，这里不涉及请求的逻辑，只是简单的返回一个 Promise，可以通过 config 中的 error 参数控制 Promise 的状态。 axios…",html:'<h1 id="前言"><a href="#%E5%89%8D%E8%A8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>前言</h1>\n<p>前端中的库很多，开发这些库的作者会尽可能的覆盖到大家在业务中千奇百怪的需求，但是总有无法预料到的，所以优秀的库就需要提供一种机制，让开发者可以干预插件中间的一些环节，从而完成自己的一些需求。</p>\n<p>本文将从 koa、axios、vuex 和 redux 的实现来教你怎么编写属于自己的插件机制。</p>\n<h1 id="axios"><a href="#axios" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>axios</h1>\n<p>首先我们模拟一个简单的 axios，这里不涉及请求的逻辑，只是简单的返回一个 Promise，可以通过 config 中的 error 参数控制 Promise 的状态。</p>\n<p>axios 的拦截器机制用流程图来表示其实就是这样的：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-01-13-11-28-36-eac4747ff157af76315b814b7b3e55bc-ad8d8.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 121.06430155210643%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAIAAAB1KUohAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABhUlEQVQ4y6WU3W6CQBCFff8nU7zAYBAURNCCIvG/ggjSftlNaEtIYO1ckHXwMOecmdnB1z9i0Ph9v98vl8v5fL5er58ibrcbT/LdYDCbzcY0TV3XHcfhPJ/P1+s1+W5wlmVpmj4eD0odDoc4jo/HI2cy3WCiqqqiKDiA3G63u92ur2YCkZCczWaj0ciyLCyATl9wnufwTJIEwUEQnE6nsiz7gqEtFYL/EKFAWzbGdV1N0xaLBRJa3WoHoxAABT3Po0lofj6ffcGSOU/UxiLqTDcYzvSW2ZhMJsvlkm5hoQJtxtMT4fv+fr9/hzY1UR6GYSvndjDjiWGr1QraeI4EBdqAGTJgtm3zCSxQAL9eLzmP0AbMkJFRMIw5YR8Mw2AraZWCYfI+YDGm0ynMkaBAu3abmkxYFEXdbiOMTQBAY3GY4swJrWK3yKCCV42v/IC5AFwROMR4DIfD8XhMt9gNRgX+7HbDuT9gfCpEMGH8FRjF0SyTtFDeMO2aWXpelyJ+y6nzDc3f1xly1OCagtgAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 01 13 11 28 36" title="" data-src="/static/2021-01-13-11-28-36-eac4747ff157af76315b814b7b3e55bc-fee1c.png" data-srcset="/static/2021-01-13-11-28-36-eac4747ff157af76315b814b7b3e55bc-a67b7.png 200w,\n/static/2021-01-13-11-28-36-eac4747ff157af76315b814b7b3e55bc-0b187.png 400w,\n/static/2021-01-13-11-28-36-eac4747ff157af76315b814b7b3e55bc-fee1c.png 800w,\n/static/2021-01-13-11-28-36-eac4747ff157af76315b814b7b3e55bc-ad8d8.png 902w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71511919450787390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const axios = (config) => {\n  if (config.error) {\n    return Promise.reject({\n      error: \'error in axios\'\n    });\n  } else {\n    return Promise.resolve({\n      ...config,\n      result: config.result\n    });\n  }\n};`, `71511919450787390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">axios</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      error<span class="token punctuation">:</span> <span class="token string">\'error in axios\'</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      <span class="token operator">...</span>config<span class="token punctuation">,</span>\n      result<span class="token punctuation">:</span> config<span class="token punctuation">.</span>result\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果传入的 config 中有 error 参数，就返回一个 rejected 的 promise，反之则返回 resolved 的 promise。</p>\n<p>先简单看一下 axios 官方提供的拦截器示例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64134592993098270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`axios.interceptors.request.use(\n  function(config) {\n    // 在发送请求之前做些什么\n    return config;\n  },\n  function(error) {\n    // 对请求错误做些什么\n    return Promise.reject(error);\n  }\n);\n\n// 添加响应拦截器\naxios.interceptors.response.use(\n  function(response) {\n    // 对响应数据做点什么\n    return response;\n  },\n  function(error) {\n    // 对响应错误做点什么\n    return Promise.reject(error);\n  }\n);`, `64134592993098270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 在发送请求之前做些什么</span>\n    <span class="token keyword">return</span> config<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 对请求错误做些什么</span>\n    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 添加响应拦截器</span>\naxios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 对响应数据做点什么</span>\n    <span class="token keyword">return</span> response<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 对响应错误做点什么</span>\n    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看出，不管是 request 还是 response 的拦截请求，都会接受两个函数作为参数，一个是用来处理正常流程，一个是处理失败流程，这让人想到了什么？</p>\n<p>没错，promise.then 接受的同样也是这两个参数。</p>\n<p>axios 内部正是利用了 promise 的这个机制，把 use 传入的两个函数作为一个 intercetpor，每一个 intercetpor 都有 resolved 和 rejected 两个方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45670807789934070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 把\naxios.interceptors.response.use(func1, func2)\n\n// 在内部存储为\n{\n    resolved: func1,\n    rejected: func2\n}`, `45670807789934070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 把</span>\naxios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>func1<span class="token punctuation">,</span> func2<span class="token punctuation">)</span>\n\n<span class="token comment">// 在内部存储为</span>\n<span class="token punctuation">{</span>\n    resolved<span class="token punctuation">:</span> func1<span class="token punctuation">,</span>\n    rejected<span class="token punctuation">:</span> func2\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接下来简单实现一下，这里我们简化一下，把 axios.interceptor.request.use 转为 axios.useRequestInterceptor 来简单实现：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2434548527289393000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 先构造一个对象 存放拦截器\naxios.interceptors = {\n  request: [],\n  response: []\n};\n\n// 注册请求拦截器\naxios.useRequestInterceptor = (resolved, rejected) => {\n  axios.interceptors.request.push({ resolved, rejected });\n};\n\n// 注册响应拦截器\naxios.useResponseInterceptor = (resolved, rejected) => {\n  axios.interceptors.response.push({ resolved, rejected });\n};\n\n// 运行拦截器\naxios.run = (config) => {\n  const chain = [\n    {\n      resolved: axios,\n      rejected: undefined\n    }\n  ];\n\n  // 把请求拦截器往数组头部推\n  axios.interceptors.request.forEach((interceptor) => {\n    chain.unshift(interceptor);\n  });\n\n  // 把响应拦截器往数组尾部推\n  axios.interceptors.response.forEach((interceptor) => {\n    chain.push(interceptor);\n  });\n\n  // 把 config 也包装成一个 promise\n  let promise = Promise.resolve(config);\n\n  // 暴力 while 循环解忧愁\n  // 利用 promise.then 的能力递归执行所有的拦截器\n  while (chain.length) {\n    const { resolved, rejected } = chain.shift();\n    promise = promise.then(resolved, rejected);\n  }\n\n  // 最后暴露给用户的就是响应拦截器处理过后的 promise\n  return promise;\n};`, `2434548527289393000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 先构造一个对象 存放拦截器</span>\naxios<span class="token punctuation">.</span>interceptors <span class="token operator">=</span> <span class="token punctuation">{</span>\n  request<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  response<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 注册请求拦截器</span>\naxios<span class="token punctuation">.</span><span class="token function-variable function">useRequestInterceptor</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">resolved<span class="token punctuation">,</span> rejected</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> resolved<span class="token punctuation">,</span> rejected <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 注册响应拦截器</span>\naxios<span class="token punctuation">.</span><span class="token function-variable function">useResponseInterceptor</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">resolved<span class="token punctuation">,</span> rejected</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> resolved<span class="token punctuation">,</span> rejected <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 运行拦截器</span>\naxios<span class="token punctuation">.</span><span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> chain <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      resolved<span class="token punctuation">:</span> axios<span class="token punctuation">,</span>\n      rejected<span class="token punctuation">:</span> <span class="token keyword">undefined</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 把请求拦截器往数组头部推</span>\n  axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">interceptor</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    chain<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 把响应拦截器往数组尾部推</span>\n  axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">interceptor</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    chain<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 把 config 也包装成一个 promise</span>\n  <span class="token keyword">let</span> promise <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 暴力 while 循环解忧愁</span>\n  <span class="token comment">// 利用 promise.then 的能力递归执行所有的拦截器</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>chain<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token punctuation">{</span> resolved<span class="token punctuation">,</span> rejected <span class="token punctuation">}</span> <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    promise <span class="token operator">=</span> promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolved<span class="token punctuation">,</span> rejected<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 最后暴露给用户的就是响应拦截器处理过后的 promise</span>\n  <span class="token keyword">return</span> promise<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从 axios.run 这个函数看运行时的机制，首先构造一个 chain 作为 promise 链，并且把正常的请求也就是我们的请求参数 axios 也构造为一个拦截器的结构，接下来</p>\n<ul>\n<li>把 request 的 interceptor 给 unshift 到 chain 顶部</li>\n<li>把 response 的 interceptor 给 push 到 chain 尾部</li>\n</ul>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21810777969406493000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 请求拦截器1\naxios.useRequestInterceptor(resolved1, rejected1);\n// 请求拦截器2\naxios.useRequestInterceptor(resolved2, rejected2);\n// 响应拦截器1\naxios.useResponseInterceptor(resolved1, rejected1);\n// 响应拦截器\naxios.useResponseInterceptor(resolved2, rejected2);`, `21810777969406493000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 请求拦截器1</span>\naxios<span class="token punctuation">.</span><span class="token function">useRequestInterceptor</span><span class="token punctuation">(</span>resolved1<span class="token punctuation">,</span> rejected1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 请求拦截器2</span>\naxios<span class="token punctuation">.</span><span class="token function">useRequestInterceptor</span><span class="token punctuation">(</span>resolved2<span class="token punctuation">,</span> rejected2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 响应拦截器1</span>\naxios<span class="token punctuation">.</span><span class="token function">useResponseInterceptor</span><span class="token punctuation">(</span>resolved1<span class="token punctuation">,</span> rejected1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 响应拦截器</span>\naxios<span class="token punctuation">.</span><span class="token function">useResponseInterceptor</span><span class="token punctuation">(</span>resolved2<span class="token punctuation">,</span> rejected2<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样子构造出来的 promise 链就是这样的 chain 结构：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94722935672177700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[\n    请求拦截器2，// ↓config\n    请求拦截器1，// ↓config\n    axios请求核心方法, // ↓response\n    响应拦截器1, // ↓response\n    响应拦截器// ↓response\n]`, `94722935672177700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">[</span>\n    请求拦截器<span class="token number">2</span>，<span class="token comment">// ↓config</span>\n    请求拦截器<span class="token number">1</span>，<span class="token comment">// ↓config</span>\n    axios请求核心方法<span class="token punctuation">,</span> <span class="token comment">// ↓response</span>\n    响应拦截器<span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// ↓response</span>\n    响应拦截器<span class="token comment">// ↓response</span>\n<span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了这个 chain 之后，只需要一句简短的代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66804372527570590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`let promise = Promise.resolve(config);\n\nwhile (chain.length) {\n  const { resolved, rejected } = chain.shift();\n  promise = promise.then(resolved, rejected);\n}\n\nreturn promise;`, `66804372527570590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">let</span> promise <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">while</span> <span class="token punctuation">(</span>chain<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> resolved<span class="token punctuation">,</span> rejected <span class="token punctuation">}</span> <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  promise <span class="token operator">=</span> promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolved<span class="token punctuation">,</span> rejected<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">return</span> promise<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>promise 就会把这个链从上而下的执行了。</p>\n<p>以这样的一段测试代码为例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13984581937242747000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`axios.useRequestInterceptor((config) => {\n  return {\n    ...config,\n    extraParams1: \'extraParams1\'\n  };\n});\n\naxios.useRequestInterceptor((config) => {\n  return {\n    ...config,\n    extraParams2: \'extraParams2\'\n  };\n});\n\naxios.useResponseInterceptor(\n  (resp) => {\n    const {\n      extraParams1,\n      extraParams2,\n      result: { code, message }\n    } = resp;\n    return \\`\\${extraParams1} \\${extraParams2} \\${message}\\`;\n  },\n  (error) => {\n    console.log(\'error\', error);\n  }\n);`, `13984581937242747000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">axios<span class="token punctuation">.</span><span class="token function">useRequestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    <span class="token operator">...</span>config<span class="token punctuation">,</span>\n    extraParams1<span class="token punctuation">:</span> <span class="token string">\'extraParams1\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\naxios<span class="token punctuation">.</span><span class="token function">useRequestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    <span class="token operator">...</span>config<span class="token punctuation">,</span>\n    extraParams2<span class="token punctuation">:</span> <span class="token string">\'extraParams2\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\naxios<span class="token punctuation">.</span><span class="token function">useResponseInterceptor</span><span class="token punctuation">(</span>\n  <span class="token punctuation">(</span><span class="token parameter">resp</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token punctuation">{</span>\n      extraParams1<span class="token punctuation">,</span>\n      extraParams2<span class="token punctuation">,</span>\n      result<span class="token punctuation">:</span> <span class="token punctuation">{</span> code<span class="token punctuation">,</span> message <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span> <span class="token operator">=</span> resp<span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>extraParams1<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>extraParams2<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'error\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ol>\n<li>\n<p>成功的调用</p>\n<p>在成功的调用下输出 <code class="language-text">result1: extraParams1 extraParams2 message1</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42038527817306060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(async function() {\n const result = await axios.run({\n   message: \'message1\'\n });\n console.log(\'result1: \', result);\n})();`, `42038527817306060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n   message<span class="token punctuation">:</span> <span class="token string">\'message1\'</span>\n <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'result1: \'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>失败的调用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93967040286001330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(async function() {\n const result = await axios.run({\n   error: true\n });\n console.log(\'result3: \', result);\n})();`, `93967040286001330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n   error<span class="token punctuation">:</span> <span class="token boolean">true</span>\n <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'result3: \'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<p>在失败的调用下，则进入响应拦截器的 rejected 分支：</p>\n<p>首先打印出拦截器定义的错误日志：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47911428581582840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`error { error: \'error in axios\' }`, `47911428581582840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">error { error: &#39;error in axios&#39; }</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后由于失败的拦截器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9189981976981309000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`error => {\n  console.log(\'error\', error)\n},`, `9189981976981309000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token parameter">error</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'error\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>没有返回任何东西，打印出 <code class="language-text">result3: undefined</code></p>\n<p>可以看出，axios 的拦截器是非常灵活的，可以在请求阶段任意的修改 config，也可以在响应阶段对 response 做各种处理，这也是因为用户对于请求数据的需求就是非常灵活的，没有必要干涉用户的自由度。</p>\n<h1 id="vuex"><a href="#vuex" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>vuex</h1>\n<p>vuex 提供了一个 api 用来在 action 被调用前后插入一些逻辑：</p>\n<p><a href="https://vuex.vuejs.org/zh/api/#subscribeaction" target="_blank" rel="nofollow noreferrer noopener">https://vuex.vuejs.org/zh/api/#subscribeaction</a></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22068242819341430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`store.subscribeAction({\n  before: (action, state) => {\n    console.log(\\`before action \\${action.type}\\`);\n  },\n  after: (action, state) => {\n    console.log(\\`after action \\${action.type}\\`);\n  }\n});`, `22068242819341430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">store<span class="token punctuation">.</span><span class="token function">subscribeAction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  <span class="token function-variable function">before</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">action<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">before action </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>action<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token function-variable function">after</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">action<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">after action </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>action<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其实这有点像 AOP（面向切面编程）的编程思想。</p>\n<p>在调用 <code class="language-text">store.dispatch({ type: &#39;add&#39; })</code> 的时候，会在执行前后打印出日志</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33719775827671118000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`before action add\nadd\nafter action add`, `33719775827671118000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">before action add\nadd\nafter action add</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>来简单实现一下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13694823164686754000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { Actions, ActionSubscribers, ActionSubscriber, ActionArguments } from \'./vuex.type\';\n\nclass Vuex {\n  state = {};\n\n  action = {};\n\n  _actionSubscribers = [];\n\n  constructor({ state, action }) {\n    this.state = state;\n    this.action = action;\n    this._actionSubscribers = [];\n  }\n\n  dispatch(action) {\n    // action前置监听器\n    this._actionSubscribers.forEach((sub) => sub.before(action, this.state));\n\n    const { type, payload } = action;\n\n    // 执行action\n    this.action[type](this.state, payload).then(() => {\n      // action后置监听器\n      this._actionSubscribers.forEach((sub) => sub.after(action, this.state));\n    });\n  }\n\n  subscribeAction(subscriber) {\n    // 把监听者推进数组\n    this._actionSubscribers.push(subscriber);\n  }\n}\n\nconst store = new Vuex({\n  state: {\n    count: 0\n  },\n  action: {\n    async add(state, payload) {\n      state.count += payload;\n    }\n  }\n});\n\nstore.subscribeAction({\n  before: (action, state) => {\n    console.log(\\`before action \\${action.type}, before count is \\${state.count}\\`);\n  },\n  after: (action, state) => {\n    console.log(\\`after action \\${action.type},  after count is \\${state.count}\\`);\n  }\n});\n\nstore.dispatch({\n  type: \'add\',\n  payload: 2\n});`, `13694823164686754000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Actions<span class="token punctuation">,</span> ActionSubscribers<span class="token punctuation">,</span> ActionSubscriber<span class="token punctuation">,</span> ActionArguments <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'./vuex.type\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Vuex</span> <span class="token punctuation">{</span>\n  state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  action <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  _actionSubscribers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> state<span class="token punctuation">,</span> action <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>action <span class="token operator">=</span> action<span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>_actionSubscribers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// action前置监听器</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>_actionSubscribers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token operator">=></span> sub<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> payload <span class="token punctuation">}</span> <span class="token operator">=</span> action<span class="token punctuation">;</span>\n\n    <span class="token comment">// 执行action</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>action<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// action后置监听器</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>_actionSubscribers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token operator">=></span> sub<span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">subscribeAction</span><span class="token punctuation">(</span><span class="token parameter">subscriber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 把监听者推进数组</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>_actionSubscribers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>subscriber<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vuex</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  state<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    count<span class="token punctuation">:</span> <span class="token number">0</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  action<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    <span class="token keyword">async</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      state<span class="token punctuation">.</span>count <span class="token operator">+=</span> payload<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nstore<span class="token punctuation">.</span><span class="token function">subscribeAction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  <span class="token function-variable function">before</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">action<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">before action </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>action<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, before count is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token punctuation">.</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token function-variable function">after</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">action<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">after action </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>action<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,  after count is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token punctuation">.</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nstore<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  type<span class="token punctuation">:</span> <span class="token string">\'add\'</span><span class="token punctuation">,</span>\n  payload<span class="token punctuation">:</span> <span class="token number">2</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>此时控制台会打印如下内容：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88620617072318730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`before action add, before count is 0\nafter action add, after count is 2`, `88620617072318730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">before action add, before count is 0\nafter action add, after count is 2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>轻松实现了日志功能。</p>\n<p>当然 Vuex 在实现插件功能的时候，选择性的将 type payload 和 state 暴露给外部，而不再提供进一步的修改能力，这也是框架内部的一种权衡，当然我们可以对 state 进行直接修改，但是不可避免的会得到 Vuex 内部的警告，因为在 Vuex 中，所有 state 的修改都应该通过 mutations 来进行，但是 Vuex 没有选择把 commit 也暴露出来，这也约束了插件的能力。</p>\n<h1 id="redux"><a href="#redux" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>redux</h1>\n<p>想要理解 redux 中的中间件机制，需要先理解一个方法：compose</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43704599941178080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function compose(...funcs: Function[]) {\n  return funcs.reduce((a, b) => (...args: any) => a(b(...args)));\n}`, `43704599941178080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>funcs<span class="token punctuation">:</span> Function<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> funcs<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>简单理解的话，就是 <code class="language-text">compose(fn1, fn2, fn3) (...args) = &gt; fn1(fn2(fn3(...args)))</code> 它是一种高阶聚合函数，相当于把 fn3 先执行，然后把结果传给 fn2 再执行，再把结果交给 fn1 去执行。</p>\n<p>有了这个前置知识，就可以很轻易的实现 redux 的中间件机制了。</p>\n<p>虽然 redux 源码里写的很少，各种高阶函数各种柯里化，但是抽丝剥茧以后，redux 中间件的机制可以用一句话来解释：</p>\n<p><strong>把 dispatch 这个方法不断用高阶函数包装，最后返回一个强化过后的 dispatch</strong></p>\n<p>以 logMiddleware 为例，这个 middleware 接受原始的 redux dispatch，返回的是</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99131556971036660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const typeLogMiddleware = (dispatch) => {\n  // 返回的其实还是一个结构相同的dispatch，接受的参数也相同\n  // 只是把原始的dispatch包在里面了而已。\n  return ({ type, ...args }) => {\n    console.log(\\`type is \\${type}\\`);\n    return dispatch({ type, ...args });\n  };\n};`, `99131556971036660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">typeLogMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dispatch</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 返回的其实还是一个结构相同的dispatch，接受的参数也相同</span>\n  <span class="token comment">// 只是把原始的dispatch包在里面了而已。</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> type<span class="token punctuation">,</span> <span class="token operator">...</span>args <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">type is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">,</span> <span class="token operator">...</span>args <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了这个思路，就来实现这个 mini-redux 吧：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56905527571978486000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function compose(...funcs) {\n  return funcs.reduce((a, b) => (...args) => a(b(...args)));\n}\n\nfunction createStore(reducer, middlewares) {\n  let currentState;\n\n  function dispatch(action) {\n    currentState = reducer(currentState, action);\n  }\n\n  function getState() {\n    return currentState;\n  }\n\n  // 初始化一个随意的 dispatch，要求外部在 type 匹配不到的时候返回初始状态\n  // 在这个 dispatch 后 currentState 就有值了。\n  dispatch({\n    type: \'INIT\'\n  });\n\n  let enhancedDispatch = dispatch;\n  // 如果第二个参数传入了 middlewares\n  if (middlewares) {\n    // 用 compose 把 middlewares 包装成一个函数\n    enhancedDispatch = compose(...middlewares)(dispatch);\n  }\n\n  return {\n    dispatch: enhancedDispatch,\n    getState\n  };\n}`, `56905527571978486000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>funcs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> funcs<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">createStore</span><span class="token punctuation">(</span><span class="token parameter">reducer<span class="token punctuation">,</span> middlewares</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> currentState<span class="token punctuation">;</span>\n\n  <span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    currentState <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>currentState<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">function</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> currentState<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 初始化一个随意的 dispatch，要求外部在 type 匹配不到的时候返回初始状态</span>\n  <span class="token comment">// 在这个 dispatch 后 currentState 就有值了。</span>\n  <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    type<span class="token punctuation">:</span> <span class="token string">\'INIT\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">let</span> enhancedDispatch <span class="token operator">=</span> dispatch<span class="token punctuation">;</span>\n  <span class="token comment">// 如果第二个参数传入了 middlewares</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>middlewares<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 用 compose 把 middlewares 包装成一个函数</span>\n    enhancedDispatch <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token operator">...</span>middlewares<span class="token punctuation">)</span><span class="token punctuation">(</span>dispatch<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    dispatch<span class="token punctuation">:</span> enhancedDispatch<span class="token punctuation">,</span>\n    getState\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接着写两个中间件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8125311123639256000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 使用\n\nconst otherDummyMiddleware = (dispatch) => {\n  // 返回一个新的 dispatch\n  return (action) => {\n    console.log(\\`type in dummy is \\${type}\\`);\n    return dispatch(action);\n  };\n};\n\n// 这个 dispatch 其实是 otherDummyMiddleware 执行后返回 otherDummyDispatch\nconst typeLogMiddleware = (dispatch) => {\n  // 返回一个新的 dispatch\n  return ({ type, ...args }) => {\n    console.log(\\`type is \\${type}\\`);\n    return dispatch({ type, ...args });\n  };\n};\n\n// 中间件从右往左执行，相当于 typeLogMiddleware(otherDummyMiddleware(dispatch))\nconst counterStore = createStore(counterReducer, [typeLogMiddleware, otherDummyMiddleware]);\n\nconsole.log(counterStore.getState().count);\ncounterStore.dispatch({ type: \'add\', payload: 2 });\nconsole.log(counterStore.getState().count);\n\n// 输出：\n// 0\n// type is add\n// type in dummy is add\n// 2`, `8125311123639256000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 使用</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">otherDummyMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dispatch</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 返回一个新的 dispatch</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">type in dummy is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 这个 dispatch 其实是 otherDummyMiddleware 执行后返回 otherDummyDispatch</span>\n<span class="token keyword">const</span> <span class="token function-variable function">typeLogMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dispatch</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 返回一个新的 dispatch</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> type<span class="token punctuation">,</span> <span class="token operator">...</span>args <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">type is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">,</span> <span class="token operator">...</span>args <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 中间件从右往左执行，相当于 typeLogMiddleware(otherDummyMiddleware(dispatch))</span>\n<span class="token keyword">const</span> counterStore <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>counterReducer<span class="token punctuation">,</span> <span class="token punctuation">[</span>typeLogMiddleware<span class="token punctuation">,</span> otherDummyMiddleware<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>counterStore<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>\ncounterStore<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">\'add\'</span><span class="token punctuation">,</span> payload<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>counterStore<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 输出：</span>\n<span class="token comment">// 0</span>\n<span class="token comment">// type is add</span>\n<span class="token comment">// type in dummy is add</span>\n<span class="token comment">// 2</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="koa"><a href="#koa" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>koa</h1>\n<p>koa 的洋葱模型想必各位都听说过，这种灵活的中间件机制也让 koa 变得非常强大，本文也会实现一个简单的洋葱中间件机制。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-01-14-10-26-26-883585e92ba59604b8ad510417cb608c-b4044.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 478px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 91.00418410041841%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAAsSAAALEgHS3X78AAAC1UlEQVQ4y4VUS08aURgFBERABuX9EHmJ1qZU/QWSaGJwZWLiwg7UdGsTS1HRGEu3dsmGwB+oSWlMdCPGsHGhYiJKE4GAWGA0WoOJ742mR4b6ICH9Fne+mXvPd77HucNg/DMmk8nj8RoaGiwWS2dnZ09Pj81mE4vF9Bbjv2Y0GoHp7e21Wq0dHR2Dg4MOh4PNZlcF1NTUPPo4x+fzH6m0Wu3U1JRSqaxKLpfLVSqVRCKRSqXwWSwWztFsCARwa2trVTDO1dXVodra2lo4zw91d3d7vV5EhI+gXC6X+czwpdwqQkTQLxwOp6ury+VyBQKBSCSyuLioUCjo6mQymUajUavVyBE+nDJYq9GAHH36NjcX393NZrP5XH5/f58qFIaHh2kwzYYEQfDEDCMIot/ev7CwcHR0lEomc7nc1dXV+fk5RVGrq6uNjY2PZctlcuCfxotVKpFMTkzgdCqVOqQOLy8vLy4urq+vfx8c/Dk5IUnyoSIuR6VQGnR6xnNtYEVujnekk3QcHx/f3Nycnp4CCefs7Oz+/v77/DxBiM0G46sWi1AorOz5zMxM6Efo7es3H0ZGfsXjt7e3mUwmmUhEo9FQKPRpbKzFZAZSUsq/ktntdiNV5IwQ4XCYog7drs9Okvw4OvrV6/0yO2s2mTD2ymnTTRsYGABVJp0uFot3d3cPUUI/V8IrS0tLIN/Y2IByadlg2phLWZd0MAxzeXn5IdVkEnUWCoXY9nYsFltbW1tfX/f7/RCpoWTQbFtbm1qlLmdBP4aGhtLpNAre29sr5PNbW1sgjMfjiPLe6ayvrwcMQtbr9VAIRvt0KTA6bHgmJ6Obm1AIep5IJHZ2doD3eDwQlkAohKR0Oh2kjtcXPReJRLi9dru9r69vfHzc5/MFg8Hp6Wl8QUUoUiAQNJfMbDa3t7fDedE5iA6FYc9kMiFDXBL8GJAeVogZ185YMm1TE8KBDJC/ap0S4tdMO1EAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 01 14 10 26 26" title="" data-src="/static/2021-01-14-10-26-26-883585e92ba59604b8ad510417cb608c-b4044.png" data-srcset="/static/2021-01-14-10-26-26-883585e92ba59604b8ad510417cb608c-061d7.png 200w,\n/static/2021-01-14-10-26-26-883585e92ba59604b8ad510417cb608c-51120.png 400w,\n/static/2021-01-14-10-26-26-883585e92ba59604b8ad510417cb608c-b4044.png 478w" data-sizes="(max-width: 478px) 100vw, 478px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>对应这张图来看，洋葱的每一个圈就是一个中间件，它既可以掌管请求进入，也可以掌管响应返回。</p>\n<p>它和 redux 的中间件机制有点类似，本质上都是高阶函数的嵌套，外层的中间件嵌套着内层的中间件，这种机制的好处是可以自己控制中间件的能力（外层的中间件可以影响内层的请求和响应阶段，内层的中间件只能影响外层的响应阶段）</p>\n<p>首先我们写出 Koa 这个类</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17677374014541480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Koa {\n  constructor() {\n    this.middlewares = [];\n  }\n  use(middleware) {\n    this.middlewares.push(middleware);\n  }\n  start({ req }) {\n    const composed = composeMiddlewares(this.middlewares);\n    const ctx = { req, res: undefined };\n    return composed(ctx);\n  }\n}`, `17677374014541480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Koa</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>middlewares <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">middleware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>middlewares<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>middleware<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> req <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> composed <span class="token operator">=</span> <span class="token function">composeMiddlewares</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>middlewares<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token punctuation">{</span> req<span class="token punctuation">,</span> res<span class="token punctuation">:</span> <span class="token keyword">undefined</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token function">composed</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里的 use 就是简单的把中间件推入中间件队列中，那核心就是怎样去把这些中间件组合起来了，下面看 <code class="language-text">composeMiddlewares</code> 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60041195125764420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function composeMiddlewares(middlewares) {\n  return function wrapMiddlewares(ctx) {\n    // 记录当前运行的 middleware 的下标\n    let index = -1;\n    function dispatch(i) {\n      // index 向后移动\n      index = i;\n\n      // 找出数组中存放的相应的中间件\n      const fn = middlewares[i];\n\n      // 最后一个中间件调用 next 也不会报错\n      if (!fn) {\n        return Promise.resolve();\n      }\n\n      return Promise.resolve(\n        fn(\n          // 继续传递 ctx\n          ctx,\n          // next 方法，允许进入下一个中间件。\n          () => dispatch(i + 1)\n        )\n      );\n    }\n    // 开始运行第一个中间件\n    return dispatch(0);\n  };\n}`, `60041195125764420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">composeMiddlewares</span><span class="token punctuation">(</span><span class="token parameter">middlewares</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">wrapMiddlewares</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 记录当前运行的 middleware 的下标</span>\n    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// index 向后移动</span>\n      index <span class="token operator">=</span> i<span class="token punctuation">;</span>\n\n      <span class="token comment">// 找出数组中存放的相应的中间件</span>\n      <span class="token keyword">const</span> fn <span class="token operator">=</span> middlewares<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 最后一个中间件调用 next 也不会报错</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>\n        <span class="token function">fn</span><span class="token punctuation">(</span>\n          <span class="token comment">// 继续传递 ctx</span>\n          ctx<span class="token punctuation">,</span>\n          <span class="token comment">// next 方法，允许进入下一个中间件。</span>\n          <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>\n        <span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// 开始运行第一个中间件</span>\n    <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>简单来说 <code class="language-text">dispatch(n)</code> 对应着第 n 个中间件的执行，而 <code class="language-text">dispatch(n)</code> 又拥有执行 <code class="language-text">dispatch(n + 1)</code> 的权力，</p>\n<p>所以在真正运行的时候，中间件并不是在平级的运行，而是嵌套的高阶函数：</p>\n<p><code class="language-text">dispatch(0)</code> 包含着 <code class="language-text">dispatch(1)</code>，而 <code class="language-text">dispatch(1)</code> 又包含着 <code class="language-text">dispatch(2)</code>，在这个模式下，我们很容易联想到 try catch 的机制，它可以 catch 住函数以及函数内部继续调用的函数的所有 error。</p>\n<p>那么我们的第一个中间件就可以做一个错误处理中间件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39282774574473380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 最外层：管控全局错误\napp.use(async (ctx, next) => {\n  try {\n    // 这里的 next 包含了第二层以及第三层的运行\n    await next();\n  } catch (error) {\n    console.log(\\`[koa error]: \\${error.message}\\`);\n  }\n});`, `39282774574473380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 最外层：管控全局错误</span>\napp<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 这里的 next 包含了第二层以及第三层的运行</span>\n    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[koa error]: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在这个错误处理中间件中，我们把 next 包裹在 try catch 中运行，调用了 next 后会进入第二层的中间件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47065778729876050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 第二层：日志中间件\napp.use(async (ctx, next) => {\n  const { req } = ctx;\n  console.log(\\`req is \\${JSON.stringify(req)}\\`);\n  await next();\n  // next 过后已经能拿到第三层写进 ctx 的数据了\n  console.log(\\`res is \\${JSON.stringify(ctx.res)}\\`);\n});`, `47065778729876050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 第二层：日志中间件</span>\napp<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> req <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">req is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// next 过后已经能拿到第三层写进 ctx 的数据了</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">res is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>res<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在第二层中间件的 next 调用后，进入第三层，业务逻辑处理中间件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37242422221984326000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 第三层：核心服务中间件\n// 在真实场景中，这一层一般用来构造真正需要返回的数据，写入ctx中\napp.use(async (ctx, next) => {\n  const { req } = ctx;\n  console.log(\\`calculating the res of \\${req}...\\`);\n  const res = {\n    code: 200,\n    result: \\`req \\${req} success\\`\n  };\n  // 写入ctx\n  ctx.res = res;\n  await next();\n});`, `37242422221984326000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 第三层：核心服务中间件</span>\n<span class="token comment">// 在真实场景中，这一层一般用来构造真正需要返回的数据，写入ctx中</span>\napp<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> req <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">calculating the res of </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">{</span>\n    code<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>\n    result<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">req </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> success</span><span class="token template-punctuation string">`</span></span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token comment">// 写入ctx</span>\n  ctx<span class="token punctuation">.</span>res <span class="token operator">=</span> res<span class="token punctuation">;</span>\n  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在这一层把 res 写入 ctx 后，函数出栈，又会回到第二层中间件的 <code class="language-text">await next()</code> 后面</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54004783402437980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`console.log(\\`req is \\${JSON.stringify(req)}\\`);\nawait next();\n// <- 回到这里\nconsole.log(\\`res is \\${JSON.stringify(ctx.res)}\\`);`, `54004783402437980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">req is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// &lt;- 回到这里</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">res is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>res<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这时候日志中间件就可以拿到 ctx.res 的值了。</p>\n<p>想要测试错误处理中间件，就在最后加入这个中间件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95228042922344940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 用来测试全局错误中间件\n// 注释掉这一个中间件 服务才能正常响应\napp.use(async (ctx, next) => {\n  throw new Error(\'oops! error!\');\n});`, `95228042922344940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 用来测试全局错误中间件</span>\n<span class="token comment">// 注释掉这一个中间件 服务才能正常响应</span>\napp<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'oops! error!\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最后要调用启动函数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60006871214932090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`app.start({ req: \'ssh\' });`, `60006871214932090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">{</span> req<span class="token punctuation">:</span> <span class="token string">\'ssh\'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>控制台打印出结果：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65076458434830670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`req is &quot;ssh&quot;\ncalculating the res of ssh...\nres is {&quot;code&quot;:200,&quot;result&quot;:&quot;req ssh success&quot;}`, `65076458434830670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">req is &quot;ssh&quot;\ncalculating the res of ssh...\nres is {&quot;code&quot;:200,&quot;result&quot;:&quot;req ssh success&quot;}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h1 id="总结"><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h1>\n<ol>\n<li>axios 把用户注册的每个拦截器构造成一个 promise.then 所接受的参数，在运行时把所有的拦截器按照一个 promise 链的形式以此执行。</li>\n<li>在发送到服务端之前，config 已经是请求拦截器处理过后的结果</li>\n<li>服务器响应结果后，response 会经过响应拦截器，最后用户拿到的就是处理过后的结果了。</li>\n<li>vuex 的实现最为简单，就是提供了两个回调函数，vuex 内部在合适的时机去调用（我个人感觉大部分的库提供这样的机制也足够了）。</li>\n<li>redux 的源码里写的最复杂最绕，它的中间件机制本质上就是用高阶函数不断的把 dispatch 包装再包装，形成套娃。本文实现的已经是精简了 n 倍以后的结果了，不过复杂的实现也是为了很多权衡和考量，Dan 对于闭包和高阶函数的运用已经炉火纯青了，只是外人去看源码有点头秃…</li>\n<li>koa 的洋葱模型实现的很精妙，和 redux 有相似之处，但是在源码理解和使用上个人感觉更优于 redux 的中间件。</li>\n</ol>\n<p>中间件机制其实是非框架强相关的，请求库一样可以加入 koa 的洋葱中间件机制（如 umi-request），不同的框架可能适合不同的中间件机制，这还是取决于你编写的框架想要解决什么问题，想给用户什么样的自由度。</p>\n<p>希望看了这篇文章的你，能对于前端库中的中间件机制有进一步的了解，进而为你自己的前端库加入合适的中间件能力。</p>\n<p>本文示例代码：<a href="https://github.com/towavephone/tiny-middlewares" target="_blank" rel="nofollow noreferrer noopener">https://github.com/towavephone/tiny-middlewares</a></p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/插件机制、拦截器、中间件/index.md absPath of file >>> MarkdownRemark",timeToRead:7,frontmatter:{date:"2021-01-13 11:21:46",path:"/plug-interceptor-middleware/",tags:"前端, JS, 高级前端",title:"插件机制、拦截器、中间件",draft:null}},{excerpt:"我们需要一个健全的架构捕获所有同步、异步的异常。业务方不处理异常时，中断函数执行并启用默认处理，业务方也可以随时捕获异常自己处理。 优雅的异常处理方式就像冒泡事件，任何元素可以自由拦截，也可以放任不管交给顶层处理。 回调 如果在回调函数中直接处理了异常，是最不明智的选择，因为业务方完全失去了对异常的控制能力。 下方的函数请求处理不但永远不会执行，还无法在异常时做额外的处理，也无法阻止异常产生时笨拙的 console.log…",html:'<p>我们需要一个健全的架构捕获所有同步、异步的异常。业务方不处理异常时，中断函数执行并启用默认处理，业务方也可以随时捕获异常自己处理。</p>\n<p>优雅的异常处理方式就像冒泡事件，任何元素可以自由拦截，也可以放任不管交给顶层处理。</p>\n<h1 id="回调"><a href="#%E5%9B%9E%E8%B0%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>回调</h1>\n<p>如果在回调函数中直接处理了异常，是最不明智的选择，因为业务方完全失去了对异常的控制能力。</p>\n<p>下方的函数请求处理不但永远不会执行，还无法在异常时做额外的处理，也无法阻止异常产生时笨拙的 console.log(‘请求失败’) 行为。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27932161352789975000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function fetch(callback) {\n  setTimeout(() => {\n    console.log(\'请求失败\');\n  });\n}\n\nfetch(() => {\n  console.log(\'请求处理\'); // 永远不会执行\n});`, `27932161352789975000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'请求失败\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'请求处理\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="回调，无法捕获的异常"><a href="#%E5%9B%9E%E8%B0%83%EF%BC%8C%E6%97%A0%E6%B3%95%E6%8D%95%E8%8E%B7%E7%9A%84%E5%BC%82%E5%B8%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>回调，无法捕获的异常</h1>\n<p>回调函数有同步和异步之分，区别在于对方执行回调函数的时机，异常一般出现在请求、数据库连接等操作中，这些操作大多是异步的。</p>\n<p>异步回调中，回调函数的执行栈与原函数分离开，导致外部无法抓住异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8376986159989497000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function fetch(callback) {\n  setTimeout(() => {\n    throw Error(\'请求失败\');\n  });\n}\n\ntry {\n  fetch(() => {\n    console.log(\'请求处理\'); // 永远不会执行\n  });\n} catch (error) {\n  console.log(\'触发异常\', error); // 永远不会执行\n}\n\n// 程序崩溃\n// Uncaught Error: 请求失败`, `8376986159989497000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">\'请求失败\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">try</span> <span class="token punctuation">{</span>\n  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'请求处理\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'触发异常\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 程序崩溃</span>\n<span class="token comment">// Uncaught Error: 请求失败</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="回调，不可控的异常"><a href="#%E5%9B%9E%E8%B0%83%EF%BC%8C%E4%B8%8D%E5%8F%AF%E6%8E%A7%E7%9A%84%E5%BC%82%E5%B8%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>回调，不可控的异常</h1>\n<p>我们变得谨慎，不敢再随意抛出异常，这已经违背了异常处理的基本原则。</p>\n<p>虽然使用了 error-first 约定，使异常看起来变得可处理，但业务方依然没有对异常的控制权，是否调用错误处理取决于回调函数是否执行，我们无法知道调用的函数是否可靠。</p>\n<p>更糟糕的问题是，业务方必须处理异常，否则程序挂掉就会什么都不做，这对大部分不用特殊处理异常的场景造成了很大的精神负担。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57068046820250526000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function fetch(handleError, callback) {\n  setTimeout(() => {\n    handleError(\'请求失败\');\n  });\n}\n\nfetch(\n  () => {\n    console.log(\'失败处理\'); // 失败处理\n  },\n  (error) => {\n    console.log(\'请求处理\'); // 永远不会执行\n  }\n);`, `57068046820250526000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token parameter">handleError<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">handleError</span><span class="token punctuation">(</span><span class="token string">\'请求失败\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">fetch</span><span class="token punctuation">(</span>\n  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'失败处理\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 失败处理</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'请求处理\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="promise-异常处理"><a href="#promise-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Promise 异常处理</h1>\n<p>不仅是 reject，抛出的异常也会被作为拒绝状态被 Promise 捕获。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84103456401548590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function fetch(callback) {\n  return new Promise((resolve, reject) => {\n    throw Error(\'用户不存在\');\n  });\n}\n\nfetch()\n  .then((result) => {\n    console.log(\'请求处理\', result); // 永远不会执行\n  })\n  .catch((error) => {\n    console.log(\'请求处理异常\', error); // 请求处理异常 用户不存在\n  });`, `84103456401548590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">\'用户不存在\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'请求处理\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'请求处理异常\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 请求处理异常 用户不存在</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="promise-无法捕获的异常"><a href="#promise-%E6%97%A0%E6%B3%95%E6%8D%95%E8%8E%B7%E7%9A%84%E5%BC%82%E5%B8%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Promise 无法捕获的异常</h1>\n<p>但是，永远不要在 macrotask 队列中抛出异常，因为 macrotask 队列脱离了运行上下文环境，异常无法被当前作用域捕获。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44283433708474160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function fetch(callback) {\n  return new Promise((resolve, reject) => {\n    setTimeout(() => {\n      throw Error(\'用户不存在\');\n    });\n  });\n}\n\nfetch()\n  .then((result) => {\n    console.log(\'请求处理\', result); // 永远不会执行\n  })\n  .catch((error) => {\n    console.log(\'请求处理异常\', error); // 永远不会执行\n  });\n\n// 程序崩溃\n// Uncaught Error: 用户不存在`, `44283433708474160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">\'用户不存在\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'请求处理\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'请求处理异常\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 程序崩溃</span>\n<span class="token comment">// Uncaught Error: 用户不存在</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>不过 microtask 中抛出的异常可以被捕获，说明 microtask 队列并没有离开当前作用域，我们通过以下例子来证明：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6433432479831747000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Promise.resolve(true)\n  .then((resolve, reject) => {\n    throw Error(\'microtask 中的异常\');\n  })\n  .catch((error) => {\n    console.log(\'捕获异常\', error); // 捕获异常 Error: microtask 中的异常\n  });`, `6433432479831747000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">\'microtask 中的异常\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'捕获异常\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 捕获异常 Error: microtask 中的异常</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>至此，Promise 的异常处理有了比较清晰的答案，只要注意在 macrotask 级别回调中使用 reject，就没有抓不住的异常。</p>\n<h1 id="promise-异常追问"><a href="#promise-%E5%BC%82%E5%B8%B8%E8%BF%BD%E9%97%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Promise 异常追问</h1>\n<p>如果第三方函数在 macrotask 回调中以 throw Error 的方式抛出异常怎么办？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80718835619488150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function thirdFunction() {\n  setTimeout(() => {\n    throw Error(\'就是任性\');\n  });\n}\n\nPromise.resolve(true)\n  .then((resolve, reject) => {\n    thirdFunction();\n  })\n  .catch((error) => {\n    console.log(\'捕获异常\', error);\n  });\n\n// 程序崩溃\n// Uncaught Error: 就是任性`, `80718835619488150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">\'就是任性\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nPromise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'捕获异常\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 程序崩溃</span>\n<span class="token comment">// Uncaught Error: 就是任性</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>值得欣慰的是，由于不在同一个调用栈，虽然这个异常无法被捕获，但也不会影响当前调用栈的执行。</p>\n<p>我们必须正视这个问题，唯一的解决办法，是第三方函数不要做这种傻事，一定要在 macrotask 抛出异常的话，请改为 reject 的方式。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6601398075067921000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function thirdFunction() {\n  return new Promise((resolve, reject) => {\n    setTimeout(() => {\n      reject(\'收敛一些\');\n    });\n  });\n}\n\nPromise.resolve(true)\n  .then((resolve, reject) => {\n    return thirdFunction();\n  })\n  .catch((error) => {\n    console.log(\'捕获异常\', error); // 捕获异常 收敛一些\n  });`, `6601398075067921000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">\'收敛一些\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nPromise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'捕获异常\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 捕获异常 收敛一些</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>请注意，如果 <code class="language-text">return thirdFunction()</code> 这行缺少了 return 的话，依然无法抓住这个错误，这是因为没有将对方返回的 Promise 传递下去，错误也不会继续传递。</p>\n<p>我们发现，这样还不是完美的办法，不但容易忘记 return，而且当同时含有多个第三方函数时，处理方式不太优雅：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89972670295416820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function thirdFunction() {\n  return new Promise((resolve, reject) => {\n    setTimeout(() => {\n      reject(\'收敛一些\');\n    });\n  });\n}\n\nPromise.resolve(true)\n  .then((resolve, reject) => {\n    return thirdFunction()\n      .then(() => {\n        return thirdFunction();\n      })\n      .then(() => {\n        return thirdFunction();\n      })\n      .then(() => {});\n  })\n  .catch((error) => {\n    console.log(\'捕获异常\', error);\n  });`, `89972670295416820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">\'收敛一些\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nPromise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'捕获异常\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>是的，我们还有更好的处理方式。</p>\n<h1 id="async-await-异常"><a href="#async-await-%E5%BC%82%E5%B8%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Async Await 异常</h1>\n<p>不论是同步、异步的异常，await 都不会自动捕获，但好处是可以自动中断函数，我们大可放心编写业务逻辑，而不用担心异步异常后会被执行引发雪崩：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89849127415318600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function fetch(callback) {\n  return new Promise((resolve, reject) => {\n    setTimeout(() => {\n      reject();\n    });\n  });\n}\n\nasync function main() {\n  const result = await fetch();\n  console.log(\'请求处理\', result); // 永远不会执行\n}\n\nmain();`, `89849127415318600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'请求处理\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="async-await-捕获异常"><a href="#async-await-%E6%8D%95%E8%8E%B7%E5%BC%82%E5%B8%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Async Await 捕获异常</h1>\n<p>我们使用 try catch 捕获异常，为什么此时异步的异常可以通过 try catch 来捕获。</p>\n<p>因为此时的异步其实在一个作用域中，通过 generator 控制执行顺序，所以可以将异步看做同步的代码去编写，包括使用 try catch 捕获异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24511399809391340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function fetch(callback) {\n  return new Promise((resolve, reject) => {\n    setTimeout(() => {\n      reject(\'no\');\n    });\n  });\n}\n\nasync function main() {\n  try {\n    const result = await fetch();\n    console.log(\'请求处理\', result); // 永远不会执行\n  } catch (error) {\n    console.log(\'异常\', error); // 异常 no\n  }\n}\n\nmain();`, `24511399809391340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">\'no\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'请求处理\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'异常\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 异常 no</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="async-await-无法捕获的异常"><a href="#async-await-%E6%97%A0%E6%B3%95%E6%8D%95%E8%8E%B7%E7%9A%84%E5%BC%82%E5%B8%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Async Await 无法捕获的异常</h1>\n<p>和 <code class="language-text">Promise 无法捕获的异常</code> 一样，这也是 await 的软肋，不过依然可以通过 <code class="language-text">Promise 异常追问</code> 的方案解决：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3848544483331917300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function thirdFunction() {\n  return new Promise((resolve, reject) => {\n    setTimeout(() => {\n      reject(\'收敛一些\');\n    });\n  });\n}\n\nasync function main() {\n  try {\n    const result = await thirdFunction();\n    console.log(\'请求处理\', result); // 永远不会执行\n  } catch (error) {\n    console.log(\'异常\', error); // 异常 收敛一些\n  }\n}\n\nmain();`, `3848544483331917300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">\'收敛一些\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'请求处理\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'异常\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 异常 收敛一些</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在解答 <code class="language-text">Promise 异常追问</code> 尾部的问题，为什么 await 是更加优雅的方案：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14745433740310477000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`async function main() {\n  try {\n    const result1 = await secondFunction(); // 如果不抛出异常，后续继续执行\n    const result2 = await thirdFunction(); // 抛出异常\n    const result3 = await thirdFunction(); // 永远不会执行\n    console.log(\'请求处理\', result); // 永远不会执行\n  } catch (error) {\n    console.log(\'异常\', error); // 异常 收敛一些\n  }\n}\n\nmain();`, `14745433740310477000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> result1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">secondFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果不抛出异常，后续继续执行</span>\n    <span class="token keyword">const</span> result2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 抛出异常</span>\n    <span class="token keyword">const</span> result3 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'请求处理\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'异常\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 异常 收敛一些</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="业务场景"><a href="#%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>业务场景</h1>\n<p>在如今 action 概念成为标配的时代，我们大可以将所有异常处理收敛到 action 中。</p>\n<p>我们以如下业务代码为例，默认不捕获错误的话，错误会一直冒泡到顶层，最后抛出异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98526416856597530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const successRequest = () => Promise.resolve(\'a\');\nconst failRequest = () => Promise.reject(\'b\');\n\nclass Action {\n  async successReuqest() {\n    const result = await successRequest();\n    console.log(\'successReuqest\', \'处理返回值\', result); // successReuqest 处理返回值 a\n  }\n\n  async failReuqest() {\n    const result = await failRequest();\n    console.log(\'failReuqest\', \'处理返回值\', result); // 永远不会执行\n  }\n\n  async allReuqest() {\n    const result1 = await successRequest();\n    console.log(\'allReuqest\', \'处理返回值 success\', result1); // allReuqest 处理返回值 success a\n    const result2 = await failRequest();\n    console.log(\'allReuqest\', \'处理返回值 success\', result2); // 永远不会执行\n  }\n}\n\nconst action = new Action();\naction.successReuqest();\naction.failReuqest();\naction.allReuqest();\n\n// 程序崩溃\n// Uncaught (in promise) b\n// Uncaught (in promise) b`, `98526416856597530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">successRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token function-variable function">failRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Action</span> <span class="token punctuation">{</span>\n  <span class="token keyword">async</span> <span class="token function">successReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">successRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'successReuqest\'</span><span class="token punctuation">,</span> <span class="token string">\'处理返回值\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// successReuqest 处理返回值 a</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">async</span> <span class="token function">failReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">failRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'failReuqest\'</span><span class="token punctuation">,</span> <span class="token string">\'处理返回值\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">async</span> <span class="token function">allReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> result1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">successRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'allReuqest\'</span><span class="token punctuation">,</span> <span class="token string">\'处理返回值 success\'</span><span class="token punctuation">,</span> result1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// allReuqest 处理返回值 success a</span>\n    <span class="token keyword">const</span> result2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">failRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'allReuqest\'</span><span class="token punctuation">,</span> <span class="token string">\'处理返回值 success\'</span><span class="token punctuation">,</span> result2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> action <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Action</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\naction<span class="token punctuation">.</span><span class="token function">successReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\naction<span class="token punctuation">.</span><span class="token function">failReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\naction<span class="token punctuation">.</span><span class="token function">allReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 程序崩溃</span>\n<span class="token comment">// Uncaught (in promise) b</span>\n<span class="token comment">// Uncaught (in promise) b</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了防止程序崩溃，需要业务线在所有 async 函数中包裹 try catch。</p>\n<p>我们需要一种机制捕获 action 最顶层的错误进行统一处理。</p>\n<h1 id="业务场景-统一异常捕获"><a href="#%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF-%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E6%8D%95%E8%8E%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>业务场景 统一异常捕获</h1>\n<p>我们来编写类级别装饰器，专门捕获 async 函数抛出的异常：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83839416707565220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const asyncClass = (errorHandler?: (error?: Error) => void) => (target: any) => {\n  Object.getOwnPropertyNames(target.prototype).forEach((key) => {\n    const func = target.prototype[key];\n    target.prototype[key] = async (...args: any[]) => {\n      try {\n        await func.apply(this, args);\n      } catch (error) {\n        errorHandler && errorHandler(error);\n      }\n    };\n  });\n  return target;\n};`, `83839416707565220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">asyncClass</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">errorHandler<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token operator">?</span><span class="token punctuation">:</span> Error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">void</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> func <span class="token operator">=</span> target<span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    target<span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token punctuation">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">try</span> <span class="token punctuation">{</span>\n        <span class="token keyword">await</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        errorHandler <span class="token operator">&amp;&amp;</span> <span class="token function">errorHandler</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> target<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>将类所有方法都用 try catch 包裹住，将异常交给业务方统一的 errorHandler 处理：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37856454075236120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const successRequest = () => Promise.resolve(\'a\');\nconst failRequest = () => Promise.reject(\'b\');\n\nconst iAsyncClass = asyncClass((error) => {\n  console.log(\'统一异常处理\', error); // 统一异常处理 b\n});\n\n@iAsyncClass\nclass Action {\n  async successReuqest() {\n    const result = await successRequest();\n    console.log(\'successReuqest\', \'处理返回值\', result);\n  }\n\n  async failReuqest() {\n    const result = await failRequest();\n    console.log(\'failReuqest\', \'处理返回值\', result); // 永远不会执行\n  }\n\n  async allReuqest() {\n    const result1 = await successRequest();\n    console.log(\'allReuqest\', \'处理返回值 success\', result1);\n    const result2 = await failRequest();\n    console.log(\'allReuqest\', \'处理返回值 success\', result2); // 永远不会执行\n  }\n}\n\nconst action = new Action();\naction.successReuqest();\naction.failReuqest();\naction.allReuqest();`, `37856454075236120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">successRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token function-variable function">failRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> iAsyncClass <span class="token operator">=</span> <span class="token function">asyncClass</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'统一异常处理\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 统一异常处理 b</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n@iAsyncClass\n<span class="token keyword">class</span> <span class="token class-name">Action</span> <span class="token punctuation">{</span>\n  <span class="token keyword">async</span> <span class="token function">successReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">successRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'successReuqest\'</span><span class="token punctuation">,</span> <span class="token string">\'处理返回值\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">async</span> <span class="token function">failReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">failRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'failReuqest\'</span><span class="token punctuation">,</span> <span class="token string">\'处理返回值\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">async</span> <span class="token function">allReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> result1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">successRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'allReuqest\'</span><span class="token punctuation">,</span> <span class="token string">\'处理返回值 success\'</span><span class="token punctuation">,</span> result1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> result2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">failRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'allReuqest\'</span><span class="token punctuation">,</span> <span class="token string">\'处理返回值 success\'</span><span class="token punctuation">,</span> result2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> action <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Action</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\naction<span class="token punctuation">.</span><span class="token function">successReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\naction<span class="token punctuation">.</span><span class="token function">failReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\naction<span class="token punctuation">.</span><span class="token function">allReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们也可以编写方法级别的异常处理：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27021673275618243000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const asyncMethod = (errorHandler?: (error?: Error) => void) => (\n  target: any,\n  propertyKey: string,\n  descriptor: PropertyDescriptor\n) => {\n  const func = descriptor.value;\n  return {\n    get() {\n      return (...args: any[]) => {\n        return Promise.resolve(func.apply(this, args)).catch((error) => {\n          errorHandler && errorHandler(error);\n        });\n      };\n    },\n    set(newValue: any) {\n      return newValue;\n    }\n  };\n};`, `27021673275618243000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">asyncMethod</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">errorHandler<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token operator">?</span><span class="token punctuation">:</span> Error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">void</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>\n  <span class="token parameter">target<span class="token punctuation">:</span> any<span class="token punctuation">,</span>\n  propertyKey<span class="token punctuation">:</span> string<span class="token punctuation">,</span>\n  descriptor<span class="token punctuation">:</span> PropertyDescriptor</span>\n<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> func <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>value<span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token punctuation">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          errorHandler <span class="token operator">&amp;&amp;</span> <span class="token function">errorHandler</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token keyword">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">:</span> any<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> newValue<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>业务方用法类似，只是装饰器需要放在函数上：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51314745954685330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const successRequest = () => Promise.resolve(\'a\');\nconst failRequest = () => Promise.reject(\'b\');\n\nconst asyncAction = asyncMethod((error) => {\n  console.log(\'统一异常处理\', error); // 统一异常处理 b\n});\n\nclass Action {\n  @asyncAction async successReuqest() {\n    const result = await successRequest();\n    console.log(\'successReuqest\', \'处理返回值\', result);\n  }\n\n  @asyncAction async failReuqest() {\n    const result = await failRequest();\n    console.log(\'failReuqest\', \'处理返回值\', result); // 永远不会执行\n  }\n\n  @asyncAction async allReuqest() {\n    const result1 = await successRequest();\n    console.log(\'allReuqest\', \'处理返回值 success\', result1);\n    const result2 = await failRequest();\n    console.log(\'allReuqest\', \'处理返回值 success\', result2); // 永远不会执行\n  }\n}\n\nconst action = new Action();\naction.successReuqest();\naction.failReuqest();\naction.allReuqest();`, `51314745954685330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">successRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token function-variable function">failRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> asyncAction <span class="token operator">=</span> <span class="token function">asyncMethod</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'统一异常处理\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 统一异常处理 b</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Action</span> <span class="token punctuation">{</span>\n  @asyncAction <span class="token keyword">async</span> <span class="token function">successReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">successRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'successReuqest\'</span><span class="token punctuation">,</span> <span class="token string">\'处理返回值\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  @asyncAction <span class="token keyword">async</span> <span class="token function">failReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">failRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'failReuqest\'</span><span class="token punctuation">,</span> <span class="token string">\'处理返回值\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span>\n\n  @asyncAction <span class="token keyword">async</span> <span class="token function">allReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> result1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">successRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'allReuqest\'</span><span class="token punctuation">,</span> <span class="token string">\'处理返回值 success\'</span><span class="token punctuation">,</span> result1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> result2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">failRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'allReuqest\'</span><span class="token punctuation">,</span> <span class="token string">\'处理返回值 success\'</span><span class="token punctuation">,</span> result2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> action <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Action</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\naction<span class="token punctuation">.</span><span class="token function">successReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\naction<span class="token punctuation">.</span><span class="token function">failReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\naction<span class="token punctuation">.</span><span class="token function">allReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="业务场景-没有后顾之忧的主动权"><a href="#%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF-%E6%B2%A1%E6%9C%89%E5%90%8E%E9%A1%BE%E4%B9%8B%E5%BF%A7%E7%9A%84%E4%B8%BB%E5%8A%A8%E6%9D%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>业务场景 没有后顾之忧的主动权</h1>\n<p>在上面这种场景下，业务方是不用担心异常导致的 crash，因为所有异常都会在顶层统一捕获，可能表现为弹出一个提示框，告诉用户请求发送失败。</p>\n<p>业务方也不需要判断程序中是否存在异常，而战战兢兢的到处 try catch，因为程序中任何异常都会立刻终止函数的后续执行，不会再引发更恶劣的结果。</p>\n<blockquote>\n<p>像 golang 中异常处理方式，就存在这个问题通过 err, result := func() 的方式，虽然固定了第一个参数是错误信息，但下一行代码免不了要以 if error {…} 开头，整个程序的业务代码充斥着巨量的不必要错误处理，而大部分时候，我们还要为如何处理这些错误想的焦头烂额。</p>\n</blockquote>\n<p>而 js 异常冒泡的方式，在前端可以用提示框兜底，nodejs 端可以返回 500 错误兜底，并立刻中断后续请求代码，等于在所有危险代码身后加了一层隐藏的 return。</p>\n<p>同时业务方也握有绝对的主动权，比如登录失败后，如果账户不存在，那么直接跳转到注册页，而不是傻瓜的提示用户帐号不存在，可以这样做：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92677572963196910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`async login(nickname, password) {\n    try {\n        const user = await userService.login(nickname, password)\n        // 跳转到首页，登录失败后不会执行到这，所以不用担心用户看到奇怪的跳转\n    } catch (error) {\n        if (error.no === -1) {\n            // 跳转到登录页\n        } else {\n            throw Error(error) // 其他错误不想管，把球继续踢走\n        }\n    }\n}`, `92677572963196910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">async</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token parameter">nickname<span class="token punctuation">,</span> password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">try</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> userService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>nickname<span class="token punctuation">,</span> password<span class="token punctuation">)</span>\n        <span class="token comment">// 跳转到首页，登录失败后不会执行到这，所以不用担心用户看到奇怪的跳转</span>\n    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>no <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 跳转到登录页</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token comment">// 其他错误不想管，把球继续踢走</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="补充"><a href="#%E8%A1%A5%E5%85%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>补充</h1>\n<p>在 nodejs 端，记得监听全局错误，兜住落网之鱼：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71562252146415120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`process.on(\'uncaughtException\', (error: any) => {\n  logger.error(\'uncaughtException\', error);\n});\n\nprocess.on(\'unhandledRejection\', (error: any) => {\n  logger.error(\'unhandledRejection\', error);\n});`, `71562252146415120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'uncaughtException\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">\'uncaughtException\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nprocess<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'unhandledRejection\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">\'unhandledRejection\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在浏览器端，记得监听 window 全局错误，兜住漏网之鱼：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36829453371040000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`window.addEventListener(\'unhandledrejection\', (event: any) => {\n  logger.error(\'unhandledrejection\', event);\n});\nwindow.addEventListener(\'onrejectionhandled\', (event: any) => {\n  logger.error(\'onrejectionhandled\', event);\n});`, `36829453371040000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'unhandledrejection\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">\'unhandledrejection\'</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nwindow<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'onrejectionhandled\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">\'onrejectionhandled\'</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/异步异常处理的演进/index.md absPath of file >>> MarkdownRemark",timeToRead:7,frontmatter:{date:"2021-01-11 15:34:15",path:"/async-exception-throw-evolution/",tags:"前端, JS, 高级前端",title:"异步异常处理的演进",draft:null}},{excerpt:"示例 思路 对于这个简单的案例来说，如果我们把它用 generator 函数表达，会是怎么样的呢？ 我们知道，generator 函数是不会自动执行的，每一次调用它的 next 方法，会停留在下一个 yield 的位置。 利用这个特性，我们只要编写一个自动执行的函数，就可以让这个 generator 函数完全实现 async 函数的功能。 那么大体上的思路已经确定了，asyncToGenerator 接受一个 generator 函数，返回一个 promise， 关键就在于，里面用 yield…",html:'<h1 id="示例"><a href="#%E7%A4%BA%E4%BE%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>示例</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56980750427506940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const getData = () => new Promise((resolve) => setTimeout(() => resolve(\'data\'), 1000));\n\nasync function test() {\n  const data = await getData();\n  console.log(\'data: \', data);\n  const data2 = await getData();\n  console.log(\'data2: \', data2);\n  return \'success\';\n}\n\n// 这样的一个函数 应该再1秒后打印data 再过一秒打印data2 最后打印success\ntest().then((res) => console.log(res));`, `56980750427506940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">getData</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">\'data\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'data: \'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> data2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'data2: \'</span><span class="token punctuation">,</span> data2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token string">\'success\'</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 这样的一个函数 应该再1秒后打印data 再过一秒打印data2 最后打印success</span>\n<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="思路"><a href="#%E6%80%9D%E8%B7%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>思路</h1>\n<p>对于这个简单的案例来说，如果我们把它用 generator 函数表达，会是怎么样的呢？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96633413178412830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function* testG() {\n  // await被编译成了yield\n  const data = yield getData();\n  console.log(\'data: \', data);\n  const data2 = yield getData();\n  console.log(\'data2: \', data2);\n  return \'success\';\n}`, `96633413178412830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">testG</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// await被编译成了yield</span>\n  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'data: \'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> data2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'data2: \'</span><span class="token punctuation">,</span> data2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token string">\'success\'</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们知道，generator 函数是不会自动执行的，每一次调用它的 next 方法，会停留在下一个 yield 的位置。</p>\n<p>利用这个特性，我们只要编写一个自动执行的函数，就可以让这个 generator 函数完全实现 async 函数的功能。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26005379673161945000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const getData = () => new Promise((resolve) => setTimeout(() => resolve(\'data\'), 1000));\n\nvar test = asyncToGenerator(function* testG() {\n  // await被编译成了yield\n  const data = yield getData();\n  console.log(\'data: \', data);\n  const data2 = yield getData();\n  console.log(\'data2: \', data2);\n  return \'success\';\n});\n\ntest().then((res) => console.log(res));`, `26005379673161945000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">getData</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">\'data\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">var</span> test <span class="token operator">=</span> <span class="token function">asyncToGenerator</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">testG</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// await被编译成了yield</span>\n  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'data: \'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> data2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'data2: \'</span><span class="token punctuation">,</span> data2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token string">\'success\'</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>那么大体上的思路已经确定了，asyncToGenerator 接受一个 generator 函数，返回一个 promise，</p>\n<p>关键就在于，里面用 yield 来划分的异步流程，应该如何自动执行。</p>\n<h1 id="如果是手动执行"><a href="#%E5%A6%82%E6%9E%9C%E6%98%AF%E6%89%8B%E5%8A%A8%E6%89%A7%E8%A1%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如果是手动执行</h1>\n<p>在编写这个函数之前，我们先模拟手动去调用这个 generator 函数去一步步的把流程走完，有助于后面的思考。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27571880842362150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function* testG() {\n  // await被编译成了yield\n  const data = yield getData();\n  console.log(\'data: \', data);\n  const data2 = yield getData();\n  console.log(\'data2: \', data2);\n  return \'success\';\n}`, `27571880842362150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">testG</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// await被编译成了yield</span>\n  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'data: \'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> data2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'data2: \'</span><span class="token punctuation">,</span> data2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token string">\'success\'</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们先调用 testG 生成一个迭代器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45713620842495550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 返回了一个迭代器\nvar gen = testG();`, `45713620842495550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 返回了一个迭代器</span>\n<span class="token keyword">var</span> gen <span class="token operator">=</span> <span class="token function">testG</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>然后开始执行第一次 next</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89973845962345320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 第一次调用next 停留在第一个yield的位置\n// 返回的promise里 包含了data需要的数据\nvar dataPromise = gen.next();`, `89973845962345320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 第一次调用next 停留在第一个yield的位置</span>\n<span class="token comment">// 返回的promise里 包含了data需要的数据</span>\n<span class="token keyword">var</span> dataPromise <span class="token operator">=</span> gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这里返回了一个 promise，就是第一次 getData()所返回的 promise，注意</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53395415675280190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const data = yield getData()`, `53395415675280190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这段代码要切割成左右两部分来看，第一次调用 next，其实只是停留在了 yield getData()这里，data 的值并没有被确定。</p>\n<p>那么什么时候 data 的值会被确定呢？</p>\n<p>下一次调用 next 的时候，传的参数会被作为上一个 yield 前面接受的值，也就是说，我们再次调用 gen.next(‘这个参数才会被赋给 data 变量’)的时候，data 的值才会被确定为’这个参数才会被赋给 data 变量’</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62906336781521600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gen.next(\'这个参数才会被赋给data变量\')\n\n// 然后这里的data才有值\nconst data = yield getData()\n\n// 然后打印出data\nconsole.log(\'data: \', data);\n\n// 然后继续走到下一个yield\nconst data2 = yield getData()`, `62906336781521600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">\'这个参数才会被赋给data变量\'</span><span class="token punctuation">)</span>\n\n<span class="token comment">// 然后这里的data才有值</span>\n<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment">// 然后打印出data</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'data: \'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 然后继续走到下一个yield</span>\n<span class="token keyword">const</span> data2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后往下执行，直到遇到下一个 yield，继续这样的流程…</p>\n<p>这是 generator 函数设计的一个比较难理解的点，但是为了实现我们的目标，还是得去学习它~</p>\n<p>借助这个特性，如果我们这样去控制 yield 的流程，是不是就能实现异步串行了？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56465524603043350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function* testG() {\n  // await被编译成了yield\n  const data = yield getData();\n  console.log(\'data: \', data);\n  const data2 = yield getData();\n  console.log(\'data2: \', data2);\n  return \'success\';\n}\n\nvar gen = testG();\n\nvar dataPromise = gen.next();\n\ndataPromise.then((value1) => {\n  // data1的value被拿到了 继续调用next并且传递给data\n  var data2Promise = gen.next(value1);\n\n  // console.log(\'data: \', data);\n  // 此时就会打印出data\n\n  data2Promise.value.then((value2) => {\n    // data2的value拿到了 继续调用next并且传递value2\n    gen.next(value2);\n\n    // console.log(\'data2: \', data2);\n    // 此时就会打印出data2\n  });\n});`, `56465524603043350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">testG</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// await被编译成了yield</span>\n  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'data: \'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> data2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'data2: \'</span><span class="token punctuation">,</span> data2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token string">\'success\'</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">var</span> gen <span class="token operator">=</span> <span class="token function">testG</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">var</span> dataPromise <span class="token operator">=</span> gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ndataPromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value1</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// data1的value被拿到了 继续调用next并且传递给data</span>\n  <span class="token keyword">var</span> data2Promise <span class="token operator">=</span> gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>value1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// console.log(\'data: \', data);</span>\n  <span class="token comment">// 此时就会打印出data</span>\n\n  data2Promise<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// data2的value拿到了 继续调用next并且传递value2</span>\n    gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>value2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// console.log(\'data2: \', data2);</span>\n    <span class="token comment">// 此时就会打印出data2</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样的一个看着像 callback hell 的调用，就可以让我们的 generator 函数把异步安排的明明白白。</p>\n<h1 id="实现"><a href="#%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现</h1>\n<p>有了这样的思路，实现这个高阶函数就变得很简单了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64538911017664800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function asyncToGenerator(generatorFunc) {\n  // 返回的是一个新的函数\n  return function() {\n    // 先调用 generator 函数 生成迭代器\n    // 对应 var gen = testG()\n    const gen = generatorFunc.apply(this, arguments);\n\n    // 返回一个 promise 因为外部是用 .then 的方式 或者 await 的方式去使用这个函数的返回值的\n    // var test = asyncToGenerator(testG)\n    // test().then(res => console.log(res))\n    return new Promise((resolve, reject) => {\n      // 内部定义一个 step 函数，用来一步一步的跨过 yield 的阻碍\n      // key 有 next 和 throw 两种取值，分别对应了 gen 的 next 和 throw 方法\n      // arg 参数则是用来把 promise resolve 出来的值交给下一个 yield\n      function step(key, arg) {\n        let generatorResult;\n\n        // 这个方法需要包裹在 try catch 中\n        // 如果报错了 就把 promise 给 reject 掉 外部通过 .catch 可以获取到错误\n        try {\n          generatorResult = gen[key](arg);\n        } catch (error) {\n          return reject(error);\n        }\n\n        // gen.next() 得到的结果是一个 { value, done } 的结构\n        const { value, done } = generatorResult;\n\n        if (done) {\n          // 如果已经完成了，就直接 resolve 这个 promise\n          // 这个 done 是在最后一次调用 next 后才会为 true\n          // 以本文的例子来说，此时的结果是 { done: true, value: \'success\' }\n          // 这个 value 也就是 generator 函数最后的返回值\n          return resolve(value);\n        } else {\n          // 除了最后结束的时候外，每次调用 gen.next()\n          // 其实是返回 { value: Promise, done: false } 的结构\n          // 这里要注意的是 Promise.resolve 可以接受一个 promise 为参数\n          // 并且这个 promise 参数被 resolve 的时候，这个 then 才会被调用\n          return Promise.resolve(\n            // 这个 value 对应的是 yield 后面的 promise\n            value\n          ).then(\n            // value 这个 promise 被 resolve 的时候，就会执行 next\n            // 并且只要 done 不是 true 的时候，就会递归的往下解开 promise，对应\n            // gen.next().value.then(value => {\n            //    gen.next(value).value.then(value2 => {\n            //       gen.next()\n            //\n            //      // 此时 done 为 true 了，整个 promise 被 resolve 了\n            //      // 最外部的 test().then(res => console.log(res)) 的 then 就开始执行了\n            //    })\n            // })\n            function onResolve(val) {\n              step(\'next\', val);\n            },\n            // 如果 promise 被 reject 了，就再次进入 step 函数\n            // 不同的是，这次的 try catch 中调用的是 gen.throw(err)\n            // 那么自然就被 catch 到，然后把 promise 给 reject 掉啦\n            function onReject(err) {\n              step(\'throw\', err);\n            }\n          );\n        }\n      }\n      step(\'next\');\n    });\n  };\n}`, `64538911017664800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">asyncToGenerator</span><span class="token punctuation">(</span><span class="token parameter">generatorFunc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 返回的是一个新的函数</span>\n  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 先调用 generator 函数 生成迭代器</span>\n    <span class="token comment">// 对应 var gen = testG()</span>\n    <span class="token keyword">const</span> gen <span class="token operator">=</span> <span class="token function">generatorFunc</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 返回一个 promise 因为外部是用 .then 的方式 或者 await 的方式去使用这个函数的返回值的</span>\n    <span class="token comment">// var test = asyncToGenerator(testG)</span>\n    <span class="token comment">// test().then(res => console.log(res))</span>\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// 内部定义一个 step 函数，用来一步一步的跨过 yield 的阻碍</span>\n      <span class="token comment">// key 有 next 和 throw 两种取值，分别对应了 gen 的 next 和 throw 方法</span>\n      <span class="token comment">// arg 参数则是用来把 promise resolve 出来的值交给下一个 yield</span>\n      <span class="token keyword">function</span> <span class="token function">step</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">let</span> generatorResult<span class="token punctuation">;</span>\n\n        <span class="token comment">// 这个方法需要包裹在 try catch 中</span>\n        <span class="token comment">// 如果报错了 就把 promise 给 reject 掉 外部通过 .catch 可以获取到错误</span>\n        <span class="token keyword">try</span> <span class="token punctuation">{</span>\n          generatorResult <span class="token operator">=</span> gen<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token comment">// gen.next() 得到的结果是一个 { value, done } 的结构</span>\n        <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> generatorResult<span class="token punctuation">;</span>\n\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// 如果已经完成了，就直接 resolve 这个 promise</span>\n          <span class="token comment">// 这个 done 是在最后一次调用 next 后才会为 true</span>\n          <span class="token comment">// 以本文的例子来说，此时的结果是 { done: true, value: \'success\' }</span>\n          <span class="token comment">// 这个 value 也就是 generator 函数最后的返回值</span>\n          <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n          <span class="token comment">// 除了最后结束的时候外，每次调用 gen.next()</span>\n          <span class="token comment">// 其实是返回 { value: Promise, done: false } 的结构</span>\n          <span class="token comment">// 这里要注意的是 Promise.resolve 可以接受一个 promise 为参数</span>\n          <span class="token comment">// 并且这个 promise 参数被 resolve 的时候，这个 then 才会被调用</span>\n          <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>\n            <span class="token comment">// 这个 value 对应的是 yield 后面的 promise</span>\n            value\n          <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>\n            <span class="token comment">// value 这个 promise 被 resolve 的时候，就会执行 next</span>\n            <span class="token comment">// 并且只要 done 不是 true 的时候，就会递归的往下解开 promise，对应</span>\n            <span class="token comment">// gen.next().value.then(value => {</span>\n            <span class="token comment">//    gen.next(value).value.then(value2 => {</span>\n            <span class="token comment">//       gen.next()</span>\n            <span class="token comment">//</span>\n            <span class="token comment">//      // 此时 done 为 true 了，整个 promise 被 resolve 了</span>\n            <span class="token comment">//      // 最外部的 test().then(res => console.log(res)) 的 then 就开始执行了</span>\n            <span class="token comment">//    })</span>\n            <span class="token comment">// })</span>\n            <span class="token keyword">function</span> <span class="token function">onResolve</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n              <span class="token function">step</span><span class="token punctuation">(</span><span class="token string">\'next\'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token comment">// 如果 promise 被 reject 了，就再次进入 step 函数</span>\n            <span class="token comment">// 不同的是，这次的 try catch 中调用的是 gen.throw(err)</span>\n            <span class="token comment">// 那么自然就被 catch 到，然后把 promise 给 reject 掉啦</span>\n            <span class="token keyword">function</span> <span class="token function">onReject</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n              <span class="token function">step</span><span class="token punctuation">(</span><span class="token string">\'throw\'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n      <span class="token function">step</span><span class="token punctuation">(</span><span class="token string">\'next\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/手写async await的最简实现/index.md absPath of file >>> MarkdownRemark",timeToRead:3,frontmatter:{date:"2021-01-10 11:30:16",path:"/async-await-simplest-implementation/",tags:"前端, JS, 高级前端",title:"手写 async await 的最简实现",draft:null}}],length:32,tag:"JS",pagesSum:7,page:1}}}});