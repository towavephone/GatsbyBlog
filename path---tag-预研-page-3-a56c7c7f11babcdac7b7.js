webpackJsonp([0x7eeb019129cb],{1651:function(n,s){n.exports={data:{site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}}},pathContext:{posts:[{excerpt:"架构 选型背景 搭建一个便于 SEO 的官网 技术栈团队成员熟悉，开发方便 提到 SEO，主流的渲染方式都是 SSR 框架选型 详见  http://doc.ssr-fc.com/docs/features$technology 支持常见的流行前端框架 React/Vue2/Vue3，这里只列举 React 的 特性 前端框架: React v17, 实时跟进 React17 的新特性 开发语言: TypeScript 代码风格(可选): 默认 eslint-config-standard…",html:'<h1 id="架构"><a href="#%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>架构</h1>\n<h2 id="选型背景"><a href="#%E9%80%89%E5%9E%8B%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型背景</h2>\n<ol>\n<li>搭建一个便于 SEO 的官网</li>\n<li>技术栈团队成员熟悉，开发方便</li>\n</ol>\n<p>提到 SEO，主流的渲染方式都是 SSR</p>\n<h2 id="框架选型"><a href="#%E6%A1%86%E6%9E%B6%E9%80%89%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>框架选型</h2>\n<p>详见 <a href="http://doc.ssr-fc.com/docs/features$technology" target="_blank" rel="nofollow noreferrer noopener">http://doc.ssr-fc.com/docs/features$technology</a></p>\n<p>支持常见的流行前端框架 React/Vue2/Vue3，这里只列举 React 的</p>\n<h3 id="特性"><a href="#%E7%89%B9%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>特性</h3>\n<ul>\n<li>前端框架: React v17, 实时跟进 React17 的新特性</li>\n<li>开发语言: TypeScript</li>\n<li>代码风格(可选): 默认 eslint-config-standard-react-ts</li>\n<li>样式处理: less + css modules(根据后缀名自动识别 .module.less 文件使用 css-modules)</li>\n<li>UI 组件: 默认已对 antd 的使用做打包配置无需额外配置</li>\n<li>前端路由: 约定式路由/声明式路由</li>\n<li>数据管理: 使用 Hooks 提供的 useContext 实现极简的跨组件通信方案, 摒弃传统的 redux/dva 等数据管理方案</li>\n<li>构建工具: Webpack/Vite</li>\n</ul>\n<h3 id="优点"><a href="#%E4%BC%98%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优点</h3>\n<ol>\n<li>\n<p>支持三种渲染模式</p>\n<p>支持服务端渲染与客户端渲染两种模式任意切换。随时安全降级。同时支持生成 html 文件独立部署也是同类型框架中唯一同时实现了三种功能的方案</p>\n</li>\n<li>\n<p>同时支持 Vite/Webpack</p>\n</li>\n<li>\n<p>轻量的数据管理方案（userContext + useReducer）</p>\n</li>\n<li>\n<p>支持约定式路由和声明式路由</p>\n</li>\n<li>\n<p>支持 antd 等流行框架（兼容 ssr）</p>\n</li>\n<li>\n<p>支持 midway，接口开发方便</p>\n</li>\n</ol>\n<h3 id="缺点"><a href="#%E7%BC%BA%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缺点</h3>\n<ol>\n<li>有些三方库并不支持 ssr，大多数时候需要改源码</li>\n<li>开发模式下采用 webpack 多次编译后会内存溢出</li>\n<li>文件较多时 webpack 编译速度较慢</li>\n</ol>\n<h3 id="优化方向"><a href="#%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化方向</h3>\n<ol>\n<li>astro 孤岛架构，每个部分都可以延迟加载</li>\n<li>remix 的并行加载、预加载</li>\n<li><a href="https://github.com/ascoders/weekly/blob/master/%E5%89%8D%E6%B2%BF%E6%8A%80%E6%9C%AF/54.%E7%B2%BE%E8%AF%BB%E3%80%8A%E5%9C%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E8%BF%90%E8%A1%8C%20serverRender%E3%80%8B.md" target="_blank" rel="nofollow noreferrer noopener">前端 ssr</a>，预渲染，设置合理缓存，减少服务器压力</li>\n<li>service worker 缓存</li>\n</ol>\n<h2 id="目录介绍"><a href="#%E7%9B%AE%E5%BD%95%E4%BB%8B%E7%BB%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>目录介绍</h2>\n<p>详见 <a href="http://doc.ssr-fc.com/docs/features$structure" target="_blank" rel="nofollow noreferrer noopener">http://doc.ssr-fc.com/docs/features$structure</a></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75663771907246030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`.\n├── build # web 目录构建产物，与 public 文件夹一样会设置为静态资源文件夹，非应用构建产物静态资源文件如图片/字体等资源建议放在 public 文件夹前端代码通过绝对路径引入\n│   ├── client # 存放前端静态资源文件\n│   └── server # 存放 external 后的服务端 bundle\n├── public # 作为静态资源目录存放静态资源文件\n├── config.js # 定义应用的配置 (框架层面使用，生产环境需要)\n├── config.prod.js # (可选) 若存在则视为生产环境的应用配置\n├── f.yml # (可选)，仅在 Serverless 场景下使用，若调用 ssr deploy 检测到无此文件会自动创建\n├── package.json\n├── src # 存放服务端 Node.js 相关代码\n│   └── index.ts\n├── tsconfig.json # 服务端 Node.js 编译配置文件\n├── typings # 存放前后端公共类型文件\n├── web # 存放前端组件相关代码\n│   ├── components # 存放公共组件\n│   │   └── header # 公共头部\n│   │   │   ├── index.less\n│   │   │   └── index.tsx\n│   │   └── layout # 页面 html 布局\n│   │       └── index.tsx # 页面 html 布局，仅在服务端被渲染\n│   │       └── App.tsx # 页面具体的组件内容，用于初始化公共配置\n│   │       └── fetch.ts # layout 级别的 fetch，用于获取所有页面的公共数据，将会在每一个页面级别的 fetch 调用之前调用\n│   ├── pages # pages 目录下的文件夹会映射为前端路由表，存放页面级别的组件\n│   │   ├── index # index文件夹映射为根路由 /index => /\n│   │   │   ├── fetch.ts # 定义 fetch 文件用来统一服务端/客户端获取数据的方式，通过 __isBrowser__ 变量区分环境，会在首页服务端渲染以及前端路由切换时被调用\n│   │   │   ├── index.less\n│   │   │   └── render.tsx # 定义 render 文件用来定义页面渲染逻辑\n│   │   └── detail\n│   │   │   ├── fetch.ts\n│   │   │   ├── index.less\n│   │   │   └── render\\$id.tsx # 映射为 /detail/:id\n│   │   │   └── user\n│   │   │        ├── fetch.ts\n│   │   │        └── render\\$id.tsx # 多级路由按照规则映射为 /detail/user/:id\n│   │   │        └── render\\$user\\$id.tsx # 多参数路由映射为 /detail/user/:user/:id\n│   │   ├── bar\n│   │   │   ├── fetch.ts\n│   │   │   └── render.tsx\n│   │   │   ├── fetch\\$id.ts\n│   │   │   └── render\\$id.tsx # 当存在多个 render 类型的文件时，每个 render 文件对应与其同名的 fetch 文件，例如 render\\$id 对应 fetch\\$id\n│   ├── tsconfig.json # web 目录下的 tsconfig 仅用于编辑器 ts 语法检测`, `75663771907246030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">.\n├── build # web 目录构建产物，与 public 文件夹一样会设置为静态资源文件夹，非应用构建产物静态资源文件如图片/字体等资源建议放在 public 文件夹前端代码通过绝对路径引入\n│   ├── client # 存放前端静态资源文件\n│   └── server # 存放 external 后的服务端 bundle\n├── public # 作为静态资源目录存放静态资源文件\n├── config.js # 定义应用的配置 (框架层面使用，生产环境需要)\n├── config.prod.js # (可选) 若存在则视为生产环境的应用配置\n├── f.yml # (可选)，仅在 Serverless 场景下使用，若调用 ssr deploy 检测到无此文件会自动创建\n├── package.json\n├── src # 存放服务端 Node.js 相关代码\n│   └── index.ts\n├── tsconfig.json # 服务端 Node.js 编译配置文件\n├── typings # 存放前后端公共类型文件\n├── web # 存放前端组件相关代码\n│   ├── components # 存放公共组件\n│   │   └── header # 公共头部\n│   │   │   ├── index.less\n│   │   │   └── index.tsx\n│   │   └── layout # 页面 html 布局\n│   │       └── index.tsx # 页面 html 布局，仅在服务端被渲染\n│   │       └── App.tsx # 页面具体的组件内容，用于初始化公共配置\n│   │       └── fetch.ts # layout 级别的 fetch，用于获取所有页面的公共数据，将会在每一个页面级别的 fetch 调用之前调用\n│   ├── pages # pages 目录下的文件夹会映射为前端路由表，存放页面级别的组件\n│   │   ├── index # index文件夹映射为根路由 /index =&gt; /\n│   │   │   ├── fetch.ts # 定义 fetch 文件用来统一服务端/客户端获取数据的方式，通过 __isBrowser__ 变量区分环境，会在首页服务端渲染以及前端路由切换时被调用\n│   │   │   ├── index.less\n│   │   │   └── render.tsx # 定义 render 文件用来定义页面渲染逻辑\n│   │   └── detail\n│   │   │   ├── fetch.ts\n│   │   │   ├── index.less\n│   │   │   └── render$id.tsx # 映射为 /detail/:id\n│   │   │   └── user\n│   │   │        ├── fetch.ts\n│   │   │        └── render$id.tsx # 多级路由按照规则映射为 /detail/user/:id\n│   │   │        └── render$user$id.tsx # 多参数路由映射为 /detail/user/:user/:id\n│   │   ├── bar\n│   │   │   ├── fetch.ts\n│   │   │   └── render.tsx\n│   │   │   ├── fetch$id.ts\n│   │   │   └── render$id.tsx # 当存在多个 render 类型的文件时，每个 render 文件对应与其同名的 fetch 文件，例如 render$id 对应 fetch$id\n│   ├── tsconfig.json # web 目录下的 tsconfig 仅用于编辑器 ts 语法检测</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="核心"><a href="#%E6%A0%B8%E5%BF%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心</h1>\n<h2 id="多语言"><a href="#%E5%A4%9A%E8%AF%AD%E8%A8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多语言</h2>\n<p>采用 react-i18next 适配多语言，支持解析多文件夹，携带路径前缀等特性</p>\n<h3 id="文件目录"><a href="#%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>文件目录</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34035768210676820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`locales\n   lang\n      da-DK\n      en-US\n      nb-NO\n      nl-NL\n      sv-SE\ni18n.ts`, `34035768210676820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">locales\n   lang\n      da-DK\n      en-US\n      nb-NO\n      nl-NL\n      sv-SE\ni18n.ts</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="使用方式"><a href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用方式</h3>\n<p>比如 locales/lang/da-DK/g3i/car-text.ts 下配置：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37578955502925780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export default {\n   withPathPrefix: true,\n   withFilePrefix: true,\n   title: \'123456\'\n};`, `37578955502925780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>\n   withPathPrefix<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n   withFilePrefix<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n   title<span class="token punctuation">:</span> <span class="token string">\'123456\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>此时拿到的 title 的 key 为 <code class="language-text">g3I.carText.title</code>, 是哪个国家根据后端拿到的 language 字符判断</p>\n<p>使用时代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60772349435087560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const { t } = useTranslation();\nconst getValue = (param: string) => t(\\`g3I.carText.\\${param}\\`);`, `60772349435087560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">const</span> <span class="token punctuation">{</span> t <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTranslation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">param<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">g3I.carText.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>param<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="核心代码"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<p>进入通用组件，切换语言</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10061679512612987000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`initLanguage(state?.language).catch()\nconst { i18n } = useTranslation()\nuseEffect(() => {\n   state?.language && i18n.changeLanguage(state.language)\n   // eslint-disable-next-line react-hooks/exhaustive-deps\n}, [state?.language])`, `10061679512612987000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token function">initLanguage</span><span class="token punctuation">(</span>state<span class="token operator">?</span><span class="token punctuation">.</span>language<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> i18n <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTranslation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   state<span class="token operator">?</span><span class="token punctuation">.</span>language <span class="token operator">&amp;&amp;</span> i18n<span class="token punctuation">.</span><span class="token function">changeLanguage</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>language<span class="token punctuation">)</span>\n   <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>state<span class="token operator">?</span><span class="token punctuation">.</span>language<span class="token punctuation">]</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>读取文件夹下语言配置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73630609845969450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import i18n, { Resource } from \'i18next\';\nimport { initReactI18next } from \'react-i18next\';\nimport { DEFAULT_LANGUAGE } from \'@/constants\';\nimport path from \'path\';\nimport { camelCase } from \'lodash\';\n\nconst moduleFiles = require.context(\'./lang\', true, /\\.ts\\$/);\n\nconst resources: Resource = {};\n\nmoduleFiles.keys().forEach((item: string) => {\n   const dirname = path.dirname(item);\n   // 取路径里面的第一个目录\n   const keys = dirname.split(\'/\').filter((item) => item && item !== \'.\');\n   const [key, ...restKey] = keys;\n   if (key) {\n      let value = moduleFiles(item).default || moduleFiles(item);\n      const pathPrefix = [];\n      // 是否携带路径前缀\n      if (value.withPathPrefix) {\n         pathPrefix.push(...restKey);\n      }\n\n      // 是否携带文件前缀\n      if (value.withFilePrefix) {\n         const basename = path.basename(item, \'.ts\');\n         pathPrefix.push(basename);\n      }\n\n      if (pathPrefix.length > 0) {\n         const newValue: { [key: string]: any } = {};\n         const newPathPrefix = pathPrefix.map(camelCase).join(\'.\');\n         Object.keys(value).forEach((key2) => {\n            newValue[\\`\\${newPathPrefix}.\\${key2}\\`] = value[key2];\n         });\n         value = newValue;\n      }\n\n      if (resources[key]) {\n         resources[key].translation = {\n            ...(resources[key].translation as {}),\n            ...value\n         };\n      } else {\n         resources[key] = {\n            translation: value\n         };\n      }\n   }\n});\n\nexport const initLanguage = async function(language: string = DEFAULT_LANGUAGE) {\n   if (i18n.isInitialized) {\n      if (language !== i18n.language) {\n         await i18n.changeLanguage(language);\n      }\n      return;\n   }\n   return await i18n\n      .use(initReactI18next) // passes i18n down to react-i18next\n      .init({\n         resources,\n         debug: process.env.NODE_ENV === \'development\',\n         lng: language,\n         keySeparator: false, // we do not use keys in form messages.welcome\n         interpolation: {\n            escapeValue: false\n         }\n         // 不能使用数组或对象，因为需要用户去填字符串\n         // returnObjects: true\n      })\n      .catch((error) => {\n         console.info(\'initReactI18next error:\', error);\n      });\n};`, `73630609845969450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">import</span> i18n<span class="token punctuation">,</span> <span class="token punctuation">{</span> Resource <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'i18next\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> initReactI18next <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-i18next\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">DEFAULT_LANGUAGE</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/constants\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">\'path\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> camelCase <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> moduleFiles <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">\'./lang\'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token regex">/\\.ts$/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> resources<span class="token punctuation">:</span> Resource <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\nmoduleFiles<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 取路径里面的第一个目录</span>\n   <span class="token keyword">const</span> keys <span class="token operator">=</span> dirname<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item <span class="token operator">&amp;&amp;</span> item <span class="token operator">!==</span> <span class="token string">\'.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> <span class="token operator">...</span>restKey<span class="token punctuation">]</span> <span class="token operator">=</span> keys<span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token function">moduleFiles</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span> <span class="token operator">||</span> <span class="token function">moduleFiles</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> pathPrefix <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token comment">// 是否携带路径前缀</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>withPathPrefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         pathPrefix<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>restKey<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// 是否携带文件前缀</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>withFilePrefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> basename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'.ts\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         pathPrefix<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>basename<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>pathPrefix<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> newValue<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token builtin">any</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n         <span class="token keyword">const</span> newPathPrefix <span class="token operator">=</span> pathPrefix<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>camelCase<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            newValue<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>newPathPrefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key2<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">[</span>key2<span class="token punctuation">]</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         value <span class="token operator">=</span> newValue<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>resources<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         resources<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>translation <span class="token operator">=</span> <span class="token punctuation">{</span>\n            <span class="token operator">...</span><span class="token punctuation">(</span>resources<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>translation <span class="token keyword">as</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            <span class="token operator">...</span>value\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         resources<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n            translation<span class="token punctuation">:</span> value\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">initLanguage</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">language<span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token constant">DEFAULT_LANGUAGE</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>i18n<span class="token punctuation">.</span>isInitialized<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>language <span class="token operator">!==</span> i18n<span class="token punctuation">.</span>language<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">await</span> i18n<span class="token punctuation">.</span><span class="token function">changeLanguage</span><span class="token punctuation">(</span>language<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">return</span> <span class="token keyword">await</span> i18n\n      <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>initReactI18next<span class="token punctuation">)</span> <span class="token comment">// passes i18n down to react-i18next</span>\n      <span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n         resources<span class="token punctuation">,</span>\n         debug<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">\'development\'</span><span class="token punctuation">,</span>\n         lng<span class="token punctuation">:</span> language<span class="token punctuation">,</span>\n         keySeparator<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// we do not use keys in form messages.welcome</span>\n         interpolation<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            escapeValue<span class="token punctuation">:</span> <span class="token boolean">false</span>\n         <span class="token punctuation">}</span>\n         <span class="token comment">// 不能使用数组或对象，因为需要用户去填字符串</span>\n         <span class="token comment">// returnObjects: true</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">\'initReactI18next error:\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="优化方向-1"><a href="#%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化方向</h3>\n<ol>\n<li>改造成 history.push 的跳转时切换多语言未生效</li>\n<li>不支持热加载，需重新刷新后才会生效</li>\n<li>多语言配置到后台，直接从后台读</li>\n</ol>\n<h2 id="动效"><a href="#%E5%8A%A8%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>动效</h2>\n<p><a href="https://lgst5rvnj2.feishu.cn/sheets/shtcnqVzHsbC1nnHIWrmlmssiVc?table=tblUDHlEq3ZXvNm4&#x26;view=vewUNrsVAJ&#x26;sheet=q7FBB0" target="_blank" rel="nofollow noreferrer noopener">动效一览</a></p>\n<ol>\n<li>react-spring（触发型动效）</li>\n<li>react-gsap（触发型动效，受控型动效）</li>\n<li>react-scrollmagic（页面停留组件）</li>\n<li>图片序列帧</li>\n</ol>\n<h3 id="触发型动效"><a href="#%E8%A7%A6%E5%8F%91%E5%9E%8B%E5%8A%A8%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>触发型动效</h3>\n<ol>\n<li>位移 + 数字跳动（react-spring）</li>\n<li>文字从上到下逐渐显示、p7-wing 鹏翼门的放大缩小（react-gsap）</li>\n</ol>\n<p>示例页面：<a href="https://www.heyxpeng.com/p7" target="_blank" rel="nofollow noreferrer noopener">https://www.heyxpeng.com/p7</a></p>\n<h3 id="受控型动效"><a href="#%E5%8F%97%E6%8E%A7%E5%9E%8B%E5%8A%A8%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>受控型动效</h3>\n<ol>\n<li>受控的图片序列帧的播放（canvas 实现的视频播放器，jsmpeg，react-gsap + jsmpeg）</li>\n<li>播放镂空文字（react-gsap + mix-blend-mode）</li>\n</ol>\n<p>示例页面：<a href="https://www.heyxpeng.com/p7" target="_blank" rel="nofollow noreferrer noopener">https://www.heyxpeng.com/p7</a></p>\n<h3 id="优化方向-2"><a href="#%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化方向</h3>\n<ol>\n<li>图片序列帧的性能优化，目前方案在有些机器上帧率过低（采用图片序列帧 + avif）</li>\n<li>在页面滚动过快时，react-gsap 执行不完全</li>\n</ol>\n<h2 id="多端适配"><a href="#%E5%A4%9A%E7%AB%AF%E9%80%82%E9%85%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多端适配</h2>\n<h3 id="方案"><a href="#%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方案</h3>\n<p>采用 @our-patches/postcss-px-to-viewport 插件</p>\n<ol>\n<li>PC 端根据 1920 px 的设计稿宽度直接转换成 rem 单位，再由 css 多媒体查询去控制</li>\n<li>h5 端直接使用 vw 单位</li>\n</ol>\n<h3 id="核心代码-1"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<p>配置代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32100973010465460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n   plugins: [\n      [\n         \'@our-patches/postcss-px-to-viewport\',\n         {\n            // https://github.com/evrone/postcss-px-to-viewport/blob/master/README_CN.md\n            unitToConvert: \'px\', // 需要转换的单位，默认为&quot;px&quot;\n            viewportWidth: 1920, // 视窗的宽度，对应设计稿的宽度\n            unitPrecision: 8, // 指定 px 转换为视窗单位值的小数后 x 位数，转换精度尽可能的大，防止出现图片比例问题\n            viewportUnit: \'rem\', // 希望使用的视口单位\n            fontViewportUnit: \'rem\', // 字体使用的视口单位,\n            minPixelValue: 1, // 最小的转换数值\n            mediaQuery: true, // 媒体查询里的单位是否需要转换单位\n            selectorBlackList: [/^html\\$/, \'hack\'],\n            exclude: /node_modules/,\n            include: [/(\\\\|\\/)web(\\\\|\\/)/]\n         }\n      ],\n      // 此插件主要修复了移动端 100vh 的高度（即减去搜索框的高度）\n      // 效果：https://codepen.io/team/css-tricks/full/vapjge\n      // https://css-tricks.com/the-trick-to-viewport-units-on-mobile/\n      \'postcss-viewport-height-correction\'\n   ]\n};`, `32100973010465460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token punctuation">[</span>\n         <span class="token string">\'@our-patches/postcss-px-to-viewport\'</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            <span class="token comment">// https://github.com/evrone/postcss-px-to-viewport/blob/master/README_CN.md</span>\n            unitToConvert<span class="token punctuation">:</span> <span class="token string">\'px\'</span><span class="token punctuation">,</span> <span class="token comment">// 需要转换的单位，默认为"px"</span>\n            viewportWidth<span class="token punctuation">:</span> <span class="token number">1920</span><span class="token punctuation">,</span> <span class="token comment">// 视窗的宽度，对应设计稿的宽度</span>\n            unitPrecision<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token comment">// 指定 px 转换为视窗单位值的小数后 x 位数，转换精度尽可能的大，防止出现图片比例问题</span>\n            viewportUnit<span class="token punctuation">:</span> <span class="token string">\'rem\'</span><span class="token punctuation">,</span> <span class="token comment">// 希望使用的视口单位</span>\n            fontViewportUnit<span class="token punctuation">:</span> <span class="token string">\'rem\'</span><span class="token punctuation">,</span> <span class="token comment">// 字体使用的视口单位,</span>\n            minPixelValue<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 最小的转换数值</span>\n            mediaQuery<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 媒体查询里的单位是否需要转换单位</span>\n            selectorBlackList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token regex">/^html$/</span><span class="token punctuation">,</span> <span class="token string">\'hack\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            exclude<span class="token punctuation">:</span> <span class="token regex">/node_modules/</span><span class="token punctuation">,</span>\n            include<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token regex">/(\\\\|\\/)web(\\\\|\\/)/</span><span class="token punctuation">]</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span><span class="token punctuation">,</span>\n      <span class="token comment">// 此插件主要修复了移动端 100vh 的高度（即减去搜索框的高度）</span>\n      <span class="token comment">// 效果：https://codepen.io/team/css-tricks/full/vapjge</span>\n      <span class="token comment">// https://css-tricks.com/the-trick-to-viewport-units-on-mobile/</span>\n      <span class="token string">\'postcss-viewport-height-correction\'</span>\n   <span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67362738752629520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@media screen and (min-width: 2560px) and (max-width: 5119px) {\n   html {\n      font-size: 22.26px;\n   }\n}\n\n@media screen and (min-width: 2388px) and (max-width: 2559px) {\n   html {\n      font-size: 21.15px;\n   }\n}\n\n/* ... */`, `67362738752629520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="css"\n              >\n                <span class="gatsby-code-button-language">css</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token atrule"><span class="token rule">@media</span> screen and <span class="token punctuation">(</span><span class="token property">min-width</span><span class="token punctuation">:</span> 2560px<span class="token punctuation">)</span> and <span class="token punctuation">(</span><span class="token property">max-width</span><span class="token punctuation">:</span> 5119px<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>\n   <span class="token selector">html</span> <span class="token punctuation">{</span>\n      <span class="token property">font-size</span><span class="token punctuation">:</span> 22.26px<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token atrule"><span class="token rule">@media</span> screen and <span class="token punctuation">(</span><span class="token property">min-width</span><span class="token punctuation">:</span> 2388px<span class="token punctuation">)</span> and <span class="token punctuation">(</span><span class="token property">max-width</span><span class="token punctuation">:</span> 2559px<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>\n   <span class="token selector">html</span> <span class="token punctuation">{</span>\n      <span class="token property">font-size</span><span class="token punctuation">:</span> 21.15px<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">/* ... */</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="优化方向-3"><a href="#%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化方向</h3>\n<ol>\n<li>\n<p>所有端都使用 rem 单位，便于控制</p>\n</li>\n<li>\n<p>适配 ipad 端</p>\n</li>\n<li>\n<p>使用以下语法，保证适配的合理性</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19292027043794113000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@media screen and (min-width: 375px) {\n  html {\n     /* 375 宽度使用 16px 的基准尺寸，414 宽度时字号大小为 18px */\n     font-size: calc(16px + 2 * (100vw - 375px) / 39);\n  }\n}`, `19292027043794113000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="css"\n              >\n                <span class="gatsby-code-button-language">css</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token atrule"><span class="token rule">@media</span> screen and <span class="token punctuation">(</span><span class="token property">min-width</span><span class="token punctuation">:</span> 375px<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>\n  <span class="token selector">html</span> <span class="token punctuation">{</span>\n     <span class="token comment">/* 375 宽度使用 16px 的基准尺寸，414 宽度时字号大小为 18px */</span>\n     <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token function">calc</span><span class="token punctuation">(</span>16px + 2 * <span class="token punctuation">(</span>100vw - 375px<span class="token punctuation">)</span> / 39<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<h2 id="懒加载"><a href="#%E6%87%92%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>懒加载</h2>\n<p>lazyLoader 通用组件使用 vanilla-lazyload，对 video、img、div 的懒加载封装</p>\n<p><a href="https://lgst5rvnj2.feishu.cn/sheets/shtcnqVzHsbC1nnHIWrmlmssiVc?table=tbldGkkqr5yse2oT&#x26;view=vew1FvZJiF&#x26;sheet=j9pMmo" target="_blank" rel="nofollow noreferrer noopener">文档</a></p>\n<h3 id="优化方向-4"><a href="#%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化方向</h3>\n<ol>\n<li>预加载</li>\n<li>组件级别的懒加载、预加载</li>\n</ol>\n<h2 id="视频压缩"><a href="#%E8%A7%86%E9%A2%91%E5%8E%8B%E7%BC%A9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>视频压缩</h2>\n<h3 id="背景"><a href="#%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景</h3>\n<p>需要对视频进行压缩，图片序列帧进行格式转换，支持多文件、并行压缩</p>\n<h3 id="核心代码-2"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<p>scripts/compress.mjs</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85848689385095270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/usr/bin/env zx\nconst { get } = require(\'lodash\');\n\nconst compressConfig = require(\'../compress.config\');\nconst concurrentRun = require(\'./concurrentRun\');\n\n// 关闭日志输出\n\\$.verbose = false;\n\nconst FILE_SUFFIX = \'mp4\';\nconst TMP_FILE_SUFFIX = \'.bak.mp4\';\n\nconst delFiles = await globby(\\`public/**/*\\${TMP_FILE_SUFFIX}\\`);\n\nawait \\$\\`rm -rf \\${delFiles}\\`;\n\nlet files = [];\n\nconst params = argv._.slice(1);\nif (params.length > 0) {\n   files = params.filter((item) => /mp4\\$/.test(item));\n} else {\n   files = await globby(\\`public/**/*.\\${FILE_SUFFIX}\\`);\n}\n\nconsole.log(\\`开始压缩 \\${FILE_SUFFIX}\\`);\n\n// https://github.com/google/zx/issues/126\n\\$.noquote = async (...args) => {\n   const q = \\$.quote;\n   \\$.quote = (v) => v;\n   const p = \\$(...args);\n   await p;\n   \\$.quote = q;\n   return p;\n};\n\nconst transformToMpeg = async (bashFunc, file) => {\n   await \\$.noquote\\`\\${bashFunc(file, file.replace(/mp4\\$/, \'mpeg\'))}\\`;\n   // await \\$\\`rm -rf \\${file}\\`\n};\n\nconst transformToMp4 = async (bashFunc, file) => {\n   await \\$.noquote\\`\\${bashFunc(file, file + TMP_FILE_SUFFIX)}\\`;\n   await \\$\\`rm -rf \\${file}\\`;\n   await \\$\\`mv \\${file}\\${TMP_FILE_SUFFIX} \\${file}\\`;\n   await \\$\\`rm -rf \\${file}\\${TMP_FILE_SUFFIX}\\`;\n};\n\nconst funcArray = [\n   {\n      path: \'mpeg.4\',\n      func: transformToMpeg\n   },\n   {\n      path: \'mp4.hasAudio\',\n      func: transformToMp4\n   },\n   {\n      path: \'mp4\',\n      func: transformToMp4\n   }\n];\n\nawait concurrentRun(\n   files.map((file) => async () => {\n      for (let i = 0; i < funcArray.length; i++) {\n         const item = funcArray[i];\n         const { bashFunc, files } = get(compressConfig.mp4, item.path);\n         // files 未定义或者包含 file\n         if (!files || files.includes(file)) {\n            await item.func(bashFunc, file);\n            return Promise.resolve();\n         }\n      }\n      return Promise.resolve();\n   })\n);\n\nconsole.log(\\`共 \\${files.length} 个 \\${FILE_SUFFIX} 压缩完成\\`);`, `85848689385095270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env zx\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> compressConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../compress.config\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> concurrentRun <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./concurrentRun\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 关闭日志输出</span>\n$<span class="token punctuation">.</span>verbose <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">FILE_SUFFIX</span> <span class="token operator">=</span> <span class="token string">\'mp4\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token constant">TMP_FILE_SUFFIX</span> <span class="token operator">=</span> <span class="token string">\'.bak.mp4\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> delFiles <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">globby</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">public/**/*</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">TMP_FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rm -rf </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>delFiles<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> params <span class="token operator">=</span> argv<span class="token punctuation">.</span>_<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   files <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token regex">/mp4$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n   files <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">globby</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">public/**/*.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">开始压缩 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// https://github.com/google/zx/issues/126</span>\n$<span class="token punctuation">.</span><span class="token function-variable function">noquote</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> q <span class="token operator">=</span> $<span class="token punctuation">.</span>quote<span class="token punctuation">;</span>\n   $<span class="token punctuation">.</span><span class="token function-variable function">quote</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=></span> v<span class="token punctuation">;</span>\n   <span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">await</span> p<span class="token punctuation">;</span>\n   $<span class="token punctuation">.</span>quote <span class="token operator">=</span> q<span class="token punctuation">;</span>\n   <span class="token keyword">return</span> p<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">transformToMpeg</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">bashFunc<span class="token punctuation">,</span> file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">await</span> $<span class="token punctuation">.</span>noquote<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">bashFunc</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/mp4$/</span><span class="token punctuation">,</span> <span class="token string">\'mpeg\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n   <span class="token comment">// await $`rm -rf ${file}`</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">transformToMp4</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">bashFunc<span class="token punctuation">,</span> file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">await</span> $<span class="token punctuation">.</span>noquote<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">bashFunc</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> file <span class="token operator">+</span> <span class="token constant">TMP_FILE_SUFFIX</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n   <span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rm -rf </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n   <span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">mv </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">TMP_FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n   <span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rm -rf </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">TMP_FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> funcArray <span class="token operator">=</span> <span class="token punctuation">[</span>\n   <span class="token punctuation">{</span>\n      path<span class="token punctuation">:</span> <span class="token string">\'mpeg.4\'</span><span class="token punctuation">,</span>\n      func<span class="token punctuation">:</span> transformToMpeg\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token punctuation">{</span>\n      path<span class="token punctuation">:</span> <span class="token string">\'mp4.hasAudio\'</span><span class="token punctuation">,</span>\n      func<span class="token punctuation">:</span> transformToMp4\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token punctuation">{</span>\n      path<span class="token punctuation">:</span> <span class="token string">\'mp4\'</span><span class="token punctuation">,</span>\n      func<span class="token punctuation">:</span> transformToMp4\n   <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">await</span> <span class="token function">concurrentRun</span><span class="token punctuation">(</span>\n   files<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> funcArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> item <span class="token operator">=</span> funcArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n         <span class="token keyword">const</span> <span class="token punctuation">{</span> bashFunc<span class="token punctuation">,</span> files <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>compressConfig<span class="token punctuation">.</span>mp4<span class="token punctuation">,</span> item<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token comment">// files 未定义或者包含 file</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>files <span class="token operator">||</span> files<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">await</span> item<span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">(</span>bashFunc<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">共 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>files<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 压缩完成</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>compress.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90367248879151860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n   mp4: {\n      mp4: {\n         bashFunc: (input, output) =>\n            \\`ffmpeg -y -i \\${input} -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -an -movflags faststart -v fatal \\${output}\\`,\n         hasAudio: {\n            bashFunc: (input, output) =>\n               \\`ffmpeg -y -i \\${input} -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -movflags faststart -v fatal \\${output}\\`,\n            files: [\'public/p7/xmart-os/p7-p6-1.mp4\', \'public/no/p7/build-yours/p7-p1-1@long.mp4\']\n         }\n      },\n      mpeg: {\n         4: {\n            bashFunc: (input, output) =>\n               \\`ffmpeg -y -i \\${input} -f mpeg1video -codec:v mpeg1video -q 4 -bf 0 -r 25 -an -movflags faststart -v fatal \\${output}\\`,\n            files: [\n               \'public/p5/smart-space-internal/p5-inside.mp4\',\n               \'public/p7/extra-performance/p7-chassis.mp4\',\n               \'public/p7/learn-more/p7-wing.mp4\',\n               \'public/g3i/xmart-os/g3i-inside.mp4\'\n            ]\n         }\n      }\n   }\n};`, `90367248879151860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   mp4<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      mp4<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         <span class="token function-variable function">bashFunc</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">input<span class="token punctuation">,</span> output</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ffmpeg -y -i </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>input<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -an -movflags faststart -v fatal </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>output<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n         hasAudio<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token function-variable function">bashFunc</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">input<span class="token punctuation">,</span> output</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n               <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ffmpeg -y -i </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>input<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -movflags faststart -v fatal </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>output<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n            files<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'public/p7/xmart-os/p7-p6-1.mp4\'</span><span class="token punctuation">,</span> <span class="token string">\'public/no/p7/build-yours/p7-p1-1@long.mp4\'</span><span class="token punctuation">]</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      mpeg<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         <span class="token number">4</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token function-variable function">bashFunc</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">input<span class="token punctuation">,</span> output</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n               <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ffmpeg -y -i </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>input<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -f mpeg1video -codec:v mpeg1video -q 4 -bf 0 -r 25 -an -movflags faststart -v fatal </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>output<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n            files<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n               <span class="token string">\'public/p5/smart-space-internal/p5-inside.mp4\'</span><span class="token punctuation">,</span>\n               <span class="token string">\'public/p7/extra-performance/p7-chassis.mp4\'</span><span class="token punctuation">,</span>\n               <span class="token string">\'public/p7/learn-more/p7-wing.mp4\'</span><span class="token punctuation">,</span>\n               <span class="token string">\'public/g3i/xmart-os/g3i-inside.mp4\'</span>\n            <span class="token punctuation">]</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="使用方式-1"><a href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用方式</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69933148305025950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`yarn compress # 压缩全部视频文件\nyarn public/g9/1.mp4 public/g9/2.mp4 public/g9/3.mp4 # 部分压缩`, `69933148305025950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token function">yarn</span> compress <span class="token comment"># 压缩全部视频文件</span>\n<span class="token function">yarn</span> public/g9/1.mp4 public/g9/2.mp4 public/g9/3.mp4 <span class="token comment"># 部分压缩</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="优化方向-5"><a href="#%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化方向</h3>\n<ol>\n<li>支持图片压缩</li>\n<li>压缩脚本工具化</li>\n<li>图片、视频的 cdn、格式优化（av1, avif）</li>\n</ol>\n<h1 id="痛点"><a href="#%E7%97%9B%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>痛点</h1>\n<ol>\n<li>国际站与国家站，pc 与 h5 代码相互影响</li>\n<li>复用样式太多，导致需要重置的样式也很多（尽量少写或不写复用样式，除非非常确定。pc 端与 h5 端样式利用媒体查询分开写）</li>\n<li>antd 组件的适配方式有问题，未转化为 rem 单位</li>\n<li>h5 下应该使用 antd-mobile 组件</li>\n<li>国家站车型部分重复代码过多</li>\n<li>生成路由含有 2 个国家及以上的（已解决）</li>\n<li>官网内的链接跳转未使用 history.push（解决中）</li>\n</ol>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/国际官网核心原理/index.md absPath of file >>> MarkdownRemark",timeToRead:10,frontmatter:{date:"2022-12-16 17:26:23",path:"/international-official-website-core-principle/",tags:"前端, 国际官网, 预研",title:"国际官网核心原理",draft:null}},{excerpt:"需求背景 由于 PMS 项目需要开发如下图所示的甘特图，需要选择合适的组件来实现此功能 技术选型 选型 优点 缺点 gantt-schedule-timeline-calendar 功能丰富 与 UI 相差较大，定制化代码较多 react-timeline-gantt 功能丰富 与 UI 相差较大，定制化代码较多 gantt 与 UI 相差不大 在 react 使用需要封装；缺失左侧文字描述功能 gantt-for-react 与 UI 相差不大，可直接在 react…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>由于 PMS 项目需要开发如下图所示的甘特图，需要选择合适的组件来实现此功能</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-11-16-17-43-29-3a19f19f610438d817f4d830953d71b5-9c1be.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 26.041666666666668%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAAAuUlEQVQY001PW2rDQAz0/S/WG7QkDU0/TAiunZel3dW7sh1ChtEyCM2O1DHLOE0PbMSaujYyC/NgESISkXjBAxCrsKi6ezY6M38UhiJNIjkXHK9/9/lW2ArHXB3IMdkMSQt7Xbn91mUxMQBqJkaM98vnz2GYTqlbg2n4FkbX6ktwbuTJbfJplnVDXxFvyJyPff913BH0tQGWi9pyxWtsMatq+jezrFryya5Z5ShkA8S+P+9+D1DLu/kf+6kjyh20r2EAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="pms-example" title="" data-src="/static/2021-11-16-17-43-29-3a19f19f610438d817f4d830953d71b5-fee1c.png" data-srcset="/static/2021-11-16-17-43-29-3a19f19f610438d817f4d830953d71b5-a67b7.png 200w,\n/static/2021-11-16-17-43-29-3a19f19f610438d817f4d830953d71b5-0b187.png 400w,\n/static/2021-11-16-17-43-29-3a19f19f610438d817f4d830953d71b5-fee1c.png 800w,\n/static/2021-11-16-17-43-29-3a19f19f610438d817f4d830953d71b5-b1a91.png 1200w,\n/static/2021-11-16-17-43-29-3a19f19f610438d817f4d830953d71b5-9c1be.png 1440w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="技术选型"><a href="#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术选型</h1>\n<table>\n<thead>\n<tr>\n<th align="left">选型</th>\n<th align="left">优点</th>\n<th align="left">缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left"><a href="https://github.com/neuronetio/gantt-schedule-timeline-calendar" target="_blank" rel="nofollow noreferrer noopener">gantt-schedule-timeline-calendar</a></td>\n<td align="left">功能丰富</td>\n<td align="left">与 UI 相差较大，定制化代码较多</td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/guiqui/react-timeline-gantt" target="_blank" rel="nofollow noreferrer noopener">react-timeline-gantt</a></td>\n<td align="left">功能丰富</td>\n<td align="left">与 UI 相差较大，定制化代码较多</td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/frappe/gantt" target="_blank" rel="nofollow noreferrer noopener">gantt</a></td>\n<td align="left">与 UI 相差不大</td>\n<td align="left">在 react 使用需要封装；缺失左侧文字描述功能</td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/hustcc/gantt-for-react" target="_blank" rel="nofollow noreferrer noopener">gantt-for-react</a></td>\n<td align="left">与 UI 相差不大，可直接在 react 中使用</td>\n<td align="left">缺失左侧文字描述功能</td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/MaTeMaTuK/gantt-task-react" target="_blank" rel="nofollow noreferrer noopener">gantt-task-react</a></td>\n<td align="left">与 UI 最为接近</td>\n<td align="left">左侧文字展示功能较弱，只能展示固定的几个字段；关键样式没有暴露，不好做定制化</td>\n</tr>\n</tbody>\n</table>\n<h1 id="技术难点"><a href="#%E6%8A%80%E6%9C%AF%E9%9A%BE%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术难点</h1>\n<p>需要针对 gantt-task-react 的源码做功能的增强：</p>\n<ol>\n<li>左侧文字展示功能增强</li>\n<li>样式属性暴露</li>\n</ol>\n<h1 id="核心逻辑"><a href="#%E6%A0%B8%E5%BF%83%E9%80%BB%E8%BE%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心逻辑</h1>\n<p>所有代码在<a href="https://github.com/towavephone/gantt-task-react/commit/01ef13b7623e2f1bc2fe0b483093d4b84f5edb2f" target="_blank" rel="nofollow noreferrer noopener">这里</a>，这里只展示核心逻辑</p>\n<h2 id="左侧文字展示功能"><a href="#%E5%B7%A6%E4%BE%A7%E6%96%87%E5%AD%97%E5%B1%95%E7%A4%BA%E5%8A%9F%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>左侧文字展示功能</h2>\n<p>左侧文字展示的功能和 antd 的列表渲染 API 一致</p>\n<h3 id="表头渲染"><a href="#%E8%A1%A8%E5%A4%B4%E6%B8%B2%E6%9F%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>表头渲染</h3>\n<p>主要功能如下：</p>\n<ol>\n<li>表头的宽度</li>\n<li>标题渲染</li>\n</ol>\n<p>src/components/task-list/task-list-header.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14831167117611100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React from &quot;react&quot;;\n+ import { ListColumn } from &quot;../../types/public-types&quot;;\nimport styles from &quot;./task-list-header.module.css&quot;;\n\nexport const TaskListHeaderDefault: React.FC<{\n  headerHeight: number;\n  rowWidth: string;\n  fontFamily: string;\n  fontSize: string;\n- }> = ({ headerHeight, fontFamily, fontSize, rowWidth }) => {\n+ listColumns: ListColumn[];\n+ }> = ({ headerHeight, fontFamily, fontSize, listColumns, rowWidth }) => {\n  return (\n    <div\n      className={styles.ganttTable}\n      style={{\n        fontFamily: fontFamily,\n        fontSize: fontSize,\n+       width: rowWidth,\n      }}\n    >\n      <div\n@@ -21,44 +24,17 @@ export const TaskListHeaderDefault: React.FC<{\n          height: headerHeight - 2,\n        }}\n      >\n-       <div\n-         className={styles.ganttTable_HeaderItem}\n-         style={{\n-           minWidth: rowWidth,\n-         }}\n-       >\n-         &nbsp;Name\n-       </div>\n-       <div\n-         className={styles.ganttTable_HeaderSeparator}\n-         style={{\n-           height: headerHeight * 0.5,\n-           marginTop: headerHeight * 0.2,\n-         }}\n-       />\n-       <div\n-         className={styles.ganttTable_HeaderItem}\n-         style={{\n-           minWidth: rowWidth,\n-         }}\n-       >\n-         &nbsp;From\n-       </div>\n-       <div\n-         className={styles.ganttTable_HeaderSeparator}\n-         style={{\n-           height: headerHeight * 0.5,\n-           marginTop: headerHeight * 0.25,\n-         }}\n-       />\n-       <div\n-         className={styles.ganttTable_HeaderItem}\n-         style={{\n-           minWidth: rowWidth,\n-         }}\n-       >\n-         &nbsp;To\n-       </div>\n+       {listColumns.map(item => (\n+         <div\n+           key={item.key || item.dataIndex}\n+           className={styles.ganttTable_HeaderItem}\n+           style={{\n+             width: item.width || &quot;auto&quot;,\n+           }}\n+         >\n+           {item.title}\n+         </div>\n+       ))}\n      </div>\n    </div>\n  );`, `14831167117611100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="diff"\n              >\n                <span class="gatsby-code-button-language">diff</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="diff"><pre style="counter-reset: linenumber NaN" class="language-diff line-numbers"><code class="language-diff">import React from "react";\n<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span> import { ListColumn } from "../../types/public-types";\n</span>import styles from "./task-list-header.module.css";\n\nexport const TaskListHeaderDefault: React.FC&lt;{\n<span class="token unchanged"><span class="token prefix unchanged"> </span> headerHeight: number;\n<span class="token prefix unchanged"> </span> rowWidth: string;\n<span class="token prefix unchanged"> </span> fontFamily: string;\n<span class="token prefix unchanged"> </span> fontSize: string;\n</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span> }> = ({ headerHeight, fontFamily, fontSize, rowWidth }) => {\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span> listColumns: ListColumn[];\n<span class="token prefix inserted">+</span> }> = ({ headerHeight, fontFamily, fontSize, listColumns, rowWidth }) => {\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span> return (\n<span class="token prefix unchanged"> </span>   &lt;div\n<span class="token prefix unchanged"> </span>     className={styles.ganttTable}\n<span class="token prefix unchanged"> </span>     style={{\n<span class="token prefix unchanged"> </span>       fontFamily: fontFamily,\n<span class="token prefix unchanged"> </span>       fontSize: fontSize,\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>       width: rowWidth,\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span>     }}\n<span class="token prefix unchanged"> </span>   >\n<span class="token prefix unchanged"> </span>     &lt;div\n</span>@@ -21,44 +24,17 @@ export const TaskListHeaderDefault: React.FC&lt;{\n<span class="token unchanged"><span class="token prefix unchanged"> </span>         height: headerHeight - 2,\n<span class="token prefix unchanged"> </span>       }}\n<span class="token prefix unchanged"> </span>     >\n</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>       &lt;div\n<span class="token prefix deleted">-</span>         className={styles.ganttTable_HeaderItem}\n<span class="token prefix deleted">-</span>         style={{\n<span class="token prefix deleted">-</span>           minWidth: rowWidth,\n<span class="token prefix deleted">-</span>         }}\n<span class="token prefix deleted">-</span>       >\n<span class="token prefix deleted">-</span>         &amp;nbsp;Name\n<span class="token prefix deleted">-</span>       &lt;/div>\n<span class="token prefix deleted">-</span>       &lt;div\n<span class="token prefix deleted">-</span>         className={styles.ganttTable_HeaderSeparator}\n<span class="token prefix deleted">-</span>         style={{\n<span class="token prefix deleted">-</span>           height: headerHeight * 0.5,\n<span class="token prefix deleted">-</span>           marginTop: headerHeight * 0.2,\n<span class="token prefix deleted">-</span>         }}\n<span class="token prefix deleted">-</span>       />\n<span class="token prefix deleted">-</span>       &lt;div\n<span class="token prefix deleted">-</span>         className={styles.ganttTable_HeaderItem}\n<span class="token prefix deleted">-</span>         style={{\n<span class="token prefix deleted">-</span>           minWidth: rowWidth,\n<span class="token prefix deleted">-</span>         }}\n<span class="token prefix deleted">-</span>       >\n<span class="token prefix deleted">-</span>         &amp;nbsp;From\n<span class="token prefix deleted">-</span>       &lt;/div>\n<span class="token prefix deleted">-</span>       &lt;div\n<span class="token prefix deleted">-</span>         className={styles.ganttTable_HeaderSeparator}\n<span class="token prefix deleted">-</span>         style={{\n<span class="token prefix deleted">-</span>           height: headerHeight * 0.5,\n<span class="token prefix deleted">-</span>           marginTop: headerHeight * 0.25,\n<span class="token prefix deleted">-</span>         }}\n<span class="token prefix deleted">-</span>       />\n<span class="token prefix deleted">-</span>       &lt;div\n<span class="token prefix deleted">-</span>         className={styles.ganttTable_HeaderItem}\n<span class="token prefix deleted">-</span>         style={{\n<span class="token prefix deleted">-</span>           minWidth: rowWidth,\n<span class="token prefix deleted">-</span>         }}\n<span class="token prefix deleted">-</span>       >\n<span class="token prefix deleted">-</span>         &amp;nbsp;To\n<span class="token prefix deleted">-</span>       &lt;/div>\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>       {listColumns.map(item => (\n<span class="token prefix inserted">+</span>         &lt;div\n<span class="token prefix inserted">+</span>           key={item.key || item.dataIndex}\n<span class="token prefix inserted">+</span>           className={styles.ganttTable_HeaderItem}\n<span class="token prefix inserted">+</span>           style={{\n<span class="token prefix inserted">+</span>             width: item.width || "auto",\n<span class="token prefix inserted">+</span>           }}\n<span class="token prefix inserted">+</span>         >\n<span class="token prefix inserted">+</span>           {item.title}\n<span class="token prefix inserted">+</span>         &lt;/div>\n<span class="token prefix inserted">+</span>       ))}\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span>     &lt;/div>\n<span class="token prefix unchanged"> </span>   &lt;/div>\n<span class="token prefix unchanged"> </span> );</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="列表内容渲染"><a href="#%E5%88%97%E8%A1%A8%E5%86%85%E5%AE%B9%E6%B8%B2%E6%9F%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>列表内容渲染</h3>\n<p>主要功能如下：</p>\n<ol>\n<li>表格宽度</li>\n<li>列表内容渲染</li>\n<li>表格行、列单元格合并</li>\n<li>表格长标题过长时省略</li>\n</ol>\n<p>src/components/task-list/task-list-table.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53898115726799900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`- import React, { useMemo } from &quot;react&quot;;\n+ import React from &quot;react&quot;;\n+ import classnames from &quot;classnames&quot;;\n+\nimport styles from &quot;./task-list-table.module.css&quot;;\n- import { Task } from &quot;../../types/public-types&quot;;\n+ import { Task, ListColumn } from &quot;../../types/public-types&quot;;\n+ import { getPathValue } from &quot;../../helpers/other-helper&quot;;\n\n- const localeDateStringCache = {};\n- const toLocaleDateStringFactory = (locale: string) => (\n-   date: Date,\n-   dateTimeOptions: Intl.DateTimeFormatOptions\n- ) => {\n-   const key = date.toString();\n-   let lds = localeDateStringCache[key];\n-   if (!lds) {\n-     lds = date.toLocaleDateString(locale, dateTimeOptions);\n-     localeDateStringCache[key] = lds;\n-   }\n-   return lds;\n- };\n- const dateTimeOptions: Intl.DateTimeFormatOptions = {\n-   weekday: &quot;short&quot;,\n-   year: &quot;numeric&quot;,\n-   month: &quot;long&quot;,\n-   day: &quot;numeric&quot;,\n- };\n\n+ function isRenderCell(data: any) {\n+   return (\n+     data &&\n+     typeof data === &quot;object&quot; &&\n+     !Array.isArray(data) &&\n+     !React.isValidElement(data)\n+   );\n+ }\n\nexport const TaskListTableDefault: React.FC<{\n  rowHeight: number;\n@@ -32,84 +44,153 @@ export const TaskListTableDefault: React.FC<{\n  selectedTaskId: string;\n  setSelectedTask: (taskId: string) => void;\n  onExpanderClick: (task: Task) => void;\n+ listColumns: ListColumn[];\n}> = ({\n  rowHeight,\n  rowWidth,\n  tasks,\n  fontFamily,\n  fontSize,\n- locale,\n  onExpanderClick,\n+ listColumns,\n}) => {\n- const toLocaleDateString = useMemo(() => toLocaleDateStringFactory(locale), [\n-   locale,\n- ]);\n\n  return (\n-   <div\n+   <table\n      className={styles.taskListWrapper}\n      style={{\n        fontFamily: fontFamily,\n        fontSize: fontSize,\n+       width: rowWidth,\n      }}\n    >\n-     {tasks.map(t => {\n-       let expanderSymbol = &quot;&quot;;\n-       if (t.hideChildren === false) {\n-         expanderSymbol = &quot;▼&quot;;\n-       } else if (t.hideChildren === true) {\n-         expanderSymbol = &quot;▶&quot;;\n-       }\n+     <tbody>\n+       {tasks.map((t, index) => {\n+         let expanderSymbol = &quot;&quot;;\n+         if (t.hideChildren === false) {\n+           expanderSymbol = &quot;▼&quot;;\n+         } else if (t.hideChildren === true) {\n+           expanderSymbol = &quot;▶&quot;;\n+         }\n\n-       return (\n-         <div\n-           className={styles.taskListTableRow}\n-           style={{ height: rowHeight }}\n-           key={\\`\\${t.id}row\\`}\n-         >\n-           <div\n-             className={styles.taskListCell}\n-             style={{\n-               minWidth: rowWidth,\n-               maxWidth: rowWidth,\n-             }}\n-             title={t.name}\n+         return (\n+           <tr\n+             className={styles.taskListTableRow}\n+             style={{ height: rowHeight }}\n+             key={\\`\\${t.id}row\\`}\n            >\n-             <div className={styles.taskListNameWrapper}>\n-               <div\n-                 className={\n-                   expanderSymbol\n-                     ? styles.taskListExpander\n-                     : styles.taskListEmptyExpander\n+             {listColumns.map(item => {\n+               let childNode: any;\n+               let cellProps;\n+               if (item.children) {\n+                 childNode = item.children;\n+               } else {\n+                 const value = getPathValue(t, item.dataIndex);\n+                 childNode = value;\n+                 if (item.render) {\n+                   const renderData = item.render(value, t, index);\n+                   if (isRenderCell(renderData)) {\n+                     childNode = renderData.children;\n+                     cellProps = renderData.props;\n+                   } else {\n+                     childNode = renderData;\n+                   }\n                  }\n-                 onClick={() => onExpanderClick(t)}\n-               >\n-                 {expanderSymbol}\n-               </div>\n-               <div>{t.name}</div>\n-             </div>\n-           </div>\n-           <div\n-             className={styles.taskListCell}\n-             style={{\n-               minWidth: rowWidth,\n-               maxWidth: rowWidth,\n-             }}\n-           >\n-             &nbsp;{toLocaleDateString(t.start, dateTimeOptions)}\n-           </div>\n-           <div\n-             className={styles.taskListCell}\n-             style={{\n-               minWidth: rowWidth,\n-               maxWidth: rowWidth,\n-             }}\n-           >\n-             &nbsp;{toLocaleDateString(t.end, dateTimeOptions)}\n-           </div>\n-         </div>\n-       );\n-     })}\n-   </div>\n+               }\n+               if (\n+                 typeof childNode === &quot;object&quot; &&\n+                 !Array.isArray(childNode) &&\n+                 !React.isValidElement(childNode)\n+               ) {\n+                 childNode = null;\n+               }\n+               const { colSpan: cellColSpan, rowSpan: cellRowSpan } =\n+                 cellProps || {};\n+               const mergedColSpan =\n+                 cellColSpan !== undefined ? cellColSpan : item.colSpan;\n+               const mergedRowSpan =\n+                 cellRowSpan !== undefined ? cellRowSpan : item.rowSpan;\n+               if (mergedColSpan === 0 || mergedRowSpan === 0) {\n+                 return null;\n+               }\n+               let title;\n+               const ellipsisConfig =\n+                 item.ellipsis === true\n+                   ? {\n+                       showTitle: true,\n+                     }\n+                   : item.ellipsis;\n+               if (ellipsisConfig && ellipsisConfig.showTitle) {\n+                 if (\n+                   typeof childNode === &quot;string&quot; ||\n+                   typeof childNode === &quot;number&quot;\n+                 ) {\n+                   title = childNode.toString();\n+                 } else if (\n+                   React.isValidElement(childNode) &&\n+                   // @ts-ignore\n+                   typeof childNode.props.children === &quot;string&quot;\n+                 ) {\n+                   // @ts-ignore\n+                   title = childNode.props.children;\n+                 }\n+               }\n+               return (\n+                 <td\n+                   key={item.key || item.dataIndex}\n+                   className={classnames(\n+                     styles.taskListCell,\n+                     item.ellipsis ? styles.ellipsis : &quot;&quot;\n+                   )}\n+                   style={{\n+                     width: item.width || &quot;auto&quot;,\n+                   }}\n+                   colSpan={\n+                     mergedColSpan && mergedColSpan !== 1\n+                       ? mergedColSpan\n+                       : null\n+                   }\n+                   rowSpan={\n+                     mergedRowSpan && mergedRowSpan !== 1\n+                       ? mergedRowSpan\n+                       : null\n+                   }\n+                 >\n+                   <div className={styles.taskListNameWrapper}>\n+                     <div\n+                       className={\n+                         expanderSymbol\n+                           ? styles.taskListExpander\n+                           : styles.taskListEmptyExpander\n+                       }\n+                       onClick={() => onExpanderClick(t)}\n+                     >\n+                       {expanderSymbol}\n+                     </div>\n+                     <div title={title} className={styles.ellipsis}>\n+                       {childNode}\n+                     </div>\n+                   </div>\n+                 </td>\n+               );\n+             })}\n+           </tr>\n+         );\n+       })}\n+     </tbody>\n+   </table>\n  );\n};`, `53898115726799900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="diff"\n              >\n                <span class="gatsby-code-button-language">diff</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="diff"><pre style="counter-reset: linenumber NaN" class="language-diff line-numbers"><code class="language-diff"><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span> import React, { useMemo } from "react";\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span> import React from "react";\n<span class="token prefix inserted">+</span> import classnames from "classnames";\n<span class="token prefix inserted">+</span>\n</span>import styles from "./task-list-table.module.css";\n<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span> import { Task } from "../../types/public-types";\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span> import { Task, ListColumn } from "../../types/public-types";\n<span class="token prefix inserted">+</span> import { getPathValue } from "../../helpers/other-helper";\n</span>\n<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span> const localeDateStringCache = {};\n<span class="token prefix deleted">-</span> const toLocaleDateStringFactory = (locale: string) => (\n<span class="token prefix deleted">-</span>   date: Date,\n<span class="token prefix deleted">-</span>   dateTimeOptions: Intl.DateTimeFormatOptions\n<span class="token prefix deleted">-</span> ) => {\n<span class="token prefix deleted">-</span>   const key = date.toString();\n<span class="token prefix deleted">-</span>   let lds = localeDateStringCache[key];\n<span class="token prefix deleted">-</span>   if (!lds) {\n<span class="token prefix deleted">-</span>     lds = date.toLocaleDateString(locale, dateTimeOptions);\n<span class="token prefix deleted">-</span>     localeDateStringCache[key] = lds;\n<span class="token prefix deleted">-</span>   }\n<span class="token prefix deleted">-</span>   return lds;\n<span class="token prefix deleted">-</span> };\n<span class="token prefix deleted">-</span> const dateTimeOptions: Intl.DateTimeFormatOptions = {\n<span class="token prefix deleted">-</span>   weekday: "short",\n<span class="token prefix deleted">-</span>   year: "numeric",\n<span class="token prefix deleted">-</span>   month: "long",\n<span class="token prefix deleted">-</span>   day: "numeric",\n<span class="token prefix deleted">-</span> };\n</span>\n<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span> function isRenderCell(data: any) {\n<span class="token prefix inserted">+</span>   return (\n<span class="token prefix inserted">+</span>     data &amp;&amp;\n<span class="token prefix inserted">+</span>     typeof data === "object" &amp;&amp;\n<span class="token prefix inserted">+</span>     !Array.isArray(data) &amp;&amp;\n<span class="token prefix inserted">+</span>     !React.isValidElement(data)\n<span class="token prefix inserted">+</span>   );\n<span class="token prefix inserted">+</span> }\n</span>\nexport const TaskListTableDefault: React.FC&lt;{\n<span class="token unchanged"><span class="token prefix unchanged"> </span> rowHeight: number;\n</span>@@ -32,84 +44,153 @@ export const TaskListTableDefault: React.FC&lt;{\n<span class="token unchanged"><span class="token prefix unchanged"> </span> selectedTaskId: string;\n<span class="token prefix unchanged"> </span> setSelectedTask: (taskId: string) => void;\n<span class="token prefix unchanged"> </span> onExpanderClick: (task: Task) => void;\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span> listColumns: ListColumn[];\n</span>}> = ({\n<span class="token unchanged"><span class="token prefix unchanged"> </span> rowHeight,\n<span class="token prefix unchanged"> </span> rowWidth,\n<span class="token prefix unchanged"> </span> tasks,\n<span class="token prefix unchanged"> </span> fontFamily,\n<span class="token prefix unchanged"> </span> fontSize,\n</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span> locale,\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span> onExpanderClick,\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span> listColumns,\n</span>}) => {\n<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span> const toLocaleDateString = useMemo(() => toLocaleDateStringFactory(locale), [\n<span class="token prefix deleted">-</span>   locale,\n<span class="token prefix deleted">-</span> ]);\n</span>\n<span class="token unchanged"><span class="token prefix unchanged"> </span> return (\n</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>   &lt;div\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>   &lt;table\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span>     className={styles.taskListWrapper}\n<span class="token prefix unchanged"> </span>     style={{\n<span class="token prefix unchanged"> </span>       fontFamily: fontFamily,\n<span class="token prefix unchanged"> </span>       fontSize: fontSize,\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>       width: rowWidth,\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span>     }}\n<span class="token prefix unchanged"> </span>   >\n</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>     {tasks.map(t => {\n<span class="token prefix deleted">-</span>       let expanderSymbol = "";\n<span class="token prefix deleted">-</span>       if (t.hideChildren === false) {\n<span class="token prefix deleted">-</span>         expanderSymbol = "▼";\n<span class="token prefix deleted">-</span>       } else if (t.hideChildren === true) {\n<span class="token prefix deleted">-</span>         expanderSymbol = "▶";\n<span class="token prefix deleted">-</span>       }\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>     &lt;tbody>\n<span class="token prefix inserted">+</span>       {tasks.map((t, index) => {\n<span class="token prefix inserted">+</span>         let expanderSymbol = "";\n<span class="token prefix inserted">+</span>         if (t.hideChildren === false) {\n<span class="token prefix inserted">+</span>           expanderSymbol = "▼";\n<span class="token prefix inserted">+</span>         } else if (t.hideChildren === true) {\n<span class="token prefix inserted">+</span>           expanderSymbol = "▶";\n<span class="token prefix inserted">+</span>         }\n</span>\n<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>       return (\n<span class="token prefix deleted">-</span>         &lt;div\n<span class="token prefix deleted">-</span>           className={styles.taskListTableRow}\n<span class="token prefix deleted">-</span>           style={{ height: rowHeight }}\n<span class="token prefix deleted">-</span>           key={`${t.id}row`}\n<span class="token prefix deleted">-</span>         >\n<span class="token prefix deleted">-</span>           &lt;div\n<span class="token prefix deleted">-</span>             className={styles.taskListCell}\n<span class="token prefix deleted">-</span>             style={{\n<span class="token prefix deleted">-</span>               minWidth: rowWidth,\n<span class="token prefix deleted">-</span>               maxWidth: rowWidth,\n<span class="token prefix deleted">-</span>             }}\n<span class="token prefix deleted">-</span>             title={t.name}\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>         return (\n<span class="token prefix inserted">+</span>           &lt;tr\n<span class="token prefix inserted">+</span>             className={styles.taskListTableRow}\n<span class="token prefix inserted">+</span>             style={{ height: rowHeight }}\n<span class="token prefix inserted">+</span>             key={`${t.id}row`}\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span>           >\n</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>             &lt;div className={styles.taskListNameWrapper}>\n<span class="token prefix deleted">-</span>               &lt;div\n<span class="token prefix deleted">-</span>                 className={\n<span class="token prefix deleted">-</span>                   expanderSymbol\n<span class="token prefix deleted">-</span>                     ? styles.taskListExpander\n<span class="token prefix deleted">-</span>                     : styles.taskListEmptyExpander\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>             {listColumns.map(item => {\n<span class="token prefix inserted">+</span>               let childNode: any;\n<span class="token prefix inserted">+</span>               let cellProps;\n<span class="token prefix inserted">+</span>               if (item.children) {\n<span class="token prefix inserted">+</span>                 childNode = item.children;\n<span class="token prefix inserted">+</span>               } else {\n<span class="token prefix inserted">+</span>                 const value = getPathValue(t, item.dataIndex);\n<span class="token prefix inserted">+</span>                 childNode = value;\n<span class="token prefix inserted">+</span>                 if (item.render) {\n<span class="token prefix inserted">+</span>                   const renderData = item.render(value, t, index);\n<span class="token prefix inserted">+</span>                   if (isRenderCell(renderData)) {\n<span class="token prefix inserted">+</span>                     childNode = renderData.children;\n<span class="token prefix inserted">+</span>                     cellProps = renderData.props;\n<span class="token prefix inserted">+</span>                   } else {\n<span class="token prefix inserted">+</span>                     childNode = renderData;\n<span class="token prefix inserted">+</span>                   }\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span>                 }\n</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>                 onClick={() => onExpanderClick(t)}\n<span class="token prefix deleted">-</span>               >\n<span class="token prefix deleted">-</span>                 {expanderSymbol}\n<span class="token prefix deleted">-</span>               &lt;/div>\n<span class="token prefix deleted">-</span>               &lt;div>{t.name}&lt;/div>\n<span class="token prefix deleted">-</span>             &lt;/div>\n<span class="token prefix deleted">-</span>           &lt;/div>\n<span class="token prefix deleted">-</span>           &lt;div\n<span class="token prefix deleted">-</span>             className={styles.taskListCell}\n<span class="token prefix deleted">-</span>             style={{\n<span class="token prefix deleted">-</span>               minWidth: rowWidth,\n<span class="token prefix deleted">-</span>               maxWidth: rowWidth,\n<span class="token prefix deleted">-</span>             }}\n<span class="token prefix deleted">-</span>           >\n<span class="token prefix deleted">-</span>             &amp;nbsp;{toLocaleDateString(t.start, dateTimeOptions)}\n<span class="token prefix deleted">-</span>           &lt;/div>\n<span class="token prefix deleted">-</span>           &lt;div\n<span class="token prefix deleted">-</span>             className={styles.taskListCell}\n<span class="token prefix deleted">-</span>             style={{\n<span class="token prefix deleted">-</span>               minWidth: rowWidth,\n<span class="token prefix deleted">-</span>               maxWidth: rowWidth,\n<span class="token prefix deleted">-</span>             }}\n<span class="token prefix deleted">-</span>           >\n<span class="token prefix deleted">-</span>             &amp;nbsp;{toLocaleDateString(t.end, dateTimeOptions)}\n<span class="token prefix deleted">-</span>           &lt;/div>\n<span class="token prefix deleted">-</span>         &lt;/div>\n<span class="token prefix deleted">-</span>       );\n<span class="token prefix deleted">-</span>     })}\n<span class="token prefix deleted">-</span>   &lt;/div>\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>               }\n<span class="token prefix inserted">+</span>               if (\n<span class="token prefix inserted">+</span>                 typeof childNode === "object" &amp;&amp;\n<span class="token prefix inserted">+</span>                 !Array.isArray(childNode) &amp;&amp;\n<span class="token prefix inserted">+</span>                 !React.isValidElement(childNode)\n<span class="token prefix inserted">+</span>               ) {\n<span class="token prefix inserted">+</span>                 childNode = null;\n<span class="token prefix inserted">+</span>               }\n<span class="token prefix inserted">+</span>               const { colSpan: cellColSpan, rowSpan: cellRowSpan } =\n<span class="token prefix inserted">+</span>                 cellProps || {};\n<span class="token prefix inserted">+</span>               const mergedColSpan =\n<span class="token prefix inserted">+</span>                 cellColSpan !== undefined ? cellColSpan : item.colSpan;\n<span class="token prefix inserted">+</span>               const mergedRowSpan =\n<span class="token prefix inserted">+</span>                 cellRowSpan !== undefined ? cellRowSpan : item.rowSpan;\n<span class="token prefix inserted">+</span>               if (mergedColSpan === 0 || mergedRowSpan === 0) {\n<span class="token prefix inserted">+</span>                 return null;\n<span class="token prefix inserted">+</span>               }\n<span class="token prefix inserted">+</span>               let title;\n<span class="token prefix inserted">+</span>               const ellipsisConfig =\n<span class="token prefix inserted">+</span>                 item.ellipsis === true\n<span class="token prefix inserted">+</span>                   ? {\n<span class="token prefix inserted">+</span>                       showTitle: true,\n<span class="token prefix inserted">+</span>                     }\n<span class="token prefix inserted">+</span>                   : item.ellipsis;\n<span class="token prefix inserted">+</span>               if (ellipsisConfig &amp;&amp; ellipsisConfig.showTitle) {\n<span class="token prefix inserted">+</span>                 if (\n<span class="token prefix inserted">+</span>                   typeof childNode === "string" ||\n<span class="token prefix inserted">+</span>                   typeof childNode === "number"\n<span class="token prefix inserted">+</span>                 ) {\n<span class="token prefix inserted">+</span>                   title = childNode.toString();\n<span class="token prefix inserted">+</span>                 } else if (\n<span class="token prefix inserted">+</span>                   React.isValidElement(childNode) &amp;&amp;\n<span class="token prefix inserted">+</span>                   // @ts-ignore\n<span class="token prefix inserted">+</span>                   typeof childNode.props.children === "string"\n<span class="token prefix inserted">+</span>                 ) {\n<span class="token prefix inserted">+</span>                   // @ts-ignore\n<span class="token prefix inserted">+</span>                   title = childNode.props.children;\n<span class="token prefix inserted">+</span>                 }\n<span class="token prefix inserted">+</span>               }\n<span class="token prefix inserted">+</span>               return (\n<span class="token prefix inserted">+</span>                 &lt;td\n<span class="token prefix inserted">+</span>                   key={item.key || item.dataIndex}\n<span class="token prefix inserted">+</span>                   className={classnames(\n<span class="token prefix inserted">+</span>                     styles.taskListCell,\n<span class="token prefix inserted">+</span>                     item.ellipsis ? styles.ellipsis : ""\n<span class="token prefix inserted">+</span>                   )}\n<span class="token prefix inserted">+</span>                   style={{\n<span class="token prefix inserted">+</span>                     width: item.width || "auto",\n<span class="token prefix inserted">+</span>                   }}\n<span class="token prefix inserted">+</span>                   colSpan={\n<span class="token prefix inserted">+</span>                     mergedColSpan &amp;&amp; mergedColSpan !== 1\n<span class="token prefix inserted">+</span>                       ? mergedColSpan\n<span class="token prefix inserted">+</span>                       : null\n<span class="token prefix inserted">+</span>                   }\n<span class="token prefix inserted">+</span>                   rowSpan={\n<span class="token prefix inserted">+</span>                     mergedRowSpan &amp;&amp; mergedRowSpan !== 1\n<span class="token prefix inserted">+</span>                       ? mergedRowSpan\n<span class="token prefix inserted">+</span>                       : null\n<span class="token prefix inserted">+</span>                   }\n<span class="token prefix inserted">+</span>                 >\n<span class="token prefix inserted">+</span>                   &lt;div className={styles.taskListNameWrapper}>\n<span class="token prefix inserted">+</span>                     &lt;div\n<span class="token prefix inserted">+</span>                       className={\n<span class="token prefix inserted">+</span>                         expanderSymbol\n<span class="token prefix inserted">+</span>                           ? styles.taskListExpander\n<span class="token prefix inserted">+</span>                           : styles.taskListEmptyExpander\n<span class="token prefix inserted">+</span>                       }\n<span class="token prefix inserted">+</span>                       onClick={() => onExpanderClick(t)}\n<span class="token prefix inserted">+</span>                     >\n<span class="token prefix inserted">+</span>                       {expanderSymbol}\n<span class="token prefix inserted">+</span>                     &lt;/div>\n<span class="token prefix inserted">+</span>                     &lt;div title={title} className={styles.ellipsis}>\n<span class="token prefix inserted">+</span>                       {childNode}\n<span class="token prefix inserted">+</span>                     &lt;/div>\n<span class="token prefix inserted">+</span>                   &lt;/div>\n<span class="token prefix inserted">+</span>                 &lt;/td>\n<span class="token prefix inserted">+</span>               );\n<span class="token prefix inserted">+</span>             })}\n<span class="token prefix inserted">+</span>           &lt;/tr>\n<span class="token prefix inserted">+</span>         );\n<span class="token prefix inserted">+</span>       })}\n<span class="token prefix inserted">+</span>     &lt;/tbody>\n<span class="token prefix inserted">+</span>   &lt;/table>\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span> );\n</span>};</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="样式属性暴露"><a href="#%E6%A0%B7%E5%BC%8F%E5%B1%9E%E6%80%A7%E6%9A%B4%E9%9C%B2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>样式属性暴露</h2>\n<p>主要功能如下：</p>\n<ol>\n<li>行级斑马线显示</li>\n<li>日期分隔线显示</li>\n<li>行级分隔线显示</li>\n</ol>\n<p>src/components/grid/grid-body.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82657415523829170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`  columnWidth: number;\n  todayColor: string;\n  rtl: boolean;\n+  hasCrosswalk: boolean;\n+  hasDateLine: boolean;\n+  renderRowLines: (index: number) => boolean;\n};\n+\nexport const GridBody: React.FC<GridBodyProps> = ({\n  tasks,\n  dates,\n@@ -20,6 +24,9 @@ export const GridBody: React.FC<GridBodyProps> = ({\n  columnWidth,\n  todayColor,\n  rtl,\n+ hasCrosswalk,\n+ hasDateLine,\n+ renderRowLines,\n}) => {\n  let y = 0;\n  const gridRows: ReactChild[] = [];\n@@ -33,27 +40,33 @@ export const GridBody: React.FC<GridBodyProps> = ({\n      className={styles.gridRowLine}\n    />,\n  ];\n- for (const task of tasks) {\n-   gridRows.push(\n-     <rect\n-       key={&quot;Row&quot; + task.id}\n-       x=&quot;0&quot;\n-       y={y}\n-       width={svgWidth}\n-       height={rowHeight}\n-       className={styles.gridRow}\n-     />\n-   );\n-   rowLines.push(\n-     <line\n-       key={&quot;RowLine&quot; + task.id}\n-       x=&quot;0&quot;\n-       y1={y + rowHeight}\n-       x2={svgWidth}\n-       y2={y + rowHeight}\n-       className={styles.gridRowLine}\n-     />\n-   );\n+ for (let i = 0; i < tasks.length; i++) {\n+   const task = tasks[i];\n+   if (hasCrosswalk) {\n+     gridRows.push(\n+       <rect\n+         key={&quot;Row&quot; + task.id}\n+         x=&quot;0&quot;\n+         y={y}\n+         width={svgWidth}\n+         height={rowHeight}\n+         className={styles.gridRow}\n+       />\n+     );\n+   }\n+   const isRenderRowLines = renderRowLines(i);\n+   if (isRenderRowLines) {\n+     rowLines.push(\n+       <line\n+         key={&quot;RowLine&quot; + task.id}\n+         x=&quot;0&quot;\n+         y1={y + rowHeight}\n+         x2={svgWidth}\n+         y2={y + rowHeight}\n+         className={styles.gridRowLine}\n+       />\n+     );\n+   }\n    y += rowHeight;\n  }\n\n@@ -63,16 +76,18 @@ export const GridBody: React.FC<GridBodyProps> = ({\n  let today: ReactChild = <rect />;\n  for (let i = 0; i < dates.length; i++) {\n    const date = dates[i];\n-   ticks.push(\n-     <line\n-       key={date.getTime()}\n-       x1={tickX}\n-       y1={0}\n-       x2={tickX}\n-       y2={y}\n-       className={styles.gridTick}\n-     />\n-   );\n+   if (hasDateLine) {\n+     ticks.push(\n+       <line\n+         key={date.getTime()}\n+         x1={tickX}\n+         y1={0}\n+         x2={tickX}\n+         y2={y}\n+         className={styles.gridTick}\n+       />\n+     );\n+   }\n    if (\n      (i + 1 !== dates.length &&\n        date.getTime() < now.getTime() &&`, `82657415523829170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="diff"\n              >\n                <span class="gatsby-code-button-language">diff</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="diff"><pre style="counter-reset: linenumber NaN" class="language-diff line-numbers"><code class="language-diff"><span class="token unchanged"><span class="token prefix unchanged"> </span> columnWidth: number;\n<span class="token prefix unchanged"> </span> todayColor: string;\n<span class="token prefix unchanged"> </span> rtl: boolean;\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>  hasCrosswalk: boolean;\n<span class="token prefix inserted">+</span>  hasDateLine: boolean;\n<span class="token prefix inserted">+</span>  renderRowLines: (index: number) => boolean;\n</span>};\n<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>\n</span>export const GridBody: React.FC&lt;GridBodyProps> = ({\n<span class="token unchanged"><span class="token prefix unchanged"> </span> tasks,\n<span class="token prefix unchanged"> </span> dates,\n</span>@@ -20,6 +24,9 @@ export const GridBody: React.FC&lt;GridBodyProps> = ({\n<span class="token unchanged"><span class="token prefix unchanged"> </span> columnWidth,\n<span class="token prefix unchanged"> </span> todayColor,\n<span class="token prefix unchanged"> </span> rtl,\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span> hasCrosswalk,\n<span class="token prefix inserted">+</span> hasDateLine,\n<span class="token prefix inserted">+</span> renderRowLines,\n</span>}) => {\n<span class="token unchanged"><span class="token prefix unchanged"> </span> let y = 0;\n<span class="token prefix unchanged"> </span> const gridRows: ReactChild[] = [];\n</span>@@ -33,27 +40,33 @@ export const GridBody: React.FC&lt;GridBodyProps> = ({\n<span class="token unchanged"><span class="token prefix unchanged"> </span>     className={styles.gridRowLine}\n<span class="token prefix unchanged"> </span>   />,\n<span class="token prefix unchanged"> </span> ];\n</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span> for (const task of tasks) {\n<span class="token prefix deleted">-</span>   gridRows.push(\n<span class="token prefix deleted">-</span>     &lt;rect\n<span class="token prefix deleted">-</span>       key={"Row" + task.id}\n<span class="token prefix deleted">-</span>       x="0"\n<span class="token prefix deleted">-</span>       y={y}\n<span class="token prefix deleted">-</span>       width={svgWidth}\n<span class="token prefix deleted">-</span>       height={rowHeight}\n<span class="token prefix deleted">-</span>       className={styles.gridRow}\n<span class="token prefix deleted">-</span>     />\n<span class="token prefix deleted">-</span>   );\n<span class="token prefix deleted">-</span>   rowLines.push(\n<span class="token prefix deleted">-</span>     &lt;line\n<span class="token prefix deleted">-</span>       key={"RowLine" + task.id}\n<span class="token prefix deleted">-</span>       x="0"\n<span class="token prefix deleted">-</span>       y1={y + rowHeight}\n<span class="token prefix deleted">-</span>       x2={svgWidth}\n<span class="token prefix deleted">-</span>       y2={y + rowHeight}\n<span class="token prefix deleted">-</span>       className={styles.gridRowLine}\n<span class="token prefix deleted">-</span>     />\n<span class="token prefix deleted">-</span>   );\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span> for (let i = 0; i &lt; tasks.length; i++) {\n<span class="token prefix inserted">+</span>   const task = tasks[i];\n<span class="token prefix inserted">+</span>   if (hasCrosswalk) {\n<span class="token prefix inserted">+</span>     gridRows.push(\n<span class="token prefix inserted">+</span>       &lt;rect\n<span class="token prefix inserted">+</span>         key={"Row" + task.id}\n<span class="token prefix inserted">+</span>         x="0"\n<span class="token prefix inserted">+</span>         y={y}\n<span class="token prefix inserted">+</span>         width={svgWidth}\n<span class="token prefix inserted">+</span>         height={rowHeight}\n<span class="token prefix inserted">+</span>         className={styles.gridRow}\n<span class="token prefix inserted">+</span>       />\n<span class="token prefix inserted">+</span>     );\n<span class="token prefix inserted">+</span>   }\n<span class="token prefix inserted">+</span>   const isRenderRowLines = renderRowLines(i);\n<span class="token prefix inserted">+</span>   if (isRenderRowLines) {\n<span class="token prefix inserted">+</span>     rowLines.push(\n<span class="token prefix inserted">+</span>       &lt;line\n<span class="token prefix inserted">+</span>         key={"RowLine" + task.id}\n<span class="token prefix inserted">+</span>         x="0"\n<span class="token prefix inserted">+</span>         y1={y + rowHeight}\n<span class="token prefix inserted">+</span>         x2={svgWidth}\n<span class="token prefix inserted">+</span>         y2={y + rowHeight}\n<span class="token prefix inserted">+</span>         className={styles.gridRowLine}\n<span class="token prefix inserted">+</span>       />\n<span class="token prefix inserted">+</span>     );\n<span class="token prefix inserted">+</span>   }\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span>   y += rowHeight;\n<span class="token prefix unchanged"> </span> }\n</span>\n@@ -63,16 +76,18 @@ export const GridBody: React.FC&lt;GridBodyProps> = ({\n<span class="token unchanged"><span class="token prefix unchanged"> </span> let today: ReactChild = &lt;rect />;\n<span class="token prefix unchanged"> </span> for (let i = 0; i &lt; dates.length; i++) {\n<span class="token prefix unchanged"> </span>   const date = dates[i];\n</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>   ticks.push(\n<span class="token prefix deleted">-</span>     &lt;line\n<span class="token prefix deleted">-</span>       key={date.getTime()}\n<span class="token prefix deleted">-</span>       x1={tickX}\n<span class="token prefix deleted">-</span>       y1={0}\n<span class="token prefix deleted">-</span>       x2={tickX}\n<span class="token prefix deleted">-</span>       y2={y}\n<span class="token prefix deleted">-</span>       className={styles.gridTick}\n<span class="token prefix deleted">-</span>     />\n<span class="token prefix deleted">-</span>   );\n</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>   if (hasDateLine) {\n<span class="token prefix inserted">+</span>     ticks.push(\n<span class="token prefix inserted">+</span>       &lt;line\n<span class="token prefix inserted">+</span>         key={date.getTime()}\n<span class="token prefix inserted">+</span>         x1={tickX}\n<span class="token prefix inserted">+</span>         y1={0}\n<span class="token prefix inserted">+</span>         x2={tickX}\n<span class="token prefix inserted">+</span>         y2={y}\n<span class="token prefix inserted">+</span>         className={styles.gridTick}\n<span class="token prefix inserted">+</span>       />\n<span class="token prefix inserted">+</span>     );\n<span class="token prefix inserted">+</span>   }\n</span><span class="token unchanged"><span class="token prefix unchanged"> </span>   if (\n<span class="token prefix unchanged"> </span>     (i + 1 !== dates.length &amp;&amp;\n<span class="token prefix unchanged"> </span>       date.getTime() &lt; now.getTime() &amp;&amp;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="实现效果"><a href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现效果</h1>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/vtuj8t?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=split" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="总结"><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h1>\n<ol>\n<li>ts 写的不够熟练且精简，需要加强</li>\n<li>对于样式属性暴露应该用固定类名去控制，原作者包含很多的 className 属性，非常冗余</li>\n<li>本地源码优化很少涉及到 svg 的优化，需要加强 svg 的学习</li>\n</ol>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/甘特图组件源码优化/index.md absPath of file >>> MarkdownRemark",timeToRead:8,frontmatter:{date:"2021-11-15 11:48:33",path:"/gantt-component-optimization/",tags:"前端, 源码优化, 预研",title:"甘特图组件源码优化",draft:null}},{excerpt:"需求背景 由于 C 端营销线新建项目需要模板化，需要代码模板的生成功能，以便统一技术栈 一期 一期代码生成需要在 lerna 工程下去做改造，除了带有代码模板的功能，还封装了执行脚本的入口 参考链接： react-boilerplate 这里的代码模板包含项目级别的代码模板、页面级别的代码模板，目前只完成了项目的代码模板生成 目录结构 脚本主入口 package.json 模板代码生成 模板代码执行主入口 internals/generators/index.js 检测 packages…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>由于 C 端营销线新建项目需要模板化，需要代码模板的生成功能，以便统一技术栈</p>\n<h1 id="一期"><a href="#%E4%B8%80%E6%9C%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一期</h1>\n<p>一期代码生成需要在 lerna 工程下去做改造，除了带有代码模板的功能，还封装了执行脚本的入口</p>\n<p>参考链接：<a href="https://github.com/react-boilerplate/react-boilerplate" target="_blank" rel="nofollow noreferrer noopener">react-boilerplate</a></p>\n<blockquote>\n<p>这里的代码模板包含项目级别的代码模板、页面级别的代码模板，目前只完成了项目的代码模板生成</p>\n</blockquote>\n<h2 id="目录结构"><a href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>目录结构</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37954876044787800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`.\n├── index.html\n├── internals\n│   ├── generators\n│   │   ├── index.js // 模板代码执行主入口\n│   │   ├── package // 模板文件夹，带有模板变量的文件后缀名为 hbs\n│   │   │   ├── config.js.hbs\n│   │   │   ├── index.js // 项目级别的代码模板命令执行入口\n│   │   │   ├── package-lock.json.hbs\n│   │   │   ├── package.json.hbs // 带模板变量的模板文件\n│   │   │   └── template // 不带模板变量的模板文件\n│   │   ├── page\n│   │   │   └── index.js // 页面级别的代码模板命令执行入口\n│   │   └── utils\n│   │       ├── directoryExists.js // 检测 packages 文件夹存在性\n│   │       └── fileKeyExists.js // 检测 packages 下面文件里面某种属性是否存在，主要为了实现端口占用检测功能\n│   └── scripts\n│       ├── helpers\n│       │   └── argv.js // 命令行参数封装\n│       └── run.js // 脚本执行主入口\n├── packages // 项目源代码，即代码模板生成后的结果文件夹\n|   ├── demo1\n│   └── demo2\n├── lerna.json\n├── package-lock.json\n├── package.json // 命令主入口\n└── readme.md`, `37954876044787800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">.</span>\n├── index<span class="token punctuation">.</span>html\n├── internals\n│   ├── generators\n│   │   ├── index<span class="token punctuation">.</span>js <span class="token comment">// 模板代码执行主入口</span>\n│   │   ├── <span class="token keyword">package</span> <span class="token comment">// 模板文件夹，带有模板变量的文件后缀名为 hbs</span>\n│   │   │   ├── config<span class="token punctuation">.</span>js<span class="token punctuation">.</span>hbs\n│   │   │   ├── index<span class="token punctuation">.</span>js <span class="token comment">// 项目级别的代码模板命令执行入口</span>\n│   │   │   ├── <span class="token keyword">package</span><span class="token operator">-</span>lock<span class="token punctuation">.</span>json<span class="token punctuation">.</span>hbs\n│   │   │   ├── <span class="token keyword">package</span><span class="token punctuation">.</span>json<span class="token punctuation">.</span>hbs <span class="token comment">// 带模板变量的模板文件</span>\n│   │   │   └── template <span class="token comment">// 不带模板变量的模板文件</span>\n│   │   ├── page\n│   │   │   └── index<span class="token punctuation">.</span>js <span class="token comment">// 页面级别的代码模板命令执行入口</span>\n│   │   └── utils\n│   │       ├── directoryExists<span class="token punctuation">.</span>js <span class="token comment">// 检测 packages 文件夹存在性</span>\n│   │       └── fileKeyExists<span class="token punctuation">.</span>js <span class="token comment">// 检测 packages 下面文件里面某种属性是否存在，主要为了实现端口占用检测功能</span>\n│   └── scripts\n│       ├── helpers\n│       │   └── argv<span class="token punctuation">.</span>js <span class="token comment">// 命令行参数封装</span>\n│       └── run<span class="token punctuation">.</span>js <span class="token comment">// 脚本执行主入口</span>\n├── packages <span class="token comment">// 项目源代码，即代码模板生成后的结果文件夹</span>\n<span class="token operator">|</span>   ├── demo1\n│   └── demo2\n├── lerna<span class="token punctuation">.</span>json\n├── <span class="token keyword">package</span><span class="token operator">-</span>lock<span class="token punctuation">.</span>json\n├── <span class="token keyword">package</span><span class="token punctuation">.</span>json <span class="token comment">// 命令主入口</span>\n└── readme<span class="token punctuation">.</span>md</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="脚本主入口"><a href="#%E8%84%9A%E6%9C%AC%E4%B8%BB%E5%85%A5%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>脚本主入口</h2>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15604184616887640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n   &quot;name&quot;: &quot;root&quot;,\n   &quot;private&quot;: true,\n   &quot;devDependencies&quot;: {\n      &quot;cross-env&quot;: &quot;^7.0.3&quot;,\n      &quot;lerna&quot;: &quot;^4.0.0&quot;,\n      &quot;minimist&quot;: &quot;^1.2.5&quot;,\n      &quot;plop&quot;: &quot;^2.7.4&quot;,\n      &quot;shelljs&quot;: &quot;^0.8.4&quot;\n   },\n   &quot;scripts&quot;: {\n      &quot;postinstall&quot;: &quot;lerna bootstrap&quot;,\n      &quot;start&quot;: &quot;node internals/scripts/run --cmd=start&quot;,\n      &quot;build&quot;: &quot;node internals/scripts/run --cmd=build&quot;,\n      &quot;generate&quot;: &quot;plop --plopfile internals/generators/index.js&quot;\n   }\n}`, `15604184616887640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n   <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>\n   <span class="token property">"private"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n   <span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"cross-env"</span><span class="token operator">:</span> <span class="token string">"^7.0.3"</span><span class="token punctuation">,</span>\n      <span class="token property">"lerna"</span><span class="token operator">:</span> <span class="token string">"^4.0.0"</span><span class="token punctuation">,</span>\n      <span class="token property">"minimist"</span><span class="token operator">:</span> <span class="token string">"^1.2.5"</span><span class="token punctuation">,</span>\n      <span class="token property">"plop"</span><span class="token operator">:</span> <span class="token string">"^2.7.4"</span><span class="token punctuation">,</span>\n      <span class="token property">"shelljs"</span><span class="token operator">:</span> <span class="token string">"^0.8.4"</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"postinstall"</span><span class="token operator">:</span> <span class="token string">"lerna bootstrap"</span><span class="token punctuation">,</span>\n      <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"node internals/scripts/run --cmd=start"</span><span class="token punctuation">,</span>\n      <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"node internals/scripts/run --cmd=build"</span><span class="token punctuation">,</span>\n      <span class="token property">"generate"</span><span class="token operator">:</span> <span class="token string">"plop --plopfile internals/generators/index.js"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="模板代码生成"><a href="#%E6%A8%A1%E6%9D%BF%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模板代码生成</h2>\n<h3 id="模板代码执行主入口"><a href="#%E6%A8%A1%E6%9D%BF%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E4%B8%BB%E5%85%A5%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模板代码执行主入口</h3>\n<p>internals/generators/index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82074152256685700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const shell = require(\'shelljs\');\n\nconst packageGenerator = require(\'./package/index.js\');\n\nmodule.exports = (plop) => {\n   plop.setGenerator(\'package\', packageGenerator); // 注册 package 下的命令\n   // plop.setGenerator(&quot;page&quot;, containerGenerator);\n   plop.setDefaultInclude({ actionTypes: true });\n   // 拓展 plop 复制功能\n   plop.setActionType(\'copy\', (answers, config, plop) => {\n      const src = plop.renderString(config.src, answers);\n      const dest = plop.renderString(config.dest, answers);\n      shell.cp(\'-r\', src, dest);\n   });\n};`, `82074152256685700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> shell <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'shelljs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> packageGenerator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./package/index.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">plop</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   plop<span class="token punctuation">.</span><span class="token function">setGenerator</span><span class="token punctuation">(</span><span class="token string">\'package\'</span><span class="token punctuation">,</span> packageGenerator<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注册 package 下的命令</span>\n   <span class="token comment">// plop.setGenerator("page", containerGenerator);</span>\n   plop<span class="token punctuation">.</span><span class="token function">setDefaultInclude</span><span class="token punctuation">(</span><span class="token punctuation">{</span> actionTypes<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 拓展 plop 复制功能</span>\n   plop<span class="token punctuation">.</span><span class="token function">setActionType</span><span class="token punctuation">(</span><span class="token string">\'copy\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">answers<span class="token punctuation">,</span> config<span class="token punctuation">,</span> plop</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> src <span class="token operator">=</span> plop<span class="token punctuation">.</span><span class="token function">renderString</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>src<span class="token punctuation">,</span> answers<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> dest <span class="token operator">=</span> plop<span class="token punctuation">.</span><span class="token function">renderString</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>dest<span class="token punctuation">,</span> answers<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      shell<span class="token punctuation">.</span><span class="token function">cp</span><span class="token punctuation">(</span><span class="token string">\'-r\'</span><span class="token punctuation">,</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="检测-packages-文件夹存在性"><a href="#%E6%A3%80%E6%B5%8B-packages-%E6%96%87%E4%BB%B6%E5%A4%B9%E5%AD%98%E5%9C%A8%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>检测 packages 文件夹存在性</h3>\n<p>internals/generators/utils/directoryExists.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89468325910340910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const fs = require(\'fs\');\nconst path = require(\'path\');\n\n/**\n *\n * @param {*} directoryPath 文件夹路径\n * @param {*} value 输入的值\n * @returns\n */\nfunction directoryExists(directoryPath, value) {\n   const directoryFullPath = path.join(\n      process.cwd(),\n      ...(Array.isArray(directoryPath) ? directoryPath : [directoryPath])\n   );\n   if (fs.existsSync(directoryFullPath) && fs.statSync(directoryFullPath).isDirectory()) {\n      const packages = fs.readdirSync(directoryFullPath);\n      return packages.indexOf(value) >= 0;\n   }\n   return false;\n}\n\nmodule.exports = directoryExists;`, `89468325910340910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">/**\n *\n * @param {*} directoryPath 文件夹路径\n * @param {*} value 输入的值\n * @returns\n */</span>\n<span class="token keyword">function</span> <span class="token function">directoryExists</span><span class="token punctuation">(</span><span class="token parameter">directoryPath<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> directoryFullPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>\n      process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token operator">...</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>directoryPath<span class="token punctuation">)</span> <span class="token operator">?</span> directoryPath <span class="token punctuation">:</span> <span class="token punctuation">[</span>directoryPath<span class="token punctuation">]</span><span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>directoryFullPath<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>directoryFullPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> packages <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>directoryFullPath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> packages<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> directoryExists<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="检测-packages-下面文件里面某种属性是否存在"><a href="#%E6%A3%80%E6%B5%8B-packages-%E4%B8%8B%E9%9D%A2%E6%96%87%E4%BB%B6%E9%87%8C%E9%9D%A2%E6%9F%90%E7%A7%8D%E5%B1%9E%E6%80%A7%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>检测 packages 下面文件里面某种属性是否存在</h3>\n<p>主要为了实现端口占用检测功能</p>\n<p>internals/generators/utils/fileKeyExists.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70047326530109874000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const fs = require(\'fs\');\nconst path = require(\'path\');\nconst packagesPath = path.join(process.cwd(), \'packages\');\nconst packages = fs.readdirSync(packagesPath);\nconst lodash = require(\'lodash\');\n\n/**\n * 检测 packages 下面文件里面某种属性是否存在\n * @param {*} filePath 文件路径\n * @param {*} key 文件的属性\n * @param {*} defaultValue 属性不存在时的默认值\n * @param {*} value 输入的值\n * @returns\n */\nfunction fileKeyExists(filePath, key, defaultValue, value) {\n   const values = [];\n   packages.forEach((item) => {\n      if (item !== \'js-bridge\') {\n         const fileFullPath = path.join(packagesPath, item, ...(Array.isArray(filePath) ? filePath : [filePath]));\n         if (fs.existsSync(fileFullPath) && fs.statSync(fileFullPath).isFile()) {\n            const fileResult = require(fileFullPath);\n            const fileKeyValue = lodash.get(fileResult, key);\n            if (fileKeyValue) {\n               values.push(fileKeyValue);\n            } else {\n               values.push(defaultValue);\n            }\n         } else {\n            values.push(defaultValue);\n         }\n      }\n   });\n   return values.map((item) => \\`\\${item}\\`).indexOf(value) >= 0;\n}\n\nmodule.exports = fileKeyExists;`, `70047326530109874000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> packagesPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'packages\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> packages <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>packagesPath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> lodash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">/**\n * 检测 packages 下面文件里面某种属性是否存在\n * @param {*} filePath 文件路径\n * @param {*} key 文件的属性\n * @param {*} defaultValue 属性不存在时的默认值\n * @param {*} value 输入的值\n * @returns\n */</span>\n<span class="token keyword">function</span> <span class="token function">fileKeyExists</span><span class="token punctuation">(</span><span class="token parameter">filePath<span class="token punctuation">,</span> key<span class="token punctuation">,</span> defaultValue<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> values <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n   packages<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>item <span class="token operator">!==</span> <span class="token string">\'js-bridge\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> fileFullPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>packagesPath<span class="token punctuation">,</span> item<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span> <span class="token operator">?</span> filePath <span class="token punctuation">:</span> <span class="token punctuation">[</span>filePath<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>fileFullPath<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>fileFullPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">const</span> fileResult <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>fileFullPath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">const</span> fileKeyValue <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>fileResult<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>fileKeyValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               values<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fileKeyValue<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n               values<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            values<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> values<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> fileKeyExists<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="项目级别的代码模板命令执行入口"><a href="#%E9%A1%B9%E7%9B%AE%E7%BA%A7%E5%88%AB%E7%9A%84%E4%BB%A3%E7%A0%81%E6%A8%A1%E6%9D%BF%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%85%A5%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>项目级别的代码模板命令执行入口</h3>\n<p>internals/generators/package/index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48154890319869370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const directoryExists = require(\'../utils/directoryExists\');\nconst fileKeyExists = require(\'../utils/fileKeyExists\');\n\nconst portExists = (value) =>\n   fileKeyExists(\'config.js\', \'serverPort\', 3000, value) || fileKeyExists(\'config.js\', \'fePort\', 8888, value);\n\nmodule.exports = {\n   description: \'生成 package\',\n   prompts: [\n      {\n         type: \'input\',\n         name: \'name\',\n         message: \'package 叫什么名字？\',\n         default: \'demo\',\n         validate: (value) => {\n            if (/.+/.test(value)) {\n               return directoryExists(\'packages\', value) ? \'package 名字已存在\' : true;\n            }\n\n            return \'package 名字必填\';\n         }\n      },\n      {\n         type: \'input\',\n         name: \'serverPort\',\n         message: \'package 的 Node.js 服务端口？\',\n         default: \'8001\',\n         validate: (value) => {\n            if (/.+/.test(value)) {\n               return portExists(value) ? \'要设置 package 的 Node.js 服务端口已被占用\' : true;\n            }\n\n            return \'package 名字必填\';\n         }\n      },\n      {\n         type: \'input\',\n         name: \'fePort\',\n         message: \'package 的 webpack-dev-server 端口？\',\n         default: \'8002\',\n         validate: (value) => {\n            if (/.+/.test(value)) {\n               return portExists(value) ? \'要设置 package 的 webpack-dev-server 端口已被占用\' : true;\n            }\n\n            return \'package 名字必填\';\n         }\n      }\n   ],\n   actions: (data) => {\n      const actions = [\n         {\n            type: \'copy\',\n            src: \'internals/generators/package/template\',\n            dest: \'packages/{{ dashCase name }}\'\n         },\n         {\n            type: \'addMany\',\n            templateFiles: \'package/*.hbs\',\n            destination: \'../../packages/{{ dashCase name }}/\'\n         }\n      ];\n\n      return actions;\n   }\n};`, `48154890319869370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> directoryExists <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../utils/directoryExists\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fileKeyExists <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../utils/fileKeyExists\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">portExists</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   <span class="token function">fileKeyExists</span><span class="token punctuation">(</span><span class="token string">\'config.js\'</span><span class="token punctuation">,</span> <span class="token string">\'serverPort\'</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">fileKeyExists</span><span class="token punctuation">(</span><span class="token string">\'config.js\'</span><span class="token punctuation">,</span> <span class="token string">\'fePort\'</span><span class="token punctuation">,</span> <span class="token number">8888</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   description<span class="token punctuation">:</span> <span class="token string">\'生成 package\'</span><span class="token punctuation">,</span>\n   prompts<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token punctuation">{</span>\n         type<span class="token punctuation">:</span> <span class="token string">\'input\'</span><span class="token punctuation">,</span>\n         name<span class="token punctuation">:</span> <span class="token string">\'name\'</span><span class="token punctuation">,</span>\n         message<span class="token punctuation">:</span> <span class="token string">\'package 叫什么名字？\'</span><span class="token punctuation">,</span>\n         <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token string">\'demo\'</span><span class="token punctuation">,</span>\n         <span class="token function-variable function">validate</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/.+/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token keyword">return</span> <span class="token function">directoryExists</span><span class="token punctuation">(</span><span class="token string">\'packages\'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">\'package 名字已存在\'</span> <span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token keyword">return</span> <span class="token string">\'package 名字必填\'</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">{</span>\n         type<span class="token punctuation">:</span> <span class="token string">\'input\'</span><span class="token punctuation">,</span>\n         name<span class="token punctuation">:</span> <span class="token string">\'serverPort\'</span><span class="token punctuation">,</span>\n         message<span class="token punctuation">:</span> <span class="token string">\'package 的 Node.js 服务端口？\'</span><span class="token punctuation">,</span>\n         <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token string">\'8001\'</span><span class="token punctuation">,</span>\n         <span class="token function-variable function">validate</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/.+/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token keyword">return</span> <span class="token function">portExists</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">\'要设置 package 的 Node.js 服务端口已被占用\'</span> <span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token keyword">return</span> <span class="token string">\'package 名字必填\'</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">{</span>\n         type<span class="token punctuation">:</span> <span class="token string">\'input\'</span><span class="token punctuation">,</span>\n         name<span class="token punctuation">:</span> <span class="token string">\'fePort\'</span><span class="token punctuation">,</span>\n         message<span class="token punctuation">:</span> <span class="token string">\'package 的 webpack-dev-server 端口？\'</span><span class="token punctuation">,</span>\n         <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token string">\'8002\'</span><span class="token punctuation">,</span>\n         <span class="token function-variable function">validate</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/.+/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token keyword">return</span> <span class="token function">portExists</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">\'要设置 package 的 webpack-dev-server 端口已被占用\'</span> <span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token keyword">return</span> <span class="token string">\'package 名字必填\'</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">]</span><span class="token punctuation">,</span>\n   <span class="token function-variable function">actions</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> actions <span class="token operator">=</span> <span class="token punctuation">[</span>\n         <span class="token punctuation">{</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'copy\'</span><span class="token punctuation">,</span>\n            src<span class="token punctuation">:</span> <span class="token string">\'internals/generators/package/template\'</span><span class="token punctuation">,</span>\n            dest<span class="token punctuation">:</span> <span class="token string">\'packages/{{ dashCase name }}\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'addMany\'</span><span class="token punctuation">,</span>\n            templateFiles<span class="token punctuation">:</span> <span class="token string">\'package/*.hbs\'</span><span class="token punctuation">,</span>\n            destination<span class="token punctuation">:</span> <span class="token string">\'../../packages/{{ dashCase name }}/\'</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> actions<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="带模板变量的模板文件"><a href="#%E5%B8%A6%E6%A8%A1%E6%9D%BF%E5%8F%98%E9%87%8F%E7%9A%84%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>带模板变量的模板文件</h3>\n<p>hbs 文件为模板文件，所有需要替换的地方用 <code class="language-text">{{}}</code> 模板变量，详情请查看 <a href="https://github.com/plopjs/plop" target="_blank" rel="nofollow noreferrer noopener">plop</a>，其他模板文件不再举例</p>\n<p>internals/generators/package/config.js.hbs</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62966480523584510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  prefix: \'page\',\n  serverPort: {{ serverPort }},\n  fePort: {{ fePort }}\n}`, `62966480523584510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="hbs"\n              >\n                <span class="gatsby-code-button-language">hbs</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="hbs"><pre style="counter-reset: linenumber NaN" class="language-hbs line-numbers"><code class="language-hbs">module.exports = {\n  prefix: &#39;page&#39;,\n  serverPort: {{ serverPort }},\n  fePort: {{ fePort }}\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行结果"><a href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行结果</h3>\n<p>以下是检测存在冲突的情况</p>\n<p><img src="/static/code-generation-addfae6d6b5126e00ca2c25e4c38dd96.gif" alt="代码生成冲突检测"></p>\n<h2 id="脚本执行封装"><a href="#%E8%84%9A%E6%9C%AC%E6%89%A7%E8%A1%8C%E5%B0%81%E8%A3%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>脚本执行封装</h2>\n<p>封装 lerna 脚本，以实现脚本的并行执行</p>\n<p>internals/scripts/helpers/argv.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63164967688453430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = require(\'minimist\')(process.argv.slice(2));`, `63164967688453430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'minimist\'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>internals/scripts/run.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21131237520661150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/usr/bin/env node\n\nconst shelljs = require(\'shelljs\');\nconst argv = require(\'./helpers/argv\');\n\nlet scopeParams = [];\nconst arguments = argv._;\n\nif (arguments && arguments.length > 0) {\n   scopeParams = arguments.map((item) => \\`--scope=\\${item}\\`);\n}\n\nshelljs.exec(\\`\n  cross-env FORCE_COLOR=1 lerna run \\${argv.cmd} --stream --parallel \\${scopeParams.join(\' \')}\n\\`);`, `21131237520661150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node\n\n<span class="token keyword">const</span> shelljs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'shelljs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> argv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./helpers/argv\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> scopeParams <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> arguments <span class="token operator">=</span> argv<span class="token punctuation">.</span>_<span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>arguments <span class="token operator">&amp;&amp;</span> arguments<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   scopeParams <span class="token operator">=</span> arguments<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">--scope=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nshelljs<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n  cross-env FORCE_COLOR=1 lerna run </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>argv<span class="token punctuation">.</span>cmd<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> --stream --parallel </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>scopeParams<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\' \'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="使用说明"><a href="#%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用说明</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34138057471598590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`npm i # 安装依赖\n\n# 启动\nnpm start # 并行启动所有 package\nnpm start website # 启动 website 项目\nnpm start website demo # 并行启动 website,demo 项目\n\n# 编译\nnpm run build # 并行编译所有 package\nnpm run build website # 编译 package 项目\nnpm run build website demo # 并行编译 website,demo 项目\n\n# 模板代码生成\nnpm run generate`, `34138057471598590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token function">npm</span> i <span class="token comment"># 安装依赖</span>\n\n<span class="token comment"># 启动</span>\n<span class="token function">npm</span> start <span class="token comment"># 并行启动所有 package</span>\n<span class="token function">npm</span> start website <span class="token comment"># 启动 website 项目</span>\n<span class="token function">npm</span> start website demo <span class="token comment"># 并行启动 website,demo 项目</span>\n\n<span class="token comment"># 编译</span>\n<span class="token function">npm</span> run build <span class="token comment"># 并行编译所有 package</span>\n<span class="token function">npm</span> run build website <span class="token comment"># 编译 package 项目</span>\n<span class="token function">npm</span> run build website demo <span class="token comment"># 并行编译 website,demo 项目</span>\n\n<span class="token comment"># 模板代码生成</span>\n<span class="token function">npm</span> run generate</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="二期"><a href="#%E4%BA%8C%E6%9C%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>二期</h1>\n<p>由于项目代码需要分离，不再使用 lerna 管理各个产品线的包，所以二期主要工作在于封装成可用的命令行，以便直接使用它来新建项目</p>\n<p>参考链接：<a href="https://juejin.cn/post/6919308174151385096" target="_blank" rel="nofollow noreferrer noopener">从 0-1 搭建 react，ts 脚手架</a></p>\n<h2 id="目录结构-1"><a href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>目录结构</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30030550511893717000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`.\n├── bin\n│   └── cli.js // 脚本主入口\n├── internals\n│   ├── generators\n│   │   ├── index.js // 模板代码生成\n│   │   ├── package\n│   │   │   ├── config.js.hbs\n│   │   │   ├── index.js\n│   │   │   ├── package-lock.json.hbs\n│   │   │   ├── package.json.hbs\n│   │   │   └── template\n│   │   ├── page\n│   │   │   └── index.js\n│   │   └── utils\n│   │       ├── directoryExists.js\n│   │       └── fileKeyExists.js\n│   └── scripts\n│       ├── helpers\n│       │   └── argv.js\n│       └── run.js\n├── package-lock.json\n├── package.json\n├── src\n│   ├── create.js // 模板代码生成主入口\n│   └── start.js\n└── utils\n    └── index.js`, `30030550511893717000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">.</span>\n├── bin\n│   └── cli<span class="token punctuation">.</span>js <span class="token comment">// 脚本主入口</span>\n├── internals\n│   ├── generators\n│   │   ├── index<span class="token punctuation">.</span>js <span class="token comment">// 模板代码生成</span>\n│   │   ├── <span class="token keyword">package</span>\n│   │   │   ├── config<span class="token punctuation">.</span>js<span class="token punctuation">.</span>hbs\n│   │   │   ├── index<span class="token punctuation">.</span>js\n│   │   │   ├── <span class="token keyword">package</span><span class="token operator">-</span>lock<span class="token punctuation">.</span>json<span class="token punctuation">.</span>hbs\n│   │   │   ├── <span class="token keyword">package</span><span class="token punctuation">.</span>json<span class="token punctuation">.</span>hbs\n│   │   │   └── template\n│   │   ├── page\n│   │   │   └── index<span class="token punctuation">.</span>js\n│   │   └── utils\n│   │       ├── directoryExists<span class="token punctuation">.</span>js\n│   │       └── fileKeyExists<span class="token punctuation">.</span>js\n│   └── scripts\n│       ├── helpers\n│       │   └── argv<span class="token punctuation">.</span>js\n│       └── run<span class="token punctuation">.</span>js\n├── <span class="token keyword">package</span><span class="token operator">-</span>lock<span class="token punctuation">.</span>json\n├── <span class="token keyword">package</span><span class="token punctuation">.</span>json\n├── src\n│   ├── create<span class="token punctuation">.</span>js <span class="token comment">// 模板代码生成主入口</span>\n│   └── start<span class="token punctuation">.</span>js\n└── utils\n    └── index<span class="token punctuation">.</span>js</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="脚本主入口-1"><a href="#%E8%84%9A%E6%9C%AC%E4%B8%BB%E5%85%A5%E5%8F%A3-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>脚本主入口</h2>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3296506048202707500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n   &quot;name&quot;: &quot;cli&quot;,\n   &quot;version&quot;: &quot;1.0.0&quot;,\n   &quot;description&quot;: &quot;销服C端脚手架&quot;,\n   &quot;main&quot;: &quot;index.js&quot;,\n   &quot;scripts&quot;: {\n      &quot;test&quot;: &quot;echo \\&quot;Error: no test specified\\&quot; && exit 1&quot;,\n      &quot;start&quot;: &quot;node internals/scripts/run --cmd=start&quot;,\n      &quot;build&quot;: &quot;node internals/scripts/run --cmd=build&quot;\n   },\n   &quot;bin&quot;: {\n      &quot;cli&quot;: &quot;./bin/cli.js&quot;\n   },\n   &quot;author&quot;: &quot;&quot;,\n   &quot;license&quot;: &quot;ISC&quot;,\n   &quot;dependencies&quot;: {\n      &quot;commander&quot;: &quot;^8.2.0&quot;,\n      &quot;cross-env&quot;: &quot;^7.0.3&quot;,\n      &quot;minimist&quot;: &quot;^1.2.5&quot;,\n      &quot;plop&quot;: &quot;^2.7.4&quot;,\n      &quot;shelljs&quot;: &quot;^0.8.4&quot;\n   }\n}`, `3296506048202707500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n   <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"cli"</span><span class="token punctuation">,</span>\n   <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span>\n   <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"销服C端脚手架"</span><span class="token punctuation">,</span>\n   <span class="token property">"main"</span><span class="token operator">:</span> <span class="token string">"index.js"</span><span class="token punctuation">,</span>\n   <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"test"</span><span class="token operator">:</span> <span class="token string">"echo \\"Error: no test specified\\" &amp;&amp; exit 1"</span><span class="token punctuation">,</span>\n      <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"node internals/scripts/run --cmd=start"</span><span class="token punctuation">,</span>\n      <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"node internals/scripts/run --cmd=build"</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token property">"bin"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"cli"</span><span class="token operator">:</span> <span class="token string">"./bin/cli.js"</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token property">"author"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>\n   <span class="token property">"license"</span><span class="token operator">:</span> <span class="token string">"ISC"</span><span class="token punctuation">,</span>\n   <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"commander"</span><span class="token operator">:</span> <span class="token string">"^8.2.0"</span><span class="token punctuation">,</span>\n      <span class="token property">"cross-env"</span><span class="token operator">:</span> <span class="token string">"^7.0.3"</span><span class="token punctuation">,</span>\n      <span class="token property">"minimist"</span><span class="token operator">:</span> <span class="token string">"^1.2.5"</span><span class="token punctuation">,</span>\n      <span class="token property">"plop"</span><span class="token operator">:</span> <span class="token string">"^2.7.4"</span><span class="token punctuation">,</span>\n      <span class="token property">"shelljs"</span><span class="token operator">:</span> <span class="token string">"^0.8.4"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="模板代码生成-1"><a href="#%E6%A8%A1%E6%9D%BF%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模板代码生成</h2>\n<p>以下仅列出和一期的不同点</p>\n<h3 id="模板代码执行主入口-1"><a href="#%E6%A8%A1%E6%9D%BF%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E4%B8%BB%E5%85%A5%E5%8F%A3-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模板代码执行主入口</h3>\n<p>相比一期主要多了新建项目后 <code class="language-text">npm install</code> 的功能</p>\n<p>bin/cli.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24459463331227636000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/usr/bin/env node\nconst program = require(\'commander\');\nconst create = require(\'../src/create\');\n// const start = require(&quot;../src/start&quot;);\n\nconst { green } = require(\'../utils\');\n\nprogram.version(\'1.0.0\');\n\n/* create a project */\nprogram\n   .command(\'create\')\n   .description(\'create a project \')\n   .action(function() {\n      green(\'👽 👽 👽 \' + \'欢迎使用 rux, 轻松构建 react ts 项目～🎉🎉🎉\');\n      create();\n   });\n\n/* start project */\nprogram\n   .command(\'start\')\n   .description(\'start a project\')\n   .action(function() {\n      green(\'--------运行项目-------\');\n      start(\'start\').then(() => {\n         green(\'-------✅  ✅运行完成-------\');\n      });\n   });\n\nprogram.parse(process.argv);`, `24459463331227636000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node\n<span class="token keyword">const</span> program <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'commander\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> create <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../src/create\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// const start = require("../src/start");</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> green <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../utils\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nprogram<span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token string">\'1.0.0\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">/* create a project */</span>\nprogram\n   <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">\'create\'</span><span class="token punctuation">)</span>\n   <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">\'create a project \'</span><span class="token punctuation">)</span>\n   <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">green</span><span class="token punctuation">(</span><span class="token string">\'👽 👽 👽 \'</span> <span class="token operator">+</span> <span class="token string">\'欢迎使用 rux, 轻松构建 react ts 项目～🎉🎉🎉\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">/* start project */</span>\nprogram\n   <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">\'start\'</span><span class="token punctuation">)</span>\n   <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">\'start a project\'</span><span class="token punctuation">)</span>\n   <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">green</span><span class="token punctuation">(</span><span class="token string">\'--------运行项目-------\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">start</span><span class="token punctuation">(</span><span class="token string">\'start\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token function">green</span><span class="token punctuation">(</span><span class="token string">\'-------✅  ✅运行完成-------\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nprogram<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>internals/generators/index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88627145779051790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const shell = require(\'shelljs\');\nconst { spawn } = require(\'child_process\');\n\nconst packageGenerator = require(\'./package/index.js\');\n\nconst didSucceed = (code) => \\`\\${code}\\` === \'0\';\n\nfunction npmInstall(answers, config, plop) {\n   const path = plop.renderString(config.path, answers);\n   const spawnOptions = config.verbose\n      ? {\n           cwd: path,\n           shell: true,\n           stdio: \'inherit\'\n        }\n      : {\n           cwd: path\n        };\n\n   return new Promise((resolve, reject) => {\n      const npmI = spawn(\'npm\', [\'install\'], spawnOptions);\n\n      npmI.on(\'close\', (code) => {\n         if (didSucceed(code)) {\n            resolve(\\`npm install ran correctly\\`);\n         } else {\n            reject(\\`npm install exited with \\${code}\\`);\n         }\n      });\n   });\n}\n\nmodule.exports = (plop) => {\n   plop.setGenerator(\'package\', packageGenerator);\n   // plop.setGenerator(&quot;page&quot;, containerGenerator);\n   plop.setDefaultInclude({ actionTypes: true });\n   plop.setActionType(\'copy\', (answers, config, plop) => {\n      const src = plop.renderString(config.src, answers);\n      const dest = plop.renderString(config.dest, answers);\n      shell.cp(\'-r\', src, dest);\n   });\n   plop.setActionType(\'npmInstall\', npmInstall);\n};`, `88627145779051790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> shell <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'shelljs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> spawn <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'child_process\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> packageGenerator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./package/index.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">didSucceed</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">===</span> <span class="token string">\'0\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">npmInstall</span><span class="token punctuation">(</span><span class="token parameter">answers<span class="token punctuation">,</span> config<span class="token punctuation">,</span> plop</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> path <span class="token operator">=</span> plop<span class="token punctuation">.</span><span class="token function">renderString</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>path<span class="token punctuation">,</span> answers<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> spawnOptions <span class="token operator">=</span> config<span class="token punctuation">.</span>verbose\n      <span class="token operator">?</span> <span class="token punctuation">{</span>\n           cwd<span class="token punctuation">:</span> path<span class="token punctuation">,</span>\n           shell<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n           stdio<span class="token punctuation">:</span> <span class="token string">\'inherit\'</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">:</span> <span class="token punctuation">{</span>\n           cwd<span class="token punctuation">:</span> path\n        <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> npmI <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">\'npm\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'install\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> spawnOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      npmI<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'close\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">didSucceed</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">npm install ran correctly</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">npm install exited with </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">plop</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   plop<span class="token punctuation">.</span><span class="token function">setGenerator</span><span class="token punctuation">(</span><span class="token string">\'package\'</span><span class="token punctuation">,</span> packageGenerator<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// plop.setGenerator("page", containerGenerator);</span>\n   plop<span class="token punctuation">.</span><span class="token function">setDefaultInclude</span><span class="token punctuation">(</span><span class="token punctuation">{</span> actionTypes<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   plop<span class="token punctuation">.</span><span class="token function">setActionType</span><span class="token punctuation">(</span><span class="token string">\'copy\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">answers<span class="token punctuation">,</span> config<span class="token punctuation">,</span> plop</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> src <span class="token operator">=</span> plop<span class="token punctuation">.</span><span class="token function">renderString</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>src<span class="token punctuation">,</span> answers<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> dest <span class="token operator">=</span> plop<span class="token punctuation">.</span><span class="token function">renderString</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>dest<span class="token punctuation">,</span> answers<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      shell<span class="token punctuation">.</span><span class="token function">cp</span><span class="token punctuation">(</span><span class="token string">\'-r\'</span><span class="token punctuation">,</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   plop<span class="token punctuation">.</span><span class="token function">setActionType</span><span class="token punctuation">(</span><span class="token string">\'npmInstall\'</span><span class="token punctuation">,</span> npmInstall<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="项目级别的代码模板命令执行入口-1"><a href="#%E9%A1%B9%E7%9B%AE%E7%BA%A7%E5%88%AB%E7%9A%84%E4%BB%A3%E7%A0%81%E6%A8%A1%E6%9D%BF%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%85%A5%E5%8F%A3-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>项目级别的代码模板命令执行入口</h3>\n<p>相比一期增加 <code class="language-text">npm install</code> 逻辑</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22435565414691295000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const directoryExists = require(\'../utils/directoryExists\');\nconst fileKeyExists = require(\'../utils/fileKeyExists\');\n\nconst portExists = (value) =>\n   fileKeyExists(\'config.js\', \'serverPort\', 3000, value) || fileKeyExists(\'config.js\', \'fePort\', 8888, value);\n\nmodule.exports = {\n   description: \'生成 package\',\n   prompts: [\n      {\n         type: \'input\',\n         name: \'name\',\n         message: \'package 叫什么名字？\',\n         default: \'demo\',\n         validate: (value) => {\n            if (/.+/.test(value)) {\n               return directoryExists(\'packages\', value) ? \'package 名字已存在\' : true;\n            }\n\n            return \'package 名字必填\';\n         }\n      },\n      {\n         type: \'input\',\n         name: \'serverPort\',\n         message: \'package 的 Node.js 服务端口？\',\n         default: \'8001\',\n         validate: (value) => {\n            if (/.+/.test(value)) {\n               return portExists(value) ? \'要设置 package 的 Node.js 服务端口已被占用\' : true;\n            }\n\n            return \'package 名字必填\';\n         }\n      },\n      {\n         type: \'input\',\n         name: \'fePort\',\n         message: \'package 的 webpack-dev-server 端口？\',\n         default: \'8002\',\n         validate: (value) => {\n            if (/.+/.test(value)) {\n               return portExists(value) ? \'要设置 package 的 webpack-dev-server 端口已被占用\' : true;\n            }\n\n            return \'package 名字必填\';\n         }\n      }\n   ],\n   actions: (data) => {\n      const actions = [\n         {\n            type: \'copy\',\n            src: \'internals/generators/package/template\',\n            dest: \'packages/{{ dashCase name }}\'\n         },\n         {\n            type: \'addMany\',\n            templateFiles: \'package/*.hbs\',\n            destination: \'../../packages/{{ dashCase name }}/\'\n         },\n         {\n            type: \'npmInstall\',\n            path: \\`packages/{{ dashCase name }}/\\`\n         }\n      ];\n\n      return actions;\n   }\n};`, `22435565414691295000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> directoryExists <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../utils/directoryExists\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fileKeyExists <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../utils/fileKeyExists\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">portExists</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   <span class="token function">fileKeyExists</span><span class="token punctuation">(</span><span class="token string">\'config.js\'</span><span class="token punctuation">,</span> <span class="token string">\'serverPort\'</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">fileKeyExists</span><span class="token punctuation">(</span><span class="token string">\'config.js\'</span><span class="token punctuation">,</span> <span class="token string">\'fePort\'</span><span class="token punctuation">,</span> <span class="token number">8888</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   description<span class="token punctuation">:</span> <span class="token string">\'生成 package\'</span><span class="token punctuation">,</span>\n   prompts<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token punctuation">{</span>\n         type<span class="token punctuation">:</span> <span class="token string">\'input\'</span><span class="token punctuation">,</span>\n         name<span class="token punctuation">:</span> <span class="token string">\'name\'</span><span class="token punctuation">,</span>\n         message<span class="token punctuation">:</span> <span class="token string">\'package 叫什么名字？\'</span><span class="token punctuation">,</span>\n         <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token string">\'demo\'</span><span class="token punctuation">,</span>\n         <span class="token function-variable function">validate</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/.+/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token keyword">return</span> <span class="token function">directoryExists</span><span class="token punctuation">(</span><span class="token string">\'packages\'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">\'package 名字已存在\'</span> <span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token keyword">return</span> <span class="token string">\'package 名字必填\'</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">{</span>\n         type<span class="token punctuation">:</span> <span class="token string">\'input\'</span><span class="token punctuation">,</span>\n         name<span class="token punctuation">:</span> <span class="token string">\'serverPort\'</span><span class="token punctuation">,</span>\n         message<span class="token punctuation">:</span> <span class="token string">\'package 的 Node.js 服务端口？\'</span><span class="token punctuation">,</span>\n         <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token string">\'8001\'</span><span class="token punctuation">,</span>\n         <span class="token function-variable function">validate</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/.+/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token keyword">return</span> <span class="token function">portExists</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">\'要设置 package 的 Node.js 服务端口已被占用\'</span> <span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token keyword">return</span> <span class="token string">\'package 名字必填\'</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">{</span>\n         type<span class="token punctuation">:</span> <span class="token string">\'input\'</span><span class="token punctuation">,</span>\n         name<span class="token punctuation">:</span> <span class="token string">\'fePort\'</span><span class="token punctuation">,</span>\n         message<span class="token punctuation">:</span> <span class="token string">\'package 的 webpack-dev-server 端口？\'</span><span class="token punctuation">,</span>\n         <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token string">\'8002\'</span><span class="token punctuation">,</span>\n         <span class="token function-variable function">validate</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/.+/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token keyword">return</span> <span class="token function">portExists</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">\'要设置 package 的 webpack-dev-server 端口已被占用\'</span> <span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token keyword">return</span> <span class="token string">\'package 名字必填\'</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">]</span><span class="token punctuation">,</span>\n   <span class="token function-variable function">actions</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> actions <span class="token operator">=</span> <span class="token punctuation">[</span>\n         <span class="token punctuation">{</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'copy\'</span><span class="token punctuation">,</span>\n            src<span class="token punctuation">:</span> <span class="token string">\'internals/generators/package/template\'</span><span class="token punctuation">,</span>\n            dest<span class="token punctuation">:</span> <span class="token string">\'packages/{{ dashCase name }}\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'addMany\'</span><span class="token punctuation">,</span>\n            templateFiles<span class="token punctuation">:</span> <span class="token string">\'package/*.hbs\'</span><span class="token punctuation">,</span>\n            destination<span class="token punctuation">:</span> <span class="token string">\'../../packages/{{ dashCase name }}/\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'npmInstall\'</span><span class="token punctuation">,</span>\n            path<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">packages/{{ dashCase name }}/</span><span class="token template-punctuation string">`</span></span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> actions<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行结果-1"><a href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行结果</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94209466233503290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ cli create\n👽 👽 👽 欢迎使用 rux, 轻松构建 react ts 项目～🎉🎉🎉\n? package 叫什么名字？ (demo) 项目路径/packages\n? package 叫什么名字？ demo\n? package 的 Node.js 服务端口？ 8001\n? package 的 webpack-dev-server 端口？ 8002\n✔  copy\n✔  +! 3 files added\n -> 项目路径/packages/demo/config.js\n -> 项目路径/packages/demo/package-lock.json\n -> 项目路径/packages/demo/package.json\n✔  npmInstall npm install ran correctly`, `94209466233503290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ cli create\n👽 👽 👽 欢迎使用 rux, 轻松构建 react ts 项目～🎉🎉🎉\n? package 叫什么名字？ <span class="token punctuation">(</span>demo<span class="token punctuation">)</span> 项目路径/packages\n? package 叫什么名字？ demo\n? package 的 Node.js 服务端口？ <span class="token number">8001</span>\n? package 的 webpack-dev-server 端口？ <span class="token number">8002</span>\n✔  copy\n✔  +<span class="token operator">!</span> <span class="token number">3</span> files added\n -<span class="token operator">></span> 项目路径/packages/demo/config.js\n -<span class="token operator">></span> 项目路径/packages/demo/package-lock.json\n -<span class="token operator">></span> 项目路径/packages/demo/package.json\n✔  npmInstall <span class="token function">npm</span> <span class="token function">install</span> ran correctly</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>// TODO 代码生成脚手架还在完成中</p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/代码生成脚手架搭建/index.md absPath of file >>> MarkdownRemark",timeToRead:10,frontmatter:{date:"2021-11-15 11:43:19",path:"/code-generation-scaffolding/",tags:"前端, 前端工程化, 预研",title:"代码生成脚手架搭建",draft:null}},{excerpt:"需求背景 基于公司的要求，需要对地图组件做出选型，以支持在地图上展示线路轨迹 技术选型 选型 优点 缺点 百度地图 大厂支持、UI 比较美观、API 文档较为清楚 内网搭建访问较为困难 高德地图 大厂支持、UI 比较美观、API 文档较为清楚 内网搭建访问较为困难 echarts 地图 UI 美观、API 文档较为清楚 内网搭建访问较为困难、功能较弱 天地图 支持离线访问、是专用地图 UI 不够美观、文档不够清楚 arcgis 支持离线访问、UI…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>基于公司的要求，需要对地图组件做出选型，以支持在地图上展示线路轨迹</p>\n<h1 id="技术选型"><a href="#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术选型</h1>\n<table>\n<thead>\n<tr>\n<th align="center">选型</th>\n<th align="center">优点</th>\n<th align="center">缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="center">百度地图</td>\n<td align="center">大厂支持、UI 比较美观、API 文档较为清楚</td>\n<td align="center">内网搭建访问较为困难</td>\n</tr>\n<tr>\n<td align="center">高德地图</td>\n<td align="center">大厂支持、UI 比较美观、API 文档较为清楚</td>\n<td align="center">内网搭建访问较为困难</td>\n</tr>\n<tr>\n<td align="center">echarts 地图</td>\n<td align="center">UI 美观、API 文档较为清楚</td>\n<td align="center">内网搭建访问较为困难、功能较弱</td>\n</tr>\n<tr>\n<td align="center">天地图</td>\n<td align="center">支持离线访问、是专用地图</td>\n<td align="center">UI 不够美观、文档不够清楚</td>\n</tr>\n<tr>\n<td align="center">arcgis</td>\n<td align="center">支持离线访问、UI 上可做到切换不同图层</td>\n<td align="center">文档不够清楚</td>\n</tr>\n</tbody>\n</table>\n<p>最终由于是内网相关的项目，需要支持离线访问，同时那边所采用的地图组件也是 arcgis，所以最终采用 arcgis</p>\n<h1 id="前期准备"><a href="#%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>前期准备</h1>\n<h2 id="三方库本地化"><a href="#%E4%B8%89%E6%96%B9%E5%BA%93%E6%9C%AC%E5%9C%B0%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>三方库本地化</h2>\n<p>考虑到在内网离线运行，所以要对 arcgis 的 js 库进行本地化，大致经历了以下过程：</p>\n<h3 id="配合内网验证-demo-静态文件服务器"><a href="#%E9%85%8D%E5%90%88%E5%86%85%E7%BD%91%E9%AA%8C%E8%AF%81-demo-%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配合内网验证 demo 静态文件服务器</h3>\n<p>直接使用 nginx 或者 http-server 静态服务器，将 arcgis 脚本地址改为本地</p>\n<h3 id="静态文件服务器托管"><a href="#%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%89%98%E7%AE%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>静态文件服务器托管</h3>\n<p>将 arcgis 三方库托管在静态文件服务器上，同时反代相关路径，这里的后端采用 koa 技术栈</p>\n<p>src\\server\\controllers\\stat-multi.controller.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91011738437044730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 访问地址的 css 路径：/stat-multi/arcgis/esri/themes/light/main.css\n// 访问地址的 url 路径：/stat-multi/arcgis/init.js\nconst config = require(\'config\'); // 全局配置\nconst proxy = require(\'http-proxy-middleware\');\nconst c2k = require(\'koa2-connect\');\n\nfunction proxyArcgis(ctx, next) {\n  const proxyMiddleware = c2k(\n    proxy({\n      target: config.arcgisMapHost,\n      // 对 /stat-multi/arcgis 开头的 url 进行反代\n      pathRewrite: (path) => path.replace(\'/stat-multi/arcgis\', \'\'),\n      onProxyRes: (proxyRes) => {\n        console.log(\'proxyRes\', proxyRes);\n        // proxyRes.headers[\'Cache-Control\'] = \'private,max-stale=0,max-age=0\'\n      },\n      onProxyReq: (proxyReq) => {\n        console.log(\'proxyReq\', proxyReq);\n      }\n    })\n  );\n  return proxyMiddleware(ctx, next);\n}\n\nproxyArcgis();`, `91011738437044730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 访问地址的 css 路径：/stat-multi/arcgis/esri/themes/light/main.css</span>\n<span class="token comment">// 访问地址的 url 路径：/stat-multi/arcgis/init.js</span>\n<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'config\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 全局配置</span>\n<span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'http-proxy-middleware\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> c2k <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'koa2-connect\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">proxyArcgis</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> proxyMiddleware <span class="token operator">=</span> <span class="token function">c2k</span><span class="token punctuation">(</span>\n    <span class="token function">proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      target<span class="token punctuation">:</span> config<span class="token punctuation">.</span>arcgisMapHost<span class="token punctuation">,</span>\n      <span class="token comment">// 对 /stat-multi/arcgis 开头的 url 进行反代</span>\n      <span class="token function-variable function">pathRewrite</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token operator">=></span> path<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'/stat-multi/arcgis\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token function-variable function">onProxyRes</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">proxyRes</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'proxyRes\'</span><span class="token punctuation">,</span> proxyRes<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// proxyRes.headers[\'Cache-Control\'] = \'private,max-stale=0,max-age=0\'</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token function-variable function">onProxyReq</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">proxyReq</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'proxyReq\'</span><span class="token punctuation">,</span> proxyReq<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token function">proxyMiddleware</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">proxyArcgis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="npm-私有库托管"><a href="#npm-%E7%A7%81%E6%9C%89%E5%BA%93%E6%89%98%E7%AE%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>npm 私有库托管</h3>\n<p>由于此三方库的静态文件服务器需要单独进行配置，略显繁琐，于是决定上传到公司 npm 私有库上，安装到后端对应的项目，并在后端以静态文件服务器的形式提供访问，这里后端采用 midway 技术栈</p>\n<p>server\\src\\config\\config.default.ts</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3563846861093189600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 访问地址的 css 路径：/static-apps/mut/arcgis/esri/themes/light/main.css\n// 访问地址的 url 路径：/static-apps/mut/arcgis/init.js\n\nconfig.static = {\n  prefix: \'/static-apps/mut\',\n  dir: [\n    path.join(appInfo.baseDir, \'app/public\'),\n    {\n      prefix: \'/static-apps/mut/arcgis\',\n      dir: path.join(process.cwd(), \'node_modules/上传到 npm 私有库的三方库/dist\'),\n      maxAge: 60 * 10 // 缓存 10 分钟\n    }\n  ]\n};`, `3563846861093189600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 访问地址的 css 路径：/static-apps/mut/arcgis/esri/themes/light/main.css</span>\n<span class="token comment">// 访问地址的 url 路径：/static-apps/mut/arcgis/init.js</span>\n\nconfig<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token punctuation">{</span>\n  prefix<span class="token punctuation">:</span> <span class="token string">\'/static-apps/mut\'</span><span class="token punctuation">,</span>\n  dir<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>appInfo<span class="token punctuation">.</span>baseDir<span class="token punctuation">,</span> <span class="token string">\'app/public\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      prefix<span class="token punctuation">:</span> <span class="token string">\'/static-apps/mut/arcgis\'</span><span class="token punctuation">,</span>\n      dir<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'node_modules/上传到 npm 私有库的三方库/dist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      maxAge<span class="token punctuation">:</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">10</span> <span class="token comment">// 缓存 10 分钟</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="内网图层验证"><a href="#%E5%86%85%E7%BD%91%E5%9B%BE%E5%B1%82%E9%AA%8C%E8%AF%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>内网图层验证</h2>\n<p>由于需要在内网离线运行，验证在内网 demo 是否能正常加载图层</p>\n<h3 id="react-arcgis"><a href="#react-arcgis" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-arcgis</h3>\n<p>首先确保没有多余的外网请求，在采用 <a href="https://github.com/Esri/react-arcgis" target="_blank" rel="nofollow noreferrer noopener">react-arcgis</a> 的过程中，发现无论采用什么图层也会加载 arcgis 的默认图层（在内网的情况下会阻塞内网图层的加载，同时也会对地图的加载速度造成影响），所以直接使用 <a href="https://github.com/Esri/esri-loader" target="_blank" rel="nofollow noreferrer noopener">esri-loader</a> 加载图层</p>\n<h3 id="esri-loader"><a href="#esri-loader" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>esri-loader</h3>\n<p>写出一个基本的 demo，在外网的情况下以天地图的图层进行访问，在内网以内部服务器返回的图层进行访问，在内网验证成功，未发现多余请求，主要验证代码如下：</p>\n<div>\n          <div\n            class="gatsby-resp-iframe-wrapper"\n            style="padding-bottom: 25%; position: relative; height: 0; overflow: hidden;margin-bottom: 2em"\n          >\n            <iframe src="/examples/arcgis-map-component-build-deploy/load-map-demo.html" style="\n            position: absolute;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n          "></iframe>\n          </div>\n          </div>\n<p><div class="gatsby-highlight">\n        <pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span>\n      <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span>\n      <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>initial-scale=1,maximum-scale=1,user-scalable=no<span class="token punctuation">"</span></span>\n    <span class="token punctuation">/></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>\n      Intro to MapView - Create a 2D map | Sample | ArcGIS API for JavaScript\n      4.18\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">\n      <span class="token selector">html,\n      body,\n      #viewDiv</span> <span class="token punctuation">{</span>\n        <span class="token property">padding</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>\n        <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>\n        <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>\n        <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>\n\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://js.arcgis.com/4.16/<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>\n\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">\n      <span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n        <span class="token string">"esri/Map"</span><span class="token punctuation">,</span>\n        <span class="token string">"esri/views/MapView"</span><span class="token punctuation">,</span>\n        <span class="token string">"esri/layers/WebTileLayer"</span>\n      <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">Map<span class="token punctuation">,</span> MapView<span class="token punctuation">,</span> WebTileLayer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 天地图加载图层，这里可以替换为内网服务器的图层</span>\n        <span class="token comment">// mapLayerUrlTemplate: 矢量底图经纬度投影</span>\n        <span class="token comment">// markerLayerUrlTemplate: 矢量注记经纬度投影</span>\n        <span class="token comment">// subDomains: 占位符</span>\n        <span class="token keyword">const</span> mapLayerUrlTemplate <span class="token operator">=</span> <span class="token string">\'http://{subDomain}.tianditu.gov.cn/vec_w/wmts?SERVICE=WMTS&amp;REQUEST=GetTile&amp;VERSION=1.0.0&amp;LAYER=vec&amp;STYLE=default&amp;TILEMATRIXSET=w&amp;FORMAT=tiles&amp;TILEMATRIX={level}&amp;TILEROW={row}&amp;TILECOL={col}&amp;tk=f73eace6fbf7a640861984ea1b3ffa07\'</span>\n        <span class="token keyword">const</span> markerLayerUrlTemplate <span class="token operator">=</span> <span class="token string">\'http://{subDomain}.tianditu.gov.cn/cva_w/wmts?SERVICE=WMTS&amp;REQUEST=GetTile&amp;VERSION=1.0.0&amp;LAYER=cva&amp;STYLE=default&amp;TILEMATRIXSET=w&amp;FORMAT=tiles&amp;TILEMATRIX={level}&amp;TILEROW={row}&amp;TILECOL={col}&amp;tk=f73eace6fbf7a640861984ea1b3ffa07\'</span>\n        <span class="token keyword">const</span> subDomains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'t0\'</span><span class="token punctuation">,</span> <span class="token string">\'t1\'</span><span class="token punctuation">,</span> <span class="token string">\'t2\'</span><span class="token punctuation">,</span> <span class="token string">\'t3\'</span><span class="token punctuation">,</span> <span class="token string">\'t4\'</span><span class="token punctuation">,</span> <span class="token string">\'t5\'</span><span class="token punctuation">,</span> <span class="token string">\'t6\'</span><span class="token punctuation">,</span> <span class="token string">\'t7\'</span><span class="token punctuation">]</span>\n\n        <span class="token keyword">const</span> mapLayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebTileLayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          urlTemplate<span class="token punctuation">:</span> mapLayerUrlTemplate<span class="token punctuation">,</span>\n          subDomains\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n        <span class="token keyword">const</span> markerLayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebTileLayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          urlTemplate<span class="token punctuation">:</span> markerLayerUrlTemplate<span class="token punctuation">,</span>\n          subDomains\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n        <span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          layers<span class="token punctuation">:</span> <span class="token punctuation">[</span>mapLayer<span class="token punctuation">,</span> markerLayer<span class="token punctuation">]</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">const</span> view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapView</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          container<span class="token punctuation">:</span> <span class="token string">"viewDiv"</span><span class="token punctuation">,</span>\n          map<span class="token punctuation">,</span>\n          zoom<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>\n          center<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token punctuation">,</span> <span class="token number">38</span><span class="token punctuation">]</span> <span class="token comment">// longitude, latitude</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        view<span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>\n          <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'地图加载完成\'</span><span class="token punctuation">)</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          <span class="token parameter">error</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'地图加载失败\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>\n\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewDiv<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>\n        </div></p>\n<h2 id="经纬度修复"><a href="#%E7%BB%8F%E7%BA%AC%E5%BA%A6%E4%BF%AE%E5%A4%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>经纬度修复</h2>\n<p>在地图上加载公司数据组给的数据时，发现有很多地点对应的经纬度有偏差，需要对数据组的经纬度数据修复</p>\n<h3 id="外网天地图修复脚本"><a href="#%E5%A4%96%E7%BD%91%E5%A4%A9%E5%9C%B0%E5%9B%BE%E4%BF%AE%E5%A4%8D%E8%84%9A%E6%9C%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>外网天地图修复脚本</h3>\n<p>核心逻辑：</p>\n<ol>\n<li>申请天地图服务器端的 key，确保根据地点获取地点详情接口请求成功</li>\n<li>考虑到天地图开放 API 可能有频率限制，采用串行逻辑请求接口</li>\n<li>更新数据库时采用增量更新的方式，即需要判断写入的 lat 或 lon 字段是否已写入，每次查出未写入的再进行更新</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69280321441688650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const request = require(\'request\');\nconst lodash = require(\'lodash\');\nconst ProgressBar = require(\'progress\');\n\nconst { sequelize } = require(\'./sequelize.js\');\nconst { targetTable } = require(\'./config.js\');\n\n// curl --connect-timeout 999999 -m 999999 \'http://localhost:8000/stat-multi/train-analysis/get-all-station-info?isUseTianDiTuApi=1&isUpdateDatabase=1&pageSize=1000\'\n// http://api.tianditu.gov.cn/geocoder?ds={&quot;keyWord&quot;:&quot;弯坵火车站&quot;}&tk=f73eace6fbf7a640861984ea1b3ffa07\nasync function updateGps(params = {}) {\n  const { isUseTianDiTuApi, isUpdateDatabase, pageSize = 10, current = 1 } = params;\n  const offset = (current - 1) * pageSize;\n  const sql = \\`select * from \\${targetTable} where lat is null or lon is null order by zmdm limit \\${pageSize} offset \\${offset}\\`;\n  const rsp = await sequelize.query(sql, {\n    type: sequelize.QueryTypes.SELECT\n  });\n  function getTianDiTuInfo(keyword) {\n    const tianDiTuApiUrl = \'http://api.tianditu.gov.cn\';\n    const token = \'ab61c4d11eab1728b7f6ff48639bc73e\';\n    return new Promise((resolve, reject) => {\n      request(\n        {\n          method: \'GET\',\n          url: encodeURI(\\`\\${tianDiTuApiUrl}/geocoder?ds={&quot;keyWord&quot;:&quot;\\${keyword}&quot;}&tk=\\${token}\\`),\n          timeout: 10000\n        },\n        (error, response) => {\n          if (error) {\n            reject(error);\n          } else {\n            resolve(response.body);\n          }\n        }\n      );\n    });\n  }\n\n  async function getListByKeyword() {\n    const list = [];\n    const bar = new ProgressBar(\'更新中 [:bar] :rate/bps :percent :etas\', { total: rsp.length });\n    for (const item of rsp) {\n      const rsp2 = await getTianDiTuInfo(\\`\\${item.zm}火车站\\`);\n      const response = JSON.parse(rsp2);\n      const lon = lodash.get(response, \'location.lon\');\n      const lat = lodash.get(response, \'location.lat\');\n      if (isUpdateDatabase) {\n        const sql = \\`update \\${targetTable} set lat=\'\\${lat}\', lon=\'\\${lon}\' where zmdm=\'\\${item.zmdm}\'\\`;\n        const rsp3 = await sequelize.query(sql, {\n          type: sequelize.QueryTypes.UPDATE\n        });\n        bar.tick();\n        // console.log(rsp3)\n      }\n      list.push({\n        ...item,\n        lon,\n        lat\n      });\n    }\n    if (bar.complete) {\n      console.log(\'\\n刷新数据库完成\\n\');\n    }\n    return list;\n  }\n\n  if (isUseTianDiTuApi) {\n    return getListByKeyword();\n  }\n  return rsp;\n}\n\nupdateGps({\n  isUseTianDiTuApi: true, // 是否使用天地图 API 获取经纬度\n  isUpdateDatabase: true, // 是否更新数据库\n  current: 1, // 当前页\n  pageSize: 100 // 第几页\n}).then((rsp) => {\n  console.log(\\`\\${rsp.length} 个数据更新成功\\`);\n  process.exit(0);\n});`, `69280321441688650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'request\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> lodash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> ProgressBar <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'progress\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> sequelize <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./sequelize.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> targetTable <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./config.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// curl --connect-timeout 999999 -m 999999 \'http://localhost:8000/stat-multi/train-analysis/get-all-station-info?isUseTianDiTuApi=1&amp;isUpdateDatabase=1&amp;pageSize=1000\'</span>\n<span class="token comment">// http://api.tianditu.gov.cn/geocoder?ds={"keyWord":"弯坵火车站"}&amp;tk=f73eace6fbf7a640861984ea1b3ffa07</span>\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">updateGps</span><span class="token punctuation">(</span><span class="token parameter">params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> isUseTianDiTuApi<span class="token punctuation">,</span> isUpdateDatabase<span class="token punctuation">,</span> pageSize <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> current <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token operator">=</span> params<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> offset <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">select * from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>targetTable<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> where lat is null or lon is null order by zmdm limit </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageSize<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> offset </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>offset<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> rsp <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    type<span class="token punctuation">:</span> sequelize<span class="token punctuation">.</span>QueryTypes<span class="token punctuation">.</span><span class="token constant">SELECT</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">function</span> <span class="token function">getTianDiTuInfo</span><span class="token punctuation">(</span><span class="token parameter">keyword</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> tianDiTuApiUrl <span class="token operator">=</span> <span class="token string">\'http://api.tianditu.gov.cn\'</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token string">\'ab61c4d11eab1728b7f6ff48639bc73e\'</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token function">request</span><span class="token punctuation">(</span>\n        <span class="token punctuation">{</span>\n          method<span class="token punctuation">:</span> <span class="token string">\'GET\'</span><span class="token punctuation">,</span>\n          url<span class="token punctuation">:</span> <span class="token function">encodeURI</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tianDiTuApiUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/geocoder?ds={"keyWord":"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>keyword<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"}&amp;tk=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n          timeout<span class="token punctuation">:</span> <span class="token number">10000</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            <span class="token function">resolve</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getListByKeyword</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProgressBar</span><span class="token punctuation">(</span><span class="token string">\'更新中 [:bar] :rate/bps :percent :etas\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> total<span class="token punctuation">:</span> rsp<span class="token punctuation">.</span>length <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> item <span class="token keyword">of</span> rsp<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> rsp2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getTianDiTuInfo</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zm<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">火车站</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>rsp2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> lon <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">\'location.lon\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> lat <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">\'location.lat\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>isUpdateDatabase<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">update </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>targetTable<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> set lat=\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lat<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\', lon=\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lon<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\' where zmdm=\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zmdm<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> rsp3 <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n          type<span class="token punctuation">:</span> sequelize<span class="token punctuation">.</span>QueryTypes<span class="token punctuation">.</span><span class="token constant">UPDATE</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        bar<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// console.log(rsp3)</span>\n      <span class="token punctuation">}</span>\n      list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n        <span class="token operator">...</span>item<span class="token punctuation">,</span>\n        lon<span class="token punctuation">,</span>\n        lat\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>bar<span class="token punctuation">.</span>complete<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'\\n刷新数据库完成\\n\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">return</span> list<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>isUseTianDiTuApi<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token function">getListByKeyword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> rsp<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">updateGps</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  isUseTianDiTuApi<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 是否使用天地图 API 获取经纬度</span>\n  isUpdateDatabase<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 是否更新数据库</span>\n  current<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 当前页</span>\n  pageSize<span class="token punctuation">:</span> <span class="token number">100</span> <span class="token comment">// 第几页</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rsp</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>rsp<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个数据更新成功</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="内网修复脚本"><a href="#%E5%86%85%E7%BD%91%E4%BF%AE%E5%A4%8D%E8%84%9A%E6%9C%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>内网修复脚本</h3>\n<p>在以上的版本上，核心逻辑多了以下功能：</p>\n<ol>\n<li>内网接口返回的经纬度单位是转换墨卡托投影单位，需要用 gcoord 三方库做转换</li>\n<li>get 参数处理</li>\n<li>增加成功、失败总数统计</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23876061249563430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const request = require(\'request\');\nconst lodash = require(\'lodash\');\nconst ProgressBar = require(\'progress\');\nconst gcoord = require(\'gcoord\');\n\n// const result = gcoord.transform(\n//   [12580093.358100001, 3273944.1777000017],    // 经纬度坐标\n//   gcoord.WebMercator,               // 当前坐标系\n//   gcoord.WGS84                 // 目标坐标系\n// );\n\n// console.log(result)\n\nconst { sequelize } = require(\'./sequelize.js\');\nconst { targetTable } = require(\'./config.js\');\nconst { withExtraQuery } = require(\'./utils\');\n\nfunction getInfoByZm(searchText) {\n  // const apiUrl = \'http://api.tianditu.gov.cn/geocoder\'\n  // const token = \'ab61c4d11eab1728b7f6ff48639bc73e\'\n  // const url = encodeURI(\\`\\${apiUrl}/geocoder?ds={&quot;keyWord&quot;:&quot;\\${searchText}&quot;}&tk=\\${token}\\`)\n\n  const apiUrl = \'http://10.160.9.49:8080/OneMapServer/rest/services/SEARCH_QGCZ/Transfer/find\';\n  const params = {\n    f: \'json\',\n    searchText,\n    contains: false,\n    layers: \'0\',\n    searchFields: \'name,label\'\n  };\n  const url = withExtraQuery(apiUrl, params);\n  // console.log(url)\n  return new Promise((resolve, reject) => {\n    request(\n      {\n        method: \'GET\',\n        url,\n        timeout: 10000\n      },\n      (error, response) => {\n        if (error) {\n          reject(error);\n        } else {\n          resolve(response.body);\n        }\n      }\n    );\n  });\n}\n\nasync function updateList(rsp, isUpdate) {\n  const list = [];\n  const bar = new ProgressBar(\'更新中 [:bar] :rate/bps :percent :etas 第 :current 个 总共 :total 个\', {\n    total: rsp.length\n  });\n  let successTotal = 0;\n  let failTotal = 0;\n  for (const item of rsp) {\n    try {\n      const rsp2 = await getInfoByZm(item.zm.trim());\n\n      const response = JSON.parse(rsp2);\n      // 墨卡托投影单位，需要做转换\n      const x = lodash.get(response, \'results[0].geometry.x\');\n      const y = lodash.get(response, \'results[0].geometry.y\');\n\n      let lon = x;\n      let lat = y;\n      if (x && y) {\n        const result = gcoord.transform(\n          [x, y], // 坐标\n          gcoord.WebMercator, // 当前坐标系\n          gcoord.WGS84 // 目标坐标系\n        );\n        lon = result[0];\n        lat = result[1];\n      }\n\n      // const lon = lodash.get(response, \'location.lon\')\n      // const lat = lodash.get(response, \'location.lat\')\n\n      if (isUpdate) {\n        const sql = \\`update \\${targetTable} set lat=\'\\${lat}\', lon=\'\\${lon}\' where zmdm=\'\\${item.zmdm}\'\\`;\n        const rsp3 = await sequelize.query(sql, {\n          type: sequelize.QueryTypes.UPDATE\n        });\n        successTotal += 1;\n        bar.tick();\n      }\n      list.push({\n        ...item,\n        lon,\n        lat\n      });\n    } catch (error) {\n      console.log(error);\n      if (isUpdate) {\n        bar.tick();\n        failTotal += 1;\n      }\n    }\n  }\n  if (bar.complete) {\n    console.log(\\`\\${successTotal} 个数据更新成功，\\${failTotal} 个数据更新失败\\`);\n  }\n  return list;\n}\n\n// isUseApi: 是否使用 api 查询地理坐标\n// isUpdate: 是否同步到数据库\nasync function getGps(params = {}) {\n  const { isUseApi, isUpdate, pageSize, current } = params;\n  const offset = (current - 1) * pageSize;\n  const sql = \\`select * from \\${targetTable} where lat is null or lon is null order by zmdm limit \\${pageSize} offset \\${offset}\\`;\n  const rsp = await sequelize.query(sql, {\n    type: sequelize.QueryTypes.SELECT\n  });\n\n  if (isUseApi) {\n    return updateList(rsp, isUpdate);\n  }\n  return rsp;\n}\n\ngetGps({\n  isUseApi: true,\n  isUpdate: true,\n  current: 1,\n  pageSize: 1000\n}).then((rsp) => {\n  // console.log(rsp)\n  process.exit(0);\n});`, `23876061249563430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'request\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> lodash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> ProgressBar <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'progress\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> gcoord <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'gcoord\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// const result = gcoord.transform(</span>\n<span class="token comment">//   [12580093.358100001, 3273944.1777000017],    // 经纬度坐标</span>\n<span class="token comment">//   gcoord.WebMercator,               // 当前坐标系</span>\n<span class="token comment">//   gcoord.WGS84                 // 目标坐标系</span>\n<span class="token comment">// );</span>\n\n<span class="token comment">// console.log(result)</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> sequelize <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./sequelize.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> targetTable <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./config.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> withExtraQuery <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./utils\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">getInfoByZm</span><span class="token punctuation">(</span><span class="token parameter">searchText</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// const apiUrl = \'http://api.tianditu.gov.cn/geocoder\'</span>\n  <span class="token comment">// const token = \'ab61c4d11eab1728b7f6ff48639bc73e\'</span>\n  <span class="token comment">// const url = encodeURI(`${apiUrl}/geocoder?ds={"keyWord":"${searchText}"}&amp;tk=${token}`)</span>\n\n  <span class="token keyword">const</span> apiUrl <span class="token operator">=</span> <span class="token string">\'http://10.160.9.49:8080/OneMapServer/rest/services/SEARCH_QGCZ/Transfer/find\'</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>\n    f<span class="token punctuation">:</span> <span class="token string">\'json\'</span><span class="token punctuation">,</span>\n    searchText<span class="token punctuation">,</span>\n    contains<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    layers<span class="token punctuation">:</span> <span class="token string">\'0\'</span><span class="token punctuation">,</span>\n    searchFields<span class="token punctuation">:</span> <span class="token string">\'name,label\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token function">withExtraQuery</span><span class="token punctuation">(</span>apiUrl<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// console.log(url)</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">request</span><span class="token punctuation">(</span>\n      <span class="token punctuation">{</span>\n        method<span class="token punctuation">:</span> <span class="token string">\'GET\'</span><span class="token punctuation">,</span>\n        url<span class="token punctuation">,</span>\n        timeout<span class="token punctuation">:</span> <span class="token number">10000</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n          <span class="token function">resolve</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">updateList</span><span class="token punctuation">(</span><span class="token parameter">rsp<span class="token punctuation">,</span> isUpdate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProgressBar</span><span class="token punctuation">(</span><span class="token string">\'更新中 [:bar] :rate/bps :percent :etas 第 :current 个 总共 :total 个\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    total<span class="token punctuation">:</span> rsp<span class="token punctuation">.</span>length\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> successTotal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> failTotal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> item <span class="token keyword">of</span> rsp<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> rsp2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getInfoByZm</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>zm<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>rsp2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 墨卡托投影单位，需要做转换</span>\n      <span class="token keyword">const</span> x <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">\'results[0].geometry.x\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> y <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">\'results[0].geometry.y\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">let</span> lon <span class="token operator">=</span> x<span class="token punctuation">;</span>\n      <span class="token keyword">let</span> lat <span class="token operator">=</span> y<span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&amp;&amp;</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> result <span class="token operator">=</span> gcoord<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>\n          <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 坐标</span>\n          gcoord<span class="token punctuation">.</span>WebMercator<span class="token punctuation">,</span> <span class="token comment">// 当前坐标系</span>\n          gcoord<span class="token punctuation">.</span><span class="token constant">WGS84</span> <span class="token comment">// 目标坐标系</span>\n        <span class="token punctuation">)</span><span class="token punctuation">;</span>\n        lon <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n        lat <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// const lon = lodash.get(response, \'location.lon\')</span>\n      <span class="token comment">// const lat = lodash.get(response, \'location.lat\')</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>isUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">update </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>targetTable<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> set lat=\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lat<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\', lon=\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lon<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\' where zmdm=\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zmdm<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> rsp3 <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n          type<span class="token punctuation">:</span> sequelize<span class="token punctuation">.</span>QueryTypes<span class="token punctuation">.</span><span class="token constant">UPDATE</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        successTotal <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n        bar<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n        <span class="token operator">...</span>item<span class="token punctuation">,</span>\n        lon<span class="token punctuation">,</span>\n        lat\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>isUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        bar<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        failTotal <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>bar<span class="token punctuation">.</span>complete<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>successTotal<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个数据更新成功，</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>failTotal<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个数据更新失败</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> list<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// isUseApi: 是否使用 api 查询地理坐标</span>\n<span class="token comment">// isUpdate: 是否同步到数据库</span>\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getGps</span><span class="token punctuation">(</span><span class="token parameter">params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> isUseApi<span class="token punctuation">,</span> isUpdate<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> current <span class="token punctuation">}</span> <span class="token operator">=</span> params<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> offset <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">select * from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>targetTable<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> where lat is null or lon is null order by zmdm limit </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageSize<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> offset </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>offset<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> rsp <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    type<span class="token punctuation">:</span> sequelize<span class="token punctuation">.</span>QueryTypes<span class="token punctuation">.</span><span class="token constant">SELECT</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>isUseApi<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token function">updateList</span><span class="token punctuation">(</span>rsp<span class="token punctuation">,</span> isUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> rsp<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">getGps</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  isUseApi<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  isUpdate<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  current<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n  pageSize<span class="token punctuation">:</span> <span class="token number">1000</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rsp</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// console.log(rsp)</span>\n  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>内网执行脚本刷新结果：共 <code class="language-text">8493</code> 条数据，<code class="language-text">2038</code> 条查不出结果(部分原因是命名不规范或者不存在这个站)，<code class="language-text">6455</code> 条查出经纬度并完成入库</p>\n<h3 id="脚本执行线程池化"><a href="#%E8%84%9A%E6%9C%AC%E6%89%A7%E8%A1%8C%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>脚本执行线程池化</h3>\n<p>在以上的版本上，利用线程池的概念优化取数逻辑</p>\n<ol>\n<li>请求接口线程池化</li>\n<li>数据库数据更新线程池化</li>\n<li>数据库批量更新数据</li>\n</ol>\n<h4 id="带有并发数限制的异步任务"><a href="#%E5%B8%A6%E6%9C%89%E5%B9%B6%E5%8F%91%E6%95%B0%E9%99%90%E5%88%B6%E7%9A%84%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>带有并发数限制的异步任务</h4>\n<p>concurrentRun.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97746265924444240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/**\n * 执行多个异步任务\n * @param {*} fnList 任务列表\n * @param {*} max 最大并发数限制\n * @param {*} taskName 任务名称\n */\nmodule.exports = async function concurrentRun(fnList = [], max = 5, taskName = \'未命名\') {\n  if (!fnList.length) return;\n\n  console.log(\\`开始执行多个异步任务，最大并发数： \\${max}\\`);\n  const replyList = []; // 收集任务执行结果\n  const count = fnList.length; // 总任务数量\n  const startTime = new Date().getTime(); // 记录任务执行开始时间\n\n  let current = 0;\n  // 任务执行程序\n  const schedule = async (index) => {\n    return new Promise(async (resolve) => {\n      try {\n        const fn = fnList[index];\n        if (!fn) return resolve();\n\n        // 执行当前异步任务\n        const reply = await fn();\n        replyList[index] = reply;\n      } catch (e) {\n        console.log(e);\n        // 报错了不管继续下一个\n        resolve();\n      }\n\n      current++;\n      console.log(\n        \\`\\${taskName} 事务进度，第 \\${current} 个，共 \\${count} 个，进度为 \\${((current / count) * 100).toFixed(2)}% \\`\n      );\n\n      // 执行完当前任务后，继续执行任务池的剩余任务\n      await schedule(index + max);\n      resolve();\n    });\n  };\n\n  // 任务池执行程序\n  const scheduleList = new Array(max).fill(0).map((_, index) => schedule(index));\n  // 使用 Promise.all 批量执行\n  const r = await Promise.all(scheduleList);\n\n  const cost = (new Date().getTime() - startTime) / 1000;\n  console.log(\\`执行完成，最大并发数： \\${max}，耗时：\\${cost}s\\`);\n  return replyList;\n};`, `97746265924444240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/**\n * 执行多个异步任务\n * @param {*} fnList 任务列表\n * @param {*} max 最大并发数限制\n * @param {*} taskName 任务名称\n */</span>\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">concurrentRun</span><span class="token punctuation">(</span>fnList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> max <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> taskName <span class="token operator">=</span> <span class="token string">\'未命名\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fnList<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>\n\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">开始执行多个异步任务，最大并发数： </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>max<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> replyList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 收集任务执行结果</span>\n  <span class="token keyword">const</span> count <span class="token operator">=</span> fnList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token comment">// 总任务数量</span>\n  <span class="token keyword">const</span> startTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录任务执行开始时间</span>\n\n  <span class="token keyword">let</span> current <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token comment">// 任务执行程序</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">schedule</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">try</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> fn <span class="token operator">=</span> fnList<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// 执行当前异步任务</span>\n        <span class="token keyword">const</span> reply <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        replyList<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> reply<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// 报错了不管继续下一个</span>\n        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      current<span class="token operator">++</span><span class="token punctuation">;</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>\n        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>taskName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 事务进度，第 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>current<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个，共 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个，进度为 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token punctuation">(</span><span class="token punctuation">(</span>current <span class="token operator">/</span> count<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">% </span><span class="token template-punctuation string">`</span></span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 执行完当前任务后，继续执行任务池的剩余任务</span>\n      <span class="token keyword">await</span> <span class="token function">schedule</span><span class="token punctuation">(</span>index <span class="token operator">+</span> max<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 任务池执行程序</span>\n  <span class="token keyword">const</span> scheduleList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">schedule</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 使用 Promise.all 批量执行</span>\n  <span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>scheduleList<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> cost <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">执行完成，最大并发数： </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>max<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">，耗时：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cost<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">s</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> replyList<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="请求接口并发执行数据更新并发执行"><a href="#%E8%AF%B7%E6%B1%82%E6%8E%A5%E5%8F%A3%E5%B9%B6%E5%8F%91%E6%89%A7%E8%A1%8C%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0%E5%B9%B6%E5%8F%91%E6%89%A7%E8%A1%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>请求接口并发执行/数据更新并发执行</h4>\n<p>index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60881973867709686000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const request = require(\'request\');\nconst lodash = require(\'lodash\');\n\nconst { sequelize } = require(\'./sequelize.js\');\nconst { targetTable } = require(\'./config.js\');\nconst concurrentRun = require(\'./concurrentRun.js\');\n\nfunction getInfoByZm(keyword) {\n  const tianDiTuApiUrl = \'http://api.tianditu.gov.cn\';\n  const token = \'ab61c4d11eab1728b7f6ff48639bc73e\';\n  return new Promise((resolve, reject) => {\n    request(\n      {\n        method: \'GET\',\n        url: encodeURI(\\`\\${tianDiTuApiUrl}/geocoder?ds={&quot;keyWord&quot;:&quot;\\${keyword}&quot;}&tk=\\${token}\\`),\n        timeout: 10000\n      },\n      (error, response) => {\n        if (error) {\n          reject(error);\n        } else {\n          resolve(response.body);\n        }\n      }\n    );\n  });\n}\n\nasync function updateDataBase(rsp) {\n  const zmdms = [];\n  const lons = [];\n  const lats = [];\n  rsp.forEach((item) => {\n    const lon = lodash.get(item.response, \'location.lon\');\n    const lat = lodash.get(item.response, \'location.lat\');\n    zmdms.push(\\`\'\\${item.zmdm}\'\\`);\n    lons.push(\\`when \'\\${item.zmdm}\' then \'\\${lon}\'\\`);\n    lats.push(\\`when \'\\${item.zmdm}\' then \'\\${lat}\'\\`);\n  });\n\n  const sql = \\`\n    update \\${targetTable} set\n    lon = case zmdm \\${lons.join(\' \')} end,\n    lat = case zmdm \\${lats.join(\' \')} end\n    where zmdm in (\\${zmdms.join(\',\')})\n  \\`;\n\n  const rsp3 = await sequelize.query(sql, {\n    type: sequelize.QueryTypes.UPDATE\n  });\n}\n\nasync function updateList(rsp, isUpdate) {\n  const requestFnList = rsp.map((item) => () => getInfoByZm(\\`\\${item.zm.trim()}火车站\\`));\n\n  const list = await concurrentRun(requestFnList, 100, \'请求天地图\');\n\n  const result = rsp.map((item, index) => {\n    try {\n      return {\n        ...item,\n        response: JSON.parse(list[index])\n      };\n    } catch (e) {\n      return item;\n    }\n  });\n\n  if (isUpdate) {\n    // 每 100 个分隔成一组\n    const updateFnList = lodash.chunk(result, 100).map((item) => () => updateDataBase(item));\n\n    await concurrentRun(updateFnList, 5, \'保存到数据库\');\n  }\n  return list;\n}\n\n// isUseApi: 是否使用 api 查询地理坐标\n// isUpdate: 是否同步到数据库\n// pageSize:\nasync function getGps(params = {}) {\n  const { isUseApi, isUpdate, pageSize = 10, current = 1 } = params;\n  const offset = (current - 1) * pageSize;\n  const sql = \\`select * from \\${targetTable} where lat is null or lon is null order by zmdm limit \\${pageSize} offset \\${offset}\\`;\n  const rsp = await sequelize.query(sql, {\n    type: sequelize.QueryTypes.SELECT\n  });\n\n  if (isUseApi) {\n    return updateList(rsp, isUpdate);\n  }\n  return rsp;\n}\n\ngetGps({\n  isUseApi: true,\n  isUpdate: true,\n  current: 1,\n  pageSize: 9000\n}).then((rsp) => {\n  // console.log(rsp)\n  process.exit(0);\n});`, `60881973867709686000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'request\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> lodash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> sequelize <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./sequelize.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> targetTable <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./config.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> concurrentRun <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./concurrentRun.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">getInfoByZm</span><span class="token punctuation">(</span><span class="token parameter">keyword</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> tianDiTuApiUrl <span class="token operator">=</span> <span class="token string">\'http://api.tianditu.gov.cn\'</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token string">\'ab61c4d11eab1728b7f6ff48639bc73e\'</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">request</span><span class="token punctuation">(</span>\n      <span class="token punctuation">{</span>\n        method<span class="token punctuation">:</span> <span class="token string">\'GET\'</span><span class="token punctuation">,</span>\n        url<span class="token punctuation">:</span> <span class="token function">encodeURI</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tianDiTuApiUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/geocoder?ds={"keyWord":"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>keyword<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"}&amp;tk=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        timeout<span class="token punctuation">:</span> <span class="token number">10000</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n          <span class="token function">resolve</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">updateDataBase</span><span class="token punctuation">(</span><span class="token parameter">rsp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> zmdms <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> lons <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> lats <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  rsp<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> lon <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>response<span class="token punctuation">,</span> <span class="token string">\'location.lon\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> lat <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>response<span class="token punctuation">,</span> <span class="token string">\'location.lat\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    zmdms<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zmdm<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    lons<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">when \'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zmdm<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\' then \'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lon<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    lats<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">when \'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zmdm<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\' then \'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lat<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n    update </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>targetTable<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> set\n    lon = case zmdm </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lons<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\' \'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> end,\n    lat = case zmdm </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lats<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\' \'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> end\n    where zmdm in (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>zmdms<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\',\'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)\n  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> rsp3 <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    type<span class="token punctuation">:</span> sequelize<span class="token punctuation">.</span>QueryTypes<span class="token punctuation">.</span><span class="token constant">UPDATE</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">updateList</span><span class="token punctuation">(</span><span class="token parameter">rsp<span class="token punctuation">,</span> isUpdate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> requestFnList <span class="token operator">=</span> rsp<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">getInfoByZm</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zm<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">火车站</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">concurrentRun</span><span class="token punctuation">(</span>requestFnList<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">\'请求天地图\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> result <span class="token operator">=</span> rsp<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token punctuation">{</span>\n        <span class="token operator">...</span>item<span class="token punctuation">,</span>\n        response<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>list<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> item<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>isUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 每 100 个分隔成一组</span>\n    <span class="token keyword">const</span> updateFnList <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">chunk</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">updateDataBase</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">await</span> <span class="token function">concurrentRun</span><span class="token punctuation">(</span>updateFnList<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">\'保存到数据库\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> list<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// isUseApi: 是否使用 api 查询地理坐标</span>\n<span class="token comment">// isUpdate: 是否同步到数据库</span>\n<span class="token comment">// pageSize:</span>\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getGps</span><span class="token punctuation">(</span><span class="token parameter">params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> isUseApi<span class="token punctuation">,</span> isUpdate<span class="token punctuation">,</span> pageSize <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> current <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token operator">=</span> params<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> offset <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">select * from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>targetTable<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> where lat is null or lon is null order by zmdm limit </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageSize<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> offset </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>offset<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> rsp <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    type<span class="token punctuation">:</span> sequelize<span class="token punctuation">.</span>QueryTypes<span class="token punctuation">.</span><span class="token constant">SELECT</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>isUseApi<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token function">updateList</span><span class="token punctuation">(</span>rsp<span class="token punctuation">,</span> isUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> rsp<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">getGps</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  isUseApi<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  isUpdate<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  current<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n  pageSize<span class="token punctuation">:</span> <span class="token number">9000</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rsp</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// console.log(rsp)</span>\n  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="执行结果"><a href="#%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>执行结果</h4>\n<p>以 1000 个数据为例</p>\n<p>不带并行执行情况：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58721745208922220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`1000 个数据更新成功，0 个数据更新失败\nDone in 168.70s.`, `58721745208922220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">1000 个数据更新成功，0 个数据更新失败\nDone in 168.70s.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>带并行执行情况：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18876815964317740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`开始执行多个异步任务，最大并发数： 100\n执行完成，最大并发数： 100，耗时：19.954s\n开始执行多个异步任务，最大并发数： 5\n执行完成，最大并发数： 5，耗时：0.289s\nDone in 21.41s.`, `18876815964317740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">开始执行多个异步任务，最大并发数： 100\n执行完成，最大并发数： 100，耗时：19.954s\n开始执行多个异步任务，最大并发数： 5\n执行完成，最大并发数： 5，耗时：0.289s\nDone in 21.41s.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="人工修复"><a href="#%E4%BA%BA%E5%B7%A5%E4%BF%AE%E5%A4%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>人工修复</h3>\n<p>经过以上修复，还是有部分数据未查到结果，最终采用内部（另外合作商）经纬度去修复</p>\n<h1 id="组件设计"><a href="#%E7%BB%84%E4%BB%B6%E8%AE%BE%E8%AE%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>组件设计</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="795930512120590600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`.\n├── api.js # api 请求，主要用来获取地图配置\n├── components\n│   ├── map\n│   │   ├── hooks\n│   │   │   ├── use-goto-map.js # 地图导航\n│   │   │   └── use-load-map.js # 地图加载\n│   │   └── index.jsx # 地图组件主入口\n│   └── route-display-layer\n│       ├── hooks\n│       │   ├── use-add-or-del-point.js # 设置删除、添加的监听事件\n│       │   ├── use-draw-line # 画地图上的线\n│       │   │   ├── const.js\n│       │   │   └── index.js\n│       │   ├── use-draw-point # 画地图上的非选中的点\n│       │   │   └── index.js\n│       │   ├── use-draw-start-pass-end # 画地图上的选中点\n│       │   │   ├── images\n│       │   │   │   ├── 圆心.png\n│       │   │   │   ├── 定位_终点.svg\n│       │   │   │   ├── 定位_起点.svg\n│       │   │   │   └── 定位_途点.svg\n│       │   │   └── index.js\n│       │   └── use-show-hover-text.js # 设置悬浮文字\n│       ├── index.jsx # 路线组件主入口\n│       └── styles.less\n├── index.jsx # 主入口文件\n└── styles.less`, `795930512120590600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token builtin class-name">.</span>\n├── api.js <span class="token comment"># api 请求，主要用来获取地图配置</span>\n├── components\n│   ├── map\n│   │   ├── hooks\n│   │   │   ├── use-goto-map.js <span class="token comment"># 地图导航</span>\n│   │   │   └── use-load-map.js <span class="token comment"># 地图加载</span>\n│   │   └── index.jsx <span class="token comment"># 地图组件主入口</span>\n│   └── route-display-layer\n│       ├── hooks\n│       │   ├── use-add-or-del-point.js <span class="token comment"># 设置删除、添加的监听事件</span>\n│       │   ├── use-draw-line <span class="token comment"># 画地图上的线</span>\n│       │   │   ├── const.js\n│       │   │   └── index.js\n│       │   ├── use-draw-point <span class="token comment"># 画地图上的非选中的点</span>\n│       │   │   └── index.js\n│       │   ├── use-draw-start-pass-end <span class="token comment"># 画地图上的选中点</span>\n│       │   │   ├── images\n│       │   │   │   ├── 圆心.png\n│       │   │   │   ├── 定位_终点.svg\n│       │   │   │   ├── 定位_起点.svg\n│       │   │   │   └── 定位_途点.svg\n│       │   │   └── index.js\n│       │   └── use-show-hover-text.js <span class="token comment"># 设置悬浮文字</span>\n│       ├── index.jsx <span class="token comment"># 路线组件主入口</span>\n│       └── styles.less\n├── index.jsx <span class="token comment"># 主入口文件</span>\n└── styles.less</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="具体功能"><a href="#%E5%85%B7%E4%BD%93%E5%8A%9F%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体功能</h1>\n<h2 id="主入口文件"><a href="#%E4%B8%BB%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>主入口文件</h2>\n<p>核心逻辑：</p>\n<ol>\n<li>兼容地图配置从外部传入的情况</li>\n<li>path（站点数据）需要过滤掉经纬度无意义的站点</li>\n<li>route（路线信息）需要过滤掉缺失的线路，即 2 个站点间的路线有可能未知</li>\n<li>map, view 实例存在时才去渲染路线相关的组件</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69447530969442790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { useState, useEffect } from \'react\';\nimport { setDefaultOptions } from \'esri-loader\';\n\nimport RouteDisplayLayer from \'./components/route-display-layer\';\nimport Map from \'./components/map\';\nimport { getConfig } from \'./api\';\n\nimport styles from \'./styles.less\';\n\nsetDefaultOptions({\n  css: \'/static-apps/mut/arcgis/esri/themes/light/main.css\',\n  url: \'/static-apps/mut/arcgis/init.js\'\n});\n\n/*\n  config: esri 三方库后端配置地址（外部配置）\n  height: 地图高度\n  onRef：map 的 ref 回调\n  settings： {\n    centerLon 地图中心经度\n    centerLat 地图中心纬度\n    zoom 缩放级别\n  }\n  pointInfo: 过滤条件的起点、终点、途径点渲染\n  onPointInfoChange: 过滤条件变化回调\n  goToCenter: 初次加载是否到中心点\n  showAddOrDelBtn: 是否显示添加删除按钮，\n  showLineInfo: 是否显示路线信息\n  path: 站点信息\n  route: 路线信息\n  transport: 运输信息（线路密度）\n*/\n\nexport { getConfig };\n\nexport default function RailwayMap(props) {\n  const { path, route } = props;\n  const [config, setConfig] = useState(props.config);\n\n  useEffect(() => {\n    const fetchConfig = async () => {\n      const data = await getConfig();\n      setConfig(data.result);\n    };\n    if (!config) {\n      fetchConfig();\n    }\n  }, [config]);\n\n  const { centerLon = 110, centerLat = 38, zoom = 5 } = props.settings || {};\n\n  const [map, setMap] = useState();\n  const [view, setView] = useState();\n\n  if (!config) {\n    return null;\n  }\n\n  const isFloat = (number) => /^(-?\\d+)(\\.\\d+)?\\$/.test(number);\n\n  // 过滤掉没有经纬度结点或者经纬度为 0 的结点\n  const filterPath = path.filter(\n    (item) => isFloat(item.lat) && isFloat(item.lon) && +item.lat !== 0 && +item.lon !== 0\n  );\n\n  const getPointInfoByZmdm = (zmdm) => path.find((item) => item.zmdm === zmdm) || {};\n\n  const filterRoute = [];\n  for (let i = 0; i < route.length; i++) {\n    // 补充缺失的线路，比如这种情况长沙-湘潭-武汉，长沙-湘潭段属于长湘线，湘潭到武汉属于湘武线\n    // 湘潭的经纬度为空，那么直接连起来的长沙 - 武汉叫长湘线\n    if (\n      getPointInfoByZmdm(route[i].zmdm).lon &&\n      getPointInfoByZmdm(route[i].zmdm).lat &&\n      (!getPointInfoByZmdm(route[i].next_zmdm).lon || !getPointInfoByZmdm(route[i].next_zmdm).lat)\n    ) {\n      const { zm: startZm, zmdm: startZmdm, xm } = route[i];\n\n      // 累加缺失的站点的里程数\n      let distance = 0;\n      if (route[i].czjl) {\n        distance = route[i].czjl;\n      }\n\n      let index = null;\n      for (let j = i + 1; j < route.length; j++) {\n        if (route[j].czjl) {\n          distance += route[j].czjl;\n        }\n        // 这里需要找到第一个终点站经纬度不为零的站点的下标，以此来进行缺失经纬度站点的合并\n        if (getPointInfoByZmdm(route[j].next_zmdm).lon && getPointInfoByZmdm(route[j].next_zmdm).lat) {\n          index = j;\n          break;\n        }\n      }\n      if (!index) {\n        // eslint-disable-next-line no-continue\n        continue;\n      }\n      const { next_zmdm: endZmdm, next_zm: endZm } = route[index];\n      filterRoute.push({\n        zmdm: startZmdm,\n        zm: startZm,\n        next_zmdm: endZmdm,\n        next_zm: endZm,\n        xm,\n        czjl: distance\n      });\n      i = index;\n    }\n\n    // 经纬度都有的结点直接插入\n    if (\n      getPointInfoByZmdm(route[i].zmdm).lon &&\n      getPointInfoByZmdm(route[i].zmdm).lat &&\n      getPointInfoByZmdm(route[i].next_zmdm).lon &&\n      getPointInfoByZmdm(route[i].next_zmdm).lat\n    ) {\n      filterRoute.push(route[i]);\n    }\n  }\n\n  return (\n    <div className={styles.container}>\n      <Map\n        {...props}\n        config={config}\n        viewProperties={{\n          zoom: +zoom,\n          center: [+centerLon, +centerLat]\n        }}\n        setMap={setMap}\n        setView={setView}\n        view={view}\n      />\n      {map && view && <RouteDisplayLayer {...props} path={filterPath} route={filterRoute} map={map} view={view} />}\n    </div>\n  );\n}`, `69447530969442790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> setDefaultOptions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'esri-loader\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> RouteDisplayLayer <span class="token keyword">from</span> <span class="token string">\'./components/route-display-layer\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> Map <span class="token keyword">from</span> <span class="token string">\'./components/map\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> getConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'./api\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./styles.less\'</span><span class="token punctuation">;</span>\n\n<span class="token function">setDefaultOptions</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  css<span class="token punctuation">:</span> <span class="token string">\'/static-apps/mut/arcgis/esri/themes/light/main.css\'</span><span class="token punctuation">,</span>\n  url<span class="token punctuation">:</span> <span class="token string">\'/static-apps/mut/arcgis/init.js\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">/*\n  config: esri 三方库后端配置地址（外部配置）\n  height: 地图高度\n  onRef：map 的 ref 回调\n  settings： {\n    centerLon 地图中心经度\n    centerLat 地图中心纬度\n    zoom 缩放级别\n  }\n  pointInfo: 过滤条件的起点、终点、途径点渲染\n  onPointInfoChange: 过滤条件变化回调\n  goToCenter: 初次加载是否到中心点\n  showAddOrDelBtn: 是否显示添加删除按钮，\n  showLineInfo: 是否显示路线信息\n  path: 站点信息\n  route: 路线信息\n  transport: 运输信息（线路密度）\n*/</span>\n\n<span class="token keyword">export</span> <span class="token punctuation">{</span> getConfig <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">RailwayMap</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> route <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>config<span class="token punctuation">,</span> setConfig<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token function-variable function">fetchConfig</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">setConfig</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">fetchConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>config<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> centerLon <span class="token operator">=</span> <span class="token number">110</span><span class="token punctuation">,</span> centerLat <span class="token operator">=</span> <span class="token number">38</span><span class="token punctuation">,</span> zoom <span class="token operator">=</span> <span class="token number">5</span> <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">.</span>settings <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>map<span class="token punctuation">,</span> setMap<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>view<span class="token punctuation">,</span> setView<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> <span class="token function-variable function">isFloat</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">number</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token regex">/^(-?\\d+)(\\.\\d+)?$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 过滤掉没有经纬度结点或者经纬度为 0 的结点</span>\n  <span class="token keyword">const</span> filterPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>\n    <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">isFloat</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>lat<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isFloat</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>lon<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lat <span class="token operator">!==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lon <span class="token operator">!==</span> <span class="token number">0</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token function-variable function">getPointInfoByZmdm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">zmdm</span><span class="token punctuation">)</span> <span class="token operator">=></span> path<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>zmdm <span class="token operator">===</span> zmdm<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> filterRoute <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> route<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 补充缺失的线路，比如这种情况长沙-湘潭-武汉，长沙-湘潭段属于长湘线，湘潭到武汉属于湘武线</span>\n    <span class="token comment">// 湘潭的经纬度为空，那么直接连起来的长沙 - 武汉叫长湘线</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>\n      <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">&amp;&amp;</span>\n      <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat <span class="token operator">&amp;&amp;</span>\n      <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat<span class="token punctuation">)</span>\n    <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span> zm<span class="token punctuation">:</span> startZm<span class="token punctuation">,</span> zmdm<span class="token punctuation">:</span> startZmdm<span class="token punctuation">,</span> xm <span class="token punctuation">}</span> <span class="token operator">=</span> route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 累加缺失的站点的里程数</span>\n      <span class="token keyword">let</span> distance <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>czjl<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        distance <span class="token operator">=</span> route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>czjl<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> route<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>czjl<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          distance <span class="token operator">+=</span> route<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>czjl<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token comment">// 这里需要找到第一个终点站经纬度不为零的站点的下标，以此来进行缺失经纬度站点的合并</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">&amp;&amp;</span> <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          index <span class="token operator">=</span> j<span class="token punctuation">;</span>\n          <span class="token keyword">break</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>index<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// eslint-disable-next-line no-continue</span>\n        <span class="token keyword">continue</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span> next_zmdm<span class="token punctuation">:</span> endZmdm<span class="token punctuation">,</span> next_zm<span class="token punctuation">:</span> endZm <span class="token punctuation">}</span> <span class="token operator">=</span> route<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      filterRoute<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n        zmdm<span class="token punctuation">:</span> startZmdm<span class="token punctuation">,</span>\n        zm<span class="token punctuation">:</span> startZm<span class="token punctuation">,</span>\n        next_zmdm<span class="token punctuation">:</span> endZmdm<span class="token punctuation">,</span>\n        next_zm<span class="token punctuation">:</span> endZm<span class="token punctuation">,</span>\n        xm<span class="token punctuation">,</span>\n        czjl<span class="token punctuation">:</span> distance\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      i <span class="token operator">=</span> index<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 经纬度都有的结点直接插入</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>\n      <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">&amp;&amp;</span>\n      <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat <span class="token operator">&amp;&amp;</span>\n      <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">&amp;&amp;</span>\n      <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat\n    <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      filterRoute<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>container<span class="token punctuation">}</span><span class="token operator">></span>\n      <span class="token operator">&lt;</span>Map\n        <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span>\n        config<span class="token operator">=</span><span class="token punctuation">{</span>config<span class="token punctuation">}</span>\n        viewProperties<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n          zoom<span class="token punctuation">:</span> <span class="token operator">+</span>zoom<span class="token punctuation">,</span>\n          center<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">+</span>centerLon<span class="token punctuation">,</span> <span class="token operator">+</span>centerLat<span class="token punctuation">]</span>\n        <span class="token punctuation">}</span><span class="token punctuation">}</span>\n        setMap<span class="token operator">=</span><span class="token punctuation">{</span>setMap<span class="token punctuation">}</span>\n        setView<span class="token operator">=</span><span class="token punctuation">{</span>setView<span class="token punctuation">}</span>\n        view<span class="token operator">=</span><span class="token punctuation">{</span>view<span class="token punctuation">}</span>\n      <span class="token operator">/</span><span class="token operator">></span>\n      <span class="token punctuation">{</span>map <span class="token operator">&amp;&amp;</span> view <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>RouteDisplayLayer <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> path<span class="token operator">=</span><span class="token punctuation">{</span>filterPath<span class="token punctuation">}</span> route<span class="token operator">=</span><span class="token punctuation">{</span>filterRoute<span class="token punctuation">}</span> map<span class="token operator">=</span><span class="token punctuation">{</span>map<span class="token punctuation">}</span> view<span class="token operator">=</span><span class="token punctuation">{</span>view<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="地图组件主入口"><a href="#%E5%9C%B0%E5%9B%BE%E7%BB%84%E4%BB%B6%E4%B8%BB%E5%85%A5%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>地图组件主入口</h2>\n<p>采用 hooks 方式拆分，下面的组件也是采用类似的拆分</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71642827626425620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useRef } from \'react\';\n\nimport useLoadMap from \'./hooks/use-load-map\';\nimport useGotoMap from \'./hooks/use-goto-map\';\n\nexport default function Map(props) {\n  const { height } = props;\n  const mapRef = useRef();\n  useLoadMap({\n    ...props,\n    mapRef\n  });\n  useGotoMap(props);\n\n  return (\n    <div\n      style={{\n        height\n      }}\n      ref={mapRef}\n    />\n  );\n}`, `71642827626425620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> useLoadMap <span class="token keyword">from</span> <span class="token string">\'./hooks/use-load-map\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> useGotoMap <span class="token keyword">from</span> <span class="token string">\'./hooks/use-goto-map\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Map</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> height <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> mapRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">useLoadMap</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    <span class="token operator">...</span>props<span class="token punctuation">,</span>\n    mapRef\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">useGotoMap</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token operator">&lt;</span>div\n      style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n        height\n      <span class="token punctuation">}</span><span class="token punctuation">}</span>\n      ref<span class="token operator">=</span><span class="token punctuation">{</span>mapRef<span class="token punctuation">}</span>\n    <span class="token operator">/</span><span class="token operator">></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="地图加载"><a href="#%E5%9C%B0%E5%9B%BE%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>地图加载</h2>\n<p>需要监听地图组件图层加载完毕事件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91769839945849620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useEffect } from \'react\';\nimport { loadModules } from \'esri-loader\';\n\n// 地图加载\nexport default function useLoadMap(props) {\n  const { setMap, setView, viewProperties, config, mapRef, onRef } = props;\n  const { mapLayerUrlTemplate, subDomains, markerLayerUrlTemplate } = config;\n\n  useEffect(() => {\n    // https://developers.arcgis.com/javascript/latest/sample-code/sandbox/index.html?sample=layers-webtile-3d\n    loadModules([\'esri/Map\', \'esri/views/MapView\', \'esri/layers/WebTileLayer\'])\n      .then(([Map, MapView, WebTileLayer]) => {\n        const mapLayer = new WebTileLayer({\n          urlTemplate: mapLayerUrlTemplate,\n          subDomains\n        });\n        const markerLayer = new WebTileLayer({\n          urlTemplate: markerLayerUrlTemplate,\n          subDomains\n        });\n\n        const map = new Map({\n          layers: [mapLayer, markerLayer]\n        });\n\n        const view = new MapView({\n          container: mapRef.current,\n          map,\n          ...viewProperties\n        });\n\n        view.ui.move(\'zoom\', \'bottom-right\');\n\n        view.when(\n          () => {\n            console.log(\'地图加载完成\');\n            setMap(map);\n            setView(view);\n            onRef &&\n              onRef({\n                map,\n                view\n              });\n          },\n          (error) => {\n            console.log(\'地图加载失败\', error);\n          }\n        );\n      })\n      .catch((err) => {\n        // handle any errors\n        console.error(err);\n      });\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [setMap, setView]);\n}`, `91769839945849620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> loadModules <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'esri-loader\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 地图加载</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">useLoadMap</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> setMap<span class="token punctuation">,</span> setView<span class="token punctuation">,</span> viewProperties<span class="token punctuation">,</span> config<span class="token punctuation">,</span> mapRef<span class="token punctuation">,</span> onRef <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> mapLayerUrlTemplate<span class="token punctuation">,</span> subDomains<span class="token punctuation">,</span> markerLayerUrlTemplate <span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// https://developers.arcgis.com/javascript/latest/sample-code/sandbox/index.html?sample=layers-webtile-3d</span>\n    <span class="token function">loadModules</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'esri/Map\'</span><span class="token punctuation">,</span> <span class="token string">\'esri/views/MapView\'</span><span class="token punctuation">,</span> <span class="token string">\'esri/layers/WebTileLayer\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>Map<span class="token punctuation">,</span> MapView<span class="token punctuation">,</span> WebTileLayer<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> mapLayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebTileLayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          urlTemplate<span class="token punctuation">:</span> mapLayerUrlTemplate<span class="token punctuation">,</span>\n          subDomains\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> markerLayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebTileLayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          urlTemplate<span class="token punctuation">:</span> markerLayerUrlTemplate<span class="token punctuation">,</span>\n          subDomains\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          layers<span class="token punctuation">:</span> <span class="token punctuation">[</span>mapLayer<span class="token punctuation">,</span> markerLayer<span class="token punctuation">]</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">const</span> view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapView</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          container<span class="token punctuation">:</span> mapRef<span class="token punctuation">.</span>current<span class="token punctuation">,</span>\n          map<span class="token punctuation">,</span>\n          <span class="token operator">...</span>viewProperties\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        view<span class="token punctuation">.</span>ui<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token string">\'zoom\'</span><span class="token punctuation">,</span> <span class="token string">\'bottom-right\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        view<span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>\n          <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'地图加载完成\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token function">setMap</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token function">setView</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            onRef <span class="token operator">&amp;&amp;</span>\n              <span class="token function">onRef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                map<span class="token punctuation">,</span>\n                view\n              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'地图加载失败\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token comment">// handle any errors</span>\n        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>setMap<span class="token punctuation">,</span> setView<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="地图导航"><a href="#%E5%9C%B0%E5%9B%BE%E5%AF%BC%E8%88%AA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>地图导航</h2>\n<p>初始化时直接导航到相应路线（暂时有 bug，因为不能确定路线组件完全加载的时机而导致的偶尔路线渲染不出来的现象）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18487334394484134000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useEffect } from \'react\';\n\n// 地图导航\nexport default function useGotoMap(props) {\n  const { view, goToCenter, path } = props;\n\n  useEffect(() => {\n    if (!view || !goToCenter || !path || !path.length) {\n      return;\n    }\n\n    // 暂时未找到 view.graphics 完全加载时的方法，会造成白屏 bug\n    if (goToCenter === true) {\n      view.goTo(\n        {\n          target: view.graphics\n        },\n        {\n          animate: false\n        }\n      );\n    } else {\n      view.goTo(goToCenter);\n    }\n  }, [path, view, goToCenter]);\n\n  // console.log(\'view\', view)\n  // const eventRef = useRef()\n  // useEffect(() => {\n  //   if (!view) {\n  //     return\n  //   }\n\n  //   eventRef.current = view.on(\'layerview-create\', () => {\n  //     console.log(\'dsads\')\n  //     console.log(get(view, \'graphics._items\', []).length)\n  //   })\n\n  //   return () => {\n  //     eventRef.current && eventRef.current.remove()\n  //   }\n  // }, [view])\n}`, `18487334394484134000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 地图导航</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">useGotoMap</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> view<span class="token punctuation">,</span> goToCenter<span class="token punctuation">,</span> path <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>view <span class="token operator">||</span> <span class="token operator">!</span>goToCenter <span class="token operator">||</span> <span class="token operator">!</span>path <span class="token operator">||</span> <span class="token operator">!</span>path<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 暂时未找到 view.graphics 完全加载时的方法，会造成白屏 bug</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>goToCenter <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      view<span class="token punctuation">.</span><span class="token function">goTo</span><span class="token punctuation">(</span>\n        <span class="token punctuation">{</span>\n          target<span class="token punctuation">:</span> view<span class="token punctuation">.</span>graphics\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token punctuation">{</span>\n          animate<span class="token punctuation">:</span> <span class="token boolean">false</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      view<span class="token punctuation">.</span><span class="token function">goTo</span><span class="token punctuation">(</span>goToCenter<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>path<span class="token punctuation">,</span> view<span class="token punctuation">,</span> goToCenter<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// console.log(\'view\', view)</span>\n  <span class="token comment">// const eventRef = useRef()</span>\n  <span class="token comment">// useEffect(() => {</span>\n  <span class="token comment">//   if (!view) {</span>\n  <span class="token comment">//     return</span>\n  <span class="token comment">//   }</span>\n\n  <span class="token comment">//   eventRef.current = view.on(\'layerview-create\', () => {</span>\n  <span class="token comment">//     console.log(\'dsads\')</span>\n  <span class="token comment">//     console.log(get(view, \'graphics._items\', []).length)</span>\n  <span class="token comment">//   })</span>\n\n  <span class="token comment">//   return () => {</span>\n  <span class="token comment">//     eventRef.current &amp;&amp; eventRef.current.remove()</span>\n  <span class="token comment">//   }</span>\n  <span class="token comment">// }, [view])</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="路线组件主入口"><a href="#%E8%B7%AF%E7%BA%BF%E7%BB%84%E4%BB%B6%E4%B8%BB%E5%85%A5%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>路线组件主入口</h2>\n<ol>\n<li>渲染路线信息组件</li>\n<li>渲染悬浮文字组件</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9093067791637921000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { Fragment, useRef, useState } from \'react\';\nimport { ShrinkOutlined, ArrowsAltOutlined } from \'@ant-design/icons\';\nimport classnames from \'classnames\';\nimport { Button } from \'antd\';\n\nimport useDrawLine from \'./hooks/use-draw-line\';\nimport useDrawPoint from \'./hooks/use-draw-point\';\nimport useDrawStartPassEnd from \'./hooks/use-draw-start-pass-end\';\nimport useAddOrDelPoint from \'./hooks/use-add-or-del-point\';\nimport useShowHoverText from \'./hooks/use-show-hover-text\';\n\nimport styles from \'./styles.less\';\n\nexport default function RouteDisplayLayer(props) {\n  const { showLineInfo = true } = props;\n\n  const { lineInfo } = useDrawLine(props);\n\n  const [isExpand, setIsExpand] = useState(true);\n\n  useDrawPoint(props);\n\n  useDrawStartPassEnd(props);\n\n  useAddOrDelPoint(props);\n\n  const hoverNodeRef = useRef();\n\n  useShowHoverText({\n    ...props,\n    hoverNodeRef\n  });\n\n  const totalDistance = lineInfo.reduce((pre, cur) => pre + cur.distance, 0);\n\n  const totalHint = (\n    <span>\n      全程\n      {totalDistance}\n      公里\n    </span>\n  );\n\n  return (\n    <Fragment>\n      <span className={styles.hoverNode} ref={hoverNodeRef} />\n      {showLineInfo &&\n        lineInfo &&\n        lineInfo.length > 0 &&\n        (isExpand ? (\n          <div className={classnames(styles.lineInfoContainer, styles.lineInfo)}>\n            <div className={styles.header}>\n              {totalHint}\n              <div className={styles.expandBtn}>\n                <ShrinkOutlined onClick={() => setIsExpand(false)} />\n              </div>\n            </div>\n            <div className={styles.body}>\n              {lineInfo.map((item) => (\n                <div key={item.xm} className={styles.item}>\n                  <span\n                    className={styles.color}\n                    style={{\n                      background: item.color\n                    }}\n                  />\n                  <span className={styles.xm}>{item.xm}</span>\n                </div>\n              ))}\n            </div>\n          </div>\n        ) : (\n          <div className={styles.lineInfoContainer}>\n            <Button onClick={() => setIsExpand(true)} icon={<ArrowsAltOutlined />}>\n              {totalHint}\n            </Button>\n          </div>\n        ))}\n    </Fragment>\n  );\n}`, `9093067791637921000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Fragment<span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> ShrinkOutlined<span class="token punctuation">,</span> ArrowsAltOutlined <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@ant-design/icons\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> classnames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> Button <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'antd\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> useDrawLine <span class="token keyword">from</span> <span class="token string">\'./hooks/use-draw-line\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> useDrawPoint <span class="token keyword">from</span> <span class="token string">\'./hooks/use-draw-point\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> useDrawStartPassEnd <span class="token keyword">from</span> <span class="token string">\'./hooks/use-draw-start-pass-end\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> useAddOrDelPoint <span class="token keyword">from</span> <span class="token string">\'./hooks/use-add-or-del-point\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> useShowHoverText <span class="token keyword">from</span> <span class="token string">\'./hooks/use-show-hover-text\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./styles.less\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">RouteDisplayLayer</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> showLineInfo <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> lineInfo <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useDrawLine</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>isExpand<span class="token punctuation">,</span> setIsExpand<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useDrawPoint</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useDrawStartPassEnd</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useAddOrDelPoint</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> hoverNodeRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useShowHoverText</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    <span class="token operator">...</span>props<span class="token punctuation">,</span>\n    hoverNodeRef\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> totalDistance <span class="token operator">=</span> lineInfo<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pre<span class="token punctuation">,</span> cur</span><span class="token punctuation">)</span> <span class="token operator">=></span> pre <span class="token operator">+</span> cur<span class="token punctuation">.</span>distance<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> totalHint <span class="token operator">=</span> <span class="token punctuation">(</span>\n    <span class="token operator">&lt;</span>span<span class="token operator">></span>\n      全程\n      <span class="token punctuation">{</span>totalDistance<span class="token punctuation">}</span>\n      公里\n    <span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token operator">&lt;</span>Fragment<span class="token operator">></span>\n      <span class="token operator">&lt;</span>span className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>hoverNode<span class="token punctuation">}</span> ref<span class="token operator">=</span><span class="token punctuation">{</span>hoverNodeRef<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>\n      <span class="token punctuation">{</span>showLineInfo <span class="token operator">&amp;&amp;</span>\n        lineInfo <span class="token operator">&amp;&amp;</span>\n        lineInfo<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>\n        <span class="token punctuation">(</span>isExpand <span class="token operator">?</span> <span class="token punctuation">(</span>\n          <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>styles<span class="token punctuation">.</span>lineInfoContainer<span class="token punctuation">,</span> styles<span class="token punctuation">.</span>lineInfo<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>\n            <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>header<span class="token punctuation">}</span><span class="token operator">></span>\n              <span class="token punctuation">{</span>totalHint<span class="token punctuation">}</span>\n              <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>expandBtn<span class="token punctuation">}</span><span class="token operator">></span>\n                <span class="token operator">&lt;</span>ShrinkOutlined onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setIsExpand</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>\n              <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n            <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>body<span class="token punctuation">}</span><span class="token operator">></span>\n              <span class="token punctuation">{</span>lineInfo<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>\n                <span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>xm<span class="token punctuation">}</span> className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>item<span class="token punctuation">}</span><span class="token operator">></span>\n                  <span class="token operator">&lt;</span>span\n                    className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>color<span class="token punctuation">}</span>\n                    style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n                      background<span class="token punctuation">:</span> item<span class="token punctuation">.</span>color\n                    <span class="token punctuation">}</span><span class="token punctuation">}</span>\n                  <span class="token operator">/</span><span class="token operator">></span>\n                  <span class="token operator">&lt;</span>span className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>xm<span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>xm<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>\n                <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n              <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n          <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n        <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>\n          <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>lineInfoContainer<span class="token punctuation">}</span><span class="token operator">></span>\n            <span class="token operator">&lt;</span>Button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setIsExpand</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">}</span> icon<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&lt;</span>ArrowsAltOutlined <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>\n              <span class="token punctuation">{</span>totalHint<span class="token punctuation">}</span>\n            <span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">></span>\n          <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>Fragment<span class="token operator">></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="画地图上的线"><a href="#%E7%94%BB%E5%9C%B0%E5%9B%BE%E4%B8%8A%E7%9A%84%E7%BA%BF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>画地图上的线</h2>\n<ol>\n<li>根据 route、path 渲染路线</li>\n<li>根据 transport 渲染路线粗细，同时弹窗显示线路密度</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9274066169836814000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useEffect, useRef } from \'react\';\nimport { loadModules } from \'esri-loader\';\nimport { get, groupBy } from \'lodash\';\n\nimport { LINE_COLORS, getLineSize } from \'./const\';\n\n// 画地图上的线\nexport default function useDrawLine(props) {\n  const { path, view, route, transport } = props;\n\n  const polylineGraphicsRef = useRef();\n\n  useEffect(() => {\n    const groupMap = groupBy(route, (item) => item.xm);\n    const getPointInfoByZmdm = (zmdm) => path.find((item) => item.zmdm === zmdm);\n\n    // https://developers.arcgis.com/javascript/latest/guide/display-point-line-and-polygon-graphics/\n    // https://developers.arcgis.com/javascript/latest/sample-code/intro-graphics/index.html\n    loadModules([\'esri/Graphic\'])\n      .then(([Graphic]) => {\n        if (polylineGraphicsRef.current) {\n          polylineGraphicsRef.current.forEach((item) => {\n            view.graphics.remove(item);\n          });\n          polylineGraphicsRef.current = [];\n        }\n\n        /* 根据 path、transport 计算密度总数 */\n        // 根据经过的 path 即站点累加密度情况\n        const transportList = []; // 运输密度统计表，以 path 最小单元做计算\n        if (transport && transport.length > 0) {\n          transport.forEach((item) => {\n            // 找到上车站的下标\n            const startIndex = path.findIndex((item2) => item2.zmdm === item.zmdm_sc);\n            // 找到下车站的下标\n            const endIndex = path.findIndex((item2) => item2.zmdm === item.zmdm_xc);\n            // 遍历上车站到下车站的站点，累加所有密度\n            for (let i = startIndex; i < endIndex; i++) {\n              const startZmdm = get(path, \\`[\\${i}].zmdm\\`);\n              const endZmdm = get(path, \\`[\\${i + 1}].zmdm\\`);\n              const findTransportList = transportList.find(\n                (item2) => get(item2, \'start.zmdm\') === startZmdm && get(item2, \'end.zmdm\') === endZmdm\n              );\n              if (findTransportList) {\n                findTransportList.total += item.ysrs;\n              } else {\n                transportList.push({\n                  start: path[i],\n                  end: path[i + 1],\n                  total: item.ysrs\n                });\n              }\n            }\n          });\n        }\n        // 根据起点代码、终点代码找到密度数\n        const getPeopleNumberByStartEnd = (startZmdm, endZmdm) =>\n          get(\n            transportList.find((item) => get(item, \'start.zmdm\') === startZmdm && get(item, \'end.zmdm\') === endZmdm),\n            \'total\',\n            0\n          );\n        /* 根据 path、transport 计算密度总数 */\n\n        const polylineGraphics = [];\n\n        // 渲染线路\n        const renderLine = ({ paths, width, distance, xm, index, peopleNumber }) => {\n          const content = [];\n          if (distance) {\n            content.push(\\`里程：\\${distance} 公里\\`);\n          }\n          if (peopleNumber) {\n            content.push(\\`运输密度：\\${peopleNumber} 人\\`);\n          }\n          const polylineGraphic = new Graphic({\n            geometry: {\n              type: \'polyline\',\n              paths: paths.map((item) => [+get(item, \'lon\', 0), +get(item, \'lat\', 0)])\n            },\n            symbol: {\n              type: \'simple-line\',\n              color: LINE_COLORS[index % LINE_COLORS.length],\n              width\n            },\n            attributes: {\n              xm\n            },\n            popupTemplate: {\n              title: xm,\n              content: content.join(\'、\')\n            }\n          });\n          polylineGraphics.push(polylineGraphic);\n          view.graphics.add(polylineGraphic);\n        };\n\n        Object.keys(groupMap).forEach((key, index) => {\n          const paths = [];\n          let totalDistance = 0;\n          groupMap[key].forEach((item) => {\n            const startPointInfo = getPointInfoByZmdm(item.zmdm);\n            const endPointInfo = getPointInfoByZmdm(item.next_zmdm);\n            totalDistance += item.czjl || 0;\n            paths.push([startPointInfo, endPointInfo]);\n          });\n          if (transport && transport.length > 0) {\n            paths.forEach((item) => {\n              const [startPointInfo, endPointInfo] = item;\n              const peopleNumber = getPeopleNumberByStartEnd(get(startPointInfo, \'zmdm\'), get(endPointInfo, \'zmdm\'));\n              const width = getLineSize(peopleNumber);\n              // console.log(get(startPointInfo, \'zm\'), get(endPointInfo, \'zm\'), key, peopleNumber, width)\n              renderLine({\n                distance: totalDistance,\n                width: \\`\\${width}px\\`,\n                paths: item,\n                xm: key,\n                index,\n                peopleNumber\n              });\n            });\n          } else {\n            paths.forEach((item) => {\n              // const [startPointInfo, endPointInfo] = item\n              // console.log(get(startPointInfo, \'zm\'), get(endPointInfo, \'zm\'), key)\n              renderLine({\n                distance: totalDistance,\n                width: \'6px\',\n                paths: item,\n                xm: key,\n                index\n              });\n            });\n          }\n        });\n        polylineGraphicsRef.current = polylineGraphics;\n      })\n      .catch((err) => {\n        console.error(err);\n      });\n  }, [view, path, transport, route]);\n\n  const lineInfo = [];\n\n  const groupMap = groupBy(route, (item) => item.xm);\n  Object.keys(groupMap).forEach((key, index) => {\n    lineInfo.push({\n      xm: key,\n      color: LINE_COLORS[index % LINE_COLORS.length],\n      distance: groupMap[key].reduce((pre, cur) => pre + (cur.czjl || 0), 0)\n    });\n  });\n\n  return {\n    lineInfo\n  };\n}`, `9274066169836814000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> loadModules <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'esri-loader\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">,</span> groupBy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">LINE_COLORS</span><span class="token punctuation">,</span> getLineSize <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'./const\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 画地图上的线</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">useDrawLine</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> view<span class="token punctuation">,</span> route<span class="token punctuation">,</span> transport <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> polylineGraphicsRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> groupMap <span class="token operator">=</span> <span class="token function">groupBy</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>xm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> <span class="token function-variable function">getPointInfoByZmdm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">zmdm</span><span class="token punctuation">)</span> <span class="token operator">=></span> path<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>zmdm <span class="token operator">===</span> zmdm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// https://developers.arcgis.com/javascript/latest/guide/display-point-line-and-polygon-graphics/</span>\n    <span class="token comment">// https://developers.arcgis.com/javascript/latest/sample-code/intro-graphics/index.html</span>\n    <span class="token function">loadModules</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'esri/Graphic\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>Graphic<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>polylineGraphicsRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          polylineGraphicsRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            view<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          polylineGraphicsRef<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token comment">/* 根据 path、transport 计算密度总数 */</span>\n        <span class="token comment">// 根据经过的 path 即站点累加密度情况</span>\n        <span class="token keyword">const</span> transportList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 运输密度统计表，以 path 最小单元做计算</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>transport <span class="token operator">&amp;&amp;</span> transport<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          transport<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token comment">// 找到上车站的下标</span>\n            <span class="token keyword">const</span> startIndex <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item2</span><span class="token punctuation">)</span> <span class="token operator">=></span> item2<span class="token punctuation">.</span>zmdm <span class="token operator">===</span> item<span class="token punctuation">.</span>zmdm_sc<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">// 找到下车站的下标</span>\n            <span class="token keyword">const</span> endIndex <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item2</span><span class="token punctuation">)</span> <span class="token operator">=></span> item2<span class="token punctuation">.</span>zmdm <span class="token operator">===</span> item<span class="token punctuation">.</span>zmdm_xc<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">// 遍历上车站到下车站的站点，累加所有密度</span>\n            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> startIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> endIndex<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n              <span class="token keyword">const</span> startZmdm <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">].zmdm</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n              <span class="token keyword">const</span> endZmdm <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">].zmdm</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n              <span class="token keyword">const</span> findTransportList <span class="token operator">=</span> transportList<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>\n                <span class="token punctuation">(</span><span class="token parameter">item2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">get</span><span class="token punctuation">(</span>item2<span class="token punctuation">,</span> <span class="token string">\'start.zmdm\'</span><span class="token punctuation">)</span> <span class="token operator">===</span> startZmdm <span class="token operator">&amp;&amp;</span> <span class="token keyword">get</span><span class="token punctuation">(</span>item2<span class="token punctuation">,</span> <span class="token string">\'end.zmdm\'</span><span class="token punctuation">)</span> <span class="token operator">===</span> endZmdm\n              <span class="token punctuation">)</span><span class="token punctuation">;</span>\n              <span class="token keyword">if</span> <span class="token punctuation">(</span>findTransportList<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                findTransportList<span class="token punctuation">.</span>total <span class="token operator">+=</span> item<span class="token punctuation">.</span>ysrs<span class="token punctuation">;</span>\n              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n                transportList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                  start<span class="token punctuation">:</span> path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>\n                  end<span class="token punctuation">:</span> path<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n                  total<span class="token punctuation">:</span> item<span class="token punctuation">.</span>ysrs\n                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n              <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token comment">// 根据起点代码、终点代码找到密度数</span>\n        <span class="token keyword">const</span> <span class="token function-variable function">getPeopleNumberByStartEnd</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">startZmdm<span class="token punctuation">,</span> endZmdm</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n          <span class="token keyword">get</span><span class="token punctuation">(</span>\n            transportList<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'start.zmdm\'</span><span class="token punctuation">)</span> <span class="token operator">===</span> startZmdm <span class="token operator">&amp;&amp;</span> <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'end.zmdm\'</span><span class="token punctuation">)</span> <span class="token operator">===</span> endZmdm<span class="token punctuation">)</span><span class="token punctuation">,</span>\n            <span class="token string">\'total\'</span><span class="token punctuation">,</span>\n            <span class="token number">0</span>\n          <span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">/* 根据 path、transport 计算密度总数 */</span>\n\n        <span class="token keyword">const</span> polylineGraphics <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// 渲染线路</span>\n        <span class="token keyword">const</span> <span class="token function-variable function">renderLine</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> paths<span class="token punctuation">,</span> width<span class="token punctuation">,</span> distance<span class="token punctuation">,</span> xm<span class="token punctuation">,</span> index<span class="token punctuation">,</span> peopleNumber <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>distance<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            content<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">里程：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>distance<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 公里</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>peopleNumber<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            content<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">运输密度：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>peopleNumber<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 人</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n          <span class="token keyword">const</span> polylineGraphic <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Graphic</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            geometry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              type<span class="token punctuation">:</span> <span class="token string">\'polyline\'</span><span class="token punctuation">,</span>\n              paths<span class="token punctuation">:</span> paths<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token operator">+</span><span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'lon\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">+</span><span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'lat\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            symbol<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              type<span class="token punctuation">:</span> <span class="token string">\'simple-line\'</span><span class="token punctuation">,</span>\n              color<span class="token punctuation">:</span> <span class="token constant">LINE_COLORS</span><span class="token punctuation">[</span>index <span class="token operator">%</span> <span class="token constant">LINE_COLORS</span><span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">,</span>\n              width\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            attributes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              xm\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            popupTemplate<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              title<span class="token punctuation">:</span> xm<span class="token punctuation">,</span>\n              content<span class="token punctuation">:</span> content<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'、\'</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          polylineGraphics<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>polylineGraphic<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          view<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>polylineGraphic<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n        Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>groupMap<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          <span class="token keyword">const</span> paths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n          <span class="token keyword">let</span> totalDistance <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n          groupMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">const</span> startPointInfo <span class="token operator">=</span> <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">const</span> endPointInfo <span class="token operator">=</span> <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            totalDistance <span class="token operator">+=</span> item<span class="token punctuation">.</span>czjl <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>\n            paths<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>startPointInfo<span class="token punctuation">,</span> endPointInfo<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>transport <span class="token operator">&amp;&amp;</span> transport<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            paths<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n              <span class="token keyword">const</span> <span class="token punctuation">[</span>startPointInfo<span class="token punctuation">,</span> endPointInfo<span class="token punctuation">]</span> <span class="token operator">=</span> item<span class="token punctuation">;</span>\n              <span class="token keyword">const</span> peopleNumber <span class="token operator">=</span> <span class="token function">getPeopleNumberByStartEnd</span><span class="token punctuation">(</span><span class="token keyword">get</span><span class="token punctuation">(</span>startPointInfo<span class="token punctuation">,</span> <span class="token string">\'zmdm\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">get</span><span class="token punctuation">(</span>endPointInfo<span class="token punctuation">,</span> <span class="token string">\'zmdm\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n              <span class="token keyword">const</span> width <span class="token operator">=</span> <span class="token function">getLineSize</span><span class="token punctuation">(</span>peopleNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>\n              <span class="token comment">// console.log(get(startPointInfo, \'zm\'), get(endPointInfo, \'zm\'), key, peopleNumber, width)</span>\n              <span class="token function">renderLine</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                distance<span class="token punctuation">:</span> totalDistance<span class="token punctuation">,</span>\n                width<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>width<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n                paths<span class="token punctuation">:</span> item<span class="token punctuation">,</span>\n                xm<span class="token punctuation">:</span> key<span class="token punctuation">,</span>\n                index<span class="token punctuation">,</span>\n                peopleNumber\n              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            paths<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n              <span class="token comment">// const [startPointInfo, endPointInfo] = item</span>\n              <span class="token comment">// console.log(get(startPointInfo, \'zm\'), get(endPointInfo, \'zm\'), key)</span>\n              <span class="token function">renderLine</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                distance<span class="token punctuation">:</span> totalDistance<span class="token punctuation">,</span>\n                width<span class="token punctuation">:</span> <span class="token string">\'6px\'</span><span class="token punctuation">,</span>\n                paths<span class="token punctuation">:</span> item<span class="token punctuation">,</span>\n                xm<span class="token punctuation">:</span> key<span class="token punctuation">,</span>\n                index\n              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        polylineGraphicsRef<span class="token punctuation">.</span>current <span class="token operator">=</span> polylineGraphics<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>view<span class="token punctuation">,</span> path<span class="token punctuation">,</span> transport<span class="token punctuation">,</span> route<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> lineInfo <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> groupMap <span class="token operator">=</span> <span class="token function">groupBy</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>xm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>groupMap<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    lineInfo<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      xm<span class="token punctuation">:</span> key<span class="token punctuation">,</span>\n      color<span class="token punctuation">:</span> <span class="token constant">LINE_COLORS</span><span class="token punctuation">[</span>index <span class="token operator">%</span> <span class="token constant">LINE_COLORS</span><span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">,</span>\n      distance<span class="token punctuation">:</span> groupMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pre<span class="token punctuation">,</span> cur</span><span class="token punctuation">)</span> <span class="token operator">=></span> pre <span class="token operator">+</span> <span class="token punctuation">(</span>cur<span class="token punctuation">.</span>czjl <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    lineInfo\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="画地图上的非选中的点"><a href="#%E7%94%BB%E5%9C%B0%E5%9B%BE%E4%B8%8A%E7%9A%84%E9%9D%9E%E9%80%89%E4%B8%AD%E7%9A%84%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>画地图上的非选中的点</h2>\n<p>渲染非选中的站点，弹窗显示站点信息并显示添加按钮</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94778501541854220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useEffect, useRef } from \'react\';\nimport { loadModules } from \'esri-loader\';\nimport { get } from \'lodash\';\n\n// 画地图上的非过滤条件上的点\nexport default function useDrawPoint(props) {\n  const { path, pointInfo = [], view, showAddOrDelBtn = true } = props;\n  const routerRef = useRef({\n    // 属于路径但不在过滤条件里面的点\n    notFilterPointGraphics: []\n  });\n\n  useEffect(() => {\n    // https://developers.arcgis.com/javascript/latest/guide/display-point-line-and-polygon-graphics/\n    // https://developers.arcgis.com/javascript/latest/sample-code/intro-graphics/index.html\n    loadModules([\'esri/Graphic\'])\n      .then(([Graphic]) => {\n        /** 画点 **/\n        const notFilterPointGraphicsRef = routerRef.current.notFilterPointGraphics;\n        if (notFilterPointGraphicsRef.length) {\n          notFilterPointGraphicsRef.forEach((item) => {\n            view.graphics.remove(item);\n          });\n          routerRef.current.notFilterPointGraphics = [];\n        }\n        /* 非查询条件上的点 */\n        const notFilterPointGraphics = [];\n        const filterPath = pointInfo\n          .filter((item) => item.value)\n          .map((item) => ({\n            ...item,\n            zmdm: get(item, \'value.key\', \'\')\n          }));\n        path.forEach((item) => {\n          const filterPathIndex = filterPath.findIndex((item2) => item2.zmdm === item.zmdm);\n          if (filterPathIndex === -1) {\n            /** 不在筛选条件里面的点 **/\n            const pointGraphic = new Graphic({\n              attributes: {\n                point: item,\n                path\n              },\n              geometry: {\n                type: \'point\',\n                longitude: +item.lon,\n                latitude: +item.lat\n              },\n              symbol: {\n                type: \'simple-marker\',\n                color: \'#fff\',\n                size: \'10px\',\n                outline: {\n                  color: \'#2c42af\',\n                  width: \'2px\'\n                }\n              },\n              popupTemplate: {\n                title: \\`\\${item.zm}\\`,\n                content: \\`经度：\\${item.lon}，纬度：\\${item.lat}\\`,\n                actions: showAddOrDelBtn\n                  ? [\n                      {\n                        title: \'添加\',\n                        id: \'add\',\n                        className: \'esri-icon-add-attachment\'\n                      }\n                    ]\n                  : []\n              }\n            });\n            notFilterPointGraphics.push(pointGraphic);\n            view.graphics.add(pointGraphic);\n            /** 不在筛选条件里面的点 **/\n          }\n        });\n\n        routerRef.current.notFilterPointGraphics = notFilterPointGraphics;\n        /** 画点 **/\n      })\n      .catch((err) => {\n        console.error(err);\n      });\n  }, [view, path, pointInfo, showAddOrDelBtn]);\n}`, `94778501541854220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> loadModules <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'esri-loader\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 画地图上的非过滤条件上的点</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">useDrawPoint</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> pointInfo <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> view<span class="token punctuation">,</span> showAddOrDelBtn <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> routerRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    <span class="token comment">// 属于路径但不在过滤条件里面的点</span>\n    notFilterPointGraphics<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// https://developers.arcgis.com/javascript/latest/guide/display-point-line-and-polygon-graphics/</span>\n    <span class="token comment">// https://developers.arcgis.com/javascript/latest/sample-code/intro-graphics/index.html</span>\n    <span class="token function">loadModules</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'esri/Graphic\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>Graphic<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token comment">/** 画点 **/</span>\n        <span class="token keyword">const</span> notFilterPointGraphicsRef <span class="token operator">=</span> routerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>notFilterPointGraphics<span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>notFilterPointGraphicsRef<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          notFilterPointGraphicsRef<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            view<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          routerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>notFilterPointGraphics <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token comment">/* 非查询条件上的点 */</span>\n        <span class="token keyword">const</span> notFilterPointGraphics <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> filterPath <span class="token operator">=</span> pointInfo\n          <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>value<span class="token punctuation">)</span>\n          <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token operator">...</span>item<span class="token punctuation">,</span>\n            zmdm<span class="token punctuation">:</span> <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'value.key\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        path<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          <span class="token keyword">const</span> filterPathIndex <span class="token operator">=</span> filterPath<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item2</span><span class="token punctuation">)</span> <span class="token operator">=></span> item2<span class="token punctuation">.</span>zmdm <span class="token operator">===</span> item<span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>filterPathIndex <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">/** 不在筛选条件里面的点 **/</span>\n            <span class="token keyword">const</span> pointGraphic <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Graphic</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n              attributes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                point<span class="token punctuation">:</span> item<span class="token punctuation">,</span>\n                path\n              <span class="token punctuation">}</span><span class="token punctuation">,</span>\n              geometry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                type<span class="token punctuation">:</span> <span class="token string">\'point\'</span><span class="token punctuation">,</span>\n                longitude<span class="token punctuation">:</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lon<span class="token punctuation">,</span>\n                latitude<span class="token punctuation">:</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lat\n              <span class="token punctuation">}</span><span class="token punctuation">,</span>\n              symbol<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                type<span class="token punctuation">:</span> <span class="token string">\'simple-marker\'</span><span class="token punctuation">,</span>\n                color<span class="token punctuation">:</span> <span class="token string">\'#fff\'</span><span class="token punctuation">,</span>\n                size<span class="token punctuation">:</span> <span class="token string">\'10px\'</span><span class="token punctuation">,</span>\n                outline<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                  color<span class="token punctuation">:</span> <span class="token string">\'#2c42af\'</span><span class="token punctuation">,</span>\n                  width<span class="token punctuation">:</span> <span class="token string">\'2px\'</span>\n                <span class="token punctuation">}</span>\n              <span class="token punctuation">}</span><span class="token punctuation">,</span>\n              popupTemplate<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                title<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zm<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n                content<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">经度：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>lon<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">，纬度：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>lat<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n                actions<span class="token punctuation">:</span> showAddOrDelBtn\n                  <span class="token operator">?</span> <span class="token punctuation">[</span>\n                      <span class="token punctuation">{</span>\n                        title<span class="token punctuation">:</span> <span class="token string">\'添加\'</span><span class="token punctuation">,</span>\n                        id<span class="token punctuation">:</span> <span class="token string">\'add\'</span><span class="token punctuation">,</span>\n                        className<span class="token punctuation">:</span> <span class="token string">\'esri-icon-add-attachment\'</span>\n                      <span class="token punctuation">}</span>\n                    <span class="token punctuation">]</span>\n                  <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n              <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            notFilterPointGraphics<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>pointGraphic<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            view<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pointGraphic<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">/** 不在筛选条件里面的点 **/</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        routerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>notFilterPointGraphics <span class="token operator">=</span> notFilterPointGraphics<span class="token punctuation">;</span>\n        <span class="token comment">/** 画点 **/</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>view<span class="token punctuation">,</span> path<span class="token punctuation">,</span> pointInfo<span class="token punctuation">,</span> showAddOrDelBtn<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="画地图上的选中点"><a href="#%E7%94%BB%E5%9C%B0%E5%9B%BE%E4%B8%8A%E7%9A%84%E9%80%89%E4%B8%AD%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>画地图上的选中点</h2>\n<p>渲染选中的站点，弹窗显示站点信息并显示删除按钮</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4100904495130253300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useEffect, useRef } from \'react\';\nimport { loadModules } from \'esri-loader\';\nimport { get } from \'lodash\';\n\nimport startPositionIcon from \'./images/定位_起点.svg\';\nimport byPositionIcon from \'./images/定位_途点.svg\';\nimport endPositionIcon from \'./images/定位_终点.svg\';\nimport CircleIcon from \'./images/圆心.png\';\n\n// 画地图上过滤条件上的点\nexport default function useDrawStartPassEnd(props) {\n  const { path, pointInfo = [], view, showAddOrDelBtn = true } = props;\n  const routerRef = useRef({\n    // 过滤条件上的点\n    filterPointGraphics: []\n  });\n\n  useEffect(() => {\n    // https://developers.arcgis.com/javascript/latest/guide/display-point-line-and-polygon-graphics/\n    // https://developers.arcgis.com/javascript/latest/sample-code/intro-graphics/index.html\n    loadModules([\'esri/Graphic\'])\n      .then(([Graphic]) => {\n        /** 画点 **/\n        const filterPointGraphicsRef = routerRef.current.filterPointGraphics;\n        if (filterPointGraphicsRef.length) {\n          filterPointGraphicsRef.forEach((item) => {\n            const [pointGraphic, markerGraphic] = item;\n            view.graphics.removeMany([pointGraphic, markerGraphic]);\n          });\n          routerRef.current.filterPointGraphics = [];\n        }\n        /* 查询条件上的点 */\n        const filterPointGraphics = [];\n        const filterPath = pointInfo\n          .filter((item) => item.value)\n          .map((item) => ({\n            ...item,\n            zmdm: get(item, \'value.key\', \'\')\n          }));\n        path.forEach((item) => {\n          const filterPathIndex = filterPath.findIndex((item2) => item2.zmdm === item.zmdm);\n          if (filterPathIndex !== -1) {\n            /** 画起点、终点、途点 **/\n            let positionIcon = byPositionIcon;\n            if (filterPathIndex === 0) {\n              positionIcon = startPositionIcon;\n            } else if (filterPathIndex === filterPath.length - 1) {\n              positionIcon = endPositionIcon;\n            }\n            const markerGraphic = new Graphic({\n              geometry: {\n                type: \'point\',\n                longitude: +item.lon,\n                latitude: +item.lat\n              },\n              symbol: {\n                type: \'picture-marker\',\n                url: positionIcon,\n                yoffset: \'25px\',\n                width: \'32px\',\n                height: \'37px\'\n              }\n            });\n            /** 画起点、终点、途点 **/\n\n            /** 画查询条件里面的标记点 **/\n            const pointGraphic = new Graphic({\n              attributes: {\n                point: item\n              },\n              geometry: {\n                type: \'point\',\n                longitude: +item.lon,\n                latitude: +item.lat\n              },\n              symbol: {\n                type: \'picture-marker\',\n                url: CircleIcon,\n                width: \'20px\',\n                height: \'20px\'\n              },\n              popupTemplate: {\n                title: \\`\\${item.zm}：第\\${filterPathIndex + 1}站\\`,\n                content: \\`经度：\\${item.lon}，纬度：\\${item.lat}\\`,\n                actions:\n                  showAddOrDelBtn && filterPath.length > 2\n                    ? [\n                        {\n                          title: \'删除\',\n                          id: \'delete\',\n                          className: \'esri-icon-trash\'\n                        }\n                      ]\n                    : []\n              }\n            });\n            /** 画查询条件里面的标记点 **/\n            filterPointGraphics.push([pointGraphic, markerGraphic]);\n            // routerRef.current.filterPointGraphics = filterPointGraphics\n            view.graphics.addMany([pointGraphic, markerGraphic]);\n          }\n        });\n\n        routerRef.current.filterPointGraphics = filterPointGraphics;\n        /** 画点 **/\n      })\n      .catch((err) => {\n        console.error(err);\n      });\n  }, [view, path, pointInfo, showAddOrDelBtn]);\n}`, `4100904495130253300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> loadModules <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'esri-loader\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> startPositionIcon <span class="token keyword">from</span> <span class="token string">\'./images/定位_起点.svg\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> byPositionIcon <span class="token keyword">from</span> <span class="token string">\'./images/定位_途点.svg\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> endPositionIcon <span class="token keyword">from</span> <span class="token string">\'./images/定位_终点.svg\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> CircleIcon <span class="token keyword">from</span> <span class="token string">\'./images/圆心.png\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 画地图上过滤条件上的点</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">useDrawStartPassEnd</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> pointInfo <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> view<span class="token punctuation">,</span> showAddOrDelBtn <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> routerRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    <span class="token comment">// 过滤条件上的点</span>\n    filterPointGraphics<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// https://developers.arcgis.com/javascript/latest/guide/display-point-line-and-polygon-graphics/</span>\n    <span class="token comment">// https://developers.arcgis.com/javascript/latest/sample-code/intro-graphics/index.html</span>\n    <span class="token function">loadModules</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'esri/Graphic\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>Graphic<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token comment">/** 画点 **/</span>\n        <span class="token keyword">const</span> filterPointGraphicsRef <span class="token operator">=</span> routerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>filterPointGraphics<span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>filterPointGraphicsRef<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          filterPointGraphicsRef<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">const</span> <span class="token punctuation">[</span>pointGraphic<span class="token punctuation">,</span> markerGraphic<span class="token punctuation">]</span> <span class="token operator">=</span> item<span class="token punctuation">;</span>\n            view<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">removeMany</span><span class="token punctuation">(</span><span class="token punctuation">[</span>pointGraphic<span class="token punctuation">,</span> markerGraphic<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          routerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>filterPointGraphics <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token comment">/* 查询条件上的点 */</span>\n        <span class="token keyword">const</span> filterPointGraphics <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> filterPath <span class="token operator">=</span> pointInfo\n          <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>value<span class="token punctuation">)</span>\n          <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token operator">...</span>item<span class="token punctuation">,</span>\n            zmdm<span class="token punctuation">:</span> <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'value.key\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        path<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          <span class="token keyword">const</span> filterPathIndex <span class="token operator">=</span> filterPath<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item2</span><span class="token punctuation">)</span> <span class="token operator">=></span> item2<span class="token punctuation">.</span>zmdm <span class="token operator">===</span> item<span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>filterPathIndex <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">/** 画起点、终点、途点 **/</span>\n            <span class="token keyword">let</span> positionIcon <span class="token operator">=</span> byPositionIcon<span class="token punctuation">;</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>filterPathIndex <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n              positionIcon <span class="token operator">=</span> startPositionIcon<span class="token punctuation">;</span>\n            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>filterPathIndex <span class="token operator">===</span> filterPath<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n              positionIcon <span class="token operator">=</span> endPositionIcon<span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n            <span class="token keyword">const</span> markerGraphic <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Graphic</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n              geometry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                type<span class="token punctuation">:</span> <span class="token string">\'point\'</span><span class="token punctuation">,</span>\n                longitude<span class="token punctuation">:</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lon<span class="token punctuation">,</span>\n                latitude<span class="token punctuation">:</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lat\n              <span class="token punctuation">}</span><span class="token punctuation">,</span>\n              symbol<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                type<span class="token punctuation">:</span> <span class="token string">\'picture-marker\'</span><span class="token punctuation">,</span>\n                url<span class="token punctuation">:</span> positionIcon<span class="token punctuation">,</span>\n                yoffset<span class="token punctuation">:</span> <span class="token string">\'25px\'</span><span class="token punctuation">,</span>\n                width<span class="token punctuation">:</span> <span class="token string">\'32px\'</span><span class="token punctuation">,</span>\n                height<span class="token punctuation">:</span> <span class="token string">\'37px\'</span>\n              <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">/** 画起点、终点、途点 **/</span>\n\n            <span class="token comment">/** 画查询条件里面的标记点 **/</span>\n            <span class="token keyword">const</span> pointGraphic <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Graphic</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n              attributes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                point<span class="token punctuation">:</span> item\n              <span class="token punctuation">}</span><span class="token punctuation">,</span>\n              geometry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                type<span class="token punctuation">:</span> <span class="token string">\'point\'</span><span class="token punctuation">,</span>\n                longitude<span class="token punctuation">:</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lon<span class="token punctuation">,</span>\n                latitude<span class="token punctuation">:</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lat\n              <span class="token punctuation">}</span><span class="token punctuation">,</span>\n              symbol<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                type<span class="token punctuation">:</span> <span class="token string">\'picture-marker\'</span><span class="token punctuation">,</span>\n                url<span class="token punctuation">:</span> CircleIcon<span class="token punctuation">,</span>\n                width<span class="token punctuation">:</span> <span class="token string">\'20px\'</span><span class="token punctuation">,</span>\n                height<span class="token punctuation">:</span> <span class="token string">\'20px\'</span>\n              <span class="token punctuation">}</span><span class="token punctuation">,</span>\n              popupTemplate<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                title<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zm<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">：第</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filterPathIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">站</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n                content<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">经度：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>lon<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">，纬度：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>lat<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n                actions<span class="token punctuation">:</span>\n                  showAddOrDelBtn <span class="token operator">&amp;&amp;</span> filterPath<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">2</span>\n                    <span class="token operator">?</span> <span class="token punctuation">[</span>\n                        <span class="token punctuation">{</span>\n                          title<span class="token punctuation">:</span> <span class="token string">\'删除\'</span><span class="token punctuation">,</span>\n                          id<span class="token punctuation">:</span> <span class="token string">\'delete\'</span><span class="token punctuation">,</span>\n                          className<span class="token punctuation">:</span> <span class="token string">\'esri-icon-trash\'</span>\n                        <span class="token punctuation">}</span>\n                      <span class="token punctuation">]</span>\n                    <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n              <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">/** 画查询条件里面的标记点 **/</span>\n            filterPointGraphics<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>pointGraphic<span class="token punctuation">,</span> markerGraphic<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">// routerRef.current.filterPointGraphics = filterPointGraphics</span>\n            view<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">addMany</span><span class="token punctuation">(</span><span class="token punctuation">[</span>pointGraphic<span class="token punctuation">,</span> markerGraphic<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        routerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>filterPointGraphics <span class="token operator">=</span> filterPointGraphics<span class="token punctuation">;</span>\n        <span class="token comment">/** 画点 **/</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>view<span class="token punctuation">,</span> path<span class="token punctuation">,</span> pointInfo<span class="token punctuation">,</span> showAddOrDelBtn<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="设置悬浮文字"><a href="#%E8%AE%BE%E7%BD%AE%E6%82%AC%E6%B5%AE%E6%96%87%E5%AD%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>设置悬浮文字</h2>\n<p>设置鼠标轨迹监听事件，对站点、路线做悬浮文字提示处理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14268065093614602000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useEffect, useRef } from \'react\';\nimport { get, throttle } from \'lodash\';\n\n// 添加悬浮文字监听事件\nexport default function useShowHoverText(props) {\n  const { hoverNodeRef, view } = props;\n  const removePointerMoveEventRef = useRef(() => {});\n\n  useEffect(() => {\n    const handlePointMoveEvent = throttle((event) => {\n      if (!hoverNodeRef.current) {\n        return;\n      }\n      view.hitTest(event).then((response) => {\n        const type = get(response, \'results[0].graphic.geometry.type\');\n        const attributes = get(response, \'results[0].graphic.attributes\');\n        if (type === \'polyline\' && attributes) {\n          event.native.target.style = \'cursor: pointer\';\n          const xm = get(attributes, \'xm\');\n          hoverNodeRef.current.innerText = xm;\n          hoverNodeRef.current.style.left = \\`\\${event.x}px\\`;\n          hoverNodeRef.current.style.top = \\`\\${event.y}px\\`;\n          hoverNodeRef.current.style.display = \'block\';\n        } else if (type === \'point\' && attributes) {\n          event.native.target.style = \'cursor: pointer\';\n          const zm = get(attributes, \'point.zm\');\n          hoverNodeRef.current.innerText = zm;\n          hoverNodeRef.current.style.left = \\`\\${event.x - zm.length * 9}px\\`;\n          hoverNodeRef.current.style.top = \\`\\${event.y - 40}px\\`;\n          hoverNodeRef.current.style.display = \'block\';\n        } else {\n          hoverNodeRef.current.style.display = \'none\';\n          event.native.target.style = \'cursor: default\';\n        }\n      });\n    }, 200);\n\n    removePointerMoveEventRef.current();\n    const removePointerMoveEvent = view.on(\'pointer-move\', (event) => {\n      handlePointMoveEvent(event);\n    });\n    removePointerMoveEventRef.current = removePointerMoveEvent;\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n}`, `14268065093614602000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">,</span> throttle <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 添加悬浮文字监听事件</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">useShowHoverText</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> hoverNodeRef<span class="token punctuation">,</span> view <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> removePointerMoveEventRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> handlePointMoveEvent <span class="token operator">=</span> <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      view<span class="token punctuation">.</span><span class="token function">hitTest</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> type <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">\'results[0].graphic.geometry.type\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> attributes <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">\'results[0].graphic.attributes\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">\'polyline\'</span> <span class="token operator">&amp;&amp;</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          event<span class="token punctuation">.</span>native<span class="token punctuation">.</span>target<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">\'cursor: pointer\'</span><span class="token punctuation">;</span>\n          <span class="token keyword">const</span> xm <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>attributes<span class="token punctuation">,</span> <span class="token string">\'xm\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>innerText <span class="token operator">=</span> xm<span class="token punctuation">;</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>y<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">\'block\'</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">\'point\'</span> <span class="token operator">&amp;&amp;</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          event<span class="token punctuation">.</span>native<span class="token punctuation">.</span>target<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">\'cursor: pointer\'</span><span class="token punctuation">;</span>\n          <span class="token keyword">const</span> zm <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>attributes<span class="token punctuation">,</span> <span class="token string">\'point.zm\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>innerText <span class="token operator">=</span> zm<span class="token punctuation">;</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>x <span class="token operator">-</span> zm<span class="token punctuation">.</span>length <span class="token operator">*</span> <span class="token number">9</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token number">40</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">\'block\'</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">\'none\'</span><span class="token punctuation">;</span>\n          event<span class="token punctuation">.</span>native<span class="token punctuation">.</span>target<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">\'cursor: default\'</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    removePointerMoveEventRef<span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> removePointerMoveEvent <span class="token operator">=</span> view<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'pointer-move\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token function">handlePointMoveEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    removePointerMoveEventRef<span class="token punctuation">.</span>current <span class="token operator">=</span> removePointerMoveEvent<span class="token punctuation">;</span>\n    <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="设置删除、添加的监听事件"><a href="#%E8%AE%BE%E7%BD%AE%E5%88%A0%E9%99%A4%E3%80%81%E6%B7%BB%E5%8A%A0%E7%9A%84%E7%9B%91%E5%90%AC%E4%BA%8B%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>设置删除、添加的监听事件</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53508336076797166000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useEffect, useRef } from \'react\';\nimport { get } from \'lodash\';\nimport produce from \'immer\';\n\n// 设置删除、添加的监听事件\nexport default function useAddOrDelPoint(props) {\n  const { view, onPointInfoChange, pointInfo } = props;\n  const removeTriggerActionEventRef = useRef(() => {});\n\n  useEffect(() => {\n    const getFilterPointIndex = (point) => pointInfo.findIndex((item) => get(item, \'value.key\') === point.zmdm);\n\n    const handleAddPoint = () => {\n      const { point, path } = view.popup.viewModel.selectedFeature.attributes;\n      const state = produce(pointInfo, (draftState) => {\n        const filterIndex = getFilterPointIndex(point);\n        if (filterIndex !== -1) {\n          return;\n        }\n        const maxId = Math.max(...draftState.map((item) => item.id));\n        let insertIndex = 0;\n        const index = path.findIndex((item) => item.zmdm === point.zmdm);\n        // 向前查找\n        for (let i = index - 1; i >= 0; i--) {\n          const filterPointIndex = getFilterPointIndex(path[i]);\n          if (filterPointIndex !== -1) {\n            insertIndex = filterPointIndex + 1;\n            break;\n          }\n        }\n        draftState.splice(insertIndex, 0, {\n          id: maxId + 1,\n          value: {\n            key: point.zmdm,\n            label: point.zm\n          },\n          options: []\n        });\n      });\n      onPointInfoChange && onPointInfoChange(state);\n    };\n\n    const handleDeletePoint = () => {\n      const { point } = view.popup.viewModel.selectedFeature.attributes;\n      const state = produce(pointInfo, (draftState) => {\n        const index = getFilterPointIndex(point);\n        if (index !== -1) {\n          draftState.splice(index, 1);\n        }\n      });\n      onPointInfoChange && onPointInfoChange(state);\n    };\n\n    removeTriggerActionEventRef.current();\n    const removeTriggerActionEvent = view.popup.on(\'trigger-action\', (event) => {\n      const eventMap = {\n        add: handleAddPoint,\n        delete: handleDeletePoint\n      };\n      eventMap[event.action.id] && eventMap[event.action.id](event);\n      view.popup.close();\n    }).remove;\n    removeTriggerActionEventRef.current = removeTriggerActionEvent;\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [pointInfo]);\n}`, `53508336076797166000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> produce <span class="token keyword">from</span> <span class="token string">\'immer\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 设置删除、添加的监听事件</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">useAddOrDelPoint</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> view<span class="token punctuation">,</span> onPointInfoChange<span class="token punctuation">,</span> pointInfo <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> removeTriggerActionEventRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token function-variable function">getFilterPointIndex</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">point</span><span class="token punctuation">)</span> <span class="token operator">=></span> pointInfo<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'value.key\'</span><span class="token punctuation">)</span> <span class="token operator">===</span> point<span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> <span class="token function-variable function">handleAddPoint</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span> point<span class="token punctuation">,</span> path <span class="token punctuation">}</span> <span class="token operator">=</span> view<span class="token punctuation">.</span>popup<span class="token punctuation">.</span>viewModel<span class="token punctuation">.</span>selectedFeature<span class="token punctuation">.</span>attributes<span class="token punctuation">;</span>\n      <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">produce</span><span class="token punctuation">(</span>pointInfo<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">draftState</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> filterIndex <span class="token operator">=</span> <span class="token function">getFilterPointIndex</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>filterIndex <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">return</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">const</span> maxId <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token operator">...</span>draftState<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">let</span> insertIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> index <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>zmdm <span class="token operator">===</span> point<span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// 向前查找</span>\n        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">const</span> filterPointIndex <span class="token operator">=</span> <span class="token function">getFilterPointIndex</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>filterPointIndex <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            insertIndex <span class="token operator">=</span> filterPointIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>\n            <span class="token keyword">break</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n        draftState<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>insertIndex<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n          id<span class="token punctuation">:</span> maxId <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>\n          value<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            key<span class="token punctuation">:</span> point<span class="token punctuation">.</span>zmdm<span class="token punctuation">,</span>\n            label<span class="token punctuation">:</span> point<span class="token punctuation">.</span>zm\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          options<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      onPointInfoChange <span class="token operator">&amp;&amp;</span> <span class="token function">onPointInfoChange</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> <span class="token function-variable function">handleDeletePoint</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span> point <span class="token punctuation">}</span> <span class="token operator">=</span> view<span class="token punctuation">.</span>popup<span class="token punctuation">.</span>viewModel<span class="token punctuation">.</span>selectedFeature<span class="token punctuation">.</span>attributes<span class="token punctuation">;</span>\n      <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">produce</span><span class="token punctuation">(</span>pointInfo<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">draftState</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token function">getFilterPointIndex</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          draftState<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      onPointInfoChange <span class="token operator">&amp;&amp;</span> <span class="token function">onPointInfoChange</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n    removeTriggerActionEventRef<span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> removeTriggerActionEvent <span class="token operator">=</span> view<span class="token punctuation">.</span>popup<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'trigger-action\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> eventMap <span class="token operator">=</span> <span class="token punctuation">{</span>\n        add<span class="token punctuation">:</span> handleAddPoint<span class="token punctuation">,</span>\n        <span class="token keyword">delete</span><span class="token punctuation">:</span> handleDeletePoint\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      eventMap<span class="token punctuation">[</span>event<span class="token punctuation">.</span>action<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> eventMap<span class="token punctuation">[</span>event<span class="token punctuation">.</span>action<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      view<span class="token punctuation">.</span>popup<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>remove<span class="token punctuation">;</span>\n    removeTriggerActionEventRef<span class="token punctuation">.</span>current <span class="token operator">=</span> removeTriggerActionEvent<span class="token punctuation">;</span>\n    <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>pointInfo<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="实现效果"><a href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现效果</h2>\n<p><a target="_blank" href="/basic-map-73d1bc2751b9d5d59709b58e7e9472fa.gif">基本功能</a></p>\n<p><a target="_blank" href="/basic-map-2-38ff4e55afa0347ffbdcb8f646d77589.gif">基本功能-路线的粗细</a></p>\n<h1 id="修复路线未加载"><a href="#%E4%BF%AE%E5%A4%8D%E8%B7%AF%E7%BA%BF%E6%9C%AA%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修复路线未加载</h1>\n<p><code class="language-text">暂时未找到 view.graphics 完全加载时的方法，会造成白屏 bug</code> 的原因是在跳转页面时发现这个组件会有一定概率渲染不出路线，经过调试打印发现，是路线多次渲染造成的，需要解决多次渲染的问题，以下是跳转页面到这个组件：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-01-08-09-38-58-541a236902c530792c46ce26d1f1ecab-b8364.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 15.933669790915644%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsSAAALEgHS3X78AAAAi0lEQVQI103LuwrCQBSE4bz/g4iJacU+ElMoFhYWghBYWLPnMuesyQO4IgThL6aYrxJNy2LzjJzVXXIWd2Z+sZAou/HtSdsezQmHK3bDd6xVZok5FgmQW8GqSmZcMDG9PV0esumkHbS86z/ZDqhiDCGMQFJQYTARSSyTITmmMfL+zM1x+uG1ukd3zx+OrJv3XwSUFQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 01 08 09 38 58" title="" data-src="/static/2021-01-08-09-38-58-541a236902c530792c46ce26d1f1ecab-fee1c.png" data-srcset="/static/2021-01-08-09-38-58-541a236902c530792c46ce26d1f1ecab-a67b7.png 200w,\n/static/2021-01-08-09-38-58-541a236902c530792c46ce26d1f1ecab-0b187.png 400w,\n/static/2021-01-08-09-38-58-541a236902c530792c46ce26d1f1ecab-fee1c.png 800w,\n/static/2021-01-08-09-38-58-541a236902c530792c46ce26d1f1ecab-b1a91.png 1200w,\n/static/2021-01-08-09-38-58-541a236902c530792c46ce26d1f1ecab-b8364.png 1387w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-01-08-09-39-28-67fff2d0694aad43c53f12a0955a72d4-8b0e1.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 294px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 90.47619047619047%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABi0lEQVQ4y5VT7VKDMBDk/V/GF/CP1lHbzlh1LLXVKVAoXy0Q0EASSuICLeIfaW92bnJJ9m7vCBrjgqRpHBMgCEJCMs4FY/wEwY6h6KE+KhjXlKShbzn2yjIW5loPPEPJXKmi9bKi8vB9DCuq5GlRr3ONBVecWsQfE28CiNyI3CkJZr45osk89qY7+yENn8PNvbe+ydMFTrED0ERH5fz1ZXp3ez0Zj2ZPj/O3WSmoUqWsUDZvfFEd8s73oSmlNhtH19+Xy4/V6tMwTJJm2RctywpHUjZQNY6h+t2pyYRgVMF+vw/DMI7j3W7nOE5RFO3tvsm/sYYYhO12Cz44SNHdG7Qj2WnM933XdVEZiRhjgylqMqrZto3ikA2PMIqic8mojIJd20KIy2R7ngcyZIOcpml/QsOy24Y7Qzooz7JsmIx7bmNt25CAESAFJJwlGzQQMGcs0AISnTswVG5lJ0kCzzm/YGCtbNBa2ZTS7jFd8KnahvFasVk1NkwGx7IsKEfbyAJv4P8wTST6n/wDJhQJeQFsEdMAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 01 08 09 39 28" title="" data-src="/static/2021-01-08-09-39-28-67fff2d0694aad43c53f12a0955a72d4-8b0e1.png" data-srcset="/static/2021-01-08-09-39-28-67fff2d0694aad43c53f12a0955a72d4-2d2ea.png 200w,\n/static/2021-01-08-09-39-28-67fff2d0694aad43c53f12a0955a72d4-8b0e1.png 294w" data-sizes="(max-width: 294px) 100vw, 294px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>如图所示这里 hooks 多次渲染是导致路线加载不出来的原因，需要修复依赖的数据多次改变的问题，使用 useMemo 修复</p>\n<h2 id="主入口文件-1"><a href="#%E4%B8%BB%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>主入口文件</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82863909923624450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { useState, useEffect, useMemo } from \'react\';\nimport { setDefaultOptions } from \'esri-loader\';\n\nimport RouteDisplayLayer from \'./components/route-display-layer\';\nimport Map from \'./components/map\';\nimport { getConfig } from \'./api\';\n\nimport styles from \'./styles.less\';\n\nsetDefaultOptions({\n  css: \'/static-apps/mut/arcgis/esri/themes/light/main.css\',\n  url: \'/static-apps/mut/arcgis/init.js\'\n});\n\n/*\n  config: esri 三方库后端配置地址（外部配置）\n  height: 地图高度\n  onRef：map 的 ref 回调\n  settings： {\n    centerLon 地图中心经度\n    centerLat 地图中心纬度\n    zoom 缩放级别\n  }\n  pointInfo: 过滤条件的起点、终点、途径点渲染\n  onPointInfoChange: 过滤条件变化回调\n  goToCenter: 初次加载是否到中心点\n  isAddOrEdit: 是否显示添加删除按钮\n  path: 站点信息\n  route: 路线信息\n  transport: 运输信息\n*/\n\nexport { getConfig };\n\nexport default function RailwayMap(props) {\n  const { path, route } = props;\n  const [config, setConfig] = useState(props.config);\n\n  useEffect(() => {\n    const fetchConfig = async () => {\n      const data = await getConfig();\n      setConfig(data.result);\n    };\n    if (!config) {\n      fetchConfig();\n    }\n  }, [config]);\n\n  const { centerLon = 110, centerLat = 38, zoom = 5 } = props.settings || {};\n\n  const [map, setMap] = useState();\n  const [view, setView] = useState();\n\n  const isFloat = (number) => /^(-?\\d+)(\\.\\d+)?\\$/.test(number);\n\n  // 过滤掉没有经纬度结点或者经纬度为 0 的结点\n  const filterPath = useMemo(() => {\n    return path.filter((item) => isFloat(item.lat) && isFloat(item.lon) && +item.lat !== 0 && +item.lon !== 0);\n  }, [path]);\n\n  const filterRoute = useMemo(() => {\n    const getPointInfoByZmdm = (zmdm) => path.find((item) => item.zmdm === zmdm) || {};\n    const renderFilterRoute = [];\n    for (let i = 0; i < route.length; i++) {\n      // 补充缺失的线路，比如这种情况长沙-湘潭-武汉，长沙-湘潭段属于长湘线，湘潭到武汉属于湘武线\n      // 湘潭的经纬度为空，那么直接连起来的长沙 - 武汉叫长湘线\n      if (\n        getPointInfoByZmdm(route[i].zmdm).lon &&\n        getPointInfoByZmdm(route[i].zmdm).lat &&\n        (!getPointInfoByZmdm(route[i].next_zmdm).lon || !getPointInfoByZmdm(route[i].next_zmdm).lat)\n      ) {\n        const { zm: startZm, zmdm: startZmdm, xm } = route[i];\n\n        // 累加缺失的站点的里程数\n        let distance = 0;\n        if (route[i].czjl) {\n          distance = route[i].czjl;\n        }\n\n        let index = null;\n        for (let j = i + 1; j < route.length; j++) {\n          if (route[j].czjl) {\n            distance += route[j].czjl;\n          }\n          // 这里需要找到第一个终点站经纬度不为零的站点的下标，以此来进行缺失经纬度站点的合并\n          if (getPointInfoByZmdm(route[j].next_zmdm).lon && getPointInfoByZmdm(route[j].next_zmdm).lat) {\n            index = j;\n            break;\n          }\n        }\n        if (!index) {\n          // eslint-disable-next-line no-continue\n          continue;\n        }\n        const { next_zmdm: endZmdm, next_zm: endZm } = route[index];\n        renderFilterRoute.push({\n          zmdm: startZmdm,\n          zm: startZm,\n          next_zmdm: endZmdm,\n          next_zm: endZm,\n          xm,\n          czjl: distance\n        });\n        i = index;\n      }\n\n      // 经纬度都有的结点直接插入\n      if (\n        getPointInfoByZmdm(route[i].zmdm).lon &&\n        getPointInfoByZmdm(route[i].zmdm).lat &&\n        getPointInfoByZmdm(route[i].next_zmdm).lon &&\n        getPointInfoByZmdm(route[i].next_zmdm).lat\n      ) {\n        renderFilterRoute.push(route[i]);\n      }\n    }\n    return renderFilterRoute;\n  }, [route, path]);\n\n  if (!config) {\n    return null;\n  }\n\n  return (\n    <div className={styles.container}>\n      <Map\n        {...props}\n        config={config}\n        viewProperties={{\n          zoom: +zoom,\n          center: [+centerLon, +centerLat]\n        }}\n        setMap={setMap}\n        setView={setView}\n        view={view}\n      />\n      {map && view && <RouteDisplayLayer {...props} path={filterPath} route={filterRoute} map={map} view={view} />}\n    </div>\n  );\n}`, `82863909923624450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{54-59,61-118}"\n              >\n                <span class="gatsby-code-button-language">js{54-59,61-118}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect<span class="token punctuation">,</span> useMemo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> setDefaultOptions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'esri-loader\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> RouteDisplayLayer <span class="token keyword">from</span> <span class="token string">\'./components/route-display-layer\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> Map <span class="token keyword">from</span> <span class="token string">\'./components/map\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> getConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'./api\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./styles.less\'</span><span class="token punctuation">;</span>\n\n<span class="token function">setDefaultOptions</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  css<span class="token punctuation">:</span> <span class="token string">\'/static-apps/mut/arcgis/esri/themes/light/main.css\'</span><span class="token punctuation">,</span>\n  url<span class="token punctuation">:</span> <span class="token string">\'/static-apps/mut/arcgis/init.js\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">/*</span>\n<span class="token comment">  config: esri 三方库后端配置地址（外部配置）</span>\n<span class="token comment">  height: 地图高度</span>\n<span class="token comment">  onRef：map 的 ref 回调</span>\n<span class="token comment">  settings： {</span>\n<span class="token comment">    centerLon 地图中心经度</span>\n<span class="token comment">    centerLat 地图中心纬度</span>\n<span class="token comment">    zoom 缩放级别</span>\n<span class="token comment">  }</span>\n<span class="token comment">  pointInfo: 过滤条件的起点、终点、途径点渲染</span>\n<span class="token comment">  onPointInfoChange: 过滤条件变化回调</span>\n<span class="token comment">  goToCenter: 初次加载是否到中心点</span>\n<span class="token comment">  isAddOrEdit: 是否显示添加删除按钮</span>\n<span class="token comment">  path: 站点信息</span>\n<span class="token comment">  route: 路线信息</span>\n<span class="token comment">  transport: 运输信息</span>\n<span class="token comment">*/</span>\n\n<span class="token keyword">export</span> <span class="token punctuation">{</span> getConfig <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">RailwayMap</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> route <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>config<span class="token punctuation">,</span> setConfig<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token function-variable function">fetchConfig</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">setConfig</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">fetchConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>config<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> centerLon <span class="token operator">=</span> <span class="token number">110</span><span class="token punctuation">,</span> centerLat <span class="token operator">=</span> <span class="token number">38</span><span class="token punctuation">,</span> zoom <span class="token operator">=</span> <span class="token number">5</span> <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">.</span>settings <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>map<span class="token punctuation">,</span> setMap<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>view<span class="token punctuation">,</span> setView<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> <span class="token function-variable function">isFloat</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">number</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token regex">/^(-?\\d+)(\\.\\d+)?$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 过滤掉没有经纬度结点或者经纬度为 0 的结点</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> filterPath <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">isFloat</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>lat<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isFloat</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>lon<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lat <span class="token operator">!==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lon <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> filterRoute <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">const</span> <span class="token function-variable function">getPointInfoByZmdm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">zmdm</span><span class="token punctuation">)</span> <span class="token operator">=></span> path<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>zmdm <span class="token operator">===</span> zmdm<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">const</span> renderFilterRoute <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> route<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      <span class="token comment">// 补充缺失的线路，比如这种情况长沙-湘潭-武汉，长沙-湘潭段属于长湘线，湘潭到武汉属于湘武线</span></span><span class="gatsby-highlight-code-line">      <span class="token comment">// 湘潭的经纬度为空，那么直接连起来的长沙 - 武汉叫长湘线</span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">if</span> <span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">        <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">        <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> zm<span class="token punctuation">:</span> startZm<span class="token punctuation">,</span> zmdm<span class="token punctuation">:</span> startZmdm<span class="token punctuation">,</span> xm <span class="token punctuation">}</span> <span class="token operator">=</span> route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">        <span class="token comment">// 累加缺失的站点的里程数</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">let</span> distance <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>czjl<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          distance <span class="token operator">=</span> route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>czjl<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">        <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> route<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>czjl<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">            distance <span class="token operator">+=</span> route<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>czjl<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">          <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">          <span class="token comment">// 这里需要找到第一个终点站经纬度不为零的站点的下标，以此来进行缺失经纬度站点的合并</span></span><span class="gatsby-highlight-code-line">          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">&amp;&amp;</span> <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">            index <span class="token operator">=</span> j<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">            <span class="token keyword">break</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">          <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>index<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          <span class="token comment">// eslint-disable-next-line no-continue</span></span><span class="gatsby-highlight-code-line">          <span class="token keyword">continue</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> next_zmdm<span class="token punctuation">:</span> endZmdm<span class="token punctuation">,</span> next_zm<span class="token punctuation">:</span> endZm <span class="token punctuation">}</span> <span class="token operator">=</span> route<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        renderFilterRoute<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          zmdm<span class="token punctuation">:</span> startZmdm<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">          zm<span class="token punctuation">:</span> startZm<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">          next_zmdm<span class="token punctuation">:</span> endZmdm<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">          next_zm<span class="token punctuation">:</span> endZm<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">          xm<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">          czjl<span class="token punctuation">:</span> distance</span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        i <span class="token operator">=</span> index<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">      <span class="token comment">// 经纬度都有的结点直接插入</span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">if</span> <span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">        <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">        <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">        <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">        <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat</span><span class="gatsby-highlight-code-line">      <span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        renderFilterRoute<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">return</span> renderFilterRoute<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>route<span class="token punctuation">,</span> path<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>container<span class="token punctuation">}</span><span class="token operator">></span>\n      <span class="token operator">&lt;</span>Map\n        <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span>\n        config<span class="token operator">=</span><span class="token punctuation">{</span>config<span class="token punctuation">}</span>\n        viewProperties<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n          zoom<span class="token punctuation">:</span> <span class="token operator">+</span>zoom<span class="token punctuation">,</span>\n          center<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">+</span>centerLon<span class="token punctuation">,</span> <span class="token operator">+</span>centerLat<span class="token punctuation">]</span>\n        <span class="token punctuation">}</span><span class="token punctuation">}</span>\n        setMap<span class="token operator">=</span><span class="token punctuation">{</span>setMap<span class="token punctuation">}</span>\n        setView<span class="token operator">=</span><span class="token punctuation">{</span>setView<span class="token punctuation">}</span>\n        view<span class="token operator">=</span><span class="token punctuation">{</span>view<span class="token punctuation">}</span>\n      <span class="token operator">/</span><span class="token operator">></span>\n      <span class="token punctuation">{</span>map <span class="token operator">&amp;&amp;</span> view <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>RouteDisplayLayer <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> path<span class="token operator">=</span><span class="token punctuation">{</span>filterPath<span class="token punctuation">}</span> route<span class="token operator">=</span><span class="token punctuation">{</span>filterRoute<span class="token punctuation">}</span> map<span class="token operator">=</span><span class="token punctuation">{</span>map<span class="token punctuation">}</span> view<span class="token operator">=</span><span class="token punctuation">{</span>view<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="传入的参数文件"><a href="#%E4%BC%A0%E5%85%A5%E7%9A%84%E5%8F%82%E6%95%B0%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>传入的参数文件</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8265605436601731000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { useMemo } from \'react\';\nimport _ from \'lodash\';\nimport RailwayMap from \'@/common/railway-map\';\n\nexport default function RailwayMapDisplay({ data, config, index }: any) {\n  const path = _.get(data, \\`[\\${index}].result.path\\`, []);\n  const pointInfo = _.get(data, \\`[\\${index}].filter.pointInfo\\`, []);\n  const filterPointInfo = useMemo(\n    () =>\n      pointInfo.map((item: any) => ({\n        value: {\n          key: item.zmdm,\n          label: item.zm\n        }\n      })),\n    [pointInfo]\n  );\n  return (\n    config && (\n      <RailwayMap\n        path={path}\n        route={_.get(data, \\`[\\${index}].result.route\\`, [])}\n        transport={_.get(data, \\`[\\${index}].result.transport\\`, [])}\n        height={240}\n        goToCenter\n        showAddOrDelBtn={false}\n        showLineInfo={false}\n        config={config}\n        pointInfo={filterPointInfo}\n      />\n    )\n  );\n}`, `8265605436601731000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{8-17}"\n              >\n                <span class="gatsby-code-button-language">js{8-17}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useMemo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> _ <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> RailwayMap <span class="token keyword">from</span> <span class="token string">\'@/common/railway-map\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">RailwayMapDisplay</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data<span class="token punctuation">,</span> config<span class="token punctuation">,</span> index <span class="token punctuation">}</span><span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> path <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">].result.path</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> pointInfo <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">].filter.pointInfo</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> filterPointInfo <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span></span><span class="gatsby-highlight-code-line">      pointInfo<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        value<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          key<span class="token punctuation">:</span> item<span class="token punctuation">.</span>zmdm<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">          label<span class="token punctuation">:</span> item<span class="token punctuation">.</span>zm</span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">[</span>pointInfo<span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">)</span><span class="token punctuation">;</span></span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    config <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>\n      <span class="token operator">&lt;</span>RailwayMap\n        path<span class="token operator">=</span><span class="token punctuation">{</span>path<span class="token punctuation">}</span>\n        route<span class="token operator">=</span><span class="token punctuation">{</span>_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">].result.route</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n        transport<span class="token operator">=</span><span class="token punctuation">{</span>_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">].result.transport</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n        height<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">240</span><span class="token punctuation">}</span>\n        goToCenter\n        showAddOrDelBtn<span class="token operator">=</span><span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">}</span>\n        showLineInfo<span class="token operator">=</span><span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">}</span>\n        config<span class="token operator">=</span><span class="token punctuation">{</span>config<span class="token punctuation">}</span>\n        pointInfo<span class="token operator">=</span><span class="token punctuation">{</span>filterPointInfo<span class="token punctuation">}</span>\n      <span class="token operator">/</span><span class="token operator">></span>\n    <span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="修复效果"><a href="#%E4%BF%AE%E5%A4%8D%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修复效果</h2>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-01-08-10-20-28-b27a7a497357ec134b49603a98037a97-60e1b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 17.050359712230218%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsSAAALEgHS3X78AAAAm0lEQVQI1z3LuQrCQBRG4bz/e4hG4wIWdhbiZBMFQTTgRpQs473zz2RieqcIwlec5nisZPfVrUVjYQxbq4wmoorAWa7Ol+c2vg+FnoRYHTAOe77APNGehiQqjVEK0s2OUrK1dMzK9T7v2o/IMNhQEKmRgB/2XC9S7RXFqyrfgAQIYK2Z2LU83SRz/Sh4uaNA1LME0xjBX4T02vwAD1ya+fvb5GcAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 01 08 10 20 28" title="" data-src="/static/2021-01-08-10-20-28-b27a7a497357ec134b49603a98037a97-fee1c.png" data-srcset="/static/2021-01-08-10-20-28-b27a7a497357ec134b49603a98037a97-a67b7.png 200w,\n/static/2021-01-08-10-20-28-b27a7a497357ec134b49603a98037a97-0b187.png 400w,\n/static/2021-01-08-10-20-28-b27a7a497357ec134b49603a98037a97-fee1c.png 800w,\n/static/2021-01-08-10-20-28-b27a7a497357ec134b49603a98037a97-b1a91.png 1200w,\n/static/2021-01-08-10-20-28-b27a7a497357ec134b49603a98037a97-60e1b.png 1390w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2021-01-08-10-20-47-30c6439fd3893d4c388636f257861a11-ce56f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 188px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 131.38297872340425%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAaCAIAAAA44esqAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACK0lEQVQ4y4WUyXLCQAxE8//fAEfOnPgCzoRidbGbfd9iY3bIY5oQY2xQlafksaVWtzTzdb1eL5fLbrdbr9ee5202m+VyOZ1OXddl//rWvngOh0O73a5Wq91ut1wul0qlfD6fy+U+B5+NjcdjggeDwWw2I8VisRgOh+Dzx+l0OkfYDfl4PCaTyVgsxppIJOLxeDqdTqVSlCBS75DFmRSs2+0W2qvVynEcHF5B5lMk8n6/bzab8CwUCt/GGo1GJpOxLAsJLGNkea3ihkxuNCM9apPoZExo2tE/4chSG4YgVyoVqQ04PuIVi0UcGIUg804O6Hl/5hrDIYC8P8Yo5PJid7VpjBjatk3PeAW51+t9HhL4IC+9ZcgQmfYCxQ7l8PXBMBJ5Pp9DG7TRaAQ44uOwQwp/fCDFPXgymTBerGShWo03FuhQEJmHsqkTqE6nQzApiGdgIdJqtRCcHcohO0L6U9yR+ZtSWZGqVquxEsbf/X6ffejYxhDFX8i9VXTlIRUOUAIJWIhgNJOsGkNggdLA+EfiERAynlTOGOpUAK4V/tCmBA1J5HjCqmgsm81yDQCOU6/XGUzKYWwiD4aM3IDoAOicYI+C3x1JkIGCJyAcSXoGbYT4fBnIwERzwXIqgH1zAT1xpqtiK2TxpBA003iGlvB/GWAg48MCWNFmVQz7ig9BhiQ4ugPQXBew7iYMzVnZpHNPEyadmTsOg2OMUlk5TzCnQ3zC15VAaX7wX3ZWxWMJ/MgpAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2021 01 08 10 20 47" title="" data-src="/static/2021-01-08-10-20-47-30c6439fd3893d4c388636f257861a11-ce56f.png" data-srcset="/static/2021-01-08-10-20-47-30c6439fd3893d4c388636f257861a11-ce56f.png 188w" data-sizes="(max-width: 188px) 100vw, 188px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/基于arcgis地图组件的搭建部署/index.md absPath of file >>> MarkdownRemark",timeToRead:30,frontmatter:{date:"2021-04-23 18:53:54",path:"/arcgis-map-component-build-deploy/",tags:"前端, arcgis, 地图, 预研",title:"基于arcgis地图组件的搭建部署",draft:null}},{excerpt:"项目架构 公司项目分为以下几种架构： 主项目-扩展项目：扩展项目前端独立，是以 npm 包的形式安装到主项目，后端可以独立编译，但不能独立运行，即后端与主项目共用一套，主项目需要对扩展项目编译出的后端代码进行监听来实现增量编译 主项目-子项目：微前端架构，子项目前、后端独立可运行 需求背景 需要解决主项目-扩展项目架构下主项目的后端不能增量编译的问题 技术选型 选型 优点 缺点 直接在 node_modules 目录下开发 主项目已实现对 node_modules 下扩展项目的监听 每次 npm…",html:'<h1 id="项目架构"><a href="#%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>项目架构</h1>\n<p>公司项目分为以下几种架构：</p>\n<ol>\n<li>主项目-扩展项目：扩展项目前端独立，是以 npm 包的形式安装到主项目，后端可以独立编译，但不能独立运行，即后端与主项目共用一套，主项目需要对扩展项目编译出的后端代码进行监听来实现增量编译</li>\n<li>主项目-子项目：微前端架构，子项目前、后端独立可运行</li>\n</ol>\n<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>需要解决主项目-扩展项目架构下主项目的后端不能增量编译的问题</p>\n<h1 id="技术选型"><a href="#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术选型</h1>\n<table>\n<thead>\n<tr>\n<th align="center">选型</th>\n<th align="center">优点</th>\n<th align="center">缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="center">直接在 node_modules 目录下开发</td>\n<td align="center">主项目已实现对 node_modules 下扩展项目的监听</td>\n<td align="center">每次 npm install 都要重新新建项目</td>\n</tr>\n<tr>\n<td align="center">gulp 文件同步</td>\n<td align="center">有第三方插件</td>\n<td align="center">需要多运行一个文件同步脚本</td>\n</tr>\n<tr>\n<td align="center">npm link</td>\n<td align="center">不需要多运行一个脚本</td>\n<td align="center">需要每次手动重启主项目来让后端代码生效</td>\n</tr>\n<tr>\n<td align="center">nodemon + npm link</td>\n<td align="center">监听到扩展项目变化自动重启</td>\n<td align="center">每次 npm install 都要重新 npm link</td>\n</tr>\n</tbody>\n</table>\n<h1 id="解决过程"><a href="#%E8%A7%A3%E5%86%B3%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决过程</h1>\n<h2 id="gulp-文件同步"><a href="#gulp-%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>gulp 文件同步</h2>\n<p>核心逻辑：监听扩展项目编译出来的后端代码，发现改动时同步到 node_modules 下扩展项目的位置</p>\n<p>./config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23717567776883806000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  //同步文件更改到指定目录\n  syncTo: \'../主项目/node_modules/扩展项目/extend\'\n};`, `23717567776883806000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token comment">//同步文件更改到指定目录</span>\n  syncTo<span class="token punctuation">:</span> <span class="token string">\'../主项目/node_modules/扩展项目/extend\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>./gulpfile.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50563841403929756000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const gulp = require(\'gulp\');\nconst fileSync = require(\'gulp-file-sync\');\nconst { syncTo } = require(\'./config\');\nconst mkdirp = require(\'mkdirp\');\nconst fs = require(\'fs\');\nconst watch = require(\'gulp-watch\');\nconst run = require(\'run-sequence\');\n\ngulp.task(\'sync\', function() {\n  try {\n    let state = fs.statSync(syncTo);\n    if (!state.isDirectory()) {\n      mkdirp(syncTo);\n    }\n  } catch (e) {\n    console.log(e);\n    mkdirp(syncTo);\n  }\n\n  fileSync(\'extend\', syncTo);\n});\n\ngulp.task(\'watch-extend\', function() {\n  watch([\'./extend/**\'], function() {\n    run(\'sync\');\n  });\n});\n\ngulp.task(\'watch\', [\'watch-extend\']);\n\ngulp.task(\'default\', [\'sync\', \'watch\']);`, `50563841403929756000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> gulp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'gulp\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fileSync <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'gulp-file-sync\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> syncTo <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./config\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> mkdirp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'mkdirp\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> watch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'gulp-watch\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> run <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'run-sequence\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">\'sync\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> state <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>syncTo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">mkdirp</span><span class="token punctuation">(</span>syncTo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">mkdirp</span><span class="token punctuation">(</span>syncTo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">fileSync</span><span class="token punctuation">(</span><span class="token string">\'extend\'</span><span class="token punctuation">,</span> syncTo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">\'watch-extend\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'./extend/**\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">run</span><span class="token punctuation">(</span><span class="token string">\'sync\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">\'watch\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'watch-extend\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">\'default\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'sync\'</span><span class="token punctuation">,</span> <span class="token string">\'watch\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="nodemon--npm-link"><a href="#nodemon--npm-link" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>nodemon + npm link</h2>\n<ol>\n<li>对扩展项目进行 npm link 操作，然后在主项目中 npm link 扩展项目，可以在主项目的 node_modules 下看到指向扩展项目的软链接</li>\n<li>主项目使用了 nodemon 来监听 node_modules 文件变化，鉴于每次重启主项目之后扩展项目的代码才会生效的问题，需要解决 nodemon 不能监听软链接下文件变化的问题</li>\n</ol>\n<p>核心逻辑：</p>\n<ol>\n<li>在不影响 nodemon 脚本调用逻辑的情况下，在 nodemon.json 添加 <code class="language-text">watchSymbolLink</code> 属性，明确监听软链接的文件位置</li>\n<li>利用 glob 三方库读取 watchSymbolLink 下的文件，当判断读到的文件是软链接文件时（isSymbolicLink），读取真实的文件路径（realpathSync）</li>\n<li>在监听原来文件的基础上，调用 nodemon 监听另外真实的文件路径</li>\n</ol>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94135037633970490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;scripts&quot;: {\n    &quot;dev:server&quot;: &quot;node bin/nodemon.js --config nodemon.json ./bin/www&quot;\n  }\n}`, `94135037633970490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token property">"dev:server"</span><span class="token operator">:</span> <span class="token string">"node bin/nodemon.js --config nodemon.json ./bin/www"</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>bin\\nodemon.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78026186410812820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const nodemon = require(\'nodemon\');\nconst nodemonCli = require(\'nodemon/lib/cli\');\nconst options = nodemonCli.parse(process.argv);\nconst glob = require(\'glob\');\nconst fs = require(\'fs\');\nconst lodash = require(\'lodash\');\nconst path = require(\'path\');\n\n// &quot;watchSymbolLink&quot;: [\n//   {\n//     &quot;url&quot;: &quot;node_modules/sugo-analytics-extend-*&quot;,\n//     &quot;path&quot;: &quot;/extend/app/**/*&quot;\n//   },\n// ],\n// 或\n// &quot;watchSymbolLink&quot;: [\n//    &quot;node_modules/sugo-analytics-extend-*&quot;,\n// ],\nconst { configFile, ...optionsRest } = options;\n\nconst nodemonJsonPath = path.join(process.cwd(), configFile);\n\nconst nodemonJson = require(nodemonJsonPath);\n\nconst { watch, watchSymbolLink = [], ...nodemonJsonRest } = nodemonJson;\n\nconst dirs = [];\n\nwatchSymbolLink.forEach((item) => {\n  const { url, path: linkPath = \'\' } = lodash.isObject(item) ? item : { url: item };\n  const paths = glob\n    .sync(url)\n    .filter((a) => fs.lstatSync(a).isSymbolicLink())\n    .map((a) => path.join(fs.realpathSync(a), linkPath));\n  dirs.push(...paths);\n});\n\nconst opts = {\n  ...optionsRest,\n  ...nodemonJsonRest,\n  watch: [...watch, ...dirs]\n};\n\n// console.log(opts)\n\nnodemon(opts);\n\nnodemon.on(\'quit\', function() {\n  process.exit();\n});\n\nconst packageJsonPath = path.join(process.cwd(), \'package.json\');\n\n// checks for available update and returns an instance\nconst pkg = JSON.parse(fs.readFileSync(packageJsonPath));\n\nif (pkg.version.indexOf(\'0.0.0\') !== 0 && options.noUpdateNotifier !== true) {\n  require(\'update-notifier\')({ pkg }).notify();\n}`, `78026186410812820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> nodemon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'nodemon\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> nodemonCli <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'nodemon/lib/cli\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> options <span class="token operator">=</span> nodemonCli<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> glob <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'glob\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> lodash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// "watchSymbolLink": [</span>\n<span class="token comment">//   {</span>\n<span class="token comment">//     "url": "node_modules/sugo-analytics-extend-*",</span>\n<span class="token comment">//     "path": "/extend/app/**/*"</span>\n<span class="token comment">//   },</span>\n<span class="token comment">// ],</span>\n<span class="token comment">// 或</span>\n<span class="token comment">// "watchSymbolLink": [</span>\n<span class="token comment">//    "node_modules/sugo-analytics-extend-*",</span>\n<span class="token comment">// ],</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> configFile<span class="token punctuation">,</span> <span class="token operator">...</span>optionsRest <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> nodemonJsonPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> configFile<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> nodemonJson <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>nodemonJsonPath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> watch<span class="token punctuation">,</span> watchSymbolLink <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">...</span>nodemonJsonRest <span class="token punctuation">}</span> <span class="token operator">=</span> nodemonJson<span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> dirs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\nwatchSymbolLink<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> url<span class="token punctuation">,</span> path<span class="token punctuation">:</span> linkPath <span class="token operator">=</span> <span class="token string">\'\'</span> <span class="token punctuation">}</span> <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">isObject</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">?</span> item <span class="token punctuation">:</span> <span class="token punctuation">{</span> url<span class="token punctuation">:</span> item <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> paths <span class="token operator">=</span> glob\n    <span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token operator">=></span> fs<span class="token punctuation">.</span><span class="token function">lstatSync</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isSymbolicLink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token operator">=></span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">realpathSync</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> linkPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  dirs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>paths<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token operator">...</span>optionsRest<span class="token punctuation">,</span>\n  <span class="token operator">...</span>nodemonJsonRest<span class="token punctuation">,</span>\n  watch<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>watch<span class="token punctuation">,</span> <span class="token operator">...</span>dirs<span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// console.log(opts)</span>\n\n<span class="token function">nodemon</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nnodemon<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'quit\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> packageJsonPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'package.json\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// checks for available update and returns an instance</span>\n<span class="token keyword">const</span> pkg <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>packageJsonPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>version<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">\'0.0.0\'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>noUpdateNotifier <span class="token operator">!==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'update-notifier\'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span> pkg <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>nodemon.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6836658454359191000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;restartable&quot;: &quot;rs&quot;,\n  &quot;ignore&quot;: [&quot;.git&quot;, &quot;node_modules&quot;, &quot;node_modules/**/node_modules&quot;],\n  &quot;verbose&quot;: true,\n  &quot;execMap&quot;: {\n    &quot;js&quot;: &quot;node --harmony&quot;\n  },\n  &quot;events&quot;: {\n    &quot;restart&quot;: &quot;osascript -e \'display notification \\&quot;App restarted due to:\\n\'\\$FILENAME\'\\&quot; with title \\&quot;nodemon\\&quot;\'&quot;\n  },\n  &quot;watch&quot;: [\n    &quot;src/server&quot;,\n    &quot;src/common&quot;,\n    &quot;config.default.js&quot;,\n    &quot;node_modules/sugo-analytics-extend-*/extend/app/**/*&quot;,\n    &quot;config.js&quot;\n  ],\n  &quot;watchSymbolLink&quot;: [\n    {\n      &quot;url&quot;: &quot;node_modules/sugo-analytics-extend-*&quot;,\n      &quot;path&quot;: &quot;extend/app/**/*&quot;\n    }\n  ],\n  &quot;env&quot;: {\n    &quot;NODE_ENV&quot;: &quot;development&quot;\n  },\n  &quot;delay&quot;: &quot;1000&quot;,\n  &quot;ext&quot;: &quot;js,json&quot;\n}`, `6836658454359191000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json{18-23}"\n              >\n                <span class="gatsby-code-button-language">json{18-23}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"restartable"</span><span class="token operator">:</span> <span class="token string">"rs"</span><span class="token punctuation">,</span>\n  <span class="token property">"ignore"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">".git"</span><span class="token punctuation">,</span> <span class="token string">"node_modules"</span><span class="token punctuation">,</span> <span class="token string">"node_modules/**/node_modules"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token property">"verbose"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  <span class="token property">"execMap"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token property">"js"</span><span class="token operator">:</span> <span class="token string">"node --harmony"</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token property">"events"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token property">"restart"</span><span class="token operator">:</span> <span class="token string">"osascript -e \'display notification \\"App restarted due to:\\n\'$FILENAME\'\\" with title \\"nodemon\\"\'"</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token property">"watch"</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n    <span class="token string">"src/server"</span><span class="token punctuation">,</span>\n    <span class="token string">"src/common"</span><span class="token punctuation">,</span>\n    <span class="token string">"config.default.js"</span><span class="token punctuation">,</span>\n    <span class="token string">"node_modules/sugo-analytics-extend-*/extend/app/**/*"</span><span class="token punctuation">,</span>\n    <span class="token string">"config.js"</span>\n  <span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  <span class="token property">"watchSymbolLink"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"node_modules/sugo-analytics-extend-*"</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"extend/app/**/*"</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>  <span class="token property">"env"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token property">"NODE_ENV"</span><span class="token operator">:</span> <span class="token string">"development"</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token property">"delay"</span><span class="token operator">:</span> <span class="token string">"1000"</span><span class="token punctuation">,</span>\n  <span class="token property">"ext"</span><span class="token operator">:</span> <span class="token string">"js,json"</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/基于nodemon实现监听文件链接变化/index.md absPath of file >>> MarkdownRemark",timeToRead:3,frontmatter:{date:"2021-01-05 10:02:54",path:"/nodemon-monitor-link-changes/",tags:"后端, nodejs, nodemon, 预研",title:"基于nodemon实现监听文件链接变化",draft:null}}],length:31,tag:"预研",pagesSum:7,page:3}}}});