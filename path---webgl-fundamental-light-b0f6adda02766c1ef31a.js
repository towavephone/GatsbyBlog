webpackJsonp([0x8dd40151310b],{1682:function(n,s){n.exports={data:{file:{childImageSharp:{sizes:{base64:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAACXBIWXMAAAsSAAALEgHS3X78AAAHlElEQVRIx12We2xT5xXAbcI2Vmn7o1I1uhVYRxL8tuPn9bXv0+/4/YgdOyYkkATCCEEYsqVNC2wCIYQWShmUBFh4hMAWECot0BUtlI4yAS1oKqJQXimsDBgTU8codnLO7r0uUPpJn87Rp+/8vvOdc75zr8xmZmTieI1NykU5yxOfxDncz3NUjAlyDXMjXGMhys+cG+FzGQ8VU4t7XuV8z8m+GUkrJclSqVReYJ0ZWQ8Tl2AdTPhnq9ns2QKd+crDZiHha8NsYCE21HZiXphpb3sxxTf99Tdsw51ldHqFaLOXXyzvYqOyZ0YPk5soylfouuUbvHOxh56JbiqJfi4/FnE1lxKetrGUZ954nbcdU/752ORpxWVsc6mZjPxctFtApeVtra1lmIPwTxClgeCqvGTsX/WWOEbtyTGWSoGbToOPzUHQ1QghVxOEhRniZ5U8XB4TzvTdgj1ZJdq2OOrkGhVRBnrYFum6TiK0l2fr0emMlVxcBhlnEniqDjlBuqg0CnD0MPWiDrwzhR4u+5B3x3WiLUNHJjxzZYvR8ZKTCP+Xo1JoM/nBYvSB1egHuyUIrCOBPj4LtD0KlD2K4h7SGip62aygxzaK9rHA3Aqt2vw0MRYjnyJtYaQdsXG9hgWFwgmVlXZUKUjUqmm0CgfwhA80Kgr1Wg40Sue4SuFEnZq+YjMbJ0kh0zmfemjQ0j2EJYh2a23RVOODIBvHmCsBUaoWLDoWKIsP50bTApxC5QwH1Ghp0Gk4MBk8aDLQEslooCc88VClsK+zGANI2mqLer0XFuea8PSuN+DM7o3QWyhAR7IBfj+vDbyOICS9aSjkZo8nvSlUKuxXLDUOKdN6LSl/AlRUE+vNAnD50l8XeTIEPiYEzXYG5mlNeGz7BvjPpY/g5snDcHxwE+zs7oCh1zvHCrNm48u/ML8j2muVQblBZ3t6ZY2KXKtQcDiwdk1xx9rV0BlqghEuD4fNUTy1Zwhw7Cbioxu461fdsOgFDa5pbh3zu6NifE9f+XCPlGHS5nuaFI3K8brJ4EUHES4WFiyEP2/dCPc2vYH/3NIHePcywP1LWLp3Ec4tWQa3FvbAu7294yqVA801rju5utYfiQyKDD4DnC8GWEhMafJPtBALxuHjo3+C8bufIn59DfHBFcDiDcQvzyF+/iEsbWuDadNMaDW5H7nY6Iyyh165zfLNtdUqIqLTsEJSQqBVUTD1JQPqdRT8sf9NuH7kMHy0fRg+O3EUzp96H/Zs2SBklxFKxwFmowtdTCIoPQx7oKLzl32PPTRPVSudDwQgCrUGL0+twdzsDjjSdwD2J1fh/q7N0N+1EtykB178qVY4lAahRktWkw95JrG4DAxPvHU3Wwb+rlcsHfK0WNxCoMdUCgdUaxnMBPKw7dVe2LyhDw4MboORA4NQOd2CaiUFaqWjZJGAyQGRUeubP8FqElqZspquEBeUM2zrnEQUa3R8USVcp2qGDZV6ErqXL4PfrlwFhSU9cPL4MejfshOsZq90sCg5KvHZ5MnPfa+cmFrxukRFuRZNcYqIoNngHheeFmiF11ClIDBdPwfqG9qhc1E3rF25GnrX90M204JqBfWItPrP8lTqa7vFpSw3GJ9cZjI4pW5TXaWezpKxh4Q5gEY9LwApVOtZMApxVWhd2DKvC7K5FjTUsFCj45Ah4yXaHuz1MBlgyHCb1HXISIXMTcekOJqN1h/72Mx92h5DwuwHjeChWseBQsNgJJ6H944eB5oNgaLajnaL/07E24wuKr7Cz+XuuenUsMioCxYmyHhnSPLQTYVVYVfjI46Mo80WBLMgLY4E1FhCOENBAsfHQG/0juuNPqGguU8ywXas5XNbg6783wJ8w781GtUPJc+irkap/Ufdje0JXytStnDJbA2D1Z4EKxEHsyUMRmsIdcZaNFpCYBYqwWQLPhD3Btn6t2Pe5uF0cD7Sdr/xmSab8racFaDooOvuk0wDEs40EFQGbVQGbEKXJoTPgZ3JoJGIgULvR6M1jE67rzvpae5ojC7GEJ9rfgILc7lC3NV0T6flTtjoPLK+VuD8rcD65gDtaQInPxOtzoxQRrXgD8/BdW/+YezYByfxvfdHvnxl+ZLKCDfzUMIze60Ey+brJukrqcjA1u3tBw8dfZiZuRQFaNFory/WEPUlE5kFK5WDQKRtbFPfUOnChUvFL27cwKuj/8CBHXv2iQw/k/KGuNwyCYiIkhw+sO/569eu7b1+ffR/H5z4BAcG38X1m/biyjX9ODR8GC9dHsXLV0fx5KlzePDIyFd7ht9ZJZhJrcvLhV/wMuUPljQWtC6Z+FjfuWPHlPMXLq64Onpz3d8/Pf9WX//OW2vWbITBof3n3tqya9fbh/7SvW1gZ9Xj/V1dr8kf614qIZONjBwrezi8Ty54K5d9ZzTmF+xe1LnioaD+4Nvrn4/ermif3yHp8UCDLMCky7Z+n192+/YdST9z5mPZ7t1D8ouXv6gQ4S9WTplks7mut8xZijxbKz2vvi2D39/cPyB/HC5xOm2czPvd35F8rkGCS0+I4WXV1QbJaMq06XqbNXCQJIILpH8hOic3GghZMpl62qG/Nf4PRzaQ862MzO4AAAAASUVORK5CYII=",aspectRatio:.6666666666666666,src:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-25c91.png",srcSet:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-8a97b.png 200w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-0fdf3.png 400w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-25c91.png 600w",srcWebp:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-216f6.webp",srcSetWebp:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-5d70e.webp 200w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-d1677.webp 400w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-216f6.webp 600w",sizes:"(max-width: 600px) 100vw, 600px"}}},site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}},mainPost:{html:'<h1 id="webgl-三维方向光源"><a href="#webgl-%E4%B8%89%E7%BB%B4%E6%96%B9%E5%90%91%E5%85%89%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 三维方向光源</h1>\n<p>实施光照的方式有很多种，最简单的可能就是方向光源了。</p>\n<p>方向光是指光照均匀地来自某一个方向，晴朗天气下的太阳经常被当作方向光源，它距离太远所以光线被看作是平行的照到地面上。</p>\n<p>计算方向光非常简单，将方向光的方向和面的朝向点乘就可以得到两个方向的余弦值。</p>\n<p>这有个例子</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/jstbeo?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>随意拖动其中的点，如果两点方向刚好相反，点乘结果则为 -1，如果方向相同结果为 1。</p>\n<p>这有什么用呢？如果将三维物体的朝向和光的方向点乘，结果为 1 则物体朝向和光照方向相同，为 -1 则物体朝向和光照方向相反。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/j5lmj8?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>我们可以将颜色值和点乘结果相乘，有光了！</p>\n<p>还有一个问题，我们如何知道三维物体的朝向？</p>\n<h2 id="法向量"><a href="#%E6%B3%95%E5%90%91%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>法向量</h2>\n<p>我不知道为什么叫法向量，但是在三维图形学中法向量就是描述面的朝向的单位向量。</p>\n<p>这是正方体和球体的一些法向量。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/xyb9lu?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>这些插在物体上的线就是对应顶点的法向量。</p>\n<p>注意到正方体在每个顶角有 3 个法向量。这是因为需要 3 个法向量去描述相邻的每个面的朝向。</p>\n<p>这里的法向量是基于他们的方向着色的，正 x 方向为红色，上方向为绿色，正 z 方向为蓝色。</p>\n<p>让我们来给上节中的 F 添加法向量。由于 F 非常规则并且朝向都是 <code class="language-text">x, y, z</code> 轴，所以非常简单。正面的的部分法向量为 <code class="language-text">0, 0, 1</code>，背面的部分法向量为 <code class="language-text">0, 0, -1</code>，左面为 <code class="language-text">-1, 0, 0</code>，右面为 <code class="language-text">1, 0, 0</code>，上面为 <code class="language-text">0, 1, 0</code>，然后底面为 <code class="language-text">0, -1, 0</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50640192486878480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function setNormals(gl) {\n  var normals = new Float32Array([\n    // 正面左竖\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n\n    // 正面上横\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n\n    // 正面中横\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n\n    // 背面左竖\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n\n    // 背面上横\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n\n    // 背面中横\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n\n    // 顶部\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n\n    // 上横右面\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n\n    // 上横下面\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n\n    // 上横和中横之间\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n\n    // 中横上面\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n\n    // 中横右面\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n\n    // 中横底面\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n\n    // 底部右侧\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n    1,\n    0,\n    0,\n\n    // 底面\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n\n    // 左面\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0,\n    -1,\n    0,\n    0\n  ]);\n  gl.bufferData(gl.ARRAY_BUFFER, normals, gl.STATIC_DRAW);\n}`, `50640192486878480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">setNormals</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> normals <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n    <span class="token comment">// 正面左竖</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 正面上横</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 正面中横</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 背面左竖</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 背面上横</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 背面中横</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 顶部</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 上横右面</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 上横下面</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 上横和中横之间</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 中横上面</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 中横右面</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 中横底面</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 底部右侧</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 底面</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n\n    <span class="token comment">// 左面</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>\n    <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token number">0</span>\n  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> normals<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在代码中使用它们，先移除顶点颜色以便观察光照效果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49163985559493020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 找顶点着色器中的属性\nvar positionLocation = gl.getAttribLocation(program, \'a_position\');\n// var colorLocation = gl.getAttribLocation(program, &quot;a_color&quot;);\nvar normalLocation = gl.getAttribLocation(program, \'a_normal\');\n\n// ...\n\n// // 创建一个缓冲存储颜色\n// var colorBuffer = gl.createBuffer();\n// // 绑定到 ARRAY_BUFFER\n// gl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);\n// // 将几何数据放入缓冲\n// setColors(gl);\n\n// 创建缓冲存储法向量\nvar normalBuffer = gl.createBuffer();\n// 绑定到 ARRAY_BUFFER (可以看作 ARRAY_BUFFER = normalBuffer)\ngl.bindBuffer(gl.ARRAY_BUFFER, normalBuffer);\n// 将法向量存入缓冲\nsetNormals(gl);`, `49163985559493020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 找顶点着色器中的属性</span>\n<span class="token keyword">var</span> positionLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'a_position\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// var colorLocation = gl.getAttribLocation(program, "a_color");</span>\n<span class="token keyword">var</span> normalLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'a_normal\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token comment">// // 创建一个缓冲存储颜色</span>\n<span class="token comment">// var colorBuffer = gl.createBuffer();</span>\n<span class="token comment">// // 绑定到 ARRAY_BUFFER</span>\n<span class="token comment">// gl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);</span>\n<span class="token comment">// // 将几何数据放入缓冲</span>\n<span class="token comment">// setColors(gl);</span>\n\n<span class="token comment">// 创建缓冲存储法向量</span>\n<span class="token keyword">var</span> normalBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 绑定到 ARRAY_BUFFER (可以看作 ARRAY_BUFFER = normalBuffer)</span>\ngl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> normalBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 将法向量存入缓冲</span>\n<span class="token function">setNormals</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在渲染的时候</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69345775984019900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// // 启用颜色属性\n// gl.enableVertexAttribArray(colorLocation);\n\n// // 绑定颜色缓冲\n// gl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);\n\n// // 告诉颜色属性怎么从 colorBuffer(ARRAY_BUFFER) 中读取颜色值\n// var size = 3;                 // 每次迭代使用 3 个单位的数据\n// var type = gl.UNSIGNED_BYTE;  // 单位数据类型是无符号 8 位整数\n// var normalize = true;         // 标准化数据 (从 0-255 转换到 0.0-1.0)\n// var stride = 0;               // 0 = 移动距离 * 单位距离长度 sizeof(type)，每次迭代跳多少距离到下一个数据\n// var offset = 0;               // 从绑定缓冲的起始处开始\n// gl.vertexAttribPointer(\n//     colorLocation, size, type, normalize, stride, offset)\n\n// 启用法向量属性\ngl.enableVertexAttribArray(normalLocation);\n\n// 绑定法向量缓冲\ngl.bindBuffer(gl.ARRAY_BUFFER, normalBuffer);\n\n// 告诉法向量属性怎么从 normalBuffer (ARRAY_BUFFER) 中读取值\nvar size = 3; // 每次迭代使用 3 个单位的数据\nvar type = gl.FLOAT; // 单位数据类型是 32 位浮点型\nvar normalize = false; // 单位化 (从 0-255 转换到 0-1)\nvar stride = 0; // 0 = 移动距离 * 单位距离长度 sizeof(type)，每次迭代跳多少距离到下一个数据\nvar offset = 0; // 从绑定缓冲的起始处开始\ngl.vertexAttribPointer(normalLocation, size, type, normalize, stride, offset);`, `69345775984019900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// // 启用颜色属性</span>\n<span class="token comment">// gl.enableVertexAttribArray(colorLocation);</span>\n\n<span class="token comment">// // 绑定颜色缓冲</span>\n<span class="token comment">// gl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);</span>\n\n<span class="token comment">// // 告诉颜色属性怎么从 colorBuffer(ARRAY_BUFFER) 中读取颜色值</span>\n<span class="token comment">// var size = 3;                 // 每次迭代使用 3 个单位的数据</span>\n<span class="token comment">// var type = gl.UNSIGNED_BYTE;  // 单位数据类型是无符号 8 位整数</span>\n<span class="token comment">// var normalize = true;         // 标准化数据 (从 0-255 转换到 0.0-1.0)</span>\n<span class="token comment">// var stride = 0;               // 0 = 移动距离 * 单位距离长度 sizeof(type)，每次迭代跳多少距离到下一个数据</span>\n<span class="token comment">// var offset = 0;               // 从绑定缓冲的起始处开始</span>\n<span class="token comment">// gl.vertexAttribPointer(</span>\n<span class="token comment">//     colorLocation, size, type, normalize, stride, offset)</span>\n\n<span class="token comment">// 启用法向量属性</span>\ngl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>normalLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 绑定法向量缓冲</span>\ngl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> normalBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 告诉法向量属性怎么从 normalBuffer (ARRAY_BUFFER) 中读取值</span>\n<span class="token keyword">var</span> size <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 每次迭代使用 3 个单位的数据</span>\n<span class="token keyword">var</span> type <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">;</span> <span class="token comment">// 单位数据类型是 32 位浮点型</span>\n<span class="token keyword">var</span> normalize <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 单位化 (从 0-255 转换到 0-1)</span>\n<span class="token keyword">var</span> stride <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 0 = 移动距离 * 单位距离长度 sizeof(type)，每次迭代跳多少距离到下一个数据</span>\n<span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 从绑定缓冲的起始处开始</span>\ngl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>normalLocation<span class="token punctuation">,</span> size<span class="token punctuation">,</span> type<span class="token punctuation">,</span> normalize<span class="token punctuation">,</span> stride<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在让着色器使用它</p>\n<p>首先在顶点着色器中只将法向量传递给片断着色器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85963347400424280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\n// attribute vec4 a_color;\nattribute vec3 a_normal;\n\nuniform mat4 u_matrix;\n\n// varying vec4 v_color;\nvarying vec3 v_normal;\n\nvoid main() {\n  // 将位置和矩阵相乘\n  gl_Position = u_matrix * a_position;\n\n  // // 将颜色传到片断着色器\n  // v_color = a_color;\n\n  // 将法向量传到片断着色器\n  v_normal = a_normal;\n}`, `85963347400424280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token comment">// attribute vec4 a_color;</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec3</span> a_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_matrix<span class="token punctuation">;</span>\n\n<span class="token comment">// varying vec4 v_color;</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 将位置和矩阵相乘</span>\n  gl_Position <span class="token operator">=</span> u_matrix <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n\n  <span class="token comment">// // 将颜色传到片断着色器</span>\n  <span class="token comment">// v_color = a_color;</span>\n\n  <span class="token comment">// 将法向量传到片断着色器</span>\n  v_normal <span class="token operator">=</span> a_normal<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后在片断着色器中将法向量和光照方向点乘</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1497833710755269600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 从顶点着色器中传入的值\n// varying vec4 v_color;\nvarying vec3 v_normal;\n\nuniform vec3 u_reverseLightDirection;\nuniform vec4 u_color;\n\nvoid main() {\n   // 由于 v_normal 是插值出来的，有可能不是单位向量，\n   // 可以用 normalize 将其单位化。\n   vec3 normal = normalize(v_normal);\n\n   float light = dot(normal, u_reverseLightDirection);\n\n   gl_FragColor = u_color;\n\n   // 将颜色部分（不包括 alpha）和光照相乘\n   gl_FragColor.rgb *= light;\n}`, `1497833710755269600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器中传入的值</span>\n<span class="token comment">// varying vec4 v_color;</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_reverseLightDirection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_color<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 由于 v_normal 是插值出来的，有可能不是单位向量，</span>\n   <span class="token comment">// 可以用 normalize 将其单位化。</span>\n   <span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_normal<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">float</span> light <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> u_reverseLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   gl_FragColor <span class="token operator">=</span> u_color<span class="token punctuation">;</span>\n\n   <span class="token comment">// 将颜色部分（不包括 alpha）和光照相乘</span>\n   gl_FragColor<span class="token punctuation">.</span>rgb <span class="token operator">*</span><span class="token operator">=</span> light<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后找到 <code class="language-text">u_color</code> 和 <code class="language-text">u_reverseLightDirection</code> 的位置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34926439433851544000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 寻找全局变量\nvar matrixLocation = gl.getUniformLocation(program, \'u_matrix\');\nvar colorLocation = gl.getUniformLocation(program, \'u_color\');\nvar reverseLightDirectionLocation = gl.getUniformLocation(program, \'u_reverseLightDirection\');`, `34926439433851544000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 寻找全局变量</span>\n<span class="token keyword">var</span> matrixLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_matrix\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> colorLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_color\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> reverseLightDirectionLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_reverseLightDirection\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为它们赋值</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16453329843612275000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 设置矩阵\ngl.uniformMatrix4fv(matrixLocation, false, worldViewProjectionMatrix);\n\n// 设置使用的颜色\ngl.uniform4fv(colorLocation, [0.2, 1, 0.2, 1]); // green\n\n// 设置光线方向\ngl.uniform3fv(reverseLightDirectionLocation, m4.normalize([0.5, 0.7, 1]));`, `16453329843612275000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 设置矩阵</span>\ngl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>matrixLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> worldViewProjectionMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 设置使用的颜色</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform4fv</span><span class="token punctuation">(</span>colorLocation<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// green</span>\n\n<span class="token comment">// 设置光线方向</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform3fv</span><span class="token punctuation">(</span>reverseLightDirectionLocation<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们之前用到的 normalize 会将原向量转换为单位向量。例子中的 x = 0.5 说明光线是从右往左照，y = 0.7 说明光线从上方往下照，z = 1 说明光线从在场景前方。对应的值表示光源大多指向场景，在靠右方和上方一点的位置。</p>\n<p>这是结果</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/vp33w2?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>如果你旋转了 F 就会发现，F 虽然旋转了但是光照没变，我们希望随着 F 的旋转正面总是被照亮的。</p>\n<p>为了解决这个问题就需要在物体重定向时重定向法向量，和位置一样我们也可以将向量和矩阵相乘，这个矩阵显然是 world 矩阵，现在我们只传了一个矩阵 <code class="language-text">u_matrix</code>，所以先来改成传递两个矩阵，一个叫做 <code class="language-text">u_world</code> 的世界矩阵，另一个叫做 <code class="language-text">u_worldViewProjection</code> 也就是我们现在的 <code class="language-text">u_matrix</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43976257627125230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\nattribute vec3 a_normal;\n\nuniform mat4 u_worldViewProjection;\nuniform mat4 u_world;\n\nvarying vec3 v_normal;\n\nvoid main() {\n  // 将位置和矩阵相乘\n  gl_Position = u_worldViewProjection * a_position;\n\n  // 重定向法向量并传递给片断着色器\n  v_normal = mat3(u_world) * a_normal;\n}`, `43976257627125230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec3</span> a_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_worldViewProjection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_world<span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 将位置和矩阵相乘</span>\n  gl_Position <span class="token operator">=</span> u_worldViewProjection <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n\n  <span class="token comment">// 重定向法向量并传递给片断着色器</span>\n  v_normal <span class="token operator">=</span> <span class="token keyword">mat3</span><span class="token punctuation">(</span>u_world<span class="token punctuation">)</span> <span class="token operator">*</span> a_normal<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意到我们将 <code class="language-text">a_normal</code> 与 <code class="language-text">mat3(u_world)</code> 相乘，那是因为法向量是方向所以不用关心位移，矩阵的左上 3x3 部分才是控制姿态的。</p>\n<p>找到全局变量</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79587596662112350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 寻找全局变量\nvar worldViewProjectionLocation = gl.getUniformLocation(program, \'u_worldViewProjection\');\nvar worldLocation = gl.getUniformLocation(program, \'u_world\');`, `79587596662112350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 寻找全局变量</span>\n<span class="token keyword">var</span> worldViewProjectionLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_worldViewProjection\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> worldLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_world\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>然后更新它们</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74818712743269580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 设置矩阵\ngl.uniformMatrix4fv(worldViewProjectionLocation, false, worldViewProjectionMatrix);\ngl.uniformMatrix4fv(worldLocation, false, worldMatrix);`, `74818712743269580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 设置矩阵</span>\ngl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>worldViewProjectionLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> worldViewProjectionMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>worldLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> worldMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/it9qvy?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>旋转后就会发现面对 F 的面总是被照亮的。</p>\n<p>这里有一个问题我不知道如何表述所以就用图解展示，我们用 normal 和 u_world 相乘去重定向法向量，如果世界矩阵被缩放了怎么办？事实是会得到错误的法向量。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/zzocr1?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>我从没想弄清为什么，但解决办法就是对世界矩阵求逆并转置，用这个矩阵就会得到正确的结果。</p>\n<p>在图解里中间的紫色球体是未缩放的，左边的红色球体用的世界矩阵并缩放了，你可以看出有些不太对劲。右边蓝色的球体用的是世界矩阵求逆并转置后的矩阵。</p>\n<p>点击图解循环观察不同的表示形式，你会发现在缩放严重时左边的（世界矩阵）法向量和表面没有保持垂直关系，而右边的（世界矩阵求逆并转置）一直保持垂直。最后一种模式是将它们渲染成红色，你会发现两个球体的光照结果相差非常大，基于可视化的结果可以得出使用世界矩阵求逆转置是对的。</p>\n<p>修改代码让示例使用这种矩阵，首先更新着色器，理论上我们可以直接更新 <code class="language-text">u_world</code> 的值，但是最好将它重命名以表示它真正的含义，防止混淆。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9133903674600897000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\nattribute vec3 a_normal;\n\nuniform mat4 u_worldViewProjection;\nuniform mat4 u_worldInverseTranspose;\n\nvarying vec3 v_normal;\n\nvoid main() {\n  // 将位置和矩阵相乘\n  gl_Position = u_worldViewProjection * a_position;\n\n  // 重定向法向量并传递给片断着色器\n  v_normal = mat3(u_worldInverseTranspose) * a_normal;\n}`, `9133903674600897000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec3</span> a_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_worldViewProjection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_worldInverseTranspose<span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 将位置和矩阵相乘</span>\n  gl_Position <span class="token operator">=</span> u_worldViewProjection <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n\n  <span class="token comment">// 重定向法向量并传递给片断着色器</span>\n  v_normal <span class="token operator">=</span> <span class="token keyword">mat3</span><span class="token punctuation">(</span>u_worldInverseTranspose<span class="token punctuation">)</span> <span class="token operator">*</span> a_normal<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后找到它</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87939936444992340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// var worldLocation = gl.getUniformLocation(program, \'u_world\');\nvar worldInverseTransposeLocation = gl.getUniformLocation(program, \'u_worldInverseTranspose\');`, `87939936444992340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// var worldLocation = gl.getUniformLocation(program, \'u_world\');</span>\n<span class="token keyword">var</span> worldInverseTransposeLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_worldInverseTranspose\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>更新它</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33848466873880010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var worldViewProjectionMatrix = m4.multiply(viewProjectionMatrix, worldMatrix);\nvar worldInverseMatrix = m4.inverse(worldMatrix);\nvar worldInverseTransposeMatrix = m4.transpose(worldInverseMatrix);\n\n// 设置矩阵\ngl.uniformMatrix4fv(worldViewProjectionLocation, false, worldViewProjectionMatrix);\n// gl.uniformMatrix4fv(worldLocation, false, worldMatrix);\ngl.uniformMatrix4fv(worldInverseTransposeLocation, false, worldInverseTransposeMatrix);`, `33848466873880010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> worldViewProjectionMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>viewProjectionMatrix<span class="token punctuation">,</span> worldMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> worldInverseMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>worldMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> worldInverseTransposeMatrix <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">transpose</span><span class="token punctuation">(</span>worldInverseMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 设置矩阵</span>\ngl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>worldViewProjectionLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> worldViewProjectionMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// gl.uniformMatrix4fv(worldLocation, false, worldMatrix);</span>\ngl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>worldInverseTransposeLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> worldInverseTransposeMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是转置的代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66800435864273470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var m4 = {\n  transpose: function(m) {\n    return [m[0], m[4], m[8], m[12], m[1], m[5], m[9], m[13], m[2], m[6], m[10], m[14], m[3], m[7], m[11], m[15]];\n  }\n\n  // ...\n};`, `66800435864273470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> m4 <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">transpose</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">[</span>m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>由于我们并没有进行缩放，所以没有明显的变化，但防患于未然。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/vy56uh?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="mat3u_worldinversetranspose--a_normal-的可选方案"><a href="#mat3u_worldinversetranspose--a_normal-%E7%9A%84%E5%8F%AF%E9%80%89%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="language-text">mat3(u_worldInverseTranspose) * a_normal</code> 的可选方案</h2>\n<p>之前的着色器中出现了这样的代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83759468757472530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`v_normal = mat3(u_worldInverseTranspose) * a_normal;`, `83759468757472530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">v_normal <span class="token operator">=</span> <span class="token function">mat3</span><span class="token punctuation">(</span>u_worldInverseTranspose<span class="token punctuation">)</span> <span class="token operator">*</span> a_normal<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>我们也可以这样做</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41913321526239790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`v_normal = (u_worldInverseTranspose * vec4(a_normal, 0)).xyz;`, `41913321526239790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">v_normal <span class="token operator">=</span> <span class="token punctuation">(</span>u_worldInverseTranspose <span class="token operator">*</span> <span class="token function">vec4</span><span class="token punctuation">(</span>a_normal<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>由于 w 在相乘前被赋值为 0，所以在相乘后负责平移的部分与 0 相乘被移除了。我认为这可能是更常用的方式，mat3 的做法只是对我来说更简洁但我经常用前一种方法。</p>\n<p>当然另一种解决方案是将 <code class="language-text">u_worldInverseTranspose</code> 直接构造成 mat3。这有两个不能这么做的理由，第一个是我们可能需要一个完整的 <code class="language-text">u_worldInverseTranspose</code> 对象传递一个 mat4 给还要给其他地方使用，另一个是我们在 JavaScript 中的所有矩阵方法都是针对 4x4 的矩阵，如果没有其他特别的需求，没有必要构造一个 3x3 的矩阵，或者是把 4x4 转换成 3x3。</p>\n<h1 id="webgl-三维点光源"><a href="#webgl-%E4%B8%89%E7%BB%B4%E7%82%B9%E5%85%89%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 三维点光源</h1>\n<p>上篇中说到方向光统一来自一个方向，在渲染前设置好方向。</p>\n<p>如果代替方向而是从三维空间中选一个点当作光源，然后在着色器中根据光源和表面位置计算光照方向的话，就是点光源了。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/i3grsj?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>如果旋转上方的表面会发现，每个点都有一个不同的面到光源的矢量，将这个矢量和法向量点乘后，表面上的每个点都会有一个不同的光照值。</p>\n<p>让我们实现它吧。</p>\n<p>首先需要一个光源位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5006855453952785000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`uniform vec3 u_lightWorldPosition;`, `5006855453952785000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_lightWorldPosition<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后需要计算表面的世界坐标，我们可以将位置和世界矩阵相乘得到</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21505756078836204000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`uniform mat4 u_world;\n\n// ...\n\n// 计算表面的世界坐标\nvec3 surfaceWorldPosition = (u_world * a_position).xyz;`, `21505756078836204000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_world<span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 计算表面的世界坐标</span>\n<span class="token keyword">vec3</span> surfaceWorldPosition <span class="token operator">=</span> <span class="token punctuation">(</span>u_world <span class="token operator">*</span> a_position<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后可以计算出一个从表面到光源的矢量，用来模拟之前的方向光，只是这次我们为表面上的每个点都计算了一个方向。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10200785965982128000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`v_surfaceToLight = u_lightWorldPosition - surfaceWorldPosition;`, `10200785965982128000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl">v_surfaceToLight <span class="token operator">=</span> u_lightWorldPosition <span class="token operator">-</span> surfaceWorldPosition<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这是全部的内容</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68958989494876760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\nattribute vec3 a_normal;\n\nuniform vec3 u_lightWorldPosition;\n\nuniform mat4 u_world;\nuniform mat4 u_worldViewProjection;\nuniform mat4 u_worldInverseTranspose;\n\nvarying vec3 v_normal;\n\nvarying vec3 v_surfaceToLight;\n\nvoid main() {\n  // 将位置和矩阵相乘\n  gl_Position = u_worldViewProjection * a_position;\n\n  // 重定向法向量并传递给片断着色器\n  v_normal = mat3(u_worldInverseTranspose) * a_normal;\n\n  // 计算表面的世界坐标\n  vec3 surfaceWorldPosition = (u_world * a_position).xyz;\n\n  // 计算表面到光源的方向\n  // 传递给片断着色器\n  v_surfaceToLight = u_lightWorldPosition - surfaceWorldPosition;\n}`, `68958989494876760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{4,6,12,21-26}"\n              >\n                <span class="gatsby-code-button-language">glsl{4,6,12,21-26}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec3</span> a_normal<span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_lightWorldPosition<span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_world<span class="token punctuation">;</span></span><span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_worldViewProjection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_worldInverseTranspose<span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_surfaceToLight<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 将位置和矩阵相乘</span>\n  gl_Position <span class="token operator">=</span> u_worldViewProjection <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n\n  <span class="token comment">// 重定向法向量并传递给片断着色器</span>\n  v_normal <span class="token operator">=</span> <span class="token keyword">mat3</span><span class="token punctuation">(</span>u_worldInverseTranspose<span class="token punctuation">)</span> <span class="token operator">*</span> a_normal<span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 计算表面的世界坐标</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec3</span> surfaceWorldPosition <span class="token operator">=</span> <span class="token punctuation">(</span>u_world <span class="token operator">*</span> a_position<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 计算表面到光源的方向</span></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 传递给片断着色器</span></span><span class="gatsby-highlight-code-line">  v_surfaceToLight <span class="token operator">=</span> u_lightWorldPosition <span class="token operator">-</span> surfaceWorldPosition<span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在片断着色器中需要将表面到光源的方向进行单位化，注意，虽然我们可以在顶点着色器中传递单位向量，但是 varying 会进行插值再传给片断着色器，所以片断着色器中的向量基本上不是单位向量了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4767732874490305000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 从顶点着色器中传入的值\nvarying vec3 v_normal;\nvarying vec3 v_surfaceToLight;\n\n// uniform vec3 u_reverseLightDirection;\nuniform vec4 u_color;\n\nvoid main() {\n  // 由于 v_normal 是可变量，所以经过插值后不再是单位向量\n  // 单位化后会成为单位向量\n  vec3 normal = normalize(v_normal);\n\n  vec3 surfaceToLightDirection = normalize(v_surfaceToLight);\n\n  -float light = dot(normal, u_reverseLightDirection);\n  +float light = dot(normal, surfaceToLightDirection);\n\n  gl_FragColor = u_color;\n\n  // 只将颜色部分（不包含 alpha）和光照相乘\n  gl_FragColor.rgb *= light;\n}`, `4767732874490305000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{5,7}"\n              >\n                <span class="gatsby-code-button-language">glsl{5,7}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器中传入的值</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_surfaceToLight<span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// uniform vec3 u_reverseLightDirection;</span></span><span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_color<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 由于 v_normal 是可变量，所以经过插值后不再是单位向量</span>\n  <span class="token comment">// 单位化后会成为单位向量</span>\n  <span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_normal<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">vec3</span> surfaceToLightDirection <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_surfaceToLight<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token operator">-</span><span class="token keyword">float</span> light <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> u_reverseLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token operator">+</span><span class="token keyword">float</span> light <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> surfaceToLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  gl_FragColor <span class="token operator">=</span> u_color<span class="token punctuation">;</span>\n\n  <span class="token comment">// 只将颜色部分（不包含 alpha）和光照相乘</span>\n  gl_FragColor<span class="token punctuation">.</span>rgb <span class="token operator">*</span><span class="token operator">=</span> light<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后需要找到 <code class="language-text">u_world</code> 和 <code class="language-text">u_lightWorldPosition</code> 的位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19896237059909284000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// var reverseLightDirectionLocation = gl.getUniformLocation(program, \'u_reverseLightDirection\');\nvar lightWorldPositionLocation = gl.getUniformLocation(program, \'u_lightWorldPosition\');\nvar worldLocation = gl.getUniformLocation(program, \'u_world\');`, `19896237059909284000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// var reverseLightDirectionLocation = gl.getUniformLocation(program, \'u_reverseLightDirection\');</span>\n<span class="token keyword">var</span> lightWorldPositionLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_lightWorldPosition\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> worldLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_world\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>设置它们</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10100447601424212000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 设置矩阵\ngl.uniformMatrix4fv(worldLocation, false, worldMatrix);\ngl.uniformMatrix4fv(worldViewProjectionLocation, false, worldViewProjectionMatrix);\n\n// ...\n\n// // 设置光照方向\n// gl.uniform3fv(reverseLightDirectionLocation, m4.normalize([0.5, 0.7, 1]));\n// 设置光源位置\ngl.uniform3fv(lightWorldPositionLocation, [20, 30, 50]);`, `10100447601424212000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 设置矩阵</span>\ngl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>worldLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> worldMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">uniformMatrix4fv</span><span class="token punctuation">(</span>worldViewProjectionLocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> worldViewProjectionMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token comment">// // 设置光照方向</span>\n<span class="token comment">// gl.uniform3fv(reverseLightDirectionLocation, m4.normalize([0.5, 0.7, 1]));</span>\n<span class="token comment">// 设置光源位置</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform3fv</span><span class="token punctuation">(</span>lightWorldPositionLocation<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是结果</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/xwmmsc?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>现在我们可以加一个叫做镜面高光的东西。</p>\n<p>观察现实世界中的物体，如果物体表面恰好将光线反射到你眼前，就会显得非常明亮，像镜子一样。</p>\n<p>我们可以通过计算光线是否反射到眼前来模拟这种情况，点乘又一次起到了至关重要的作用。</p>\n<p>如何测试呢？如果入射角和反射角恰好与眼睛和和光源的夹角相同，那么光线就会反射到眼前。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/352uf4?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>如果我们知道了物体表面到光源的方向（刚刚已经计算过了），加上物体表面到视区/眼睛/相机的方向，再除以 2 得到 halfVector 向量，将这个向量和法向量比较，如果方向一致，那么光线就会被反射到眼前。那么如何确定方向是否一致呢？用之前的点乘就可以了。1 表示相符，0 表示垂直，-1 表示相反。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/yrs3bw?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>所以首先我们需要传入相机位置，计算表面到相机的方向矢量，然后传递到片断着色器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19980988343649320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`attribute vec4 a_position;\nattribute vec3 a_normal;\n\nuniform vec3 u_lightWorldPosition;\nuniform vec3 u_viewWorldPosition;\n\nuniform mat4 u_world;\nuniform mat4 u_worldViewProjection;\nuniform mat4 u_worldInverseTranspose;\n\nvarying vec3 v_normal;\n\nvarying vec3 v_surfaceToLight;\nvarying vec3 v_surfaceToView;\n\nvoid main() {\n  // 将位置和矩阵相乘\n  gl_Position = u_worldViewProjection * a_position;\n\n  // 重定向法向量并传递到片断着色器\n  v_normal = mat3(u_worldInverseTranspose) * a_normal;\n\n  // 计算表面的世界坐标\n  vec3 surfaceWorldPosition = (u_world * a_position).xyz;\n\n  // 计算表面到光源的方向\n  // 然后传递到片断着色器\n  v_surfaceToLight = u_lightWorldPosition - surfaceWorldPosition;\n\n  // 计算表面到相机的方向\n  // 然后传递到片断着色器\n  v_surfaceToView = u_viewWorldPosition - surfaceWorldPosition;\n}`, `19980988343649320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{5,14,30-32}"\n              >\n                <span class="gatsby-code-button-language">glsl{5,14,30-32}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec4</span> a_position<span class="token punctuation">;</span>\n<span class="token keyword">attribute</span> <span class="token keyword">vec3</span> a_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_lightWorldPosition<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_viewWorldPosition<span class="token punctuation">;</span></span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_world<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_worldViewProjection<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> u_worldInverseTranspose<span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_surfaceToLight<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_surfaceToView<span class="token punctuation">;</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 将位置和矩阵相乘</span>\n  gl_Position <span class="token operator">=</span> u_worldViewProjection <span class="token operator">*</span> a_position<span class="token punctuation">;</span>\n\n  <span class="token comment">// 重定向法向量并传递到片断着色器</span>\n  v_normal <span class="token operator">=</span> <span class="token keyword">mat3</span><span class="token punctuation">(</span>u_worldInverseTranspose<span class="token punctuation">)</span> <span class="token operator">*</span> a_normal<span class="token punctuation">;</span>\n\n  <span class="token comment">// 计算表面的世界坐标</span>\n  <span class="token keyword">vec3</span> surfaceWorldPosition <span class="token operator">=</span> <span class="token punctuation">(</span>u_world <span class="token operator">*</span> a_position<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>\n\n  <span class="token comment">// 计算表面到光源的方向</span>\n  <span class="token comment">// 然后传递到片断着色器</span>\n  v_surfaceToLight <span class="token operator">=</span> u_lightWorldPosition <span class="token operator">-</span> surfaceWorldPosition<span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 计算表面到相机的方向</span></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 然后传递到片断着色器</span></span><span class="gatsby-highlight-code-line">  v_surfaceToView <span class="token operator">=</span> u_viewWorldPosition <span class="token operator">-</span> surfaceWorldPosition<span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后在片断着色器中计算表面到光源和相机之间的 halfVector，将它和法向量相乘，查看光线是否直接反射到眼前。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84419062541389410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 从顶点着色器中传入的值\nvarying vec3 v_normal;\nvarying vec3 v_surfaceToLight;\nvarying vec3 v_surfaceToView;\n\nuniform vec4 u_color;\n\nvoid main() {\n  // 由于 v_normal 是可变量，所以经过插值后不再是单位向量，\n  // 单位化后会成为单位向量\n  vec3 normal = normalize(v_normal);\n\n  vec3 surfaceToLightDirection = normalize(v_surfaceToLight);\n  vec3 surfaceToViewDirection = normalize(v_surfaceToView);\n  vec3 halfVector = normalize(surfaceToLightDirection + surfaceToViewDirection);\n\n  float light = dot(normal, surfaceToLightDirection);\n  float specular = dot(normal, halfVector);\n\n  gl_FragColor = u_color;\n\n  // 只将颜色部分（不包含 alpha）和光照相乘\n  gl_FragColor.rgb *= light;\n\n  // 直接加上高光\n  gl_FragColor.rgb += specular;\n}`, `84419062541389410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{4,13-15,18,25-26}"\n              >\n                <span class="gatsby-code-button-language">glsl{4,13-15,18,25-26}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token comment">// 从顶点着色器中传入的值</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_surfaceToLight<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_surfaceToView<span class="token punctuation">;</span></span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_color<span class="token punctuation">;</span>\n\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 由于 v_normal 是可变量，所以经过插值后不再是单位向量，</span>\n  <span class="token comment">// 单位化后会成为单位向量</span>\n  <span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_normal<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token keyword">vec3</span> surfaceToLightDirection <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_surfaceToLight<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec3</span> surfaceToViewDirection <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_surfaceToView<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">vec3</span> halfVector <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>surfaceToLightDirection <span class="token operator">+</span> surfaceToViewDirection<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  <span class="token keyword">float</span> light <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> surfaceToLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">float</span> specular <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> halfVector<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  gl_FragColor <span class="token operator">=</span> u_color<span class="token punctuation">;</span>\n\n  <span class="token comment">// 只将颜色部分（不包含 alpha）和光照相乘</span>\n  gl_FragColor<span class="token punctuation">.</span>rgb <span class="token operator">*</span><span class="token operator">=</span> light<span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 直接加上高光</span></span><span class="gatsby-highlight-code-line">  gl_FragColor<span class="token punctuation">.</span>rgb <span class="token operator">+</span><span class="token operator">=</span> specular<span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最后找到 <code class="language-text">u_viewWorldPosition</code> 并设置它</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48156901653379710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var lightWorldPositionLocation = gl.getUniformLocation(program, \'u_lightWorldPosition\');\nvar viewWorldPositionLocation = gl.getUniformLocation(program, \'u_viewWorldPosition\');\n\n// ...\n\n// 计算相机矩阵\nvar camera = [100, 150, 200];\nvar target = [0, 35, 0];\nvar up = [0, 1, 0];\nvar cameraMatrix = makeLookAt(camera, target, up);\n\n// 设置相机位置\ngl.uniform3fv(viewWorldPositionLocation, camera);`, `48156901653379710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{2,12-13}"\n              >\n                <span class="gatsby-code-button-language">js{2,12-13}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> lightWorldPositionLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_lightWorldPosition\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> viewWorldPositionLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_viewWorldPosition\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 计算相机矩阵</span>\n<span class="token keyword">var</span> camera <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> target <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> up <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> cameraMatrix <span class="token operator">=</span> <span class="token function">makeLookAt</span><span class="token punctuation">(</span>camera<span class="token punctuation">,</span> target<span class="token punctuation">,</span> up<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line"><span class="token comment">// 设置相机位置</span></span><span class="gatsby-highlight-code-line">gl<span class="token punctuation">.</span><span class="token function">uniform3fv</span><span class="token punctuation">(</span>viewWorldPositionLocation<span class="token punctuation">,</span> camera<span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/z123sf?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>但，亮瞎了!</p>\n<p>我们可以将点乘结果进行求幂运算来解决太亮的问题，它会把高光从线性变换变成指数变换。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/nd3lyv?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>红线越接近顶部，我们加的光照就越多，通过求幂可以将高光的部分向右移动。</p>\n<p>就把它叫做 shininess 并加到着色器中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78104542193464870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`uniform vec4 u_color;\nuniform float u_shininess;\n\n// ...\n\n// float specular = dot(normal, halfVector);\nfloat specular = 0.0;\nif (light > 0.0) {\n   specular = pow(dot(normal, halfVector), u_shininess);\n}`, `78104542193464870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{2,6-10}"\n              >\n                <span class="gatsby-code-button-language">glsl{2,6-10}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_color<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">float</span> u_shininess<span class="token punctuation">;</span></span>\n<span class="token comment">// ...</span>\n\n<span class="gatsby-highlight-code-line"><span class="token comment">// float specular = dot(normal, halfVector);</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">float</span> specular <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">if</span> <span class="token punctuation">(</span>light <span class="token operator">></span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">   specular <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> halfVector<span class="token punctuation">)</span><span class="token punctuation">,</span> u_shininess<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>点乘结果有可能为负值，将负值求幂有可能会得到 undefined 的结果，所以我们只将点乘结果为正的部分进行计算，其他部分设置为 0.0。</p>\n<p>当然还要找到亮度的位置并设置它</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55902233891811705000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var shininessLocation = gl.getUniformLocation(program, \'u_shininess\');\n\n// ...\n\n// 设置亮度\ngl.uniform1f(shininessLocation, shininess);`, `55902233891811705000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1}"\n              >\n                <span class="gatsby-code-button-language">js{1}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token keyword">var</span> shininessLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_shininess\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 设置亮度</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform1f</span><span class="token punctuation">(</span>shininessLocation<span class="token punctuation">,</span> shininess<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/lrej2i?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>最后想说的是光的颜色。</p>\n<p>在此之前我们都是将 light 和 F 的颜色直接相乘，如果想要有色光也可以为光照提供颜色。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90815352344007880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`uniform vec4 u_color;\nuniform float u_shininess;\nuniform vec3 u_lightColor;\nuniform vec3 u_specularColor;\n\n// ...\n\n// 只将颜色部分（不包含 alpha） 和光照相乘\ngl_FragColor.rgb *= light * u_lightColor;\n\n// 直接和高光相加\ngl_FragColor.rgb += specular * u_specularColor;`, `90815352344007880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{3-4,9,12}"\n              >\n                <span class="gatsby-code-button-language">glsl{3-4,9,12}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_color<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">float</span> u_shininess<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_lightColor<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_specularColor<span class="token punctuation">;</span></span>\n<span class="token comment">// ...</span>\n\n<span class="token comment">// 只将颜色部分（不包含 alpha） 和光照相乘</span>\n<span class="gatsby-highlight-code-line">gl_FragColor<span class="token punctuation">.</span>rgb <span class="token operator">*</span><span class="token operator">=</span> light <span class="token operator">*</span> u_lightColor<span class="token punctuation">;</span></span>\n<span class="token comment">// 直接和高光相加</span>\n<span class="gatsby-highlight-code-line">gl_FragColor<span class="token punctuation">.</span>rgb <span class="token operator">+</span><span class="token operator">=</span> specular <span class="token operator">*</span> u_specularColor<span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89579135511511700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var lightColorLocation = gl.getUniformLocation(program, \'u_lightColor\');\nvar specularColorLocation = gl.getUniformLocation(program, \'u_specularColor\');`, `89579135511511700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> lightColorLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_lightColor\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> specularColorLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_specularColor\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>和</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86680184386712300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 设置光照颜色\ngl.uniform3fv(lightColorLocation, m4.normalize([1, 0.6, 0.6])); // 红光\n// 设置高光颜色\ngl.uniform3fv(specularColorLocation, m4.normalize([1, 0.6, 0.6])); // 红光`, `86680184386712300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 设置光照颜色</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform3fv</span><span class="token punctuation">(</span>lightColorLocation<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 红光</span>\n<span class="token comment">// 设置高光颜色</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform3fv</span><span class="token punctuation">(</span>specularColorLocation<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 红光</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/fwn7lv?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="webgl-三维聚光灯"><a href="#webgl-%E4%B8%89%E7%BB%B4%E8%81%9A%E5%85%89%E7%81%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 三维聚光灯</h1>\n<p>在上篇文章中我们讲到点光源，计算光源到物体表面每一点的方向，然后做与方向光相同的运算，也就是对光线方向和表面法向量（表面面对的方向）做点乘运算。如果两个方向完全相同就会得到 1，应该被完全照亮。如果两个方向垂直会得到 0，相反会得到 -1。我们直接将这个值和表面的颜色相乘，实现光照效果。</p>\n<p>聚光灯只是做了少量修改，事实上如果你比较有创新能力的话，可能会根据之前学的东西知道聚光灯的实现方法。</p>\n<p>你可以把点光源想象成一个点，光线从那个点照向所有方向。实现聚光灯只需要以那个点为起点选择一个方向，作为聚光灯的方向，然后将其他光线方向与所选方向点乘，然后随意选择一个限定范围，然后判断光线是否在限定范围内，如果不在就不照亮。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/4nwjt1?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>在上方的图示中我们可以看到光线照向所有的方向，并且将每个方向的点乘结果显示在上面。然后指定一个方向表示聚光灯的方向，选择一个限定（上方以度为单位）。通过限定我们计算一个点乘限定，只需对限定值取余弦就可以得到。如果与选定聚光灯方向的点乘大于这个点乘限定，就照亮，否则不照亮。</p>\n<p>换一种方式解释，假设限定是 20 度，我们可以将它转换为弧度，然后取余弦值得到 -1 到 1 之间的数，暂且把它称作点乘空间。或者可以用这个表格表示限定值的转换。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37650768198734275000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`          限制值\n   角度   |   弧度   | 点乘空间\n --------+---------+----------\n    0    |   0.0   |    1.0\n    22   |    .38  |     .93\n    45   |    .79  |     .71\n    67   |   1.17  |     .39\n    90   |   1.57  |    0.0\n   180   |   3.14  |   -1.0`, `37650768198734275000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">          限制值\n   角度   |   弧度   | 点乘空间\n --------+---------+----------\n    0    |   0.0   |    1.0\n    22   |    .38  |     .93\n    45   |    .79  |     .71\n    67   |   1.17  |     .39\n    90   |   1.57  |    0.0\n   180   |   3.14  |   -1.0</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以只需判断</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40166567181770875000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`dotFromDirection = dot(surfaceToLight, -lightDirection);\nif (dotFromDirection >= limitInDotSpace) {\n  // 使用光照\n}`, `40166567181770875000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">dotFromDirection <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>surfaceToLight<span class="token punctuation">,</span> <span class="token operator">-</span>lightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>dotFromDirection <span class="token operator">>=</span> limitInDotSpace<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 使用光照</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>让我们来实现它。</p>\n<p>首先修改上文的片断着色器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94532979258916210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`precision mediump float;\n\n// 从顶点着色器传入的值\nvarying vec3 v_normal;\nvarying vec3 v_surfaceToLight;\nvarying vec3 v_surfaceToView;\n\nuniform vec4 u_color;\nuniform float u_shininess;\nuniform vec3 u_lightDirection;\nuniform float u_limit; // 在点乘空间中\n\nvoid main() {\n  // 因为 v_normal 是可变量，被插值过\n  // 所以不是单位向量，单位可以让它成为再次成为单位向量\n  vec3 normal = normalize(v_normal);\n\n  vec3 surfaceToLightDirection = normalize(v_surfaceToLight);\n  vec3 surfaceToViewDirection = normalize(v_surfaceToView);\n  vec3 halfVector = normalize(surfaceToLightDirection + surfaceToViewDirection);\n\n  // float light = dot(normal, surfaceToLightDirection);\n  float light = 0.0;\n  float specular = 0.0;\n\n  float dotFromDirection = dot(surfaceToLightDirection,\n                               -u_lightDirection);\n  if (dotFromDirection >= u_limit) {\n    light = dot(normal, surfaceToLightDirection);\n    if (light > 0.0) {\n      specular = pow(dot(normal, halfVector), u_shininess);\n    }\n  }\n\n  gl_FragColor = u_color;\n\n  // 只将颜色部分（不包含 alpha）和光照相乘\n  gl_FragColor.rgb *= light;\n\n  // 直接加上高光\n  gl_FragColor.rgb += specular;\n}`, `94532979258916210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{10-11,22-23,26-33}"\n              >\n                <span class="gatsby-code-button-language">glsl{10-11,22-23,26-33}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 从顶点着色器传入的值</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_surfaceToLight<span class="token punctuation">;</span>\n<span class="token keyword">varying</span> <span class="token keyword">vec3</span> v_surfaceToView<span class="token punctuation">;</span>\n\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> u_color<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">float</span> u_shininess<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">vec3</span> u_lightDirection<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">float</span> u_limit<span class="token punctuation">;</span> <span class="token comment">// 在点乘空间中</span></span>\n<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 因为 v_normal 是可变量，被插值过</span>\n  <span class="token comment">// 所以不是单位向量，单位可以让它成为再次成为单位向量</span>\n  <span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_normal<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">vec3</span> surfaceToLightDirection <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_surfaceToLight<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">vec3</span> surfaceToViewDirection <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>v_surfaceToView<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">vec3</span> halfVector <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>surfaceToLightDirection <span class="token operator">+</span> surfaceToViewDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// float light = dot(normal, surfaceToLightDirection);</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">float</span> light <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span></span>  <span class="token keyword">float</span> specular <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token keyword">float</span> dotFromDirection <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>surfaceToLightDirection<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                               <span class="token operator">-</span>u_lightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>dotFromDirection <span class="token operator">>=</span> u_limit<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    light <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> surfaceToLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>light <span class="token operator">></span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      specular <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> halfVector<span class="token punctuation">)</span><span class="token punctuation">,</span> u_shininess<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  gl_FragColor <span class="token operator">=</span> u_color<span class="token punctuation">;</span>\n\n  <span class="token comment">// 只将颜色部分（不包含 alpha）和光照相乘</span>\n  gl_FragColor<span class="token punctuation">.</span>rgb <span class="token operator">*</span><span class="token operator">=</span> light<span class="token punctuation">;</span>\n\n  <span class="token comment">// 直接加上高光</span>\n  gl_FragColor<span class="token punctuation">.</span>rgb <span class="token operator">+</span><span class="token operator">=</span> specular<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当然我们需要找到刚才添加的全局变量的位置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28400139797395685000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var lightDirection = [0, 0, 0];\nvar limit = degToRad(20);\n\n// ...\n\nvar lightDirectionLocation = gl.getUniformLocation(program, \'u_lightDirection\');\nvar limitLocation = gl.getUniformLocation(program, \'u_limit\');`, `28400139797395685000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> lightDirection <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> limit <span class="token operator">=</span> <span class="token function">degToRad</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token keyword">var</span> lightDirectionLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_lightDirection\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> limitLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">\'u_limit\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后设置它们</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16855170262339424000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gl.uniform3fv(lightDirectionLocation, lightDirection);\ngl.uniform1f(limitLocation, Math.cos(limit));`, `16855170262339424000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gl<span class="token punctuation">.</span><span class="token function">uniform3fv</span><span class="token punctuation">(</span>lightDirectionLocation<span class="token punctuation">,</span> lightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">uniform1f</span><span class="token punctuation">(</span>limitLocation<span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/i7cotm?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>一些需要注意的细节：一个是我们在上方对 <code class="language-text">u_lightDirection</code> 取负，这其实是一个等价的选择，我们希望两个方向匹配的时候能指向相同的方向，也就是需要将 <code class="language-text">surfaceToLightDirection</code> 和聚光灯的反方向相比，我们可以用很多种方式实现这个。可以在设置全局变量时传入反方向，那可能是我的首选，但是我觉得那样应该叫做 <code class="language-text">u_reverseLightDirection</code> 或 <code class="language-text">u_negativeLightDirection</code> 而不是 <code class="language-text">u_lightDirection</code>。</p>\n<p>另一件事，也许这个只是个人习惯，如果可能的话我尽量不在着色器中使用条件语句，原因是我认为着色器并不是真的使用条件语句，如果你在着色器中使用，编译器会在代码中扩展很多 0 和 1 的乘法运算来实现，所以这里并不是真的条件语句，它会将你的代码扩展成多种组合。我不确定现在是否还是这样，但是我们可以使用一些技巧来避免这种情况，你自己可以选择用或不用。</p>\n<p>有一个 GLSL 函数叫做 step，它获取两个值，如果第二个值大于或等于第一个值就返回 1.0，否则返回 0。用 JavaScript 大概可以这样表示。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90547168443747930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function step(a, b) {\n  if (b >= a) {\n    return 1;\n  } else {\n    return 0;\n  }\n}`, `90547168443747930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">step</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">>=</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>让我们使用 step 避免这种情况</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13901238592559096000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`float dotFromDirection = dot(surfaceToLightDirection, -u_lightDirection);\n// 如果光线在聚光灯范围内 inLight 就为 1，否则为 0\nfloat inLight = step(u_limit, dotFromDirection);\nfloat light = inLight * dot(normal, surfaceToLightDirection);\nfloat specular = inLight * pow(dot(normal, halfVector), u_shininess);`, `13901238592559096000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">float</span> dotFromDirection <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>surfaceToLightDirection<span class="token punctuation">,</span> <span class="token operator">-</span>u_lightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 如果光线在聚光灯范围内 inLight 就为 1，否则为 0</span>\n<span class="token keyword">float</span> inLight <span class="token operator">=</span> <span class="token function">step</span><span class="token punctuation">(</span>u_limit<span class="token punctuation">,</span> dotFromDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">float</span> light <span class="token operator">=</span> inLight <span class="token operator">*</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> surfaceToLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">float</span> specular <span class="token operator">=</span> inLight <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> halfVector<span class="token punctuation">)</span><span class="token punctuation">,</span> u_shininess<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>看起来没有什么区别，这是结果</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/yd0rcc?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>还有一件事，现在的聚光灯效果非常粗糙和僵硬。只有在聚光灯范围内或外，在外面就直接变黑，没有任何过渡。</p>\n<p>要修正它我们可以使用两个限定值代替原来的一个，一个内部限定一个外部限定。如果在内部限定内就使用 1.0，在外部限定外面就使用 0.0，在内部和外部限定之间就使用 1.0 到 0.0 之间的插值。</p>\n<p>这是我们实现这个的一种方式</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61486797198182090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// uniform float u_limit; // 在点乘空间中\nuniform float u_innerLimit; // 在点乘空间中\nuniform float u_outerLimit; // 在点乘空间中\n\n// ...\n\nfloat dotFromDirection = dot(surfaceToLightDirection, -u_lightDirection);\n// float inLight = step(u_limit, dotFromDirection);\nfloat limitRange = u_innerLimit - u_outerLimit;\nfloat inLight = clamp((dotFromDirection - u_outerLimit) / limitRange, 0.0, 1.0);\nfloat light = inLight * dot(normal, surfaceToLightDirection);\nfloat specular = inLight * pow(dot(normal, halfVector), u_shininess);`, `61486797198182090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl{1-3,8-10}"\n              >\n                <span class="gatsby-code-button-language">glsl{1-3,8-10}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="gatsby-highlight-code-line"><span class="token comment">// uniform float u_limit; // 在点乘空间中</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">float</span> u_innerLimit<span class="token punctuation">;</span> <span class="token comment">// 在点乘空间中</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">uniform</span> <span class="token keyword">float</span> u_outerLimit<span class="token punctuation">;</span> <span class="token comment">// 在点乘空间中</span></span>\n<span class="token comment">// ...</span>\n\n<span class="token keyword">float</span> dotFromDirection <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>surfaceToLightDirection<span class="token punctuation">,</span> <span class="token operator">-</span>u_lightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// float inLight = step(u_limit, dotFromDirection);</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">float</span> limitRange <span class="token operator">=</span> u_innerLimit <span class="token operator">-</span> u_outerLimit<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">float</span> inLight <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dotFromDirection <span class="token operator">-</span> u_outerLimit<span class="token punctuation">)</span> <span class="token operator">/</span> limitRange<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token keyword">float</span> light <span class="token operator">=</span> inLight <span class="token operator">*</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> surfaceToLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">float</span> specular <span class="token operator">=</span> inLight <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> halfVector<span class="token punctuation">)</span><span class="token punctuation">,</span> u_shininess<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样就行了</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/8rzoi2?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>现在我们得到了聚光灯的效果。</p>\n<p>需要注意的是如果 <code class="language-text">u_innerLimit</code> 和 <code class="language-text">u_outerLimit</code> 相等那么 limitRange 就会是 0.0，除以 0 就会导致 undefined。这在着色器中没有什么解决办法，所以只需要在 JavaScript 中确保 <code class="language-text">u_innerLimit</code> 和 <code class="language-text">u_outerLimit</code> 永远不要相等。（注意：示例代码中并没有做这个。）</p>\n<p>GLSL 也有一个函数可以稍微做一些简化，叫做 smoothstep，和 step 相似返回一个 0 到 1 之间的值，但是它获取最大和最小边界值，返回该值在边界范围映射到 0 到 1 之间的插值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48942422499349320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`float dotFromDirection = dot(surfaceToLightDirection, -u_lightDirection);\n// float limitRange = u_innerLimit - u_outerLimit;\n// float inLight = clamp((dotFromDirection - u_outerLimit) / limitRange, 0.0, 1.0);\nfloat inLight = smoothstep(u_outerLimit, u_innerLimit, dotFromDirection);\nfloat light = inLight * dot(normal, surfaceToLightDirection);\nfloat specular = inLight * pow(dot(normal, halfVector), u_shininess);`, `48942422499349320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">float</span> dotFromDirection <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>surfaceToLightDirection<span class="token punctuation">,</span> <span class="token operator">-</span>u_lightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// float limitRange = u_innerLimit - u_outerLimit;</span>\n<span class="token comment">// float inLight = clamp((dotFromDirection - u_outerLimit) / limitRange, 0.0, 1.0);</span>\n<span class="token keyword">float</span> inLight <span class="token operator">=</span> <span class="token function">smoothstep</span><span class="token punctuation">(</span>u_outerLimit<span class="token punctuation">,</span> u_innerLimit<span class="token punctuation">,</span> dotFromDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">float</span> light <span class="token operator">=</span> inLight <span class="token operator">*</span> <span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> surfaceToLightDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">float</span> specular <span class="token operator">=</span> inLight <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> halfVector<span class="token punctuation">)</span><span class="token punctuation">,</span> u_shininess<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样也可以</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/5udeoe?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>不同之处是 smoothstep 使用 Hermite 插值而不是线型插值，也就是说 lowerBound 和 upperBound 之间的值插值后像下方右图所示，线型插值是左图。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-06-15-14-01-31-5b5f5613eaba450c8cc093f46892ff68-7027d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 300px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABG0lEQVQoz32RPU7DUAzHf0m/oKEkgbZUiK9WqtgZGVgYEKp6hG6scJqehYEzcIGuLEgscAEa7PccNQltLPnZT/7nZzuPB7gaQx9IW3BExUMf+/dw+QwT06Thf20qPkBhGexRYwHEEhLRNcS7NdIDjMyXfPAKoeYLx7DDW9KEY00+oPUNkeZ3pZ7OetgKKEy6x2srZuXOia71aRfRdKTe2aLrYfvnwkChmUGXFWARoKtnttHtNuBiM1kJWgMM1vY/b3ZNWBQrdGUTtA04tPrvRteuPGgJ6CZ6svgmsB//snqP80fJx55bFE307nq6cQ/zdXaaAKMLr0nqNJbu63EurtucFL3p40AKpzO4lvxMfFTUhj4OGxJfRPMI0z9RXzMYJHPdlwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 06 15 14 01 31" title="" data-src="/static/2022-06-15-14-01-31-5b5f5613eaba450c8cc093f46892ff68-7027d.png" data-srcset="/static/2022-06-15-14-01-31-5b5f5613eaba450c8cc093f46892ff68-55fa9.png 200w,\n/static/2022-06-15-14-01-31-5b5f5613eaba450c8cc093f46892ff68-7027d.png 300w" data-sizes="(max-width: 300px) 100vw, 300px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>如果你觉得没什么关系的话，使用什么取决于你自己。</p>\n<p>还有一件事就是注意当 lowerBound 大于或等于 upperBound 时 smoothstep 方法会产生 undefined。它们值相等和之前的情况一样，多出的问题是 lowerBound 大于 upperBound 时，但是对于正常的聚光灯这种情况永远不会出现。</p>',
excerpt:"WebGL…",timeToRead:14,tableOfContents:'<ul>\n<li>\n<p><a href="/webgl-fundamental-light/#webgl-%E4%B8%89%E7%BB%B4%E6%96%B9%E5%90%91%E5%85%89%E6%BA%90">WebGL 三维方向光源</a></p>\n<ul>\n<li><a href="/webgl-fundamental-light/#%E6%B3%95%E5%90%91%E9%87%8F">法向量</a></li>\n<li><a href="/webgl-fundamental-light/#mat3u_worldinversetranspose--a_normal-%E7%9A%84%E5%8F%AF%E9%80%89%E6%96%B9%E6%A1%88">&#x3C;code class="language-text">mat3(u_worldInverseTranspose) * a_normal&#x3C;/code> 的可选方案</a></li>\n</ul>\n</li>\n<li><a href="/webgl-fundamental-light/#webgl-%E4%B8%89%E7%BB%B4%E7%82%B9%E5%85%89%E6%BA%90">WebGL 三维点光源</a></li>\n<li><a href="/webgl-fundamental-light/#webgl-%E4%B8%89%E7%BB%B4%E8%81%9A%E5%85%89%E7%81%AF">WebGL 三维聚光灯</a></li>\n</ul>',wordCount:{words:506},frontmatter:{date:"2022-06-07 14:38:03",path:"/webgl-fundamental-light/",tags:"前端, 可视化, WebGL, 读书笔记",title:"WebGL 理论基础——光照",draft:null,catalog_number:null}},nextPost:{html:'<h1 id="技能要求"><a href="#%E6%8A%80%E8%83%BD%E8%A6%81%E6%B1%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技能要求</h1>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-20-23-40-33-31b6f71af6066723fb684afcd417da59-72abb.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 53.410182516810764%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABqklEQVQoz2WS7W7iMBBFef/nqrRStRJaykcJhCYEEpymEMexPfbYnk7YLbvVSiP/O57rcz3zkSCQxWSmoasNc6F3Pdw8OTRkLlA/Y5+TU+RGQkuBB1LwlMLsAWsen1RIg09mNFa07l1A+ZaYgZ6cTMx78weO3+HsarIeZPNuq8rssuF1ow57uVyiNZQwqDOIOZ8UHeF/sHJRIunTyex3qixcffaiMYdclmUg4v3J3pIfvzYjRYZDYhimM9lIqLXcvvqmttVRFQc8VWOWWXAUffKagvt6s2N+dmpEJDpKu/nQyiccx2H5gqKR+V69HcaygF2mui4R+esO2kW0V87x8/nHZr2cAUbezKokRB0IjZHrlb/UuiyGPOfwnHxsBVGcYruBguFnO9DoYIaJ7D22wym2rWvNO8sCLw1eaiea/mUBTUMU7qrvsRHYFl/3V1h+M9kN+vPFFsWYbeVmPWTbfr3SZRm9Q1mC+BXNx2T7d1XxH9sD24aoprb5duva1nUdVMfkgTUSZ55s60fPk7AHfB+62bBozaqzPccMQEbY6smLOXFJTD5+2L3nTzBOdLFML8yuAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 20 23 40 33" title="" data-src="/static/2022-05-20-23-40-33-31b6f71af6066723fb684afcd417da59-fee1c.png" data-srcset="/static/2022-05-20-23-40-33-31b6f71af6066723fb684afcd417da59-a67b7.png 200w,\n/static/2022-05-20-23-40-33-31b6f71af6066723fb684afcd417da59-0b187.png 400w,\n/static/2022-05-20-23-40-33-31b6f71af6066723fb684afcd417da59-fee1c.png 800w,\n/static/2022-05-20-23-40-33-31b6f71af6066723fb684afcd417da59-72abb.png 1041w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="显性技能"><a href="#%E6%98%BE%E6%80%A7%E6%8A%80%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>显性技能</h2>\n<h3 id="图标设计"><a href="#%E5%9B%BE%E6%A0%87%E8%AE%BE%E8%AE%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>图标设计</h3>\n<p>即出现在界面中的图形标识符号以及应用的启动图标。图标虽然有大量的素材可以用，但是想满足项目自身需求、风格统一的图标，基本只能依靠独立绘制来完成。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-20-23-42-25-5a99888f14c76b619931da6a3a927f08-ad2c1.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 45.069274653626735%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABaElEQVQoz0VRS44VMQzsm3OHkWDBggWIFSBWnGAuwXYkBh7pTidO4tiO88H93gKrYiWWyy47249vX94/PX149/br508KoWd4YGAatXSqhnF5UqYuBlFp2pqqbhPzwCIQWzjpPAw1eIonQxQInEFK4pwoAaX7JadqKLkSbl11Ms2a51qMhWqdc47e51xUMpe8Lpvrv83H04hbW6s9f5ePb6QPYTKymDG3JnDsaP0jURGXkVGZR4te2UM9uo7N8jn6+vKTK14suvgGG+l0fyH4fhZK6EixMrKid4qhWAntm+XZ7NQaM4uYl3sVNrJzt3ic+wo48kL5ReyEVnlpqasf0mWzTrY668h3qUazY8Gh/ba7Hfy4SY0M3PdbPH1KuwiWJZ6bbtVEmlJE83xHTgli6K39OQ4HYaVuvxFJM1QsXKFprasEMtkm82rMDADGtx+81Kv03l2Me4Jrv/Na737sr79fLf5Yug32D64lAqVWE9ItAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 20 23 42 25" title="" data-src="/static/2022-05-20-23-42-25-5a99888f14c76b619931da6a3a927f08-fee1c.png" data-srcset="/static/2022-05-20-23-42-25-5a99888f14c76b619931da6a3a927f08-a67b7.png 200w,\n/static/2022-05-20-23-42-25-5a99888f14c76b619931da6a3a927f08-0b187.png 400w,\n/static/2022-05-20-23-42-25-5a99888f14c76b619931da6a3a927f08-fee1c.png 800w,\n/static/2022-05-20-23-42-25-5a99888f14c76b619931da6a3a927f08-b1a91.png 1200w,\n/static/2022-05-20-23-42-25-5a99888f14c76b619931da6a3a927f08-ad2c1.png 1227w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="界面设计"><a href="#%E7%95%8C%E9%9D%A2%E8%AE%BE%E8%AE%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>界面设计</h3>\n<p>输出界面的视觉能力，我们定义的界面视觉能力是在不受外力干扰下，你可以输出符合规范、基本交互、平面要素的美观界面，简称就是飞机稿输出能力。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-20-23-44-53-bb6ca12e59387349a2bf43361bf8daa2-c849b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 85.01529051987767%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAEGElEQVQ4ywENBPL7AM3Ew6ijoLaxsKmmpMK+vP/9+v76+P/7+v/8+/76+fz59/z49/z6+Pv6+fz7+vz8+/z9+/v9/fz+/fz//QDm3t3a1tTV0tHU09HX1tTa2tjS1NXV19fa29rn6Ofx9fXy9/X0+vbv9vbo8vbn8fXr9Pbw9vfw9/ju9/kAKyorCAgGHRwZICAkDg4PDAwMNi8lKyceAAAAWFlY1fP/mcn4jLn2oMj2t9f2t9PznsTxgrbxgbHxrcv0AB4eHgwLCTU1NiUlLhgYHhUWFJJrSmtMOAAAAEpPTMnr/laQ7jZy6XSg7MfX58jc9bjS7bLV9q/O9avH7gAgISAAAAE6MjREOiw1LCItKShMRjlWQzAJAABCS0jA4/lgluthot9znuquzOeVv+rL2+r89/rt7feux+oAISIhAAAASzctWUg2QTUrJB4XPj0YNTQiAAAAQUpGu9/1WZDsR4jkbpjjf4SSeYOXx9Pi9/n86O75qMLnACMkIwAAAC0kIVk8MGFMNyMfHxcTFSUkKAAAAEBIRLjc82OT7UV553ui6trf4Nfd5NLb6OTq89zn+qbA5QAfIB8AAAAaFRNKPDMzLi0VFhoeGhQlIiAAAAA/RUK52/NqmvBYiuyWtu3y8/nw8fvR2+jk6fXb4/WjveUAMTIyCAkIDhEUHSAiHB0ZDA8SJSMZIB8ZAAABTlZTvd70psz1osbwpMXsrsbnrcXlnrrimLTgl7Plor3qAM/U0b3FxLXCv626t6u6t6y7tqm5uK69vLTBvr/PzcfX18LP0b3NzbrLzbrN0bjL0LfLz7jN07vP1cTU1wDv8uzq7uPp7eLl6t7y9O/////p6+Pi5tz3+PDi7enIyMHPwrfVysC/tKl/d258d26olom7l4S4l4TJwrcA1NvNnq6ImauCv8my5eTl5OPf1tvUjJWDuLyu4u7rxcjC08rD3dbQraiiLTEqMTgxbllKdEgxe0gvxrqwAM3WxZilepSgcrvGrvPw8uDf1c/VyJ2im6isn9zq5cTIw8jAubm3s6+qo0BBNUJIPXJbTHRVQn9TPsO3rQDL18WZm3abmHK8y67q4t3y8vLk6ObCt6zYyr7e7ezDyMKupZ55bGGopZ48NitCOzNyWUqRWj+RWDzAt60A09nNbXxcd4lnnKaS8fLw6ejj1NbRwLm06N7X3Ovpv8W/t6ecf3FnqqagIiQhLS8pclpJqmJBnFs9vrWsAOvu6ebp5Nvf1tPWzc3TwMTLtMzPw9XW1P79/Nvn5L3AudLHvuDX0LCpojc5MTk/OXZdT61tUKJoTcC3rADo7Ojy9PPr8O3m7Obf5uHf5uHe5d/Z4dfu8vDZ5uTDycTJw7zHxLzAvrewrqivr6i6trDAurLBu7LIycTrCHxzRTKNFwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 20 23 44 53" title="" data-src="/static/2022-05-20-23-44-53-bb6ca12e59387349a2bf43361bf8daa2-fee1c.png" data-srcset="/static/2022-05-20-23-44-53-bb6ca12e59387349a2bf43361bf8daa2-a67b7.png 200w,\n/static/2022-05-20-23-44-53-bb6ca12e59387349a2bf43361bf8daa2-0b187.png 400w,\n/static/2022-05-20-23-44-53-bb6ca12e59387349a2bf43361bf8daa2-fee1c.png 800w,\n/static/2022-05-20-23-44-53-bb6ca12e59387349a2bf43361bf8daa2-c849b.png 981w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="动效设计"><a href="#%E5%8A%A8%E6%95%88%E8%AE%BE%E8%AE%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>动效设计</h3>\n<p>在输出静态页面基础上，丰富使用体验的手段。通过增加一些有趣、简单的动效，来让操作效果更生动，或者作为情感化设计的一部分。</p>\n<p><html><head></head><body><video data-src="/examples/ui-introduce-learning/2022-05-20-23-50-38.mp4" loop="" muted="" autoplay="" width="100%" class="lazy"></video></body></html></video></p>\n<h3 id="项目设计"><a href="#%E9%A1%B9%E7%9B%AE%E8%AE%BE%E8%AE%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>项目设计</h3>\n<p>在项目设计中，抛开产品、体验这些内容和基本视觉样式，最让人关注的东西是对项目设计规范的搭建与应用。如何在多个页面中保持视觉风格的一致性。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-20-23-57-08-69ec6bffe78a9e894f771ba6cbed11a8-fc63d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 45.893223819301845%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACIElEQVQozxWOS28SUQBG5y+YGF34G4wr496lJi5cmNS4cOG2NTZuXNCFNSVR7MOVbSXSSGyxoWpoSkUeCjQVSimgLQzT4Q6PeTDM5c7jMgzzYKRfzupszkd83fy8Fw5vbQRikYir67amOli1NcXWNVvHY3PkWubYNt2x44ysC+yLObZpOw7Ra9JtqoragK+VhFoFcazMsyMZDRE0VBkBGjYbLapGVv4iCbRkRqAbAgA83xc5SLx7Nff41o1V38v9gJcspBkADrIZRVFc1x3puBz9TR5W79+5e/nSlcbR1i6f6LGi0hMjiebeTon4Htq6d+3q+vKiYVodjifrdYqieEEwDFNXhZ1Vyu9hg37/68Wl3s+MwsIFn296ZgYwrT6EhAQl5pyadKp18u2L6c33y4qGNQ1btsOc11myIfOyMdBtrKtYt1zX612YnX1W68hnjELkUz9Kx8VweCeRiq+8mX8yNVWnwb+Jyucy6TQHaMcySr8OsitrbLtDF8ojXXRd56RjpM4QseZ5GglvH+bzqC89ePjo+s3b2+HQp5X53WAQqnKuxlGiu+7/8vFD8DSezX2LITzQsDwYYDzExHPPwkYgwLXB5Hk0upvJZLsCn07unx0fkgx92pFaXbtQrpZPCoX9TjzEG+bItCx9OISqRsx5l47yfyqlYh+hwdAQJWhYdjIZq51WKJZlBd5CUIUQFes9TgKVarfbgxruKyoQlf+PhLfThfpuPAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 20 23 57 08" title="" data-src="/static/2022-05-20-23-57-08-69ec6bffe78a9e894f771ba6cbed11a8-fee1c.png" data-srcset="/static/2022-05-20-23-57-08-69ec6bffe78a9e894f771ba6cbed11a8-a67b7.png 200w,\n/static/2022-05-20-23-57-08-69ec6bffe78a9e894f771ba6cbed11a8-0b187.png 400w,\n/static/2022-05-20-23-57-08-69ec6bffe78a9e894f771ba6cbed11a8-fee1c.png 800w,\n/static/2022-05-20-23-57-08-69ec6bffe78a9e894f771ba6cbed11a8-fc63d.png 974w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="标注切图"><a href="#%E6%A0%87%E6%B3%A8%E5%88%87%E5%9B%BE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>标注切图</h3>\n<p>最后，就是前面这些内容都输出完了，需要将设计的内容提交给程序员进行样式的开发，那么就要实现对设计内容进行标注和切图文件的输出。</p>\n<p>显性技能对于新手来说，最大的优点就是知识点是相对固定的，练习方法也是固定的，只要通过刻意练习的方法，就可以积累和提前。</p>\n<h2 id="隐性技能"><a href="#%E9%9A%90%E6%80%A7%E6%8A%80%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>隐性技能</h2>\n<h3 id="理解规范"><a href="#%E7%90%86%E8%A7%A3%E8%A7%84%E8%8C%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>理解规范</h3>\n<p>没有规范是必然输出不了界面的。但移动端的设计规范，并不是你们想的官方准备个文档，里面数值写清楚了，你背下来就行。而是理解哪些规范是必须要遵守的，哪些是可以灵活变动的（而可以自定义的是大多数）。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-21-00-01-06-ee66acc8b421a360e3a861a0f6e92b7d-c849b.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 45.361875637105%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABpklEQVQozyVRS24UMRDtM3ALTsQ5OAJcIRsEQqBkARIS7ECKEKMskEISpGzCLAJBzChkuu22y1XlT/vTTWV4KlXZsl7V86tu9enj4Yvnp6svSwzF2YpQyVXGFqgFX2NsElOqKc7TtLR5WeaScxHU2iUzZrCSo9H3oVUwOoBJCBNCQucByJiAOEL/7er84uwyeiJEYu4IXWl1EcxzW+ZJ6v4sKREKx5FHwiUvB+vDR0eP37w9duwdh9G6bskFe7XZbmMpi3XL05fnp59XvJ4jM1inFXAgH8BxDzCVmksDRylFY6FrIj7nEIKM0jd/njx4+Or1++/j14onYMgMg8iywtQjkfchIHvjiEOy4LpaSowx51xrldfjizMZNqcmveyor29//rDXW9MjMsi3jR3BGcDsmRG7XLJSahgGMUBaWD0OQx+nJGRlzPr2118cDPJu0NoYJGLvmbwYpq3t6n+39hD/0bl6v4ci1521m51KYRKMFkdLlIrP5Y68uGiIu7zfWMp5KoVjtKIvRo6htnYHsFHKp+Rj7C1u1W938uHds83BTW/Yged/9dD1ZOc+YTYAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 21 00 01 06" title="" data-src="/static/2022-05-21-00-01-06-ee66acc8b421a360e3a861a0f6e92b7d-fee1c.png" data-srcset="/static/2022-05-21-00-01-06-ee66acc8b421a360e3a861a0f6e92b7d-a67b7.png 200w,\n/static/2022-05-21-00-01-06-ee66acc8b421a360e3a861a0f6e92b7d-0b187.png 400w,\n/static/2022-05-21-00-01-06-ee66acc8b421a360e3a861a0f6e92b7d-fee1c.png 800w,\n/static/2022-05-21-00-01-06-ee66acc8b421a360e3a861a0f6e92b7d-c849b.png 981w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="交互思维"><a href="#%E4%BA%A4%E4%BA%92%E6%80%9D%E7%BB%B4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>交互思维</h3>\n<p>如何让产品和界面操作起来合理的思维能力。平心而论，这种能力是只能依靠自己的 “多学多看” 积累的。交互书籍带来的帮助只是解释你留意到的现象原因，但不会告诉你遇到问题的时候具体应该怎么做。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-21-00-03-09-10645c538d3fe1be1278059135dda084-240b7.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 45.752302968270214%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABsElEQVQozyWQTWsUQRCG50969eRN8JSf4NGzHkUCHkTwkptERBCDkgSyOzubmZ3vme7q7qr+mpn9yK4kvZvioah64eWlKrq8uPj44f3Vzx+Pu+2DM4fBHZmG/4H1dFivD5sT201gv9vud7uHU+33h2hnaFJylMIDd5yF7gUMQUG11rSxZuPd2ppRa6/1ZM3k7BjWwU3jGBGeSikplVJaKrLGhPUocmYQG4VApPyA48iQGiFBmxKAjImevZrIe4dQEeTeKs4Yag1NJTgvmoZLNYvjQAeyrOsSZJzliih6TjwGA2Ndxfuas6bve9K6K3LWdTXjkuj3PP27SCuh5jWThHHDE4ZRsGnjjPWhIznSToigeOvGYpW1XcuR/OBvahmDzVp2uezCSXFeXZUikgoHw6Evqqq02FrqrRsMdlp1SZa1nEnryDke3mJd2rLreQxISV6E/EihcTKr05v7JIbimpUzqYxo5qKeJ0W1ZCxZFbcN3C1TrfW3X/9evHp9v1p9Oj/P2zaYEZRmAkFix4+zUKoD5ALTtomZuF0sv6/g7O27z1++/pktXr45C4e0HBjRE2+g4xSujOKuAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 21 00 03 09" title="" data-src="/static/2022-05-21-00-03-09-10645c538d3fe1be1278059135dda084-fee1c.png" data-srcset="/static/2022-05-21-00-03-09-10645c538d3fe1be1278059135dda084-a67b7.png 200w,\n/static/2022-05-21-00-03-09-10645c538d3fe1be1278059135dda084-0b187.png 400w,\n/static/2022-05-21-00-03-09-10645c538d3fe1be1278059135dda084-fee1c.png 800w,\n/static/2022-05-21-00-03-09-10645c538d3fe1be1278059135dda084-240b7.png 977w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="团队协作能力"><a href="#%E5%9B%A2%E9%98%9F%E5%8D%8F%E4%BD%9C%E8%83%BD%E5%8A%9B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>团队协作能力</h3>\n<p>我们如何有效的理解设计的需求，将设计的意图传递给别人，高效的评审和过稿，都是团队协作能力的体现。</p>\n<h3 id="审美水平"><a href="#%E5%AE%A1%E7%BE%8E%E6%B0%B4%E5%B9%B3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>审美水平</h3>\n<p>是一个设计师的品味。品味的高低是可以在作品集中感受出来的，怎么布局，怎么用配图，怎么选用设计风格。审美的落差很多时候可以填补技术上的缺陷。</p>\n<h3 id="理论掌握"><a href="#%E7%90%86%E8%AE%BA%E6%8E%8C%E6%8F%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>理论掌握</h3>\n<p>基本上上面所有讲过的细分技能点都有各自的理论、术语。设计领域中，不管多有用的理论，脱离实践都毫无意义。理论掌握的正确时机是在实践过程中查找并融汇贯通的。</p>\n<h1 id="资料准备"><a href="#%E8%B5%84%E6%96%99%E5%87%86%E5%A4%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>资料准备</h1>\n<h2 id="软件"><a href="#%E8%BD%AF%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>软件</h2>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-21-00-11-18-6d21973b629fde1510f886e7e87388d9-a45cc.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 35.19837232960325%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABqElEQVQY0zVNz0sUURx/J6GDHvoDuisdpEt07xp66GB0kERYNqpLhHkxIgiEkiRdNmuX2HKxTBNlxXBX013FTVkV1g0kWlZn2XV2Z96bmbfz5s2bed+msM/p8+HzC+Uy6cW5L+nlVCIem/n4QatVwRfSYcA5SAnSB09I3//HJfxHoD2QyKOWoKaqnIiWKR1bOg64HIQIXANr1DLP4/K8yl2uERIoHwCBx12LFPJ5lzl/t4XrS58JJ8gdFn+WK9WACCmCX08Gb6DT1vbu7mm9YdgMhZ9O3no0ujDz+UnfjTcjw64Qn97GRsP3N3NbQI+l9WttevXZ9aFMYoUD2MUSFPdT6cPLXY9D4Si6cOVm29WBwdsDfe2ov7tTVdVQ6N6lzmuRSBSOZs3SfOTuxEN0Jzb4WgPeKhTg+7fxqeWLHQ96esdQcvbrq2h8Y30z/uLlUjKJdX0tuzEWGd/J/6ipqlKvbWVy759PZVezDZNojNUpPSgdv0ukVtb3kEkI0XUdYw1jYhjMYTZjTZ1gSn+fnpQVxeK8aVuYM4O7SrNZqZ9VMa40zsqq+ge0Y1UULT1kCgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 21 00 11 18" title="" data-src="/static/2022-05-21-00-11-18-6d21973b629fde1510f886e7e87388d9-fee1c.png" data-srcset="/static/2022-05-21-00-11-18-6d21973b629fde1510f886e7e87388d9-a67b7.png 200w,\n/static/2022-05-21-00-11-18-6d21973b629fde1510f886e7e87388d9-0b187.png 400w,\n/static/2022-05-21-00-11-18-6d21973b629fde1510f886e7e87388d9-fee1c.png 800w,\n/static/2022-05-21-00-11-18-6d21973b629fde1510f886e7e87388d9-a45cc.png 983w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="图形软件"><a href="#%E5%9B%BE%E5%BD%A2%E8%BD%AF%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>图形软件</h3>\n<p>主要指的就是 Adobe 的 PS 和 AI，用来处理复杂图形样式的软件，例如复杂的图标、字体、H5 视觉等。是每个平面相关设计师都绕不开的两座大山。</p>\n<h3 id="界面软件"><a href="#%E7%95%8C%E9%9D%A2%E8%BD%AF%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>界面软件</h3>\n<p>设计 UI 界面和排版的专用软件。目前市场主要使用的工具有 Sketch / Figma / Adobe XD 三个，Sketch 只支持 Mac 系统，Adobe XD 因为更新太慢功能太少，已经不建议再花时间了解。所以主要建议从 Figma 开始学习。</p>\n<h3 id="动效软件"><a href="#%E5%8A%A8%E6%95%88%E8%BD%AF%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>动效软件</h3>\n<p>用来处理交互动效的工具。新手多数以为动效必须由 Adobe Effect 来完成，其实它最适合制作的是动效中的矢量动画，但不能输出完整的动效原型。目前市面上做的最好，Windows 也支持的动效工具是 Protopie，掌握它就可以忽略类似 Principle、Origami 等其它同类软件。</p>\n<h2 id="材料准备"><a href="#%E6%9D%90%E6%96%99%E5%87%86%E5%A4%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>材料准备</h2>\n<h3 id="规范"><a href="#%E8%A7%84%E8%8C%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>规范</h3>\n<ol>\n<li>IOS + 安卓官方规范</li>\n<li>字体文件，包含苹果官方要求的苹方中文字体，SF 系列英文字体，以及安卓的思源黑中文字体，以及 Roboto 英文字体。</li>\n<li>常用的图标素材库，iconfont 和 iconpark 两个网站，它们提供了大量的开源图标素材，可以直接应用。</li>\n</ol>\n<h3 id="书籍"><a href="#%E4%B9%A6%E7%B1%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>书籍</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-05-21-00-26-34-4857b9bcb4add8c0fc29897d90063b9c-918f8.jpg" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 131.25%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAaABQDASIAAhEBAxEB/8QAGQAAAwEBAQAAAAAAAAAAAAAAAAEDAgQF/8QAFgEBAQEAAAAAAAAAAAAAAAAAAQIA/9oADAMBAAIQAxAAAAH09aoKGacy60MyhR//xAAcEAABBAMBAAAAAAAAAAAAAAACAAEDERASISL/2gAIAQEAAQUCGX2M2yA9mvqZ+X1pEJW2f//EABURAQEAAAAAAAAAAAAAAAAAABAR/9oACAEDAQE/ASn/xAAXEQEBAQEAAAAAAAAAAAAAAAABACEx/9oACAECAQE/AYR0kXkX/8QAHRAAAgAHAQAAAAAAAAAAAAAAABEBAiAhMTJBYf/aAAgBAQAGPwKZ2Xpr0aRFymDBGxr0xR//xAAbEAADAQEAAwAAAAAAAAAAAAABESEAMRBBUf/aAAgBAQABPyECZEgT1htQSYzx3w4q5IcndPjP9GKsA3EJo5ai5Dz/AP/aAAwDAQACAAMAAAAQtCXA/8QAGBEBAQEBAQAAAAAAAAAAAAAAAQARITH/2gAIAQMBAT8Q0BEjTjAPSXXl/8QAGBEBAQEBAQAAAAAAAAAAAAAAAQARMUH/2gAIAQIBAT8Qe7A+DdhkEMXb/8QAHxABAAICAgIDAAAAAAAAAAAAAQARITFBUXGBkaHw/9oACAEBAAE/EArlaOsuBn2FG8Of3ctJsOWUkgRF/KFVouYVxsSogMBCysRNU0Kb96iKrRFR6D4iHRADRP/Z\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 05 21 00 26 34" title="" data-src="/static/2022-05-21-00-26-34-4857b9bcb4add8c0fc29897d90063b9c-dfbfc.jpg" data-srcset="/static/2022-05-21-00-26-34-4857b9bcb4add8c0fc29897d90063b9c-75a98.jpg 200w,\n/static/2022-05-21-00-26-34-4857b9bcb4add8c0fc29897d90063b9c-1f451.jpg 400w,\n/static/2022-05-21-00-26-34-4857b9bcb4add8c0fc29897d90063b9c-dfbfc.jpg 800w,\n/static/2022-05-21-00-26-34-4857b9bcb4add8c0fc29897d90063b9c-ca27a.jpg 1200w,\n/static/2022-05-21-00-26-34-4857b9bcb4add8c0fc29897d90063b9c-918f8.jpg 1280w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="软件-1"><a href="#%E8%BD%AF%E4%BB%B6-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>软件</h1>\n<p>以下都是使用即时设计</p>\n<h2 id="apple-music-界面输出"><a href="#apple-music-%E7%95%8C%E9%9D%A2%E8%BE%93%E5%87%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Apple Music 界面输出</h2>\n<ol>\n<li>安装本地字体助手，之后可以看到本地字体</li>\n<li>可以从左侧拖动标尺出来，标尺显示、隐藏快捷键 <code class="language-text">shift + r</code></li>\n<li><code class="language-text">alt + 鼠标左键</code> 拖拽复制一个元素出来</li>\n<li>长按 alt 键鼠标悬浮可以看到间距</li>\n<li>鼠标框选选中多个元素</li>\n</ol>\n<h1 id="规范-1"><a href="#%E8%A7%84%E8%8C%83-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>规范</h1>\n<h2 id="ui-规范是什么规范"><a href="#ui-%E8%A7%84%E8%8C%83%E6%98%AF%E4%BB%80%E4%B9%88%E8%A7%84%E8%8C%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>UI 规范是什么规范</h2>\n<h3 id="规范类型梳理"><a href="#%E8%A7%84%E8%8C%83%E7%B1%BB%E5%9E%8B%E6%A2%B3%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>规范类型梳理</h3>\n<p>很多人都知道学 UI 有规范，苹果的规范，安卓的规范。但是，多数人并不清楚这些规范到底是什么，有哪些，以及它们的作用、意义、内容。</p>\n<p>规范一词，可以解释为——某一行业或者行为进行定性的信息规定。它不是数学定理，而是人为制定的条件、规则、约束、限制。</p>\n<p>在从事 UI 设计师这个职业，掌握规范，就是掌握界面设计的必备条件、规则、约束、限制有哪些，确保自己做出来的东西具备可用性的，而不是毫无实现价值的飞机稿。</p>\n<p>而职业相关的规范，并不是只有苹果、安卓规范叫规范，而是包含好几种类型的规范需要我们去了解。</p>\n<p>我把它们分为下面这些类型：</p>\n<ol>\n<li>计算机规范，指的就是计算机领域的部分基础常识。有一部分知识是设计师也必须掌握的，例如图形成像、图形文件格式、字体显示原理等。</li>\n<li>硬件规范，主要指的是硬件上的特性对设计产生的影响。例如电容屏和电阻屏的操作差异，视网膜屏和低分屏的显示逻辑，折叠屏的操作和适配方式。</li>\n<li>系统规范，则是不同软件系统开发者制定出来的规范原则。系统级规范大到硬件底层系统，比如 Windows、Mac OS、Android，小到一些开源框架或软件系统，如 AntDesign、Element 等。</li>\n<li>视觉和交互规范，则是在视觉和交互领域中的一些必要规则和限制。比如视觉统一性的要求，最小可点击区域等。</li>\n</ol>\n<p>这两类规范我们会在后续的分享中一点点加入，本篇内容将围绕前三者展开。</p>\n<h3 id="学习规范的方法"><a href="#%E5%AD%A6%E4%B9%A0%E8%A7%84%E8%8C%83%E7%9A%84%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>学习规范的方法</h3>\n<p>分为 2 种即规范（强制）和建议（非强制），其中建议类规范占大部分，所以需要把规范记住，建议作为一个思考的方向</p>\n<h2 id="基础规范的扫盲"><a href="#%E5%9F%BA%E7%A1%80%E8%A7%84%E8%8C%83%E7%9A%84%E6%89%AB%E7%9B%B2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基础规范的扫盲</h2>\n<h3 id="屏幕和分辨率"><a href="#%E5%B1%8F%E5%B9%95%E5%92%8C%E5%88%86%E8%BE%A8%E7%8E%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>屏幕和分辨率</h3>\n<p>首先，UI 设计师产出的内容，都是在电子屏幕中显示的，是数字化的图形，而不是要打印喷绘出来的三维世界实物。所以，屏幕显示规则决定了图形的显示方式。</p>\n<p>电子屏幕成像的基本原理，即一块完整的屏幕由若干像素点组成。屏幕分辨率的参数，如 <code class="language-text">1920 * 1080</code>，指的就是这块屏幕 XY 轴包含的像素点数量。</p>\n<p>像素点是图像显示的最小单位（通道不算），每个像素点可以显示一个颜色，我们看见的电子图像，就是由这一个个色彩的 “小点” 拼装而成。</p>\n<p>随着技术的进步，屏幕分辨率越来越高，以及增加了子像素渲染技术，让我们看到的图形越来越细腻、清晰。</p>\n<p>而 iPhone 4 问世后更是带来了 “视网膜屏” 技术，3GS 使用 320480，而 4 使用 640960，像素密度提升了一倍，总量提升 4 (22) 倍。再到后来的 iPhoneX，屏幕密度再次提升一倍，总量是原来的 9 (33) 倍。</p>\n<p>那么这时候问题就来了，这些数值差距那么大，我们创建画布要以哪个参数为标准？真实项目里，我们是不是得每个尺寸做一套？</p>\n<p>在这里，我们不做过于专业的技术科普，大家只要牢记一点，在 iOS 和 Android 开发中，是没有 “像素” 这个单位的。</p>\n<p>苹果用的长度单位叫 PT，安卓的是 DP 和 SP，这些单位具体内涵大家不用去纠结，本质上它们只是一个符号、矢量单位，没有任何区别。</p>\n<p>这种单位的价值，就是可以统一一套数值体系，并运用在任何不同密度的屏幕中去，系统会自动完成对屏幕实际显示像素的换算和显示。</p>\n<p>例如，我们在 iOS 中制定了一个长宽 44pt 的图标，那么它在 3GS 中就是 1:1 的显示状态，即 44px。如果在 iPhone 4 中，就是 1:2 的状态，即 88px，在 iPhone X 中，则是 1:3 的 132px。</p>\n<p>换算成几倍，以及换算依据是什么，前期可以不用深究。只要知道用 PT 给出的数值是万能的，程序员写代码用这个单位，系统也根据这个单位计算像素值。</p>\n<p>我们在 Figma / Sketch / XD 创建的画布，实际上就是以 PT 为基础（矢量）。如果我们要输出不同屏幕密度的图像，就可以在导出面板选择导出 1x、2x、3x 的倍率即可。</p>\n<h3 id="矢量和位图"><a href="#%E7%9F%A2%E9%87%8F%E5%92%8C%E4%BD%8D%E5%9B%BE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>矢量和位图</h3>\n<p>上面我们说了 PT、DP、SP，本质上都是一样的东西，单位可有可无。主要的原因，就在于矢量和位图之间的原理差异上，它们是计算机领域最重要的两种图像类型，</p>\n<p>简单点说，矢量图是通过代码绘制出来的图形。比如代码指定了一个圆，那么系统就就会按圆的显示规则去解析它。而位图，则是去记录一定像素区域内，每个像素显示颜色的格式。</p>\n<p>所以，如果用矢量和位图格式分别画个圆，那么持续放大，就会发现矢量边缘依旧平滑，而位图的圆则边缘出现了深浅不一的 “锯齿”。</p>\n<p>之所以有这种差异，就是因为对于系统来说，它解析矢量文件是接受了我要 “画个圆” 的指令，不管放大还是缩小，它都按圆的方式显示。而解析位图，则仅仅是把位图中的像素色彩信息展示出来，它本身包含的了多少像素色彩信息，就显示多少。</p>\n<p>所以，矢量图形可以随意进行缩放，不会有显示上的问题。而位图因为包含的色彩信息是固定的，就没办法支持无损的放大。</p>\n<p>在矢量的世界里，也没有具体的度量单位，图形和图形之间的大小关系是比例关系而不是尺寸，只是根据我们显示的需要，它再被转换成像素呈现。所以不管是 PT、DP、SP，都没有本质区别。</p>\n<p>既然矢量可以随意缩放，位图还有什么存在必要？</p>\n<p>矢量并不是万能的，它记录图形的信息是非常有限的，适用于有明确几何关系和色彩简单的图形，比如图标、文字、扁平插画。</p>\n<p>而复杂的不规则图像，或者包含渐变、投影元素，都没法用矢量来完成，如照片、还是必须使用位图来记录才能正常显示。</p>\n<p>矢量和位图的认识涉及到项目方方面面，需要慢慢理解它们的差异和使用场景，包含切图导出格式，Lottie 动画逻辑，字体图标应用限制等。</p>\n<h3 id="图像文件格式"><a href="#%E5%9B%BE%E5%83%8F%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>图像文件格式</h3>\n<p>图像文件格式，即在计算机中记录单个图像的文件格式类型、文件后缀。根据矢量和位图的区别也可以分成两个大类。</p>\n<p>首先说矢量格式，UI 中会涉及的主要就是 SVG 和 PDF 了。在 iOS 规范中，矢量格式图形要导出 PDF，而安卓中则使用 SVG。至于它们具体有什么差异，感兴趣的同学可以自己查找。</p>\n<p>除了矢量格式外，还有若干的位图，它们有各自适用的场景，我们分别介绍。</p>\n<ol>\n<li>PNG：无损的位图格式，可以显示透明背景，是 UI 位图元素切图的最佳选择。</li>\n<li>JPG：有损的位图格式，体积更小，但不能显示透明背景，适用于运营图片素材。</li>\n<li>GIF：可支持动画帧的位图格式，主要用来作为动效示意，或一些运营动画元素的素材。</li>\n<li>WEBP：近年新兴的格式，压缩效率较高，常用来作为逐帧动画的帧图形。</li>\n</ol>\n<h3 id="色彩模式认识"><a href="#%E8%89%B2%E5%BD%A9%E6%A8%A1%E5%BC%8F%E8%AE%A4%E8%AF%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>色彩模式认识</h3>\n<p>颜色是一门很复杂的学问，在具体学习配色前，更应该先认识颜色的底层规范——色彩模式。</p>\n<p>色彩模式是一种用来描述、记录色彩的方法，而不同场景，方法就不一样。为什么解释颜色还要用不同的方法？</p>\n<p>首先，最早系统研究色彩必然从自然界开始，我们总结了色彩的基本规律，由色相、饱和度、明度构成了色彩的三个基本要素，即 HSB 色彩模式。</p>\n<p>HSB 是描述自然界所有颜色的方法。但是，随着人类的工业、化学技术提升，以及彩色屏幕的发明，对颜色的需求和应用就越来越广泛。</p>\n<p>在专业的染印领域，形成了由青(Cyan)、红(Magenta)、黄(Yellow)、黑(Black)四种颜料作为基础调和其它色彩的体系，也就是我们常说的 CMYK 模式。</p>\n<p>而在电子屏幕中，每个像素，由红(Red)、绿(Green)、蓝(Blue)三个不同发光二极管的发光强弱来组合成一个颜色的，就叫 RGB 模式。</p>',
excerpt:"…",frontmatter:{date:"2022-05-20 23:22:56",path:"/ui-introduce-learning/",tags:"UI, 读书笔记",title:"UI入门学习",draft:null}},prePost:{html:'<h1 id="webgl-三维几何加工"><a href="#webgl-%E4%B8%89%E7%BB%B4%E5%87%A0%E4%BD%95%E5%8A%A0%E5%B7%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 三维几何加工</h1>\n<p>有人问我怎么在 WebGL 中制作一个保龄球瓶，聪明的回答是<code class="language-text">使用一个三维建模工具例如 Blender, Maya, 3D Studio Max, Cinema 4D, 等等</code>。使用它创建一个保龄球瓶，导出，读取点坐标(OBJ 格式相对简单些)。</p>\n<p>但是，这让我想到，如果他们想做一个模型库该怎么办？</p>\n<p>这有几种方法，一种方法是将圆柱体按照正弦函数放置在合适位置上，但这样表面并不平滑。一个标准的圆柱需要一些间距相等的圆环，但当曲线变得锐利的时候所需圆环的数量就会很多。</p>\n<p>在模型库中你需要制作一个二维轮廓或者是一个符合边缘的曲线，然后将他们加工成三维图形。这里加工的意思就是将生成的二维点按照某些轴旋转。这样就可以很轻松的做出一些圆的物体，例如碗，棒球棒，瓶子，灯泡之类的物体。</p>\n<p>那么该怎么做呢？首先我们要通过某种方式生成一个曲线，计算曲线上的点。然后使用矩阵运算将这些点按照某个轴旋转，构建出三角形网格。</p>\n<h2 id="贝塞尔曲线"><a href="#%E8%B4%9D%E5%A1%9E%E5%B0%94%E6%9B%B2%E7%BA%BF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>贝塞尔曲线</h2>\n<p>计算机中常用的曲线就是贝塞尔曲线，你可能在一些编辑器例如 Adobe Illustrator 或 Inkscape 或 Affinity Designer 中编辑过贝塞尔曲线。</p>\n<p>贝塞尔曲线或三次贝塞尔曲线由 4 个点组成，2 个端点，2 个“控制点”。</p>\n<p>这就是四个点</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=0" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=0) -->\n<p>从 0 到 1 之间选一个数（叫做 t），其中 0 是起点，1 是终点。然后在每个线段中计算出与 t 相关的点，<code class="language-text">P1 P2</code>, <code class="language-text">P2 P3</code>, <code class="language-text">P3 P4</code>。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=1" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=1) -->\n<p>换句话说如果 <code class="language-text">t = .25</code> 那么就计算出 P1 到 P2 距离为 25% 的点，从 P2 到 P3 距离为 25% 的点，从 P3 到 P4 距离为 25% 的点。</p>\n<p>你可以拖动滑块调整 t 的值，也可以拖动 <code class="language-text">P1, P2, P3</code> 和 P4 调整位置。</p>\n<p>对这些结果点做同样的操作，计算 t 对应的 <code class="language-text">Q1 Q2</code> 和 <code class="language-text">Q2 Q3</code> 之间的点。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=2" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=2) -->\n<p>最后在 <code class="language-text">R1 R2</code> 中计算出与 t 相关的点。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=3" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=3) -->\n<p>红点的位置就构成了一个曲线。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=4" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=4) -->\n<p>这就是三次贝塞尔曲线。</p>\n<p>注意到在上述差值过程中通过 4 个点差出 3 个点，3 个点差出 2 个点，最后从 2 个点差出 1 个点，这并不是常用的做法，有人将这些数学运算简化成了一个公式，像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45219111718989640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`invT = (1 - t)\nP = P1 * invT^3 +\n    P2 * 3 * t * invT^2 +\n    P3 * 3 * invT * t^2 +\n    P4 * t^3`, `45219111718989640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">invT = (1 - t)\nP = P1 * invT^3 +\n    P2 * 3 * t * invT^2 +\n    P3 * 3 * invT * t^2 +\n    P4 * t^3</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其中 P1, P2, P3, P4 就像上例中的四个点，P 就是那个红点。</p>\n<p>在二维美术应用例如 Adobe Illustrator 中，当你制作一个较长的曲线时通常是由一些小的四点片段组成的。默认情况下应用将控制点沿着起/终点方向锁死，确保在公共点部分方向相反。</p>\n<p>看这个例子，移动 P3 或 P5 会同时移动另一个。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/xbsn5w?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>注意这个曲线是两段，<code class="language-text">P1,P2,P3,P4</code> 和 <code class="language-text">P4,P5,P6,P7</code>。只有在 P3，P5 与 P4 的连线方向相反时曲线在这一点才会连续。大多数应用可以让你断开连接，并获得一个锐利的拐点。取消选中复选框然后拖拽 P3 或 P5 就会清晰看到独立的曲线。</p>\n<p>接下来我们需要获得生成曲线上的点，通过给上方的公式提供 t 就可以生成一个点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29994118656406667000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function getPointOnBezierCurve(points, offset, t) {\n  const invT = 1 - t;\n  return v2.add(\n    v2.mult(points[offset + 0], invT * invT * invT),\n    v2.mult(points[offset + 1], 3 * t * invT * invT),\n    v2.mult(points[offset + 2], 3 * invT * t * t),\n    v2.mult(points[offset + 3], t * t * t)\n  );\n}`, `29994118656406667000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getPointOnBezierCurve</span><span class="token punctuation">(</span><span class="token parameter">points<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> t</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> invT <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> t<span class="token punctuation">;</span>\n  <span class="token keyword">return</span> v2<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>\n    v2<span class="token punctuation">.</span><span class="token function">mult</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> invT <span class="token operator">*</span> invT <span class="token operator">*</span> invT<span class="token punctuation">)</span><span class="token punctuation">,</span>\n    v2<span class="token punctuation">.</span><span class="token function">mult</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">*</span> t <span class="token operator">*</span> invT <span class="token operator">*</span> invT<span class="token punctuation">)</span><span class="token punctuation">,</span>\n    v2<span class="token punctuation">.</span><span class="token function">mult</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">*</span> invT <span class="token operator">*</span> t <span class="token operator">*</span> t<span class="token punctuation">)</span><span class="token punctuation">,</span>\n    v2<span class="token punctuation">.</span><span class="token function">mult</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t <span class="token operator">*</span> t <span class="token operator">*</span> t<span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后可以计算一系列点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57969918749549890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function getPointsOnBezierCurve(points, offset, numPoints) {\n  const points = [];\n  for (let i = 0; i < numPoints; ++i) {\n    const t = i / (numPoints - 1);\n    points.push(getPointOnBezierCurve(points, offset, t));\n  }\n  return points;\n}`, `57969918749549890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getPointsOnBezierCurve</span><span class="token punctuation">(</span><span class="token parameter">points<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> numPoints</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> points <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numPoints<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> t <span class="token operator">=</span> i <span class="token operator">/</span> <span class="token punctuation">(</span>numPoints <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    points<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">getPointOnBezierCurve</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> points<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意：<code class="language-text">v2.mult</code> 和 <code class="language-text">v2.add</code> 是我加入的二维点运算辅助方法。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=0%26showCurve=true%26showPoints=true" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=0%26showCurve=true%26showPoints=true) -->\n<p>在图示中你可以选择点的个数，如果曲线比较锐利就可以多差值一些点，如果曲线比较平缓就可以少插值一些点。一个解决办法是检查曲线的锐利程度，如果过于锐利就拆分成两个曲线。</p>\n<p>拆分的部分比较简单，如果我们再看看不同级别的拆分，对于任意值的 <code class="language-text">t, P1, Q1, R1</code>, 红点构成一个曲线，终点是红点。<code class="language-text">红点, R2, Q3, P4</code> 构成一个曲线。换句话说我们可以将曲线从任意位置分成两段，并且和原曲线相同。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=4%26show2Curves=true" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=4%26show2Curves=true) -->\n<p>第二个部分是如何决定曲线是否需要拆分，从网上查找后我发现了<a href="https://seant23.wordpress.com/2010/11/12/offset-bezier-curves/" target="_blank" rel="nofollow noreferrer noopener">这个方法</a>，对于给定的曲线可以求出平滑程度。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29537249208287887000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function flatness(points, offset) {\n  const p1 = points[offset + 0];\n  const p2 = points[offset + 1];\n  const p3 = points[offset + 2];\n  const p4 = points[offset + 3];\n\n  let ux = 3 * p2[0] - 2 * p1[0] - p4[0];\n  ux *= ux;\n  let uy = 3 * p2[1] - 2 * p1[1] - p4[1];\n  uy *= uy;\n  let vx = 3 * p3[0] - 2 * p4[0] - p1[0];\n  vx *= vx;\n  let vy = 3 * p3[1] - 2 * p4[1] - p1[1];\n  vy *= vy;\n\n  if (ux < vx) {\n    ux = vx;\n  }\n\n  if (uy < vy) {\n    uy = vy;\n  }\n\n  return ux + uy;\n}`, `29537249208287887000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">flatness</span><span class="token punctuation">(</span><span class="token parameter">points<span class="token punctuation">,</span> offset</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> p1 <span class="token operator">=</span> points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> p2 <span class="token operator">=</span> points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> p3 <span class="token operator">=</span> points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> p4 <span class="token operator">=</span> points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">let</span> ux <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">*</span> p2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> p1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> p4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  ux <span class="token operator">*=</span> ux<span class="token punctuation">;</span>\n  <span class="token keyword">let</span> uy <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">*</span> p2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> p4<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  uy <span class="token operator">*=</span> uy<span class="token punctuation">;</span>\n  <span class="token keyword">let</span> vx <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">*</span> p3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> p4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> p1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  vx <span class="token operator">*=</span> vx<span class="token punctuation">;</span>\n  <span class="token keyword">let</span> vy <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">*</span> p3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> p4<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  vy <span class="token operator">*=</span> vy<span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>ux <span class="token operator">&lt;</span> vx<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    ux <span class="token operator">=</span> vx<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>uy <span class="token operator">&lt;</span> vy<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    uy <span class="token operator">=</span> vy<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> ux <span class="token operator">+</span> uy<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以用它获取曲线上的点，首先检查曲线是否太锐利，如果是就拆分，不是就将点加入列表。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53105936378851746000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function getPointsOnBezierCurveWithSplitting(points, offset, tolerance, newPoints) {\n  const outPoints = newPoints || [];\n  if (flatness(points, offset) < tolerance) {\n    // 将它加入点队列中\n    outPoints.push(points[offset + 0]);\n    outPoints.push(points[offset + 3]);\n  } else {\n    // 拆分\n    const t = 0.5;\n    const p1 = points[offset + 0];\n    const p2 = points[offset + 1];\n    const p3 = points[offset + 2];\n    const p4 = points[offset + 3];\n\n    const q1 = v2.lerp(p1, p2, t);\n    const q2 = v2.lerp(p2, p3, t);\n    const q3 = v2.lerp(p3, p4, t);\n\n    const r1 = v2.lerp(q1, q2, t);\n    const r2 = v2.lerp(q2, q3, t);\n\n    const red = v2.lerp(r1, r2, t);\n\n    // 求前半段的点\n    getPointsOnBezierCurveWithSplitting([p1, q1, r1, red], 0, tolerance, outPoints);\n    // 求后半段的点\n    getPointsOnBezierCurveWithSplitting([red, r2, q3, p4], 0, tolerance, outPoints);\n  }\n  return outPoints;\n}`, `53105936378851746000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getPointsOnBezierCurveWithSplitting</span><span class="token punctuation">(</span><span class="token parameter">points<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> tolerance<span class="token punctuation">,</span> newPoints</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> outPoints <span class="token operator">=</span> newPoints <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">flatness</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> offset<span class="token punctuation">)</span> <span class="token operator">&lt;</span> tolerance<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 将它加入点队列中</span>\n    outPoints<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    outPoints<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 拆分</span>\n    <span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> p1 <span class="token operator">=</span> points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> p2 <span class="token operator">=</span> points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> p3 <span class="token operator">=</span> points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> p4 <span class="token operator">=</span> points<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> q1 <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> q2 <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>p2<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> q3 <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>p3<span class="token punctuation">,</span> p4<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> r1 <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>q1<span class="token punctuation">,</span> q2<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> r2 <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>q2<span class="token punctuation">,</span> q3<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> red <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>r1<span class="token punctuation">,</span> r2<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 求前半段的点</span>\n    <span class="token function">getPointsOnBezierCurveWithSplitting</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span> q1<span class="token punctuation">,</span> r1<span class="token punctuation">,</span> red<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> tolerance<span class="token punctuation">,</span> outPoints<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 求后半段的点</span>\n    <span class="token function">getPointsOnBezierCurveWithSplitting</span><span class="token punctuation">(</span><span class="token punctuation">[</span>red<span class="token punctuation">,</span> r2<span class="token punctuation">,</span> q3<span class="token punctuation">,</span> p4<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> tolerance<span class="token punctuation">,</span> outPoints<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> outPoints<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=0%26showCurve=true%26showTolerance=true" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=0%26showCurve=true%26showTolerance=true) -->\n<p>这个算法在获取曲线点的过程中确保了点的数量比较充足，但是不能很好的排除不必要的点。</p>\n<p>由于这个原因我们将使用我在网上找到的 <a href="https://en.wikipedia.org/wiki/Ramer%E2%80%93Douglas%E2%80%93Peucker_algorithm" target="_blank" rel="nofollow noreferrer noopener">Ramer Douglas Peucker 算法</a>。</p>\n<p>在这个算法中我们提供一系列点，找到离最后两点构成的直线距离最远的点，然后将这个距离和一个定值进行比较，如果小于那个值就保留最后两个点然后丢弃其他的点，大于则将曲线沿那个最远点分成两份，分别对每一份再做一次这个运算。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88040395446762290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function simplifyPoints(points, start, end, epsilon, newPoints) {\n  const outPoints = newPoints || [];\n\n  // 找到离最后两点距离最远的点\n  const s = points[start];\n  const e = points[end - 1];\n  let maxDistSq = 0;\n  let maxNdx = 1;\n  for (let i = start + 1; i < end - 1; ++i) {\n    const distSq = v2.distanceToSegmentSq(points[i], s, e);\n    if (distSq > maxDistSq) {\n      maxDistSq = distSq;\n      maxNdx = i;\n    }\n  }\n\n  // 如果距离太远\n  if (Math.sqrt(maxDistSq) > epsilon) {\n    // 拆分\n    simplifyPoints(points, start, maxNdx + 1, epsilon, outPoints);\n    simplifyPoints(points, maxNdx, end, epsilon, outPoints);\n  } else {\n    // 添加最后两个点\n    outPoints.push(s, e);\n  }\n\n  return outPoints;\n}`, `88040395446762290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">simplifyPoints</span><span class="token punctuation">(</span><span class="token parameter">points<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">,</span> epsilon<span class="token punctuation">,</span> newPoints</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> outPoints <span class="token operator">=</span> newPoints <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 找到离最后两点距离最远的点</span>\n  <span class="token keyword">const</span> s <span class="token operator">=</span> points<span class="token punctuation">[</span>start<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> e <span class="token operator">=</span> points<span class="token punctuation">[</span>end <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> maxDistSq <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> maxNdx <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> start <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> end <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> distSq <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">distanceToSegmentSq</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>distSq <span class="token operator">></span> maxDistSq<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      maxDistSq <span class="token operator">=</span> distSq<span class="token punctuation">;</span>\n      maxNdx <span class="token operator">=</span> i<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 如果距离太远</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>maxDistSq<span class="token punctuation">)</span> <span class="token operator">></span> epsilon<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 拆分</span>\n    <span class="token function">simplifyPoints</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> start<span class="token punctuation">,</span> maxNdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> epsilon<span class="token punctuation">,</span> outPoints<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">simplifyPoints</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> maxNdx<span class="token punctuation">,</span> end<span class="token punctuation">,</span> epsilon<span class="token punctuation">,</span> outPoints<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 添加最后两个点</span>\n    outPoints<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> outPoints<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">v2.distanceToSegmentSq</code> 是计算点到线段距离平方的一个方法，使用距离平方的原因是比使用实际距离要快一些，因为我们值管线最远距离所以和实际距离的效果相同。</p>\n<p>这是结果，调整距离查看添加或删除的点。</p>\n<html><head></head><body><iframe data-src="https://codesandbox.io/embed/5s188r?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview&amp;initialpath=?maxDepth=0%26showCurve=true%26showDistance=true" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe></body></html>\n<!-- [bezier-curve-diagram](embedded-codesandbox://webgl-fundamental-geometry/bezier-curve-diagram?view=preview&initialpath=?maxDepth=0%26showCurve=true%26showDistance=true) -->\n<h2 id="保龄球"><a href="#%E4%BF%9D%E9%BE%84%E7%90%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>保龄球</h2>\n<p>回到保龄球瓶，我们可以将上方的代码整理一下，需要添加和移除点，锁定和解锁控制点， 撤销等等。但是这有一个简单的方式，我们可以使用一个上方提到的编辑器，我使用这个在线编辑器。</p>\n<p>这是保龄球的半边轮廓的 svg。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-06-23-11-00-19-6d26d4834d585ad7693700c7d8e3f61c-80d40.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 640px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAAAZUlEQVQ4y2NgwA9YgJiVgUqACYh1gJiPWgbyALEylM1IDQO5gFiFgcoAZCAHNQyCeVEZ6nUGahmqBsTM1DKQH4iVqBEpyN7lHZQRAsshytR0HRPUQGZqJhlVIOampis5qZlkyAYA9fACRaHh3QoAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 06 23 11 00 19" title="" data-src="/static/2022-06-23-11-00-19-6d26d4834d585ad7693700c7d8e3f61c-80d40.png" data-srcset="/static/2022-06-23-11-00-19-6d26d4834d585ad7693700c7d8e3f61c-5da91.png 200w,\n/static/2022-06-23-11-00-19-6d26d4834d585ad7693700c7d8e3f61c-08121.png 400w,\n/static/2022-06-23-11-00-19-6d26d4834d585ad7693700c7d8e3f61c-80d40.png 640w" data-sizes="(max-width: 640px) 100vw, 640px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>由 4 个曲线制成，路径的数据像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10997691787044973000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<path\n  fill=&quot;none&quot;\n  stroke-width=&quot;5&quot;\n  d=&quot;\n   m44,434\n   c18,-33 19,-66 15,-111\n   c-4,-45 -37,-104 -39,-132\n   c-2,-28 11,-51 16,-81\n   c5,-30 3,-63 -36,-63\n  &quot;\n/>`, `10997691787044973000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="svg"\n              >\n                <span class="gatsby-code-button-language">svg</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="svg"><pre style="counter-reset: linenumber NaN" class="language-svg line-numbers"><code class="language-svg"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>path</span>\n  <span class="token attr-name">fill</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>none<span class="token punctuation">"</span></span>\n  <span class="token attr-name">stroke-width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span>\n  <span class="token attr-name">d</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>\n   m44,434\n   c18,-33 19,-66 15,-111\n   c-4,-45 -37,-104 -39,-132\n   c-2,-28 11,-51 16,-81\n   c5,-30 3,-63 -36,-63\n  <span class="token punctuation">"</span></span>\n<span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Tutorial/Paths" target="_blank" rel="nofollow noreferrer noopener">解译</a>这些数据得到这些点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2014995077647885300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`        ___\n44, 371,   |\n62, 338,   | 第一个曲线\n63, 305,___|__\n59, 260,___|  |\n55, 215,      | 第二个曲线\n22, 156,______|__\n20, 128,______|  |\n18, 100,         | 第三个曲线\n31,  77,_________|__\n36,  47,_________|  |\n41,  17,            | 第四个曲线\n39, -16,            |\n 0, -16,____________|`, `2014995077647885300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">        ___\n44, 371,   |\n62, 338,   | 第一个曲线\n63, 305,___|__\n59, 260,___|  |\n55, 215,      | 第二个曲线\n22, 156,______|__\n20, 128,______|  |\n18, 100,         | 第三个曲线\n31,  77,_________|__\n36,  47,_________|  |\n41,  17,            | 第四个曲线\n39, -16,            |\n 0, -16,____________|</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在有了曲线数据，需要计算出曲线上的点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78662528261830000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 获取所有片段的点\nfunction getPointsOnBezierCurves(points, tolerance) {\n  const newPoints = [];\n  const numSegments = (points.length - 1) / 3;\n  for (let i = 0; i < numSegments; ++i) {\n    const offset = i * 3;\n    getPointsOnBezierCurveWithSplitting(points, offset, tolerance, newPoints);\n  }\n  return newPoints;\n}`, `78662528261830000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 获取所有片段的点</span>\n<span class="token keyword">function</span> <span class="token function">getPointsOnBezierCurves</span><span class="token punctuation">(</span><span class="token parameter">points<span class="token punctuation">,</span> tolerance</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> newPoints <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> numSegments <span class="token operator">=</span> <span class="token punctuation">(</span>points<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numSegments<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> offset <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>\n    <span class="token function">getPointsOnBezierCurveWithSplitting</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> tolerance<span class="token punctuation">,</span> newPoints<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> newPoints<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用 simplifyPoints 处理结果。</p>\n<p>现在要旋转它们了，需要决定分多少个部分，对于每个部分都用矩阵运算绕 Y 轴转动一定角度获得，一旦获得所有点就用索引连接它们。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70692628087009890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 绕 Y 轴旋转\nfunction lathePoints(\n  points,\n  startAngle, // 起始角 (例如 0)\n  endAngle, // 终止角 (例如 Math.PI * 2)\n  numDivisions, // 这中间生成多少块\n  capStart, // true 就封闭起点\n  capEnd\n) {\n  // true 就封闭重点\n  const positions = [];\n  const texcoords = [];\n  const indices = [];\n\n  const vOffset = capStart ? 1 : 0;\n  const pointsPerColumn = points.length + vOffset + (capEnd ? 1 : 0);\n  const quadsDown = pointsPerColumn - 1;\n\n  // 生成点\n  for (let division = 0; division <= numDivisions; ++division) {\n    const u = division / numDivisions;\n    const angle = lerp(startAngle, endAngle, u) % (Math.PI * 2);\n    const mat = m4.yRotation(angle);\n    if (capStart) {\n      // 在开始处添加一个 Y 轴上的点\n      positions.push(0, points[0][1], 0);\n      texcoords.push(u, 0);\n    }\n    points.forEach((p, ndx) => {\n      const tp = m4.transformPoint(mat, [...p, 0]);\n      positions.push(tp[0], tp[1], tp[2]);\n      const v = (ndx + vOffset) / quadsDown;\n      texcoords.push(u, v);\n    });\n    if (capEnd) {\n      // 在终点处添加一个 Y 轴上的点\n      positions.push(0, points[points.length - 1][1], 0);\n      texcoords.push(u, 1);\n    }\n  }\n\n  // 创建索引\n  for (let division = 0; division < numDivisions; ++division) {\n    const column1Offset = division * pointsPerColumn;\n    const column2Offset = column1Offset + pointsPerColumn;\n    for (let quad = 0; quad < quadsDown; ++quad) {\n      indices.push(column1Offset + quad, column2Offset + quad, column1Offset + quad + 1);\n      indices.push(column1Offset + quad + 1, column2Offset + quad, column2Offset + quad + 1);\n    }\n  }\n\n  return {\n    position: positions,\n    texcoord: texcoords,\n    indices: indices\n  };\n}`, `70692628087009890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 绕 Y 轴旋转</span>\n<span class="token keyword">function</span> <span class="token function">lathePoints</span><span class="token punctuation">(</span>\n  points<span class="token punctuation">,</span>\n  startAngle<span class="token punctuation">,</span> <span class="token comment">// 起始角 (例如 0)</span>\n  endAngle<span class="token punctuation">,</span> <span class="token comment">// 终止角 (例如 Math.PI * 2)</span>\n  numDivisions<span class="token punctuation">,</span> <span class="token comment">// 这中间生成多少块</span>\n  capStart<span class="token punctuation">,</span> <span class="token comment">// true 就封闭起点</span>\n  capEnd\n<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// true 就封闭重点</span>\n  <span class="token keyword">const</span> positions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> texcoords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> indices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> vOffset <span class="token operator">=</span> capStart <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> pointsPerColumn <span class="token operator">=</span> points<span class="token punctuation">.</span>length <span class="token operator">+</span> vOffset <span class="token operator">+</span> <span class="token punctuation">(</span>capEnd <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> quadsDown <span class="token operator">=</span> pointsPerColumn <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 生成点</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> division <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> division <span class="token operator">&lt;=</span> numDivisions<span class="token punctuation">;</span> <span class="token operator">++</span>division<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> u <span class="token operator">=</span> division <span class="token operator">/</span> numDivisions<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> angle <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>startAngle<span class="token punctuation">,</span> endAngle<span class="token punctuation">,</span> u<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> mat <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">yRotation</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>capStart<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 在开始处添加一个 Y 轴上的点</span>\n      positions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> points<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      texcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    points<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p<span class="token punctuation">,</span> ndx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> tp <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">transformPoint</span><span class="token punctuation">(</span>mat<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">...</span>p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      positions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>tp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tp<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> v <span class="token operator">=</span> <span class="token punctuation">(</span>ndx <span class="token operator">+</span> vOffset<span class="token punctuation">)</span> <span class="token operator">/</span> quadsDown<span class="token punctuation">;</span>\n      texcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>capEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 在终点处添加一个 Y 轴上的点</span>\n      positions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> points<span class="token punctuation">[</span>points<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      texcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 创建索引</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> division <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> division <span class="token operator">&lt;</span> numDivisions<span class="token punctuation">;</span> <span class="token operator">++</span>division<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> column1Offset <span class="token operator">=</span> division <span class="token operator">*</span> pointsPerColumn<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> column2Offset <span class="token operator">=</span> column1Offset <span class="token operator">+</span> pointsPerColumn<span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> quad <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> quad <span class="token operator">&lt;</span> quadsDown<span class="token punctuation">;</span> <span class="token operator">++</span>quad<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      indices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>column1Offset <span class="token operator">+</span> quad<span class="token punctuation">,</span> column2Offset <span class="token operator">+</span> quad<span class="token punctuation">,</span> column1Offset <span class="token operator">+</span> quad <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      indices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>column1Offset <span class="token operator">+</span> quad <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> column2Offset <span class="token operator">+</span> quad<span class="token punctuation">,</span> column2Offset <span class="token operator">+</span> quad <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    position<span class="token punctuation">:</span> positions<span class="token punctuation">,</span>\n    texcoord<span class="token punctuation">:</span> texcoords<span class="token punctuation">,</span>\n    indices<span class="token punctuation">:</span> indices\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上方的代码创建了位置点和纹理坐标，然后创建索引生成三角网。capStart 和 capEnd 确定是都生成闭合点，假设我们在做一个罐头，这些选项指明是否需要闭合顶面和底面。</p>\n<p>使用我们的简化代码就可以用哪些数据生成这样的 WebGL 缓冲</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86145294618513390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const tolerance = 0.15;\nconst distance = 0.4;\nconst divisions = 16;\nconst startAngle = 0;\nconst endAngle = Math.PI * 2;\nconst capStart = true;\nconst capEnd = true;\n\nconst tempPoints = getPointsOnBezierCurves(curvePoints, tolerance);\nconst points = simplifyPoints(tempPoints, 0, tempPoints.length, distance);\nconst arrays = lathePoints(points, startAngle, endAngle, divisions, capStart, capEnd);\nconst extents = getExtents(arrays.position);\nif (!bufferInfo) {\n  bufferInfo = webglUtils.createBufferInfoFromArrays(gl, arrays);\n}`, `86145294618513390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> tolerance <span class="token operator">=</span> <span class="token number">0.15</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> distance <span class="token operator">=</span> <span class="token number">0.4</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> divisions <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> startAngle <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> endAngle <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> capStart <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> capEnd <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> tempPoints <span class="token operator">=</span> <span class="token function">getPointsOnBezierCurves</span><span class="token punctuation">(</span>curvePoints<span class="token punctuation">,</span> tolerance<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> points <span class="token operator">=</span> <span class="token function">simplifyPoints</span><span class="token punctuation">(</span>tempPoints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> tempPoints<span class="token punctuation">.</span>length<span class="token punctuation">,</span> distance<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> arrays <span class="token operator">=</span> <span class="token function">lathePoints</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> startAngle<span class="token punctuation">,</span> endAngle<span class="token punctuation">,</span> divisions<span class="token punctuation">,</span> capStart<span class="token punctuation">,</span> capEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> extents <span class="token operator">=</span> <span class="token function">getExtents</span><span class="token punctuation">(</span>arrays<span class="token punctuation">.</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bufferInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  bufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> arrays<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/lfvcxq?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>拖动滑块观察对结果的影响。</p>\n<p>这还有一个问题，开启三角形你会看到纹理不是均匀分布的，这是因为我们将纹理坐标的 v 值赋为曲线点的索引，如果曲线上的点距离相等那就没问题，但是它们距离并不相等。</p>\n<p>我们可以遍历曲线上的点并计算出每一点对应曲线长度，最后将这个长度除以曲线总长度赋值给 v。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97459112864921490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 绕 Y 轴旋转\nfunction lathePoints(\n  points,\n  startAngle, // 起始角 (例如 0)\n  endAngle, // 终止角 (例如 Math.PI * 2)\n  numDivisions, // 这中间生成多少块\n  capStart, // true 就封闭起点\n  capEnd\n) {\n  // true 就封闭重点\n  const positions = [];\n  const texcoords = [];\n  const indices = [];\n\n  const vOffset = capStart ? 1 : 0;\n  const pointsPerColumn = points.length + vOffset + (capEnd ? 1 : 0);\n  const quadsDown = pointsPerColumn - 1;\n\n  // 生成 v 值\n  let vcoords = [];\n\n  // 先计算出每一点对应的长度\n  let length = 0;\n  for (let i = 0; i < points.length - 1; ++i) {\n    vcoords.push(length);\n    length += v2.distance(points[i], points[i + 1]);\n  }\n  vcoords.push(length); // 最后一个点\n\n  // 除以总长\n  vcoords = vcoords.map((v) => v / length);\n\n  // 生成点\n  for (let division = 0; division <= numDivisions; ++division) {\n    const u = division / numDivisions;\n    const angle = lerp(startAngle, endAngle, u) % (Math.PI * 2);\n    const mat = m4.yRotation(angle);\n    if (capStart) {\n      // 在开始处添加一个 Y 轴上的点\n      positions.push(0, points[0][1], 0);\n      texcoords.push(u, 0);\n    }\n    points.forEach((p, ndx) => {\n      const tp = m4.transformPoint(mat, [...p, 0]);\n      positions.push(tp[0], tp[1], tp[2]);\n      texcoords.push(u, vcoords[ndx]);\n    });\n    if (capEnd) {\n      // 在终点处添加一个 Y 轴上的点\n      positions.push(0, points[points.length - 1][1], 0);\n      texcoords.push(u, 1);\n    }\n  }\n\n  // 创建索引\n  for (let division = 0; division < numDivisions; ++division) {\n    const column1Offset = division * pointsPerColumn;\n    const column2Offset = column1Offset + pointsPerColumn;\n    for (let quad = 0; quad < quadsDown; ++quad) {\n      indices.push(column1Offset + quad, column1Offset + quad + 1, column2Offset + quad);\n      indices.push(column1Offset + quad + 1, column2Offset + quad + 1, column2Offset + quad);\n    }\n  }\n\n  return {\n    position: positions,\n    texcoord: texcoords,\n    indices: indices\n  };\n}`, `97459112864921490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{19-31,46}"\n              >\n                <span class="gatsby-code-button-language">js{19-31,46}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 绕 Y 轴旋转</span>\n<span class="token keyword">function</span> <span class="token function">lathePoints</span><span class="token punctuation">(</span>\n  points<span class="token punctuation">,</span>\n  startAngle<span class="token punctuation">,</span> <span class="token comment">// 起始角 (例如 0)</span>\n  endAngle<span class="token punctuation">,</span> <span class="token comment">// 终止角 (例如 Math.PI * 2)</span>\n  numDivisions<span class="token punctuation">,</span> <span class="token comment">// 这中间生成多少块</span>\n  capStart<span class="token punctuation">,</span> <span class="token comment">// true 就封闭起点</span>\n  capEnd\n<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// true 就封闭重点</span>\n  <span class="token keyword">const</span> positions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> texcoords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> indices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> vOffset <span class="token operator">=</span> capStart <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> pointsPerColumn <span class="token operator">=</span> points<span class="token punctuation">.</span>length <span class="token operator">+</span> vOffset <span class="token operator">+</span> <span class="token punctuation">(</span>capEnd <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> quadsDown <span class="token operator">=</span> pointsPerColumn <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 生成 v 值</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">let</span> vcoords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 先计算出每一点对应的长度</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">let</span> length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> points<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    vcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    length <span class="token operator">+=</span> v2<span class="token punctuation">.</span><span class="token function">distance</span><span class="token punctuation">(</span>points<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> points<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">  vcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 最后一个点</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 除以总长</span></span><span class="gatsby-highlight-code-line">  vcoords <span class="token operator">=</span> vcoords<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=></span> v <span class="token operator">/</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// 生成点</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> division <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> division <span class="token operator">&lt;=</span> numDivisions<span class="token punctuation">;</span> <span class="token operator">++</span>division<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> u <span class="token operator">=</span> division <span class="token operator">/</span> numDivisions<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> angle <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>startAngle<span class="token punctuation">,</span> endAngle<span class="token punctuation">,</span> u<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> mat <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">yRotation</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>capStart<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 在开始处添加一个 Y 轴上的点</span>\n      positions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> points<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      texcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    points<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p<span class="token punctuation">,</span> ndx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> tp <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">transformPoint</span><span class="token punctuation">(</span>mat<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">...</span>p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      positions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>tp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tp<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">      texcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> vcoords<span class="token punctuation">[</span>ndx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>capEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 在终点处添加一个 Y 轴上的点</span>\n      positions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> points<span class="token punctuation">[</span>points<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      texcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 创建索引</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> division <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> division <span class="token operator">&lt;</span> numDivisions<span class="token punctuation">;</span> <span class="token operator">++</span>division<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> column1Offset <span class="token operator">=</span> division <span class="token operator">*</span> pointsPerColumn<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> column2Offset <span class="token operator">=</span> column1Offset <span class="token operator">+</span> pointsPerColumn<span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> quad <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> quad <span class="token operator">&lt;</span> quadsDown<span class="token punctuation">;</span> <span class="token operator">++</span>quad<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      indices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>column1Offset <span class="token operator">+</span> quad<span class="token punctuation">,</span> column1Offset <span class="token operator">+</span> quad <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> column2Offset <span class="token operator">+</span> quad<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      indices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>column1Offset <span class="token operator">+</span> quad <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> column2Offset <span class="token operator">+</span> quad <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> column2Offset <span class="token operator">+</span> quad<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    position<span class="token punctuation">:</span> positions<span class="token punctuation">,</span>\n    texcoord<span class="token punctuation">:</span> texcoords<span class="token punctuation">,</span>\n    indices<span class="token punctuation">:</span> indices\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/92oji1?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>这些纹理坐标还是不完美，因为我们还没决定怎么处理闭合部分的纹理。这也是使用建模软件的一个原因。我们可以总结出很多计算闭合处 uv 值的方法，但并不是很有意义。如果你谷歌一下 UV map a barrel，你会发现完美的 UV 坐标是不需要太多数学运算的，只需要生成合适的点数据，这时你就需要一个合适工具创建点数据。</p>\n<p>还有一个事情要做，就是添加法向量。</p>\n<p>我们可以计算每一个曲线点的法向量，事实上如果你会看这节中的例子，你会发现 R1 和 R2 构成的线段切曲线于红点处。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-06-23-11-22-57-0ba072fc47669e4c73f863080ab9e16b-70a78.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 610px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 75.08196721311475%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsSAAALEgHS3X78AAAB1UlEQVQoz41Si26bMBTl3/cD+5BqSiZF1TZpK1GnhlAySAKN1KBlqUjICwzBwfhxPUMoS1gn7Viyrq99zn34avK/wStcerTGAgC1r9drhFB5FjKjmR3ZQnAQ5VWSJLZtX/Lb5MPhMLIsxstFCjLcGs/xnFMGQJWK7/sY4zfITW6kKJRRAIl4JJSoZIs4djyqnOw68yuyis0FWQXyOcg3YpfucGb7aJVHQTYwUXhMyycM3iYrVcHZBqORvkvfE7IlIklYIXjBJT2RZL/Mfrmx2yYLEJhjQskeb/ExlCmDd1Iez/m8bhwI2n/f3Kc0rTzQRAYnHs/2Lk+QelSWakhJoKY2IgJokjLG/kSGyp+cEIqCpu3wVcr86iNqG2OaZa20gcaI5QUXqgJggsmFFEV1eGXWokIUUXRFLpRYns99/8PNzY/R6Munz/r93aP1aJpmr9frdDrdblfXdUKIytl1nFMVXFMdzvOcpWUPfi4WQ8v6pvct2556T8ZgYBiGmqqPFcbj8Tl4EARhGNaRJ46zCcpqV8vlk2VNHh7sfn8+mQxNczqdzmYzz/Nc11V2q37tPLTZsfwWeHmR3a40DHl7Kx2nnpt/Q7sUU80ANScKnCun+Ast8m8R5FeFBdrBoQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 06 23 11 22 57" title="" data-src="/static/2022-06-23-11-22-57-0ba072fc47669e4c73f863080ab9e16b-70a78.png" data-srcset="/static/2022-06-23-11-22-57-0ba072fc47669e4c73f863080ab9e16b-1dff0.png 200w,\n/static/2022-06-23-11-22-57-0ba072fc47669e4c73f863080ab9e16b-8ee4c.png 400w,\n/static/2022-06-23-11-22-57-0ba072fc47669e4c73f863080ab9e16b-70a78.png 610w" data-sizes="(max-width: 610px) 100vw, 610px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>法向量和切线垂直所以从切线很容易求出法向量。</p>\n<h2 id="烛台"><a href="#%E7%83%9B%E5%8F%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>烛台</h2>\n<p>但是，假设我们想要做一个烛台，有这样一个框架。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-06-23-11-23-38-ef6b344c559a8e31bb0a204c734dc856-a27d0.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 150px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAABDElEQVQ4y2NgIA8wkqqBCUrnAHEFkngQEPeSYygzlC4E4vVI4vVAvBDKZiHHwG4gnoMkngbEW9F8QZKXPYH4MRAnALEPEF8D4lI0S0kO+CQgfgfEf4C4iYFKYDEQnwViNnJjGdlLjUD8H4o3kRN+2MAMIN4PxNyUGgRLGqC0uJzcyMDmbVBkrKWGgbCw2gDEdyn1Lswwe6RIyaLElTBNiUgGTqDEQFhaE4YmbJCBlpQYCPOyNxB/hhqYR410aADEl4D4FTQ/kw2EgNgNiMuA+BEQfwPiFiAOAGIpUg0rBuJzQPwcatALIH4CZb8B4stA3A/E7MQaCIoIQWhhwASNBBYomxWI+YFYDFtYAgD8fy81El3vMgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 06 23 11 23 38" title="" data-src="/static/2022-06-23-11-23-38-ef6b344c559a8e31bb0a204c734dc856-a27d0.png" data-srcset="/static/2022-06-23-11-23-38-ef6b344c559a8e31bb0a204c734dc856-a27d0.png 150w" data-sizes="(max-width: 150px) 100vw, 150px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这有很多平滑区域也有很多锐利角，如何决定使用法向量的方向呢？当需要锐利边缘时就要使用多余的顶点，因为一个顶点有一个位置和一个法向量，如果需要多个法向量就需要不同的顶点，这也是制作立方体需要至少 24 个顶点的原因，虽然立方体只有 8 个顶点，但每个面在那个顶点处都需要不同的法向量。</p>\n<p>创建立方体的时候很容易确定法向量，但是形状复杂的时候就没那么容易了。</p>\n<p>所有的建模软件都有不同的方式创建法向量，一个常用的做法就是将该点邻接的三角面的法向量求平均。另外，还允许用户选择一个最大角度，如果邻接的多边形的法向量的夹角大于最大角度，就会创建一个新顶点。</p>\n<p>我们来实现这个。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92020956285531770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function generateNormals(arrays, maxAngle) {\n  const positions = arrays.position;\n  const texcoords = arrays.texcoord;\n\n  // 首先计算出每个面的法向量\n  let getNextIndex = makeIndiceIterator(arrays);\n  const numFaceVerts = getNextIndex.numElements;\n  const numVerts = arrays.position.length;\n  const numFaces = numFaceVerts / 3;\n  const faceNormals = [];\n\n  // 计算每个面的法向量\n  // 计算过程中为每个面新建顶点\n  for (let i = 0; i < numFaces; ++i) {\n    const n1 = getNextIndex() * 3;\n    const n2 = getNextIndex() * 3;\n    const n3 = getNextIndex() * 3;\n\n    const v1 = positions.slice(n1, n1 + 3);\n    const v2 = positions.slice(n2, n2 + 3);\n    const v3 = positions.slice(n3, n3 + 3);\n\n    faceNormals.push(m4.normalize(m4.cross(m4.subtractVectors(v1, v2), m4.subtractVectors(v3, v2))));\n  }\n\n  let tempVerts = {};\n  let tempVertNdx = 0;\n\n  // 假设顶点位置精确匹配\n\n  function getVertIndex(x, y, z) {\n    const vertId = x + \',\' + y + \',\' + z;\n    const ndx = tempVerts[vertId];\n    if (ndx !== undefined) {\n      return ndx;\n    }\n    const newNdx = tempVertNdx++;\n    tempVerts[vertId] = newNdx;\n    return newNdx;\n  }\n\n  // 我们需要算出共享的顶点\n  // 这并不像我们看着面那么简单 (三角形)\n  // 因为假如我们有一个标准的圆柱\n  //\n  //\n  //      3-4\n  //     /   \\\n  //    2     5   从上往下看，从 S 走到 E, E 和 S\n  //    1     6   是不同的点，因为它们不共享UV坐标。\n  //     \\   /\n  //      S/E\n  //\n  // 顶点在起始和结束位置并不是共享的\n  // 由于它们有不同的 UV 坐标，但如果不\n  // 把它们看作共享顶点就会得到错误结果\n\n  const vertIndices = [];\n  for (let i = 0; i < numVerts; ++i) {\n    const offset = i * 3;\n    const vert = positions.slice(offset, offset + 3);\n    vertIndices.push(getVertIndex(vert));\n  }\n\n  // 遍历所有顶点记录所在的面\n  const vertFaces = [];\n  getNextIndex.reset();\n  for (let i = 0; i < numFaces; ++i) {\n    for (let j = 0; j < 3; ++j) {\n      const ndx = getNextIndex();\n      const sharedNdx = vertIndices[ndx];\n      let faces = vertFaces[sharedNdx];\n      if (!faces) {\n        faces = [];\n        vertFaces[sharedNdx] = faces;\n      }\n      faces.push(i);\n    }\n  }\n\n  // 遍历面上的顶点计算每个顶点的法向量\n  // 只计算两面角度不大于 maxAngle 面\n  // 将结果写入 newPositions, newTexcoords 和 newNormals\n  // 丢弃相同的顶点\n  tempVerts = {};\n  tempVertNdx = 0;\n  const newPositions = [];\n  const newTexcoords = [];\n  const newNormals = [];\n\n  function getNewVertIndex(x, y, z, nx, ny, nz, u, v) {\n    const vertId = x + \',\' + y + \',\' + z + \',\' + nx + \',\' + ny + \',\' + nz + \',\' + u + \',\' + v;\n\n    const ndx = tempVerts[vertId];\n    if (ndx !== undefined) {\n      return ndx;\n    }\n    const newNdx = tempVertNdx++;\n    tempVerts[vertId] = newNdx;\n    newPositions.push(x, y, z);\n    newNormals.push(nx, ny, nz);\n    newTexcoords.push(u, v);\n    return newNdx;\n  }\n\n  const newVertIndices = [];\n  getNextIndex.reset();\n  const maxAngleCos = Math.cos(maxAngle);\n  // 对每个面\n  for (let i = 0; i < numFaces; ++i) {\n    // 获取该面的法向量\n    const thisFaceNormal = faceNormals[i];\n    // 对于面上的每一点\n    for (let j = 0; j < 3; ++j) {\n      const ndx = getNextIndex();\n      const sharedNdx = vertIndices[ndx];\n      const faces = vertFaces[sharedNdx];\n      const norm = [0, 0, 0];\n      faces.forEach((faceNdx) => {\n        // 面的法向量是否相同\n        const otherFaceNormal = faceNormals[faceNdx];\n        const dot = m4.dot(thisFaceNormal, otherFaceNormal);\n        if (dot > maxAngleCos) {\n          m4.addVectors(norm, otherFaceNormal, norm);\n        }\n      });\n      m4.normalize(norm, norm);\n      const poffset = ndx * 3;\n      const toffset = ndx * 2;\n      newVertIndices.push(\n        getNewVertIndex(\n          positions[poffset + 0],\n          positions[poffset + 1],\n          positions[poffset + 2],\n          norm[0],\n          norm[1],\n          norm[2],\n          texcoords[toffset + 0],\n          texcoords[toffset + 1]\n        )\n      );\n    }\n  }\n\n  return {\n    position: newPositions,\n    texcoord: newTexcoords,\n    normal: newNormals,\n    indices: newVertIndices\n  };\n}\n\nfunction makeIndexedIndicesFn(arrays) {\n  const indices = arrays.indices;\n  let ndx = 0;\n  const fn = function () {\n    return indices[ndx++];\n  };\n  fn.reset = function () {\n    ndx = 0;\n  };\n  fn.numElements = indices.length;\n  return fn;\n}\n\nfunction makeUnindexedIndicesFn(arrays) {\n  let ndx = 0;\n  const fn = function () {\n    return ndx++;\n  };\n  fn.reset = function () {\n    ndx = 0;\n  };\n  fn.numElements = arrays.positions.length / 3;\n  return fn;\n}\n\nfunction makeIndiceIterator(arrays) {\n  return arrays.indices ? makeIndexedIndicesFn(arrays) : makeUnindexedIndicesFn(arrays);\n}`, `92020956285531770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">generateNormals</span><span class="token punctuation">(</span><span class="token parameter">arrays<span class="token punctuation">,</span> maxAngle</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> positions <span class="token operator">=</span> arrays<span class="token punctuation">.</span>position<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> texcoords <span class="token operator">=</span> arrays<span class="token punctuation">.</span>texcoord<span class="token punctuation">;</span>\n\n  <span class="token comment">// 首先计算出每个面的法向量</span>\n  <span class="token keyword">let</span> getNextIndex <span class="token operator">=</span> <span class="token function">makeIndiceIterator</span><span class="token punctuation">(</span>arrays<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> numFaceVerts <span class="token operator">=</span> getNextIndex<span class="token punctuation">.</span>numElements<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> numVerts <span class="token operator">=</span> arrays<span class="token punctuation">.</span>position<span class="token punctuation">.</span>length<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> numFaces <span class="token operator">=</span> numFaceVerts <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> faceNormals <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 计算每个面的法向量</span>\n  <span class="token comment">// 计算过程中为每个面新建顶点</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numFaces<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> n1 <span class="token operator">=</span> <span class="token function">getNextIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> n2 <span class="token operator">=</span> <span class="token function">getNextIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> n3 <span class="token operator">=</span> <span class="token function">getNextIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> v1 <span class="token operator">=</span> positions<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n1 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> v2 <span class="token operator">=</span> positions<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>n2<span class="token punctuation">,</span> n2 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> v3 <span class="token operator">=</span> positions<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>n3<span class="token punctuation">,</span> n3 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    faceNormals<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>m4<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span>m4<span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span>m4<span class="token punctuation">.</span><span class="token function">subtractVectors</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">subtractVectors</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">let</span> tempVerts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> tempVertNdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 假设顶点位置精确匹配</span>\n\n  <span class="token keyword">function</span> <span class="token function">getVertIndex</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> vertId <span class="token operator">=</span> x <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> y <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> z<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> ndx <span class="token operator">=</span> tempVerts<span class="token punctuation">[</span>vertId<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>ndx <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> ndx<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> newNdx <span class="token operator">=</span> tempVertNdx<span class="token operator">++</span><span class="token punctuation">;</span>\n    tempVerts<span class="token punctuation">[</span>vertId<span class="token punctuation">]</span> <span class="token operator">=</span> newNdx<span class="token punctuation">;</span>\n    <span class="token keyword">return</span> newNdx<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 我们需要算出共享的顶点</span>\n  <span class="token comment">// 这并不像我们看着面那么简单 (三角形)</span>\n  <span class="token comment">// 因为假如我们有一个标准的圆柱</span>\n  <span class="token comment">//</span>\n  <span class="token comment">//</span>\n  <span class="token comment">//      3-4</span>\n  <span class="token comment">//     /   \\</span>\n  <span class="token comment">//    2     5   从上往下看，从 S 走到 E, E 和 S</span>\n  <span class="token comment">//    1     6   是不同的点，因为它们不共享UV坐标。</span>\n  <span class="token comment">//     \\   /</span>\n  <span class="token comment">//      S/E</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// 顶点在起始和结束位置并不是共享的</span>\n  <span class="token comment">// 由于它们有不同的 UV 坐标，但如果不</span>\n  <span class="token comment">// 把它们看作共享顶点就会得到错误结果</span>\n\n  <span class="token keyword">const</span> vertIndices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numVerts<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> offset <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> vert <span class="token operator">=</span> positions<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> offset <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    vertIndices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">getVertIndex</span><span class="token punctuation">(</span>vert<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 遍历所有顶点记录所在的面</span>\n  <span class="token keyword">const</span> vertFaces <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  getNextIndex<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numFaces<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> ndx <span class="token operator">=</span> <span class="token function">getNextIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> sharedNdx <span class="token operator">=</span> vertIndices<span class="token punctuation">[</span>ndx<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">let</span> faces <span class="token operator">=</span> vertFaces<span class="token punctuation">[</span>sharedNdx<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>faces<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        faces <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n        vertFaces<span class="token punctuation">[</span>sharedNdx<span class="token punctuation">]</span> <span class="token operator">=</span> faces<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      faces<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 遍历面上的顶点计算每个顶点的法向量</span>\n  <span class="token comment">// 只计算两面角度不大于 maxAngle 面</span>\n  <span class="token comment">// 将结果写入 newPositions, newTexcoords 和 newNormals</span>\n  <span class="token comment">// 丢弃相同的顶点</span>\n  tempVerts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  tempVertNdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> newPositions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> newTexcoords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> newNormals <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">function</span> <span class="token function">getNewVertIndex</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> nx<span class="token punctuation">,</span> ny<span class="token punctuation">,</span> nz<span class="token punctuation">,</span> u<span class="token punctuation">,</span> v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> vertId <span class="token operator">=</span> x <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> y <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> z <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> nx <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> ny <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> nz <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> u <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> v<span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> ndx <span class="token operator">=</span> tempVerts<span class="token punctuation">[</span>vertId<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>ndx <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> ndx<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> newNdx <span class="token operator">=</span> tempVertNdx<span class="token operator">++</span><span class="token punctuation">;</span>\n    tempVerts<span class="token punctuation">[</span>vertId<span class="token punctuation">]</span> <span class="token operator">=</span> newNdx<span class="token punctuation">;</span>\n    newPositions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    newNormals<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>nx<span class="token punctuation">,</span> ny<span class="token punctuation">,</span> nz<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    newTexcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> newNdx<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> newVertIndices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  getNextIndex<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> maxAngleCos <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>maxAngle<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 对每个面</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numFaces<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 获取该面的法向量</span>\n    <span class="token keyword">const</span> thisFaceNormal <span class="token operator">=</span> faceNormals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token comment">// 对于面上的每一点</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> ndx <span class="token operator">=</span> <span class="token function">getNextIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> sharedNdx <span class="token operator">=</span> vertIndices<span class="token punctuation">[</span>ndx<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> faces <span class="token operator">=</span> vertFaces<span class="token punctuation">[</span>sharedNdx<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> norm <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      faces<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">faceNdx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token comment">// 面的法向量是否相同</span>\n        <span class="token keyword">const</span> otherFaceNormal <span class="token operator">=</span> faceNormals<span class="token punctuation">[</span>faceNdx<span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> dot <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>thisFaceNormal<span class="token punctuation">,</span> otherFaceNormal<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>dot <span class="token operator">></span> maxAngleCos<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          m4<span class="token punctuation">.</span><span class="token function">addVectors</span><span class="token punctuation">(</span>norm<span class="token punctuation">,</span> otherFaceNormal<span class="token punctuation">,</span> norm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      m4<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span>norm<span class="token punctuation">,</span> norm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> poffset <span class="token operator">=</span> ndx <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> toffset <span class="token operator">=</span> ndx <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>\n      newVertIndices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>\n        <span class="token function">getNewVertIndex</span><span class="token punctuation">(</span>\n          positions<span class="token punctuation">[</span>poffset <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          positions<span class="token punctuation">[</span>poffset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          positions<span class="token punctuation">[</span>poffset <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          norm<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          norm<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          norm<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          texcoords<span class="token punctuation">[</span>toffset <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          texcoords<span class="token punctuation">[</span>toffset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>\n        <span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    position<span class="token punctuation">:</span> newPositions<span class="token punctuation">,</span>\n    texcoord<span class="token punctuation">:</span> newTexcoords<span class="token punctuation">,</span>\n    normal<span class="token punctuation">:</span> newNormals<span class="token punctuation">,</span>\n    indices<span class="token punctuation">:</span> newVertIndices\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">makeIndexedIndicesFn</span><span class="token punctuation">(</span><span class="token parameter">arrays</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> indices <span class="token operator">=</span> arrays<span class="token punctuation">.</span>indices<span class="token punctuation">;</span>\n  <span class="token keyword">let</span> ndx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> indices<span class="token punctuation">[</span>ndx<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  fn<span class="token punctuation">.</span><span class="token function-variable function">reset</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    ndx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  fn<span class="token punctuation">.</span>numElements <span class="token operator">=</span> indices<span class="token punctuation">.</span>length<span class="token punctuation">;</span>\n  <span class="token keyword">return</span> fn<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">makeUnindexedIndicesFn</span><span class="token punctuation">(</span><span class="token parameter">arrays</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> ndx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> ndx<span class="token operator">++</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  fn<span class="token punctuation">.</span><span class="token function-variable function">reset</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    ndx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  fn<span class="token punctuation">.</span>numElements <span class="token operator">=</span> arrays<span class="token punctuation">.</span>positions<span class="token punctuation">.</span>length <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> fn<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">makeIndiceIterator</span><span class="token punctuation">(</span><span class="token parameter">arrays</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> arrays<span class="token punctuation">.</span>indices <span class="token operator">?</span> <span class="token function">makeIndexedIndicesFn</span><span class="token punctuation">(</span>arrays<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">makeUnindexedIndicesFn</span><span class="token punctuation">(</span>arrays<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上方的代码首先通过原始顶点计算每个面（三角形）的法向量，然后创建一个顶点索引集寻找相同的顶点，那是因为我们旋转后的起始和终止点应该是同一个点，但 UV 坐标不同所以要单独处理，计算顶点法向量时要将它们看作相同点。</p>\n<p>这些做完之后，对于每个顶点，生成了一个包含它的面的集合。</p>\n<p>最后将所有除了差值大于 maxAngle 的面的法向量求平均，获得一个新的顶点集合。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/phpk6p?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>注意到在期望的位置得到了锐利的边缘，调大 maxAngle 的值就会将相邻的面加入计算，得到平滑的边缘。试试调整 divisions 为 5 或者 6 然后调整 maxAngle 的值让该平滑的地方平滑，该锐利的地方锐利，你也可以设置 mode 为 lit 查看光照效果，这是我们需要法向量的原因。</p>\n<p>由此得到的结论是：如果想做三维模型就用三维建模库</p>\n<p>你可能需要一个 UV 编辑器，帮助完成封闭问题也是三维编辑器提供的功能。代替使用有限的组合处理闭合处问题，可以使用其他编辑器提供的特性处理闭合处并轻松的获取 UV 值，三维编辑器还支持拉伸面和沿路径拉伸，你看了之后就会发现它们是基于上方的加工方式。</p>\n<h2 id="参考"><a href="#%E5%8F%82%E8%80%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>参考</h2>\n<p><a href="https://pomax.github.io/bezierinfo/" target="_blank" rel="nofollow noreferrer noopener">贝塞尔曲线</a></p>\n<h2 id="这里的模运算符是做什么的"><a href="#%E8%BF%99%E9%87%8C%E7%9A%84%E6%A8%A1%E8%BF%90%E7%AE%97%E7%AC%A6%E6%98%AF%E5%81%9A%E4%BB%80%E4%B9%88%E7%9A%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>这里的模运算符是做什么的?</h2>\n<p>如果你仔细看了 lathePoints 方法就会看到计算角度时使用了模运算符。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12137828039829058000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for (let division = 0; division <= numDivisions; ++division) {\n  const u = division / numDivisions;\n  const angle = lerp(startAngle, endAngle, u) % (Math.PI * 2);\n}`, `12137828039829058000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> division <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> division <span class="token operator">&lt;=</span> numDivisions<span class="token punctuation">;</span> <span class="token operator">++</span>division<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> u <span class="token operator">=</span> division <span class="token operator">/</span> numDivisions<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> angle <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>startAngle<span class="token punctuation">,</span> endAngle<span class="token punctuation">,</span> u<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为什么这么做?</p>\n<p>当我们将点旋转成一个圆形时我们希望起点和终点是匹配的。<code class="language-text">Math.sin(0)</code> 和 <code class="language-text">Math.sin(Math.PI * 2)</code> 应该相等，但是浮点运算并不精确，所以通常它们并不是 100% 的相等。</p>\n<p>这在计算法向量的时候十分重要，我们想知道到一个顶点共享的所有面，我们比较顶点，如果相同就认为是同一点，那么如果不被认为是同一点就会计算出错误的法向量。</p>\n<p>这是这种情况发生时的样子</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-06-23-11-38-12-cb920957f35234ac5ecbd4a8afdb2939-1e4d6.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 420px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 140.47619047619048%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAIAAADuuAg3AAAACXBIWXMAAAsSAAALEgHS3X78AAADIUlEQVQ4y2P4jwP8+v3ny7cfv379/o8bMCBz/v37ByQv3/yS23PeNneTXlqLfV5hcVfd1Wtn4bLYNUOkfn37H5L8iMVvF1PSYoaMPNZULwF/+cRE3T/fv2LqR7H573+QXN2cj0Itxzj7V7D2F/NNCJRuUW2fFwaXxan5D9jgnv0fuRsOcDYtY6su4q0PFq5X7d6ZBdL87y8+zX//gjTn9r0W8dsnFLCU36tE3CdE3l8vr8UR7i8Cmqd1v1fSOSxvt0zavFzZJkJHV3FOVx5Y9i/+0AaR71/9zbQ6Zckyx5G/1o7ZL9fU8/3zhyBZ/Joh+oEm/H3+Y0XbPQ2f8mVNvf+efvsHCuZ/BOIZpBkcrE9+fc+5d0J2e3nmtfKHP+/8/weGBDX/AXu7f+ETHofF6n71Qhb6nTPzsXoYq7NBml/f/jo1+YKZduXUuNqXNx5hTV5YNIPjE6Tu1pP/8gU1l+4ewhrDeDSDbLr54r9ke/25BwdI1QzSffX5f9HO2pP3d5OmGZJI9z3+xTS3aP2dBWCRP0Rp/vcfGivJZ24ybi0JOx7y68/H//+JjCqwtYfv/xCct49naZ3QbI3N12bishx7PG8/+Z0rZT9ncS1vksbynd1g8d+ENYP1/n/y7K96yimm6CqVGP1rNw4Tm0jg6SFyyh2G3DKfHtd/v78R62eIkmXXn9kc2StxqMb8sNvsC7X//v4mENpABwNjGBJgW4+9Dm8+IONWFlyct/7AMqBjgGXQ33+//6IGGxZn//zz58//bysfPJDvK592te3H/3c//nzAcBxMM4T34cfvY2/eLHh5q+bl0bAXq9w+TfX+U+/+MSH4hU/Fy4i5L3KPvJ765utVZP8zQOjX33+nXLnhdfOYw50d5ndXmj2YY/dyqvndcvO76ZYPYmzvurvfMQm9pZJ2Serm2yPwBMsAyWov3/72W3RZbctOhcOrFC7MU789zeDZRJlTOdInY5Uvhaud91Y/ZG2wTd9vnv7dJ+cRmuFF1/OnPxduf5y95KT3wm32S1ebrJir0VVu0FdkNaPYd355wZLWOVsWPHn0CNnZAAmynWVSCotdAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 06 23 11 38 12" title="" data-src="/static/2022-06-23-11-38-12-cb920957f35234ac5ecbd4a8afdb2939-1e4d6.png" data-srcset="/static/2022-06-23-11-38-12-cb920957f35234ac5ecbd4a8afdb2939-5f5a6.png 200w,\n/static/2022-06-23-11-38-12-cb920957f35234ac5ecbd4a8afdb2939-fe3d6.png 400w,\n/static/2022-06-23-11-38-12-cb920957f35234ac5ecbd4a8afdb2939-1e4d6.png 420w" data-sizes="(max-width: 420px) 100vw, 420px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>你可以看到它们在共享处没有被当作相同点，因为它们不是 100% 的相等。</p>\n<p>起初我想通过提供一个误差范围，检查顶点的距离是否在范围内，如果小于误差范围就认为是同一点，就像这样。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26394190675224570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const epsilon = 0.0001;\nconst tempVerts = [];\nfunction getVertIndex(position) {\n  if (tempVerts.length) {\n    // 找到最近的点\n    let closestNdx = 0;\n    let closestDistSq = v2.distanceSq(position, tempVerts[0]);\n    for (let i = 1; i < tempVerts.length; ++i) {\n      let distSq = v2.distanceSq(position, tempVerts[i]);\n      if (distSq < closestDistSq) {\n        closestDistSq = distSq;\n        closestNdx = i;\n      }\n    }\n    // 是否在误差范围内\n    if (closestDistSq < epsilon) {\n      // 是就返回那个点\n      return closestNdx;\n    }\n  }\n  // 不是就将它添加到序列中并返回索引\n  tempVerts.push(position);\n  return tempVerts.length - 1;\n}`, `26394190675224570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> epsilon <span class="token operator">=</span> <span class="token number">0.0001</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> tempVerts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">function</span> <span class="token function">getVertIndex</span><span class="token punctuation">(</span><span class="token parameter">position</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>tempVerts<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 找到最近的点</span>\n    <span class="token keyword">let</span> closestNdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n    <span class="token keyword">let</span> closestDistSq <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">distanceSq</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> tempVerts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tempVerts<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> distSq <span class="token operator">=</span> v2<span class="token punctuation">.</span><span class="token function">distanceSq</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> tempVerts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>distSq <span class="token operator">&lt;</span> closestDistSq<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        closestDistSq <span class="token operator">=</span> distSq<span class="token punctuation">;</span>\n        closestNdx <span class="token operator">=</span> i<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// 是否在误差范围内</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>closestDistSq <span class="token operator">&lt;</span> epsilon<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 是就返回那个点</span>\n      <span class="token keyword">return</span> closestNdx<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// 不是就将它添加到序列中并返回索引</span>\n  tempVerts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> tempVerts<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>它成功解决了接缝问题，但是它消耗的时间太长，导致 UI 交互不稳定。这是因为它是一个复杂度为 O^2 的解决方法，如果你滑动滑块在最多的情况下就会创建大约 20000 个点，再加上 O^2 的复杂度就是 3 亿次迭代。</p>\n<p>我在网上寻找简单的方法但没找到，我想过将所有点都放到<a href="https://en.wikipedia.org/wiki/Octree" target="_blank" rel="nofollow noreferrer noopener">八叉树</a>中，让寻找匹配点速度快一些，但那似乎远离了本章的范围。</p>\n<p>然后我就想到既然只是终点问题我就可以进行模运算，让结果相等，原始代码像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88531532774651220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const angle = lerp(startAngle, endAngle, u);`, `88531532774651220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> angle <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>startAngle<span class="token punctuation">,</span> endAngle<span class="token punctuation">,</span> u<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>新代码像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45333863261803310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const angle = lerp(startAngle, endAngle, u) % (Math.PI * 2);`, `45333863261803310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> angle <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>startAngle<span class="token punctuation">,</span> endAngle<span class="token punctuation">,</span> u<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>由于模运算 endAngle 为 <code class="language-text">Math.PI * 2</code> 时 angle 就为 0，和起始点相同，接缝消失了，问题解决了！</p>\n<p>但是，即使这样当设置 distance 为 0.001 并且 divisions 为 60 时，在我的机子上还要几乎 1 秒钟的运算。这可能还有很多可以优化的地方，但创建复杂的网格是一个耗时的工作，这就是我的三维游戏可以以 60fps 运行，但是三维建模工具通常都是很低的帧率。</p>\n<h2 id="使用矩阵运算是不是大材小用了"><a href="#%E4%BD%BF%E7%94%A8%E7%9F%A9%E9%98%B5%E8%BF%90%E7%AE%97%E6%98%AF%E4%B8%8D%E6%98%AF%E5%A4%A7%E6%9D%90%E5%B0%8F%E7%94%A8%E4%BA%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用矩阵运算是不是大材小用了?</h2>\n<p>当我们旋转点的时候使用这样的代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32892204917880520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const mat = m4.yRotation(angle);\n// ...\npoints.forEach((p, ndx) => {\n  const tp = m4.transformPoint(mat, [...p, 0]);\n  // ...\n});`, `32892204917880520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> mat <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">yRotation</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// ...</span>\npoints<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p<span class="token punctuation">,</span> ndx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> tp <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">transformPoint</span><span class="token punctuation">(</span>mat<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">...</span>p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 4x4 矩阵转换一个任意三维点需要 16 次乘法，12 次加法，和 3 次除法。我们可以只使用单位圆形式的旋转运算。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75635540693155320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const s = Math.sin(angle);\nconst c = Math.cos(angle);\n//...\npoints.forEach((p, ndx) => {\n  const x = p[0];\n  const y = p[1];\n  const z = p[2];\n  const tp = [x * c - z * s, y, x * s + z * c];\n  //...\n});`, `75635540693155320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> s <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> c <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">//...</span>\npoints<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p<span class="token punctuation">,</span> ndx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> x <span class="token operator">=</span> p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> y <span class="token operator">=</span> p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> z <span class="token operator">=</span> p<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> tp <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token operator">*</span> c <span class="token operator">-</span> z <span class="token operator">*</span> s<span class="token punctuation">,</span> y<span class="token punctuation">,</span> x <span class="token operator">*</span> s <span class="token operator">+</span> z <span class="token operator">*</span> c<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token comment">//...</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样就只有 4 次乘法和 2 次加法，没有方法调用，应该至少要快 6 倍。</p>\n<p>这个优化值得么？当然，对于这个特殊的例子，我不认为这个有什么意义，我认为你可能需要让用户决定绕那个轴旋转，使用矩阵就可以让用户传入一个轴，像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26774380886472570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const mat = m4.axisRotation(userSuppliedAxis, angle);`, `26774380886472570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> mat <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">axisRotation</span><span class="token punctuation">(</span>userSuppliedAxis<span class="token punctuation">,</span> angle<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>哪种方式更好其实取决于你自己和你的需求，我认为我会优先选择灵活的方式，然后运行太慢时再去考虑优化。</p>\n<h1 id="webgl-加载-obj-文件"><a href="#webgl-%E5%8A%A0%E8%BD%BD-obj-%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 加载 .obj 文件</h1>\n<p>Wavefront 的 .obj 文件是网上最常用的 3D 文件格式。它们并不是难以解析的格式，所以让我们试试。这能够提供一个解析 3D 文件的有用例子。</p>\n<blockquote>\n<p>该 .obj 解析器不会面面俱到或者完美，也不保证能够处理所有 .obj 文件。这只是一个练习。如果你使用该程序并遇到问题，下面的链接可能会对你有帮助。</p>\n<p>我找到的有关 .obj 文件的<a href="http://paulbourke.net/dataformats/obj/" target="_blank" rel="nofollow noreferrer noopener">文档</a>。不过<a href="https://www.loc.gov/preservation/digital/formats/fdd/fdd000507.shtml" target="_blank" rel="nofollow noreferrer noopener">这里</a>链接了很多其它相关文档。</p>\n</blockquote>\n<h2 id="立方体"><a href="#%E7%AB%8B%E6%96%B9%E4%BD%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>立方体</h2>\n<p>让我们看一个简单的例子。下面是从 blender 默认场景中导出的 cube.obj：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43943273255846085000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# Blender v2.80 (sub 75) OBJ File: \'\'\n# www.blender.org\nmtllib cube.mtl\no Cube\nv 1.000000 1.000000 -1.000000\nv 1.000000 -1.000000 -1.000000\nv 1.000000 1.000000 1.000000\nv 1.000000 -1.000000 1.000000\nv -1.000000 1.000000 -1.000000\nv -1.000000 -1.000000 -1.000000\nv -1.000000 1.000000 1.000000\nv -1.000000 -1.000000 1.000000\nvt 0.375000 0.000000\nvt 0.625000 0.000000\nvt 0.625000 0.250000\nvt 0.375000 0.250000\nvt 0.375000 0.250000\nvt 0.625000 0.250000\nvt 0.625000 0.500000\nvt 0.375000 0.500000\nvt 0.625000 0.750000\nvt 0.375000 0.750000\nvt 0.625000 0.750000\nvt 0.625000 1.000000\nvt 0.375000 1.000000\nvt 0.125000 0.500000\nvt 0.375000 0.500000\nvt 0.375000 0.750000\nvt 0.125000 0.750000\nvt 0.625000 0.500000\nvt 0.875000 0.500000\nvt 0.875000 0.750000\nvn 0.0000 1.0000 0.0000\nvn 0.0000 0.0000 1.0000\nvn -1.0000 0.0000 0.0000\nvn 0.0000 -1.0000 0.0000\nvn 1.0000 0.0000 0.0000\nvn 0.0000 0.0000 -1.0000\nusemtl Material\ns off\nf 1/1/1 5/2/1 7/3/1 3/4/1\nf 4/5/2 3/6/2 7/7/2 8/8/2\nf 8/8/3 7/7/3 5/9/3 6/10/3\nf 6/10/4 2/11/4 4/12/4 8/13/4\nf 2/14/5 1/15/5 3/16/5 4/17/5\nf 6/18/6 5/19/6 1/20/6 2/11/6`, `43943273255846085000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="obj"\n              >\n                <span class="gatsby-code-button-language">obj</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="obj"><pre style="counter-reset: linenumber NaN" class="language-obj line-numbers"><code class="language-obj"># Blender v2.80 (sub 75) OBJ File: &#39;&#39;\n# www.blender.org\nmtllib cube.mtl\no Cube\nv 1.000000 1.000000 -1.000000\nv 1.000000 -1.000000 -1.000000\nv 1.000000 1.000000 1.000000\nv 1.000000 -1.000000 1.000000\nv -1.000000 1.000000 -1.000000\nv -1.000000 -1.000000 -1.000000\nv -1.000000 1.000000 1.000000\nv -1.000000 -1.000000 1.000000\nvt 0.375000 0.000000\nvt 0.625000 0.000000\nvt 0.625000 0.250000\nvt 0.375000 0.250000\nvt 0.375000 0.250000\nvt 0.625000 0.250000\nvt 0.625000 0.500000\nvt 0.375000 0.500000\nvt 0.625000 0.750000\nvt 0.375000 0.750000\nvt 0.625000 0.750000\nvt 0.625000 1.000000\nvt 0.375000 1.000000\nvt 0.125000 0.500000\nvt 0.375000 0.500000\nvt 0.375000 0.750000\nvt 0.125000 0.750000\nvt 0.625000 0.500000\nvt 0.875000 0.500000\nvt 0.875000 0.750000\nvn 0.0000 1.0000 0.0000\nvn 0.0000 0.0000 1.0000\nvn -1.0000 0.0000 0.0000\nvn 0.0000 -1.0000 0.0000\nvn 1.0000 0.0000 0.0000\nvn 0.0000 0.0000 -1.0000\nusemtl Material\ns off\nf 1/1/1 5/2/1 7/3/1 3/4/1\nf 4/5/2 3/6/2 7/7/2 8/8/2\nf 8/8/3 7/7/3 5/9/3 6/10/3\nf 6/10/4 2/11/4 4/12/4 8/13/4\nf 2/14/5 1/15/5 3/16/5 4/17/5\nf 6/18/6 5/19/6 1/20/6 2/11/6</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>即使不看文档我们也能发现 v 开始的行表示顶点，vt 开始的行表示纹理坐标，vn 开始的行表示法线。接下来就是理解剩下的代表什么。</p>\n<p>看起来 .obj 文件是文本文件，所以我们要做的第一件事就是加载文本文件。幸运的是，如果使用 async/await 这将是一件很简单的事。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84020163573294070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`async function main() {\n  // ...\n\n  const response = await fetch(\'resources/models/cube/cube.obj\');\n  const text = await response.text();\n}`, `84020163573294070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">\'resources/models/cube/cube.obj\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> text <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接着，我们可以一行一行地解析，每行都是下面的形式:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65539706434001690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`keyword data data data ...`, `65539706434001690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">keyword data data data ...</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>每行的开头是 keyword，data 由空格隔开。以 <code class="language-text">#</code> 开头的行是注释。</p>\n<p>接着，用代码来解析每一行，跳过空白行和注释，然后根据 keyword 调用对应的函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59794140539039020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseOBJ(text) {\n  const keywords = {};\n\n  const keywordRE = /(\\w*)(?: )*(.*)/;\n  const lines = text.split(\'\\n\');\n  for (let lineNo = 0; lineNo < lines.length; ++lineNo) {\n    const line = lines[lineNo].trim();\n    if (line === \'\' || line.startsWith(\'#\')) {\n      continue;\n    }\n    const m = keywordRE.exec(line);\n    if (!m) {\n      continue;\n    }\n    const [, keyword, unparsedArgs] = m;\n    const parts = line.split(/\\s+/).slice(1);\n    const handler = keywords[keyword];\n    if (!handler) {\n      console.warn(\'unhandled keyword:\', keyword, \' at line\', lineNo + 1);\n      continue;\n    }\n    handler(parts, unparsedArgs);\n  }\n}`, `59794140539039020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> keywordRE <span class="token operator">=</span> <span class="token regex">/(\\w*)(?: )*(.*)/</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> lines <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'\\n\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> lineNo <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> lineNo <span class="token operator">&lt;</span> lines<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>lineNo<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> line <span class="token operator">=</span> lines<span class="token punctuation">[</span>lineNo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>line <span class="token operator">===</span> <span class="token string">\'\'</span> <span class="token operator">||</span> line<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">\'#\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">continue</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> m <span class="token operator">=</span> keywordRE<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">continue</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> keyword<span class="token punctuation">,</span> unparsedArgs<span class="token punctuation">]</span> <span class="token operator">=</span> m<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> parts <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex">/\\s+/</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> handler <span class="token operator">=</span> keywords<span class="token punctuation">[</span>keyword<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">\'unhandled keyword:\'</span><span class="token punctuation">,</span> keyword<span class="token punctuation">,</span> <span class="token string">\' at line\'</span><span class="token punctuation">,</span> lineNo <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">continue</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token function">handler</span><span class="token punctuation">(</span>parts<span class="token punctuation">,</span> unparsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意：我们去除了每行开头和结尾的空格。我不知道这是否有必要，但是我觉得没有坏处。我们用 <code class="language-text">/\\s+/</code> 将每行以空格分割。同样地我不知道这是否有必要，data 之间会有多于一个空格吗？是否可以是制表符？不知道，但是这样看起来更安全。</p>\n<p>另外，我们将每行的第一部分作为 keyword，然后找到对应的函数调用，并将 keyword 后面的 data 传给该函数。所以接下来我们只要完成这些函数。</p>\n<p>之前，我们猜测了 v，vt 和 vn 的含义。文档表明 f 代表“面”或多边形，每部分数据代表了顶点、纹理坐标以及法线。</p>\n<p>如果一个索引是正数，表示从序列 1 开始的偏移。如果索引是负数，表示从序列结尾开始的偏移。索引的顺序是：顶点/纹理坐标/法线，只有顶点是必要的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72824510270445740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`f 1 2 3             # 只包含顶点索引\nf 1/1 2/2 3/3       # 包含顶点索引和纹理坐标索引\nf 1/1/1 2/2/2 3/3/3 # 包含顶点索引、纹理坐标索引和法线索引\nf 1//1 2//2 3//3    # 包含顶点索引和法线索引`, `72824510270445740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">f 1 2 3             # 只包含顶点索引\nf 1/1 2/2 3/3       # 包含顶点索引和纹理坐标索引\nf 1/1/1 2/2/2 3/3/3 # 包含顶点索引、纹理坐标索引和法线索引\nf 1//1 2//2 3//3    # 包含顶点索引和法线索引</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>f 可以有多于 3 个顶点，比如 4 个顶点代表四边形。WebGL 只能绘制三角形，所以需要将数据转换成三角形。标准并没有规定说一个面可以有多于 4 个顶点，也没有说面必须是凹的或凸的。但暂时让我们假设面是凹的。</p>\n<p>通常在 WebGL 中，我们不单独说明顶点、纹理坐标和法线，<code class="language-text">WebGL 顶点</code> 代表了包含了代表该顶点的顶点坐标、纹理坐标、法线的数据集合。例如，要绘制一个立方体，WebGL 需要 36 个顶点，每个面是两个三角形，每个三角形是 3 个顶点，6 个面每个面 2 个三角形，每个三角形 3 个顶点 = 36 个顶点。尽管一个立方体只有 8 个不重复的顶点和 6 条不重复的法线。所以，我们需要读取面的顶点索引来生成包含了顶点位置、纹理坐标、法线的 <code class="language-text">WebGL 顶点</code>。</p>\n<p>所以，根据上面的描述，我们可以像下面这样解析：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91579040781326090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseOBJ(text) {\n  // 因为索引是从 1 开始的，所以填充索引为 0 的位置\n  const objPositions = [[0, 0, 0]];\n  const objTexcoords = [[0, 0]];\n  const objNormals = [[0, 0, 0]];\n\n  // 和 \\`f\\` 一样的索引顺序\n  const objVertexData = [objPositions, objTexcoords, objNormals];\n\n  // 和 \\`f\\` 一样的索引顺序\n  let webglVertexData = [\n    [], // 顶点\n    [], // 纹理坐标\n    [] // 法线\n  ];\n\n  function addVertex(vert) {\n    const ptn = vert.split(\'/\');\n    ptn.forEach((objIndexStr, i) => {\n      if (!objIndexStr) {\n        return;\n      }\n      const objIndex = parseInt(objIndexStr);\n      const index = objIndex + (objIndex >= 0 ? 0 : objVertexData[i].length);\n      webglVertexData[i].push(...objVertexData[i][index]);\n    });\n  }\n\n  const keywords = {\n    v(parts) {\n      objPositions.push(parts.map(parseFloat));\n    },\n    vn(parts) {\n      objNormals.push(parts.map(parseFloat));\n    },\n    vt(parts) {\n      objTexcoords.push(parts.map(parseFloat));\n    },\n    f(parts) {\n      const numTriangles = parts.length - 2;\n      for (let tri = 0; tri < numTriangles; ++tri) {\n        addVertex(parts[0]);\n        addVertex(parts[tri + 1]);\n        addVertex(parts[tri + 2]);\n      }\n    }\n  };\n}`, `91579040781326090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 因为索引是从 1 开始的，所以填充索引为 0 的位置</span>\n  <span class="token keyword">const</span> objPositions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> objTexcoords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> objNormals <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 和 `f` 一样的索引顺序</span>\n  <span class="token keyword">const</span> objVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>objPositions<span class="token punctuation">,</span> objTexcoords<span class="token punctuation">,</span> objNormals<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 和 `f` 一样的索引顺序</span>\n  <span class="token keyword">let</span> webglVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 顶点</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 纹理坐标</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 法线</span>\n  <span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">function</span> <span class="token function">addVertex</span><span class="token punctuation">(</span><span class="token parameter">vert</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> ptn <span class="token operator">=</span> vert<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    ptn<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">objIndexStr<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>objIndexStr<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">const</span> objIndex <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>objIndexStr<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> index <span class="token operator">=</span> objIndex <span class="token operator">+</span> <span class="token punctuation">(</span>objIndex <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> objVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      webglVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>objVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token function">v</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      objPositions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">vn</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      objNormals<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">vt</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      objTexcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> numTriangles <span class="token operator">=</span> parts<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> tri <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> tri <span class="token operator">&lt;</span> numTriangles<span class="token punctuation">;</span> <span class="token operator">++</span>tri<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">addVertex</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token function">addVertex</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span>tri <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token function">addVertex</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span>tri <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的代码创建了 3 个数组来保存从 object 文件中解析出来的顶点位置、纹理坐标和法线。同时创建了 3 个数组来保存 WebGL 的顶点。为了方便引用，数组的顺序和 f 中索引的顺序是一样的。</p>\n<p>例如下面的 f 行</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30887080745162064000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`f 1/2/3/ 4/5/6 7/8/9`, `30887080745162064000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">f 1/2/3/ 4/5/6 7/8/9</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>像 4/5/6 表示对这个面的一个顶点使用“顶点 4”，“纹理坐标 5”，“法线 6”。我们将顶点、纹理坐标、法线数据放进 objVertexData 数组，这样就能简单的表示为：对 webglData 的第 i 项，使用 objData 第 i 个数组中的第 n 个元素。 这样会简化我们的代码。</p>\n<p>在函数的结尾返回我们构建的数据</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2025345999727235000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n\nreturn {\n  position: webglVertexData[0],\n  texcoord: webglVertexData[1],\n  normal: webglVertexData[2]\n};`, `2025345999727235000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n\n<span class="token keyword">return</span> <span class="token punctuation">{</span>\n  position<span class="token punctuation">:</span> webglVertexData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  texcoord<span class="token punctuation">:</span> webglVertexData<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  normal<span class="token punctuation">:</span> webglVertexData<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接下来要做的就是将数据绘制出来。首先我们使用三维方向光源中着色器的变体。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64405621038598880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const vs = \\`\n   attribute vec4 a_position;\n   attribute vec3 a_normal;\n   \n   uniform mat4 u_projection;\n   uniform mat4 u_view;\n   uniform mat4 u_world;\n   \n   varying vec3 v_normal;\n   \n   void main() {\n      gl_Position = u_projection * u_view * u_world * a_position;\n      v_normal = mat3(u_world) * a_normal;\n   }\n\\`;\n\nconst fs = \\`\n   precision mediump float;\n   \n   varying vec3 v_normal;\n   \n   uniform vec4 u_diffuse;\n   uniform vec3 u_lightDirection;\n   \n   void main () {\n      vec3 normal = normalize(v_normal);\n      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;\n      gl_FragColor = vec4(u_diffuse.rgb * fakeLight, u_diffuse.a);\n   }\n\\`;`, `64405621038598880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> vs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n   attribute vec4 a_position;\n   attribute vec3 a_normal;\n   \n   uniform mat4 u_projection;\n   uniform mat4 u_view;\n   uniform mat4 u_world;\n   \n   varying vec3 v_normal;\n   \n   void main() {\n      gl_Position = u_projection * u_view * u_world * a_position;\n      v_normal = mat3(u_world) * a_normal;\n   }\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n   precision mediump float;\n   \n   varying vec3 v_normal;\n   \n   uniform vec4 u_diffuse;\n   uniform vec3 u_lightDirection;\n   \n   void main () {\n      vec3 normal = normalize(v_normal);\n      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;\n      gl_FragColor = vec4(u_diffuse.rgb * fakeLight, u_diffuse.a);\n   }\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后使用来自码少趣多中的代码加载模型</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60719130537944556000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`async function main() {\n  // 获取 WebGL 渲染上下文\n  /** @type {HTMLCanvasElement} */\n  const canvas = document.querySelector(\'#canvas\');\n  const gl = canvas.getContext(\'webgl\');\n  if (!gl) {\n    return;\n  }\n\n  // ... shaders ...\n\n  // 编译、链接着色器，查找属性和全局变量位置\n  const meshProgramInfo = webglUtils.createProgramInfo(gl, [vs, fs]);\n\n  const data = await loadOBJ(\'resources/models/cube/cube.obj\');\n\n  // 数据是像这样命名的：\n  //\n  // {\n  //   position: [...],\n  //   texcoord: [...],\n  //   normal: [...],\n  // }\n  //\n  // 因为这些数组的名称和顶点着色器中的属性对应，所以我们可以将数据直接传进\n  // 来自“码少趣多”文章中的 \\`createBufferInfoFromArrays\\`。\n\n  // 通过调用 gl.createBuffer, gl.bindBuffer, gl.bufferData 为每个数组创建缓冲\n  const bufferInfo = webglUtils.createBufferInfoFromArrays(gl, data);\n}`, `60719130537944556000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 获取 WebGL 渲染上下文</span>\n  <span class="token comment">/** @type {HTMLCanvasElement} */</span>\n  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'#canvas\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">\'webgl\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>gl<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// ... shaders ...</span>\n\n  <span class="token comment">// 编译、链接着色器，查找属性和全局变量位置</span>\n  <span class="token keyword">const</span> meshProgramInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createProgramInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">[</span>vs<span class="token punctuation">,</span> fs<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadOBJ</span><span class="token punctuation">(</span><span class="token string">\'resources/models/cube/cube.obj\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 数据是像这样命名的：</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// {</span>\n  <span class="token comment">//   position: [...],</span>\n  <span class="token comment">//   texcoord: [...],</span>\n  <span class="token comment">//   normal: [...],</span>\n  <span class="token comment">// }</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// 因为这些数组的名称和顶点着色器中的属性对应，所以我们可以将数据直接传进</span>\n  <span class="token comment">// 来自“码少趣多”文章中的 `createBufferInfoFromArrays`。</span>\n\n  <span class="token comment">// 通过调用 gl.createBuffer, gl.bindBuffer, gl.bufferData 为每个数组创建缓冲</span>\n  <span class="token keyword">const</span> bufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后绘制数据</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58882932165471040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const cameraTarget = [0, 0, 0];\nconst cameraPosition = [0, 0, 4];\nconst zNear = 0.1;\nconst zFar = 50;\n\nfunction degToRad(deg) {\n  return (deg * Math.PI) / 180;\n}\n\nfunction render(time) {\n  time *= 0.001; // 转成秒\n\n  webglUtils.resizeCanvasToDisplaySize(gl.canvas);\n  gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);\n  gl.enable(gl.DEPTH_TEST);\n  gl.enable(gl.CULL_FACE);\n\n  const fieldOfViewRadians = degToRad(60);\n  const aspect = gl.canvas.clientWidth / gl.canvas.clientHeight;\n  const projection = m4.perspective(fieldOfViewRadians, aspect, zNear, zFar);\n\n  const up = [0, 1, 0];\n  // 通过 lookAt 计算 camera 矩阵\n  const camera = m4.lookAt(cameraPosition, cameraTarget, up);\n\n  // 通过 camera 矩阵创建 view 矩阵\n  const view = m4.inverse(camera);\n\n  const sharedUniforms = {\n    u_lightDirection: m4.normalize([-1, 3, 5]),\n    u_view: view,\n    u_projection: projection\n  };\n\n  gl.useProgram(meshProgramInfo.program);\n\n  // 调用 gl.uniform\n  webglUtils.setUniforms(meshProgramInfo, sharedUniforms);\n\n  // 调用 gl.bindBuffer, gl.enableVertexAttribArray, gl.vertexAttribPointer\n  webglUtils.setBuffersAndAttributes(gl, meshProgramInfo, bufferInfo);\n\n  // 调用 gl.uniform\n  webglUtils.setUniforms(meshProgramInfo, {\n    u_world: m4.yRotation(time),\n    u_diffuse: [1, 0.7, 0.5, 1]\n  });\n\n  // 调用 gl.drawArrays or gl.drawElements\n  webglUtils.drawBufferInfo(gl, bufferInfo);\n\n  requestAnimationFrame(render);\n}\nrequestAnimationFrame(render);`, `58882932165471040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> cameraTarget <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> cameraPosition <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> zNear <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> zFar <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">degToRad</span><span class="token punctuation">(</span><span class="token parameter">deg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>deg <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  time <span class="token operator">*=</span> <span class="token number">0.001</span><span class="token punctuation">;</span> <span class="token comment">// 转成秒</span>\n\n  webglUtils<span class="token punctuation">.</span><span class="token function">resizeCanvasToDisplaySize</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">DEPTH_TEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">CULL_FACE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> fieldOfViewRadians <span class="token operator">=</span> <span class="token function">degToRad</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> aspect <span class="token operator">=</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientWidth <span class="token operator">/</span> gl<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> projection <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">perspective</span><span class="token punctuation">(</span>fieldOfViewRadians<span class="token punctuation">,</span> aspect<span class="token punctuation">,</span> zNear<span class="token punctuation">,</span> zFar<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> up <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token comment">// 通过 lookAt 计算 camera 矩阵</span>\n  <span class="token keyword">const</span> camera <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span>cameraPosition<span class="token punctuation">,</span> cameraTarget<span class="token punctuation">,</span> up<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 通过 camera 矩阵创建 view 矩阵</span>\n  <span class="token keyword">const</span> view <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span>camera<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> sharedUniforms <span class="token operator">=</span> <span class="token punctuation">{</span>\n    u_lightDirection<span class="token punctuation">:</span> m4<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    u_view<span class="token punctuation">:</span> view<span class="token punctuation">,</span>\n    u_projection<span class="token punctuation">:</span> projection\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>meshProgramInfo<span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 调用 gl.uniform</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>meshProgramInfo<span class="token punctuation">,</span> sharedUniforms<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 调用 gl.bindBuffer, gl.enableVertexAttribArray, gl.vertexAttribPointer</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setBuffersAndAttributes</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> meshProgramInfo<span class="token punctuation">,</span> bufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 调用 gl.uniform</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>meshProgramInfo<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    u_world<span class="token punctuation">:</span> m4<span class="token punctuation">.</span><span class="token function">yRotation</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">,</span>\n    u_diffuse<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 调用 gl.drawArrays or gl.drawElements</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">drawBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> bufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样，我们就能看到模型被加载和绘制。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/5o1eof?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="椅子"><a href="#%E6%A4%85%E5%AD%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>椅子</h2>\n<p>关于未处理 keyword 的信息，它们是什么作用呢？</p>\n<p>usemtl 是这之中最重要的。它指明了后面出现的所有几何体都使用指定的材质。例如，你有一个车辆的模型，你可能会希望车窗是透明的，保险杠是金属反光的。窗是透明的，保险杠是反光的，所以它们需要和车体不一样的绘制方法。usemtl 标签标记了这部分信息。</p>\n<p>因为我们需要单独绘制这些部分，所以我们需要修改代码，每次遇到 usemtl 我们就创建一个新的 webgl 数据集。</p>\n<p>首先，添加代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67063002857497380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseOBJ(text) {\n  // 因为索引是从 1 开始的，所以填充索引为 0 的位置\n  const objPositions = [[0, 0, 0]];\n  const objTexcoords = [[0, 0]];\n  const objNormals = [[0, 0, 0]];\n\n  // 和 \\`f\\` 一样的索引顺序\n  const objVertexData = [objPositions, objTexcoords, objNormals];\n\n  // 和 \\`f\\` 一样的索引顺序\n  let webglVertexData = [\n    [], // 顶点\n    [], // 纹理坐标\n    [] // 法线\n  ];\n\n  const geometries = [];\n  let geometry;\n  let material = \'default\';\n\n  function newGeometry() {\n    // 如果有存在的几何体并且不是空的，销毁\n    if (geometry && geometry.data.position.length) {\n      geometry = undefined;\n    }\n  }\n\n  function setGeometry() {\n    if (!geometry) {\n      const position = [];\n      const texcoord = [];\n      const normal = [];\n      webglVertexData = [position, texcoord, normal];\n      geometry = {\n        material,\n        data: {\n          position,\n          texcoord,\n          normal\n        }\n      };\n      geometries.push(geometry);\n    }\n  }\n\n  // ...\n}`, `67063002857497380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{17-44}"\n              >\n                <span class="gatsby-code-button-language">js{17-44}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 因为索引是从 1 开始的，所以填充索引为 0 的位置</span>\n  <span class="token keyword">const</span> objPositions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> objTexcoords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> objNormals <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 和 `f` 一样的索引顺序</span>\n  <span class="token keyword">const</span> objVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>objPositions<span class="token punctuation">,</span> objTexcoords<span class="token punctuation">,</span> objNormals<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 和 `f` 一样的索引顺序</span>\n  <span class="token keyword">let</span> webglVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 顶点</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 纹理坐标</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 法线</span>\n  <span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> geometries <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">let</span> geometry<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">let</span> material <span class="token operator">=</span> <span class="token string">\'default\'</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">function</span> <span class="token function">newGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">// 如果有存在的几何体并且不是空的，销毁</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>geometry <span class="token operator">&amp;&amp;</span> geometry<span class="token punctuation">.</span>data<span class="token punctuation">.</span>position<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      geometry <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">function</span> <span class="token function">setGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>geometry<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">const</span> position <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">const</span> texcoord <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">const</span> normal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      webglVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>position<span class="token punctuation">,</span> texcoord<span class="token punctuation">,</span> normal<span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      geometry <span class="token operator">=</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        material<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        data<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          position<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">          texcoord<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">          normal</span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      geometries<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>geometry<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接着当我们在处理 keywords 的时候，在合适的地方调用它们，包括添加 o keyword 的函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51508229061125685000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n\nconst keywords = {\n  v(parts) {\n    objPositions.push(parts.map(parseFloat));\n  },\n  vn(parts) {\n    objNormals.push(parts.map(parseFloat));\n  },\n  vt(parts) {\n    objTexcoords.push(parts.map(parseFloat));\n  },\n  f(parts) {\n    setGeometry();\n    const numTriangles = parts.length - 2;\n    for (let tri = 0; tri < numTriangles; ++tri) {\n      addVertex(parts[0]);\n      addVertex(parts[tri + 1]);\n      addVertex(parts[tri + 2]);\n    }\n  },\n  usemtl(parts, unparsedArgs) {\n    material = unparsedArgs;\n    newGeometry();\n  }\n};\n\n// ...`, `51508229061125685000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{14,22-25}"\n              >\n                <span class="gatsby-code-button-language">js{14,22-25}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n\n<span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function">v</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    objPositions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token function">vn</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    objNormals<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token function">vt</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    objTexcoords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">    <span class="token function">setGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>    <span class="token keyword">const</span> numTriangles <span class="token operator">=</span> parts<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> tri <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> tri <span class="token operator">&lt;</span> numTriangles<span class="token punctuation">;</span> <span class="token operator">++</span>tri<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">addVertex</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">addVertex</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span>tri <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">addVertex</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span>tri <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  <span class="token function">usemtl</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    material <span class="token operator">=</span> unparsedArgs<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token function">newGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>usemtl 不是必要的，如果在文件中没有 usemtl，我们想要有默认的几何体。所以在 f 函数中我们调用了 setGeometry 来创建。</p>\n<p>最后我们返回 geometries 对象数组，每个对象包含 name 和 data。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63740304411363560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\n\n// return {\n//   position: webglVertexData[0],\n//   texcoord: webglVertexData[1],\n//   normal: webglVertexData[2]\n// };\nreturn geometries;`, `63740304411363560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n\n<span class="token comment">// return {</span>\n<span class="token comment">//   position: webglVertexData[0],</span>\n<span class="token comment">//   texcoord: webglVertexData[1],</span>\n<span class="token comment">//   normal: webglVertexData[2]</span>\n<span class="token comment">// };</span>\n<span class="token keyword">return</span> geometries<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同时，我们需要处理纹理坐标或法线缺失的情况。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67175669229469090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 移除空数组\nfor (const geometry of geometries) {\n  geometry.data = Object.fromEntries(Object.entries(geometry.data).filter(([, array]) => array.length > 0));\n}\n\nreturn {\n  materialLibs,\n  geometries\n};`, `67175669229469090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1-4}"\n              >\n                <span class="gatsby-code-button-language">js{1-4}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token comment">// 移除空数组</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> geometry <span class="token keyword">of</span> geometries<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  geometry<span class="token punctuation">.</span>data <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">fromEntries</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>geometry<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span><span class="token punctuation">,</span> array<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> array<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span></span>\n<span class="token keyword">return</span> <span class="token punctuation">{</span>\n  materialLibs<span class="token punctuation">,</span>\n  geometries\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>让我们继续 keywords，根据官方规范，mtllib 指定了包含材质信息的独立的一个或多个文件。不幸的是，在实际应用中，文件名中可以包含空格，但 .obj 格式中并没有提供逃逸字符来使用空格或引号。理想情况应该使用能解决这些问题的、良好定义的格式，比如 json、xml 或 yaml 等，但 .obj 格式诞生的比它们都早。</p>\n<p>稍后我们在处理加载文件。先让我们把它加到加载器里以便之后可以使用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50346118238412910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseOBJ(text) {\n  // ...\n  const materialLibs = [];\n\n  // ...\n\n  const keywords = {\n    // ...\n    mtllib(parts, unparsedArgs) {\n      materialLibs.push(unparsedArgs);\n    }\n    // ...\n  };\n\n  // return geometries;\n  return {\n    materialLibs,\n    geometries\n  };\n}`, `50346118238412910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3,9-11,15-19}"\n              >\n                <span class="gatsby-code-button-language">js{3,9-11,15-19}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> materialLibs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// ...</span>\n\n  <span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token comment">// ...</span>\n<span class="gatsby-highlight-code-line">    <span class="token function">mtllib</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      materialLibs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>unparsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span>    <span class="token comment">// ...</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// return geometries;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    materialLibs<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    geometries</span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>o 指定表明了接下来的条目属于命名为 “object” 的对象。但我们并不清楚如何使用它。文件中能只包含 o 而没有 usemtl 吗？先假设可以。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13909216880310660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseOBJ(text) {\n  // ...\n  let material = \'default\';\n  let object = \'default\';\n\n  // ...\n\n  function setGeometry() {\n    if (!geometry) {\n      const position = [];\n      const texcoord = [];\n      const normal = [];\n      webglVertexData = [position, texcoord, normal];\n      geometry = {\n        object,\n        material,\n        data: {\n          position,\n          texcoord,\n          normal\n        }\n      };\n      geometries.push(geometry);\n    }\n  }\n\n  const keywords = {\n    // ...\n    o(parts, unparsedArgs) {\n      object = unparsedArgs;\n      newGeometry();\n    }\n    // ...\n  };\n}`, `13909216880310660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4,15,29-32}"\n              >\n                <span class="gatsby-code-button-language">js{4,15,29-32}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n  <span class="token keyword">let</span> material <span class="token operator">=</span> <span class="token string">\'default\'</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">let</span> object <span class="token operator">=</span> <span class="token string">\'default\'</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// ...</span>\n\n  <span class="token keyword">function</span> <span class="token function">setGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>geometry<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> position <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> texcoord <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> normal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      webglVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>position<span class="token punctuation">,</span> texcoord<span class="token punctuation">,</span> normal<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      geometry <span class="token operator">=</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">        object<span class="token punctuation">,</span></span>        material<span class="token punctuation">,</span>\n        data<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n          position<span class="token punctuation">,</span>\n          texcoord<span class="token punctuation">,</span>\n          normal\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      geometries<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>geometry<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token comment">// ...</span>\n<span class="gatsby-highlight-code-line">    <span class="token function">o</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      object <span class="token operator">=</span> unparsedArgs<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      <span class="token function">newGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span>    <span class="token comment">// ...</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>s 指定了一个 smoothing group。我觉得这是我们可以忽略的。它们通常在建模程序中用来自动生成顶点法线。顶点法线的计算，需要先计算每个面的法线，而每个面的法线可以很容易使用叉乘得到，这部分已经在三维相机中提到了。对于任意顶点，我们可以对该顶点所在的面取均值。但是有时我们想要一条边时，我们需要能够告诉程序忽略一些面。Smoothing groups 让我们指定计算顶点法线时哪些面需要被包含。关于如何计算几何体的顶点法线，可以看 <code class="language-text">WebGL 三维几何加工</code> 作为例子。</p>\n<p>在我们的例子中，我们先忽略它。假设大部分 .obj 文件内部都包含法线，所以一般不需要 smoothing groups。一般在模型库中才会有它，以便你想要编辑或重新生成法线。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92615958248399750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const noop = () => {};\n\nconst keywords = {\n  // ...\n  s: noop\n  // ...\n};`, `92615958248399750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1,5}"\n              >\n                <span class="gatsby-code-button-language">js{1,5}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> <span class="token function-variable function">noop</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>\n<span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n<span class="gatsby-highlight-code-line">  s<span class="token punctuation">:</span> noop</span>  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>目前为止我们还剩一个 keyword：g 代表组 (group)。通常它只是一些元数据。Objects 可以存在于多个 group 中。因为它会出现在我们接下来的文件中，所以我们先添加支持代码，尽管现在并不使用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6290879521448933000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseOBJ(text) {\n  // ...\n  let groups = [\'default\'];\n  // ...\n  function setGeometry() {\n    if (!geometry) {\n      const position = [];\n      const texcoord = [];\n      const normal = [];\n      webglVertexData = [position, texcoord, normal];\n      geometry = {\n        object,\n        groups,\n        material,\n        data: {\n          position,\n          texcoord,\n          normal\n        }\n      };\n      geometries.push(geometry);\n    }\n  }\n\n  // ...\n\n  const keywords = {\n    // ...\n    g(parts) {\n      groups = parts;\n      newGeometry();\n    }\n    // ...\n  };\n}`, `6290879521448933000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3,13,29-32}"\n              >\n                <span class="gatsby-code-button-language">js{3,13,29-32}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">let</span> groups <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'default\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>  <span class="token comment">// ...</span>\n  <span class="token keyword">function</span> <span class="token function">setGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>geometry<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> position <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> texcoord <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> normal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      webglVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>position<span class="token punctuation">,</span> texcoord<span class="token punctuation">,</span> normal<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      geometry <span class="token operator">=</span> <span class="token punctuation">{</span>\n        object<span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">        groups<span class="token punctuation">,</span></span>        material<span class="token punctuation">,</span>\n        data<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n          position<span class="token punctuation">,</span>\n          texcoord<span class="token punctuation">,</span>\n          normal\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      geometries<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>geometry<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// ...</span>\n\n  <span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token comment">// ...</span>\n<span class="gatsby-highlight-code-line">    <span class="token function">g</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      groups <span class="token operator">=</span> parts<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      <span class="token function">newGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span>    <span class="token comment">// ...</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在我们创建了多个几何体的集合，我们需要改变我们的初始化代码来为每一个几何体创建 WebGLBuffers。同时我们也会创建一个随机的颜色，这样就能方便地分辨不同的部分。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47876021701687140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// const response = await fetch(\'resources/models/cube/cube.obj\');\nconst response = await fetch(\'resources/models/chair/chair.obj\');\nconst text = await response.text();\n// const data = parseOBJ(text);\nconst obj = parseOBJ(text);\n\nconst parts = obj.geometries.map(({ data }) => {\n  // 数据是像这样命名的：\n  //\n  // {\n  //   position: [...],\n  //   texcoord: [...],\n  //   normal: [...],\n  // }\n  //\n  // 因为这些数组的名称和顶点着色器中的属性对应，所以我们可以将数据直接传进\n  // 来自“码少趣多”文章中的 \\`createBufferInfoFromArrays\\`。\n\n  // 通过调用 gl.createBuffer, gl.bindBuffer, gl.bufferData 为每个数组创建缓冲\n  const bufferInfo = webglUtils.createBufferInfoFromArrays(gl, data);\n  return {\n    material: {\n      u_diffuse: [Math.random(), Math.random(), Math.random(), 1]\n    },\n    bufferInfo\n  };\n});`, `47876021701687140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1-2,4-5,7,21-26}"\n              >\n                <span class="gatsby-code-button-language">js{1-2,4-5,7,21-26}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token comment">// const response = await fetch(\'resources/models/cube/cube.obj\');</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">\'resources/models/chair/chair.obj\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token keyword">const</span> text <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token comment">// const data = parseOBJ(text);</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> parts <span class="token operator">=</span> obj<span class="token punctuation">.</span>geometries<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>  <span class="token comment">// 数据是像这样命名的：</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// {</span>\n  <span class="token comment">//   position: [...],</span>\n  <span class="token comment">//   texcoord: [...],</span>\n  <span class="token comment">//   normal: [...],</span>\n  <span class="token comment">// }</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// 因为这些数组的名称和顶点着色器中的属性对应，所以我们可以将数据直接传进</span>\n  <span class="token comment">// 来自“码少趣多”文章中的 `createBufferInfoFromArrays`。</span>\n\n  <span class="token comment">// 通过调用 gl.createBuffer, gl.bindBuffer, gl.bufferData 为每个数组创建缓冲</span>\n  <span class="token keyword">const</span> bufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    material<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      u_diffuse<span class="token punctuation">:</span> <span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    bufferInfo</span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们从加载一个立方体换成了椅子</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-06-28-14-35-39-34d7a0d3d4db7f20af8f8cf2385044bb-2c25a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 55.86283185840708%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAACYUlEQVQozx2PyW7TUBiF/S4sQEKitI2oOiRtMzRp0oxN3DRxBidx4jnX9vV4bV8ncUppC6itkBCbSkgIsUas2cCGF4Bn4ClwkL7Nf36dc3SIZDJdLldbLWpIj7gJL4tTFWhQgaaqRxgK1ICmyEASpOg7HDBUq1OvNfK5Qnw3QTTPWpEk8pKmQNu0PcfDKFh6Qfv6LrO4sr1gjlzPQa5p29CEQJN4iRmOo4hquUaMRyyQFcuwfeTP/XkYhJd+gF7f5T5/3Xz5trm4vPD8mY/nHg5cz7OcKEKVFW7MdakeIYvA1C2M/BDPl7MwnC2Wrmvd3J68e1gHes7BMwdhB82QN3P9ld92LGio0pRlxkS0EJkoQHjhzxY4iBqwYeLwIn51/wiYO8s3ZmQwDDcSLRvbyLeRY5i6ooosTyiy6uhWJGHkRg2eaTmqaphW5vr+qRXEwxt6MJJo2oLQ1jT3f4oNdW0KRJYjJE6EQLGgjqBhQ2gAYIFpj6Iqi+vDV7fl9x97338xULcE3gCKqazQp1MgiOyIIRh6IEzY6FAlSZNElec0kafJeuHDp/S3H4Wff0q//7bDS5E6lydjhecVQZAmLDsc9akO0aw3+u0O0+uzA5of9CNYusdR5wJenj98qTnBbr4Y29hIx3dPC8ddssF0e8NOp3PWbFRrxHEmWy2WzqrVdqPeJVf0yHq7VuFHTLdBAkHeicWePXm8tbGWTx2QpZPWaY2sVCqFfDaVJmLr64md7fR+4jh5WMykSkcrKkfpai6792KzXjyJOrP7e4XUQSV3VM5m8qlkKpGIb29tPl/7B5clDsgEWto8AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 06 28 14 35 39" title="" data-src="/static/2022-06-28-14-35-39-34d7a0d3d4db7f20af8f8cf2385044bb-fee1c.png" data-srcset="/static/2022-06-28-14-35-39-34d7a0d3d4db7f20af8f8cf2385044bb-a67b7.png 200w,\n/static/2022-06-28-14-35-39-34d7a0d3d4db7f20af8f8cf2385044bb-0b187.png 400w,\n/static/2022-06-28-14-35-39-34d7a0d3d4db7f20af8f8cf2385044bb-fee1c.png 800w,\n/static/2022-06-28-14-35-39-34d7a0d3d4db7f20af8f8cf2385044bb-2c25a.png 904w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>要渲染，我们只需要循环绘制每个部分</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66938552405599715000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function render(time) {\n  // ...\n\n  gl.useProgram(meshProgramInfo.program);\n\n  // 调用 gl.uniform\n  webglUtils.setUniforms(meshProgramInfo, sharedUniforms);\n\n  // 对整个空间矩阵进行一次计算\n  const u_world = m4.yRotation(time);\n\n  for (const { bufferInfo, material } of parts) {\n    // 调用 gl.bindBuffer, gl.enableVertexAttribArray, gl.vertexAttribPointer\n    webglUtils.setBuffersAndAttributes(gl, meshProgramInfo, bufferInfo);\n    // 调用 gl.uniform\n    webglUtils.setUniforms(meshProgramInfo, {\n      // u_world: m4.yRotation(time),\n      // u_diffuse: [1, 0.7, 0.5, 1],\n      u_world,\n      u_diffuse: material.u_diffuse\n    });\n    // 调用 gl.drawArrays or gl.drawElements\n    webglUtils.drawBufferInfo(gl, bufferInfo);\n  }\n\n  // ...\n}`, `66938552405599715000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{9-10,12,17-20}"\n              >\n                <span class="gatsby-code-button-language">js{9-10,12,17-20}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>meshProgramInfo<span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 调用 gl.uniform</span>\n  webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>meshProgramInfo<span class="token punctuation">,</span> sharedUniforms<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 对整个空间矩阵进行一次计算</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> u_world <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">yRotation</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">{</span> bufferInfo<span class="token punctuation">,</span> material <span class="token punctuation">}</span> <span class="token keyword">of</span> parts<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>    <span class="token comment">// 调用 gl.bindBuffer, gl.enableVertexAttribArray, gl.vertexAttribPointer</span>\n    webglUtils<span class="token punctuation">.</span><span class="token function">setBuffersAndAttributes</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> meshProgramInfo<span class="token punctuation">,</span> bufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 调用 gl.uniform</span>\n    webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>meshProgramInfo<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">      <span class="token comment">// u_world: m4.yRotation(time),</span></span><span class="gatsby-highlight-code-line">      <span class="token comment">// u_diffuse: [1, 0.7, 0.5, 1],</span></span><span class="gatsby-highlight-code-line">      u_world<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      u_diffuse<span class="token punctuation">:</span> material<span class="token punctuation">.</span>u_diffuse</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 调用 gl.drawArrays or gl.drawElements</span>\n    webglUtils<span class="token punctuation">.</span><span class="token function">drawBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> bufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/3qq063?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>如果我们试着把物体放中间是不是更好？</p>\n<p>为了把物体放中间我们需要计算物体的范围，即顶点的最小和最大位置。首先我们需要一个函数，计算给定多个位置中的最小和最大位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53828433003107250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function getExtents(positions) {\n  const min = positions.slice(0, 3);\n  const max = positions.slice(0, 3);\n  for (let i = 3; i < positions.length; i += 3) {\n    for (let j = 0; j < 3; ++j) {\n      const v = positions[i + j];\n      min[j] = Math.min(v, min[j]);\n      max[j] = Math.max(v, max[j]);\n    }\n  }\n  return { min, max };\n}`, `53828433003107250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getExtents</span><span class="token punctuation">(</span><span class="token parameter">positions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> min <span class="token operator">=</span> positions<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> max <span class="token operator">=</span> positions<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> positions<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> v <span class="token operator">=</span> positions<span class="token punctuation">[</span>i <span class="token operator">+</span> j<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      min<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> min<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      max<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> max<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span> min<span class="token punctuation">,</span> max <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后我们遍历几何体的每个部分，并且得到对应的范围</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50246183832264830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function getGeometriesExtents(geometries) {\n  return geometries.reduce(\n    ({ min, max }, { data }) => {\n      const minMax = getExtents(data.position);\n      return {\n        min: min.map((min, ndx) => Math.min(minMax.min[ndx], min)),\n        max: max.map((max, ndx) => Math.max(minMax.max[ndx], max))\n      };\n    },\n    {\n      min: Array(3).fill(Number.POSITIVE_INFINITY),\n      max: Array(3).fill(Number.NEGATIVE_INFINITY)\n    }\n  );\n}`, `50246183832264830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getGeometriesExtents</span><span class="token punctuation">(</span><span class="token parameter">geometries</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> geometries<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>\n    <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> min<span class="token punctuation">,</span> max <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> minMax <span class="token operator">=</span> <span class="token function">getExtents</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> <span class="token punctuation">{</span>\n        min<span class="token punctuation">:</span> min<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">min<span class="token punctuation">,</span> ndx</span><span class="token punctuation">)</span> <span class="token operator">=></span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>minMax<span class="token punctuation">.</span>min<span class="token punctuation">[</span>ndx<span class="token punctuation">]</span><span class="token punctuation">,</span> min<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        max<span class="token punctuation">:</span> max<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">max<span class="token punctuation">,</span> ndx</span><span class="token punctuation">)</span> <span class="token operator">=></span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>minMax<span class="token punctuation">.</span>max<span class="token punctuation">[</span>ndx<span class="token punctuation">]</span><span class="token punctuation">,</span> max<span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      min<span class="token punctuation">:</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token constant">POSITIVE_INFINITY</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      max<span class="token punctuation">:</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token constant">NEGATIVE_INFINITY</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接着，我们需要计算物体的平移距离，以便能将它的中心放在原点，同时计算原点和 camera 的距离，保证能完全看到物体。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41573877237179180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// const cameraTarget = [0, 0, 0];\n// const cameraPosition = [0, 0, 4];\n// const zNear = 0.1;\n// const zFar = 50;\nconst extents = getGeometriesExtents(obj.geometries);\nconst range = m4.subtractVectors(extents.max, extents.min);\n// 移动物体的距离，使得其中心在原点\nconst objOffset = m4.scaleVector(m4.addVectors(extents.min, m4.scaleVector(range, 0.5)), -1);\nconst cameraTarget = [0, 0, 0];\n// 计算移动 camera 的距离，以便我们能完全看到物体\nconst radius = m4.length(range) * 1.2;\nconst cameraPosition = m4.addVectors(cameraTarget, [0, 0, radius]);\n// 设置合适于物体大小的 zNear 和 zFar 值\nconst zNear = radius / 100;\nconst zFar = radius * 3;`, `41573877237179180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// const cameraTarget = [0, 0, 0];</span>\n<span class="token comment">// const cameraPosition = [0, 0, 4];</span>\n<span class="token comment">// const zNear = 0.1;</span>\n<span class="token comment">// const zFar = 50;</span>\n<span class="token keyword">const</span> extents <span class="token operator">=</span> <span class="token function">getGeometriesExtents</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>geometries<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> range <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">subtractVectors</span><span class="token punctuation">(</span>extents<span class="token punctuation">.</span>max<span class="token punctuation">,</span> extents<span class="token punctuation">.</span>min<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 移动物体的距离，使得其中心在原点</span>\n<span class="token keyword">const</span> objOffset <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">scaleVector</span><span class="token punctuation">(</span>m4<span class="token punctuation">.</span><span class="token function">addVectors</span><span class="token punctuation">(</span>extents<span class="token punctuation">.</span>min<span class="token punctuation">,</span> m4<span class="token punctuation">.</span><span class="token function">scaleVector</span><span class="token punctuation">(</span>range<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> cameraTarget <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token comment">// 计算移动 camera 的距离，以便我们能完全看到物体</span>\n<span class="token keyword">const</span> radius <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.2</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> cameraPosition <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">addVectors</span><span class="token punctuation">(</span>cameraTarget<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> radius<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 设置合适于物体大小的 zNear 和 zFar 值</span>\n<span class="token keyword">const</span> zNear <span class="token operator">=</span> radius <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> zFar <span class="token operator">=</span> radius <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面，我们也设置了适合显示物体的 zNear 和 zFar 值。</p>\n<p>只需要使用 objOffset 来将物体平移到原点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40358001267828800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 将整个空间矩阵重新计算一次\nconst u_world = m4.yRotation(time);\nlet u_world = m4.yRotation(time);\nu_world = m4.translate(u_world, ...objOffset);`, `40358001267828800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 将整个空间矩阵重新计算一次</span>\n<span class="token keyword">const</span> u_world <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">yRotation</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> u_world <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">yRotation</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>\nu_world <span class="token operator">=</span> m4<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>u_world<span class="token punctuation">,</span> <span class="token operator">...</span>objOffset<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/zbrpfw?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="书"><a href="#%E4%B9%A6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>书</h2>\n<p>有些非标准的 .obj 文件包含了顶点的颜色值，它们将额外的值放在了每个顶点位置的后面</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50169998423012310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 标准\nv <x> <y> <z>\n// 非标准\nv <x> <y> <z> <red> <green> <blue>`, `50169998423012310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">// 标准\nv &lt;x&gt; &lt;y&gt; &lt;z&gt;\n// 非标准\nv &lt;x&gt; &lt;y&gt; &lt;z&gt; &lt;red&gt; &lt;green&gt; &lt;blue&gt;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>由 <a href="https://sketchfab.com/homkahom0" target="_blank" rel="nofollow noreferrer noopener">Oleaf</a> 创建的 <a href="https://sketchfab.com/3d-models/book-vertex-chameleon-study-51b0b3bdcd844a9e951a9ede6f192da8" target="_blank" rel="nofollow noreferrer noopener">Book - Vertex chameleon study by CC-BY-NC</a> 使用了顶点颜色。</p>\n<p>让我们看看能不能添加代码来支持显示顶点颜色。</p>\n<p>我们需要在有顶点位置、法线和纹理坐标的地方添加一些代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47281844757767070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseOBJ(text) {\n  // 因为索引是从 1 开始的，所以填充索引为 0 的位置\n  const objPositions = [[0, 0, 0]];\n  const objTexcoords = [[0, 0]];\n  const objNormals = [[0, 0, 0]];\n  const objColors = [[0, 0, 0]];\n\n  // 和 \\`f\\` 一样的索引顺序\n  const objVertexData = [objPositions, objTexcoords, objNormals, objColors];\n\n  // 和 \\`f\\` 一样的索引顺序\n  let webglVertexData = [\n    [], // 顶点\n    [], // 纹理坐标\n    [], // 法线\n    [] // 颜色\n  ];\n\n  // ...\n\n  function setGeometry() {\n    if (!geometry) {\n      const position = [];\n      const texcoord = [];\n      const normal = [];\n      const color = [];\n      webglVertexData = [position, texcoord, normal, color];\n      geometry = {\n        object,\n        groups,\n        material,\n        data: {\n          position,\n          texcoord,\n          normal,\n          color\n        }\n      };\n      geometries.push(geometry);\n    }\n  }\n}`, `47281844757767070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{6,9,16,26-27,36}"\n              >\n                <span class="gatsby-code-button-language">js{6,9,16,26-27,36}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 因为索引是从 1 开始的，所以填充索引为 0 的位置</span>\n  <span class="token keyword">const</span> objPositions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> objTexcoords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> objNormals <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> objColors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// 和 `f` 一样的索引顺序</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> objVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>objPositions<span class="token punctuation">,</span> objTexcoords<span class="token punctuation">,</span> objNormals<span class="token punctuation">,</span> objColors<span class="token punctuation">]</span><span class="token punctuation">;</span></span>\n  <span class="token comment">// 和 `f` 一样的索引顺序</span>\n  <span class="token keyword">let</span> webglVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 顶点</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 纹理坐标</span>\n    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 法线</span>\n<span class="gatsby-highlight-code-line">    <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 颜色</span></span>  <span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n\n  <span class="token keyword">function</span> <span class="token function">setGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>geometry<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> position <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> texcoord <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> normal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">      <span class="token keyword">const</span> color <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      webglVertexData <span class="token operator">=</span> <span class="token punctuation">[</span>position<span class="token punctuation">,</span> texcoord<span class="token punctuation">,</span> normal<span class="token punctuation">,</span> color<span class="token punctuation">]</span><span class="token punctuation">;</span></span>      geometry <span class="token operator">=</span> <span class="token punctuation">{</span>\n        object<span class="token punctuation">,</span>\n        groups<span class="token punctuation">,</span>\n        material<span class="token punctuation">,</span>\n        data<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n          position<span class="token punctuation">,</span>\n          texcoord<span class="token punctuation">,</span>\n          normal<span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">          color</span>        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      geometries<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>geometry<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这使得我们的代码有一点不通用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55295820267477120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const keywords = {\n  v(parts) {\n    // objPositions.push(parts.map(parseFloat));\n    // 如果超过 3 个值，就是顶点颜色\n    if (parts.length > 3) {\n      objPositions.push(parts.slice(0, 3).map(parseFloat));\n      objColors.push(parts.slice(3).map(parseFloat));\n    } else {\n      objPositions.push(parts.map(parseFloat));\n    }\n  }\n  // ...\n};`, `55295820267477120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3-10}"\n              >\n                <span class="gatsby-code-button-language">js{3-10}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function">v</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">    <span class="token comment">// objPositions.push(parts.map(parseFloat));</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">// 如果超过 3 个值，就是顶点颜色</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>parts<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      objPositions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      objColors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      objPositions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span>  <span class="token punctuation">}</span>\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后当我们读取到 f 面的时候，调用 addVertex，我们需要获取顶点的颜色</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60685294836227736000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function addVertex(vert) {\n  const ptn = vert.split(\'/\');\n  ptn.forEach((objIndexStr, i) => {\n    if (!objIndexStr) {\n      return;\n    }\n    const objIndex = parseInt(objIndexStr);\n    const index = objIndex + (objIndex >= 0 ? 0 : objVertexData[i].length);\n    webglVertexData[i].push(...objVertexData[i][index]);\n    // 如果这是位置索引并且解析到了颜色值，将顶点的颜色值复制到 webgl 顶点的颜色中\n    if (i === 0 && objColors.length > 1) {\n      geometry.data.color.push(...objColors[index]);\n    }\n  });\n}`, `60685294836227736000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{10-13}"\n              >\n                <span class="gatsby-code-button-language">js{10-13}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">addVertex</span><span class="token punctuation">(</span><span class="token parameter">vert</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> ptn <span class="token operator">=</span> vert<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  ptn<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">objIndexStr<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>objIndexStr<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> objIndex <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>objIndexStr<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> index <span class="token operator">=</span> objIndex <span class="token operator">+</span> <span class="token punctuation">(</span>objIndex <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> objVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    webglVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>objVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">    <span class="token comment">// 如果这是位置索引并且解析到了颜色值，将顶点的颜色值复制到 webgl 顶点的颜色中</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> objColors<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      geometry<span class="token punctuation">.</span>data<span class="token punctuation">.</span>color<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>objColors<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接着，我们需要更改我们的着色器来使用顶点颜色</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99496934918516670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const vs = \\`\n   attribute vec4 a_position;\n   attribute vec3 a_normal;\n   attribute vec4 a_color;\n   \n   uniform mat4 u_projection;\n   uniform mat4 u_view;\n   uniform mat4 u_world;\n   \n   varying vec3 v_normal;\n   varying vec4 v_color;\n   \n   void main() {\n      gl_Position = u_projection * u_view * u_world * a_position;\n      v_normal = mat3(u_world) * a_normal;\n      v_color = a_color;\n   }\n\\`;\n\nconst fs = \\`\n   precision mediump float;\n   \n   varying vec3 v_normal;\n   varying vec4 v_color;\n   \n   uniform vec4 u_diffuse;\n   uniform vec3 u_lightDirection;\n   \n   void main () {\n      vec3 normal = normalize(v_normal);\n      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;\n      // gl_FragColor = vec4(u_diffuse.rgb * fakeLight, u_diffuse.a);\n      vec4 diffuse = u_diffuse * v_color;\n      gl_FragColor = vec4(diffuse.rgb * fakeLight, diffuse.a);\n   }\n\\`;`, `99496934918516670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4,11,16,24,32-34}"\n              >\n                <span class="gatsby-code-button-language">js{4,11,16,24,32-34}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> vs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   attribute vec4 a_position;</span>\n<span class="token string">   attribute vec3 a_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   attribute vec4 a_color;</span></span><span class="token string">   </span>\n<span class="token string">   uniform mat4 u_projection;</span>\n<span class="token string">   uniform mat4 u_view;</span>\n<span class="token string">   uniform mat4 u_world;</span>\n<span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   varying vec4 v_color;</span></span><span class="token string">   </span>\n<span class="token string">   void main() {</span>\n<span class="token string">      gl_Position = u_projection * u_view * u_world * a_position;</span>\n<span class="token string">      v_normal = mat3(u_world) * a_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">      v_color = a_color;</span></span><span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   precision mediump float;</span>\n<span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   varying vec4 v_color;</span></span><span class="token string">   </span>\n<span class="token string">   uniform vec4 u_diffuse;</span>\n<span class="token string">   uniform vec3 u_lightDirection;</span>\n<span class="token string">   </span>\n<span class="token string">   void main () {</span>\n<span class="token string">      vec3 normal = normalize(v_normal);</span>\n<span class="token string">      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">      // gl_FragColor = vec4(u_diffuse.rgb * fakeLight, u_diffuse.a);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      vec4 diffuse = u_diffuse * v_color;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      gl_FragColor = vec4(diffuse.rgb * fakeLight, diffuse.a);</span></span><span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>就如上面提到的，我不确定这个非标准版本的 .obj 文件能否在每个顶点颜色中包含 alpha 值。我们的 helper library 根据我们传入的数据自动创建缓冲区。它假设每个元素有多少个组成部分。对于名字中包含 position 或 normal 的，默认每个元素包含 3 个组成部分。对于名字中包含 texcoord 的，默认每个元素 2 个组成部分。其它的每个元素默认 4 个组成部分。这样的话，如果我们的颜色仅包含 r、g、b，每个元素三个组成部分，我们需要传参给它。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27492011835429930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const parts = obj.geometries.map(({ data }) => {\n  // 数据是像这样命名的：\n  //\n  // {\n  //   position: [...],\n  //   texcoord: [...],\n  //   normal: [...],\n  // }\n  //\n  // 因为这些数组的名称和顶点着色器中的属性对应，所以我们可以将数据直接传进\n  // 来自“码少趣多”文章中的 \\`createBufferInfoFromArrays\\`。\n\n  if (data.position.length === data.color.length) {\n    // 是 3，helper library 默认是 4 所以我们需要告诉程序只有 3 个\n    data.color = { numComponents: 3, data: data.color };\n  }\n\n  // 通过调用 gl.createBuffer, gl.bindBuffer, gl.bufferData 为每个数组创建缓冲\n  const bufferInfo = webglUtils.createBufferInfoFromArrays(gl, data);\n  return {\n    material: {\n      u_diffuse: [Math.random(), Math.random(), Math.random(), 1]\n    },\n    bufferInfo\n  };\n});`, `27492011835429930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{13-16}"\n              >\n                <span class="gatsby-code-button-language">js{13-16}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> parts <span class="token operator">=</span> obj<span class="token punctuation">.</span>geometries<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 数据是像这样命名的：</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// {</span>\n  <span class="token comment">//   position: [...],</span>\n  <span class="token comment">//   texcoord: [...],</span>\n  <span class="token comment">//   normal: [...],</span>\n  <span class="token comment">// }</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// 因为这些数组的名称和顶点着色器中的属性对应，所以我们可以将数据直接传进</span>\n  <span class="token comment">// 来自“码少趣多”文章中的 `createBufferInfoFromArrays`。</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>position<span class="token punctuation">.</span>length <span class="token operator">===</span> data<span class="token punctuation">.</span>color<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">// 是 3，helper library 默认是 4 所以我们需要告诉程序只有 3 个</span></span><span class="gatsby-highlight-code-line">    data<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token punctuation">{</span> numComponents<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> data<span class="token punctuation">.</span>color <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  <span class="token comment">// 通过调用 gl.createBuffer, gl.bindBuffer, gl.bufferData 为每个数组创建缓冲</span>\n  <span class="token keyword">const</span> bufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    material<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      u_diffuse<span class="token punctuation">:</span> <span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    bufferInfo\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们也希望能够处理更常见的没有顶点颜色的情况。在 WebGL 基础概念和 WebGL 属性中我们提到了属性通常从缓冲中获取值。但我们也可以将属性设置成常量。没有的值使用默认常量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68899126523885855000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gl.disableVertexAttribArray(someAttributeLocation); // 使用常量\nconst value = [1, 2, 3, 4];\ngl.vertexAttrib4fv(someAttributeLocation, value); // 使用给定的值`, `68899126523885855000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gl<span class="token punctuation">.</span><span class="token function">disableVertexAttribArray</span><span class="token punctuation">(</span>someAttributeLocation<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使用常量</span>\n<span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\ngl<span class="token punctuation">.</span><span class="token function">vertexAttrib4fv</span><span class="token punctuation">(</span>someAttributeLocation<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使用给定的值</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>如果将属性的值设为 <code class="language-text">{value:[1, 2, 3, 4]}</code>，我们的 helper library 为我们处理了这种情况。当检查到没有顶点颜色时，默认将顶点颜色属性设置成白色。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34386169060788507000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const parts = obj.geometries.map(({ data }) => {\n  // 数据是像这样命名的：\n  //\n  // {\n  //   position: [...],\n  //   texcoord: [...],\n  //   normal: [...],\n  // }\n  //\n  // 因为这些数组的名称和顶点着色器中的属性对应，所以我们可以将数据直接传进\n  // 来自“码少趣多”文章中的 \\`createBufferInfoFromArrays\\`。\n\n  if (data.color) {\n    if (data.position.length === data.color.length) {\n      // 是 3，helper library 默认是 4 所以我们需要告诉程序只有 3 个\n      data.color = { numComponents: 3, data: data.color };\n    }\n  } else {\n    // 没有顶点颜色，使用白色\n    data.color = { value: [1, 1, 1, 1] };\n  }\n\n  // ...\n});`, `34386169060788507000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{13,18-21}"\n              >\n                <span class="gatsby-code-button-language">js{13,18-21}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> parts <span class="token operator">=</span> obj<span class="token punctuation">.</span>geometries<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 数据是像这样命名的：</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// {</span>\n  <span class="token comment">//   position: [...],</span>\n  <span class="token comment">//   texcoord: [...],</span>\n  <span class="token comment">//   normal: [...],</span>\n  <span class="token comment">// }</span>\n  <span class="token comment">//</span>\n  <span class="token comment">// 因为这些数组的名称和顶点着色器中的属性对应，所以我们可以将数据直接传进</span>\n  <span class="token comment">// 来自“码少趣多”文章中的 `createBufferInfoFromArrays`。</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>color<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>position<span class="token punctuation">.</span>length <span class="token operator">===</span> data<span class="token punctuation">.</span>color<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 是 3，helper library 默认是 4 所以我们需要告诉程序只有 3 个</span>\n      data<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token punctuation">{</span> numComponents<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> data<span class="token punctuation">.</span>color <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">// 没有顶点颜色，使用白色</span></span><span class="gatsby-highlight-code-line">    data<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们也不能使用随机颜色</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98399240791729820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const parts = obj.geometries.map(({ data }) => {\n  // ...\n\n  // 通过调用 gl.createBuffer, gl.bindBuffer, gl.bufferData 为每个数组创建缓冲\n  const bufferInfo = webglUtils.createBufferInfoFromArrays(gl, data);\n  return {\n    material: {\n      // u_diffuse: [Math.random(), Math.random(), Math.random(), 1],\n      u_diffuse: [1, 1, 1, 1]\n    },\n    bufferInfo\n  };\n});`, `98399240791729820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{8-9}"\n              >\n                <span class="gatsby-code-button-language">js{8-9}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> parts <span class="token operator">=</span> obj<span class="token punctuation">.</span>geometries<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 通过调用 gl.createBuffer, gl.bindBuffer, gl.bufferData 为每个数组创建缓冲</span>\n  <span class="token keyword">const</span> bufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    material<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">      <span class="token comment">// u_diffuse: [Math.random(), Math.random(), Math.random(), 1],</span></span><span class="gatsby-highlight-code-line">      u_diffuse<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span></span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    bufferInfo\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样，我们就能带顶点颜色的 .obj 文件了。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/761hg3?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>至于解析和使用材质，看下一篇。</p>\n<h2 id="一些注意点"><a href="#%E4%B8%80%E4%BA%9B%E6%B3%A8%E6%84%8F%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一些注意点</h2>\n<ul>\n<li>\n<p>这个加载器是不完整的</p>\n<p>你可以阅读更多关于 .obj 格式。有大量的功能上面的代码是不支持的。同时，代码也没有经过大量 .obj 文件的测试，所以可能有很多未知的 bug。也就是说，我假设了大多数在线的 .obj 文件只使用了上面提到的功能，所以这部分代码说不定是一个有用的例子。</p>\n</li>\n<li>\n<p>这个加载器没有进行错误检查</p>\n<p>例如：vt 可以有 3 个值而不仅仅是 2 个。3 个值是给 3D 纹理使用的，不普遍所以我没有处理。如果你确实想要用它解析 3D 纹理座标，你需要修改着色器来处理 3D 纹理，修改生成 WebGLBuffers (调用 createBufferInfoFromArrays)的代码，告诉它每个 UV 座标有 3 个组成部分。</p>\n</li>\n<li>\n<p>假设数据是一致的</p>\n<p>我不知道是否会出现同一个文件中一些 f 有 3 个条目而另一些只有 2 个条目会。如果有可能，上面的代码没有处理这种情况。</p>\n<p>这段代码同样假设了所有顶点座标都有 x、y、z。如果出现有些顶点座标有 x、y、z，有些顶点座标只有 x、y，而有些则有 x、y、z、r、g、b，我们需要重构代码。</p>\n</li>\n<li>\n<p>可以将所有数据放进一个缓冲里</p>\n<p>上面的代码将顶点位置、纹理座标、法线放进了不同的缓冲。你也可以将它们交错的放进一个缓冲中：pos, uv, nrm, pos, uv, nrm, … 这样的话就需要改变设置属性的方式。</p>\n<p>更进一步，你甚至可以将所有部分的所有数据放进同一个缓冲里，而不是每个部分、每个类型的数据一个缓冲。</p>\n<p>我不考虑这些因为我觉得它们没有那么重要，同时它们也会使得代码变得复杂。</p>\n</li>\n<li>\n<p>可以重建顶点的索引</p>\n<p>上面的代码将顶点展开放进了三个数组中。我们可以重建顶点的索引。尤其当我们将所有顶点数据放进一个共享的缓冲中，或至少每个类型有一个单独的共享缓冲时，对于每个 f 面，可以将索引转换到一个正数（负数变换到正确的正数），那么对于每个顶点，数据集就变成了一个或多个 id。所以，只要记下 id 到索引的映射关系就能查找到对应的索引。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96027489556937410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const idToIndexMap = {};\nconst webglIndices = [];\n\nfunction addVertex(vert) {\n  const ptn = vert.split(\'/\');\n  // 首先将所有索引转换成正数\n  const indices = ptn.forEach((objIndexStr, i) => {\n     if (!objIndexStr) {\n        return;\n     }\n     const objIndex = parseInt(objIndexStr);\n     return objIndex + (objIndex >= 0 ? 0 : objVertexData[i].length);\n  });\n  // 现在检查已存在的顶点位置、纹理座标、法线组合\n  const id = indices.join(\',\');\n  let vertIndex = idToIndexMap[id];\n  if (!vertIndex) {\n     vertIndex = webglVertexData[0].length / 3;\n     idToIndexMap[id] = vertexIndex;\n     indices.forEach((index, i) => {\n        if (index !== undefined) {\n        webglVertexData[i].push(...objVertexData[i][index]);\n        }\n     })\n  }\n  webglIndices.push(vertexIndex);\n}`, `96027489556937410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> idToIndexMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> webglIndices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">addVertex</span><span class="token punctuation">(</span><span class="token parameter">vert</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> ptn <span class="token operator">=</span> vert<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 首先将所有索引转换成正数</span>\n  <span class="token keyword">const</span> indices <span class="token operator">=</span> ptn<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">objIndexStr<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>objIndexStr<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span><span class="token punctuation">;</span>\n     <span class="token punctuation">}</span>\n     <span class="token keyword">const</span> objIndex <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>objIndexStr<span class="token punctuation">)</span><span class="token punctuation">;</span>\n     <span class="token keyword">return</span> objIndex <span class="token operator">+</span> <span class="token punctuation">(</span>objIndex <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> objVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 现在检查已存在的顶点位置、纹理座标、法线组合</span>\n  <span class="token keyword">const</span> id <span class="token operator">=</span> indices<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\',\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> vertIndex <span class="token operator">=</span> idToIndexMap<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vertIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n     vertIndex <span class="token operator">=</span> webglVertexData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">;</span>\n     idToIndexMap<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> vertexIndex<span class="token punctuation">;</span>\n     indices<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">index<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        webglVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>objVertexData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n     <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n  webglIndices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>vertexIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>或者，如果你觉得重要你可以重排索引。</p>\n</li>\n<li>\n<p>这段代码没有处理只有顶点座标，或只有顶点座标和纹理座标的情况</p>\n<p>这段代码假设法线存在。就像我们在三维几何加工里做的，如果法线不存在，我们可以生成它，考虑到如果我们需要 smoothing group。或者我们也可以不使用也不计算法线的不同着色器。</p>\n</li>\n<li>\n<p>你不应该使用 .obj 文件</p>\n<p>老实说，我认为你不应该使用 .obj 文件。我写这篇文章是作为一个例子。如果你可以从一个文件中获取顶点数据，你可以为任意格式的文件写导入器。</p>\n<p>.obj 文件的问题包括：</p>\n<ul>\n<li>\n<p>不支持光线或视角</p>\n<p>如果你加载大量部件（比如景观中的树、灌木、石头），你不需要视角或光线，这可能没问题。但文件如果提供选项让你能够原样导入作者创建的整个场景会更好。</p>\n</li>\n<li>\n<p>没有层级，没有场景图</p>\n<p>如果你想要导入一辆车，你会希望车轮能够转向，并能够绕着中心点旋转。这对 .obj 文件来说是不可能的，因为 .obj 不包含场景图。更好的文件格式包含这些数据，如果你想要能够旋转的部件、滑动窗户、开门、移动角色的腿等，这会很有用。</p>\n</li>\n<li>\n<p>不支持动画或蒙皮</p>\n<p>相比于其它的，我们更想要蒙皮，但 .obj 并没有蒙皮或者动画相关内容。如果你不需要这些，可能没什么问题。但我更偏向一种能包含更多内容的格式。</p>\n</li>\n<li>\n<p>.obj 不支持更多现代的材质</p>\n<p>材质一般来说针对于特定的引擎，但至少对于一些基于物理的材质渲染各引擎是共通的，据我所知 .obj 文件并不支持。</p>\n</li>\n<li>\n<p>.obj 需要解析</p>\n<p>除非你在写一个通用的查看器让用户上传 .obj 文件，通常最佳的做法是使用一个不太需要解析的文件格式。.gltf 是一种为 WebGL 设计的文件格式。它使用 JSON，你可以轻松地加载。对于二进制数据，它使用能直接加载进 GPU 的格式，一般不需要将数字解析成数组。</p>\n<p>如果你想使用 .obj 文件，最佳实践是先将它转换成其它文件格式，然后在你的页面中使用。</p>\n</li>\n</ul>\n</li>\n</ul>\n<h1 id="webgl-加载带-mtl-的-obj"><a href="#webgl-%E5%8A%A0%E8%BD%BD%E5%B8%A6-mtl-%E7%9A%84-obj" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>WebGL 加载带 Mtl 的 Obj</h1>\n<p>在上一节我们解析了 .obj 文件，在本节让我们解析它的补充文件：.mtl 材质文件。</p>\n<h2 id="椅子-1"><a href="#%E6%A4%85%E5%AD%90-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>椅子</h2>\n<blockquote>\n<p>该 .mtl 解析器不会面面俱到或者完美，也不保证能够处理所有 .mtl 文件。这只是一个练习。如果你使用该程序并遇到问题，下面的链接可能会对你有帮助。</p>\n</blockquote>\n<p>我们加载了我在 <a href="https://sketchfab.com/" target="_blank" rel="nofollow noreferrer noopener">Sketchfab</a> 上找到的，由 haytonm 创建的<a href="https://sketchfab.com/3d-models/chair-aa2acddb218646a59ece132bf95aa558" target="_blank" rel="nofollow noreferrer noopener">椅子</a>。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-06-28-14-35-39-34d7a0d3d4db7f20af8f8cf2385044bb-2c25a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 55.86283185840708%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAACYUlEQVQozx2PyW7TUBiF/S4sQEKitI2oOiRtMzRp0oxN3DRxBidx4jnX9vV4bV8ncUppC6itkBCbSkgIsUas2cCGF4Bn4ClwkL7Nf36dc3SIZDJdLldbLWpIj7gJL4tTFWhQgaaqRxgK1ICmyEASpOg7HDBUq1OvNfK5Qnw3QTTPWpEk8pKmQNu0PcfDKFh6Qfv6LrO4sr1gjlzPQa5p29CEQJN4iRmOo4hquUaMRyyQFcuwfeTP/XkYhJd+gF7f5T5/3Xz5trm4vPD8mY/nHg5cz7OcKEKVFW7MdakeIYvA1C2M/BDPl7MwnC2Wrmvd3J68e1gHes7BMwdhB82QN3P9ld92LGio0pRlxkS0EJkoQHjhzxY4iBqwYeLwIn51/wiYO8s3ZmQwDDcSLRvbyLeRY5i6ooosTyiy6uhWJGHkRg2eaTmqaphW5vr+qRXEwxt6MJJo2oLQ1jT3f4oNdW0KRJYjJE6EQLGgjqBhQ2gAYIFpj6Iqi+vDV7fl9x97338xULcE3gCKqazQp1MgiOyIIRh6IEzY6FAlSZNElec0kafJeuHDp/S3H4Wff0q//7bDS5E6lydjhecVQZAmLDsc9akO0aw3+u0O0+uzA5of9CNYusdR5wJenj98qTnBbr4Y29hIx3dPC8ddssF0e8NOp3PWbFRrxHEmWy2WzqrVdqPeJVf0yHq7VuFHTLdBAkHeicWePXm8tbGWTx2QpZPWaY2sVCqFfDaVJmLr64md7fR+4jh5WMykSkcrKkfpai6792KzXjyJOrP7e4XUQSV3VM5m8qlkKpGIb29tPl/7B5clDsgEWto8AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 06 28 14 35 39" title="" data-src="/static/2022-06-28-14-35-39-34d7a0d3d4db7f20af8f8cf2385044bb-fee1c.png" data-srcset="/static/2022-06-28-14-35-39-34d7a0d3d4db7f20af8f8cf2385044bb-a67b7.png 200w,\n/static/2022-06-28-14-35-39-34d7a0d3d4db7f20af8f8cf2385044bb-0b187.png 400w,\n/static/2022-06-28-14-35-39-34d7a0d3d4db7f20af8f8cf2385044bb-fee1c.png 800w,\n/static/2022-06-28-14-35-39-34d7a0d3d4db7f20af8f8cf2385044bb-2c25a.png 904w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>它有一个相应的 .mtl 文件，看起来是这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94328237556425410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# Blender MTL File: \'None\'\n# Material Count: 11\n\nnewmtl D1blinn1SG\nNs 323.999994\nKa 1.000000 1.000000 1.000000\nKd 0.500000 0.500000 0.500000\nKs 0.500000 0.500000 0.500000\nKe 0.0 0.0 0.0\nNi 1.000000\nd 1.000000\nillum 2\n\nnewmtl D1lambert2SG\nNs 323.999994\nKa 1.000000 1.000000 1.000000\nKd 0.020000 0.020000 0.020000\nKs 0.500000 0.500000 0.500000\nKe 0.0 0.0 0.0\nNi 1.000000\nd 1.000000\nillum 2\n\nnewmtl D1lambert3SG\nNs 323.999994\nKa 1.000000 1.000000 1.000000\nKd 1.000000 1.000000 1.000000\nKs 0.500000 0.500000 0.500000\nKe 0.0 0.0 0.0\nNi 1.000000\nd 1.000000\nillum 2\n\n# ... 更多类似的 8 个材质`, `94328237556425410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="mtl"\n              >\n                <span class="gatsby-code-button-language">mtl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="mtl"><pre style="counter-reset: linenumber NaN" class="language-mtl line-numbers"><code class="language-mtl"># Blender MTL File: &#39;None&#39;\n# Material Count: 11\n\nnewmtl D1blinn1SG\nNs 323.999994\nKa 1.000000 1.000000 1.000000\nKd 0.500000 0.500000 0.500000\nKs 0.500000 0.500000 0.500000\nKe 0.0 0.0 0.0\nNi 1.000000\nd 1.000000\nillum 2\n\nnewmtl D1lambert2SG\nNs 323.999994\nKa 1.000000 1.000000 1.000000\nKd 0.020000 0.020000 0.020000\nKs 0.500000 0.500000 0.500000\nKe 0.0 0.0 0.0\nNi 1.000000\nd 1.000000\nillum 2\n\nnewmtl D1lambert3SG\nNs 323.999994\nKa 1.000000 1.000000 1.000000\nKd 1.000000 1.000000 1.000000\nKs 0.500000 0.500000 0.500000\nKe 0.0 0.0 0.0\nNi 1.000000\nd 1.000000\nillum 2\n\n# ... 更多类似的 8 个材质</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>查看对 <a href="http://paulbourke.net/dataformats/mtl/" target="_blank" rel="nofollow noreferrer noopener">.mtl 文件格式</a>的描述，我们可以看到以关键词 newmtl 和给定名字开头的新材质，下面是该材质的所有设置。每行都以关键词开始，这和 .obj 文件类似，所以我们可以用类似的方法来开始解析。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56233843081159350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseMTL(text) {\n  const materials = {};\n  let material;\n\n  const keywords = {\n    newmtl(parts, unparsedArgs) {\n      material = {};\n      materials[unparsedArgs] = material;\n    }\n  };\n\n  const keywordRE = /(\\w*)(?: )*(.*)/;\n  const lines = text.split(\'\\n\');\n  for (let lineNo = 0; lineNo < lines.length; ++lineNo) {\n    const line = lines[lineNo].trim();\n    if (line === \'\' || line.startsWith(\'#\')) {\n      continue;\n    }\n    const m = keywordRE.exec(line);\n    if (!m) {\n      continue;\n    }\n    const [, keyword, unparsedArgs] = m;\n    const parts = line.split(/\\s+/).slice(1);\n    const handler = keywords[keyword];\n    if (!handler) {\n      console.warn(\'unhandled keyword:\', keyword);\n      continue;\n    }\n    handler(parts, unparsedArgs);\n  }\n\n  return materials;\n}`, `56233843081159350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseMTL</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> materials <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> material<span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token function">newmtl</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n      materials<span class="token punctuation">[</span>unparsedArgs<span class="token punctuation">]</span> <span class="token operator">=</span> material<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> keywordRE <span class="token operator">=</span> <span class="token regex">/(\\w*)(?: )*(.*)/</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> lines <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'\\n\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> lineNo <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> lineNo <span class="token operator">&lt;</span> lines<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>lineNo<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> line <span class="token operator">=</span> lines<span class="token punctuation">[</span>lineNo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>line <span class="token operator">===</span> <span class="token string">\'\'</span> <span class="token operator">||</span> line<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">\'#\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">continue</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> m <span class="token operator">=</span> keywordRE<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">continue</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> keyword<span class="token punctuation">,</span> unparsedArgs<span class="token punctuation">]</span> <span class="token operator">=</span> m<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> parts <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex">/\\s+/</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> handler <span class="token operator">=</span> keywords<span class="token punctuation">[</span>keyword<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">\'unhandled keyword:\'</span><span class="token punctuation">,</span> keyword<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">continue</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token function">handler</span><span class="token punctuation">(</span>parts<span class="token punctuation">,</span> unparsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> materials<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接着，我们只需要为每个关键词添加对应的方法。文档指出：</p>\n<ul>\n<li>Ns 是关于点光源的文章中提到的镜面光泽设置</li>\n<li>Ka 是材质的环境光</li>\n<li>Kd 是散射光，这是在关于点光源的文章中的颜色</li>\n<li>Ks 是镜面光</li>\n<li>Ke 是放射光</li>\n<li>Ni 是光学密度。我们这里不使用</li>\n<li>d 代表“溶解”，代表透明度</li>\n<li>illum 指定了材质的光照模型。文档中列出了 11 种类型。我们先忽略它</li>\n</ul>\n<p>我在犹豫是否要保持这些名字的原样。我想一个数学人喜欢简短的名字。但是大多数代码风格指南都喜欢描述性的名字，所以我决定这么做。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89962134831615720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseMTL(text) {\n  const materials = {};\n  let material;\n\n  const keywords = {\n    newmtl(parts, unparsedArgs) {\n      material = {};\n      materials[unparsedArgs] = material;\n    },\n    Ns(parts) {\n      material.shininess = parseFloat(parts[0]);\n    },\n    Ka(parts) {\n      material.ambient = parts.map(parseFloat);\n    },\n    Kd(parts) {\n      material.diffuse = parts.map(parseFloat);\n    },\n    Ks(parts) {\n      material.specular = parts.map(parseFloat);\n    },\n    Ke(parts) {\n      material.emissive = parts.map(parseFloat);\n    },\n    Ni(parts) {\n      material.opticalDensity = parseFloat(parts[0]);\n    },\n    d(parts) {\n      material.opacity = parseFloat(parts[0]);\n    },\n    illum(parts) {\n      material.illum = parseInt(parts[0]);\n    }\n  };\n\n  //  ...\n\n  return materials;\n}`, `89962134831615720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{10-33}"\n              >\n                <span class="gatsby-code-button-language">js{10-33}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseMTL</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> materials <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> material<span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token function">newmtl</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n      materials<span class="token punctuation">[</span>unparsedArgs<span class="token punctuation">]</span> <span class="token operator">=</span> material<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">    <span class="token function">Ns</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>shininess <span class="token operator">=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">Ka</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>ambient <span class="token operator">=</span> parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">Kd</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>diffuse <span class="token operator">=</span> parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">Ks</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>specular <span class="token operator">=</span> parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">Ke</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>emissive <span class="token operator">=</span> parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">Ni</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>opticalDensity <span class="token operator">=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">d</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>opacity <span class="token operator">=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">illum</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>illum <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">//  ...</span>\n\n  <span class="token keyword">return</span> materials<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我也在犹豫要不要推测每个 .mtl 文件的路径，或者手动指定。我们可以这样做：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57901348942040556000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 伪代码 - 手动指定 .obj 文件和 .mtl 文件的路径\nconst obj = downloadAndParseObj(pathToOBJFile);\nconst materials = downloadAndParseMtl(pathToMTLFile);`, `57901348942040556000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 伪代码 - 手动指定 .obj 文件和 .mtl 文件的路径</span>\n<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">downloadAndParseObj</span><span class="token punctuation">(</span>pathToOBJFile<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> materials <span class="token operator">=</span> <span class="token function">downloadAndParseMtl</span><span class="token punctuation">(</span>pathToMTLFile<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>或者这样:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58351936435496570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 伪代码 - 根据 .obj 文件推测 .mtl 文件的的路径\nconst obj = downloadAndParseObj(pathToOBJFile);\nconst materials = downloadAndParseMtl(pathToOBJFile, obj);`, `58351936435496570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 伪代码 - 根据 .obj 文件推测 .mtl 文件的的路径</span>\n<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">downloadAndParseObj</span><span class="token punctuation">(</span>pathToOBJFile<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> materials <span class="token operator">=</span> <span class="token function">downloadAndParseMtl</span><span class="token punctuation">(</span>pathToOBJFile<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>我选择后者，但是我也不确定是好是坏。根据文档一个 .obj 文件可以包含多个 .mtl 文件的引用。我从没见过这样的例子，但我想文档的作者是这么做的。</p>\n<p>并且我也没有见过 .mtl 文件与 .obj 文件命名不同的。换句话说，如果 .obj 文件是 bananas.obj，那么 .mtl 文件几乎总是 bananas.mtl。</p>\n<p>也就是说，规范指出 .mtl 文件是在 .obj 文件中指定的，所以我决定试着计算 .mtl 文件的路径。</p>\n<p>从上节的代码开始, 我们将 .obj 文件的 URL 提取出来，然后构建 .obj 相关的 .mtl 文件的 URL。最后我们将它们全部加载，连接起来（因为它们都是文本文件），然后传给解析器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96070744815712810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// const response = await fetch(\'resources/models/chair/chair.obj\');\nconst objHref = \'resources/models/chair/chair.obj\';\nconst response = await fetch(objHref);\nconst text = await response.text();\nconst obj = parseOBJ(text);\nconst baseHref = new URL(objHref, window.location.href);\nconst matTexts = await Promise.all(\n  obj.materialLibs.map(async (filename) => {\n    const matHref = new URL(filename, baseHref).href;\n    const response = await fetch(matHref);\n    return await response.text();\n  })\n);\nconst materials = parseMTL(matTexts.join(\'\\n\'));`, `96070744815712810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1-3,6-14}"\n              >\n                <span class="gatsby-code-button-language">js{1-3,6-14}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token comment">// const response = await fetch(\'resources/models/chair/chair.obj\');</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> objHref <span class="token operator">=</span> <span class="token string">\'resources/models/chair/chair.obj\'</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>objHref<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token keyword">const</span> text <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">parseOBJ</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> baseHref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>objHref<span class="token punctuation">,</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> matTexts <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">  obj<span class="token punctuation">.</span>materialLibs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">const</span> matHref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> baseHref<span class="token punctuation">)</span><span class="token punctuation">.</span>href<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>matHref<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">return</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> materials <span class="token operator">=</span> <span class="token function">parseMTL</span><span class="token punctuation">(</span>matTexts<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'\\n\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，我们来使用材质。首先，当我们在设置每个部分的时候，我们需要使用从 .obj 文件中提取出来的材质名称，然后从刚才加载的材质中查找。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87898403504265800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// const parts = obj.geometries.map(({data}) => {\nconst parts = obj.geometries.map(({ material, data }) => {\n  // ...\n\n  // create a buffer for each array by calling\n  // gl.createBuffer, gl.bindBuffer, gl.bufferData\n  const bufferInfo = webglUtils.createBufferInfoFromArrays(gl, data);\n  return {\n    //  material: {\n    //    u_diffuse: [1, 1, 1, 1],\n    //  },\n    material: materials[material],\n    bufferInfo\n  };\n});`, `87898403504265800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1-2,9-12}"\n              >\n                <span class="gatsby-code-button-language">js{1-2,9-12}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token comment">// const parts = obj.geometries.map(({data}) => {</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> parts <span class="token operator">=</span> obj<span class="token punctuation">.</span>geometries<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> material<span class="token punctuation">,</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span>  <span class="token comment">// ...</span>\n\n  <span class="token comment">// create a buffer for each array by calling</span>\n  <span class="token comment">// gl.createBuffer, gl.bindBuffer, gl.bufferData</span>\n  <span class="token keyword">const</span> bufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">    <span class="token comment">//  material: {</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//    u_diffuse: [1, 1, 1, 1],</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//  },</span></span><span class="gatsby-highlight-code-line">    material<span class="token punctuation">:</span> materials<span class="token punctuation">[</span>material<span class="token punctuation">]</span><span class="token punctuation">,</span></span>    bufferInfo\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当我们在渲染时，我们需要传不止一组全局变量值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17691466221754993000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function render(time) {\n  // ...\n\n  for (const { bufferInfo, material } of parts) {\n    // calls gl.bindBuffer, gl.enableVertexAttribArray, gl.vertexAttribPointer\n    webglUtils.setBuffersAndAttributes(gl, meshProgramInfo, bufferInfo);\n    // calls gl.uniform\n    webglUtils.setUniforms(\n      meshProgramInfo,\n      {\n        u_world\n        // u_diffuse: material.u_diffuse,\n        //  });\n      },\n      material\n    );\n    // calls gl.drawArrays or gl.drawElements\n    webglUtils.drawBufferInfo(gl, bufferInfo);\n  }\n\n  requestAnimationFrame(render);\n}`, `17691466221754993000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{12-16}"\n              >\n                <span class="gatsby-code-button-language">js{12-16}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">{</span> bufferInfo<span class="token punctuation">,</span> material <span class="token punctuation">}</span> <span class="token keyword">of</span> parts<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// calls gl.bindBuffer, gl.enableVertexAttribArray, gl.vertexAttribPointer</span>\n    webglUtils<span class="token punctuation">.</span><span class="token function">setBuffersAndAttributes</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> meshProgramInfo<span class="token punctuation">,</span> bufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// calls gl.uniform</span>\n    webglUtils<span class="token punctuation">.</span><span class="token function">setUniforms</span><span class="token punctuation">(</span>\n      meshProgramInfo<span class="token punctuation">,</span>\n      <span class="token punctuation">{</span>\n        u_world\n<span class="gatsby-highlight-code-line">        <span class="token comment">// u_diffuse: material.u_diffuse,</span></span><span class="gatsby-highlight-code-line">        <span class="token comment">//  });</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      material</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>    <span class="token comment">// calls gl.drawArrays or gl.drawElements</span>\n    webglUtils<span class="token punctuation">.</span><span class="token function">drawBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> bufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后我们需要修改着色器。因为材质有镜面设置，我们添加像关于点光源的文章中一样的镜面计算，除了一点不同，我们计算镜面光是根据方向光源，而不是点光源。</p>\n<p>ambient 和 emissive 可能需要解释一下。ambient 是材质在无方向光源下的反射颜色。如果我们想看到它，我们可以乘上 <code class="language-text">u_ambientLight</code> 并设置黑色以外的颜色。这像把东西冲洗干净。</p>\n<p>emissive 是材质自身发光的颜色，与所有光照无关，所以我们只要加上它就好。如果你想有块地方发光，你可能会用到 emissive。</p>\n<p>这是新的着色器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37510741404251770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const vs = \\`\n   attribute vec4 a_position;\n   attribute vec3 a_normal;\n   attribute vec4 a_color;\n   \n   uniform mat4 u_projection;\n   uniform mat4 u_view;\n   uniform mat4 u_world;\n   uniform vec3 u_viewWorldPosition;\n   \n   varying vec3 v_normal;\n   varying vec3 v_surfaceToView;\n   varying vec4 v_color;\n   \n   void main() {\n      // gl_Position = u_projection * u_view * a_position;\n      vec4 worldPostion = u_world * a_position;\n      gl_Position = u_projection * u_view * worldPosition;\n      v_surfaceToView = u_viewWorldPosition - worldPosition.xyz;\n      v_normal = mat3(u_world) * a_normal;\n      v_color = a_color;\n   }\n\\`;\n\nconst fs = \\`\n   precision highp float;\n   \n   varying vec3 v_normal;\n   varying vec3 v_surfaceToView;\n   varying vec4 v_color;\n   \n   // uniform vec4 u_diffuse;\n   uniform vec3 diffuse;\n   uniform vec3 ambient;\n   uniform vec3 emissive;\n   uniform vec3 specular;\n   uniform float shininess;\n   uniform float opacity;\n   uniform vec3 u_lightDirection;\n   uniform vec3 u_ambientLight;\n   \n   void main () {\n      vec3 normal = normalize(v_normal);\n      \n      vec3 surfaceToViewDirection = normalize(v_surfaceToView);\n      vec3 halfVector = normalize(u_lightDirection + surfaceToViewDirection);\n      \n      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;\n      float specularLight = clamp(dot(normal, halfVector), 0.0, 1.0);\n      \n      // vec4 diffuse = u_diffuse * v_color;\n      vec3 effectiveDiffuse = diffuse * v_color.rgb;\n      float effectiveOpacity = opacity * v_color.a;\n      \n      // gl_FragColor = vec4(diffuse.rgb * fakeLight, diffuse.a);\n      gl_FragColor = vec4(\n            emissive +\n            ambient * u_ambientLight +\n            effectiveDiffuse * fakeLight +\n            specular * pow(specularLight, shininess),\n            effectiveOpacity);\n   }\n\\`;`, `37510741404251770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{9,12,16-19,29,32-38,40,45-46,49,51-53,55-61}"\n              >\n                <span class="gatsby-code-button-language">js{9,12,16-19,29,32-38,40,45-46,49,51-53,55-61}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> vs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   attribute vec4 a_position;</span>\n<span class="token string">   attribute vec3 a_normal;</span>\n<span class="token string">   attribute vec4 a_color;</span>\n<span class="token string">   </span>\n<span class="token string">   uniform mat4 u_projection;</span>\n<span class="token string">   uniform mat4 u_view;</span>\n<span class="token string">   uniform mat4 u_world;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   uniform vec3 u_viewWorldPosition;</span></span><span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   varying vec3 v_surfaceToView;</span></span><span class="token string">   varying vec4 v_color;</span>\n<span class="token string">   </span>\n<span class="token string">   void main() {</span>\n<span class="gatsby-highlight-code-line"><span class="token string">      // gl_Position = u_projection * u_view * a_position;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      vec4 worldPostion = u_world * a_position;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      gl_Position = u_projection * u_view * worldPosition;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      v_surfaceToView = u_viewWorldPosition - worldPosition.xyz;</span></span><span class="token string">      v_normal = mat3(u_world) * a_normal;</span>\n<span class="token string">      v_color = a_color;</span>\n<span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   precision highp float;</span>\n<span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   varying vec3 v_surfaceToView;</span></span><span class="token string">   varying vec4 v_color;</span>\n<span class="token string">   </span>\n<span class="gatsby-highlight-code-line"><span class="token string">   // uniform vec4 u_diffuse;</span></span><span class="gatsby-highlight-code-line"><span class="token string">   uniform vec3 diffuse;</span></span><span class="gatsby-highlight-code-line"><span class="token string">   uniform vec3 ambient;</span></span><span class="gatsby-highlight-code-line"><span class="token string">   uniform vec3 emissive;</span></span><span class="gatsby-highlight-code-line"><span class="token string">   uniform vec3 specular;</span></span><span class="gatsby-highlight-code-line"><span class="token string">   uniform float shininess;</span></span><span class="gatsby-highlight-code-line"><span class="token string">   uniform float opacity;</span></span><span class="token string">   uniform vec3 u_lightDirection;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   uniform vec3 u_ambientLight;</span></span><span class="token string">   </span>\n<span class="token string">   void main () {</span>\n<span class="token string">      vec3 normal = normalize(v_normal);</span>\n<span class="token string">      </span>\n<span class="gatsby-highlight-code-line"><span class="token string">      vec3 surfaceToViewDirection = normalize(v_surfaceToView);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      vec3 halfVector = normalize(u_lightDirection + surfaceToViewDirection);</span></span><span class="token string">      </span>\n<span class="token string">      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">      float specularLight = clamp(dot(normal, halfVector), 0.0, 1.0);</span></span><span class="token string">      </span>\n<span class="gatsby-highlight-code-line"><span class="token string">      // vec4 diffuse = u_diffuse * v_color;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      vec3 effectiveDiffuse = diffuse * v_color.rgb;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      float effectiveOpacity = opacity * v_color.a;</span></span><span class="token string">      </span>\n<span class="gatsby-highlight-code-line"><span class="token string">      // gl_FragColor = vec4(diffuse.rgb * fakeLight, diffuse.a);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      gl_FragColor = vec4(</span></span><span class="gatsby-highlight-code-line"><span class="token string">            emissive +</span></span><span class="gatsby-highlight-code-line"><span class="token string">            ambient * u_ambientLight +</span></span><span class="gatsby-highlight-code-line"><span class="token string">            effectiveDiffuse * fakeLight +</span></span><span class="gatsby-highlight-code-line"><span class="token string">            specular * pow(specularLight, shininess),</span></span><span class="gatsby-highlight-code-line"><span class="token string">            effectiveOpacity);</span></span><span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样，我们得到了和上面图片看起来差不多的效果。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/e8w4o8?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="风车"><a href="#%E9%A3%8E%E8%BD%A6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>风车</h2>\n<p>让我们来加载 .mtl 文件中引用纹理的 .obj 文件。</p>\n<p>我发现了由 <a href="https://www.blendswap.com/user/ahedov" target="_blank" rel="nofollow noreferrer noopener">ahedov</a> 创建的<a href="https://blendswap.com/blend/9755" target="_blank" rel="nofollow noreferrer noopener">风车</a> 3D 模型。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-06-30-11-25-00-7f5a625c70e746445775d674b4928a59-124ef.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 440px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAAB/klEQVQ4y41Uy5LSQBTll9y48FE15chYw8tBCA6BGQKBEEKSSSAh9AuSTneD47jQhZaWCy1/1PZRlpKA3EUvuuvcc+4993YhPRhciCSJEYhSxrKvhf1AyjhHy4Vx2ZhoVzKLvDkaTCnnHESLkVJzh5pMdDzzD5FCHowBx4TelFLKMspzwUyw5E6gzXpGljfIt5A7kcwYQc+2pH6ZaB+YURqn2EuhgwPTHnfUZtnovmRiYw/7rn7NuNjPzBiNMfCNyDOWvhG4w3ajrLUVHIVO75KEs7/bniNb1oaCiWeqM7vvW72LcrHZqAeOlWC4Y1hezYynyGZwFANzbqu1Zw8r52cQQpFxq5ClXceJbQ1goFcrp4Za01sXvmOjcJ51K4c5oalpaNNBs/L0xOkp4bQPotDUur/8+w9YGvFmi1eeZrWb2NXfvkYEo0GrTiDYIc+RLWu+sUfEv8aW/u3D9vN7QTD2+p0VjA6BJZIQAgBo1Ktap6Yqja+fNl8+bghCcO5xvl+2nBvZzzAMKufFsyePS8VHvSvl3R16xReEoD9TdbjmpFo6fXD/3ot6aeaPMfZvb2Mh8hdgFyyluVP9ebXY7SoAeIKjlJF1HOetc7ZhKUVLr99Tmy1lbJmzMFjiNRfb7DLvsSrBCVkAhNE6WSU/By49Tvbv+WTyJ8hV+k98B4aURrgdGswMAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 06 30 11 25 00" title="" data-src="/static/2022-06-30-11-25-00-7f5a625c70e746445775d674b4928a59-124ef.png" data-srcset="/static/2022-06-30-11-25-00-7f5a625c70e746445775d674b4928a59-add0a.png 200w,\n/static/2022-06-30-11-25-00-7f5a625c70e746445775d674b4928a59-7a35e.png 400w,\n/static/2022-06-30-11-25-00-7f5a625c70e746445775d674b4928a59-124ef.png 440w" data-sizes="(max-width: 440px) 100vw, 440px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>它的 .mtl 文件看起来是这样的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60885508163045150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# Blender MTL File: \'windmill_001.blend\'\n# Material Count: 2\n\nnewmtl Material\nNs 0.000000\nKa 1.000000 1.000000 1.000000\nKd 0.800000 0.800000 0.800000\nKs 0.000000 0.000000 0.000000\nKe 0.000000 0.000000 0.000000\nNi 1.000000\nd 1.000000\nillum 1\nmap_Kd windmill_001_lopatky_COL.jpg\nmap_Bump windmill_001_lopatky_NOR.jpg\n\nnewmtl windmill\nNs 0.000000\nKa 1.000000 1.000000 1.000000\nKd 0.800000 0.800000 0.800000\nKs 0.000000 0.000000 0.000000\nKe 0.000000 0.000000 0.000000\nNi 1.000000\nd 1.000000\nillum 1\nmap_Kd windmill_001_base_COL.jpg\nmap_Bump windmill_001_base_NOR.jpg\nmap_Ns windmill_001_base_SPEC.jpg`, `60885508163045150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="mtl"\n              >\n                <span class="gatsby-code-button-language">mtl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="mtl"><pre style="counter-reset: linenumber NaN" class="language-mtl line-numbers"><code class="language-mtl"># Blender MTL File: &#39;windmill_001.blend&#39;\n# Material Count: 2\n\nnewmtl Material\nNs 0.000000\nKa 1.000000 1.000000 1.000000\nKd 0.800000 0.800000 0.800000\nKs 0.000000 0.000000 0.000000\nKe 0.000000 0.000000 0.000000\nNi 1.000000\nd 1.000000\nillum 1\nmap_Kd windmill_001_lopatky_COL.jpg\nmap_Bump windmill_001_lopatky_NOR.jpg\n\nnewmtl windmill\nNs 0.000000\nKa 1.000000 1.000000 1.000000\nKd 0.800000 0.800000 0.800000\nKs 0.000000 0.000000 0.000000\nKe 0.000000 0.000000 0.000000\nNi 1.000000\nd 1.000000\nillum 1\nmap_Kd windmill_001_base_COL.jpg\nmap_Bump windmill_001_base_NOR.jpg\nmap_Ns windmill_001_base_SPEC.jpg</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以看到 <code class="language-text">map_Kd</code>，<code class="language-text">map_Bump</code> 和 <code class="language-text">map_Ns</code> 都指定了图片文件。让我们把它们加入到我们的 <code class="language-text">.mtl</code> 解析器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34356214042905297000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function parseMapArgs(unparsedArgs) {\n  // 处理可选项\n  return unparsedArgs;\n}\n\nfunction parseMTL(text) {\n  const materials = {};\n  let material;\n\n  const keywords = {\n    newmtl(parts, unparsedArgs) {\n      material = {};\n      materials[unparsedArgs] = material;\n    },\n    Ns(parts) {\n      material.shininess = parseFloat(parts[0]);\n    },\n    Ka(parts) {\n      material.ambient = parts.map(parseFloat);\n    },\n    Kd(parts) {\n      material.diffuse = parts.map(parseFloat);\n    },\n    Ks(parts) {\n      material.specular = parts.map(parseFloat);\n    },\n    Ke(parts) {\n      material.emissive = parts.map(parseFloat);\n    },\n    map_Kd(parts, unparsedArgs) {\n      material.diffuseMap = parseMapArgs(unparsedArgs);\n    },\n    map_Ns(parts, unparsedArgs) {\n      material.specularMap = parseMapArgs(unparsedArgs);\n    },\n    map_Bump(parts, unparsedArgs) {\n      material.normalMap = parseMapArgs(unparsedArgs);\n    },\n    Ni(parts) {\n      material.opticalDensity = parseFloat(parts[0]);\n    },\n    d(parts) {\n      material.opacity = parseFloat(parts[0]);\n    },\n    illum(parts) {\n      material.illum = parseInt(parts[0]);\n    }\n  };\n\n  // ...\n}`, `34356214042905297000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{30-38}"\n              >\n                <span class="gatsby-code-button-language">js{30-38}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">parseMapArgs</span><span class="token punctuation">(</span><span class="token parameter">unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 处理可选项</span>\n  <span class="token keyword">return</span> unparsedArgs<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">parseMTL</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> materials <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> material<span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> keywords <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token function">newmtl</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n      materials<span class="token punctuation">[</span>unparsedArgs<span class="token punctuation">]</span> <span class="token operator">=</span> material<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">Ns</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material<span class="token punctuation">.</span>shininess <span class="token operator">=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">Ka</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material<span class="token punctuation">.</span>ambient <span class="token operator">=</span> parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">Kd</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material<span class="token punctuation">.</span>diffuse <span class="token operator">=</span> parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">Ks</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material<span class="token punctuation">.</span>specular <span class="token operator">=</span> parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">Ke</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material<span class="token punctuation">.</span>emissive <span class="token operator">=</span> parts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseFloat<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">    <span class="token function">map_Kd</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>diffuseMap <span class="token operator">=</span> <span class="token function">parseMapArgs</span><span class="token punctuation">(</span>unparsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">map_Ns</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>specularMap <span class="token operator">=</span> <span class="token function">parseMapArgs</span><span class="token punctuation">(</span>unparsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function">map_Bump</span><span class="token punctuation">(</span><span class="token parameter">parts<span class="token punctuation">,</span> unparsedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      material<span class="token punctuation">.</span>normalMap <span class="token operator">=</span> <span class="token function">parseMapArgs</span><span class="token punctuation">(</span>unparsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>    <span class="token function">Ni</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material<span class="token punctuation">.</span>opticalDensity <span class="token operator">=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">d</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material<span class="token punctuation">.</span>opacity <span class="token operator">=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">illum</span><span class="token punctuation">(</span><span class="token parameter">parts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      material<span class="token punctuation">.</span>illum <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意：我写了 parseMapArgs，因为根据这份<a href="http://paulbourke.net/dataformats/mtl" target="_blank" rel="nofollow noreferrer noopener">规范</a>，还有很多额外的可选项我们没有在这个文件中看到。我们需要重构代码才能使用它们。但现在我们只处理带空格的文件名，不处理可选项。</p>\n<p>为了加载所有的纹理，我们会使用来自关于纹理的文章的代码，稍作修改。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12582019096328323000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function create1PixelTexture(gl, pixel) {\n  const texture = gl.createTexture();\n  gl.bindTexture(gl.TEXTURE_2D, texture);\n  gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE, new Uint8Array(pixel));\n  return texture;\n}\n\nfunction createTexture(gl, url) {\n  const texture = create1PixelTexture(gl, [128, 192, 255, 255]);\n  // 异步加载图片\n  const image = new Image();\n  image.src = url;\n  image.addEventListener(\'load\', function () {\n    // 图片加载完成后复制到纹理\n    gl.bindTexture(gl.TEXTURE_2D, texture);\n    gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);\n    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);\n\n    // 检查图片在每个维度都为 2 的幂\n    if (isPowerOf2(image.width) && isPowerOf2(image.height)) {\n      // Yes, it\'s a power of 2. Generate mips.\n      gl.generateMipmap(gl.TEXTURE_2D);\n    } else {\n      // No, it\'s not a power of 2. Turn of mips and set wrapping to clamp to edge\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n    }\n  });\n  return texture;\n}`, `12582019096328323000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">create1PixelTexture</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span> pixel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>pixel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> texture<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span> url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> texture <span class="token operator">=</span> <span class="token function">create1PixelTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 异步加载图片</span>\n  <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  image<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span>\n  image<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'load\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 图片加载完成后复制到纹理</span>\n    gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    gl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_FLIP_Y_WEBGL</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 检查图片在每个维度都为 2 的幂</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPowerOf2</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span>width<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isPowerOf2</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// Yes, it\'s a power of 2. Generate mips.</span>\n      gl<span class="token punctuation">.</span><span class="token function">generateMipmap</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// No, it\'s not a power of 2. Turn of mips and set wrapping to clamp to edge</span>\n      gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> texture<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>两个材质可能引用同一张图片，所以我们将所有的纹理根据名字保存在对象中，这样就不用加载两次了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28942459846138323000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const textures = {};\n\n// 为材质加载纹理\nfor (const material of Object.values(materials)) {\n  Object.entries(material)\n    .filter(([key]) => key.endsWith(\'Map\'))\n    .forEach(([key, filename]) => {\n      let texture = textures[filename];\n      if (!texture) {\n        const textureHref = new URL(filename, baseHref).href;\n        texture = createTexture(gl, textureHref);\n        textures[filename] = texture;\n      }\n      material[key] = texture;\n    });\n}`, `28942459846138323000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> textures <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 为材质加载纹理</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> material <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>materials<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>material<span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>key<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> key<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">\'Map\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>key<span class="token punctuation">,</span> filename<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> texture <span class="token operator">=</span> textures<span class="token punctuation">[</span>filename<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>texture<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> textureHref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> baseHref<span class="token punctuation">)</span><span class="token punctuation">.</span>href<span class="token punctuation">;</span>\n        texture <span class="token operator">=</span> <span class="token function">createTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> textureHref<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        textures<span class="token punctuation">[</span>filename<span class="token punctuation">]</span> <span class="token operator">=</span> texture<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      material<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> texture<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的代码遍历了每个材质的每个属性。如果属性以 “Map” 结尾，就创建相对 URL，创建纹理，然后分配材质，我们将异步加载图片到纹理中。</p>\n<p>我们也会放一个单独的白像素纹理，给那些没有引用纹理的材质。这样我们就可以使用同一个着色器了。否则，我们需要不同的着色器，一个处理带纹理的材质，一个处理不带纹理的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15471875795982193000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// const textures = {};\nconst textures = {\n  defaultWhite: create1PixelTexture(gl, [255, 255, 255, 255])\n};`, `15471875795982193000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// const textures = {};</span>\n<span class="token keyword">const</span> textures <span class="token operator">=</span> <span class="token punctuation">{</span>\n  defaultWhite<span class="token punctuation">:</span> <span class="token function">create1PixelTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们也给材质的其它参数设置默认值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97354306427175440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const defaultMaterial = {\n  diffuse: [1, 1, 1],\n  diffuseMap: textures.defaultWhite,\n  ambient: [0, 0, 0],\n  specular: [1, 1, 1],\n  shininess: 400,\n  opacity: 1\n};\n\nconst parts = obj.geometries.map(({ material, data }) => {\n  // ...\n\n  // create a buffer for each array by calling\n  // gl.createBuffer, gl.bindBuffer, gl.bufferData\n  const bufferInfo = webglUtils.createBufferInfoFromArrays(gl, data);\n  return {\n    // material: materials[material],\n    material: {\n      ...defaultMaterial,\n      ...materials[material]\n    },\n    bufferInfo\n  };\n});`, `97354306427175440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{1-8,17-21}"\n              >\n                <span class="gatsby-code-button-language">js{1-8,17-21}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> defaultMaterial <span class="token operator">=</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  diffuse<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  diffuseMap<span class="token punctuation">:</span> textures<span class="token punctuation">.</span>defaultWhite<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  ambient<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  specular<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  shininess<span class="token punctuation">:</span> <span class="token number">400</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  opacity<span class="token punctuation">:</span> <span class="token number">1</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>\n<span class="token keyword">const</span> parts <span class="token operator">=</span> obj<span class="token punctuation">.</span>geometries<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> material<span class="token punctuation">,</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// create a buffer for each array by calling</span>\n  <span class="token comment">// gl.createBuffer, gl.bindBuffer, gl.bufferData</span>\n  <span class="token keyword">const</span> bufferInfo <span class="token operator">=</span> webglUtils<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">    <span class="token comment">// material: materials[material],</span></span><span class="gatsby-highlight-code-line">    material<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      <span class="token operator">...</span>defaultMaterial<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token operator">...</span>materials<span class="token punctuation">[</span>material<span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>    bufferInfo\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要使用纹理，我们要修改着色器。我们一个一个来处理。我们先来使用漫反射贴图。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82513356451915350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const vs = \\`\n   attribute vec4 a_position;\n   attribute vec3 a_normal;\n   attribute vec2 a_texcoord;\n   attribute vec4 a_color;\n   \n   uniform mat4 u_projection;\n   uniform mat4 u_view;\n   uniform mat4 u_world;\n   uniform vec3 u_viewWorldPosition;\n   \n   varying vec3 v_normal;\n   varying vec3 v_surfaceToView;\n   varying vec2 v_texcoord;\n   varying vec4 v_color;\n   \n   void main() {\n      vec4 worldPosition = u_world * a_position;\n      gl_Position = u_projection * u_view * worldPosition;\n      v_surfaceToView = u_viewWorldPosition - worldPosition.xyz;\n      v_normal = mat3(u_world) * a_normal;\n      v_texcoord = a_texcoord;\n      v_color = a_color;\n   }\n\\`;\n\nconst fs = \\`\n   # version 300 es\n   precision highp float;\n   \n   varying vec3 v_normal;\n   varying vec3 v_surfaceToView;\n   varying vec2 v_texcoord;\n   varying vec4 v_color;\n   \n   uniform vec3 diffuse;\n   uniform sampler2D diffuseMap;\n   uniform vec3 ambient;\n   uniform vec3 emissive;\n   uniform vec3 specular;\n   uniform float shininess;\n   uniform float opacity;\n   uniform vec3 u_lightDirection;\n   uniform vec3 u_ambientLight;\n   \n   void main () {\n      vec3 normal = normalize(v_normal);\n      \n      vec3 surfaceToViewDirection = normalize(v_surfaceToView);\n      vec3 halfVector = normalize(u_lightDirection + surfaceToViewDirection);\n      \n      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;\n      float specularLight = clamp(dot(normal, halfVector), 0.0, 1.0);\n      \n      // vec3 effectiveDiffuse = diffuse.rgb * v_color.rgb;\n      // float effectiveOpacity = v_color.a * opacity;\n      vec4 diffuseMapColor = texture2D(diffuseMap, v_texcoord);\n      vec3 effectiveDiffuse = diffuse * diffuseMapColor.rgb * v_color.rgb;\n      float effectiveOpacity = opacity * diffuseMapColor.a * v_color.a;\n      \n      gl_FragColor = vec4(\n         emissive +\n         ambient * u_ambientLight +\n         effectiveDiffuse * fakeLight +\n         specular * pow(specularLight, shininess),\n         effectiveOpacity\n      );\n   }\n\\`;`, `82513356451915350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4,14,22,33,37,55-59}"\n              >\n                <span class="gatsby-code-button-language">js{4,14,22,33,37,55-59}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> vs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   attribute vec4 a_position;</span>\n<span class="token string">   attribute vec3 a_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   attribute vec2 a_texcoord;</span></span><span class="token string">   attribute vec4 a_color;</span>\n<span class="token string">   </span>\n<span class="token string">   uniform mat4 u_projection;</span>\n<span class="token string">   uniform mat4 u_view;</span>\n<span class="token string">   uniform mat4 u_world;</span>\n<span class="token string">   uniform vec3 u_viewWorldPosition;</span>\n<span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="token string">   varying vec3 v_surfaceToView;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   varying vec2 v_texcoord;</span></span><span class="token string">   varying vec4 v_color;</span>\n<span class="token string">   </span>\n<span class="token string">   void main() {</span>\n<span class="token string">      vec4 worldPosition = u_world * a_position;</span>\n<span class="token string">      gl_Position = u_projection * u_view * worldPosition;</span>\n<span class="token string">      v_surfaceToView = u_viewWorldPosition - worldPosition.xyz;</span>\n<span class="token string">      v_normal = mat3(u_world) * a_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">      v_texcoord = a_texcoord;</span></span><span class="token string">      v_color = a_color;</span>\n<span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   # version 300 es</span>\n<span class="token string">   precision highp float;</span>\n<span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="token string">   varying vec3 v_surfaceToView;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   varying vec2 v_texcoord;</span></span><span class="token string">   varying vec4 v_color;</span>\n<span class="token string">   </span>\n<span class="token string">   uniform vec3 diffuse;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   uniform sampler2D diffuseMap;</span></span><span class="token string">   uniform vec3 ambient;</span>\n<span class="token string">   uniform vec3 emissive;</span>\n<span class="token string">   uniform vec3 specular;</span>\n<span class="token string">   uniform float shininess;</span>\n<span class="token string">   uniform float opacity;</span>\n<span class="token string">   uniform vec3 u_lightDirection;</span>\n<span class="token string">   uniform vec3 u_ambientLight;</span>\n<span class="token string">   </span>\n<span class="token string">   void main () {</span>\n<span class="token string">      vec3 normal = normalize(v_normal);</span>\n<span class="token string">      </span>\n<span class="token string">      vec3 surfaceToViewDirection = normalize(v_surfaceToView);</span>\n<span class="token string">      vec3 halfVector = normalize(u_lightDirection + surfaceToViewDirection);</span>\n<span class="token string">      </span>\n<span class="token string">      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;</span>\n<span class="token string">      float specularLight = clamp(dot(normal, halfVector), 0.0, 1.0);</span>\n<span class="token string">      </span>\n<span class="gatsby-highlight-code-line"><span class="token string">      // vec3 effectiveDiffuse = diffuse.rgb * v_color.rgb;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      // float effectiveOpacity = v_color.a * opacity;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      vec4 diffuseMapColor = texture2D(diffuseMap, v_texcoord);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      vec3 effectiveDiffuse = diffuse * diffuseMapColor.rgb * v_color.rgb;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      float effectiveOpacity = opacity * diffuseMapColor.a * v_color.a;</span></span><span class="token string">      </span>\n<span class="token string">      gl_FragColor = vec4(</span>\n<span class="token string">         emissive +</span>\n<span class="token string">         ambient * u_ambientLight +</span>\n<span class="token string">         effectiveDiffuse * fakeLight +</span>\n<span class="token string">         specular * pow(specularLight, shininess),</span>\n<span class="token string">         effectiveOpacity</span>\n<span class="token string">      );</span>\n<span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/0227gc?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>回头看 .mtl 文件，我们看到 <code class="language-text">map_Ks</code> 基本是黑白的纹理，它指定了特定表面的光泽度，或者也可以说是多少镜面反射的效果。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-04-17-41-33-f768706a2325e6f700587a19e116101f-9cb4a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 510px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100.19607843137254%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAABO0lEQVQ4y61UuW6FMBA09ylA4mooqCgQDUKioeT/v2mjcbTG8vPLgyTFyOeOZy+LpmkoSRLKskwiTVM1vwvYsJ0AmRDi/wBmXjiOI0e81HXdy/5PUHd0QkZRFDSO4+8USr9tLz1E3/fkuu5FKBcaKUM3wh3P8yRMwmVZZHJfYsgGNqU6IZ/zuK4rHcdxEeJyGIbk+76EqQLnJnTCeZ5p3/eL0OaGjdBUzutt2+g8z+8YmvELgsAaU33PJESZTdNEIs9zpRCAkUlouvexbDjYf+kQVRVQyLFht5AcgJXZXH3bLZwUs+70WrxLaO2Udy/fDgkTckL00mB1tnL5+NtwzLgLmARrZP3x9wVCLh29vTDi7DZhWZYUx7FqOyjDGEWRCsUjhXVdU9u2VFWVJIUx5sMwyI8WfyPu3M30F4nGnoJ4HqT5AAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 04 17 41 33" title="" data-src="/static/2022-07-04-17-41-33-f768706a2325e6f700587a19e116101f-9cb4a.png" data-srcset="/static/2022-07-04-17-41-33-f768706a2325e6f700587a19e116101f-931d4.png 200w,\n/static/2022-07-04-17-41-33-f768706a2325e6f700587a19e116101f-3a665.png 400w,\n/static/2022-07-04-17-41-33-f768706a2325e6f700587a19e116101f-9cb4a.png 510w" data-sizes="(max-width: 510px) 100vw, 510px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>为了使用它，只需要更新着色器，因为我们已经加载了全部的纹理。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66334078678942810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const fs = \\`\n   precision highp float;\n   \n   varying vec3 v_normal;\n   varying vec3 v_surfaceToView;\n   varying vec2 v_texcoord;\n   varying vec4 v_color;\n   \n   uniform vec3 diffuse;\n   uniform sampler2D diffuseMap;\n   uniform vec3 ambient;\n   uniform vec3 emissive;\n   uniform vec3 specular;\n   uniform sampler2D specularMap;\n   uniform float shininess;\n   uniform float opacity;\n   uniform vec3 u_lightDirection;\n   uniform vec3 u_ambientLight;\n   \n   void main () {\n      vec3 normal = normalize(v_normal);\n      \n      vec3 surfaceToViewDirection = normalize(v_surfaceToView);\n      vec3 halfVector = normalize(u_lightDirection + surfaceToViewDirection);\n      \n      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;\n      float specularLight = clamp(dot(normal, halfVector), 0.0, 1.0);\n      vec4 specularMapColor = texture2D(specularMap, v_texcoord);\n      vec3 effectiveSpecular = specular * specularMapColor.rgb;\n      \n      vec4 diffuseMapColor = texture2D(diffuseMap, v_texcoord);\n      vec3 effectiveDiffuse = diffuse * diffuseMapColor.rgb * v_color.rgb;\n      float effectiveOpacity = opacity * diffuseMapColor.a * v_color.a;\n      \n      gl_FragColor = vec4(\n         emissive +\n         ambient * u_ambientLight +\n         effectiveDiffuse * fakeLight +\n         // specular * pow(specularLight, shininess),\n         effectiveSpecular * pow(specularLight, shininess),\n         effectiveOpacity\n      );\n   }\n\\`;`, `66334078678942810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{14,28-29,39-40}"\n              >\n                <span class="gatsby-code-button-language">js{14,28-29,39-40}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   precision highp float;</span>\n<span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="token string">   varying vec3 v_surfaceToView;</span>\n<span class="token string">   varying vec2 v_texcoord;</span>\n<span class="token string">   varying vec4 v_color;</span>\n<span class="token string">   </span>\n<span class="token string">   uniform vec3 diffuse;</span>\n<span class="token string">   uniform sampler2D diffuseMap;</span>\n<span class="token string">   uniform vec3 ambient;</span>\n<span class="token string">   uniform vec3 emissive;</span>\n<span class="token string">   uniform vec3 specular;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   uniform sampler2D specularMap;</span></span><span class="token string">   uniform float shininess;</span>\n<span class="token string">   uniform float opacity;</span>\n<span class="token string">   uniform vec3 u_lightDirection;</span>\n<span class="token string">   uniform vec3 u_ambientLight;</span>\n<span class="token string">   </span>\n<span class="token string">   void main () {</span>\n<span class="token string">      vec3 normal = normalize(v_normal);</span>\n<span class="token string">      </span>\n<span class="token string">      vec3 surfaceToViewDirection = normalize(v_surfaceToView);</span>\n<span class="token string">      vec3 halfVector = normalize(u_lightDirection + surfaceToViewDirection);</span>\n<span class="token string">      </span>\n<span class="token string">      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;</span>\n<span class="token string">      float specularLight = clamp(dot(normal, halfVector), 0.0, 1.0);</span>\n<span class="gatsby-highlight-code-line"><span class="token string">      vec4 specularMapColor = texture2D(specularMap, v_texcoord);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      vec3 effectiveSpecular = specular * specularMapColor.rgb;</span></span><span class="token string">      </span>\n<span class="token string">      vec4 diffuseMapColor = texture2D(diffuseMap, v_texcoord);</span>\n<span class="token string">      vec3 effectiveDiffuse = diffuse * diffuseMapColor.rgb * v_color.rgb;</span>\n<span class="token string">      float effectiveOpacity = opacity * diffuseMapColor.a * v_color.a;</span>\n<span class="token string">      </span>\n<span class="token string">      gl_FragColor = vec4(</span>\n<span class="token string">         emissive +</span>\n<span class="token string">         ambient * u_ambientLight +</span>\n<span class="token string">         effectiveDiffuse * fakeLight +</span>\n<span class="gatsby-highlight-code-line"><span class="token string">         // specular * pow(specularLight, shininess),</span></span><span class="gatsby-highlight-code-line"><span class="token string">         effectiveSpecular * pow(specularLight, shininess),</span></span><span class="token string">         effectiveOpacity</span>\n<span class="token string">      );</span>\n<span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们也给没有高光贴图的材质设置默认值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68886513725475650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const defaultMaterial = {\n  diffuse: [1, 1, 1],\n  diffuseMap: textures.defaultWhite,\n  ambient: [0, 0, 0],\n  specular: [1, 1, 1],\n  specularMap: textures.defaultWhite,\n  shininess: 400,\n  opacity: 1\n};`, `68886513725475650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{6}"\n              >\n                <span class="gatsby-code-button-language">js{6}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> defaultMaterial <span class="token operator">=</span> <span class="token punctuation">{</span>\n  diffuse<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  diffuseMap<span class="token punctuation">:</span> textures<span class="token punctuation">.</span>defaultWhite<span class="token punctuation">,</span>\n  ambient<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  specular<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  specularMap<span class="token punctuation">:</span> textures<span class="token punctuation">.</span>defaultWhite<span class="token punctuation">,</span></span>  shininess<span class="token punctuation">:</span> <span class="token number">400</span><span class="token punctuation">,</span>\n  opacity<span class="token punctuation">:</span> <span class="token number">1</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>根据 <code class="language-text">.mtl</code> 文件中的材质设置，很难看到什么效果。让我们来修改下镜面设置，这样就好了</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75746736249822970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// hack the materials so we can see the specular map\nObject.values(materials).forEach((m) => {\n  m.shininess = 25;\n  m.specular = [3, 2, 1];\n});`, `75746736249822970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// hack the materials so we can see the specular map</span>\nObject<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>materials<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  m<span class="token punctuation">.</span>shininess <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>\n  m<span class="token punctuation">.</span>specular <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样，只有窗和叶片被设置成反射高光了。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/i4ui4n?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>我很奇怪叶片被设置成了反光。如果你检查 .mtl 文件，你会发现光泽度 Ns 被设置成了 0.0，也就是几乎不反光。但同时，所有材质的 illum 被设置成了 1。根据文档，照度模型为 1 意味着：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47314317251532080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`颜色 = KaIa + Kd { SUM j=1...ls, (N * Lj)Ij }`, `47314317251532080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">颜色 = KaIa + Kd { SUM j=1...ls, (N * Lj)Ij }</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>更通俗的说：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29228597389623267000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`颜色 = 环境色 * 环境光 + 漫反射色 * 光照计算和`, `29228597389623267000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">颜色 = 环境色 * 环境光 + 漫反射色 * 光照计算和</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>你可以看到并没有用到镜面反射，但文件里却有镜面贴图！镜面高光需要照度模型为 2 或以上。这是一些关于 <code class="language-text">.obj/.mtl</code> 文件的经验，你总是需要对材质做一些手动调整。如何解决这些问题取决于你。你可以编辑 .mtl 文件，或者添加代码。而我们现在会添加一些代码。</p>\n<p>最后一个 .mtl 文件使用贴图的是凹凸贴图：map_Bump。这又是一个可以看出 <code class="language-text">.obj/.mtl</code> 文件古老的地方。引用的只是法线贴图，并不是凹凸贴图。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-07-04-18-04-45-0fe2f374e025dc6527f9befccfd30379-5d925.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 508px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 99.60629921259843%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAACa0lEQVQ4y31UyXbkIAz0ZxsMSQzY35pJejIvvXjpC1MlyUsOM4d6YDBSqUrQ+DzXrszVA122Ub4XjA+MUw1AB3gbg+G8t6HpMg4SxcYz0qwBMqEJA9YVs/03yboCAT0WfZ6M4bRvSHbO0ySBgyU5j6GsOhcyFjDkp2WyLFLGIglCOTNad3TEvrdako3hAAajgTrkTS/qdxeWYZNkuAO3Gob5SFBWZWgVNm2+4+A3yr4CDyv7IXOPvSisl9qWa3X5grUPBPhd4zAdJZuWYTPFv001pqU6sOrKTdwNpmHMXL8BfySYz+/AL+x/yZ4wF4kY8FGbCA2ZyQ0IllBSz9GAH+KAPTAlu47B0qW6/hP7F0usbntheIcp5YlgKA2BYlprxDdBs3yvpbB8l7+E4UuGhmm1ddN90HkAoaalFumGIMgyoqFHMBuvNcCkODDzogYl6Jw+UCaNWXbjhKUEnrVk6TNstnDPZxzqceDtitLvYgoP0KTIVknbt90YaX6ym62drG3oYGDJPdlab6Esj4Z2wki17KC1NzaqmTa3z9Y2gLRNSFcwoBbz3ovBBHei3ze0m3bxfdIbRW0DOoAEnEhAU6wUaWCwi6cbwW8vjt8QUG/IxnC7GUKGxsocGlLYSEFR0g+UY+5NcHV/3a+ctFx+7gRIpmFGoUuHB4WUDm3doOvdOMuN4eGtrSR4YZudWg2Qxm6TvTT9pK4lTRI4Jn2+XuTePn9IEnd2z4MhI7dkVuyBMGZba7Q2f6WjwlAPnpme0UiJfAj6g6Hrp/1hdb0yjfLuGZN/BJOATl6To+PJVDRlqcZWDVGGofw/4F/hE52zqm4A9QAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 07 04 18 04 45" title="" data-src="/static/2022-07-04-18-04-45-0fe2f374e025dc6527f9befccfd30379-5d925.png" data-srcset="/static/2022-07-04-18-04-45-0fe2f374e025dc6527f9befccfd30379-7e12f.png 200w,\n/static/2022-07-04-18-04-45-0fe2f374e025dc6527f9befccfd30379-6877e.png 400w,\n/static/2022-07-04-18-04-45-0fe2f374e025dc6527f9befccfd30379-5d925.png 508w" data-sizes="(max-width: 508px) 100vw, 508px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>.mtl 文件中并没有选项指定将凹凸贴图用作法线贴图。我们可以启发性的假设文件名中有个 <code class="language-text">nor</code> 呢？或者我们可以假设 2020 及以后，所有 <code class="language-text">map_Bump</code> 引用的文件都是法线贴图，因为我不确定在过去的几年中看到过 <code class="language-text">.obj</code> 文件中引用的确实是凹凸贴图。 我们先沿着这个假设做。</p>\n<p>我们会用到来自关于法线贴图的文章的代码来生成切线。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56214496609462030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const parts = obj.geometries.map(({ material, data }) => {\n  // ...\n\n  // 如果数据满足，生成切线\n  if (data.texcoord && data.normal) {\n    data.tangent = generateTangents(data.position, data.texcoord);\n  } else {\n    // 没有切线\n    data.tangent = { value: [1, 0, 0] };\n  }\n\n  // create a buffer for each array by calling\n  // gl.createBuffer, gl.bindBuffer, gl.bufferData\n  const bufferInfo = twgl.createBufferInfoFromArrays(gl, data);\n  const vao = twgl.createVAOFromBufferInfo(gl, meshProgramInfo, bufferInfo);\n  return {\n    material: {\n      ...defaultMaterial,\n      ...materials[material]\n    },\n    bufferInfo,\n    vao\n  };\n});`, `56214496609462030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4-10}"\n              >\n                <span class="gatsby-code-button-language">js{4-10}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> parts <span class="token operator">=</span> obj<span class="token punctuation">.</span>geometries<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> material<span class="token punctuation">,</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 如果数据满足，生成切线</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>texcoord <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">.</span>normal<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    data<span class="token punctuation">.</span>tangent <span class="token operator">=</span> <span class="token function">generateTangents</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>position<span class="token punctuation">,</span> data<span class="token punctuation">.</span>texcoord<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">// 没有切线</span></span><span class="gatsby-highlight-code-line">    data<span class="token punctuation">.</span>tangent <span class="token operator">=</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  <span class="token comment">// create a buffer for each array by calling</span>\n  <span class="token comment">// gl.createBuffer, gl.bindBuffer, gl.bufferData</span>\n  <span class="token keyword">const</span> bufferInfo <span class="token operator">=</span> twgl<span class="token punctuation">.</span><span class="token function">createBufferInfoFromArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> vao <span class="token operator">=</span> twgl<span class="token punctuation">.</span><span class="token function">createVAOFromBufferInfo</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> meshProgramInfo<span class="token punctuation">,</span> bufferInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    material<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      <span class="token operator">...</span>defaultMaterial<span class="token punctuation">,</span>\n      <span class="token operator">...</span>materials<span class="token punctuation">[</span>material<span class="token punctuation">]</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    bufferInfo<span class="token punctuation">,</span>\n    vao\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同样的，为没有法线贴图的材质添加默认值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12571971337973453000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const textures = {\n  defaultWhite: create1PixelTexture(gl, [255, 255, 255, 255]),\n  defaultNormal: create1PixelTexture(gl, [127, 127, 255, 0])\n};\n\n// ...\n\nconst defaultMaterial = {\n  diffuse: [1, 1, 1],\n  diffuseMap: textures.defaultWhite,\n  normalMap: textures.defaultNormal,\n  ambient: [0, 0, 0],\n  specular: [1, 1, 1],\n  specularMap: textures.defaultWhite,\n  shininess: 400,\n  opacity: 1\n};\n\n// ...`, `12571971337973453000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{3,11}"\n              >\n                <span class="gatsby-code-button-language">js{3,11}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> textures <span class="token operator">=</span> <span class="token punctuation">{</span>\n  defaultWhite<span class="token punctuation">:</span> <span class="token function">create1PixelTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  defaultNormal<span class="token punctuation">:</span> <span class="token function">create1PixelTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">127</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span>\n\n<span class="token keyword">const</span> defaultMaterial <span class="token operator">=</span> <span class="token punctuation">{</span>\n  diffuse<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  diffuseMap<span class="token punctuation">:</span> textures<span class="token punctuation">.</span>defaultWhite<span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  normalMap<span class="token punctuation">:</span> textures<span class="token punctuation">.</span>defaultNormal<span class="token punctuation">,</span></span>  ambient<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  specular<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  specularMap<span class="token punctuation">:</span> textures<span class="token punctuation">.</span>defaultWhite<span class="token punctuation">,</span>\n  shininess<span class="token punctuation">:</span> <span class="token number">400</span><span class="token punctuation">,</span>\n  opacity<span class="token punctuation">:</span> <span class="token number">1</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后我们需要将关于法线贴图的文章中对着色器的修改合并：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71878204649208046000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const vs = \\`\n   attribute vec4 a_position;\n   attribute vec3 a_normal;\n   attribute vec3 a_tangent;\n   attribute vec2 a_texcoord;\n   attribute vec4 a_color;\n   \n   uniform mat4 u_projection;\n   uniform mat4 u_view;\n   uniform mat4 u_world;\n   uniform vec3 u_viewWorldPosition;\n   \n   varying vec3 v_normal;\n   varying vec3 v_tangent;\n   varying vec3 v_surfaceToView;\n   varying vec2 v_texcoord;\n   varying vec4 v_color;\n   \n   void main() {\n      vec4 worldPosition = u_world * a_position;\n      gl_Position = u_projection * u_view * worldPosition;\n      v_surfaceToView = u_viewWorldPosition - worldPosition.xyz;\n      \n      // v_normal = mat3(u_world) * a_normal;\n      mat3 normalMat = mat3(u_world);\n      v_normal = normalize(normalMat * a_normal);\n      v_tangent = normalize(normalMat * a_tangent);\n      \n      v_texcoord = a_texcoord;\n      v_color = a_color;\n   }\n\\`;\n\nconst fs = \\`\n   precision highp float;\n   \n   varying vec3 v_normal;\n   varying vec3 v_tangent;\n   varying vec3 v_surfaceToView;\n   varying vec2 v_texcoord;\n   varying vec4 v_color;\n   \n   uniform vec3 diffuse;\n   uniform sampler2D diffuseMap;\n   uniform vec3 ambient;\n   uniform vec3 emissive;\n   uniform vec3 specular;\n   uniform sampler2D specularMap;\n   uniform float shininess;\n   uniform sampler2D normalMap;\n   uniform float opacity;\n   uniform vec3 u_lightDirection;\n   uniform vec3 u_ambientLight;\n   \n   void main () {\n      vec3 normal = normalize(v_normal);\n      vec3 tangent = normalize(v_tangent);\n      vec3 bitangent = normalize(cross(normal, tangent));\n      \n      mat3 tbn = mat3(tangent, bitangent, normal);\n      normal = texture2D(normalMap, v_texcoord).rgb * 2. - 1.;\n      normal = normalize(tbn * normal);\n      \n      vec3 surfaceToViewDirection = normalize(v_surfaceToView);\n      vec3 halfVector = normalize(u_lightDirection + surfaceToViewDirection);\n      \n      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;\n      float specularLight = clamp(dot(normal, halfVector), 0.0, 1.0);\n      vec4 specularMapColor = texture2D(specularMap, v_texcoord);\n      vec3 effectiveSpecular = specular * specularMapColor.rgb;\n      \n      vec4 diffuseMapColor = texture2D(diffuseMap, v_texcoord);\n      vec3 effectiveDiffuse = diffuse * diffuseMapColor.rgb * v_color.rgb;\n      float effectiveOpacity = opacity * diffuseMapColor.a * v_color.a;\n      \n      gl_FragColor = vec4(\n         emissive +\n         ambient * u_ambientLight +\n         effectiveDiffuse * fakeLight +\n         effectiveSpecular * pow(specularLight, shininess),\n         effectiveOpacity); // * 0.0 + vec4(normal * 0.5 + 0.5 + effectiveSpecular * pow(specularLight, shininess), 1\n      );\n   }\n\\`;`, `71878204649208046000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{4,14,24-27,38,57-62}"\n              >\n                <span class="gatsby-code-button-language">js{4,14,24-27,38,57-62}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> vs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   attribute vec4 a_position;</span>\n<span class="token string">   attribute vec3 a_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   attribute vec3 a_tangent;</span></span><span class="token string">   attribute vec2 a_texcoord;</span>\n<span class="token string">   attribute vec4 a_color;</span>\n<span class="token string">   </span>\n<span class="token string">   uniform mat4 u_projection;</span>\n<span class="token string">   uniform mat4 u_view;</span>\n<span class="token string">   uniform mat4 u_world;</span>\n<span class="token string">   uniform vec3 u_viewWorldPosition;</span>\n<span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   varying vec3 v_tangent;</span></span><span class="token string">   varying vec3 v_surfaceToView;</span>\n<span class="token string">   varying vec2 v_texcoord;</span>\n<span class="token string">   varying vec4 v_color;</span>\n<span class="token string">   </span>\n<span class="token string">   void main() {</span>\n<span class="token string">      vec4 worldPosition = u_world * a_position;</span>\n<span class="token string">      gl_Position = u_projection * u_view * worldPosition;</span>\n<span class="token string">      v_surfaceToView = u_viewWorldPosition - worldPosition.xyz;</span>\n<span class="token string">      </span>\n<span class="gatsby-highlight-code-line"><span class="token string">      // v_normal = mat3(u_world) * a_normal;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      mat3 normalMat = mat3(u_world);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      v_normal = normalize(normalMat * a_normal);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      v_tangent = normalize(normalMat * a_tangent);</span></span><span class="token string">      </span>\n<span class="token string">      v_texcoord = a_texcoord;</span>\n<span class="token string">      v_color = a_color;</span>\n<span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">   precision highp float;</span>\n<span class="token string">   </span>\n<span class="token string">   varying vec3 v_normal;</span>\n<span class="gatsby-highlight-code-line"><span class="token string">   varying vec3 v_tangent;</span></span><span class="token string">   varying vec3 v_surfaceToView;</span>\n<span class="token string">   varying vec2 v_texcoord;</span>\n<span class="token string">   varying vec4 v_color;</span>\n<span class="token string">   </span>\n<span class="token string">   uniform vec3 diffuse;</span>\n<span class="token string">   uniform sampler2D diffuseMap;</span>\n<span class="token string">   uniform vec3 ambient;</span>\n<span class="token string">   uniform vec3 emissive;</span>\n<span class="token string">   uniform vec3 specular;</span>\n<span class="token string">   uniform sampler2D specularMap;</span>\n<span class="token string">   uniform float shininess;</span>\n<span class="token string">   uniform sampler2D normalMap;</span>\n<span class="token string">   uniform float opacity;</span>\n<span class="token string">   uniform vec3 u_lightDirection;</span>\n<span class="token string">   uniform vec3 u_ambientLight;</span>\n<span class="token string">   </span>\n<span class="token string">   void main () {</span>\n<span class="token string">      vec3 normal = normalize(v_normal);</span>\n<span class="gatsby-highlight-code-line"><span class="token string">      vec3 tangent = normalize(v_tangent);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      vec3 bitangent = normalize(cross(normal, tangent));</span></span><span class="gatsby-highlight-code-line"><span class="token string">      </span></span><span class="gatsby-highlight-code-line"><span class="token string">      mat3 tbn = mat3(tangent, bitangent, normal);</span></span><span class="gatsby-highlight-code-line"><span class="token string">      normal = texture2D(normalMap, v_texcoord).rgb * 2. - 1.;</span></span><span class="gatsby-highlight-code-line"><span class="token string">      normal = normalize(tbn * normal);</span></span><span class="token string">      </span>\n<span class="token string">      vec3 surfaceToViewDirection = normalize(v_surfaceToView);</span>\n<span class="token string">      vec3 halfVector = normalize(u_lightDirection + surfaceToViewDirection);</span>\n<span class="token string">      </span>\n<span class="token string">      float fakeLight = dot(u_lightDirection, normal) * .5 + .5;</span>\n<span class="token string">      float specularLight = clamp(dot(normal, halfVector), 0.0, 1.0);</span>\n<span class="token string">      vec4 specularMapColor = texture2D(specularMap, v_texcoord);</span>\n<span class="token string">      vec3 effectiveSpecular = specular * specularMapColor.rgb;</span>\n<span class="token string">      </span>\n<span class="token string">      vec4 diffuseMapColor = texture2D(diffuseMap, v_texcoord);</span>\n<span class="token string">      vec3 effectiveDiffuse = diffuse * diffuseMapColor.rgb * v_color.rgb;</span>\n<span class="token string">      float effectiveOpacity = opacity * diffuseMapColor.a * v_color.a;</span>\n<span class="token string">      </span>\n<span class="token string">      gl_FragColor = vec4(</span>\n<span class="token string">         emissive +</span>\n<span class="token string">         ambient * u_ambientLight +</span>\n<span class="token string">         effectiveDiffuse * fakeLight +</span>\n<span class="token string">         effectiveSpecular * pow(specularLight, shininess),</span>\n<span class="token string">         effectiveOpacity); // * 0.0 + vec4(normal * 0.5 + 0.5 + effectiveSpecular * pow(specularLight, shininess), 1</span>\n<span class="token string">      );</span>\n<span class="token string">   }</span>\n<span class="token string"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样，我们就得到了法线贴图。注意：我移近了摄像头，这样能看的更清楚。</p>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/j09plh?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<p>我确信我们还可以支持更多的 <code class="language-text">.mtl</code> 文件的的特性。比如 refl 关键词指定了反射贴图，也就是环境贴图。同样还有很多 <code class="language-text">map_</code> 加各种选项参数的关键词。比如：</p>\n<ul>\n<li><code class="language-text">-clamp on | off</code> 指定纹理是否重复</li>\n<li><code class="language-text">-mm base gain</code> 指定纹理值的偏移和倍数</li>\n<li><code class="language-text">-o u v w</code> 指定纹理坐标的偏移。可以像关于 drawImage 的文章中那样放进纹理矩阵中来使用</li>\n<li><code class="language-text">-s u v w</code> 指定纹理坐标的缩放。像上面一样，这些需要放进纹理矩阵中</li>\n</ul>\n<p>我不知道有多少 .mtl 文件使用了这些设置，或用了多少。例如，要支持 -o 和 -s，我们就要假设所有的贴图都有区别，并支持全部的纹理。这就需要我们为每个纹理传不同的纹理矩阵，而这又需要我们从顶点着色器为每个纹理传不同的纹理坐标到片段着色器，或者在片段着色器中进行纹理矩阵乘法（而不是传统方法那样在顶点着色器中做）。</p>\n<p>更重要的是，如果支持所有特性，会让着色器变得又大又复杂。上面的代码是一种超级着色器的样子，一个试图处理所有情况的着色器。通过传默认值来让它正常工作。例如，我们将 diffuseMap 默认设置成白色纹理，这样如果我们加载了没有纹理的模型，也可以显示出来。漫反射的颜色会被乘上白色，也就是 1.0，所以我们就能得到漫反射颜色。类似的，我们将顶点颜色默认设置为白色。</p>\n<p>这是一种常用的方式。如果它效果不错，满足了你的要求，就没有理由去改动它。更常见的做法是生成一个可以开/关这些特性的着色器。如果没有顶点颜色，就通过操作字符串，生成一个着色器，着色器里没有 <code class="language-text">a_color</code> 属性和其它相关代码。类似的，如果一个材质没有漫反射贴图，就生成一个没有 <code class="language-text">uniform sampler2D diffuseMap</code> 的着色器，并移除相关代码。如果不包含任何贴图，就不需要纹理坐标，我们就可以把它们全部移除。</p>\n<p>如果将这些组合都加上，可能会有 1000 多种着色器。我们上面有的特性就有：</p>\n<ul>\n<li>漫反射贴图</li>\n<li>有/无镜面贴图</li>\n<li>有/无法线贴图</li>\n<li>有/无顶点颜色</li>\n<li>有/无环境贴图</li>\n<li>有/无（我们不支持，但 .mtl 文件中有）</li>\n<li>反射贴图，有/无（我们不支持，但 .mtl 文件中有）</li>\n</ul>\n<p>仅这些就有 64 种组合。如果再加上 1 到 4 种光线（点光源、方向光源等），那么就会有 8192 种可能的着色器组合。</p>\n<p>管理这些就会有很多工作。这就是为什么很多人选择像 three.js 这样的 3D 引擎而不是自己开发的原因。但至少这篇文章介绍了一些展示任意 3D 内容的相关的知识。</p>\n<h2 id="尽可能避免在着色器中使用条件语句"><a href="#%E5%B0%BD%E5%8F%AF%E8%83%BD%E9%81%BF%E5%85%8D%E5%9C%A8%E7%9D%80%E8%89%B2%E5%99%A8%E4%B8%AD%E4%BD%BF%E7%94%A8%E6%9D%A1%E4%BB%B6%E8%AF%AD%E5%8F%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>尽可能避免在着色器中使用条件语句</h2>\n<p>通常的建议是避免在着色器中使用条件语句。比如我们可能写这样的代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="953597636531999700"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`uniform bool hasDiffuseMap;\nuniform vec4 diffuse;\nuniform sampler2D diffuseMap\n\n// ...\nvec4 effectiveDiffuse = diffuse;\nif (hasDiffuseMap) {\n   effectiveDiffuse \\*= texture2D(diffuseMap, texcoord);\n}\n// ...`, `953597636531999700`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="glsl"\n              >\n                <span class="gatsby-code-button-language">glsl</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="glsl"><pre style="counter-reset: linenumber NaN" class="language-glsl line-numbers"><code class="language-glsl"><span class="token keyword">uniform</span> <span class="token keyword">bool</span> hasDiffuseMap<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">vec4</span> diffuse<span class="token punctuation">;</span>\n<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> diffuseMap\n\n<span class="token comment">// ...</span>\n<span class="token keyword">vec4</span> effectiveDiffuse <span class="token operator">=</span> diffuse<span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>hasDiffuseMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   effectiveDiffuse \\<span class="token operator">*</span><span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>diffuseMap<span class="token punctuation">,</span> texcoord<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// ...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样的条件语句一般是不鼓励的，因为依赖于 GPU 或者驱动，它们没有很好的性能。</p>\n<p>当没有纹理时我们用一个 1x1 像素的白点纹理，这样就不用考虑条件语句了。</p>\n<p>或者，使用不同的着色器。一个带有该特性，一个没有，根据情况选择使用正确的着色器。</p>',
excerpt:"WebGL 三维几何加工 有人问我怎么在 WebGL 中制作一个保龄球瓶，聪明的回答是 。使用它创建一个保龄球瓶，导出，读取点坐标(OBJ…",frontmatter:{date:"2022-06-21 18:20:05",path:"/webgl-fundamental-geometry/",tags:"前端, 可视化, WebGL, 读书笔记",title:"WebGL 理论基础——几何",draft:null}}},pathContext:{mainPostPath:"/webgl-fundamental-light/",nextPostPath:"/ui-introduce-learning/",prePostPath:"/webgl-fundamental-geometry/"}}}});