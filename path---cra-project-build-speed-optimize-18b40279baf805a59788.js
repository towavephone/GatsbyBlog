webpackJsonp([35149704389276],{1205:function(n,s){n.exports={data:{file:{childImageSharp:{sizes:{base64:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAACXBIWXMAAAsSAAALEgHS3X78AAAHlElEQVRIx12We2xT5xXAbcI2Vmn7o1I1uhVYRxL8tuPn9bXv0+/4/YgdOyYkkATCCEEYsqVNC2wCIYQWShmUBFh4hMAWECot0BUtlI4yAS1oKqJQXimsDBgTU8codnLO7r0uUPpJn87Rp+/8vvOdc75zr8xmZmTieI1NykU5yxOfxDncz3NUjAlyDXMjXGMhys+cG+FzGQ8VU4t7XuV8z8m+GUkrJclSqVReYJ0ZWQ8Tl2AdTPhnq9ns2QKd+crDZiHha8NsYCE21HZiXphpb3sxxTf99Tdsw51ldHqFaLOXXyzvYqOyZ0YPk5soylfouuUbvHOxh56JbiqJfi4/FnE1lxKetrGUZ954nbcdU/752ORpxWVsc6mZjPxctFtApeVtra1lmIPwTxClgeCqvGTsX/WWOEbtyTGWSoGbToOPzUHQ1QghVxOEhRniZ5U8XB4TzvTdgj1ZJdq2OOrkGhVRBnrYFum6TiK0l2fr0emMlVxcBhlnEniqDjlBuqg0CnD0MPWiDrwzhR4u+5B3x3WiLUNHJjxzZYvR8ZKTCP+Xo1JoM/nBYvSB1egHuyUIrCOBPj4LtD0KlD2K4h7SGip62aygxzaK9rHA3Aqt2vw0MRYjnyJtYaQdsXG9hgWFwgmVlXZUKUjUqmm0CgfwhA80Kgr1Wg40Sue4SuFEnZq+YjMbJ0kh0zmfemjQ0j2EJYh2a23RVOODIBvHmCsBUaoWLDoWKIsP50bTApxC5QwH1Ghp0Gk4MBk8aDLQEslooCc88VClsK+zGANI2mqLer0XFuea8PSuN+DM7o3QWyhAR7IBfj+vDbyOICS9aSjkZo8nvSlUKuxXLDUOKdN6LSl/AlRUE+vNAnD50l8XeTIEPiYEzXYG5mlNeGz7BvjPpY/g5snDcHxwE+zs7oCh1zvHCrNm48u/ML8j2muVQblBZ3t6ZY2KXKtQcDiwdk1xx9rV0BlqghEuD4fNUTy1Zwhw7Cbioxu461fdsOgFDa5pbh3zu6NifE9f+XCPlGHS5nuaFI3K8brJ4EUHES4WFiyEP2/dCPc2vYH/3NIHePcywP1LWLp3Ec4tWQa3FvbAu7294yqVA801rju5utYfiQyKDD4DnC8GWEhMafJPtBALxuHjo3+C8bufIn59DfHBFcDiDcQvzyF+/iEsbWuDadNMaDW5H7nY6Iyyh165zfLNtdUqIqLTsEJSQqBVUTD1JQPqdRT8sf9NuH7kMHy0fRg+O3EUzp96H/Zs2SBklxFKxwFmowtdTCIoPQx7oKLzl32PPTRPVSudDwQgCrUGL0+twdzsDjjSdwD2J1fh/q7N0N+1EtykB178qVY4lAahRktWkw95JrG4DAxPvHU3Wwb+rlcsHfK0WNxCoMdUCgdUaxnMBPKw7dVe2LyhDw4MboORA4NQOd2CaiUFaqWjZJGAyQGRUeubP8FqElqZspquEBeUM2zrnEQUa3R8USVcp2qGDZV6ErqXL4PfrlwFhSU9cPL4MejfshOsZq90sCg5KvHZ5MnPfa+cmFrxukRFuRZNcYqIoNngHheeFmiF11ClIDBdPwfqG9qhc1E3rF25GnrX90M204JqBfWItPrP8lTqa7vFpSw3GJ9cZjI4pW5TXaWezpKxh4Q5gEY9LwApVOtZMApxVWhd2DKvC7K5FjTUsFCj45Ah4yXaHuz1MBlgyHCb1HXISIXMTcekOJqN1h/72Mx92h5DwuwHjeChWseBQsNgJJ6H944eB5oNgaLajnaL/07E24wuKr7Cz+XuuenUsMioCxYmyHhnSPLQTYVVYVfjI46Mo80WBLMgLY4E1FhCOENBAsfHQG/0juuNPqGguU8ywXas5XNbg6783wJ8w781GtUPJc+irkap/Ufdje0JXytStnDJbA2D1Z4EKxEHsyUMRmsIdcZaNFpCYBYqwWQLPhD3Btn6t2Pe5uF0cD7Sdr/xmSab8racFaDooOvuk0wDEs40EFQGbVQGbEKXJoTPgZ3JoJGIgULvR6M1jE67rzvpae5ojC7GEJ9rfgILc7lC3NV0T6flTtjoPLK+VuD8rcD65gDtaQInPxOtzoxQRrXgD8/BdW/+YezYByfxvfdHvnxl+ZLKCDfzUMIze60Ey+brJukrqcjA1u3tBw8dfZiZuRQFaNFory/WEPUlE5kFK5WDQKRtbFPfUOnChUvFL27cwKuj/8CBHXv2iQw/k/KGuNwyCYiIkhw+sO/569eu7b1+ffR/H5z4BAcG38X1m/biyjX9ODR8GC9dHsXLV0fx5KlzePDIyFd7ht9ZJZhJrcvLhV/wMuUPljQWtC6Z+FjfuWPHlPMXLq64Onpz3d8/Pf9WX//OW2vWbITBof3n3tqya9fbh/7SvW1gZ9Xj/V1dr8kf614qIZONjBwrezi8Ty54K5d9ZzTmF+xe1LnioaD+4Nvrn4/ermif3yHp8UCDLMCky7Z+n192+/YdST9z5mPZ7t1D8ouXv6gQ4S9WTplks7mut8xZijxbKz2vvi2D39/cPyB/HC5xOm2czPvd35F8rkGCS0+I4WXV1QbJaMq06XqbNXCQJIILpH8hOic3GghZMpl62qG/Nf4PRzaQ862MzO4AAAAASUVORK5CYII=",aspectRatio:.6666666666666666,src:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-25c91.png",srcSet:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-8a97b.png 200w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-0fdf3.png 400w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-25c91.png 600w",srcWebp:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-216f6.webp",srcSetWebp:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-5d70e.webp 200w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-d1677.webp 400w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-216f6.webp 600w",sizes:"(max-width: 600px) 100vw, 600px"}}},site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}},mainPost:{html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>由于公司老项目采用 cra 来构建前端项目，在 jenkins 上的平均打包时长在 10 分钟以上，需要优化线上的打包时间，同时优化本地的开发体验</p>\n<h1 id="一期优化"><a href="#%E4%B8%80%E6%9C%9F%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一期优化</h1>\n<p>主要针对 cra + webpack3/4 进行的优化</p>\n<h2 id="具体功能"><a href="#%E5%85%B7%E4%BD%93%E5%8A%9F%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体功能</h2>\n<h3 id="cra-配置优化"><a href="#cra-%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>cra 配置优化</h3>\n<p>核心：thread-loader 加快首次编译速度，hard-source-webpack-plugin 加快二次编译速度</p>\n<p>config-overrides.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25751930907349620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const {\n   override,\n   addBabelPlugins,\n   fixBabelImports,\n   addLessLoader,\n   removeModuleScopePlugin,\n   addWebpackModuleRule,\n   setWebpackOptimizationSplitChunks,\n   addWebpackPlugin,\n   addWebpackAlias\n} = require(\'customize-cra\');\nconst fs = require(\'fs\');\nconst PreloadWebpackPlugin = require(\'preload-webpack-plugin\');\nconst path = require(\'path\');\nconst MonacoWebpackPlugin = require(\'monaco-editor-webpack-plugin\');\nconst WebpackBarPlugin = require(\'webpackbar\');\nconst { get, pick } = require(\'lodash\');\nconst threadLoader = require(\'thread-loader\');\nconst HardSourceWebpackPlugin = require(\'hard-source-webpack-plugin\');\n\nconst packageJson = require(\'./package.json\');\nconst FixHardSourceWebpackPlugin = require(\'./plugins/FixHardSourceWebpackPlugin\');\n// const SpeedMeasurePlugin = require(\'speed-measure-webpack-plugin\')\n// const smp = new SpeedMeasurePlugin()\n\n// 默认开启 hard-source-webpack-plugin 插件，可以传入这个环境变量来主动关闭\nconst { DISABLE_HARD_SOURCE_PLUGIN } = process.env;\n\nthreadLoader.warmup(\n   {\n      // pool options, like passed to loader options\n      // must match loader options to boot the correct pool\n   },\n   [\n      // modules to load\n      // can be any module, i. e.\n      \'babel-loader\'\n   ]\n);\n\n// 打印 webpack 的相关配置，便于调试\nconst craDir = path.join(process.cwd() + \'/.cra\');\n\nif (!fs.existsSync(craDir)) {\n   fs.mkdirSync(craDir);\n}\n\n// 分析打印出的 webpack 相关配置的规律，可以写出此钩子函数，函数签名参考 craco 里面的函数\nconst addBeforeLoaders = (webpackConfig, matchLoader, newLoader = []) => {\n   const matchLoaders = get(webpackConfig, \'module.rules.1.oneOf\', []).filter((item) =>\n      get(item, \'loader\', \'\').includes(matchLoader)\n   );\n   if (matchLoaders.length > 0) {\n      matchLoaders.forEach((item) => {\n         const props = [\'loader\', \'options\'];\n         item.use = [...newLoader, pick(item, props)];\n         props.forEach((item2) => {\n            delete item[item2];\n         });\n      });\n   }\n};\n\n// 这里不能单纯的使用 JSON.stringify，需要特殊处理，否则不能序列化出函数部分\nconst formatConfig = (config) =>\n   JSON.stringify(\n      config,\n      (key, value) => {\n         if (typeof value === \'function\') {\n            return value.toString();\n         }\n         return value;\n      },\n      2\n   );\n\nconst getHardSourceWebpackPlugins = (env) =>\n   !DISABLE_HARD_SOURCE_PLUGIN\n      ? [\n           addWebpackPlugin(\n              new HardSourceWebpackPlugin({\n                 // Either an absolute path or relative to webpack\'s options.context.\n                 cacheDirectory: path.resolve(process.cwd(), \\`node_modules/.cache/hard-source/\\${env}/[confighash]\\`),\n                 // Either a string of object hash function given a webpack config.\n                 configHash: (webpackConfig) => {\n                    // node-object-hash on npm can be used to build this.\n                    // 这里根据 package.json 里面的 dependencies 以及 webpack 配置来决定是否复用缓存\n                    return require(\'node-object-hash\')({ sort: false }).hash({\n                       webpackConfig,\n                       dependencies: packageJson.dependencies\n                    });\n                 },\n                 // Either false, a string, an object, or a project hashing function.\n                 environmentHash: {\n                    root: process.cwd(),\n                    directories: [],\n                    files: []\n                 },\n                 // An object.\n                 info: {\n                    // \'none\' or \'test\'.\n                    mode: \'none\',\n                    // \'debug\', \'log\', \'info\', \'warn\', or \'error\'.\n                    level: \'debug\'\n                 },\n                 // Clean up large, old caches automatically.\n                 cachePrune: {\n                    // Caches younger than \\`maxAge\\` are not considered for deletion. They must\n                    // be at least this (default: 2 days) old in milliseconds.\n                    maxAge: 2 * 24 * 60 * 60 * 1000,\n                    // All caches together must be larger than \\`sizeThreshold\\` before any\n                    // caches will be deleted. Together they must be at least this\n                    // (default: 50 MB) big in bytes.\n                    sizeThreshold: 50 * 1024 * 1024\n                 }\n              })\n           ),\n           env === \'production\' &&\n              // 修复 hard-source-webpack-plugin 插件的各种异常，后面详细说明\n              addWebpackPlugin(\n                 new FixHardSourceWebpackPlugin({\n                    cacheDirectory: path.resolve(process.cwd(), \\`node_modules/.cache/hard-source/\\${env}\\`)\n                 })\n              )\n        ]\n      : [];\n\nmodule.exports = {\n   webpack: (config, env) => {\n      const isProd = env === \'production\';\n\n      const localConfig = override(\n         addBabelPlugins(\n            [\'@babel/plugin-proposal-nullish-coalescing-operator\'],\n            [\'@babel/plugin-syntax-optional-chaining\']\n         ),\n         fixBabelImports(\'import\', {\n            libraryName: \'antd\',\n            libraryDirectory: \'es\',\n            style: true\n         }),\n         addLessLoader({\n            javascriptEnabled: true\n            // modifyVars: { \'@primary-color\': \'#1DA570\' }\n         }),\n         addWebpackAlias({\n            \'@\': path.resolve(__dirname, \'src\')\n         }),\n         removeModuleScopePlugin(),\n         addWebpackModuleRule({\n            // test: /StreamDataWorker\\.js/,\n            test: /(StreamDataWorker|MapDataWorker|FrameProcessWorker)\\.js/,\n            use: { loader: \'worker-loader\', options: { filename: \'worker.[hash].js\' } }\n         }),\n         // TODO 这里不能用 worker.js 后缀，猜测是 oneOf 导致\n         // addWebpackModuleRule({\n         //   test: /\\.worker\\.js\\$/,\n         //   use: { loader: \'worker-loader\' }\n         // }),\n         isProd &&\n            setWebpackOptimizationSplitChunks({\n               cacheGroups: {\n                  vendors: {\n                     minChunks: 2,\n                     test: /[\\\\/]node_modules[\\\\/](?!google-protobuf|@antv|highcharts|mathjs|two\\.js|konva|victory-core)/,\n                     priority: -10,\n                     reuseExistingChunk: true,\n                     name: \'vendors\'\n                  },\n                  default: {\n                     minChunks: 2,\n                     priority: -20,\n                     reuseExistingChunk: true\n                  }\n               }\n            }),\n         // TODO 以下分包策略不是最优解\n         // isProd &&\n         //   setWebpackOptimizationSplitChunks({\n         //     chunks: \'all\',\n         //     maxInitialRequests: 10,\n         //     minSize: 0,\n         //     cacheGroups: {\n         //       vendor: {\n         //         test: module => {\n         //           // 遇到 echarts 相关库时，不要抽出来，以免 echarts 抽出的包很大\n         //           if (/[\\\\/]node_modules[\\\\/](echarts|zrender)/.test(module.context)) {\n         //             return false\n         //           }\n         //           return /[\\\\/]node_modules[\\\\/]/.test(module.context)\n         //         },\n         //         name: module => {\n         //           const packageName = module.context.match(/[\\\\/]node_modules[\\\\/](.*?)([\\\\/]|\\$)/)[1]\n         //           return \\`npm.\\${packageName.replace(\'@\', \'\')}\\`\n         //         }\n         //       }\n         //     }\n         //   }),\n         isProd &&\n            addWebpackPlugin(\n               new PreloadWebpackPlugin({\n                  rel: \'prefetch\',\n                  as: \'script\',\n                  fileBlacklist: [\n                     /\\d{1,2}\\.(\\d?[a-z]?)+\\.chunk\\.js\\$/,\n                     /main\\..+\\.js\\$/,\n                     /\\.css\\$/,\n                     /\\.txt\\$/,\n                     /\\.png\\$/,\n                     /.jpeg\\$/\n                  ],\n                  include: \'allAssets\'\n               })\n            ),\n         addWebpackPlugin(\n            new MonacoWebpackPlugin({\n               languages: [\'json\']\n            })\n         ),\n         // 显示编译进度\n         addWebpackPlugin(new WebpackBarPlugin()),\n         ...getHardSourceWebpackPlugins(env)\n      )(config);\n\n      // 注入 thread-loader\n      addBeforeLoaders(localConfig, \'babel-loader\', [\'thread-loader\']);\n\n      // 限制编译范围\n      localConfig.resolve.extensions = [\'.js\'];\n      localConfig.resolve.mainFields = [\'jsnext:main\', \'main\'];\n      localConfig.resolve.modules = [\'node_modules\'];\n\n      // 本地开发采用更轻量级的 cheap-module-eval-source-map\n      if (!isProd) {\n         localConfig.devtool = \'cheap-module-eval-source-map\';\n      }\n\n      // if (isProd) {\n      //   localConfig.optimization = {\n      //     ...localConfig.optimization,\n      //     nodeEnv: \'production\',\n      //     sideEffects: true,\n      //     concatenateModules: true,\n      //     runtimeChunk: \'single\'\n      //   }\n      // }\n\n      fs.writeFileSync(path.join(craDir, \\`webpack.\\${env}.json\\`), formatConfig(localConfig));\n\n      return localConfig;\n   },\n   devServer: (configFunction) => (proxy, allowedHost) => {\n      const config = configFunction(proxy, allowedHost);\n\n      config.quiet = false;\n\n      // 显示构建耗时\n      config.stats = {\n         errors: true,\n         children: false,\n         warnings: false,\n         colors: true,\n         assets: false,\n         modules: false,\n         entrypoints: false\n      };\n\n      // 关闭 host 检测，以免非 localhost 域名访问时热更新不生效\n      config.disableHostCheck = true;\n\n      fs.writeFileSync(path.join(craDir, \'webpack-dev-server.json\'), formatConfig(config));\n\n      return config;\n   }\n};`, `25751930907349620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span>\n   override<span class="token punctuation">,</span>\n   addBabelPlugins<span class="token punctuation">,</span>\n   fixBabelImports<span class="token punctuation">,</span>\n   addLessLoader<span class="token punctuation">,</span>\n   removeModuleScopePlugin<span class="token punctuation">,</span>\n   addWebpackModuleRule<span class="token punctuation">,</span>\n   setWebpackOptimizationSplitChunks<span class="token punctuation">,</span>\n   addWebpackPlugin<span class="token punctuation">,</span>\n   addWebpackAlias\n<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'customize-cra\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> PreloadWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'preload-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> MonacoWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'monaco-editor-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> WebpackBarPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpackbar\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">,</span> pick <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> threadLoader <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'thread-loader\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> HardSourceWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'hard-source-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> packageJson <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./package.json\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> FixHardSourceWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./plugins/FixHardSourceWebpackPlugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// const SpeedMeasurePlugin = require(\'speed-measure-webpack-plugin\')</span>\n<span class="token comment">// const smp = new SpeedMeasurePlugin()</span>\n\n<span class="token comment">// 默认开启 hard-source-webpack-plugin 插件，可以传入这个环境变量来主动关闭</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">DISABLE_HARD_SOURCE_PLUGIN</span> <span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">;</span>\n\nthreadLoader<span class="token punctuation">.</span><span class="token function">warmup</span><span class="token punctuation">(</span>\n   <span class="token punctuation">{</span>\n      <span class="token comment">// pool options, like passed to loader options</span>\n      <span class="token comment">// must match loader options to boot the correct pool</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token punctuation">[</span>\n      <span class="token comment">// modules to load</span>\n      <span class="token comment">// can be any module, i. e.</span>\n      <span class="token string">\'babel-loader\'</span>\n   <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 打印 webpack 的相关配置，便于调试</span>\n<span class="token keyword">const</span> craDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">\'/.cra\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>craDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>craDir<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 分析打印出的 webpack 相关配置的规律，可以写出此钩子函数，函数签名参考 craco 里面的函数</span>\n<span class="token keyword">const</span> <span class="token function-variable function">addBeforeLoaders</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">webpackConfig<span class="token punctuation">,</span> matchLoader<span class="token punctuation">,</span> newLoader <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> matchLoaders <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">,</span> <span class="token string">\'module.rules.1.oneOf\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n      <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'loader\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>matchLoader<span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>matchLoaders<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      matchLoaders<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'loader\'</span><span class="token punctuation">,</span> <span class="token string">\'options\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n         item<span class="token punctuation">.</span>use <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>newLoader<span class="token punctuation">,</span> <span class="token function">pick</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n         props<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">delete</span> item<span class="token punctuation">[</span>item2<span class="token punctuation">]</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 这里不能单纯的使用 JSON.stringify，需要特殊处理，否则不能序列化出函数部分</span>\n<span class="token keyword">const</span> <span class="token function-variable function">formatConfig</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>\n      config<span class="token punctuation">,</span>\n      <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">\'function\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         <span class="token keyword">return</span> value<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token number">2</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">getHardSourceWebpackPlugins</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">env</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   <span class="token operator">!</span><span class="token constant">DISABLE_HARD_SOURCE_PLUGIN</span>\n      <span class="token operator">?</span> <span class="token punctuation">[</span>\n           <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n              <span class="token keyword">new</span> <span class="token class-name">HardSourceWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                 <span class="token comment">// Either an absolute path or relative to webpack\'s options.context.</span>\n                 cacheDirectory<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">node_modules/.cache/hard-source/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>env<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/[confighash]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                 <span class="token comment">// Either a string of object hash function given a webpack config.</span>\n                 <span class="token function-variable function">configHash</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">webpackConfig</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                    <span class="token comment">// node-object-hash on npm can be used to build this.</span>\n                    <span class="token comment">// 这里根据 package.json 里面的 dependencies 以及 webpack 配置来决定是否复用缓存</span>\n                    <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'node-object-hash\'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span> sort<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                       webpackConfig<span class="token punctuation">,</span>\n                       dependencies<span class="token punctuation">:</span> packageJson<span class="token punctuation">.</span>dependencies\n                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                 <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                 <span class="token comment">// Either false, a string, an object, or a project hashing function.</span>\n                 environmentHash<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                    root<span class="token punctuation">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                    directories<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n                    files<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n                 <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                 <span class="token comment">// An object.</span>\n                 info<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                    <span class="token comment">// \'none\' or \'test\'.</span>\n                    mode<span class="token punctuation">:</span> <span class="token string">\'none\'</span><span class="token punctuation">,</span>\n                    <span class="token comment">// \'debug\', \'log\', \'info\', \'warn\', or \'error\'.</span>\n                    level<span class="token punctuation">:</span> <span class="token string">\'debug\'</span>\n                 <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                 <span class="token comment">// Clean up large, old caches automatically.</span>\n                 cachePrune<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                    <span class="token comment">// Caches younger than `maxAge` are not considered for deletion. They must</span>\n                    <span class="token comment">// be at least this (default: 2 days) old in milliseconds.</span>\n                    maxAge<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span>\n                    <span class="token comment">// All caches together must be larger than `sizeThreshold` before any</span>\n                    <span class="token comment">// caches will be deleted. Together they must be at least this</span>\n                    <span class="token comment">// (default: 50 MB) big in bytes.</span>\n                    sizeThreshold<span class="token punctuation">:</span> <span class="token number">50</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span>\n                 <span class="token punctuation">}</span>\n              <span class="token punctuation">}</span><span class="token punctuation">)</span>\n           <span class="token punctuation">)</span><span class="token punctuation">,</span>\n           env <span class="token operator">===</span> <span class="token string">\'production\'</span> <span class="token operator">&amp;&amp;</span>\n              <span class="token comment">// 修复 hard-source-webpack-plugin 插件的各种异常，后面详细说明</span>\n              <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n                 <span class="token keyword">new</span> <span class="token class-name">FixHardSourceWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                    cacheDirectory<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">node_modules/.cache/hard-source/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>env<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n                 <span class="token punctuation">}</span><span class="token punctuation">)</span>\n              <span class="token punctuation">)</span>\n        <span class="token punctuation">]</span>\n      <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   <span class="token function-variable function">webpack</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">config<span class="token punctuation">,</span> env</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> isProd <span class="token operator">=</span> env <span class="token operator">===</span> <span class="token string">\'production\'</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> localConfig <span class="token operator">=</span> <span class="token function">override</span><span class="token punctuation">(</span>\n         <span class="token function">addBabelPlugins</span><span class="token punctuation">(</span>\n            <span class="token punctuation">[</span><span class="token string">\'@babel/plugin-proposal-nullish-coalescing-operator\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            <span class="token punctuation">[</span><span class="token string">\'@babel/plugin-syntax-optional-chaining\'</span><span class="token punctuation">]</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">fixBabelImports</span><span class="token punctuation">(</span><span class="token string">\'import\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n            libraryName<span class="token punctuation">:</span> <span class="token string">\'antd\'</span><span class="token punctuation">,</span>\n            libraryDirectory<span class="token punctuation">:</span> <span class="token string">\'es\'</span><span class="token punctuation">,</span>\n            style<span class="token punctuation">:</span> <span class="token boolean">true</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addLessLoader</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            javascriptEnabled<span class="token punctuation">:</span> <span class="token boolean">true</span>\n            <span class="token comment">// modifyVars: { \'@primary-color\': \'#1DA570\' }</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackAlias</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token string">\'@\'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'src\'</span><span class="token punctuation">)</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">removeModuleScopePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackModuleRule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token comment">// test: /StreamDataWorker\\.js/,</span>\n            test<span class="token punctuation">:</span> <span class="token regex">/(StreamDataWorker|MapDataWorker|FrameProcessWorker)\\.js/</span><span class="token punctuation">,</span>\n            use<span class="token punctuation">:</span> <span class="token punctuation">{</span> loader<span class="token punctuation">:</span> <span class="token string">\'worker-loader\'</span><span class="token punctuation">,</span> options<span class="token punctuation">:</span> <span class="token punctuation">{</span> filename<span class="token punctuation">:</span> <span class="token string">\'worker.[hash].js\'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token comment">// TODO 这里不能用 worker.js 后缀，猜测是 oneOf 导致</span>\n         <span class="token comment">// addWebpackModuleRule({</span>\n         <span class="token comment">//   test: /\\.worker\\.js$/,</span>\n         <span class="token comment">//   use: { loader: \'worker-loader\' }</span>\n         <span class="token comment">// }),</span>\n         isProd <span class="token operator">&amp;&amp;</span>\n            <span class="token function">setWebpackOptimizationSplitChunks</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               cacheGroups<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                  vendors<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                     minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n                     test<span class="token punctuation">:</span> <span class="token regex">/[\\\\/]node_modules[\\\\/](?!google-protobuf|@antv|highcharts|mathjs|two\\.js|konva|victory-core)/</span><span class="token punctuation">,</span>\n                     priority<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span>\n                     reuseExistingChunk<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n                     name<span class="token punctuation">:</span> <span class="token string">\'vendors\'</span>\n                  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                  <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                     minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n                     priority<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span>\n                     reuseExistingChunk<span class="token punctuation">:</span> <span class="token boolean">true</span>\n                  <span class="token punctuation">}</span>\n               <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token comment">// TODO 以下分包策略不是最优解</span>\n         <span class="token comment">// isProd &amp;&amp;</span>\n         <span class="token comment">//   setWebpackOptimizationSplitChunks({</span>\n         <span class="token comment">//     chunks: \'all\',</span>\n         <span class="token comment">//     maxInitialRequests: 10,</span>\n         <span class="token comment">//     minSize: 0,</span>\n         <span class="token comment">//     cacheGroups: {</span>\n         <span class="token comment">//       vendor: {</span>\n         <span class="token comment">//         test: module => {</span>\n         <span class="token comment">//           // 遇到 echarts 相关库时，不要抽出来，以免 echarts 抽出的包很大</span>\n         <span class="token comment">//           if (/[\\\\/]node_modules[\\\\/](echarts|zrender)/.test(module.context)) {</span>\n         <span class="token comment">//             return false</span>\n         <span class="token comment">//           }</span>\n         <span class="token comment">//           return /[\\\\/]node_modules[\\\\/]/.test(module.context)</span>\n         <span class="token comment">//         },</span>\n         <span class="token comment">//         name: module => {</span>\n         <span class="token comment">//           const packageName = module.context.match(/[\\\\/]node_modules[\\\\/](.*?)([\\\\/]|$)/)[1]</span>\n         <span class="token comment">//           return `npm.${packageName.replace(\'@\', \'\')}`</span>\n         <span class="token comment">//         }</span>\n         <span class="token comment">//       }</span>\n         <span class="token comment">//     }</span>\n         <span class="token comment">//   }),</span>\n         isProd <span class="token operator">&amp;&amp;</span>\n            <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n               <span class="token keyword">new</span> <span class="token class-name">PreloadWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                  rel<span class="token punctuation">:</span> <span class="token string">\'prefetch\'</span><span class="token punctuation">,</span>\n                  <span class="token keyword">as</span><span class="token punctuation">:</span> <span class="token string">\'script\'</span><span class="token punctuation">,</span>\n                  fileBlacklist<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n                     <span class="token regex">/\\d{1,2}\\.(\\d?[a-z]?)+\\.chunk\\.js$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/main\\..+\\.js$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/\\.css$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/\\.txt$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/\\.png$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/.jpeg$/</span>\n                  <span class="token punctuation">]</span><span class="token punctuation">,</span>\n                  include<span class="token punctuation">:</span> <span class="token string">\'allAssets\'</span>\n               <span class="token punctuation">}</span><span class="token punctuation">)</span>\n            <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n            <span class="token keyword">new</span> <span class="token class-name">MonacoWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               languages<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'json\'</span><span class="token punctuation">]</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token comment">// 显示编译进度</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebpackBarPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token operator">...</span><span class="token function">getHardSourceWebpackPlugins</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 注入 thread-loader</span>\n      <span class="token function">addBeforeLoaders</span><span class="token punctuation">(</span>localConfig<span class="token punctuation">,</span> <span class="token string">\'babel-loader\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'thread-loader\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 限制编译范围</span>\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>extensions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'.js\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>mainFields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'jsnext:main\'</span><span class="token punctuation">,</span> <span class="token string">\'main\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'node_modules\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 本地开发采用更轻量级的 cheap-module-eval-source-map</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>devtool <span class="token operator">=</span> <span class="token string">\'cheap-module-eval-source-map\'</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// if (isProd) {</span>\n      <span class="token comment">//   localConfig.optimization = {</span>\n      <span class="token comment">//     ...localConfig.optimization,</span>\n      <span class="token comment">//     nodeEnv: \'production\',</span>\n      <span class="token comment">//     sideEffects: true,</span>\n      <span class="token comment">//     concatenateModules: true,</span>\n      <span class="token comment">//     runtimeChunk: \'single\'</span>\n      <span class="token comment">//   }</span>\n      <span class="token comment">// }</span>\n\n      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>craDir<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">webpack.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>env<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.json</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">formatConfig</span><span class="token punctuation">(</span>localConfig<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> localConfig<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token function-variable function">devServer</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">configFunction</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">proxy<span class="token punctuation">,</span> allowedHost</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">configFunction</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> allowedHost<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      config<span class="token punctuation">.</span>quiet <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 显示构建耗时</span>\n      config<span class="token punctuation">.</span>stats <span class="token operator">=</span> <span class="token punctuation">{</span>\n         errors<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n         children<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n         warnings<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n         colors<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n         assets<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n         modules<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n         entrypoints<span class="token punctuation">:</span> <span class="token boolean">false</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 关闭 host 检测，以免非 localhost 域名访问时热更新不生效</span>\n      config<span class="token punctuation">.</span>disableHostCheck <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n\n      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>craDir<span class="token punctuation">,</span> <span class="token string">\'webpack-dev-server.json\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">formatConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> config<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="dockerfile-配置缓存优化"><a href="#dockerfile-%E9%85%8D%E7%BD%AE%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dockerfile 配置缓存优化</h3>\n<h4 id="需求背景-1"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>为了充分利用缓存，采用 docker 的缓存策略</p>\n<h4 id="背景知识"><a href="#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景知识</h4>\n<p><a href="/docker-introduce-learning/">Docker 入门学习</a></p>\n<h4 id="第一版"><a href="#%E7%AC%AC%E4%B8%80%E7%89%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第一版</h4>\n<p>这里的主要问题在于一旦改了源码需要编译的时候，缓存失效了</p>\n<p>原因是标红行部分复制了文件，再进行构建的时候，因为已经是新的文件了，所以这里 build 的时候不能使用缓存</p>\n<p>Dockerfile-client</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28313985688854503000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`FROM node:14-alpine as builder\n\n# 全局安装依赖，尽量写在一行防止加了新库之后还是使用原来的镜像\nRUN npm config set registry https://registry.npmmirror.com\n\nWORKDIR /home/\n\n# 缓存 package.json pnpm-lock.yaml，只有变更的时候才会重新 install\nCOPY package.json package-lock.json ./\n# 安装依赖\nRUN npm i\n\n# 复制剩余文件\nCOPY . .\n\nRUN ls && npm run build && ls\n\nFROM nginx:alpine\nCOPY --from=builder /home/build /usr/share/nginx/html/\nCOPY nginx.conf /etc/nginx/conf.d/default.conf\n\nEXPOSE 3000`, `28313985688854503000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile{14}"\n              >\n                <span class="gatsby-code-button-language">dockerfile{14}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>14<span class="token punctuation">-</span>alpine as builder\n\n<span class="token comment"># 全局安装依赖，尽量写在一行防止加了新库之后还是使用原来的镜像</span>\n<span class="token keyword">RUN</span> npm config set registry https<span class="token punctuation">:</span>//registry.npmmirror.com\n\n<span class="token keyword">WORKDIR</span> /home/\n\n<span class="token comment"># 缓存 package.json pnpm-lock.yaml，只有变更的时候才会重新 install</span>\n<span class="token keyword">COPY</span> package.json package<span class="token punctuation">-</span>lock.json ./\n<span class="token comment"># 安装依赖</span>\n<span class="token keyword">RUN</span> npm i\n\n<span class="token comment"># 复制剩余文件</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">COPY</span> . .</span>\n<span class="token keyword">RUN</span> ls &amp;&amp; npm run build &amp;&amp; ls\n\n<span class="token keyword">FROM</span> nginx<span class="token punctuation">:</span>alpine\n<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>from=builder /home/build /usr/share/nginx/html/\n<span class="token keyword">COPY</span> nginx.conf /etc/nginx/conf.d/default.conf\n\n<span class="token keyword">EXPOSE</span> 3000</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="第二版"><a href="#%E7%AC%AC%E4%BA%8C%E7%89%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第二版</h4>\n<p>由于第一版的问题，所以需要想办法在 build 过程中也要尽可能的使用缓存</p>\n<p>这里由于缓存容易损坏（由上面提到的 hard-source-webpack-plugin 造成），需要给缓存一个版本的概念，同时也要控制是否使用缓存</p>\n<p>Dockerfile-client-buildkit</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47653324276773315000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# syntax = docker/dockerfile:experimental\n\nFROM node:14-alpine as builder\n\nARG registry=https://registry.npmmirror.com\n\n# 全局安装依赖，尽量写在一行防止加了新库之后还是使用原来的镜像\nRUN npm config set registry \\${registry} -g && npm i -g pnpm\n\nWORKDIR /home/\n\n# 缓存 pnpm-lock.yaml\nCOPY pnpm-lock.yaml ./\n\n# 下载依赖到全局位置\nRUN pnpm fetch --prod\n\n# 复制剩余文件\nCOPY . .\n\n# 安装依赖同时读写缓存\nRUN --mount=type=cache,target=node_modules,id=frontend_node_modules,sharing=locked \\\n    --mount=type=cache,target=/root/.npm,id=npm_cache \\\n    pnpm i --ignore-scripts=true --prod --offline --registry=\\$registry\n\n# build 并读写缓存\nRUN --mount=type=cache,target=node_modules,id=frontend_node_modules,sharing=locked \\\n    pnpm build\n\n# 以下是二阶段\nFROM nginx:alpine\n\nRUN --mount=type=bind,target=/tmp/build,from=builder,source=/home/build \\\n    cp -r /tmp/build/* /usr/share/nginx/html/\n\nCOPY nginx.conf /etc/nginx/conf.d/default.conf\n\nEXPOSE 3000`, `47653324276773315000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># syntax = docker/dockerfile:experimental</span>\n\n<span class="token keyword">FROM</span> node<span class="token punctuation">:</span>14<span class="token punctuation">-</span>alpine as builder\n\n<span class="token keyword">ARG</span> registry=https<span class="token punctuation">:</span>//registry.npmmirror.com\n\n<span class="token comment"># 全局安装依赖，尽量写在一行防止加了新库之后还是使用原来的镜像</span>\n<span class="token keyword">RUN</span> npm config set registry $<span class="token punctuation">{</span>registry<span class="token punctuation">}</span> <span class="token punctuation">-</span>g &amp;&amp; npm i <span class="token punctuation">-</span>g pnpm\n\n<span class="token keyword">WORKDIR</span> /home/\n\n<span class="token comment"># 缓存 pnpm-lock.yaml</span>\n<span class="token keyword">COPY</span> pnpm<span class="token punctuation">-</span>lock.yaml ./\n\n<span class="token comment"># 下载依赖到全局位置</span>\n<span class="token keyword">RUN</span> pnpm fetch <span class="token punctuation">-</span><span class="token punctuation">-</span>prod\n\n<span class="token comment"># 复制剩余文件</span>\n<span class="token keyword">COPY</span> . .\n\n<span class="token comment"># 安装依赖同时读写缓存</span>\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=node_modules<span class="token punctuation">,</span>id=frontend_node_modules<span class="token punctuation">,</span>sharing=locked \\\n    <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=/root/.npm<span class="token punctuation">,</span>id=npm_cache \\\n    pnpm i <span class="token punctuation">-</span><span class="token punctuation">-</span>ignore<span class="token punctuation">-</span>scripts=true <span class="token punctuation">-</span><span class="token punctuation">-</span>prod <span class="token punctuation">-</span><span class="token punctuation">-</span>offline <span class="token punctuation">-</span><span class="token punctuation">-</span>registry=$registry\n\n<span class="token comment"># build 并读写缓存</span>\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=node_modules<span class="token punctuation">,</span>id=frontend_node_modules<span class="token punctuation">,</span>sharing=locked \\\n    pnpm build\n\n<span class="token comment"># 以下是二阶段</span>\n<span class="token keyword">FROM</span> nginx<span class="token punctuation">:</span>alpine\n\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=bind<span class="token punctuation">,</span>target=/tmp/build<span class="token punctuation">,</span>from=builder<span class="token punctuation">,</span>source=/home/build \\\n    cp <span class="token punctuation">-</span>r /tmp/build/* /usr/share/nginx/html/\n\n<span class="token keyword">COPY</span> nginx.conf /etc/nginx/conf.d/default.conf\n\n<span class="token keyword">EXPOSE</span> 3000</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最终采用第二版，同时为了减少构建上下文，需要添加如下的文件</p>\n<p>.dockerignore</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3573755855336058400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`*\n# 静态文件\n!public\n# 为了兼容老版本的 jenkins 不报错，实际上不该加\n!build\n\n# 源码\n!src\n\n# 构建相关\n!.env.production\n!config-overrides.js\n!plugins\n!scripts\n\n# 依赖库\n!package.json\n!pnpm-lock.yaml\n\n# nginx\n!nginx.conf`, `3573755855336058400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile"\n              >\n                <span class="gatsby-code-button-language">dockerfile</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile">*\n<span class="token comment"># 静态文件</span>\n!public\n<span class="token comment"># 为了兼容老版本的 jenkins 不报错，实际上不该加</span>\n!build\n\n<span class="token comment"># 源码</span>\n!src\n\n<span class="token comment"># 构建相关</span>\n!.env.production\n!config<span class="token punctuation">-</span>overrides.js\n!plugins\n!scripts\n\n<span class="token comment"># 依赖库</span>\n!package.json\n!pnpm<span class="token punctuation">-</span>lock.yaml\n\n<span class="token comment"># nginx</span>\n!nginx.conf</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="调用"><a href="#%E8%B0%83%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>调用</h4>\n<ol>\n<li><code class="language-text">BUILDKIT_CACHE_MOUNT_NS</code> 就类似于缓存版本的概念</li>\n<li>可以传入 <code class="language-text">--no-cache</code> 来控制不使用缓存，默认使用（这里的 docker 18 版本的 <code class="language-text">--no-cache</code> 不对 <code class="language-text">type=cache</code> 生效，20 版本的反而生效）</li>\n<li>以上 2 个参数可以配合 jenkins 来控制</li>\n</ol>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31353524430622028000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n   &quot;scripts&quot;: {\n      &quot;build&quot;: &quot;node scripts/build.js&quot;,\n      &quot;docker:build&quot;: &quot;DOCKER_BUILDKIT=1 docker build --build-arg=BUILDKIT_CACHE_MOUNT_NS=tbtu --network=host -t frontend -f ./Dockerfile-client-buildkit .&quot;,\n      &quot;docker:run&quot;: &quot;docker run -it -p 3000:3000 --rm frontend&quot;,\n      &quot;docker:start&quot;: &quot;npm run docker:build && npm run docker:run&quot;\n   }\n}`, `31353524430622028000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n   <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"node scripts/build.js"</span><span class="token punctuation">,</span>\n      <span class="token property">"docker:build"</span><span class="token operator">:</span> <span class="token string">"DOCKER_BUILDKIT=1 docker build --build-arg=BUILDKIT_CACHE_MOUNT_NS=tbtu --network=host -t frontend -f ./Dockerfile-client-buildkit ."</span><span class="token punctuation">,</span>\n      <span class="token property">"docker:run"</span><span class="token operator">:</span> <span class="token string">"docker run -it -p 3000:3000 --rm frontend"</span><span class="token punctuation">,</span>\n      <span class="token property">"docker:start"</span><span class="token operator">:</span> <span class="token string">"npm run docker:build &amp;&amp; npm run docker:run"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="npm-切换到-pnpm"><a href="#npm-%E5%88%87%E6%8D%A2%E5%88%B0-pnpm" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>npm 切换到 pnpm</h3>\n<h4 id="需求背景-2"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>在公司的 jenkins 平台上打包时发现 npm install 的过程特别慢，主要是老项目的依赖库太多，故考虑转向安装速度更快的 pnpm</p>\n<h4 id="实现方式"><a href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现方式</h4>\n<ol>\n<li>因为老项目里面已有 package-lock.json，所以通过 <code class="language-text">pnpm import</code> 可以实现一键迁移，当然有些三方库使用错误导致白屏，这些库需要特殊处理</li>\n<li>配合上面的 dockerfile 可实现深度缓存</li>\n<li>由于上面提到的是否使用缓存一部分是由 package.json 里面的 dependencies 决定，所以需要规范 dependencies 的用法</li>\n</ol>\n<h3 id="npm-install-校验命令"><a href="#npm-install-%E6%A0%A1%E9%AA%8C%E5%91%BD%E4%BB%A4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>npm install 校验命令</h3>\n<h4 id="需求背景-3"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>为了统一库的安装工具，防止团队成员使用别的库安装工具</p>\n<h4 id="实现方式-1"><a href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现方式</h4>\n<ol>\n<li>通过 volta 限制只能使用 pnpm（截止 2022-11-21 11:21:42 <a href="https://github.com/volta-cli/volta/issues/737" target="_blank" rel="nofollow noreferrer noopener">不支持 pnpm</a>）</li>\n<li>手动写 hook 脚本</li>\n</ol>\n<p>最终 2 种方式都采用</p>\n<h4 id="volta"><a href="#volta" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>volta</h4>\n<p>安装过程见 <a href="/frontend-devlopment-environment-setting/#volta">volta</a></p>\n<p>同时在 package.json 加如下几行，这样切入项目目录就会自动切换构建工具</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36337134966096230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n   &quot;volta&quot;: {\n      &quot;node&quot;: &quot;14.20.0&quot;,\n      &quot;pnpm&quot;: &quot;7.14.1&quot;\n   }\n}`, `36337134966096230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n   <span class="token property">"volta"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"node"</span><span class="token operator">:</span> <span class="token string">"14.20.0"</span><span class="token punctuation">,</span>\n      <span class="token property">"pnpm"</span><span class="token operator">:</span> <span class="token string">"7.14.1"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="hook-脚本"><a href="#hook-%E8%84%9A%E6%9C%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>hook 脚本</h4>\n<p>scripts/node-check-version.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2821052042912231000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const { exec } = require(\'child_process\');\nexec(\'node -v\', (err, stdout) => {\n   if (err) throw err;\n   if (parseInt(stdout.slice(1)) !== 14) {\n      // NOTE: This can happen if you have a dependency which lists an old version of npm in its own dependencies.\n      throw new Error(\\`[ERROR] You need node version @=14 but you have \\${stdout}\\`);\n   }\n});`, `2821052042912231000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> exec <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'child_process\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">\'node -v\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stdout</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>stdout<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token number">14</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// NOTE: This can happen if you have a dependency which lists an old version of npm in its own dependencies.</span>\n      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[ERROR] You need node version @=14 but you have </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>stdout<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>scripts/only-allow.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43411234011431320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const pmFromUserAgent = (userAgent) => {\n   const pmSpec = userAgent.split(\' \')[0];\n   const separatorPos = pmSpec.lastIndexOf(\'/\');\n   return {\n      name: pmSpec.substr(0, separatorPos),\n      version: pmSpec.substr(separatorPos + 1)\n   };\n};\n\nif (!process.env.npm_config_user_agent) {\n   throw new Error(\'[ERROR] Please check your npm!\');\n}\n\nconst [name, version] = process.argv.slice(2);\n\nconst pm = pmFromUserAgent(process.env.npm_config_user_agent);\n\nif (name !== pm.name) {\n   const errors = [\\`[ERROR] You need \\${name}\\`];\n\n   const urlMap = {\n      pnpm: \'https://pnpm.js.org/\',\n      yarn: \'https://yarnpkg.com/\'\n   };\n\n   if (urlMap[name]) {\n      errors.push(\\`Please go to \\${urlMap[name]}\\`);\n   }\n\n   throw new Error(errors.join(\', \'));\n}\n\nif (parseFloat(pm.version) < version) {\n   throw new Error(\\`[ERROR] You need \\${name} version @>=\\${version} but you have \\${pm.version}\\`);\n}`, `43411234011431320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">pmFromUserAgent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">userAgent</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> pmSpec <span class="token operator">=</span> userAgent<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\' \'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> separatorPos <span class="token operator">=</span> pmSpec<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> <span class="token punctuation">{</span>\n      name<span class="token punctuation">:</span> pmSpec<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> separatorPos<span class="token punctuation">)</span><span class="token punctuation">,</span>\n      version<span class="token punctuation">:</span> pmSpec<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>separatorPos <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>npm_config_user_agent<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'[ERROR] Please check your npm!\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> version<span class="token punctuation">]</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> pm <span class="token operator">=</span> <span class="token function">pmFromUserAgent</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>npm_config_user_agent<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">!==</span> pm<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[ERROR] You need </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> urlMap <span class="token operator">=</span> <span class="token punctuation">{</span>\n      pnpm<span class="token punctuation">:</span> <span class="token string">\'https://pnpm.js.org/\'</span><span class="token punctuation">,</span>\n      yarn<span class="token punctuation">:</span> <span class="token string">\'https://yarnpkg.com/\'</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>urlMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Please go to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>urlMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\', \'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">parseFloat</span><span class="token punctuation">(</span>pm<span class="token punctuation">.</span>version<span class="token punctuation">)</span> <span class="token operator">&lt;</span> version<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[ERROR] You need </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> version @>=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> but you have </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pm<span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75714071722269930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n   &quot;scripts&quot;: {\n      &quot;preinstall&quot;: &quot;npm run verify-version&quot;,\n      &quot;node-check-version&quot;: &quot;node scripts/node-check-version.js&quot;,\n      &quot;only-allow&quot;: &quot;node scripts/only-allow.js pnpm 7&quot;,\n      &quot;pnpm:devPreinstall&quot;: &quot;npm run verify-version&quot;,\n      &quot;verify-version&quot;: &quot;npm run node-check-version && npm run only-allow&quot;\n   }\n}`, `75714071722269930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n   <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"preinstall"</span><span class="token operator">:</span> <span class="token string">"npm run verify-version"</span><span class="token punctuation">,</span>\n      <span class="token property">"node-check-version"</span><span class="token operator">:</span> <span class="token string">"node scripts/node-check-version.js"</span><span class="token punctuation">,</span>\n      <span class="token property">"only-allow"</span><span class="token operator">:</span> <span class="token string">"node scripts/only-allow.js pnpm 7"</span><span class="token punctuation">,</span>\n      <span class="token property">"pnpm:devPreinstall"</span><span class="token operator">:</span> <span class="token string">"npm run verify-version"</span><span class="token punctuation">,</span>\n      <span class="token property">"verify-version"</span><span class="token operator">:</span> <span class="token string">"npm run node-check-version &amp;&amp; npm run only-allow"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里要注意，由于 pnpm 下的 preinstall 是 install 后才执行的，所以增加了 <code class="language-text">pnpm:devPreinstall</code>，同时生产环境通过添加 <code class="language-text">--ignore-scripts=true</code> 参数不运行此钩子</p>\n<p>以上就可以限制只能通过 pnpm 来进行 install（以上脚本还限制了版本）</p>\n<h3 id="hard-source-webpack-plugin-的线上修复"><a href="#hard-source-webpack-plugin-%E7%9A%84%E7%BA%BF%E4%B8%8A%E4%BF%AE%E5%A4%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>hard-source-webpack-plugin 的线上修复</h3>\n<h4 id="需求背景-4"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>在使用了 hard-source-webpack-plugin 作缓存加速时，有以下比较明显的问题</p>\n<ol>\n<li>二次编译有时不能正常停止</li>\n<li>二次编译会出现各种编译报错，清空缓存后重新编译却正常</li>\n</ol>\n<h4 id="实现方式-2"><a href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现方式</h4>\n<p>针对以上问题，有以下解决方式</p>\n<ol>\n<li>二次编译时识别到 done 即编译完成，此时调用 <code class="language-text">process.exit(0)</code> 手动结束</li>\n<li>二次编译时一旦编译报错则认为是缓存损坏，此时清空缓存，重启 build 命令</li>\n</ol>\n<p>scripts/const.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16862900599883979000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const CACHE_ERROR_CODE = 10;\n\nmodule.exports = {\n   CACHE_ERROR_CODE\n};`, `16862900599883979000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token constant">CACHE_ERROR_CODE</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   <span class="token constant">CACHE_ERROR_CODE</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>scripts/build.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9336401171700960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const child_process = require(\'child_process\');\n\nconst { CACHE_ERROR_CODE } = require(\'./const\');\n\nfunction spawn(mainModule) {\n   const worker = child_process.spawn(\'react-app-rewired\', mainModule, {\n      stdio: \'inherit\'\n   });\n\n   worker.on(\'exit\', function(code) {\n      // 接受到缓存损坏信号，重启命令\n      if (code === CACHE_ERROR_CODE) {\n         spawn(mainModule);\n         // 除了正常停止的 0 外，其他错误码均认为异常\n      } else if (code !== 0) {\n         process.exit(1);\n      }\n   });\n}\n\nspawn([\'--max-old-space-size=4096\', \'build\']);`, `9336401171700960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> child_process <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'child_process\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">CACHE_ERROR_CODE</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./const\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token parameter">mainModule</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> worker <span class="token operator">=</span> child_process<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">\'react-app-rewired\'</span><span class="token punctuation">,</span> mainModule<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      stdio<span class="token punctuation">:</span> <span class="token string">\'inherit\'</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'exit\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 接受到缓存损坏信号，重启命令</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">===</span> <span class="token constant">CACHE_ERROR_CODE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token function">spawn</span><span class="token punctuation">(</span>mainModule<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token comment">// 除了正常停止的 0 外，其他错误码均认为异常</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">spawn</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'--max-old-space-size=4096\'</span><span class="token punctuation">,</span> <span class="token string">\'build\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>plugins/FixHardSourceWebpackPlugin.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20260701042001130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const rimraf = require(\'rimraf\');\nconst { get } = require(\'lodash\');\nconst { CACHE_ERROR_CODE } = require(\'../scripts/const\');\n\nclass FixHardSourceWebpackPlugin {\n   constructor(options) {\n      this.options = options || {};\n      // 是否读取了上次的缓存\n      this.cacheRead = false;\n   }\n\n   apply(compiler) {\n      compiler.hooks.hardSourceLog.tap(\'hardSourceLog\', (message) => {\n         // eslint-disable-next-line no-useless-call\n         // console[message.level].call(console, message)\n\n         const id = get(message, \'data.id\');\n\n         if (id === \'confighash--reused\') {\n            this.cacheRead = true;\n         }\n      });\n\n      const handleClearCache = () => {\n         // 第一次生成缓存的时候，如果编译失败则判定缓存无效，清空缓存，退出命令\n         // 第二次读缓存的情况下，如果编译失败则判定缓存无效，清空缓存，重启命令\n         const { cacheDirectory } = this.options;\n         console.log(\'[FixHardSourceWebpackPlugin] Clearing Cache\', cacheDirectory);\n         rimraf.sync(cacheDirectory);\n         console.log(\'[FixHardSourceWebpackPlugin] Cache Cleared\');\n         if (this.cacheRead) {\n            console.log(\'[FixHardSourceWebpackPlugin] Restarting...\');\n            process.exit(CACHE_ERROR_CODE);\n         }\n      };\n\n      // 找不到具体的模块时会调用，比如随便导入一个不存在的模块\n      // import Atmp from \'./fake\'，且代码里面用到 Atmp 组件（这里的 fake 根本不存在）\n      compiler.hooks.failed.tap(\'FixHardSourceWebpack Cache Error\', () => {\n         console.log(\'[FixHardSourceWebpackPlugin] Invoke Failed\');\n         handleClearCache();\n      });\n\n      // 导出一个不存在的模块并使用时会调用\n      // import { Atmp } from \'./fake\' 且代码里面用到 Atmp 组件（实际上 Atmp 是不存在的组件）\n      compiler.hooks.done.tap(\'FixHardSourceWebpack Cache Error\', (stats) => {\n         const hasErrors = stats.hasErrors();\n         if (!hasErrors) {\n            return;\n         }\n         console.log(\'[FixHardSourceWebpackPlugin] Invoke Done\');\n         handleClearCache();\n      });\n\n      compiler.hooks.done.tap(\'FixHardSourceWebpackPlugin Force Stop\', (stats) => {\n         if (!this.cacheRead) {\n            return;\n         }\n\n         // 编译完成强制结束\n         // HACK 生产模式下因为 hard-source-webpack-plugin 插件的原因不会完全停止，暂未找到原因\n         setTimeout(() => {\n            console.log(\'[FixHardSourceWebpackPlugin] Force Stop\');\n            process.exit(0);\n         });\n      });\n   }\n}\n\nmodule.exports = FixHardSourceWebpackPlugin;`, `20260701042001130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> rimraf <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'rimraf\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">CACHE_ERROR_CODE</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../scripts/const\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">FixHardSourceWebpackPlugin</span> <span class="token punctuation">{</span>\n   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token comment">// 是否读取了上次的缓存</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>cacheRead <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>hardSourceLog<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'hardSourceLog\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token comment">// eslint-disable-next-line no-useless-call</span>\n         <span class="token comment">// console[message.level].call(console, message)</span>\n\n         <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token string">\'data.id\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">===</span> <span class="token string">\'confighash--reused\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span>cacheRead <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> <span class="token function-variable function">handleClearCache</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token comment">// 第一次生成缓存的时候，如果编译失败则判定缓存无效，清空缓存，退出命令</span>\n         <span class="token comment">// 第二次读缓存的情况下，如果编译失败则判定缓存无效，清空缓存，重启命令</span>\n         <span class="token keyword">const</span> <span class="token punctuation">{</span> cacheDirectory <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">;</span>\n         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'[FixHardSourceWebpackPlugin] Clearing Cache\'</span><span class="token punctuation">,</span> cacheDirectory<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         rimraf<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>cacheDirectory<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'[FixHardSourceWebpackPlugin] Cache Cleared\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cacheRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'[FixHardSourceWebpackPlugin] Restarting...\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token constant">CACHE_ERROR_CODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 找不到具体的模块时会调用，比如随便导入一个不存在的模块</span>\n      <span class="token comment">// import Atmp from \'./fake\'，且代码里面用到 Atmp 组件（这里的 fake 根本不存在）</span>\n      compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>failed<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'FixHardSourceWebpack Cache Error\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'[FixHardSourceWebpackPlugin] Invoke Failed\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token function">handleClearCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 导出一个不存在的模块并使用时会调用</span>\n      <span class="token comment">// import { Atmp } from \'./fake\' 且代码里面用到 Atmp 组件（实际上 Atmp 是不存在的组件）</span>\n      compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'FixHardSourceWebpack Cache Error\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> hasErrors <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">hasErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasErrors<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'[FixHardSourceWebpackPlugin] Invoke Done\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token function">handleClearCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'FixHardSourceWebpackPlugin Force Stop\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>cacheRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n\n         <span class="token comment">// 编译完成强制结束</span>\n         <span class="token comment">// HACK 生产模式下因为 hard-source-webpack-plugin 插件的原因不会完全停止，暂未找到原因</span>\n         <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'[FixHardSourceWebpackPlugin] Force Stop\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> FixHardSourceWebpackPlugin<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="后续问题"><a href="#%E5%90%8E%E7%BB%AD%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后续问题</h4>\n<p>在代码变动之后，如果通过缓存生成，查看编译后的代码还是之前的老代码，需要暂时关闭缓存待以后解决</p>\n<h3 id="preload-webpack-plugin-失效处理"><a href="#preload-webpack-plugin-%E5%A4%B1%E6%95%88%E5%A4%84%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>preload-webpack-plugin 失效处理</h3>\n<h4 id="需求背景-5"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>此插件在 pnpm 下不生效，在 npm 下反而生效</p>\n<h4 id="原因"><a href="#%E5%8E%9F%E5%9B%A0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原因</h4>\n<p>require 指向的 html-webpack-plugin 不是同一个，导致 hook 不能被调用，具体见 <a href="https://github.com/jantimon/html-webpack-plugin/issues/1091#issuecomment-434708455" target="_blank" rel="nofollow noreferrer noopener">issue</a></p>\n<h4 id="解决方案"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h4>\n<p>升级到 3.0.0-beta.4 即可，对比可知源码做了以上处理</p>\n<p>3.0.0-beta.3 代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16643202918559408000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (!hook) {\n   const HtmlWebpackPlugin = require(\'html-webpack-plugin\');\n   hook = HtmlWebpackPlugin.getHooks(compilation).beforeEmit;\n}`, `16643202918559408000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hook<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'html-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   hook <span class="token operator">=</span> HtmlWebpackPlugin<span class="token punctuation">.</span><span class="token function">getHooks</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span><span class="token punctuation">.</span>beforeEmit<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>3.0.0-beta.4 代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60628552684918110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (!hook) {\n   const [HtmlWebpackPlugin] = compiler.options.plugins.filter(\n      (plugin) => plugin.constructor.name === \'HtmlWebpackPlugin\'\n   );\n   assert(HtmlWebpackPlugin, \'Unable to find an instance of \' + \'HtmlWebpackPlugin in the current compilation.\');\n   hook = HtmlWebpackPlugin.constructor.getHooks(compilation).beforeEmit;\n}`, `60628552684918110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hook<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>HtmlWebpackPlugin<span class="token punctuation">]</span> <span class="token operator">=</span> compiler<span class="token punctuation">.</span>options<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>\n      <span class="token punctuation">(</span><span class="token parameter">plugin</span><span class="token punctuation">)</span> <span class="token operator">=></span> plugin<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">\'HtmlWebpackPlugin\'</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token function">assert</span><span class="token punctuation">(</span>HtmlWebpackPlugin<span class="token punctuation">,</span> <span class="token string">\'Unable to find an instance of \'</span> <span class="token operator">+</span> <span class="token string">\'HtmlWebpackPlugin in the current compilation.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   hook <span class="token operator">=</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">.</span>constructor<span class="token punctuation">.</span><span class="token function">getHooks</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span><span class="token punctuation">.</span>beforeEmit<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="分包失效问题"><a href="#%E5%88%86%E5%8C%85%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分包失效问题</h3>\n<h4 id="需求背景-6"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>发现分包结果和原来的不一致，比原来大很多，比如看下面的三方库</p>\n<p>原来的</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-a9fd5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 67.109375%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAACzElEQVQozyWS3U/TYBjF+9fpFcEbidyYkHihRi4wYQZkJopOiLoZxAuixjgBIcBwDANMPgZzMka3dd3Wteu6dt9rN9rStesnq+8kOTl5b05+53meF2rz7TIRrjWqgiRdyp2OIvcM/VpXmgbU0zTbttuRUGnGWV1w456X9W+fClMOdOIxxPIXxXoTeNc0ZENTDV1XFE2WdUXWgcsKcMu2iz9Xo7dv4I4H2OQoPfs8eutm4s4gRDfbZJ1jOyona62u0ZZ1QVR4QRZFRRT6EgS5Y9jMr03k3hA17Ug7xxq+FXp1kV72QpVGJZsnUtkMXiA5gQdkQ1X1rnLNt0BzVe3ZNrfrz43eLbyawB33xd2tWjhUOdiDeJHNEjkYSWbwXDKDFhma51i2Vm2Uy1y9ZqndnmH0Z0aR4rKX8W9UAv7GD+/v4UH44Qh00a7ieRzNZnIE0eBYSZKuDMPS+3wTrMo0LQuMbGcZYWmPDEQqgaRIhs9pj4tZmIOENotl0vD5eSqZJAmiWqmUaJoiSapQkESxZ1m60Q9vR+qjc1nPWml2tYzGClzkqHh8CKlCmSKwDILkMQyNxxmKUjuS1pEMcDNd72mqrvVrb582nO6zue/E2y0+thaMPhpBpsYhvlnEM2g6kcihKN9sSjwvtDgTjKpplqqCbZmGCcJp+mIjiO3+YfaxS+rwGH06RrpdEM82MTQVPzsDWBLDSBwvUQVd7lyHLU29svpkisf9+fW9UuCQDZYYWIxFm7G/kCQIoDACw9lUCkujaDJBkyQg26ZxLfNKB+Gj1sFYevQ1/uJdzRMNf8WmnbBrEpBLmRRydnqKJOLJOExTxVq5fMnzWv/O4HspiqpYVi/UDD3LTs0T772tlZOtuZ2hgdXhAcgfRtb2Y0s7kZXgKZAvFPefJH1H8MZ/gcd6CN48SX0Ibo/755/4Ps7sry0sLn558eazy/0P0amGPG/S4poAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 02 10 11 51 16" title="" data-src="/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-fee1c.png" data-srcset="/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-a67b7.png 200w,\n/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-0b187.png 400w,\n/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-fee1c.png 800w,\n/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-b1a91.png 1200w,\n/static/2023-02-10-11-51-16-bb2ff91472970fe8fa0d538f99cab0e3-a9fd5.png 1280w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>新的</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-a9fd5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 85.9375%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsSAAALEgHS3X78AAAC/klEQVQ4y02SW4+bVhDH+ez5AH1oVGkbrZRKURsp6UMeojbVpvJmk+zaqzX3A4eDuWPAcLituRiMoYOdh0o/Hc+5zMx//oYpn6uALAtf7o+ncRimcQTG0+n/nIYBgNu+7/ZV1QbbVsetbTBFvrdW73z+43a7y2nynOdFlrZVNZ1fj8fjD6B23499P01T8fiwe/+2+HbLFEkSRzQMdnkSd01zqCqga+pT2w59d2zqY9sMh3Y4HGbgcBzpzd/+1c/xh3cMjXeOsQlcp2vaoeuPhw7ogfbQd31X11Bxji807XE4pYub4LdX8fvfGdeLdMP3gyxJ63BXxrRKs4ZeKA4J3dO0umzhPKZ1UXXZ7U30+tf04ZZ5LosoCJM4oQmID9umuRg2OzednRtO02kERmCAaKp0rV4tvYwwZRYRrEiiJAoCwdh1nK3vA67r+J7ruS7EnufpOnFs27Es23HqwJuI+d3/xHT73CRYU1SiKERVkSBgRQFknscISTyvyjLwuFwiUZQ4FhOS3H3Orq8X5E/mUHiegU19Y+m6Z9uB60bbLRA4TggSbDv03NDzbMOAK9+yYkqTxT/JLy/vzY9MHnmKwCGBlzhOV9Ut5HgepPlQaF4tyAGgNFxB8jYI6ZfPyasr2bpj2n1pEg0EAzqG6aVLDCJBPBTVkAz6n1YrVZIQTIG14u7f9M31XpaYag/mwQNZQUjDWFUUnRAAAk3TYCXwo2F2vcZQEcmw2RlWpHt0dc+UaWRuCLwALMNIkyTPsiLLMkrzecnSLAfCaEdpGidpllJWyz7JvbP4yjRlBm7PVivKRpv1G4QA85YQpGqqpqtYX7MCnMhINU3jw13w4o1tIpupy4IgBBMqMCTIOv9DWJYlnoNZWE7kRQR8u18KggQlVKwuHsOf3loE+3OycW4IVkNn7dwfOmsI6RqREYa2wNOaRyqRkLrZ6It1cvUX3Sx5pioLTZkbwveAJElkWfgkQIXIcZIorqGzIHOC9PX7A8/y6zUHnt6y8R9fMvdJ+A+6oH9QRieClwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 02 10 11 52 53" title="" data-src="/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-fee1c.png" data-srcset="/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-a67b7.png 200w,\n/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-0b187.png 400w,\n/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-fee1c.png 800w,\n/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-b1a91.png 1200w,\n/static/2023-02-10-11-52-53-077e555bd435b9e484d8fbd5fffbda67-a9fd5.png 1280w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h4 id="原因-1"><a href="#%E5%8E%9F%E5%9B%A0-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原因</h4>\n<p>经分析 treeShaking 失效，说明 main 没有识别到 es6 的语法</p>\n<h4 id="解决方案-1"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h4>\n<p>需要注释掉 mainFields 这一行，默认 cra 已做了 es6 语法的处理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44331348080909200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// localConfig.resolve.mainFields = [\'jsnext:main\', \'main\'];`, `44331348080909200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// localConfig.resolve.mainFields = [\'jsnext:main\', \'main\'];</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="修复-fastrefresh-在-worker-报错"><a href="#%E4%BF%AE%E5%A4%8D-fastrefresh-%E5%9C%A8-worker-%E6%8A%A5%E9%94%99" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修复 fastRefresh 在 worker 报错</h3>\n<h4 id="需求背景-7"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>如果一个文件导出函数时被前端代码和 worker 同时使用时报错</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-02-10-11-58-09-c4c17a2f8efeac97e2a34ecaa69c3245-a36d1.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 604px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 26.986754966887418%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAAA9klEQVQY0yWNyXKEIBQA/f/fSg6zqUQYXHgEcMFlxBGUaGUuMUlVV9+6OrCrX8xkWNmgvA2pjNLwQuIL+TghGmVpAvhGgUBXaj/OfrKLmVczu8d0ENhlneZF905gzqOUJsAwpAmjcabKBy5qlCoKTSF0IdvDVfeUjRntPrrvv9h5Y7eBQndFFcnziBBEUYjjECdJxnjFpGZC87IDqZt+1oPtzDJMa+CO2PrBeJ2L4hxnMaWn+H4j17fz7f1KUIrvgCi/F4qyimSCq6HsnqIZK21+z7Pzzm1TP+aF4KA4V/BZ5iBB1VzWqmrduttlP3zgt9f69fr3D+qQCTlnM4VyAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 02 10 11 58 09" title="" data-src="/static/2023-02-10-11-58-09-c4c17a2f8efeac97e2a34ecaa69c3245-a36d1.png" data-srcset="/static/2023-02-10-11-58-09-c4c17a2f8efeac97e2a34ecaa69c3245-765e7.png 200w,\n/static/2023-02-10-11-58-09-c4c17a2f8efeac97e2a34ecaa69c3245-c9f48.png 400w,\n/static/2023-02-10-11-58-09-c4c17a2f8efeac97e2a34ecaa69c3245-a36d1.png 604w" data-sizes="(max-width: 604px) 100vw, 604px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h4 id="原因-2"><a href="#%E5%8E%9F%E5%9B%A0-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原因</h4>\n<p>在 development 模式下，如果一个文件里面的 function 同时被 worker 和前端文件使用（即被前端的 <code class="language-text">babel-loader/react-refresh</code> 处理过，此时就有了 fastRefresh 的插件代码），而 fastRefresh 里面没有针对 worker 运行环境的处理，此时会报错</p>\n<h4 id="方案"><a href="#%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方案</h4>\n<p>需要对 <code class="language-text">$RefreshReg$</code> 做兼容处理，即确保只在开发环境的 worker 添加以下代码（注意这里的代码必须写成单独的文件并使用 import 放在 worker 的第一行，否则会因为执行时机的问题不起作用）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25889071427121533000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`global.\\$RefreshReg\\$ = () => {};\nglobal.\\$RefreshSig\\$ = () => {};`, `25889071427121533000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">global<span class="token punctuation">.</span><span class="token function-variable function">$RefreshReg$</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\nglobal<span class="token punctuation">.</span><span class="token function-variable function">$RefreshSig$</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<ol>\n<li>不对 worker 文件做 babel 处理（此方案改动较大，不现实）</li>\n<li>\n<p>在 worker-loader 前插入新的 loader，此 loader 插入以上代码，注意只在 development 环境插入一行代码</p>\n<ol>\n<li>找现成的插入代码的 loader</li>\n<li>自己写 loader</li>\n</ol>\n</li>\n</ol>\n<h3 id="懒编译"><a href="#%E6%87%92%E7%BC%96%E8%AF%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>懒编译</h3>\n<h4 id="需求背景-8"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>目前老项目在开发模式下全量编译过慢，而有时只需要开发少数几个页面</p>\n<h4 id="选型过程"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h4>\n<p>因老项目使用的是 webpack4，历史代码太多不好升级，所以需要通过模仿 webpack5 的懒编译实现，有以下几个选型</p>\n<ol>\n<li><a href="https://github.com/bahmutov/web-packing" target="_blank" rel="nofollow noreferrer noopener">web-packing</a> 实现了网络请求来打包对应组件，实现思路类似懒编译，但和理想中的相差较远</li>\n<li><a href="https://github.com/sysgears/webpack-virtual-modules" target="_blank" rel="nofollow noreferrer noopener">webpack-virtual-modules</a> 实现了在内存中动态创建文件，但需要重新开始写懒编译效果</li>\n<li><a href="https://github.com/lisiyizu/vue-dynamic-module-example" target="_blank" rel="nofollow noreferrer noopener">vue-dynamic-module-example</a> 实现了在 vue 中懒编译文件，但只能在命令行中指定要编译哪些模块，不能从网络请求来决定编译哪些模块</li>\n<li><a href="https://github.com/liximomo/lazy-compile-webpack-plugin" target="_blank" rel="nofollow noreferrer noopener">lazy-compile-webpack-plugin</a> 基本实现了根据请求来编译对应页面的效果，但请求一个页面会触发多次编译，且二次请求这个页面还会触发编译</li>\n<li><a href="https://github.com/devtreehouse/lazy-build-webpack-plugin" target="_blank" rel="nofollow noreferrer noopener">lazy-build-webpack-plugin</a> 修复以上问题，但在老项目里面运行会出现循环依赖的报错</li>\n<li><a href="https://github.com/towavephone/lazy-build-webpack-plugin" target="_blank" rel="nofollow noreferrer noopener">towavephone/lazy-build-webpack-plugin</a> 修复循环依赖问题</li>\n</ol>\n<h4 id="具体实现"><a href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体实现</h4>\n<p>config-overrides.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86625509433467880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const LazyBuildWebpackPlugin = require(\'@towavephone/lazy-build-webpack-plugin\');\n\nconst { LAZY_BUILD } = process.env;\n\n// 默认不开启懒编译\nLAZY_BUILD &&\n   addWebpackPlugin(\n      // 以下三个和热更新有关的三方库会导致页面不停刷新，造成此原因的链接如下\n      // https://github.com/towavephone/lazy-build-webpack-plugin/blob/2a2654f8ea22b015caaef7d5bc961b851f92033d/lib/loaders/entry-loader.js#L15\n      new LazyBuildWebpackPlugin({\n         ignores: [/\\b(react-dev-utils|dev-server|react-refresh-webpack-plugin)\\b/]\n      })\n   );`, `86625509433467880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> LazyBuildWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'@towavephone/lazy-build-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">LAZY_BUILD</span> <span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">;</span>\n\n<span class="token comment">// 默认不开启懒编译</span>\n<span class="token constant">LAZY_BUILD</span> <span class="token operator">&amp;&amp;</span>\n   <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n      <span class="token comment">// 以下三个和热更新有关的三方库会导致页面不停刷新，造成此原因的链接如下</span>\n      <span class="token comment">// https://github.com/towavephone/lazy-build-webpack-plugin/blob/2a2654f8ea22b015caaef7d5bc961b851f92033d/lib/loaders/entry-loader.js#L15</span>\n      <span class="token keyword">new</span> <span class="token class-name">LazyBuildWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n         ignores<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token regex">/\\b(react-dev-utils|dev-server|react-refresh-webpack-plugin)\\b/</span><span class="token punctuation">]</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3870791904737203000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 主入口需要加这几行代码，否则懒编译完成后页面不刷新\nif (module.hot) {\n   module.hot.accept();\n}`, `3870791904737203000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 主入口需要加这几行代码，否则懒编译完成后页面不刷新</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="编译效果"><a href="#%E7%BC%96%E8%AF%91%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编译效果</h4>\n<ol>\n<li>懒编译开启前，即全量编译．时长在 3 分钟左右</li>\n<li>懒编译开启后，即单页面编译，随机挑选一个页面，时长在 20 秒左右</li>\n</ol>\n<h4 id="源码解析"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解析</h4>\n<p><a href="https://github.com/towavephone/lazy-build-webpack-plugin" target="_blank" rel="nofollow noreferrer noopener">lazy-build-webpack-plugin</a></p>\n<h3 id="jenkins-编译速度优化"><a href="#jenkins-%E7%BC%96%E8%AF%91%E9%80%9F%E5%BA%A6%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>jenkins 编译速度优化</h3>\n<p><a href="/jenkins-build-speed-optimize/">原文链接</a></p>\n<h2 id="效果展示"><a href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果展示</h2>\n<h3 id="生产环境"><a href="#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生产环境</h3>\n<p>只算前端编译过程，原来的正在用的前端编译时间 9 分钟</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-12-16-19-27-36-de2a8fcc302e0ca8073efd93a1263a1f-602dc.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 39.15426781519186%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABaUlEQVQY0yVPi46kIBD0/z9tk03ubnacUQEBFQHxMTx8g8vMdTqVTndXqiqZ9Ktmzbws13Wd3h/+PEOIwxn8fzwi+nM79njyn+V+HnEOV0iuT/lYwb+0rupq3VZtjHWWUGKtNePorC0JMdZEjdgYY9nJyEq0c/00SdWpvmeSFwRyJeWoatHmGLUEYQgZArShbSdaxUXfIYobwXxUZmogjE+vad8P6vjTEry2le/QwrK5Qip/2oigMAQuDB+i3Nos/jjmQ0j0sslhdLOLNtiqno7SQ9aXwhsvlhoPAFiKewgcLTdOTkl2kc8VWXiI5MnOUbnv1bZtWDe3ERS2givLNLmNsBCPwhIgsvsAMkPjHs7NzwSBrt7Ko3GkYVxwbXSmym9+vw/wafC/Lv9qbj/V33RCaX3/w9NbDx4apyP6FumjhyFcyeRWwtrIDNdVLzLSouF3tvWduezyfESlzHNL0MqIf9v+ZG6j7V9Mj7qUsT0QQQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 12 16 19 27 36" title="" data-src="/static/2022-12-16-19-27-36-de2a8fcc302e0ca8073efd93a1263a1f-fee1c.png" data-srcset="/static/2022-12-16-19-27-36-de2a8fcc302e0ca8073efd93a1263a1f-a67b7.png 200w,\n/static/2022-12-16-19-27-36-de2a8fcc302e0ca8073efd93a1263a1f-0b187.png 400w,\n/static/2022-12-16-19-27-36-de2a8fcc302e0ca8073efd93a1263a1f-fee1c.png 800w,\n/static/2022-12-16-19-27-36-de2a8fcc302e0ca8073efd93a1263a1f-b1a91.png 1200w,\n/static/2022-12-16-19-27-36-de2a8fcc302e0ca8073efd93a1263a1f-602dc.png 1277w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>优化缓存过后，分 2 种情况，初次编译完全无缓存的情况下编译时间 8 分钟，第二次有缓存的情况下 3 分钟</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-12-16-19-28-35-ac103b5f8619d4f07254b7bba39ea5e1-0f56a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 34.19047619047619%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABL0lEQVQY01WQDW+DIBCG/f8/b9lWPwoCWhCpiijyUYq7dsmSXd5c7oG7lxzFsmrCqJDD88ygfObzPN/F+dYL8xt/z/8yRHH+j8MdYhAhBrNtZjMhRvB13i96meYpPqK6333wq1lHpQowSTkba7Ux23FMi/4uy1nrbbfbvgOWdb0sWipF+ttuj55zva6DHFtKCzfNinUSozshd0pvtMHXT0Yq3iPRXVtcoearpxUldd1UrK2vzQfFF94h0aMCXpjmZRA8BJ9TYpZfthYdHUuSpqF1fWkwIBSt67Drq71FtiNRkMiLydhhXvWqQ3rAx3RuLHeKHWdZsafCTjRHjz3HXiDIjteWoeMGV6AiPhNsK5X0McD+nZcXS6AbhmkeceCVpShwGGjcy6UEdDeSRpLkD4t/hoHkVqdHAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 12 16 19 28 35" title="" data-src="/static/2022-12-16-19-28-35-ac103b5f8619d4f07254b7bba39ea5e1-fee1c.png" data-srcset="/static/2022-12-16-19-28-35-ac103b5f8619d4f07254b7bba39ea5e1-a67b7.png 200w,\n/static/2022-12-16-19-28-35-ac103b5f8619d4f07254b7bba39ea5e1-0b187.png 400w,\n/static/2022-12-16-19-28-35-ac103b5f8619d4f07254b7bba39ea5e1-fee1c.png 800w,\n/static/2022-12-16-19-28-35-ac103b5f8619d4f07254b7bba39ea5e1-0f56a.png 1050w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="开发环境"><a href="#%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>开发环境</h3>\n<p>看自己电脑配置来定，目前本人电脑上前端初次编译 5 分钟，二次编译 2 分钟（不过不建议开启缓存插件，会影响热更新速度且时间长会报错，可通过上面提到的 <code class="language-text">DISABLE_HARD_SOURCE_PLUGIN</code> 关闭）</p>\n<h2 id="后期优化"><a href="#%E5%90%8E%E6%9C%9F%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后期优化</h2>\n<p>后期优化偏向页面加载性能方面，有以下几点可以考虑：</p>\n<ol>\n<li>页面分包优化</li>\n<li>worker.js loader 优化</li>\n<li>不必要的三方库优化</li>\n</ol>\n<h1 id="二期优化"><a href="#%E4%BA%8C%E6%9C%9F%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>二期优化</h1>\n<p>主要升级 cra + webpack5 以及对其他编译工具的调研</p>\n<h2 id="具体功能-1"><a href="#%E5%85%B7%E4%BD%93%E5%8A%9F%E8%83%BD-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体功能</h2>\n<h3 id="cra--webpack5"><a href="#cra--webpack5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>cra + webpack5</h3>\n<h4 id="环境变量"><a href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>环境变量</h4>\n<p>.env</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53072838963219910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`DISABLE_ESLINT_PLUGIN=true\nGENERATE_SOURCEMAP=false\nPORT=3000\nBROWSER=none\n\n# LAZY_BUILD=true\n# DISABLE_CACHE=true\n# DEBUG_CACHE=true`, `53072838963219910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token assign-left variable">DISABLE_ESLINT_PLUGIN</span><span class="token operator">=</span>true\n<span class="token assign-left variable">GENERATE_SOURCEMAP</span><span class="token operator">=</span>false\n<span class="token assign-left variable">PORT</span><span class="token operator">=</span><span class="token number">3000</span>\n<span class="token assign-left variable">BROWSER</span><span class="token operator">=</span>none\n\n<span class="token comment"># LAZY_BUILD=true</span>\n<span class="token comment"># DISABLE_CACHE=true</span>\n<span class="token comment"># DEBUG_CACHE=true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>.env.production</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74655643474197090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`DISABLE_ESLINT_PLUGIN=true\nGENERATE_SOURCEMAP=false\n\n# DISABLE_CACHE=true\nDEBUG_CACHE=true\n# BUNDLE_ANALYZER=true`, `74655643474197090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token assign-left variable">DISABLE_ESLINT_PLUGIN</span><span class="token operator">=</span>true\n<span class="token assign-left variable">GENERATE_SOURCEMAP</span><span class="token operator">=</span>false\n\n<span class="token comment"># DISABLE_CACHE=true</span>\n<span class="token assign-left variable">DEBUG_CACHE</span><span class="token operator">=</span>true\n<span class="token comment"># BUNDLE_ANALYZER=true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="核心配置"><a href="#%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心配置</h4>\n<p>config-overrides.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94238004187818200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const {\n   override,\n   addBabelPlugins,\n   fixBabelImports,\n   addLessLoader,\n   removeModuleScopePlugin,\n   setWebpackOptimizationSplitChunks,\n   addWebpackPlugin,\n   addWebpackAlias,\n   adjustStyleLoaders\n} = require(\'customize-cra\');\nconst fs = require(\'fs\');\nconst webpack = require(\'webpack\');\nconst PreloadWebpackPlugin = require(\'preload-webpack-plugin\');\nconst path = require(\'path\');\nconst MonacoWebpackPlugin = require(\'monaco-editor-webpack-plugin\');\nconst WebpackBarPlugin = require(\'webpackbar\');\nconst { get, pick } = require(\'lodash\');\nconst threadLoader = require(\'thread-loader\');\nconst BundleAnalyzerPlugin = require(\'webpack-bundle-analyzer\').BundleAnalyzerPlugin;\n\nconst { LAZY_BUILD, DISABLE_CACHE, DEBUG_CACHE, BUNDLE_ANALYZER } = process.env;\n\nthreadLoader.warmup(\n   {\n      // pool options, like passed to loader options\n      // must match loader options to boot the correct pool\n   },\n   [\n      // modules to load\n      // can be any module, i. e.\n      \'babel-loader\'\n   ]\n);\n\nconst craDir = path.join(process.cwd() + \'/.cra\');\n\nif (!fs.existsSync(craDir)) {\n   fs.mkdirSync(craDir);\n}\n\nconst addBeforeLoaders = (webpackConfig, matchLoader, newLoader = []) => {\n   const matchLoaders = get(webpackConfig, \'module.rules.0.oneOf\', []).filter((item) =>\n      get(item, \'loader\', \'\').includes(matchLoader)\n   );\n   if (matchLoaders.length > 0) {\n      matchLoaders.forEach((item) => {\n         const props = [\'loader\', \'options\'];\n         item.use = [...newLoader, pick(item, props)];\n         props.forEach((item2) => {\n            delete item[item2];\n         });\n      });\n   }\n};\n\nconst formatConfig = (config) =>\n   JSON.stringify(\n      config,\n      (key, value) => {\n         if (typeof value === \'function\') {\n            return value.toString();\n         }\n         return value;\n      },\n      2\n   );\n\nmodule.exports = {\n   webpack: (config, env) => {\n      const isProd = env === \'production\';\n\n      const localConfig = override(\n         addBabelPlugins(\n            [\'@babel/plugin-proposal-nullish-coalescing-operator\'],\n            [\'@babel/plugin-syntax-optional-chaining\']\n         ),\n         fixBabelImports(\'import\', {\n            libraryName: \'antd\',\n            libraryDirectory: \'es\',\n            style: true\n         }),\n         addLessLoader({\n            lessOptions: { javascriptEnabled: true }\n         }),\n         // 适配 cra 下 less-loader 的兼容性问题\n         adjustStyleLoaders(({ use: [, , postcss] }) => {\n            const postcssOptions = postcss.options;\n            postcss.options = { postcssOptions };\n         }),\n         addWebpackAlias({\n            \'@\': path.resolve(__dirname, \'src\')\n         }),\n         removeModuleScopePlugin(),\n         isProd &&\n            setWebpackOptimizationSplitChunks({\n               cacheGroups: {\n                  vendors: {\n                     minChunks: 2,\n                     test: /[\\\\/]node_modules[\\\\/]\\.pnpm[\\\\/](?!google-protobuf|@antv|highcharts|mathjs|two\\.js|konva|victory-core)/,\n                     priority: -10,\n                     reuseExistingChunk: true,\n                     name: \'vendors\'\n                  },\n                  default: {\n                     minChunks: 2,\n                     priority: -20,\n                     reuseExistingChunk: true\n                  }\n               }\n            }),\n         isProd &&\n            addWebpackPlugin(\n               new PreloadWebpackPlugin({\n                  rel: \'prefetch\',\n                  as: \'script\',\n                  fileBlacklist: [\n                     /\\d{1,2}\\.(\\d?[a-z]?)+\\.chunk\\.js\\$/,\n                     /main\\..+\\.js\\$/,\n                     /\\.css\\$/,\n                     /\\.txt\\$/,\n                     /\\.png\\$/,\n                     /.jpeg\\$/,\n                     /.cjs\\$/,\n                     /.svg\\$/,\n                     /.ttf\\$/\n                  ],\n                  include: \'allAssets\'\n               })\n            ),\n         addWebpackPlugin(\n            new MonacoWebpackPlugin({\n               languages: [\'json\']\n            })\n         ),\n         addWebpackPlugin(\n            new webpack.DefinePlugin({\n               \'process.env.BUILD_TOOL\': &quot;\'webpack\'&quot;\n            })\n         ),\n         // 处理 buffer 缺失问题，因为 webpack5 现在默认不导入 nodejs 相关库，需要自行导入\n         addWebpackPlugin(\n            new webpack.ProvidePlugin({\n               Buffer: [\'buffer\', \'Buffer\']\n            })\n         ),\n         BUNDLE_ANALYZER &&\n            addWebpackPlugin(\n               new BundleAnalyzerPlugin({\n                  analyzerPort: 8080,\n                  generateStatsFile: true\n               })\n            ),\n         addWebpackPlugin(new WebpackBarPlugin())\n      )(config);\n\n      addBeforeLoaders(localConfig, \'babel-loader\', [\'thread-loader\']);\n\n      localConfig.resolve.extensions = [\'.js\'];\n      localConfig.resolve.modules = [\'node_modules\'];\n      // 兼容处理\n      localConfig.resolve.fallback = {\n         buffer: require.resolve(\'buffer\')\n      };\n\n      // 懒编译功能，默认关闭\n      if (LAZY_BUILD) {\n         localConfig.experiments = {\n            lazyCompilation: {\n               // disable lazy compilation for dynamic imports\n               imports: true,\n\n               // disable lazy compilation for entries\n               entries: false\n\n               // do not lazily compile moduleB\n               // test: module => !/moduleB/.test(module.nameForCondition())\n            }\n         };\n      } // 开启缓存调试日志，默认关闭，配合环境变量使用\n\n      if (DEBUG_CACHE) {\n         localConfig.infrastructureLogging = {\n            debug: /webpack\\.cache/\n         };\n      } // 是否关闭缓存，默认开启\n\n      if (DISABLE_CACHE) {\n         localConfig.cache = false;\n      }\n\n      if (!isProd) {\n         localConfig.stats = {\n            errors: true,\n            children: false,\n            warnings: false,\n            colors: true,\n            assets: false,\n            modules: false,\n            entrypoints: false,\n            timings: true,\n            builtAt: true,\n            hash: true\n         };\n      } else {\n         const instanceOfMiniCssExtractPlugin = localConfig.plugins.find(\n            (plugin) => plugin.constructor.name === \'MiniCssExtractPlugin\'\n         );\n\n         // 忽略样式导入顺序报错\n         // https://github.com/facebook/create-react-app/issues/5372\n         if (instanceOfMiniCssExtractPlugin) {\n            instanceOfMiniCssExtractPlugin.options.ignoreOrder = true;\n         }\n      }\n\n      fs.writeFileSync(path.join(craDir, \\`webpack.\\${env}.json\\`), formatConfig(localConfig));\n\n      return localConfig;\n   },\n   devServer: (configFunction) => (proxy, allowedHost) => {\n      const config = configFunction(proxy, allowedHost);\n\n      config.allowedHosts = \'all\';\n\n      fs.writeFileSync(path.join(craDir, \'webpack-dev-server.json\'), formatConfig(config));\n\n      return config;\n   }\n};`, `94238004187818200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span>\n   override<span class="token punctuation">,</span>\n   addBabelPlugins<span class="token punctuation">,</span>\n   fixBabelImports<span class="token punctuation">,</span>\n   addLessLoader<span class="token punctuation">,</span>\n   removeModuleScopePlugin<span class="token punctuation">,</span>\n   setWebpackOptimizationSplitChunks<span class="token punctuation">,</span>\n   addWebpackPlugin<span class="token punctuation">,</span>\n   addWebpackAlias<span class="token punctuation">,</span>\n   adjustStyleLoaders\n<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'customize-cra\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpack\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> PreloadWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'preload-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> MonacoWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'monaco-editor-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> WebpackBarPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpackbar\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">,</span> pick <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> threadLoader <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'thread-loader\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> BundleAnalyzerPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpack-bundle-analyzer\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>BundleAnalyzerPlugin<span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">LAZY_BUILD</span><span class="token punctuation">,</span> <span class="token constant">DISABLE_CACHE</span><span class="token punctuation">,</span> <span class="token constant">DEBUG_CACHE</span><span class="token punctuation">,</span> <span class="token constant">BUNDLE_ANALYZER</span> <span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">;</span>\n\nthreadLoader<span class="token punctuation">.</span><span class="token function">warmup</span><span class="token punctuation">(</span>\n   <span class="token punctuation">{</span>\n      <span class="token comment">// pool options, like passed to loader options</span>\n      <span class="token comment">// must match loader options to boot the correct pool</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token punctuation">[</span>\n      <span class="token comment">// modules to load</span>\n      <span class="token comment">// can be any module, i. e.</span>\n      <span class="token string">\'babel-loader\'</span>\n   <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> craDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">\'/.cra\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>craDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>craDir<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">addBeforeLoaders</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">webpackConfig<span class="token punctuation">,</span> matchLoader<span class="token punctuation">,</span> newLoader <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> matchLoaders <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">,</span> <span class="token string">\'module.rules.0.oneOf\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n      <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'loader\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>matchLoader<span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>matchLoaders<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      matchLoaders<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'loader\'</span><span class="token punctuation">,</span> <span class="token string">\'options\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n         item<span class="token punctuation">.</span>use <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>newLoader<span class="token punctuation">,</span> <span class="token function">pick</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n         props<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">delete</span> item<span class="token punctuation">[</span>item2<span class="token punctuation">]</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">formatConfig</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>\n      config<span class="token punctuation">,</span>\n      <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">\'function\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         <span class="token keyword">return</span> value<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token number">2</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   <span class="token function-variable function">webpack</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">config<span class="token punctuation">,</span> env</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> isProd <span class="token operator">=</span> env <span class="token operator">===</span> <span class="token string">\'production\'</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> localConfig <span class="token operator">=</span> <span class="token function">override</span><span class="token punctuation">(</span>\n         <span class="token function">addBabelPlugins</span><span class="token punctuation">(</span>\n            <span class="token punctuation">[</span><span class="token string">\'@babel/plugin-proposal-nullish-coalescing-operator\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            <span class="token punctuation">[</span><span class="token string">\'@babel/plugin-syntax-optional-chaining\'</span><span class="token punctuation">]</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">fixBabelImports</span><span class="token punctuation">(</span><span class="token string">\'import\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n            libraryName<span class="token punctuation">:</span> <span class="token string">\'antd\'</span><span class="token punctuation">,</span>\n            libraryDirectory<span class="token punctuation">:</span> <span class="token string">\'es\'</span><span class="token punctuation">,</span>\n            style<span class="token punctuation">:</span> <span class="token boolean">true</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addLessLoader</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            lessOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span> javascriptEnabled<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token comment">// 适配 cra 下 less-loader 的兼容性问题</span>\n         <span class="token function">adjustStyleLoaders</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token punctuation">,</span> postcss<span class="token punctuation">]</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">const</span> postcssOptions <span class="token operator">=</span> postcss<span class="token punctuation">.</span>options<span class="token punctuation">;</span>\n            postcss<span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token punctuation">{</span> postcssOptions <span class="token punctuation">}</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackAlias</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token string">\'@\'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'src\'</span><span class="token punctuation">)</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">removeModuleScopePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         isProd <span class="token operator">&amp;&amp;</span>\n            <span class="token function">setWebpackOptimizationSplitChunks</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               cacheGroups<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                  vendors<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                     minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n                     test<span class="token punctuation">:</span> <span class="token regex">/[\\\\/]node_modules[\\\\/]\\.pnpm[\\\\/](?!google-protobuf|@antv|highcharts|mathjs|two\\.js|konva|victory-core)/</span><span class="token punctuation">,</span>\n                     priority<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span>\n                     reuseExistingChunk<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n                     name<span class="token punctuation">:</span> <span class="token string">\'vendors\'</span>\n                  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                  <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                     minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n                     priority<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span>\n                     reuseExistingChunk<span class="token punctuation">:</span> <span class="token boolean">true</span>\n                  <span class="token punctuation">}</span>\n               <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         isProd <span class="token operator">&amp;&amp;</span>\n            <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n               <span class="token keyword">new</span> <span class="token class-name">PreloadWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                  rel<span class="token punctuation">:</span> <span class="token string">\'prefetch\'</span><span class="token punctuation">,</span>\n                  <span class="token keyword">as</span><span class="token punctuation">:</span> <span class="token string">\'script\'</span><span class="token punctuation">,</span>\n                  fileBlacklist<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n                     <span class="token regex">/\\d{1,2}\\.(\\d?[a-z]?)+\\.chunk\\.js$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/main\\..+\\.js$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/\\.css$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/\\.txt$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/\\.png$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/.jpeg$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/.cjs$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/.svg$/</span><span class="token punctuation">,</span>\n                     <span class="token regex">/.ttf$/</span>\n                  <span class="token punctuation">]</span><span class="token punctuation">,</span>\n                  include<span class="token punctuation">:</span> <span class="token string">\'allAssets\'</span>\n               <span class="token punctuation">}</span><span class="token punctuation">)</span>\n            <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n            <span class="token keyword">new</span> <span class="token class-name">MonacoWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               languages<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'json\'</span><span class="token punctuation">]</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n            <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               <span class="token string">\'process.env.BUILD_TOOL\'</span><span class="token punctuation">:</span> <span class="token string">"\'webpack\'"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token comment">// 处理 buffer 缺失问题，因为 webpack5 现在默认不导入 nodejs 相关库，需要自行导入</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n            <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>ProvidePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               Buffer<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'buffer\'</span><span class="token punctuation">,</span> <span class="token string">\'Buffer\'</span><span class="token punctuation">]</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token constant">BUNDLE_ANALYZER</span> <span class="token operator">&amp;&amp;</span>\n            <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n               <span class="token keyword">new</span> <span class="token class-name">BundleAnalyzerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                  analyzerPort<span class="token punctuation">:</span> <span class="token number">8080</span><span class="token punctuation">,</span>\n                  generateStatsFile<span class="token punctuation">:</span> <span class="token boolean">true</span>\n               <span class="token punctuation">}</span><span class="token punctuation">)</span>\n            <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebpackBarPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token function">addBeforeLoaders</span><span class="token punctuation">(</span>localConfig<span class="token punctuation">,</span> <span class="token string">\'babel-loader\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'thread-loader\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>extensions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'.js\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'node_modules\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token comment">// 兼容处理</span>\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>fallback <span class="token operator">=</span> <span class="token punctuation">{</span>\n         buffer<span class="token punctuation">:</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">\'buffer\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 懒编译功能，默认关闭</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">LAZY_BUILD</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>experiments <span class="token operator">=</span> <span class="token punctuation">{</span>\n            lazyCompilation<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n               <span class="token comment">// disable lazy compilation for dynamic imports</span>\n               imports<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n\n               <span class="token comment">// disable lazy compilation for entries</span>\n               entries<span class="token punctuation">:</span> <span class="token boolean">false</span>\n\n               <span class="token comment">// do not lazily compile moduleB</span>\n               <span class="token comment">// test: module => !/moduleB/.test(module.nameForCondition())</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token comment">// 开启缓存调试日志，默认关闭，配合环境变量使用</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_CACHE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>infrastructureLogging <span class="token operator">=</span> <span class="token punctuation">{</span>\n            debug<span class="token punctuation">:</span> <span class="token regex">/webpack\\.cache/</span>\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token comment">// 是否关闭缓存，默认开启</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DISABLE_CACHE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>stats <span class="token operator">=</span> <span class="token punctuation">{</span>\n            errors<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            children<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            warnings<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            colors<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            assets<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            modules<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            entrypoints<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            timings<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            builtAt<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            hash<span class="token punctuation">:</span> <span class="token boolean">true</span>\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> instanceOfMiniCssExtractPlugin <span class="token operator">=</span> localConfig<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>\n            <span class="token punctuation">(</span><span class="token parameter">plugin</span><span class="token punctuation">)</span> <span class="token operator">=></span> plugin<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">\'MiniCssExtractPlugin\'</span>\n         <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n         <span class="token comment">// 忽略样式导入顺序报错</span>\n         <span class="token comment">// https://github.com/facebook/create-react-app/issues/5372</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>instanceOfMiniCssExtractPlugin<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            instanceOfMiniCssExtractPlugin<span class="token punctuation">.</span>options<span class="token punctuation">.</span>ignoreOrder <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>craDir<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">webpack.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>env<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.json</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">formatConfig</span><span class="token punctuation">(</span>localConfig<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> localConfig<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token function-variable function">devServer</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">configFunction</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">proxy<span class="token punctuation">,</span> allowedHost</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">configFunction</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> allowedHost<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      config<span class="token punctuation">.</span>allowedHosts <span class="token operator">=</span> <span class="token string">\'all\'</span><span class="token punctuation">;</span>\n\n      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>craDir<span class="token punctuation">,</span> <span class="token string">\'webpack-dev-server.json\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">formatConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> config<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>package.json 只显示增加部分</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25691092865928500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n   &quot;dependencies&quot;: {\n      &quot;html-webpack-plugin&quot;: &quot;^5.5.0&quot;,\n      &quot;less-loader&quot;: &quot;^11.1.0&quot;,\n      &quot;react-scripts&quot;: &quot;npm:@towavephone/react-scripts@^5.0.3&quot;,\n      &quot;webpack&quot;: &quot;5.78.0&quot;,\n      &quot;webpack-bundle-analyzer&quot;: &quot;^4.7.0&quot;,\n      &quot;webpack-dev-server&quot;: &quot;4.13.2&quot;,\n      &quot;buffer&quot;: &quot;^6.0.3&quot;\n   }\n}`, `25691092865928500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n   <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"html-webpack-plugin"</span><span class="token operator">:</span> <span class="token string">"^5.5.0"</span><span class="token punctuation">,</span>\n      <span class="token property">"less-loader"</span><span class="token operator">:</span> <span class="token string">"^11.1.0"</span><span class="token punctuation">,</span>\n      <span class="token property">"react-scripts"</span><span class="token operator">:</span> <span class="token string">"npm:@towavephone/react-scripts@^5.0.3"</span><span class="token punctuation">,</span>\n      <span class="token property">"webpack"</span><span class="token operator">:</span> <span class="token string">"5.78.0"</span><span class="token punctuation">,</span>\n      <span class="token property">"webpack-bundle-analyzer"</span><span class="token operator">:</span> <span class="token string">"^4.7.0"</span><span class="token punctuation">,</span>\n      <span class="token property">"webpack-dev-server"</span><span class="token operator">:</span> <span class="token string">"4.13.2"</span><span class="token punctuation">,</span>\n      <span class="token property">"buffer"</span><span class="token operator">:</span> <span class="token string">"^6.0.3"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="worker-loader-的兼容处理"><a href="#worker-loader-%E7%9A%84%E5%85%BC%E5%AE%B9%E5%A4%84%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>worker-loader 的兼容处理</h4>\n<p>去掉 worker-loader，使用 <code class="language-text">new Worker(new URL(&#39;worker文件路径&#39;, import.meta.url))</code> 代替</p>\n<h4 id="修复-react-scripts-生产环境缓存"><a href="#%E4%BF%AE%E5%A4%8D-react-scripts-%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修复 react-scripts 生产环境缓存</h4>\n<p><a href="https://github.com/yicheny/create-react-app/compare/main...towavephone:create-react-app:main" target="_blank" rel="nofollow noreferrer noopener">仓库地址</a></p>\n<p>生产环境下 cra 不能正常生成文件缓存，原因是没有调用 webpack5 的 <code class="language-text">compiler.close</code>，同时需要注意 close 之后需要正常终止</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24385864157778637000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`compiler.close((err) => {\n   if (err && err.message) {\n      console.log(err.message);\n      process.exit(1);\n   }\n\n   process.exit(0);\n});`, `24385864157778637000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">compiler<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&amp;&amp;</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="运行模板"><a href="#%E8%BF%90%E8%A1%8C%E6%A8%A1%E6%9D%BF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行模板</h4>\n<p><a href="https://github.com/towavephone/GatsbyBlog/tree/master/template/cra-js-template" target="_blank" rel="nofollow noreferrer noopener">仓库地址</a></p>\n<h4 id="优缺点"><a href="#%E4%BC%98%E7%BC%BA%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优缺点</h4>\n<p>相比于一期优化的本地和生产模式编译时间都为 2~3 分钟，优缺点如下</p>\n<ul>\n<li>优点：二次编译速度快，开发模式在 18 秒左右，生产模式在 40 秒左右</li>\n<li>缺点：首次编译速度慢，需要 3~4 分钟</li>\n</ul>\n<h3 id="rspack"><a href="#rspack" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>rspack</h3>\n<h4 id="核心配置-1"><a href="#%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心配置</h4>\n<p>rspack.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6831489852762141000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const path = require(\'path\');\nconst { defineConfig } = require(\'@rspack/cli\');\nconst fs = require(\'fs\');\n// const MonacoWebpackPlugin = require(\'monaco-editor-webpack-plugin\')\n// const NodePolyfill = require(\'@rspack/plugin-node-polyfill\')\n\nconst appDirectory = fs.realpathSync(process.cwd());\nconst resolveApp = (relativePath) => path.resolve(appDirectory, relativePath);\n\nconst dotenv = resolveApp(\'.env\');\n\nconst NODE_ENV = process.env.NODE_ENV;\n// https://github.com/bkeepers/dotenv#what-other-env-files-can-i-use\nconst dotenvFiles = [\n   \\`\\${dotenv}.\\${NODE_ENV}.local\\`,\n   // Don\'t include \\`.env.local\\` for \\`test\\` environment\n   // since normally you expect tests to produce the same\n   // results for everyone\n   NODE_ENV !== \'test\' && \\`\\${dotenv}.local\\`,\n   \\`\\${dotenv}.\\${NODE_ENV}\\`,\n   dotenv\n].filter(Boolean);\n\n// Load environment variables from .env* files. Suppress warnings using silent\n// if this file is missing. dotenv will never modify any environment variables\n// that have already been set.  Variable expansion is supported in .env files.\n// https://github.com/motdotla/dotenv\n// https://github.com/motdotla/dotenv-expand\ndotenvFiles.forEach((dotenvFile) => {\n   if (fs.existsSync(dotenvFile)) {\n      require(\'dotenv-expand\')(\n         require(\'dotenv\').config({\n            path: dotenvFile\n         })\n      );\n   }\n});\n\nconst { DISABLE_OVERLAY } = process.env;\n\nmodule.exports = defineConfig({\n   mode: \'development\',\n   entry: {\n      main: \'./src/index.js\'\n   },\n   builtins: {\n      html: [\n         {\n            template: \'./public/index.html\'\n         }\n      ],\n      pluginImport: [\n         {\n            libraryName: \'antd\',\n            libraryDirectory: \'es\',\n            style: true\n         }\n      ],\n      define: {\n         // \'process.env.NODE_ENV\': &quot;\'development\'&quot;,\n         \'import.meta.env\': &quot;\'development\'&quot;,\n         \'import.meta.env.MODE\': &quot;\'development\'&quot;,\n         \'process.env.NODE_DEBUG\': false,\n         \'process.env.BUILD_TOOL\': &quot;\'rspack\'&quot;\n      }\n   },\n   module: {\n      rules: [\n         {\n            test: /\\.js\\$/,\n            include: /src/,\n            type: \'jsx\'\n         },\n         {\n            test: /\\.less\\$/,\n            exclude: /node_modules/,\n            use: [\n               {\n                  loader: \'less-loader\',\n                  options: {\n                     lessOptions: { javascriptEnabled: true }\n                  }\n               }\n            ],\n            type: \'css/module\'\n         },\n         {\n            test: /\\.less\\$/,\n            include: /node_modules/,\n            use: [\n               {\n                  loader: \'less-loader\',\n                  options: {\n                     lessOptions: { javascriptEnabled: true }\n                  }\n               }\n            ],\n            type: \'css\'\n         },\n         // {\n         //   test: /\\.css\\$/,\n         //   type: \'css\'\n         // },\n         {\n            test: /\\.(png|svg|jpg|jpeg|ttf)\\$/,\n            type: \'asset\'\n         }\n      ]\n   },\n   resolve: {\n      alias: {\n         \'@\': path.resolve(__dirname, \'./src\'),\n         \'antd/es/theme\': false // 修复因 @ant-design/pro-components 导致的编译报错问题\n      },\n      extensions: [\'.js\'],\n      mainFields: [\'main\', \'browser\', \'module\']\n   },\n   // plugins: [\n   //   new MonacoWebpackPlugin({\n   //     languages: [\'json\']\n   //   })\n   //   // new NodePolyfill()\n   // ],\n   devServer: {\n      port: 3000,\n      allowedHosts: \'all\',\n      client: {\n         overlay: !DISABLE_OVERLAY\n      }\n   },\n   devtool: \'source-map\',\n   snapshot: {\n      resolve: {\n         hash: true,\n         timestamp: false\n      },\n      module: {\n         hash: true,\n         timestamp: false\n      }\n   },\n   stats: {\n      preset: \'errors-only\',\n      reasons: true,\n      hash: true,\n      builtAt: true,\n      timings: true\n   },\n   experiments: {\n      incrementalRebuild: true\n   }\n});`, `6831489852762141000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'@rspack/cli\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// const MonacoWebpackPlugin = require(\'monaco-editor-webpack-plugin\')</span>\n<span class="token comment">// const NodePolyfill = require(\'@rspack/plugin-node-polyfill\')</span>\n\n<span class="token keyword">const</span> appDirectory <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">realpathSync</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token function-variable function">resolveApp</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">relativePath</span><span class="token punctuation">)</span> <span class="token operator">=></span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>appDirectory<span class="token punctuation">,</span> relativePath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> dotenv <span class="token operator">=</span> <span class="token function">resolveApp</span><span class="token punctuation">(</span><span class="token string">\'.env\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">NODE_ENV</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token punctuation">;</span>\n<span class="token comment">// https://github.com/bkeepers/dotenv#what-other-env-files-can-i-use</span>\n<span class="token keyword">const</span> dotenvFiles <span class="token operator">=</span> <span class="token punctuation">[</span>\n   <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dotenv<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">NODE_ENV</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.local</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n   <span class="token comment">// Don\'t include `.env.local` for `test` environment</span>\n   <span class="token comment">// since normally you expect tests to produce the same</span>\n   <span class="token comment">// results for everyone</span>\n   <span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">\'test\'</span> <span class="token operator">&amp;&amp;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dotenv<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.local</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n   <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dotenv<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">NODE_ENV</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n   dotenv\n<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Load environment variables from .env* files. Suppress warnings using silent</span>\n<span class="token comment">// if this file is missing. dotenv will never modify any environment variables</span>\n<span class="token comment">// that have already been set.  Variable expansion is supported in .env files.</span>\n<span class="token comment">// https://github.com/motdotla/dotenv</span>\n<span class="token comment">// https://github.com/motdotla/dotenv-expand</span>\ndotenvFiles<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dotenvFile</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>dotenvFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'dotenv-expand\'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>\n         <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'dotenv\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            path<span class="token punctuation">:</span> dotenvFile\n         <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">DISABLE_OVERLAY</span> <span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n   mode<span class="token punctuation">:</span> <span class="token string">\'development\'</span><span class="token punctuation">,</span>\n   entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      main<span class="token punctuation">:</span> <span class="token string">\'./src/index.js\'</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   builtins<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      html<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n         <span class="token punctuation">{</span>\n            template<span class="token punctuation">:</span> <span class="token string">\'./public/index.html\'</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span><span class="token punctuation">,</span>\n      pluginImport<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n         <span class="token punctuation">{</span>\n            libraryName<span class="token punctuation">:</span> <span class="token string">\'antd\'</span><span class="token punctuation">,</span>\n            libraryDirectory<span class="token punctuation">:</span> <span class="token string">\'es\'</span><span class="token punctuation">,</span>\n            style<span class="token punctuation">:</span> <span class="token boolean">true</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span><span class="token punctuation">,</span>\n      define<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         <span class="token comment">// \'process.env.NODE_ENV\': "\'development\'",</span>\n         <span class="token string">\'import.meta.env\'</span><span class="token punctuation">:</span> <span class="token string">"\'development\'"</span><span class="token punctuation">,</span>\n         <span class="token string">\'import.meta.env.MODE\'</span><span class="token punctuation">:</span> <span class="token string">"\'development\'"</span><span class="token punctuation">,</span>\n         <span class="token string">\'process.env.NODE_DEBUG\'</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n         <span class="token string">\'process.env.BUILD_TOOL\'</span><span class="token punctuation">:</span> <span class="token string">"\'rspack\'"</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   module<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n         <span class="token punctuation">{</span>\n            test<span class="token punctuation">:</span> <span class="token regex">/\\.js$/</span><span class="token punctuation">,</span>\n            include<span class="token punctuation">:</span> <span class="token regex">/src/</span><span class="token punctuation">,</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'jsx\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            test<span class="token punctuation">:</span> <span class="token regex">/\\.less$/</span><span class="token punctuation">,</span>\n            exclude<span class="token punctuation">:</span> <span class="token regex">/node_modules/</span><span class="token punctuation">,</span>\n            use<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n               <span class="token punctuation">{</span>\n                  loader<span class="token punctuation">:</span> <span class="token string">\'less-loader\'</span><span class="token punctuation">,</span>\n                  options<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                     lessOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span> javascriptEnabled<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>\n                  <span class="token punctuation">}</span>\n               <span class="token punctuation">}</span>\n            <span class="token punctuation">]</span><span class="token punctuation">,</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'css/module\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            test<span class="token punctuation">:</span> <span class="token regex">/\\.less$/</span><span class="token punctuation">,</span>\n            include<span class="token punctuation">:</span> <span class="token regex">/node_modules/</span><span class="token punctuation">,</span>\n            use<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n               <span class="token punctuation">{</span>\n                  loader<span class="token punctuation">:</span> <span class="token string">\'less-loader\'</span><span class="token punctuation">,</span>\n                  options<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                     lessOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span> javascriptEnabled<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>\n                  <span class="token punctuation">}</span>\n               <span class="token punctuation">}</span>\n            <span class="token punctuation">]</span><span class="token punctuation">,</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'css\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         <span class="token comment">// {</span>\n         <span class="token comment">//   test: /\\.css$/,</span>\n         <span class="token comment">//   type: \'css\'</span>\n         <span class="token comment">// },</span>\n         <span class="token punctuation">{</span>\n            test<span class="token punctuation">:</span> <span class="token regex">/\\.(png|svg|jpg|jpeg|ttf)$/</span><span class="token punctuation">,</span>\n            type<span class="token punctuation">:</span> <span class="token string">\'asset\'</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   resolve<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      alias<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         <span class="token string">\'@\'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'./src\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token string">\'antd/es/theme\'</span><span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token comment">// 修复因 @ant-design/pro-components 导致的编译报错问题</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      extensions<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'.js\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n      mainFields<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'main\'</span><span class="token punctuation">,</span> <span class="token string">\'browser\'</span><span class="token punctuation">,</span> <span class="token string">\'module\'</span><span class="token punctuation">]</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token comment">// plugins: [</span>\n   <span class="token comment">//   new MonacoWebpackPlugin({</span>\n   <span class="token comment">//     languages: [\'json\']</span>\n   <span class="token comment">//   })</span>\n   <span class="token comment">//   // new NodePolyfill()</span>\n   <span class="token comment">// ],</span>\n   devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      port<span class="token punctuation">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>\n      allowedHosts<span class="token punctuation">:</span> <span class="token string">\'all\'</span><span class="token punctuation">,</span>\n      client<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         overlay<span class="token punctuation">:</span> <span class="token operator">!</span><span class="token constant">DISABLE_OVERLAY</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   devtool<span class="token punctuation">:</span> <span class="token string">\'source-map\'</span><span class="token punctuation">,</span>\n   snapshot<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      resolve<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         hash<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n         timestamp<span class="token punctuation">:</span> <span class="token boolean">false</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      module<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         hash<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n         timestamp<span class="token punctuation">:</span> <span class="token boolean">false</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   stats<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      preset<span class="token punctuation">:</span> <span class="token string">\'errors-only\'</span><span class="token punctuation">,</span>\n      reasons<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n      hash<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n      builtAt<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n      timings<span class="token punctuation">:</span> <span class="token boolean">true</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   experiments<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      incrementalRebuild<span class="token punctuation">:</span> <span class="token boolean">true</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="运行模板-1"><a href="#%E8%BF%90%E8%A1%8C%E6%A8%A1%E6%9D%BF-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行模板</h4>\n<p><a href="https://github.com/towavephone/GatsbyBlog/tree/master/template/rspack-js-template" target="_blank" rel="nofollow noreferrer noopener">仓库地址</a></p>\n<h4 id="优缺点-1"><a href="#%E4%BC%98%E7%BC%BA%E7%82%B9-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优缺点</h4>\n<ul>\n<li>优点：首次编译，hmr 速度快</li>\n<li>缺点：目前只适用于开发环境，主要是还不支持 <code class="language-text">worker-loader</code> 的用法</li>\n</ul>\n<p>由于以上原因，暂时只在开发模式下使用</p>\n<h3 id="vite"><a href="#vite" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>vite</h3>\n<h4 id="核心配置-2"><a href="#%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心配置</h4>\n<ol>\n<li>index.html 下的 script 脚本需要改成 module 类型</li>\n<li>worker-loader 替换为 <code class="language-text">import Worker from &#39;文件路径?worker&#39;</code></li>\n<li>所有使用 require 的地方替换为 import</li>\n</ol>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37218407713581050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n   &quot;devDependencies&quot;: {\n      &quot;@vitejs/plugin-react&quot;: &quot;^3.1.0&quot;,\n      &quot;vite&quot;: &quot;^4.3.1&quot;,\n      &quot;vite-plugin-imp&quot;: &quot;^2.3.1&quot;\n   }\n}`, `37218407713581050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n   <span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"@vitejs/plugin-react"</span><span class="token operator">:</span> <span class="token string">"^3.1.0"</span><span class="token punctuation">,</span>\n      <span class="token property">"vite"</span><span class="token operator">:</span> <span class="token string">"^4.3.1"</span><span class="token punctuation">,</span>\n      <span class="token property">"vite-plugin-imp"</span><span class="token operator">:</span> <span class="token string">"^2.3.1"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>vite.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45044411570774860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { defineConfig } from \'vite\';\nimport react from \'@vitejs/plugin-react\';\nimport fs from \'fs/promises\';\nimport path from \'path\';\nimport vitePluginImp from \'vite-plugin-imp\';\n\nexport default defineConfig({\n   plugins: [react(), vitePluginImp()],\n   css: {\n      preprocessorOptions: {\n         less: {\n            javascriptEnabled: true\n         }\n      }\n   },\n   esbuild: {\n      loader: \'jsx\',\n      include: /src\\/.*\\.js?\\$/,\n      exclude: []\n   },\n   resolve: {\n      alias: [\n         {\n            // 处理 @import \'~antd/es/style/themes/default.less\' 报错\n            find: /^~/,\n            replacement: \'\'\n         },\n         {\n            find: \'@\',\n            replacement: path.resolve(__dirname, \'./src\')\n         }\n      ]\n   },\n   define: {\n      \'import.meta.env\': &quot;\'development\'&quot;,\n      \'process.env.NODE_DEBUG\': false,\n      \'module.hot\': false\n   },\n   server: {\n      port: 3000\n   },\n   optimizeDeps: {\n      esbuildOptions: {\n         plugins: [\n            {\n               name: \'load-js-files-as-jsx\',\n               // 把 js 文件当成 jsx 处理\n               setup(build) {\n                  build.onLoad({ filter: /src\\/.*\\.js\\$/ }, async (args) => ({\n                     loader: \'jsx\',\n                     contents: await fs.readFile(args.path, \'utf8\')\n                  }));\n               }\n            }\n         ]\n      }\n   }\n});`, `45044411570774860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'vite\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> react <span class="token keyword">from</span> <span class="token string">\'@vitejs/plugin-react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> fs <span class="token keyword">from</span> <span class="token string">\'fs/promises\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">\'path\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> vitePluginImp <span class="token keyword">from</span> <span class="token string">\'vite-plugin-imp\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n   plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token function">react</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">vitePluginImp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n   css<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      preprocessorOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         less<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            javascriptEnabled<span class="token punctuation">:</span> <span class="token boolean">true</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   esbuild<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      loader<span class="token punctuation">:</span> <span class="token string">\'jsx\'</span><span class="token punctuation">,</span>\n      include<span class="token punctuation">:</span> <span class="token regex">/src\\/.*\\.js?$/</span><span class="token punctuation">,</span>\n      exclude<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   resolve<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      alias<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n         <span class="token punctuation">{</span>\n            <span class="token comment">// 处理 @import \'~antd/es/style/themes/default.less\' 报错</span>\n            find<span class="token punctuation">:</span> <span class="token regex">/^~/</span><span class="token punctuation">,</span>\n            replacement<span class="token punctuation">:</span> <span class="token string">\'\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            find<span class="token punctuation">:</span> <span class="token string">\'@\'</span><span class="token punctuation">,</span>\n            replacement<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'./src\'</span><span class="token punctuation">)</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   define<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      <span class="token string">\'import.meta.env\'</span><span class="token punctuation">:</span> <span class="token string">"\'development\'"</span><span class="token punctuation">,</span>\n      <span class="token string">\'process.env.NODE_DEBUG\'</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n      <span class="token string">\'module.hot\'</span><span class="token punctuation">:</span> <span class="token boolean">false</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   server<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      port<span class="token punctuation">:</span> <span class="token number">3000</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   optimizeDeps<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      esbuildOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n            <span class="token punctuation">{</span>\n               name<span class="token punctuation">:</span> <span class="token string">\'load-js-files-as-jsx\'</span><span class="token punctuation">,</span>\n               <span class="token comment">// 把 js 文件当成 jsx 处理</span>\n               <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">build</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                  build<span class="token punctuation">.</span><span class="token function">onLoad</span><span class="token punctuation">(</span><span class="token punctuation">{</span> filter<span class="token punctuation">:</span> <span class="token regex">/src\\/.*\\.js$/</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>\n                     loader<span class="token punctuation">:</span> <span class="token string">\'jsx\'</span><span class="token punctuation">,</span>\n                     contents<span class="token punctuation">:</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token string">\'utf8\'</span><span class="token punctuation">)</span>\n                  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n               <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">]</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="优缺点-2"><a href="#%E4%BC%98%E7%BC%BA%E7%82%B9-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优缺点</h4>\n<ul>\n<li>优点：首次编译速度快</li>\n<li>缺点：此方案初次页面跳转编译速度较慢，而且编译问题较多，同时不太适合生产环境使用</li>\n</ul>\n<p>由于以上原因，不采用此方案</p>\n<h3 id="dockerfile-pnpm-缓存不生效"><a href="#dockerfile-pnpm-%E7%BC%93%E5%AD%98%E4%B8%8D%E7%94%9F%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dockerfile pnpm 缓存不生效</h3>\n<h4 id="需求背景-9"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h4>\n<p>在 jenkins 下运行 docker，缓存不能被使用，因为是跨磁盘（home 目录与 root 目录不在一个磁盘上）的，即 pnpm 不支持硬连接操作，同时 pnpm@7.14.1 也没有对这种情况进行处理，详见 <a href="https://github.com/pnpm/pnpm/releases/tag/v7.14.2" target="_blank" rel="nofollow noreferrer noopener">资料</a></p>\n<h4 id="解决方案-2"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h4>\n<ol>\n<li>升级到 pnpm@7 下的最新版本</li>\n<li>设置缓存路径</li>\n</ol>\n<p>Dockerfile-client-buildkit</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47457059426107890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# syntax = docker/dockerfile:experimental\n\nFROM node:14-alpine as builder\n\nARG registry=https://registry.npmmirror.com\n\n# 全局安装依赖，尽量写在一行防止加了新库之后还是使用原来的镜像\nRUN npm config set registry \\${registry} -g && npm i -g pnpm@7.32.1\n\nWORKDIR /home/\n\n# 缓存 pnpm-lock.yaml\nCOPY pnpm-lock.yaml ./\n\n# 下载依赖到全局位置\nRUN --mount=type=cache,target=/root/.local/share/pnpm/store/v3,id=pnpm_cache \\\n    pnpm fetch --prod\n\n# 复制剩余文件\nCOPY . .\n\n# 安装依赖\nRUN --mount=type=cache,target=node_modules,id=frontend_node_modules,sharing=locked \\\n    --mount=type=cache,target=/root/.local/share/pnpm/store/v3,id=pnpm_cache \\\n    pnpm i --ignore-scripts=true --prod --offline --registry=\\$registry\n\nRUN --mount=type=cache,target=node_modules,id=frontend_node_modules,sharing=locked \\\n    pnpm build\n\nFROM nginx:alpine\n\nRUN --mount=type=bind,target=/tmp/build,from=builder,source=/home/build \\\n    cp -r /tmp/build/* /usr/share/nginx/html/\n\nCOPY nginx.conf /etc/nginx/conf.d/default.conf\n\nEXPOSE 3000`, `47457059426107890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile{8,16,24}"\n              >\n                <span class="gatsby-code-button-language">dockerfile{8,16,24}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># syntax = docker/dockerfile:experimental</span>\n\n<span class="token keyword">FROM</span> node<span class="token punctuation">:</span>14<span class="token punctuation">-</span>alpine as builder\n\n<span class="token keyword">ARG</span> registry=https<span class="token punctuation">:</span>//registry.npmmirror.com\n\n<span class="token comment"># 全局安装依赖，尽量写在一行防止加了新库之后还是使用原来的镜像</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">RUN</span> npm config set registry $<span class="token punctuation">{</span>registry<span class="token punctuation">}</span> <span class="token punctuation">-</span>g &amp;&amp; npm i <span class="token punctuation">-</span>g pnpm@7.32.1</span>\n<span class="token keyword">WORKDIR</span> /home/\n\n<span class="token comment"># 缓存 pnpm-lock.yaml</span>\n<span class="token keyword">COPY</span> pnpm<span class="token punctuation">-</span>lock.yaml ./\n\n<span class="token comment"># 下载依赖到全局位置</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=/root/.local/share/pnpm/store/v3<span class="token punctuation">,</span>id=pnpm_cache \\</span>    pnpm fetch <span class="token punctuation">-</span><span class="token punctuation">-</span>prod\n\n<span class="token comment"># 复制剩余文件</span>\n<span class="token keyword">COPY</span> . .\n\n<span class="token comment"># 安装依赖</span>\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=node_modules<span class="token punctuation">,</span>id=frontend_node_modules<span class="token punctuation">,</span>sharing=locked \\\n<span class="gatsby-highlight-code-line">    <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=/root/.local/share/pnpm/store/v3<span class="token punctuation">,</span>id=pnpm_cache \\</span>    pnpm i <span class="token punctuation">-</span><span class="token punctuation">-</span>ignore<span class="token punctuation">-</span>scripts=true <span class="token punctuation">-</span><span class="token punctuation">-</span>prod <span class="token punctuation">-</span><span class="token punctuation">-</span>offline <span class="token punctuation">-</span><span class="token punctuation">-</span>registry=$registry\n\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=node_modules<span class="token punctuation">,</span>id=frontend_node_modules<span class="token punctuation">,</span>sharing=locked \\\n    pnpm build\n\n<span class="token keyword">FROM</span> nginx<span class="token punctuation">:</span>alpine\n\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=bind<span class="token punctuation">,</span>target=/tmp/build<span class="token punctuation">,</span>from=builder<span class="token punctuation">,</span>source=/home/build \\\n    cp <span class="token punctuation">-</span>r /tmp/build/* /usr/share/nginx/html/\n\n<span class="token keyword">COPY</span> nginx.conf /etc/nginx/conf.d/default.conf\n\n<span class="token keyword">EXPOSE</span> 3000</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="效果展示-1"><a href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果展示</h2>\n<p>以下都是在二次缓存下的展示，首次编译性能并没有一期优化的性能好</p>\n<h3 id="本地环境"><a href="#%E6%9C%AC%E5%9C%B0%E7%8E%AF%E5%A2%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>本地环境</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79720631230280100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Compiled successfully!\n\nYou can now view in the browser.\n\n  Local:            http://localhost:3000\n  On Your Network:  http://ip:3000\n\nNote that the development build is not optimized.\nTo create a production build, use npm run build.\n\n2023-04-25 16:54:30: webpack 5.78.0 compiled successfully in 18559 ms (c2255578550bc936f958)`, `79720631230280100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Compiled successfully<span class="token operator">!</span>\n\nYou can now view <span class="token keyword">in</span> the browser.\n\n  Local:            http://localhost:3000\n  On Your Network:  http://ip:3000\n\nNote that the development build is not optimized.\nTo create a production build, use <span class="token function">npm</span> run build.\n\n<span class="token number">2023</span>-04-25 <span class="token number">16</span>:54:30: webpack <span class="token number">5.78</span>.0 compiled successfully <span class="token keyword">in</span> <span class="token number">18559</span> ms <span class="token punctuation">(</span>c2255578550bc936f958<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="生产环境-1"><a href="#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生产环境</h3>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-04-25-16-58-25-6846f4ecf5de0d69ad7fc8ace49a11a1-a2427.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 25.995807127882596%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsSAAALEgHS3X78AAAA60lEQVQY0zWO23KEIBBE/f+/y+ayXiIgjMKAchGExN2KIQ+Z6odTNdPT3VzX9fM315GOFJP3IcborMvHUXLRqEMI1rm47xXWdQ0+IGI9MNo0MWVjjHNOagkScNNqRb4ItRltNZeg1DwTImYu/rfTzCtIoxquNmdtjYaMY+bTKUmGLhD+UOKpxgwsTlx3NNCxwPS90AKtJ/xU4sQGN1/71PJzwfEQ09dCD+g8EQ+EZ30HU+LgRrYzUoCVmWZoHRGngmoWyigpU0rDRl+3rt9Z6z5v2PaRVb3ZoTVdL14+dPtuhz7QGnvDe4UhsF8fsxH36JCIMQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 04 25 16 58 25" title="" data-src="/static/2023-04-25-16-58-25-6846f4ecf5de0d69ad7fc8ace49a11a1-fee1c.png" data-srcset="/static/2023-04-25-16-58-25-6846f4ecf5de0d69ad7fc8ace49a11a1-a67b7.png 200w,\n/static/2023-04-25-16-58-25-6846f4ecf5de0d69ad7fc8ace49a11a1-0b187.png 400w,\n/static/2023-04-25-16-58-25-6846f4ecf5de0d69ad7fc8ace49a11a1-fee1c.png 800w,\n/static/2023-04-25-16-58-25-6846f4ecf5de0d69ad7fc8ace49a11a1-b1a91.png 1200w,\n/static/2023-04-25-16-58-25-6846f4ecf5de0d69ad7fc8ace49a11a1-a2427.png 1431w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h2 id="后期优化-1"><a href="#%E5%90%8E%E6%9C%9F%E4%BC%98%E5%8C%96-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后期优化</h2>\n<p>待 rspack 生产环境可用且性能较好的时候考虑迁移</p>\n<h1 id="三期优化"><a href="#%E4%B8%89%E6%9C%9F%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>三期优化</h1>\n<h2 id="具体功能-2"><a href="#%E5%85%B7%E4%BD%93%E5%8A%9F%E8%83%BD-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体功能</h2>\n<h3 id="格式化"><a href="#%E6%A0%BC%E5%BC%8F%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>格式化</h3>\n<p>需要对老项目的 js 代码格式化，分为 eslint/prettier</p>\n<p>如下可实现 git commit 前只对暂存到 git 的代码进行格式化修复及校验</p>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8926896546259666000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;scripts&quot;: {\n   &quot;eslint&quot;: &quot;npm run eslint:files -- src&quot;,\n   &quot;eslint:files&quot;: &quot;eslint --cache --cache-location node_modules/.cache/.eslintcache --cache-strategy content --ext .js --max-warnings 0&quot;,\n   &quot;fix&quot;: &quot;npm run fix:js&quot;,\n   &quot;fix:js&quot;: &quot;npm run prettier -- --write&quot;,\n   &quot;fl&quot;: &quot;npm run fix && npm run lint&quot;,\n   &quot;lint&quot;: &quot;npm run lint:js&quot;,\n   &quot;lint:js&quot;: &quot;npm run prettier -- --check && npm run eslint&quot;,\n   &quot;lint:js:log2file&quot;: &quot;npm run prettier -- --check && npm run eslint -- -o .cra/eslint-error.log --no-color&quot;,\n   &quot;lint:log2file&quot;: &quot;npm run lint:js:log2file&quot;,\n   &quot;prettier&quot;: &quot;npm run prettier:files -- \'src/**/*.js\'&quot;,\n   &quot;prettier:files&quot;: &quot;prettier --cache --cache-strategy content&quot;\n},\n&quot;husky&quot;: {\n   &quot;hooks&quot;: {\n      &quot;pre-commit&quot;: &quot;node scripts/pre-commit.js&quot;\n   }\n},\n&quot;dependencies&quot;: {\n   &quot;eslint-config-prettier&quot;: &quot;^8.8.0&quot;,\n   &quot;eslint-plugin-eslint-comments&quot;: &quot;^3.2.0&quot;,\n   &quot;prettier&quot;: &quot;^2.8.8&quot;,\n   &quot;confusing-browser-globals&quot;: &quot;^1.0.11&quot;\n},\n&quot;devDependencies&quot;: {\n   &quot;husky&quot;: &quot;^1.0.0-rc.2&quot;,\n   &quot;lint-staged&quot;: &quot;^13.2.2&quot;\n}`, `8926896546259666000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n   <span class="token property">"eslint"</span><span class="token operator">:</span> <span class="token string">"npm run eslint:files -- src"</span><span class="token punctuation">,</span>\n   <span class="token property">"eslint:files"</span><span class="token operator">:</span> <span class="token string">"eslint --cache --cache-location node_modules/.cache/.eslintcache --cache-strategy content --ext .js --max-warnings 0"</span><span class="token punctuation">,</span>\n   <span class="token property">"fix"</span><span class="token operator">:</span> <span class="token string">"npm run fix:js"</span><span class="token punctuation">,</span>\n   <span class="token property">"fix:js"</span><span class="token operator">:</span> <span class="token string">"npm run prettier -- --write"</span><span class="token punctuation">,</span>\n   <span class="token property">"fl"</span><span class="token operator">:</span> <span class="token string">"npm run fix &amp;&amp; npm run lint"</span><span class="token punctuation">,</span>\n   <span class="token property">"lint"</span><span class="token operator">:</span> <span class="token string">"npm run lint:js"</span><span class="token punctuation">,</span>\n   <span class="token property">"lint:js"</span><span class="token operator">:</span> <span class="token string">"npm run prettier -- --check &amp;&amp; npm run eslint"</span><span class="token punctuation">,</span>\n   <span class="token property">"lint:js:log2file"</span><span class="token operator">:</span> <span class="token string">"npm run prettier -- --check &amp;&amp; npm run eslint -- -o .cra/eslint-error.log --no-color"</span><span class="token punctuation">,</span>\n   <span class="token property">"lint:log2file"</span><span class="token operator">:</span> <span class="token string">"npm run lint:js:log2file"</span><span class="token punctuation">,</span>\n   <span class="token property">"prettier"</span><span class="token operator">:</span> <span class="token string">"npm run prettier:files -- \'src/**/*.js\'"</span><span class="token punctuation">,</span>\n   <span class="token property">"prettier:files"</span><span class="token operator">:</span> <span class="token string">"prettier --cache --cache-strategy content"</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token property">"husky"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n   <span class="token property">"hooks"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"pre-commit"</span><span class="token operator">:</span> <span class="token string">"node scripts/pre-commit.js"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n   <span class="token property">"eslint-config-prettier"</span><span class="token operator">:</span> <span class="token string">"^8.8.0"</span><span class="token punctuation">,</span>\n   <span class="token property">"eslint-plugin-eslint-comments"</span><span class="token operator">:</span> <span class="token string">"^3.2.0"</span><span class="token punctuation">,</span>\n   <span class="token property">"prettier"</span><span class="token operator">:</span> <span class="token string">"^2.8.8"</span><span class="token punctuation">,</span>\n   <span class="token property">"confusing-browser-globals"</span><span class="token operator">:</span> <span class="token string">"^1.0.11"</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n   <span class="token property">"husky"</span><span class="token operator">:</span> <span class="token string">"^1.0.0-rc.2"</span><span class="token punctuation">,</span>\n   <span class="token property">"lint-staged"</span><span class="token operator">:</span> <span class="token string">"^13.2.2"</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>scripts/pre-commit.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20100854743534514000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const child_process = require(\'child_process\');\n\nfunction spawn(mainModule) {\n   const worker = child_process.spawn(\'lint-staged\', mainModule, {\n      stdio: \'inherit\'\n   });\n\n   worker.on(\'exit\', function(code) {\n      if (code !== 0) {\n         process.exit(1);\n      }\n   });\n}\n\nspawn([\'--no-stash\']);`, `20100854743534514000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> child_process <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'child_process\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token parameter">mainModule</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> worker <span class="token operator">=</span> child_process<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">\'lint-staged\'</span><span class="token punctuation">,</span> mainModule<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      stdio<span class="token punctuation">:</span> <span class="token string">\'inherit\'</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'exit\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">spawn</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'--no-stash\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>.eslintrc.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52288239896500355000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const restrictedGlobals = require(\'confusing-browser-globals\');\n\nconst excludeRestrictedGlobals = restrictedGlobals.filter((item) => ![\'self\'].includes(item));\n\n// console.log(\'excludeRestrictedGlobals\', excludeRestrictedGlobals)\n\nmodule.exports = {\n   extends: [\'react-app\', \'prettier\', \'plugin:eslint-comments/recommended\'],\n   // plugins: [\'prettier\'],\n   rules: {\n      // \'prettier/prettier\': 2,\n      \'no-unused-vars\': 2,\n      \'no-restricted-globals\': [\'error\'].concat(excludeRestrictedGlobals),\n      \'no-debugger\': 2,\n      \'eslint-comments/no-use\': [\'error\', { allow: [\'eslint-disable-next-line\'] }]\n   }\n};`, `52288239896500355000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> restrictedGlobals <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'confusing-browser-globals\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> excludeRestrictedGlobals <span class="token operator">=</span> restrictedGlobals<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token operator">!</span><span class="token punctuation">[</span><span class="token string">\'self\'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// console.log(\'excludeRestrictedGlobals\', excludeRestrictedGlobals)</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   <span class="token keyword">extends</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'react-app\'</span><span class="token punctuation">,</span> <span class="token string">\'prettier\'</span><span class="token punctuation">,</span> <span class="token string">\'plugin:eslint-comments/recommended\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n   <span class="token comment">// plugins: [\'prettier\'],</span>\n   rules<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      <span class="token comment">// \'prettier/prettier\': 2,</span>\n      <span class="token string">\'no-unused-vars\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n      <span class="token string">\'no-restricted-globals\'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'error\'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>excludeRestrictedGlobals<span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token string">\'no-debugger\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n      <span class="token string">\'eslint-comments/no-use\'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'error\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> allow<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'eslint-disable-next-line\'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">]</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>.prettierrc.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57810983170272110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n   arrowParens: \'avoid\',\n   bracketSpacing: true,\n   printWidth: 200,\n   semi: false,\n   singleQuote: true,\n   tabWidth: 2,\n   trailingComma: \'none\',\n   useTabs: false\n};`, `57810983170272110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   arrowParens<span class="token punctuation">:</span> <span class="token string">\'avoid\'</span><span class="token punctuation">,</span>\n   bracketSpacing<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n   printWidth<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>\n   semi<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n   singleQuote<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n   tabWidth<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n   trailingComma<span class="token punctuation">:</span> <span class="token string">\'none\'</span><span class="token punctuation">,</span>\n   useTabs<span class="token punctuation">:</span> <span class="token boolean">false</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>.lintstagedrc.mjs</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52003889776732200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { ESLint } from \'eslint\';\n\nconst removeIgnoredFiles = async (files) => {\n   const eslint = new ESLint();\n   const isIgnored = await Promise.all(\n      files.map((file) => {\n         return eslint.isPathIgnored(file);\n      })\n   );\n   const filteredFiles = files.filter((_, i) => !isIgnored[i]);\n   return filteredFiles;\n};\n\nexport default {\n   \'src/**/*.js\': async (files) => {\n      let filteredFiles = await removeIgnoredFiles(files);\n\n      if (filteredFiles.length === 0) {\n         return [];\n      }\n\n      // 提交文件超过 20 个的强制检测全部文件\n      if (filteredFiles.length > 20) {\n         filteredFiles = [\'src/**/*.js\'];\n      }\n\n      // console.log(\'filteredFiles\', filteredFiles)\n\n      const filesToLint = filteredFiles.join(\' \');\n      const cmds = [\n         \\`npm run prettier:files -- --write \\${filesToLint}\\`,\n         \\`npm run prettier:files -- --check \\${filesToLint}\\`,\n         \\`npm run eslint:files -- \\${filesToLint}\\`\n      ];\n      // console.log(\'cmds\', cmds)\n      return cmds;\n   }\n};`, `52003889776732200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> ESLint <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'eslint\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">removeIgnoredFiles</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">files</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> eslint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ESLint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> isIgnored <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>\n      files<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span> eslint<span class="token punctuation">.</span><span class="token function">isPathIgnored</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> filteredFiles <span class="token operator">=</span> files<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token operator">!</span>isIgnored<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> filteredFiles<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>\n   <span class="token string">\'src/**/*.js\'</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">files</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> filteredFiles <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">removeIgnoredFiles</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>filteredFiles<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// 提交文件超过 20 个的强制检测全部文件</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>filteredFiles<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         filteredFiles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'src/**/*.js\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// console.log(\'filteredFiles\', filteredFiles)</span>\n\n      <span class="token keyword">const</span> filesToLint <span class="token operator">=</span> filteredFiles<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\' \'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> cmds <span class="token operator">=</span> <span class="token punctuation">[</span>\n         <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">npm run prettier:files -- --write </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filesToLint<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n         <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">npm run prettier:files -- --check </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filesToLint<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n         <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">npm run eslint:files -- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filesToLint<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n      <span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token comment">// console.log(\'cmds\', cmds)</span>\n      <span class="token keyword">return</span> cmds<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="分包策略"><a href="#%E5%88%86%E5%8C%85%E7%AD%96%E7%95%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分包策略</h3>\n<p>config-overrides.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50587576227985880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const {\n   override,\n   addBabelPlugins,\n   fixBabelImports,\n   addLessLoader,\n   removeModuleScopePlugin,\n   setWebpackOptimizationSplitChunks,\n   addWebpackPlugin,\n   addWebpackAlias,\n   adjustStyleLoaders\n} = require(\'customize-cra\');\nconst fs = require(\'fs\');\nconst webpack = require(\'webpack\');\nconst path = require(\'path\');\nconst MonacoWebpackPlugin = require(\'monaco-editor-webpack-plugin\');\nconst WebpackBarPlugin = require(\'webpackbar\');\nconst { get, pick } = require(\'lodash\');\nconst threadLoader = require(\'thread-loader\');\nconst BundleAnalyzerPlugin = require(\'webpack-bundle-analyzer\').BundleAnalyzerPlugin;\n\nconst { LAZY_BUILD, DISABLE_CACHE, DEBUG_CACHE, BUNDLE_ANALYZER, DISABLE_OVERLAY } = process.env;\n\nthreadLoader.warmup(\n   {\n      // pool options, like passed to loader options\n      // must match loader options to boot the correct pool\n   },\n   [\n      // modules to load\n      // can be any module, i. e.\n      \'babel-loader\'\n   ]\n);\n\nconst craDir = path.join(process.cwd() + \'/.cra\');\n\nif (!fs.existsSync(craDir)) {\n   fs.mkdirSync(craDir);\n}\n\nconst getLoaders = (webpackConfig, matcher) => {\n   const matchLoaders = get(webpackConfig, \'module.rules.0.oneOf\', []).filter((item) =>\n      get(item, \'loader\', \'\').includes(matcher)\n   );\n   return matchLoaders;\n};\n\nconst getAssetModules = (webpackConfig, matcher) => {\n   const matchLoaders = get(webpackConfig, \'module.rules.0.oneOf\', []).filter((item) =>\n      get(item, \'type\', \'\').includes(matcher)\n   );\n   return matchLoaders;\n};\n\nconst addBeforeLoaders = (webpackConfig, matcher, newLoader = []) => {\n   const matchLoaders = getLoaders(webpackConfig, matcher);\n   if (matchLoaders.length === 0) {\n      return;\n   }\n\n   matchLoaders.forEach((item) => {\n      const props = [\'loader\', \'options\'];\n      item.use = [...newLoader, pick(item, props)];\n      props.forEach((item2) => {\n         delete item[item2];\n      });\n   });\n};\n\nconst removeAssetDataUrlCondition = (webpackConfig) => {\n   const matchLoaders = getAssetModules(webpackConfig, \'asset\');\n   if (matchLoaders.length === 0) {\n      return;\n   }\n\n   matchLoaders.forEach((item) => {\n      if (!item.parser) {\n         return;\n      }\n      delete item.parser;\n   });\n};\n\nconst formatConfig = (config) =>\n   JSON.stringify(\n      config,\n      (key, value) => {\n         if (typeof value === \'function\') {\n            return value.toString();\n         }\n         return value;\n      },\n      2\n   );\n\nmodule.exports = {\n   webpack: (config, env) => {\n      const isProd = env === \'production\';\n\n      const localConfig = override(\n         addBabelPlugins(\n            [\'@babel/plugin-proposal-nullish-coalescing-operator\'],\n            [\'@babel/plugin-syntax-optional-chaining\']\n         ),\n         fixBabelImports(\'import\', {\n            libraryName: \'antd\',\n            libraryDirectory: \'es\',\n            style: true\n         }),\n         addLessLoader({\n            lessOptions: { javascriptEnabled: true }\n         }),\n         adjustStyleLoaders(({ use: [, , postcss] }) => {\n            const postcssOptions = postcss.options;\n            postcss.options = { postcssOptions };\n         }),\n         addWebpackAlias({\n            \'@\': path.resolve(__dirname, \'src\')\n         }),\n         removeModuleScopePlugin(),\n         isProd &&\n            // 分包原则：首先提取 node_modules 下的所有三方库，然后提取出 src 目录下引用超过 2 次的 chunk，对所有同步、异步包都生效\n            setWebpackOptimizationSplitChunks({\n               chunks: \'all\',\n               maxInitialRequests: 10,\n               minSize: 0,\n               cacheGroups: {\n                  defaultVendors: {\n                     // 抽取三方库\n                     test: (module) => {\n                        return /[\\\\/]node_modules[\\\\/]/.test(module.context);\n                     },\n                     name: (module) => {\n                        // 从后往前匹配 node_modules 后的包名\n                        //\n                        // /frontend/node_modules/.pnpm/@antv+g2plot@2.4.20/node_modules/@antv/g2plot/esm/plots/tiny-column/\n                        // 结果为 @antv\n                        //\n                        // /frontend/node_modules/@antv+g2plot@2.4.20/323\n                        // 结果为 @antv+g2plot@2.4.20\n                        //\n                        // /frontend/node_modules/@antv+g2plot@2.4.20\n                        // 结果为 @antv+g2plot@2.4.20\n                        const matchResult = module.context.match(/(?<=[\\\\/]node_modules[\\\\/])(.*?)(?=([\\\\/]|\\$))/g);\n                        const packageName = matchResult[matchResult.length - 1];\n                        // console.log(\\`packageName: \\${packageName}\\`, module.context)\n                        return \\`pnpm.\\${packageName.replace(/@|\\./g, \'\')}\\`;\n                     },\n                     priority: -10,\n                     reuseExistingChunk: true\n                  },\n                  default: {\n                     // 抽取页面的公共部分\n                     test: (module) => {\n                        // console.log(\'test module.context---------- \', module.context)\n                        return new RegExp(\\`\\${process.cwd()}[\\\\/](src|public)[\\\\/]\\`).test(module.context);\n                     },\n                     name: (module) => {\n                        // console.log(\'name module.context---------- \', module.resourceResolveData.relativePath)\n                        const relativePath = module.resourceResolveData.relativePath\n                           .split(\'/\')\n                           .slice(1)\n                           .join(\'~\');\n                        return relativePath;\n                     },\n                     minChunks: 2,\n                     priority: -20,\n                     reuseExistingChunk: true\n                  }\n               }\n            }),\n         addWebpackPlugin(\n            new MonacoWebpackPlugin({\n               languages: [\'json\']\n            })\n         ),\n         addWebpackPlugin(\n            new webpack.DefinePlugin({\n               \'process.env.BUILD_TOOL\': &quot;\'webpack\'&quot;\n            })\n         ),\n         addWebpackPlugin(\n            new webpack.ProvidePlugin({\n               Buffer: [\'buffer\', \'Buffer\']\n            })\n         ),\n         BUNDLE_ANALYZER &&\n            addWebpackPlugin(\n               new BundleAnalyzerPlugin({\n                  analyzerPort: 8080,\n                  generateStatsFile: true\n               })\n            ),\n         addWebpackPlugin(new WebpackBarPlugin())\n      )(config);\n\n      addBeforeLoaders(localConfig, \'babel-loader\', [\'thread-loader\']);\n      removeAssetDataUrlCondition(localConfig);\n\n      localConfig.resolve.extensions = [\'.js\'];\n      localConfig.resolve.modules = [\'node_modules\'];\n      localConfig.resolve.fallback = {\n         buffer: require.resolve(\'buffer\')\n      };\n\n      if (LAZY_BUILD) {\n         localConfig.experiments = {\n            lazyCompilation: {\n               // disable lazy compilation for dynamic imports\n               imports: true,\n\n               // disable lazy compilation for entries\n               entries: false\n\n               // do not lazily compile moduleB\n               // test: module => !/moduleB/.test(module.nameForCondition())\n            }\n         };\n      }\n\n      if (DEBUG_CACHE) {\n         localConfig.infrastructureLogging = {\n            debug: /webpack\\.cache/\n         };\n      }\n\n      if (DISABLE_CACHE) {\n         localConfig.cache = false;\n      }\n\n      if (!isProd) {\n         localConfig.stats = {\n            errors: true,\n            children: false,\n            warnings: false,\n            colors: true,\n            assets: false,\n            modules: false,\n            entrypoints: false,\n            timings: true,\n            builtAt: true,\n            hash: true\n         };\n      } else {\n         const instanceOfMiniCssExtractPlugin = localConfig.plugins.find(\n            (plugin) => plugin.constructor.name === \'MiniCssExtractPlugin\'\n         );\n\n         // 忽略样式导入顺序报错\n         // https://github.com/facebook/create-react-app/issues/5372\n         if (instanceOfMiniCssExtractPlugin) {\n            instanceOfMiniCssExtractPlugin.options.ignoreOrder = true;\n         }\n\n         localConfig.optimization = {\n            ...localConfig.optimization,\n            nodeEnv: \'production\',\n            sideEffects: true,\n            concatenateModules: true,\n            runtimeChunk: \'single\'\n         };\n      }\n\n      fs.writeFileSync(path.join(craDir, \\`webpack.\\${env}.json\\`), formatConfig(localConfig));\n\n      return localConfig;\n   },\n   devServer: (configFunction) => (proxy, allowedHost) => {\n      const config = configFunction(proxy, allowedHost);\n\n      config.allowedHosts = \'all\';\n\n      if (DISABLE_OVERLAY) {\n         config.client.overlay = false;\n      }\n\n      fs.writeFileSync(path.join(craDir, \'webpack-dev-server.json\'), formatConfig(config));\n\n      return config;\n   }\n};`, `50587576227985880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js{121-171,255-261}"\n              >\n                <span class="gatsby-code-button-language">js{121-171,255-261}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span>\n   override<span class="token punctuation">,</span>\n   addBabelPlugins<span class="token punctuation">,</span>\n   fixBabelImports<span class="token punctuation">,</span>\n   addLessLoader<span class="token punctuation">,</span>\n   removeModuleScopePlugin<span class="token punctuation">,</span>\n   setWebpackOptimizationSplitChunks<span class="token punctuation">,</span>\n   addWebpackPlugin<span class="token punctuation">,</span>\n   addWebpackAlias<span class="token punctuation">,</span>\n   adjustStyleLoaders\n<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'customize-cra\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpack\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> MonacoWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'monaco-editor-webpack-plugin\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> WebpackBarPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpackbar\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">,</span> pick <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> threadLoader <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'thread-loader\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> BundleAnalyzerPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'webpack-bundle-analyzer\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>BundleAnalyzerPlugin<span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">LAZY_BUILD</span><span class="token punctuation">,</span> <span class="token constant">DISABLE_CACHE</span><span class="token punctuation">,</span> <span class="token constant">DEBUG_CACHE</span><span class="token punctuation">,</span> <span class="token constant">BUNDLE_ANALYZER</span><span class="token punctuation">,</span> <span class="token constant">DISABLE_OVERLAY</span> <span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">;</span>\n\nthreadLoader<span class="token punctuation">.</span><span class="token function">warmup</span><span class="token punctuation">(</span>\n   <span class="token punctuation">{</span>\n      <span class="token comment">// pool options, like passed to loader options</span>\n      <span class="token comment">// must match loader options to boot the correct pool</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token punctuation">[</span>\n      <span class="token comment">// modules to load</span>\n      <span class="token comment">// can be any module, i. e.</span>\n      <span class="token string">\'babel-loader\'</span>\n   <span class="token punctuation">]</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> craDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">\'/.cra\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>craDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>craDir<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">getLoaders</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">webpackConfig<span class="token punctuation">,</span> matcher</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> matchLoaders <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">,</span> <span class="token string">\'module.rules.0.oneOf\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n      <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'loader\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> matchLoaders<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">getAssetModules</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">webpackConfig<span class="token punctuation">,</span> matcher</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> matchLoaders <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">,</span> <span class="token string">\'module.rules.0.oneOf\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n      <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'type\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> matchLoaders<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">addBeforeLoaders</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">webpackConfig<span class="token punctuation">,</span> matcher<span class="token punctuation">,</span> newLoader <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> matchLoaders <span class="token operator">=</span> <span class="token function">getLoaders</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">,</span> matcher<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>matchLoaders<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   matchLoaders<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'loader\'</span><span class="token punctuation">,</span> <span class="token string">\'options\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      item<span class="token punctuation">.</span>use <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>newLoader<span class="token punctuation">,</span> <span class="token function">pick</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      props<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">delete</span> item<span class="token punctuation">[</span>item2<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">removeAssetDataUrlCondition</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">webpackConfig</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> matchLoaders <span class="token operator">=</span> <span class="token function">getAssetModules</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">,</span> <span class="token string">\'asset\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>matchLoaders<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   matchLoaders<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>item<span class="token punctuation">.</span>parser<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">delete</span> item<span class="token punctuation">.</span>parser<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">formatConfig</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>\n      config<span class="token punctuation">,</span>\n      <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">\'function\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         <span class="token keyword">return</span> value<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token number">2</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   <span class="token function-variable function">webpack</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">config<span class="token punctuation">,</span> env</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> isProd <span class="token operator">=</span> env <span class="token operator">===</span> <span class="token string">\'production\'</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> localConfig <span class="token operator">=</span> <span class="token function">override</span><span class="token punctuation">(</span>\n         <span class="token function">addBabelPlugins</span><span class="token punctuation">(</span>\n            <span class="token punctuation">[</span><span class="token string">\'@babel/plugin-proposal-nullish-coalescing-operator\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            <span class="token punctuation">[</span><span class="token string">\'@babel/plugin-syntax-optional-chaining\'</span><span class="token punctuation">]</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">fixBabelImports</span><span class="token punctuation">(</span><span class="token string">\'import\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n            libraryName<span class="token punctuation">:</span> <span class="token string">\'antd\'</span><span class="token punctuation">,</span>\n            libraryDirectory<span class="token punctuation">:</span> <span class="token string">\'es\'</span><span class="token punctuation">,</span>\n            style<span class="token punctuation">:</span> <span class="token boolean">true</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addLessLoader</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            lessOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span> javascriptEnabled<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">adjustStyleLoaders</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token punctuation">,</span> postcss<span class="token punctuation">]</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">const</span> postcssOptions <span class="token operator">=</span> postcss<span class="token punctuation">.</span>options<span class="token punctuation">;</span>\n            postcss<span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token punctuation">{</span> postcssOptions <span class="token punctuation">}</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackAlias</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token string">\'@\'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'src\'</span><span class="token punctuation">)</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">removeModuleScopePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">         isProd <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">            <span class="token comment">// 分包原则：首先提取 node_modules 下的所有三方库，然后提取出 src 目录下引用超过 2 次的 chunk，对所有同步、异步包都生效</span></span><span class="gatsby-highlight-code-line">            <span class="token function">setWebpackOptimizationSplitChunks</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">               chunks<span class="token punctuation">:</span> <span class="token string">\'all\'</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">               maxInitialRequests<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">               minSize<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">               cacheGroups<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                  defaultVendors<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                     <span class="token comment">// 抽取三方库</span></span><span class="gatsby-highlight-code-line">                     <span class="token function-variable function">test</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                        <span class="token keyword">return</span> <span class="token operator">/</span><span class="token punctuation">[</span>\\\\<span class="token regex">/]node_modules[\\\\/]/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                     <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                     <span class="token function-variable function">name</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// 从后往前匹配 node_modules 后的包名</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">//</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// /frontend/node_modules/.pnpm/@antv+g2plot@2.4.20/node_modules/@antv/g2plot/esm/plots/tiny-column/</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// 结果为 @antv</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">//</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// /frontend/node_modules/@antv+g2plot@2.4.20/323</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// 结果为 @antv+g2plot@2.4.20</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">//</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// /frontend/node_modules/@antv+g2plot@2.4.20</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// 结果为 @antv+g2plot@2.4.20</span></span><span class="gatsby-highlight-code-line">                        <span class="token keyword">const</span> matchResult <span class="token operator">=</span> module<span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;=[\\\\/]node_modules[\\\\/])(.*?)(?=([\\\\/]|$))/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                        <span class="token keyword">const</span> packageName <span class="token operator">=</span> matchResult<span class="token punctuation">[</span>matchResult<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// console.log(`packageName: ${packageName}`, module.context)</span></span><span class="gatsby-highlight-code-line">                        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">pnpm.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/@|\\./g</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                     <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                     priority<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                     reuseExistingChunk<span class="token punctuation">:</span> <span class="token boolean">true</span></span><span class="gatsby-highlight-code-line">                  <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                  <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                     <span class="token comment">// 抽取页面的公共部分</span></span><span class="gatsby-highlight-code-line">                     <span class="token function-variable function">test</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// console.log(\'test module.context---------- \', module.context)</span></span><span class="gatsby-highlight-code-line">                        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">[\\\\/](src|public)[\\\\/]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                     <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                     <span class="token function-variable function">name</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                        <span class="token comment">// console.log(\'name module.context---------- \', module.resourceResolveData.relativePath)</span></span><span class="gatsby-highlight-code-line">                        <span class="token keyword">const</span> relativePath <span class="token operator">=</span> module<span class="token punctuation">.</span>resourceResolveData<span class="token punctuation">.</span>relativePath</span><span class="gatsby-highlight-code-line">                           <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">                           <span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">                           <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'~\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                        <span class="token keyword">return</span> relativePath<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                     <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                     minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                     priority<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                     reuseExistingChunk<span class="token punctuation">:</span> <span class="token boolean">true</span></span><span class="gatsby-highlight-code-line">                  <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">               <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n            <span class="token keyword">new</span> <span class="token class-name">MonacoWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               languages<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'json\'</span><span class="token punctuation">]</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n            <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               <span class="token string">\'process.env.BUILD_TOOL\'</span><span class="token punctuation">:</span> <span class="token string">"\'webpack\'"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n            <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>ProvidePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               Buffer<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'buffer\'</span><span class="token punctuation">,</span> <span class="token string">\'Buffer\'</span><span class="token punctuation">]</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span>\n         <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token constant">BUNDLE_ANALYZER</span> <span class="token operator">&amp;&amp;</span>\n            <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span>\n               <span class="token keyword">new</span> <span class="token class-name">BundleAnalyzerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                  analyzerPort<span class="token punctuation">:</span> <span class="token number">8080</span><span class="token punctuation">,</span>\n                  generateStatsFile<span class="token punctuation">:</span> <span class="token boolean">true</span>\n               <span class="token punctuation">}</span><span class="token punctuation">)</span>\n            <span class="token punctuation">)</span><span class="token punctuation">,</span>\n         <span class="token function">addWebpackPlugin</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebpackBarPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token function">addBeforeLoaders</span><span class="token punctuation">(</span>localConfig<span class="token punctuation">,</span> <span class="token string">\'babel-loader\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'thread-loader\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">removeAssetDataUrlCondition</span><span class="token punctuation">(</span>localConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>extensions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'.js\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'node_modules\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      localConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>fallback <span class="token operator">=</span> <span class="token punctuation">{</span>\n         buffer<span class="token punctuation">:</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">\'buffer\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">LAZY_BUILD</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>experiments <span class="token operator">=</span> <span class="token punctuation">{</span>\n            lazyCompilation<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n               <span class="token comment">// disable lazy compilation for dynamic imports</span>\n               imports<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n\n               <span class="token comment">// disable lazy compilation for entries</span>\n               entries<span class="token punctuation">:</span> <span class="token boolean">false</span>\n\n               <span class="token comment">// do not lazily compile moduleB</span>\n               <span class="token comment">// test: module => !/moduleB/.test(module.nameForCondition())</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_CACHE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>infrastructureLogging <span class="token operator">=</span> <span class="token punctuation">{</span>\n            debug<span class="token punctuation">:</span> <span class="token regex">/webpack\\.cache/</span>\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DISABLE_CACHE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         localConfig<span class="token punctuation">.</span>stats <span class="token operator">=</span> <span class="token punctuation">{</span>\n            errors<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            children<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            warnings<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            colors<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            assets<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            modules<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            entrypoints<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n            timings<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            builtAt<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            hash<span class="token punctuation">:</span> <span class="token boolean">true</span>\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> instanceOfMiniCssExtractPlugin <span class="token operator">=</span> localConfig<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>\n            <span class="token punctuation">(</span><span class="token parameter">plugin</span><span class="token punctuation">)</span> <span class="token operator">=></span> plugin<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">\'MiniCssExtractPlugin\'</span>\n         <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n         <span class="token comment">// 忽略样式导入顺序报错</span>\n         <span class="token comment">// https://github.com/facebook/create-react-app/issues/5372</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>instanceOfMiniCssExtractPlugin<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            instanceOfMiniCssExtractPlugin<span class="token punctuation">.</span>options<span class="token punctuation">.</span>ignoreOrder <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n\n<span class="gatsby-highlight-code-line">         localConfig<span class="token punctuation">.</span>optimization <span class="token operator">=</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">            <span class="token operator">...</span>localConfig<span class="token punctuation">.</span>optimization<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">            nodeEnv<span class="token punctuation">:</span> <span class="token string">\'production\'</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">            sideEffects<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">            concatenateModules<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">            runtimeChunk<span class="token punctuation">:</span> <span class="token string">\'single\'</span></span><span class="gatsby-highlight-code-line">         <span class="token punctuation">}</span><span class="token punctuation">;</span></span>      <span class="token punctuation">}</span>\n\n      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>craDir<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">webpack.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>env<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.json</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">formatConfig</span><span class="token punctuation">(</span>localConfig<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> localConfig<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token function-variable function">devServer</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">configFunction</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">proxy<span class="token punctuation">,</span> allowedHost</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">configFunction</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> allowedHost<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      config<span class="token punctuation">.</span>allowedHosts <span class="token operator">=</span> <span class="token string">\'all\'</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DISABLE_OVERLAY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         config<span class="token punctuation">.</span>client<span class="token punctuation">.</span>overlay <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>craDir<span class="token punctuation">,</span> <span class="token string">\'webpack-dev-server.json\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">formatConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> config<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="快速脚本启动"><a href="#%E5%BF%AB%E9%80%9F%E8%84%9A%E6%9C%AC%E5%90%AF%E5%8A%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>快速脚本启动</h3>\n<p>由于前端项目在子目录下面，所以需要在根目录执行命令，方便快速启动本地开发，使用举例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28402980924878963000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pnpm r # 等价于 pnpm r start:rspack 或 cd 前端项目文件夹 && pnpm start:rspack，这里默认使用 rspack，推荐使用，相比 webpack 它的热更新速度很快\npnpm r start # 等价于 cd 前端项目文件夹 && pnpm start\npnpm r i # 等价于 cd 前端项目文件夹 && pnpm i`, `28402980924878963000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token function">pnpm</span> r <span class="token comment"># 等价于 pnpm r start:rspack 或 cd 前端项目文件夹 &amp;&amp; pnpm start:rspack，这里默认使用 rspack，推荐使用，相比 webpack 它的热更新速度很快</span>\n<span class="token function">pnpm</span> r start <span class="token comment"># 等价于 cd 前端项目文件夹 &amp;&amp; pnpm start</span>\n<span class="token function">pnpm</span> r i <span class="token comment"># 等价于 cd 前端项目文件夹 &amp;&amp; pnpm i</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>相关改动如下：</p>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1465752182330804000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n   &quot;scripts&quot;: {\n      &quot;r&quot;: &quot;node sim_ui/scripts/run.js&quot;\n   }\n}`, `1465752182330804000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="json"\n              >\n                <span class="gatsby-code-button-language">json</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n   <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token property">"r"</span><span class="token operator">:</span> <span class="token string">"node sim_ui/scripts/run.js"</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>sim_ui/scripts/run.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42604557257215080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const shelljs = require(\'shelljs\');\nconst child_process = require(\'child_process\');\nconst argv = require(\'yargs\').argv;\nconst SCRIPT = argv[\'_\'].length > 0 ? argv[\'_\'] : [\'start:rspack\'];\n\nshelljs.cd(\'sim_ui\');\n\nconst worker = child_process.spawn(\'pnpm\', SCRIPT, {\n   stdio: \'inherit\'\n});\n\n// 当接收到终止信号时，终止子进程\nprocess.on(\'SIGINT\', () => {\n   worker.kill(\'SIGINT\');\n});`, `42604557257215080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> shelljs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'shelljs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> child_process <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'child_process\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> argv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'yargs\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>argv<span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token constant">SCRIPT</span> <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token string">\'_\'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> argv<span class="token punctuation">[</span><span class="token string">\'_\'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'start:rspack\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\nshelljs<span class="token punctuation">.</span><span class="token function">cd</span><span class="token punctuation">(</span><span class="token string">\'sim_ui\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> worker <span class="token operator">=</span> child_process<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">\'pnpm\'</span><span class="token punctuation">,</span> <span class="token constant">SCRIPT</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n   stdio<span class="token punctuation">:</span> <span class="token string">\'inherit\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 当接收到终止信号时，终止子进程</span>\nprocess<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'SIGINT\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   worker<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token string">\'SIGINT\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="效果展示-2"><a href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果展示</h2>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-07-04-15-05-15-1aae8175e7c6797e5518e6b224256e89-0424d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 42.67657992565056%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABIElEQVQoz42RW3OCMBCFea2XqiCItTqd1orKPZEQEGzr//9Pp9nVcXyp5eHMEib5ds9Z6/yuoacRKi/GcZ6hmiWo/RRHP+NaeQny/ifSpw9kvfWt/iWrWQgDjFFMdijdCGoasrQb85kkn4N/QTfgaXlA7SYM/VoVOL1K8D8zHYEJSM06A1sCGBGU7JFtmq72UhxGW8hRADHcMLCLbas0+R1nGRo/NxADNTACErx0IpayQ+SDTbcMz28aPyvFUFK7kLwQaqSvIqgYBt2A7YvA97JgiHJCnkYaq2nPPOyvWfd2H4nuWIW957zIrjLflJcwW6XNyvGW4fd2H4knVJO9yS1BM8+5kqgBbV07EdfSvtTqKnpTjHccRe2mfE8MLov7BTNQ/81VMpNzAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 07 04 15 05 15" title="" data-src="/static/2023-07-04-15-05-15-1aae8175e7c6797e5518e6b224256e89-fee1c.png" data-srcset="/static/2023-07-04-15-05-15-1aae8175e7c6797e5518e6b224256e89-a67b7.png 200w,\n/static/2023-07-04-15-05-15-1aae8175e7c6797e5518e6b224256e89-0b187.png 400w,\n/static/2023-07-04-15-05-15-1aae8175e7c6797e5518e6b224256e89-fee1c.png 800w,\n/static/2023-07-04-15-05-15-1aae8175e7c6797e5518e6b224256e89-b1a91.png 1200w,\n/static/2023-07-04-15-05-15-1aae8175e7c6797e5518e6b224256e89-0424d.png 1345w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-07-04-15-08-47-cc14aa594a380d489615e7dd7ec656b9-1f825.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 552px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 35.869565217391305%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABk0lEQVQoz1WP227aUBBFeWlL2qQEmhBR7ldxMcY2xgZjJwYMpIBNmgDq7an//w+rU6dC6sPWnjlztGZ2wiwbjCstRtkmS3H3rs0orWKmOqIuVlqJayvdw8ooGFdt1GRd1DhrcNFAe1+PPeG3Hoh6Jn6hx2NzyKpu8KQ6BFWdtfS7js2saMi7xaZtE1T6mB+rjFK1WONMDfOqfoYmFNk4TuWZfCphXxexUkXG6bx8LkpfiKVdlDEuSwIq4dyUsdN/QdVYbvYVfgZqWU02z1i3fLnCwy+NmVecWKGyJKi5jK67cVT9Q4vem9p/cdVk8x/sVQk9N+BgfCFSFhLZ46u2FndZ16cS2eVFZquaE8+2HZ/7zwZaUqDv5KrYq3Hdf1uhL3XCbrn8Dn9w8vf8XB44zfZ8Xzxzuo/4Nn/i+BCyGwYcvS3P7oZfqwPb4YxpYcAo02Wa07BvFLy8iXPbF2DZJdTmbPozQn3JcRqyN1fMGxMiPWCnLYiGSyIjYNWe4haHeGWTSU7FEpCbN3DuVCa3KrYs+AMFgtdNtYO+3wAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 07 04 15 08 47" title="" data-src="/static/2023-07-04-15-08-47-cc14aa594a380d489615e7dd7ec656b9-1f825.png" data-srcset="/static/2023-07-04-15-08-47-cc14aa594a380d489615e7dd7ec656b9-632a9.png 200w,\n/static/2023-07-04-15-08-47-cc14aa594a380d489615e7dd7ec656b9-cac39.png 400w,\n/static/2023-07-04-15-08-47-cc14aa594a380d489615e7dd7ec656b9-1f825.png 552w" data-sizes="(max-width: 552px) 100vw, 552px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-07-04-15-09-21-bad87ebfe810ab507ef7d63a77d61f3e-eb534.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 113.67061356297093%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAAAsSAAALEgHS3X78AAADsUlEQVQ4y11Va3PbNhDkv27s2I3k/MB+60zbWJYovknw/Ral7S4gOZlo5uYo3OGwt3sgvf3bDrvdN7y+vmC/3+H79zfs6L++vOCPpye8/vlqY8/PT85/fcYL/SN//7bHN8W+fLExr0lSDP2AcZzQ0OdlhbPpEaQG57xGnBsUVW3Xy6ZD3fVoh5G5IzruscZ90zQjbyd4Bz/EOYwQxgkiFv/nxwGHU4B/3w/47/CB9+MJfhjjGKU4BcyNEsRZjpC5AffIksLwsBZF3cD766PA6XS0mwyRVAzI6razvunouxF/B0TOgipQMdb0PWPO6s7lVm0LLylKJLnMIExzRLQgyYjgYfnns43FKc60KM1c3m/5XmwaBFmJuKhQtMPdxru5Z0OfNwO9WzP3NT2X3c81ea8U4VmGjrB7tjGOI+Zpsv8v64qavFwuFzRNg2VZ7PpAUZT3WKuqCuu6MLeGV1QtttsVNwDX6w2XbcO2Xa3/1a63G/qBSCUAQVwuG37/3ZjjReEZMfmQckleoL6LIuUlkmLyUruRSCS+pSibPXiz6K/Xq0XcsUNvqEL4vg9Tlpjn2bbp2qix0tdsayIFURSz1QEZD9bMCs1yzxVatZ1wlLy+ijgOAQpTWk60WUk6QF6IdHp4L6iDtP7rb2VhcZtRC68vA/jnABnbzfLcFlCCCorolom6BcppGVPhiuQ/OJPxyR5SFAW8zgT4OB4RE64hSqEQSpEvCoRaqp5IS88rpuFWTPw9ipbLZvclSQJvrOPPlmWGd1aFNC62FRKt/1EUoZtWFJMm4fqJ7kZBNpoKFsY4hP75bFvOCbng6RoPoRVSka1ktayXQEOFR65L3XmhKBe2u90wrxtK0mQRRrHjRbwNFEDtPAZaIzKTn4h3WPyGHKeAaEMZr+B7WOAj4Tugm1DzcIvQtWwsOhVUi0KoG6ODhFCFpLZQT9NoQUgkcV+wu2WebNzNIdtRuyVPeMxWSS7lncoTAhbUf/Eq00SoQEYQVVljEwUEYsfmePKRcmCFcr0XFEJb8M6ZDtWGRzxJU4s85tvGmIr0rK5gV4YciTNywlZRoRQiFXdj01oaVPAx9PIxOXUFM1LlZlbr3kBRRLDlUMreUYg7edsy1zTQ7pq51lLeCvvaZ7GqaqyQituWJYoS7P1dHXR79TSPGmwiDDjQQiAk8zwiVctct98c2rLMTpQs5feCLZ/Ykk/idQsKCqLvi55Fuobd1w0xNd/Usgo/TglMxjj3lRSl14eLn4P/ATquv1jYwePvAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 07 04 15 09 21" title="" data-src="/static/2023-07-04-15-09-21-bad87ebfe810ab507ef7d63a77d61f3e-fee1c.png" data-srcset="/static/2023-07-04-15-09-21-bad87ebfe810ab507ef7d63a77d61f3e-a67b7.png 200w,\n/static/2023-07-04-15-09-21-bad87ebfe810ab507ef7d63a77d61f3e-0b187.png 400w,\n/static/2023-07-04-15-09-21-bad87ebfe810ab507ef7d63a77d61f3e-fee1c.png 800w,\n/static/2023-07-04-15-09-21-bad87ebfe810ab507ef7d63a77d61f3e-eb534.png 929w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="四期优化"><a href="#%E5%9B%9B%E6%9C%9F%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>四期优化</h1>\n<h2 id="解决镜像源不能访问"><a href="#%E8%A7%A3%E5%86%B3%E9%95%9C%E5%83%8F%E6%BA%90%E4%B8%8D%E8%83%BD%E8%AE%BF%E9%97%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决镜像源不能访问</h2>\n<p>由于国外 docker 源被屏蔽，上面的 dockerfile 在构建镜像过程中会 404，需要修改为国内镜像源，修改如下</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53688107477552260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# syntax = docker/dockerfile:experimental\n\n# 必须都指定\nARG docker_registry=m.daocloud.io/docker.io\n\nFROM \\${docker_registry}/node:14-alpine as builder\n\nARG npm_registry=https://registry.npmmirror.com\n\n# 全局安装依赖，尽量写在一行防止加了新库之后还是使用原来的镜像\nRUN npm config set registry \\${npm_registry} -g && npm i -g pnpm@7.32.1\n\nWORKDIR /home/\n\n# 缓存 pnpm-lock.yaml\nCOPY pnpm-lock.yaml ./\n\n# 下载依赖到全局位置\nRUN --mount=type=cache,target=/root/.local/share/pnpm/store/v3,id=pnpm_cache \\\n    pnpm fetch --prod\n\n# 缓存依赖\nCOPY package.json ./\n\n# 安装依赖\nRUN --mount=type=cache,target=node_modules,id=frontend_node_modules,sharing=locked \\\n    --mount=type=cache,target=/root/.local/share/pnpm/store/v3,id=pnpm_cache \\\n    pnpm i --ignore-scripts=true --prod --offline --registry=\\$npm_registry\n\n# 复制剩余文件\nCOPY . .\n\nRUN --mount=type=cache,target=node_modules,id=frontend_node_modules,sharing=locked \\\n    pnpm lint && pnpm build\n\n# 必须都指定\nARG docker_registry=https://docker.m.daocloud.io\n\nFROM \\${docker_registry}/nginx:alpine\n\nRUN --mount=type=bind,target=/tmp/build,from=builder,source=/home/build \\\n    cp -r /tmp/build/* /usr/share/nginx/html/\n\nCOPY nginx.conf /etc/nginx/conf.d/default.conf\n\nEXPOSE 3000`, `53688107477552260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="dockerfile{4-6,37-39}"\n              >\n                <span class="gatsby-code-button-language">dockerfile{4-6,37-39}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># syntax = docker/dockerfile:experimental</span>\n\n<span class="token comment"># 必须都指定</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">ARG</span> docker_registry=m.daocloud.io/docker.io</span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line"><span class="token keyword">FROM</span> $<span class="token punctuation">{</span>docker_registry<span class="token punctuation">}</span>/node<span class="token punctuation">:</span>14<span class="token punctuation">-</span>alpine as builder</span>\n<span class="token keyword">ARG</span> npm_registry=https<span class="token punctuation">:</span>//registry.npmmirror.com\n\n<span class="token comment"># 全局安装依赖，尽量写在一行防止加了新库之后还是使用原来的镜像</span>\n<span class="token keyword">RUN</span> npm config set registry $<span class="token punctuation">{</span>npm_registry<span class="token punctuation">}</span> <span class="token punctuation">-</span>g &amp;&amp; npm i <span class="token punctuation">-</span>g pnpm@7.32.1\n\n<span class="token keyword">WORKDIR</span> /home/\n\n<span class="token comment"># 缓存 pnpm-lock.yaml</span>\n<span class="token keyword">COPY</span> pnpm<span class="token punctuation">-</span>lock.yaml ./\n\n<span class="token comment"># 下载依赖到全局位置</span>\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=/root/.local/share/pnpm/store/v3<span class="token punctuation">,</span>id=pnpm_cache \\\n    pnpm fetch <span class="token punctuation">-</span><span class="token punctuation">-</span>prod\n\n<span class="token comment"># 缓存依赖</span>\n<span class="token keyword">COPY</span> package.json ./\n\n<span class="token comment"># 安装依赖</span>\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=node_modules<span class="token punctuation">,</span>id=frontend_node_modules<span class="token punctuation">,</span>sharing=locked \\\n    <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=/root/.local/share/pnpm/store/v3<span class="token punctuation">,</span>id=pnpm_cache \\\n    pnpm i <span class="token punctuation">-</span><span class="token punctuation">-</span>ignore<span class="token punctuation">-</span>scripts=true <span class="token punctuation">-</span><span class="token punctuation">-</span>prod <span class="token punctuation">-</span><span class="token punctuation">-</span>offline <span class="token punctuation">-</span><span class="token punctuation">-</span>registry=$npm_registry\n\n<span class="token comment"># 复制剩余文件</span>\n<span class="token keyword">COPY</span> . .\n\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=cache<span class="token punctuation">,</span>target=node_modules<span class="token punctuation">,</span>id=frontend_node_modules<span class="token punctuation">,</span>sharing=locked \\\n    pnpm lint &amp;&amp; pnpm build\n\n<span class="token comment"># 必须都指定</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">ARG</span> docker_registry=https<span class="token punctuation">:</span>//docker.m.daocloud.io</span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line"><span class="token keyword">FROM</span> $<span class="token punctuation">{</span>docker_registry<span class="token punctuation">}</span>/nginx<span class="token punctuation">:</span>alpine</span>\n<span class="token keyword">RUN</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>mount=type=bind<span class="token punctuation">,</span>target=/tmp/build<span class="token punctuation">,</span>from=builder<span class="token punctuation">,</span>source=/home/build \\\n    cp <span class="token punctuation">-</span>r /tmp/build/* /usr/share/nginx/html/\n\n<span class="token keyword">COPY</span> nginx.conf /etc/nginx/conf.d/default.conf\n\n<span class="token keyword">EXPOSE</span> 3000</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>',
excerpt:"需求背景 由于公司老项目采用 cra 来构建前端项目，在 jenkins 上的平均打包时长在 10 分钟以上，需要优化线上的打包时间，同时优化本地的开发体验 一期优化 主要针对 cra + webpack3/4 进行的优化 具体功能 cra 配置优化 核心：thread…",timeToRead:34,tableOfContents:'<ul>\n<li><a href="/cra-project-build-speed-optimize/#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF">需求背景</a></li>\n<li>\n<p><a href="/cra-project-build-speed-optimize/#%E4%B8%80%E6%9C%9F%E4%BC%98%E5%8C%96">一期优化</a></p>\n<ul>\n<li>\n<p><a href="/cra-project-build-speed-optimize/#%E5%85%B7%E4%BD%93%E5%8A%9F%E8%83%BD">具体功能</a></p>\n<ul>\n<li><a href="/cra-project-build-speed-optimize/#cra-%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96">cra 配置优化</a></li>\n<li>\n<p><a href="/cra-project-build-speed-optimize/#dockerfile-%E9%85%8D%E7%BD%AE%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96">Dockerfile 配置缓存优化</a></p>\n<ul>\n<li><a href="/cra-project-build-speed-optimize/#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-1">需求背景</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86">背景知识</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E7%AC%AC%E4%B8%80%E7%89%88">第一版</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E7%AC%AC%E4%BA%8C%E7%89%88">第二版</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E8%B0%83%E7%94%A8">调用</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/cra-project-build-speed-optimize/#npm-%E5%88%87%E6%8D%A2%E5%88%B0-pnpm">npm 切换到 pnpm</a></p>\n<ul>\n<li><a href="/cra-project-build-speed-optimize/#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-2">需求背景</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F">实现方式</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/cra-project-build-speed-optimize/#npm-install-%E6%A0%A1%E9%AA%8C%E5%91%BD%E4%BB%A4">npm install 校验命令</a></p>\n<ul>\n<li><a href="/cra-project-build-speed-optimize/#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-3">需求背景</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-1">实现方式</a></li>\n<li><a href="/cra-project-build-speed-optimize/#volta">volta</a></li>\n<li><a href="/cra-project-build-speed-optimize/#hook-%E8%84%9A%E6%9C%AC">hook 脚本</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/cra-project-build-speed-optimize/#hard-source-webpack-plugin-%E7%9A%84%E7%BA%BF%E4%B8%8A%E4%BF%AE%E5%A4%8D">hard-source-webpack-plugin 的线上修复</a></p>\n<ul>\n<li><a href="/cra-project-build-speed-optimize/#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-4">需求背景</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-2">实现方式</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E5%90%8E%E7%BB%AD%E9%97%AE%E9%A2%98">后续问题</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/cra-project-build-speed-optimize/#preload-webpack-plugin-%E5%A4%B1%E6%95%88%E5%A4%84%E7%90%86">preload-webpack-plugin 失效处理</a></p>\n<ul>\n<li><a href="/cra-project-build-speed-optimize/#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-5">需求背景</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E5%8E%9F%E5%9B%A0">原因</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">解决方案</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/cra-project-build-speed-optimize/#%E5%88%86%E5%8C%85%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98">分包失效问题</a></p>\n<ul>\n<li><a href="/cra-project-build-speed-optimize/#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-6">需求背景</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E5%8E%9F%E5%9B%A0-1">原因</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1">解决方案</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/cra-project-build-speed-optimize/#%E4%BF%AE%E5%A4%8D-fastrefresh-%E5%9C%A8-worker-%E6%8A%A5%E9%94%99">修复 fastRefresh 在 worker 报错</a></p>\n<ul>\n<li><a href="/cra-project-build-speed-optimize/#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-7">需求背景</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E5%8E%9F%E5%9B%A0-2">原因</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E6%96%B9%E6%A1%88">方案</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/cra-project-build-speed-optimize/#%E6%87%92%E7%BC%96%E8%AF%91">懒编译</a></p>\n<ul>\n<li><a href="/cra-project-build-speed-optimize/#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-8">需求背景</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B">选型过程</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0">具体实现</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E7%BC%96%E8%AF%91%E6%95%88%E6%9E%9C">编译效果</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90">源码解析</a></li>\n</ul>\n</li>\n<li><a href="/cra-project-build-speed-optimize/#jenkins-%E7%BC%96%E8%AF%91%E9%80%9F%E5%BA%A6%E4%BC%98%E5%8C%96">jenkins 编译速度优化</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/cra-project-build-speed-optimize/#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA">效果展示</a></p>\n<ul>\n<li><a href="/cra-project-build-speed-optimize/#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83">生产环境</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83">开发环境</a></li>\n</ul>\n</li>\n<li><a href="/cra-project-build-speed-optimize/#%E5%90%8E%E6%9C%9F%E4%BC%98%E5%8C%96">后期优化</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/cra-project-build-speed-optimize/#%E4%BA%8C%E6%9C%9F%E4%BC%98%E5%8C%96">二期优化</a></p>\n<ul>\n<li>\n<p><a href="/cra-project-build-speed-optimize/#%E5%85%B7%E4%BD%93%E5%8A%9F%E8%83%BD-1">具体功能</a></p>\n<ul>\n<li>\n<p><a href="/cra-project-build-speed-optimize/#cra--webpack5">cra + webpack5</a></p>\n<ul>\n<li><a href="/cra-project-build-speed-optimize/#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F">环境变量</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE">核心配置</a></li>\n<li><a href="/cra-project-build-speed-optimize/#worker-loader-%E7%9A%84%E5%85%BC%E5%AE%B9%E5%A4%84%E7%90%86">worker-loader 的兼容处理</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E4%BF%AE%E5%A4%8D-react-scripts-%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E7%BC%93%E5%AD%98">修复 react-scripts 生产环境缓存</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E8%BF%90%E8%A1%8C%E6%A8%A1%E6%9D%BF">运行模板</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E4%BC%98%E7%BC%BA%E7%82%B9">优缺点</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/cra-project-build-speed-optimize/#rspack">rspack</a></p>\n<ul>\n<li><a href="/cra-project-build-speed-optimize/#%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE-1">核心配置</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E8%BF%90%E8%A1%8C%E6%A8%A1%E6%9D%BF-1">运行模板</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E4%BC%98%E7%BC%BA%E7%82%B9-1">优缺点</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/cra-project-build-speed-optimize/#vite">vite</a></p>\n<ul>\n<li><a href="/cra-project-build-speed-optimize/#%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE-2">核心配置</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E4%BC%98%E7%BC%BA%E7%82%B9-2">优缺点</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/cra-project-build-speed-optimize/#dockerfile-pnpm-%E7%BC%93%E5%AD%98%E4%B8%8D%E7%94%9F%E6%95%88">dockerfile pnpm 缓存不生效</a></p>\n<ul>\n<li><a href="/cra-project-build-speed-optimize/#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-9">需求背景</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-2">解决方案</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/cra-project-build-speed-optimize/#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA-1">效果展示</a></p>\n<ul>\n<li><a href="/cra-project-build-speed-optimize/#%E6%9C%AC%E5%9C%B0%E7%8E%AF%E5%A2%83">本地环境</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83-1">生产环境</a></li>\n</ul>\n</li>\n<li><a href="/cra-project-build-speed-optimize/#%E5%90%8E%E6%9C%9F%E4%BC%98%E5%8C%96-1">后期优化</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/cra-project-build-speed-optimize/#%E4%B8%89%E6%9C%9F%E4%BC%98%E5%8C%96">三期优化</a></p>\n<ul>\n<li>\n<p><a href="/cra-project-build-speed-optimize/#%E5%85%B7%E4%BD%93%E5%8A%9F%E8%83%BD-2">具体功能</a></p>\n<ul>\n<li><a href="/cra-project-build-speed-optimize/#%E6%A0%BC%E5%BC%8F%E5%8C%96">格式化</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E5%88%86%E5%8C%85%E7%AD%96%E7%95%A5">分包策略</a></li>\n<li><a href="/cra-project-build-speed-optimize/#%E5%BF%AB%E9%80%9F%E8%84%9A%E6%9C%AC%E5%90%AF%E5%8A%A8">快速脚本启动</a></li>\n</ul>\n</li>\n<li><a href="/cra-project-build-speed-optimize/#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA-2">效果展示</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/cra-project-build-speed-optimize/#%E5%9B%9B%E6%9C%9F%E4%BC%98%E5%8C%96">四期优化</a></p>\n<ul>\n<li><a href="/cra-project-build-speed-optimize/#%E8%A7%A3%E5%86%B3%E9%95%9C%E5%83%8F%E6%BA%90%E4%B8%8D%E8%83%BD%E8%AE%BF%E9%97%AE">解决镜像源不能访问</a></li>\n</ul>\n</li>\n</ul>',wordCount:{words:601},frontmatter:{date:"2022-12-16 17:34:33",path:"/cra-project-build-speed-optimize/",tags:"前端, webpack, Docker, 预研, rspack, 前端构建工具",title:"CRA 项目构建速度优化",draft:null,catalog_number:null}},nextPost:{html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>完成官网 1.0 的上线，实现动效、国际化、多平台适配等功能</p>\n<h1 id="动效"><a href="#%E5%8A%A8%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>动效</h1>\n<h2 id="逐行显示"><a href="#%E9%80%90%E8%A1%8C%E6%98%BE%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>逐行显示</h2>\n<h3 id="需求背景-1"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>实现功能如下：</p>\n<p>x 旋转 -> 不同文字由下而上透明度从 0 到 1</p>\n<p>实现要点如下：</p>\n<ol>\n<li>进入视口执行一次</li>\n<li>离开视口重置动画</li>\n</ol>\n<p>实现如下所示动效：</p>\n<p><html><head></head><body><video data-src="/examples/international-official-website-technical-difficulties/line-by-line-display.mp4" loop="" muted="" autoplay="" width="100%" class="lazy"></video></body></html></video></p>\n<h3 id="选型过程"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h3>\n<table>\n<thead>\n<tr>\n<th align="left">选型</th>\n<th align="left">优点</th>\n<th align="left">缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left"><a href="https://github.com/pmndrs/react-spring" target="_blank" rel="nofollow noreferrer noopener">react-spring</a></td>\n<td align="left">使用方便，基于弹簧物理的动画库</td>\n<td align="left"><ol>\n<li>\n改变 state 会导致多次执行\n</li>\n<li>\n不能自由控制播放进度\n</li>\n</ol></td>\n</tr>\n<tr>\n<td align="left"><a href="https://animate.style/" target="_blank" rel="nofollow noreferrer noopener">animate.css</a></td>\n<td align="left">原生方法体积小，提供回退兼容性好</td>\n<td align="left">使用较为繁琐，需要同时写 css、js</td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/greensock/GSAP" target="_blank" rel="nofollow noreferrer noopener">gsap</a></td>\n<td align="left"><ol>\n<li>\n可控制播放进度或自动播放，可配合之后提到的 react-scrollmagic 实现动效进度控制\n</li>\n<li>\n示例丰富，可实现很多动效\n</li>\n</ol></td>\n<td align="left">api 过于原始，需要封装</td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/bitworking/react-gsap" target="_blank" rel="nofollow noreferrer noopener">react-gsap</a></td>\n<td align="left">除了以上优点，可直接在 react 中使用</td>\n<td align="left">有些 gsap 动效不能直接在 react-gsap 中使用，比如说和 react-scrollmagic 相同的效果</td>\n</tr>\n</tbody>\n</table>\n<h3 id="核心代码"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<h4 id="react-spring"><a href="#react-spring" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-spring</h4>\n<p>最初采用 react-spring 版本，主要实现了如下功能</p>\n<ol>\n<li>react-spring 时间序列化（react-spring ref delay）</li>\n<li>useContext 全局控制，实现 react-spring 的反向动画</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16907787208010007000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { CSSProperties, ReactNode, Children, useRef, useEffect, useContext } from \'react\';\nimport classnames from \'classnames\';\nimport { a, useTransition, useSpringRef, useSpring } from \'@react-spring/web\';\nimport { useInViewport } from \'ahooks\';\n\nimport XIcon from \'@/components/xIcon\';\nimport ConfigContext from \'@/components/layout/configContext\';\n\nimport { delayFunc } from \'@/utils\';\n\nimport PageStyles from \'./index.module.less\';\n\nexport interface AnimationTitleProps {\n   className?: string;\n   title?: ReactNode;\n   subTitle?: ReactNode;\n   closeIcon?: ReactNode;\n   delay?: number;\n   style?: CSSProperties;\n   animation?: boolean;\n   isOnce?: boolean;\n}\n\ntype TransitionProps = Parameters<typeof useTransition>[1];\n\nconst AnimationTitle = ({\n   className,\n   title,\n   subTitle,\n   closeIcon = <XIcon name=\'title-x\' />,\n   delay = 300,\n   style,\n   animation = true,\n   isOnce = false\n}: AnimationTitleProps) => {\n   const { isRunMultiTime } = useContext(ConfigContext);\n\n   const closeIconRef = useSpringRef();\n   const closeIconStyle = useSpring({\n      ref: closeIconRef,\n      from: {\n         opacity: 0,\n         rotate: -100\n      },\n      to: {\n         rotate: 0,\n         opacity: 1\n      }\n   });\n\n   const titleRef = useSpringRef();\n   const titleStyle = useSpring({\n      ref: titleRef,\n      from: {\n         scale: 0,\n         opacity: 0\n      },\n      to: {\n         scale: 1,\n         opacity: 1\n      },\n      config: {\n         tension: 100,\n         friction: 14\n      }\n   });\n\n   const renderSubTitle: ReactNode[] = Children.map(Children.toArray(subTitle), (child, index) => {\n      if (typeof child === \'string\') {\n         return <div key={index}>{child}</div>;\n      }\n      return child;\n   });\n\n   const subTitleRef = useSpringRef();\n   const transitionProps: TransitionProps = {\n      from: {\n         opacity: 0,\n         y: 50\n      },\n      enter: (msg, i) => ({\n         delay: () => {\n            return i * 400;\n         },\n         to: {\n            opacity: 1,\n            y: 0\n         }\n      }),\n      ref: subTitleRef\n   };\n\n   if (!isRunMultiTime || isOnce) {\n      transitionProps.keys = (item: { key: any }) => item.key;\n   }\n\n   const transitions = useTransition(renderSubTitle, transitionProps);\n\n   const domRef = useRef<HTMLDivElement>(null);\n   const [inViewPort] = useInViewport(domRef);\n   useEffect(() => {\n      const startAnimation = async () => {\n         await delayFunc(delay);\n         if (closeIcon) {\n            closeIconRef.start();\n         }\n         if (title) {\n            await Promise.all(titleRef.start());\n         }\n         if (subTitle) {\n            await Promise.all(subTitleRef.start());\n         }\n      };\n\n      const reverseAnimation = () => {\n         [closeIconRef, titleRef, subTitleRef].forEach((item) => {\n            item.start({\n               reverse: true\n            });\n         });\n      };\n\n      if (inViewPort) {\n         startAnimation();\n      } else if (isRunMultiTime && !isOnce) {\n         reverseAnimation();\n      }\n      // eslint-disable-next-line react-hooks/exhaustive-deps\n   }, [inViewPort, isOnce, title, subTitle]);\n\n   const getStyle = (style: any) => (animation ? style : undefined);\n\n   return (\n      <div ref={domRef} className={classnames(PageStyles.textDisplay, \'text-display\', className)} style={style}>\n         {closeIcon && (\n            <a.div style={getStyle(closeIconStyle)} className={classnames(PageStyles.closeIcon, \'close-icon\')}>\n               {closeIcon}\n            </a.div>\n         )}\n         {title && (\n            <a.div style={getStyle(titleStyle)} className={classnames(PageStyles.title, \'text-display-title\')}>\n               {title}\n            </a.div>\n         )}\n         {subTitle && (\n            <div className={classnames(PageStyles.subTitleContainer, \'text-display-sub-title-container\')}>\n               {transitions((style, item: any) => {\n                  return (\n                     <a.div\n                        style={getStyle(style)}\n                        className={classnames(PageStyles.subTitle, \'text-display-sub-title\')}\n                     >\n                        {item}\n                     </a.div>\n                  );\n               })}\n            </div>\n         )}\n      </div>\n   );\n};\n\nexport default AnimationTitle;`, `16907787208010007000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> CSSProperties<span class="token punctuation">,</span> ReactNode<span class="token punctuation">,</span> Children<span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useEffect<span class="token punctuation">,</span> useContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> classnames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> a<span class="token punctuation">,</span> useTransition<span class="token punctuation">,</span> useSpringRef<span class="token punctuation">,</span> useSpring <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@react-spring/web\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useInViewport <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> XIcon <span class="token keyword">from</span> <span class="token string">\'@/components/xIcon\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> ConfigContext <span class="token keyword">from</span> <span class="token string">\'@/components/layout/configContext\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> delayFunc <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> PageStyles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">AnimationTitleProps</span> <span class="token punctuation">{</span>\n   className<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n   title<span class="token operator">?</span><span class="token punctuation">:</span> ReactNode<span class="token punctuation">;</span>\n   subTitle<span class="token operator">?</span><span class="token punctuation">:</span> ReactNode<span class="token punctuation">;</span>\n   closeIcon<span class="token operator">?</span><span class="token punctuation">:</span> ReactNode<span class="token punctuation">;</span>\n   delay<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n   style<span class="token operator">?</span><span class="token punctuation">:</span> CSSProperties<span class="token punctuation">;</span>\n   animation<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>\n   isOnce<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">type</span> TransitionProps <span class="token operator">=</span> Parameters<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>typeof</span> <span class="token attr-name">useTransition</span><span class="token punctuation">></span></span><span class="token plain-text">[1];\n\nconst AnimationTitle = (</span><span class="token punctuation">{</span>\n   className<span class="token punctuation">,</span>\n   title<span class="token punctuation">,</span>\n   subTitle<span class="token punctuation">,</span>\n   closeIcon <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XIcon</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>title-x<span class="token punctuation">\'</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>\n   delay <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">,</span>\n   style<span class="token punctuation">,</span>\n   animation <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n   isOnce <span class="token operator">=</span> <span class="token boolean">false</span>\n<span class="token punctuation">}</span><span class="token plain-text">: AnimationTitleProps) => </span><span class="token punctuation">{</span>\n   <span class="token keyword">const</span> <span class="token punctuation">{</span> isRunMultiTime <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>ConfigContext<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> closeIconRef <span class="token operator">=</span> <span class="token function">useSpringRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> closeIconStyle <span class="token operator">=</span> <span class="token function">useSpring</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      ref<span class="token punctuation">:</span> closeIconRef<span class="token punctuation">,</span>\n      <span class="token keyword">from</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         opacity<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n         rotate<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">100</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      to<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         rotate<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n         opacity<span class="token punctuation">:</span> <span class="token number">1</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> titleRef <span class="token operator">=</span> <span class="token function">useSpringRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> titleStyle <span class="token operator">=</span> <span class="token function">useSpring</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      ref<span class="token punctuation">:</span> titleRef<span class="token punctuation">,</span>\n      <span class="token keyword">from</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         scale<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n         opacity<span class="token punctuation">:</span> <span class="token number">0</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      to<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         scale<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n         opacity<span class="token punctuation">:</span> <span class="token number">1</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      config<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         tension<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>\n         friction<span class="token punctuation">:</span> <span class="token number">14</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> renderSubTitle<span class="token punctuation">:</span> ReactNode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> Children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Children<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>subTitle<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">child<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> child <span class="token operator">===</span> <span class="token string">\'string\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>child<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span> child<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> subTitleRef <span class="token operator">=</span> <span class="token function">useSpringRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> transitionProps<span class="token punctuation">:</span> TransitionProps <span class="token operator">=</span> <span class="token punctuation">{</span>\n      <span class="token keyword">from</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         opacity<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n         y<span class="token punctuation">:</span> <span class="token number">50</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token function-variable function">enter</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>\n         <span class="token function-variable function">delay</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> i <span class="token operator">*</span> <span class="token number">400</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         to<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            opacity<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n            y<span class="token punctuation">:</span> <span class="token number">0</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      ref<span class="token punctuation">:</span> subTitleRef\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRunMultiTime <span class="token operator">||</span> isOnce<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      transitionProps<span class="token punctuation">.</span><span class="token function-variable function">keys</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">:</span> <span class="token punctuation">{</span> key<span class="token punctuation">:</span> <span class="token builtin">any</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>key<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">const</span> transitions <span class="token operator">=</span> <span class="token function">useTransition</span><span class="token punctuation">(</span>renderSubTitle<span class="token punctuation">,</span> transitionProps<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> domRef <span class="token operator">=</span> useRef<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">HTMLDivElement</span></span><span class="token punctuation">></span></span><span class="token plain-text">(null);\n   const [inViewPort] = useInViewport(domRef);\n   useEffect(() => </span><span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token function-variable function">startAnimation</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">await</span> <span class="token function">delayFunc</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>closeIcon<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            closeIconRef<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>title<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>titleRef<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>subTitle<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>subTitleRef<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> <span class="token function-variable function">reverseAnimation</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token punctuation">[</span>closeIconRef<span class="token punctuation">,</span> titleRef<span class="token punctuation">,</span> subTitleRef<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            item<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n               reverse<span class="token punctuation">:</span> <span class="token boolean">true</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>inViewPort<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token function">startAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isRunMultiTime <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isOnce<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token function">reverseAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n   <span class="token punctuation">}</span><span class="token plain-text">, [inViewPort, isOnce, title, subTitle]);\n\n   const getStyle = (style: any) => (animation ? style : undefined);\n\n   return (\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>domRef<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>PageStyles<span class="token punctuation">.</span>textDisplay<span class="token punctuation">,</span> <span class="token string">\'text-display\'</span><span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n         </span><span class="token punctuation">{</span>closeIcon <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>\n            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a.div</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getStyle</span><span class="token punctuation">(</span>closeIconStyle<span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>PageStyles<span class="token punctuation">.</span>closeIcon<span class="token punctuation">,</span> <span class="token string">\'close-icon\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n               </span><span class="token punctuation">{</span>closeIcon<span class="token punctuation">}</span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a.div</span><span class="token punctuation">></span></span>\n         <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">\n         </span><span class="token punctuation">{</span>title <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>\n            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a.div</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getStyle</span><span class="token punctuation">(</span>titleStyle<span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>PageStyles<span class="token punctuation">.</span>title<span class="token punctuation">,</span> <span class="token string">\'text-display-title\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n               </span><span class="token punctuation">{</span>title<span class="token punctuation">}</span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a.div</span><span class="token punctuation">></span></span>\n         <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">\n         </span><span class="token punctuation">{</span>subTitle <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>\n            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>PageStyles<span class="token punctuation">.</span>subTitleContainer<span class="token punctuation">,</span> <span class="token string">\'text-display-sub-title-container\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n               </span><span class="token punctuation">{</span><span class="token function">transitions</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">style<span class="token punctuation">,</span> item<span class="token punctuation">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n                     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a.div</span>\n                        <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getStyle</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n                        <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>PageStyles<span class="token punctuation">.</span>subTitle<span class="token punctuation">,</span> <span class="token string">\'text-display-sub-title\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n                     <span class="token punctuation">></span></span><span class="token plain-text">\n                        </span><span class="token punctuation">{</span>item<span class="token punctuation">}</span><span class="token plain-text">\n                     </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a.div</span><span class="token punctuation">></span></span>\n                  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n               <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n         <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n   );\n};\n\nexport default AnimationTitle;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="react-gsap"><a href="#react-gsap" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-gsap</h4>\n<p>为了解决渲染多次组件带来的多次执行动效的问题，之后采用 react-gsap 实现</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50704743209658606000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, {\n  CSSProperties,\n  ReactNode,\n  Children,\n  useContext,\n  useRef,\n  useEffect\n} from \'react\'\nimport classnames from \'classnames\'\nimport { Tween, PlayState } from \'react-gsap\'\nimport { useInViewport } from \'ahooks\'\n\nimport XIcon from \'@/components/xIcon\'\nimport ConfigContext from \'@/components/layout/configContext\'\n\nimport useStoreContext, { CLIENT_TYPE } from \'@/hooks/useStoreContext\'\n\nimport { delayFunc } from \'@/utils\'\n\nimport PageStyles from \'./index.module.less\'\n\nexport interface AnimationTitleProps {\n  className?: string\n  title?: ReactNode\n  subTitle?: ReactNode\n  closeIcon?: ReactNode\n  delay?: number\n  style?: CSSProperties\n  animation?: boolean\n  isOnce?: boolean\n  titleStyle?: CSSProperties\n  closeIconStyle?: CSSProperties\n  reverseAnimationRef?: any\n  startAnimationRef?: any\n}\n\nexport const defaultCloseIcon = (<XIcon\n  name=\'title-x\'\n/>)\n\nconst AnimationTitle = (props: AnimationTitleProps) => {\n  const {\n    className,\n    title,\n    subTitle,\n    closeIcon = defaultCloseIcon,\n    delay = 300,\n    style,\n    animation = true,\n    isOnce = false,\n    closeIconStyle,\n    titleStyle,\n    reverseAnimationRef = null,\n    startAnimationRef = null\n  } = props\n\n  const { isRunMultiTime } = useContext(ConfigContext)\n  const closeIconRef = useRef(null)\n  const titleRef = useRef(null)\n  const subTitleRef = useRef(null)\n\n  const domRef = useRef<HTMLDivElement>(null)\n  const [inViewPort] = useInViewport(domRef)\n\n  const { state } = useStoreContext()\n\n  useEffect(() => {\n    if (!animation || state?.clientType === CLIENT_TYPE.H5) {\n      return\n    }\n    const startAnimation = async () => {\n      await delayFunc(delay)\n      if (closeIcon) {\n        closeIconRef.current?.getGSAP().play()\n      }\n      await delayFunc(200)\n      if (title) {\n        titleRef.current?.getGSAP().play()\n      }\n      // 等 title 动画的一半就开始运行\n      await delayFunc(500)\n      if (subTitle) {\n        await subTitleRef.current?.getGSAP().play()\n      }\n    }\n\n    const reverseAnimation = () => {\n      [closeIconRef, titleRef, subTitleRef].forEach((item) => {\n        item.current?.getGSAP().reverse()\n      })\n    }\n\n    if (reverseAnimationRef) {\n      reverseAnimationRef.current = reverseAnimation\n    }\n\n    if (startAnimationRef) {\n      startAnimationRef.current = startAnimation\n    }\n\n    if (inViewPort) {\n      startAnimation()\n    } else if (isRunMultiTime && !isOnce) {\n      reverseAnimation()\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [inViewPort, isOnce])\n\n  let playState = animation ? PlayState.stop : PlayState.stopEnd\n\n  // animation 未定义且是 h5 的情况下，去掉动效\n  if (state?.clientType === CLIENT_TYPE.H5) {\n    playState = PlayState.stopEnd\n  }\n\n  return (\n    <div\n      className={classnames(\n        PageStyles.textDisplay,\n        \'text-display\',\n        className\n      )}\n      style={style}\n      ref={domRef}\n    >\n      {\n        closeIcon && <Tween\n          ref={closeIconRef}\n          from={{\n            opacity: 0,\n            rotate: -100\n          }}\n          to={{\n            opacity: 1,\n            rotate: 0\n          }}\n          playState={playState}\n        >\n          <div\n            className={classnames(PageStyles.closeIcon, \'close-icon\')}\n            style={closeIconStyle}\n          >\n            {closeIcon}\n          </div>\n        </Tween>\n      }\n      {\n        title && <Tween\n          ref={titleRef}\n          from={{\n            scale: 0,\n            opacity: 0\n          }}\n          to={{\n            opacity: 1,\n            scale: 1\n          }}\n          playState={playState}\n        >\n          <div\n            className={classnames(\n              PageStyles.title,\n              \'text-display-title\'\n            )}\n            style={titleStyle}\n          >\n            {title}\n          </div>\n        </Tween>\n      }\n      {\n        subTitle && <div\n          className={classnames(\n            PageStyles.subTitleContainer,\n            \'text-display-sub-title-container\'\n          )}\n        >\n          <Tween\n            ref={subTitleRef}\n            from={{\n              opacity: 0,\n              y: 50\n            }}\n            to={{\n              opacity: 1,\n              y: 0\n            }}\n            stagger={0.6}\n            duration={Children.toArray(subTitle).length * 0.4}\n            playState={playState}\n          >\n            {\n              Children.toArray(subTitle).map((item: any, index: number) => {\n                return (\n                  <div\n                    className={classnames(\n                      PageStyles.subTitle,\n                      \'text-display-sub-title\'\n                    )}\n                    key={index}\n                  >\n                    {item}\n                  </div>\n                )\n              })\n            }\n          </Tween>\n        </div>\n      }\n    </div>\n  )\n}\n\nexport default AnimationTitle`, `50704743209658606000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  CSSProperties<span class="token punctuation">,</span>\n  ReactNode<span class="token punctuation">,</span>\n  Children<span class="token punctuation">,</span>\n  useContext<span class="token punctuation">,</span>\n  useRef<span class="token punctuation">,</span>\n  useEffect\n<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span>\n<span class="token keyword">import</span> classnames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> Tween<span class="token punctuation">,</span> PlayState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-gsap\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useInViewport <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks\'</span>\n\n<span class="token keyword">import</span> XIcon <span class="token keyword">from</span> <span class="token string">\'@/components/xIcon\'</span>\n<span class="token keyword">import</span> ConfigContext <span class="token keyword">from</span> <span class="token string">\'@/components/layout/configContext\'</span>\n\n<span class="token keyword">import</span> useStoreContext<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token constant">CLIENT_TYPE</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/hooks/useStoreContext\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> delayFunc <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span>\n\n<span class="token keyword">import</span> PageStyles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span>\n\n<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">AnimationTitleProps</span> <span class="token punctuation">{</span>\n  className<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span>\n  title<span class="token operator">?</span><span class="token punctuation">:</span> ReactNode\n  subTitle<span class="token operator">?</span><span class="token punctuation">:</span> ReactNode\n  closeIcon<span class="token operator">?</span><span class="token punctuation">:</span> ReactNode\n  delay<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span>\n  style<span class="token operator">?</span><span class="token punctuation">:</span> CSSProperties\n  animation<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span>\n  isOnce<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span>\n  titleStyle<span class="token operator">?</span><span class="token punctuation">:</span> CSSProperties\n  closeIconStyle<span class="token operator">?</span><span class="token punctuation">:</span> CSSProperties\n  reverseAnimationRef<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">any</span>\n  startAnimationRef<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">any</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">const</span> defaultCloseIcon <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XIcon</span></span>\n  <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>title-x<span class="token punctuation">\'</span></span>\n<span class="token punctuation">/></span></span><span class="token punctuation">)</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">AnimationTitle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">:</span> AnimationTitleProps</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span>\n    className<span class="token punctuation">,</span>\n    title<span class="token punctuation">,</span>\n    subTitle<span class="token punctuation">,</span>\n    closeIcon <span class="token operator">=</span> defaultCloseIcon<span class="token punctuation">,</span>\n    delay <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">,</span>\n    style<span class="token punctuation">,</span>\n    animation <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    isOnce <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    closeIconStyle<span class="token punctuation">,</span>\n    titleStyle<span class="token punctuation">,</span>\n    reverseAnimationRef <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n    startAnimationRef <span class="token operator">=</span> <span class="token keyword">null</span>\n  <span class="token punctuation">}</span> <span class="token operator">=</span> props\n\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> isRunMultiTime <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>ConfigContext<span class="token punctuation">)</span>\n  <span class="token keyword">const</span> closeIconRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> titleRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> subTitleRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> domRef <span class="token operator">=</span> useRef<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">HTMLDivElement</span></span><span class="token punctuation">></span></span><span class="token plain-text">(null)\n  const [inViewPort] = useInViewport(domRef)\n\n  const </span><span class="token punctuation">{</span> state <span class="token punctuation">}</span><span class="token plain-text"> = useStoreContext()\n\n  useEffect(() => </span><span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>animation <span class="token operator">||</span> state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">H5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> <span class="token function-variable function">startAnimation</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">await</span> <span class="token function">delayFunc</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>closeIcon<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        closeIconRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getGSAP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">await</span> <span class="token function">delayFunc</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>title<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        titleRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getGSAP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// 等 title 动画的一半就开始运行</span>\n      <span class="token keyword">await</span> <span class="token function">delayFunc</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>subTitle<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">await</span> subTitleRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getGSAP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">const</span> <span class="token function-variable function">reverseAnimation</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token punctuation">[</span>closeIconRef<span class="token punctuation">,</span> titleRef<span class="token punctuation">,</span> subTitleRef<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        item<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getGSAP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>reverseAnimationRef<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      reverseAnimationRef<span class="token punctuation">.</span>current <span class="token operator">=</span> reverseAnimation\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>startAnimationRef<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      startAnimationRef<span class="token punctuation">.</span>current <span class="token operator">=</span> startAnimation\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>inViewPort<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">startAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isRunMultiTime <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isOnce<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">reverseAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n  <span class="token punctuation">}</span><span class="token plain-text">, [inViewPort, isOnce])\n\n  let playState = animation ? PlayState.stop : PlayState.stopEnd\n\n  // animation 未定义且是 h5 的情况下，去掉动效\n  if (state?.clientType === CLIENT_TYPE.H5) </span><span class="token punctuation">{</span>\n    playState <span class="token operator">=</span> PlayState<span class="token punctuation">.</span>stopEnd\n  <span class="token punctuation">}</span><span class="token plain-text">\n\n  return (\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>\n      <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>\n        PageStyles<span class="token punctuation">.</span>textDisplay<span class="token punctuation">,</span>\n        <span class="token string">\'text-display\'</span><span class="token punctuation">,</span>\n        className\n      <span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n      <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span></span>\n      <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>domRef<span class="token punctuation">}</span></span>\n    <span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token punctuation">{</span>\n        closeIcon <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Tween</span></span>\n          <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>closeIconRef<span class="token punctuation">}</span></span>\n          <span class="token attr-name">from</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n            opacity<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n            rotate<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">100</span>\n          <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">to</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n            opacity<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n            rotate<span class="token punctuation">:</span> <span class="token number">0</span>\n          <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">playState</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>playState<span class="token punctuation">}</span></span>\n        <span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>\n            <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>PageStyles<span class="token punctuation">.</span>closeIcon<span class="token punctuation">,</span> <span class="token string">\'close-icon\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n            <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>closeIconStyle<span class="token punctuation">}</span></span>\n          <span class="token punctuation">></span></span><span class="token plain-text">\n            </span><span class="token punctuation">{</span>closeIcon<span class="token punctuation">}</span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Tween</span></span><span class="token punctuation">></span></span>\n      <span class="token punctuation">}</span><span class="token plain-text">\n      </span><span class="token punctuation">{</span>\n        title <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Tween</span></span>\n          <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>titleRef<span class="token punctuation">}</span></span>\n          <span class="token attr-name">from</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n            scale<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n            opacity<span class="token punctuation">:</span> <span class="token number">0</span>\n          <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">to</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n            opacity<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n            scale<span class="token punctuation">:</span> <span class="token number">1</span>\n          <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">playState</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>playState<span class="token punctuation">}</span></span>\n        <span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>\n            <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>\n              PageStyles<span class="token punctuation">.</span>title<span class="token punctuation">,</span>\n              <span class="token string">\'text-display-title\'</span>\n            <span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n            <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>titleStyle<span class="token punctuation">}</span></span>\n          <span class="token punctuation">></span></span><span class="token plain-text">\n            </span><span class="token punctuation">{</span>title<span class="token punctuation">}</span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Tween</span></span><span class="token punctuation">></span></span>\n      <span class="token punctuation">}</span><span class="token plain-text">\n      </span><span class="token punctuation">{</span>\n        subTitle <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>\n          <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>\n            PageStyles<span class="token punctuation">.</span>subTitleContainer<span class="token punctuation">,</span>\n            <span class="token string">\'text-display-sub-title-container\'</span>\n          <span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n        <span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Tween</span></span>\n            <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>subTitleRef<span class="token punctuation">}</span></span>\n            <span class="token attr-name">from</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n              opacity<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n              y<span class="token punctuation">:</span> <span class="token number">50</span>\n            <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n            <span class="token attr-name">to</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n              opacity<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n              y<span class="token punctuation">:</span> <span class="token number">0</span>\n            <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n            <span class="token attr-name">stagger</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">0.6</span><span class="token punctuation">}</span></span>\n            <span class="token attr-name">duration</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>Children<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>subTitle<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">*</span> <span class="token number">0.4</span><span class="token punctuation">}</span></span>\n            <span class="token attr-name">playState</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>playState<span class="token punctuation">}</span></span>\n          <span class="token punctuation">></span></span><span class="token plain-text">\n            </span><span class="token punctuation">{</span>\n              Children<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>subTitle<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> index<span class="token punctuation">:</span> <span class="token builtin">number</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                <span class="token keyword">return</span> <span class="token punctuation">(</span>\n                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>\n                    <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>\n                      PageStyles<span class="token punctuation">.</span>subTitle<span class="token punctuation">,</span>\n                      <span class="token string">\'text-display-sub-title\'</span>\n                    <span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n                    <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span>\n                  <span class="token punctuation">></span></span><span class="token plain-text">\n                    </span><span class="token punctuation">{</span>item<span class="token punctuation">}</span><span class="token plain-text">\n                  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n                <span class="token punctuation">)</span>\n              <span class="token punctuation">}</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Tween</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n      <span class="token punctuation">}</span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n  )\n}\n\nexport default AnimationTitle</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行效果"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<h4 id="react-spring-1"><a href="#react-spring-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-spring</h4>\n<!-- <iframe data-src="https://codesandbox.io/embed/b03lty?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/49vcpg?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h4 id="react-gsap-1"><a href="#react-gsap-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-gsap</h4>\n<!-- <iframe data-src="https://codesandbox.io/embed/yibidu?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/69fcy2?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="数字滚动展示"><a href="#%E6%95%B0%E5%AD%97%E6%BB%9A%E5%8A%A8%E5%B1%95%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数字滚动展示</h2>\n<h3 id="需求背景-2"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>实现功能如下：</p>\n<ol>\n<li>数字有滚动效果</li>\n<li>整体有位移、透明度变化效果</li>\n</ol>\n<p>实现要点如下：</p>\n<ol>\n<li>进入视口执行一次</li>\n<li>离开视口重置动画</li>\n</ol>\n<p>实现如下所示动效：</p>\n<p><html><head></head><body><video data-src="/examples/international-official-website-technical-difficulties/number-change-display.mp4" loop="" muted="" autoplay="" width="100%" class="lazy"></video></body></html></video></p>\n<h3 id="选型过程-1"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h3>\n<p>同 <code class="language-text">逐行显示</code> 的选型过程，这里使用的是 react-spring</p>\n<h3 id="核心代码-1"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21067498527411278000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { ReactNode, useRef, useEffect } from \'react\';\nimport classnames from \'classnames\';\nimport { a, useTrail, useSprings, useSpringRef } from \'@react-spring/web\';\nimport { useInViewport } from \'ahooks\';\n\nimport { delayFunc } from \'@/utils\';\n\nimport PageStyles from \'./index.module.less\';\n\ninterface TitleContent {\n   title: string;\n}\n\ninterface NumberContent {\n   number: string;\n   unit: string;\n   precision?: number;\n   render?: (value: number) => string;\n}\n\ninterface CommonDataItem {\n   hint: string;\n}\n\ntype DataItem = CommonDataItem & (TitleContent | NumberContent);\n\ninterface Props {\n   data: DataItem[];\n   className?: string;\n   delay?: number;\n}\n\nconst CarConfiguration = ({ data, className, delay = 300 }: Props) => {\n   const [trails, trailsApi] = useTrail(data.length, () => ({\n      opacity: 0,\n      y: 40\n   }));\n\n   const springsRef = useSpringRef();\n   const springs = useSprings(\n      data.length,\n      data.map((item) => ({\n         ref: springsRef,\n         from: {\n            number: 0\n         },\n         to: {\n            number: Number((item as NumberContent).number)\n         }\n      }))\n   );\n\n   const domRef = useRef();\n   const [inViewPort] = useInViewport(domRef);\n   useEffect(() => {\n      const startAnimation = async () => {\n         await delayFunc(delay);\n         trailsApi.start({\n            y: 0,\n            opacity: 1\n         });\n         await delayFunc(1200);\n         springsRef.start();\n      };\n\n      const reverseAnimation = () => {\n         trailsApi.start({\n            y: 40,\n            opacity: 0\n         });\n         [springsRef].forEach((item) => {\n            item &&\n               item.start({\n                  reverse: true\n               });\n         });\n      };\n\n      if (inViewPort) {\n         startAnimation();\n      } else {\n         reverseAnimation();\n      }\n      // eslint-disable-next-line react-hooks/exhaustive-deps\n   }, [inViewPort]);\n\n   return (\n      <div ref={domRef} className={classnames(PageStyles.configuration, className, \'car-configuration\')}>\n         {trails.map((style, index) => {\n            const item = data[index];\n            let title: ReactNode = (item as TitleContent).title;\n            const titleComponent = (\n               <>\n                  <span\n                     className={PageStyles.configurationTitle}\n                     key={Math.random()}\n                     dangerouslySetInnerHTML={{ __html: (item as TitleContent).title }}\n                  />\n                  <span\n                     className={PageStyles.unit}\n                     key={Math.random()}\n                     dangerouslySetInnerHTML={{ __html: (item as any).unit }}\n                  />\n               </>\n            );\n            const numberItem = item as NumberContent;\n            if (!title && numberItem.number) {\n               const renderFunc = numberItem.render\n                  ? numberItem.render\n                  : (value: number) => value.toFixed(numberItem.precision || 0);\n               title = (\n                  <>\n                     <a.span>{springs[index].number.to(renderFunc)}</a.span>\n                     <span\n                        className={PageStyles.unit}\n                        key={Math.random()}\n                        dangerouslySetInnerHTML={{ __html: numberItem.unit }}\n                     />\n                  </>\n               );\n            }\n            return (\n               <>\n                  <a.div\n                     key={index}\n                     className={classnames(PageStyles.configurationItem, \'car-configuration-item\')}\n                     style={style}\n                  >\n                     {typeof title === \'string\' ? (\n                        titleComponent\n                     ) : (\n                        <div className={PageStyles.configurationTitle}>{title} </div>\n                     )}\n                     <div className={PageStyles.configurationHint}>{item.hint}</div>\n                  </a.div>\n                  {index < trails.length - 1 && <a.div key={index} className={PageStyles.divider} style={style} />}\n               </>\n            );\n         })}\n      </div>\n   );\n};\n\nexport default CarConfiguration;`, `21067498527411278000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> ReactNode<span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> classnames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> a<span class="token punctuation">,</span> useTrail<span class="token punctuation">,</span> useSprings<span class="token punctuation">,</span> useSpringRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@react-spring/web\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useInViewport <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> delayFunc <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> PageStyles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">TitleContent</span> <span class="token punctuation">{</span>\n   title<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">NumberContent</span> <span class="token punctuation">{</span>\n   <span class="token builtin">number</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n   unit<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n   precision<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n   render<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">:</span> <span class="token builtin">number</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">CommonDataItem</span> <span class="token punctuation">{</span>\n   hint<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">type</span> DataItem <span class="token operator">=</span> CommonDataItem <span class="token operator">&amp;</span> <span class="token punctuation">(</span>TitleContent <span class="token operator">|</span> NumberContent<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">Props</span> <span class="token punctuation">{</span>\n   data<span class="token punctuation">:</span> DataItem<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n   className<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n   delay<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">CarConfiguration</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data<span class="token punctuation">,</span> className<span class="token punctuation">,</span> delay <span class="token operator">=</span> <span class="token number">300</span> <span class="token punctuation">}</span><span class="token punctuation">:</span> Props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>trails<span class="token punctuation">,</span> trailsApi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useTrail</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>\n      opacity<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n      y<span class="token punctuation">:</span> <span class="token number">40</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> springsRef <span class="token operator">=</span> <span class="token function">useSpringRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> springs <span class="token operator">=</span> <span class="token function">useSprings</span><span class="token punctuation">(</span>\n      data<span class="token punctuation">.</span>length<span class="token punctuation">,</span>\n      data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>\n         ref<span class="token punctuation">:</span> springsRef<span class="token punctuation">,</span>\n         <span class="token keyword">from</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token builtin">number</span><span class="token punctuation">:</span> <span class="token number">0</span>\n         <span class="token punctuation">}</span><span class="token punctuation">,</span>\n         to<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token builtin">number</span><span class="token punctuation">:</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item <span class="token keyword">as</span> NumberContent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">number</span><span class="token punctuation">)</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> domRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>inViewPort<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useInViewport</span><span class="token punctuation">(</span>domRef<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token function-variable function">startAnimation</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">await</span> <span class="token function">delayFunc</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         trailsApi<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n            opacity<span class="token punctuation">:</span> <span class="token number">1</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token keyword">await</span> <span class="token function">delayFunc</span><span class="token punctuation">(</span><span class="token number">1200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         springsRef<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> <span class="token function-variable function">reverseAnimation</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         trailsApi<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            y<span class="token punctuation">:</span> <span class="token number">40</span><span class="token punctuation">,</span>\n            opacity<span class="token punctuation">:</span> <span class="token number">0</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">[</span>springsRef<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            item <span class="token operator">&amp;&amp;</span>\n               item<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                  reverse<span class="token punctuation">:</span> <span class="token boolean">true</span>\n               <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>inViewPort<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token function">startAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         <span class="token function">reverseAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>inViewPort<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">return</span> <span class="token punctuation">(</span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>domRef<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>PageStyles<span class="token punctuation">.</span>configuration<span class="token punctuation">,</span> className<span class="token punctuation">,</span> <span class="token string">\'car-configuration\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n         </span><span class="token punctuation">{</span>trails<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">style<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">const</span> item <span class="token operator">=</span> data<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>\n            <span class="token keyword">let</span> title<span class="token punctuation">:</span> ReactNode <span class="token operator">=</span> <span class="token punctuation">(</span>item <span class="token keyword">as</span> TitleContent<span class="token punctuation">)</span><span class="token punctuation">.</span>title<span class="token punctuation">;</span>\n            <span class="token keyword">const</span> titleComponent <span class="token operator">=</span> <span class="token punctuation">(</span>\n               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n                  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span>\n                     <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>PageStyles<span class="token punctuation">.</span>configurationTitle<span class="token punctuation">}</span></span>\n                     <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n                     <span class="token attr-name">dangerouslySetInnerHTML</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> __html<span class="token punctuation">:</span> <span class="token punctuation">(</span>item <span class="token keyword">as</span> TitleContent<span class="token punctuation">)</span><span class="token punctuation">.</span>title <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n                  <span class="token punctuation">/></span></span><span class="token plain-text">\n                  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span>\n                     <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>PageStyles<span class="token punctuation">.</span>unit<span class="token punctuation">}</span></span>\n                     <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n                     <span class="token attr-name">dangerouslySetInnerHTML</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> __html<span class="token punctuation">:</span> <span class="token punctuation">(</span>item <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unit <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n                  <span class="token punctuation">/></span></span><span class="token plain-text">\n               </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>\n            <span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">const</span> numberItem <span class="token operator">=</span> item <span class="token keyword">as</span> NumberContent<span class="token punctuation">;</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>title <span class="token operator">&amp;&amp;</span> numberItem<span class="token punctuation">.</span><span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token keyword">const</span> renderFunc <span class="token operator">=</span> numberItem<span class="token punctuation">.</span>render\n                  <span class="token operator">?</span> numberItem<span class="token punctuation">.</span><span class="token function-variable function">render</span>\n                  <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">:</span> <span class="token builtin">number</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> value<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span>numberItem<span class="token punctuation">.</span>precision <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n               title <span class="token operator">=</span> <span class="token punctuation">(</span>\n                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n                     </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a.span</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>springs<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">number</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>renderFunc<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a.span</span><span class="token punctuation">></span></span><span class="token plain-text">\n                     </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span>\n                        <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>PageStyles<span class="token punctuation">.</span>unit<span class="token punctuation">}</span></span>\n                        <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n                        <span class="token attr-name">dangerouslySetInnerHTML</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> __html<span class="token punctuation">:</span> numberItem<span class="token punctuation">.</span>unit <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n                     <span class="token punctuation">/></span></span><span class="token plain-text">\n                  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>\n               <span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n            <span class="token keyword">return</span> <span class="token punctuation">(</span>\n               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n                  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a.div</span>\n                     <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span>\n                     <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>PageStyles<span class="token punctuation">.</span>configurationItem<span class="token punctuation">,</span> <span class="token string">\'car-configuration-item\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n                     <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span></span>\n                  <span class="token punctuation">></span></span><span class="token plain-text">\n                     </span><span class="token punctuation">{</span><span class="token keyword">typeof</span> title <span class="token operator">===</span> <span class="token string">\'string\'</span> <span class="token operator">?</span> <span class="token punctuation">(</span>\n                        titleComponent\n                     <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>\n                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>PageStyles<span class="token punctuation">.</span>configurationTitle<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>title<span class="token punctuation">}</span><span class="token plain-text"> </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n                     <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">\n                     </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>PageStyles<span class="token punctuation">.</span>configurationHint<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>hint<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n                  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a.div</span><span class="token punctuation">></span></span><span class="token plain-text">\n                  </span><span class="token punctuation">{</span>index <span class="token operator">&lt;</span> trails<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a.div</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>PageStyles<span class="token punctuation">.</span>divider<span class="token punctuation">}</span></span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">}</span><span class="token plain-text">\n               </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>\n            <span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> CarConfiguration<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行效果-1"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<!-- <iframe data-src="https://codesandbox.io/embed/ocnfxs?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/r72tf2?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="固定页面滚动控制"><a href="#%E5%9B%BA%E5%AE%9A%E9%A1%B5%E9%9D%A2%E6%BB%9A%E5%8A%A8%E6%8E%A7%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>固定页面滚动控制</h2>\n<h3 id="需求背景-3"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>实现要点：</p>\n<ol>\n<li>随着鼠标滚轮滚动而触发的动效（跟随鼠标滚动，鼠标停顿时，动效也会停顿）</li>\n<li>需要固定页面</li>\n</ol>\n<p>实现如下所示的动效：</p>\n<p><html><head></head><body><video data-src="/examples/international-official-website-technical-difficulties/fix-page-scroll-display.mp4" loop="" muted="" autoplay="" width="100%" class="lazy"></video></body></html></video></p>\n<h3 id="选型过程-2"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h3>\n<table>\n<thead>\n<tr>\n<th align="left">选型</th>\n<th align="left">优点</th>\n<th align="left">缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left"><a href="https://github.com/janpaepke/ScrollMagic" target="_blank" rel="nofollow noreferrer noopener">ScrollMagic</a></td>\n<td align="left">官网例子满足需求</td>\n<td align="left">需要封装成 react</td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/bitworking/react-scrollmagic" target="_blank" rel="nofollow noreferrer noopener">react-scrollmagic</a></td>\n<td align="left"><ol>\n<li>\n可在 react 中直接使用\n</li>\n<li>\n提供固定页面的百分比可完美用于 react-gsap 动效\n</li>\n</ol></td>\n<td align="left"><ol>\n<li>\n滑动过快会出现“抖动”\n</li>\n<li>\n不能实现切屏 + 固定页面同时存在的效果\n</li>\n</ol></td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/bitworking/react-gsap" target="_blank" rel="nofollow noreferrer noopener">react-gsap</a>\n + scrollTrigger</td>\n<td align="left">解决了“抖动”问题</td>\n<td align="left">react-gsap 暴露的 api 不够底层，实现切屏 + 固定页面较困难</td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/greensock/GSAP" target="_blank" rel="nofollow noreferrer noopener">gsap</a>\n + scrollTrigger</td>\n<td align="left">解决了以上的所有缺点</td>\n<td align="left">代码量过多，react 下需要考虑情况较多</td>\n</tr>\n</tbody>\n</table>\n<h3 id="核心代码-2"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<h4 id="react-scrollmagic"><a href="#react-scrollmagic" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-scrollmagic</h4>\n<p>web/components/reactScrollMagic/index.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46368755893692785000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { Children, cloneElement, ReactElement } from \'react\'\nimport { Controller as XPController, Scene, SceneProps as XPSceneProps } from \'xp-react-scrollmagic\'\n\nimport useStoreContext, { CLIENT_TYPE } from \'@/hooks/useStoreContext\'\n\nimport { getWindowHeight } from \'@/utils\'\n\nconst defaultControllerProps = {\n  // container: getDocument()?.querySelector(\'h\')\n}\n\nconst defaultSceneProps = {\n  indicators: false,\n  triggerHook: 0,\n  duration: getWindowHeight()\n}\n\ninterface ProgressEventsParams {\n  progress: number\n  event: {\n    state: string\n    type: string\n  }\n}\n\nexport interface SceneProps {\n  sceneProps?: (Partial<XPSceneProps> & { enableParams: boolean }) | null\n  sceneParams?: ProgressEventsParams\n}\n\ninterface ControllerProps {\n  children: Array<ReactElement<SceneProps>> | ReactElement<SceneProps>\n}\n\nconst ReactScrollMagic = ({\n  children\n}: ControllerProps) => {\n  const { state } = useStoreContext()\n\n  const renderChildren = Children.map(children, (item, index) => {\n    const sceneProps = {\n      ...defaultSceneProps,\n      pin: state?.clientType === CLIENT_TYPE.PC,\n      ...item.props.sceneProps\n    }\n    if (sceneProps.enableParams) {\n      const {\n        enableParams,\n        ...rest\n      } = sceneProps\n      return (\n        <Scene\n          {...rest}\n        >\n          {\n            (progress: number, event: { state: string }) => {\n              return <div>\n                {\n                  cloneElement(item, {\n                    ...item.props,\n                    sceneParams: {\n                      progress,\n                      event\n                    }\n                  })\n                }\n              </div>\n            }\n          }\n        </Scene>\n      )\n    }\n    return (\n      <Scene\n        {...sceneProps}\n      >\n        <div>\n          {item}\n        </div>\n      </Scene>\n    )\n  })\n\n  return (\n    <XPController {...defaultControllerProps}>\n      <div>\n        {renderChildren}\n      </div>\n    </XPController>\n  )\n}\n\nexport default ReactScrollMagic`, `46368755893692785000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Children<span class="token punctuation">,</span> cloneElement<span class="token punctuation">,</span> ReactElement <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> Controller <span class="token keyword">as</span> XPController<span class="token punctuation">,</span> Scene<span class="token punctuation">,</span> SceneProps <span class="token keyword">as</span> XPSceneProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'xp-react-scrollmagic\'</span>\n\n<span class="token keyword">import</span> useStoreContext<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token constant">CLIENT_TYPE</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/hooks/useStoreContext\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> getWindowHeight <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span>\n\n<span class="token keyword">const</span> defaultControllerProps <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token comment">// container: getDocument()?.querySelector(\'h\')</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> defaultSceneProps <span class="token operator">=</span> <span class="token punctuation">{</span>\n  indicators<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n  triggerHook<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n  duration<span class="token punctuation">:</span> <span class="token function">getWindowHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">ProgressEventsParams</span> <span class="token punctuation">{</span>\n  progress<span class="token punctuation">:</span> <span class="token builtin">number</span>\n  event<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    state<span class="token punctuation">:</span> <span class="token builtin">string</span>\n    <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token builtin">string</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">SceneProps</span> <span class="token punctuation">{</span>\n  sceneProps<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>Partial<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XPSceneProps</span></span><span class="token punctuation">></span></span><span class="token plain-text"> &amp; </span><span class="token punctuation">{</span> enableParams<span class="token punctuation">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">}</span><span class="token plain-text">) | null\n  sceneParams?: ProgressEventsParams\n}\n\ninterface ControllerProps </span><span class="token punctuation">{</span>\n  children<span class="token punctuation">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>ReactElement<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">SceneProps</span></span><span class="token punctuation">></span></span><span class="token plain-text">> | ReactElement</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">SceneProps</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n}\n\nconst ReactScrollMagic = ({\n  children\n}: ControllerProps) => </span><span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> state <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useStoreContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> renderChildren <span class="token operator">=</span> Children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> sceneProps <span class="token operator">=</span> <span class="token punctuation">{</span>\n      <span class="token operator">...</span>defaultSceneProps<span class="token punctuation">,</span>\n      pin<span class="token punctuation">:</span> state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">PC</span><span class="token punctuation">,</span>\n      <span class="token operator">...</span>item<span class="token punctuation">.</span>props<span class="token punctuation">.</span>sceneProps\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>sceneProps<span class="token punctuation">.</span>enableParams<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span>\n        enableParams<span class="token punctuation">,</span>\n        <span class="token operator">...</span>rest\n      <span class="token punctuation">}</span> <span class="token operator">=</span> sceneProps\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>\n        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Scene</span></span>\n          <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">rest</span><span class="token punctuation">}</span></span>\n        <span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token punctuation">{</span>\n            <span class="token punctuation">(</span><span class="token parameter">progress<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> event<span class="token punctuation">:</span> <span class="token punctuation">{</span> state<span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n              <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n                </span><span class="token punctuation">{</span>\n                  <span class="token function">cloneElement</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n                    <span class="token operator">...</span>item<span class="token punctuation">.</span>props<span class="token punctuation">,</span>\n                    sceneParams<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                      progress<span class="token punctuation">,</span>\n                      event\n                    <span class="token punctuation">}</span>\n                  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n                <span class="token punctuation">}</span><span class="token plain-text">\n              </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Scene</span></span><span class="token punctuation">></span></span>\n      <span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Scene</span></span>\n        <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">sceneProps</span><span class="token punctuation">}</span></span>\n      <span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token punctuation">{</span>item<span class="token punctuation">}</span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Scene</span></span><span class="token punctuation">></span></span>\n    <span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XPController</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">defaultControllerProps</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token punctuation">{</span>renderChildren<span class="token punctuation">}</span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">XPController</span></span><span class="token punctuation">></span></span>\n  <span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token plain-text">\n\nexport default ReactScrollMagic</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用时：</p>\n<p>web/pages/p7/render.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43005023150186710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import ReactScrollMagic from \'@/components/reactScrollMagic\';\nimport { getWindowHeight } from \'@/utils\';\n\n<ReactScrollMagic>\n   <Sepa\n      sceneProps={{\n         enableParams: true,\n         duration: getWindowHeight() * 2 // 总共停 2 屏高度\n      }}\n   />\n</ReactScrollMagic>;`, `43005023150186710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> ReactScrollMagic <span class="token keyword">from</span> <span class="token string">\'@/components/reactScrollMagic\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> getWindowHeight <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span><span class="token punctuation">;</span>\n\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ReactScrollMagic</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n   </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Sepa</span></span>\n      <span class="token attr-name">sceneProps</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n         enableParams<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n         duration<span class="token punctuation">:</span> <span class="token function">getWindowHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token comment">// 总共停 2 屏高度</span>\n      <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n   <span class="token punctuation">/></span></span><span class="token plain-text">\n</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">ReactScrollMagic</span></span><span class="token punctuation">></span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>web/pages/p7/components/sepa/index.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1071418499841092500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React from \'react\'\nimport { useTranslation } from \'react-i18next\'\nimport classNames from \'classnames\'\nimport { Tween, PlayState } from \'react-gsap\'\n\nimport { l } from \'@/components/lazyLoader\'\nimport ModelLeftText from \'@/components/modelLeftText\'\nimport { SceneProps } from \'@/components/reactScrollMagic\'\nimport AnimationBg from \'@/components/animationBg\'\n\nimport useTmpComponent from \'@/hooks/useTmpComponent\'\n\nimport { getAnimateProgresses } from \'@/utils/animate\'\n\nimport styles from \'./index.module.less\'\n\nconst Index = ({\n  sceneParams\n}: SceneProps) => {\n  const {\n    progress = 0\n  } = sceneParams || {}\n  const { t } = useTranslation()\n  const getValue = (param: string) => t(\\`p7.sepa.\\${param}\\`)\n\n  const { api, Slot } = useTmpComponent()\n\n  const [animationTextProgress] = getAnimateProgresses(progress, [\n    {\n      start: 1 / 2, // 滚动到一半的时候才开始动效\n      duration: 1 / 2 // 动效的持续百分比\n    }\n  ])\n\n  return (\n    <l.div\n      src=&quot;/public/p7/sepa/p7-p4-1.jpg&quot;\n      minSrcSet=&quot;/public/p7/sepa/p7-p4-1@mini.jpg&quot;\n      srcSet=&quot;/public/p7/sepa/p7-p4-1@2x.jpg&quot;\n      className={classNames(\'global-full-page-with-top-menu\', styles.container)}\n    >\n      <Slot\n        modelType=\'P7\'\n        pageType=\'SEPA\'\n        buttonType=\'Arrow\'\n        itemList={[{\n          imgList: [{\n            src: \'/public/p7/d3/P7-d3-1.png\',\n            srcSet: \'/public/p7/d3/P7-d3-1@2x.jpg\'\n          }],\n          background: \'linear-gradient(133deg, #343538 0%, #000102 100%)\',\n          textData: {\n            topSubTitle: t(\'p7.d3.topSubTitle1\'),\n            title: t(\'p7.d3.title1\'),\n            subTitle: t(\'p7.d3.subTitle1\')\n          }\n        }, {\n          imgList: [{\n            src: \'/public/p7/d3/P7-d3-2.jpg\',\n            srcSet: \'/public/p7/d3/P7-d3-2@2x.jpg\'\n          }],\n          background: \'linear-gradient(133deg, #343538 0%, #000102 100%)\',\n          textData: {\n            topSubTitle: t(\'p7.d3.topSubTitle2\'),\n            title: t(\'p7.d3.title2\'),\n            subTitle: t(\'p7.d3.subTitle2\')\n          }\n        }]}\n      />\n      <div ref={trackRef} className={classNames(\'body\', styles.body)}>\n        <ModelLeftText\n          topSubTitle={getValue(\'topSubTitle\')}\n          title={getValue(\'title\')}\n          subTitle={getValue(\'subTitle\')}\n          shortDesc={getValue(\'shortDesc\')}\n          buttonProps={{\n            onClick: () => {\n              api.current?.open()\n            },\n            type: \'ghost\'\n          }}\n        />\n      </div>\n      {\n        animationTextProgress > 0 && <AnimationBg type={2} className={styles.animationBg}>\n          <Tween\n            from={{\n              scale: 40\n            }}\n            totalProgress={animationTextProgress}\n            playState={PlayState.pause}\n          >\n            <div className={styles.animationText}>\n              {/* 这里所有国家都是这个，不需要国际化 */}\n              XPILOT\n            </div>\n          </Tween>\n        </AnimationBg>\n      }\n    </l.div>\n  )\n}\n\nexport default Index`, `1071418499841092500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useTranslation <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-i18next\'</span>\n<span class="token keyword">import</span> classNames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> Tween<span class="token punctuation">,</span> PlayState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-gsap\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> l <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/lazyLoader\'</span>\n<span class="token keyword">import</span> ModelLeftText <span class="token keyword">from</span> <span class="token string">\'@/components/modelLeftText\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> SceneProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/reactScrollMagic\'</span>\n<span class="token keyword">import</span> AnimationBg <span class="token keyword">from</span> <span class="token string">\'@/components/animationBg\'</span>\n\n<span class="token keyword">import</span> useTmpComponent <span class="token keyword">from</span> <span class="token string">\'@/hooks/useTmpComponent\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> getAnimateProgresses <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils/animate\'</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">Index</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>\n  sceneParams\n<span class="token punctuation">}</span><span class="token punctuation">:</span> SceneProps</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span>\n    progress <span class="token operator">=</span> <span class="token number">0</span>\n  <span class="token punctuation">}</span> <span class="token operator">=</span> sceneParams <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> t <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTranslation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">param<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">p7.sepa.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>param<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> api<span class="token punctuation">,</span> Slot <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTmpComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>animationTextProgress<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getAnimateProgresses</span><span class="token punctuation">(</span>progress<span class="token punctuation">,</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      start<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// 滚动到一半的时候才开始动效</span>\n      duration<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token comment">// 动效的持续百分比</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>l.div</span>\n      <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/public/p7/sepa/p7-p4-1.jpg<span class="token punctuation">"</span></span>\n      <span class="token attr-name">minSrcSet</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/public/p7/sepa/p7-p4-1@mini.jpg<span class="token punctuation">"</span></span>\n      <span class="token attr-name">srcSet</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/public/p7/sepa/p7-p4-1@2x.jpg<span class="token punctuation">"</span></span>\n      <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classNames</span><span class="token punctuation">(</span><span class="token string">\'global-full-page-with-top-menu\'</span><span class="token punctuation">,</span> styles<span class="token punctuation">.</span>container<span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n    <span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Slot</span></span>\n        <span class="token attr-name">modelType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>P7<span class="token punctuation">\'</span></span>\n        <span class="token attr-name">pageType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>SEPA<span class="token punctuation">\'</span></span>\n        <span class="token attr-name">buttonType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>Arrow<span class="token punctuation">\'</span></span>\n        <span class="token attr-name">itemList</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token punctuation">{</span>\n          imgList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n            src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d3/P7-d3-1.png\'</span><span class="token punctuation">,</span>\n            srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d3/P7-d3-1@2x.jpg\'</span>\n          <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          background<span class="token punctuation">:</span> <span class="token string">\'linear-gradient(133deg, #343538 0%, #000102 100%)\'</span><span class="token punctuation">,</span>\n          textData<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            topSubTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d3.topSubTitle1\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            title<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d3.title1\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            subTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d3.subTitle1\'</span><span class="token punctuation">)</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n          imgList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n            src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d3/P7-d3-2.jpg\'</span><span class="token punctuation">,</span>\n            srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d3/P7-d3-2@2x.jpg\'</span>\n          <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          background<span class="token punctuation">:</span> <span class="token string">\'linear-gradient(133deg, #343538 0%, #000102 100%)\'</span><span class="token punctuation">,</span>\n          textData<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            topSubTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d3.topSubTitle2\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            title<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d3.title2\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            subTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d3.subTitle2\'</span><span class="token punctuation">)</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>\n      <span class="token punctuation">/></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>trackRef<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classNames</span><span class="token punctuation">(</span><span class="token string">\'body\'</span><span class="token punctuation">,</span> styles<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ModelLeftText</span></span>\n          <span class="token attr-name">topSubTitle</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'topSubTitle\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">title</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'title\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">subTitle</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'subTitle\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">shortDesc</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'shortDesc\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">buttonProps</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n            <span class="token function-variable function">onClick</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n              api<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">\'ghost\'</span>\n          <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n        <span class="token punctuation">/></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token punctuation">{</span>\n        animationTextProgress <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AnimationBg</span></span> <span class="token attr-name">type</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>animationBg<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Tween</span></span>\n            <span class="token attr-name">from</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n              scale<span class="token punctuation">:</span> <span class="token number">40</span>\n            <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n            <span class="token attr-name">totalProgress</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>animationTextProgress<span class="token punctuation">}</span></span>\n            <span class="token attr-name">playState</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>PlayState<span class="token punctuation">.</span>pause<span class="token punctuation">}</span></span>\n          <span class="token punctuation">></span></span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>animationText<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n              </span><span class="token punctuation">{</span><span class="token comment">/* 这里所有国家都是这个，不需要国际化 */</span><span class="token punctuation">}</span><span class="token plain-text">\n              XPILOT\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Tween</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">AnimationBg</span></span><span class="token punctuation">></span></span>\n      <span class="token punctuation">}</span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>l.div</span><span class="token punctuation">></span></span>\n  <span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> Index</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="react-gsap-2"><a href="#react-gsap-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-gsap</h4>\n<p>后期需要实现 <code class="language-text">切屏 + 固定页面</code> 的效果，暂未实现</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29072526676195287000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { Children, cloneElement, useRef, useEffect, useState } from \'react\';\nimport { gsap } from \'gsap\';\nimport produce from \'immer\';\n\nimport { getDocument } from \'@/utils\';\n\nif (getDocument()) {\n   import(\'gsap/ScrollTrigger\').then((component) => {\n      const ScrollTrigger = component.default;\n      gsap.registerPlugin(ScrollTrigger);\n   });\n}\nconst ReactScrollMagic = ({ children }) => {\n   const revealRefs = useRef([]);\n   const [updateParams, setUpdateParams] = useState([]);\n   revealRefs.current = [];\n\n   useEffect(() => {\n      revealRefs.current.forEach((el, index) => {\n         gsap.from(el, {\n            scrollTrigger: {\n               trigger: el,\n               pin: true,\n               start: \'top top\',\n               end: \'+=300%\',\n               markers: true,\n               anticipatePin: 2, // 滑动过快时的“防抖”参数\n               onUpdate: (self) => {\n                  console.log(\n                     self,\n                     \'progress:\',\n                     self.isActive,\n                     self.progress.toFixed(3),\n                     \'direction:\',\n                     self.direction,\n                     \'velocity\',\n                     self.getVelocity()\n                  );\n                  const { progress, isActive } = self;\n                  setUpdateParams(\n                     produce((draftState) => {\n                        draftState[index] = {\n                           progress,\n                           isActive\n                        };\n                     })\n                  );\n               }\n            }\n         });\n      });\n   }, []);\n\n   const addToRefs = (el, index) => {\n      if (el && !revealRefs.current.includes(el)) {\n         revealRefs.current[index] = el;\n      }\n      console.log(revealRefs.current);\n   };\n\n   return Children.map(children, (item, index) => {\n      // const sceneProps = {\n      //   ...defaultSceneProps,\n      //   ...item.props.sceneProps\n      // }\n      return (\n         <div ref={(el) => addToRefs(el, index)}>\n            {cloneElement(item, {\n               ...item.props,\n               sceneParams: updateParams[index] || {}\n            })}\n         </div>\n      );\n   });\n};\n\nexport default ReactScrollMagic;`, `29072526676195287000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Children<span class="token punctuation">,</span> cloneElement<span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useEffect<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> gsap <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'gsap\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> produce <span class="token keyword">from</span> <span class="token string">\'immer\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> getDocument <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">\'gsap/ScrollTrigger\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">component</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> ScrollTrigger <span class="token operator">=</span> component<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">;</span>\n      gsap<span class="token punctuation">.</span><span class="token function">registerPlugin</span><span class="token punctuation">(</span>ScrollTrigger<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">const</span> <span class="token function-variable function">ReactScrollMagic</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> revealRefs <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>updateParams<span class="token punctuation">,</span> setUpdateParams<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   revealRefs<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n   <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      revealRefs<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         gsap<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n            scrollTrigger<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n               trigger<span class="token punctuation">:</span> el<span class="token punctuation">,</span>\n               pin<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n               start<span class="token punctuation">:</span> <span class="token string">\'top top\'</span><span class="token punctuation">,</span>\n               end<span class="token punctuation">:</span> <span class="token string">\'+=300%\'</span><span class="token punctuation">,</span>\n               markers<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n               anticipatePin<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// 滑动过快时的“防抖”参数</span>\n               <span class="token function-variable function">onUpdate</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">self</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>\n                     self<span class="token punctuation">,</span>\n                     <span class="token string">\'progress:\'</span><span class="token punctuation">,</span>\n                     self<span class="token punctuation">.</span>isActive<span class="token punctuation">,</span>\n                     self<span class="token punctuation">.</span>progress<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                     <span class="token string">\'direction:\'</span><span class="token punctuation">,</span>\n                     self<span class="token punctuation">.</span>direction<span class="token punctuation">,</span>\n                     <span class="token string">\'velocity\'</span><span class="token punctuation">,</span>\n                     self<span class="token punctuation">.</span><span class="token function">getVelocity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n                  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n                  <span class="token keyword">const</span> <span class="token punctuation">{</span> progress<span class="token punctuation">,</span> isActive <span class="token punctuation">}</span> <span class="token operator">=</span> self<span class="token punctuation">;</span>\n                  <span class="token function">setUpdateParams</span><span class="token punctuation">(</span>\n                     <span class="token function">produce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">draftState</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                        draftState<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n                           progress<span class="token punctuation">,</span>\n                           isActive\n                        <span class="token punctuation">}</span><span class="token punctuation">;</span>\n                     <span class="token punctuation">}</span><span class="token punctuation">)</span>\n                  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n               <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> <span class="token function-variable function">addToRefs</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>el <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>revealRefs<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         revealRefs<span class="token punctuation">.</span>current<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> el<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>revealRefs<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">return</span> Children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// const sceneProps = {</span>\n      <span class="token comment">//   ...defaultSceneProps,</span>\n      <span class="token comment">//   ...item.props.sceneProps</span>\n      <span class="token comment">// }</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>\n         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">addToRefs</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n            </span><span class="token punctuation">{</span><span class="token function">cloneElement</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n               <span class="token operator">...</span>item<span class="token punctuation">.</span>props<span class="token punctuation">,</span>\n               sceneParams<span class="token punctuation">:</span> updateParams<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">\n         </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> ReactScrollMagic<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行效果-2"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<h4 id="react-scrollmagic-1"><a href="#react-scrollmagic-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-scrollmagic</h4>\n<!-- <iframe data-src="https://codesandbox.io/embed/6t81il?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/nxqttn?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h4 id="react-gsap-3"><a href="#react-gsap-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-gsap</h4>\n<!-- <iframe data-src="https://codesandbox.io/embed/jhqw77?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/wjdr88?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="视频进度同步--缩放动效"><a href="#%E8%A7%86%E9%A2%91%E8%BF%9B%E5%BA%A6%E5%90%8C%E6%AD%A5--%E7%BC%A9%E6%94%BE%E5%8A%A8%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>视频进度同步 / 缩放动效</h2>\n<h3 id="需求背景-4"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>实现功能如下：</p>\n<ol>\n<li>页面往下完全滚动到第二屏时，视频开始播放，鼠标的滚动一段距离后，触发视频缩小到右下角视频的动效</li>\n<li>文字、图片有缩放效果</li>\n</ol>\n<p>实现要点如下：</p>\n<ol>\n<li>视频在视口范围内只会播放一次，完全离开视口重置播放进度，完全进入视口播放视频</li>\n<li>由 2 个视频拼接而成，触发缩放的瞬间进度需要同步（在视频未播放完成的情况下需要同步）</li>\n<li>过渡时需要使用 visibility 来控制显隐</li>\n</ol>\n<p>实现如下所示的动效：</p>\n<p><html><head></head><body><video data-src="/examples/international-official-website-technical-difficulties/video-sync-scale-play.mp4" loop="" muted="" autoplay="" width="100%" class="lazy"></video></body></html></video></p>\n<h3 id="选型过程-3"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h3>\n<p>同 <code class="language-text">逐行显示</code>、<code class="language-text">固定页面滚动控制</code> 的选型过程</p>\n<h3 id="核心代码-3"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<p>web/pages/p7/components/learnMore/index.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5718073810710811000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { useState, useRef, useEffect } from \'react\'\nimport { useTranslation } from \'react-i18next\'\nimport classNames from \'classnames\'\nimport { useInViewport } from \'ahooks\'\nimport { isNumber } from \'lodash\'\n\nimport { SceneProps } from \'@/components/reactScrollMagic\'\nimport { l, VideoRef } from \'@/components/lazyLoader\'\n\nimport { getAnimateProgresses } from \'@/utils/animate\'\n\nimport useStoreContext, { CLIENT_TYPE } from \'@/hooks/useStoreContext\'\n\nimport ModelLearnMore from \'../modelLearnMore\'\n\nimport styles from \'./index.module.less\'\n\nexport type VisibleComponent = \'JsmpegPlayer\' | \'ModelLearnMore\'\n\nconst MAX_THRESHOLD = 0.99\nconst MIN_THRESHOLD = 0.01\nconst THRESHOLD = [MIN_THRESHOLD, MAX_THRESHOLD]\n\nconst Index = ({\n  sceneParams\n}: SceneProps) => {\n  const { t } = useTranslation()\n  const getValue = (param: string) => t(\\`p7.learnMore.\\${param}\\`)\n\n  const {\n    progress = 0\n  } = sceneParams || {}\n\n  const [modelLearnMoreProgress] = getAnimateProgresses(progress, [\n    {\n      start: 1 / 2,\n      duration: 1 / 2\n    }\n  ])\n\n  // 设置哪个组件可见\n  const [visibleComponent, setVisibleComponent] = useState<VisibleComponent>(\'JsmpegPlayer\')\n\n  const { state } = useStoreContext()\n\n  const videoRef = useRef<VideoRef>(null)\n  const miniVideoRef = useRef<VideoRef>(null)\n\n  const containerRef = useRef(null)\n  const [_, ratio] = useInViewport(containerRef, {\n    threshold: THRESHOLD\n  })\n\n  const [isPlayed, setIsPlayed] = useState(false)\n\n  useEffect(() => {\n    if (state?.clientType === CLIENT_TYPE.H5) {\n      return\n    }\n\n    const videoDom = videoRef.current?.getVideoElement()\n    const miniVideoDom = miniVideoRef.current?.getVideoElement()\n    if (!isNumber(ratio) || !videoDom || !miniVideoDom) {\n      return\n    }\n\n    if (ratio > MAX_THRESHOLD && !isPlayed && visibleComponent === \'JsmpegPlayer\') {\n      videoDom.play()\n      setIsPlayed(true)\n    }\n\n    if (ratio > MAX_THRESHOLD && !isPlayed && visibleComponent === \'ModelLearnMore\') {\n      miniVideoDom.play()\n      setIsPlayed(true)\n    }\n\n    if (ratio < MIN_THRESHOLD) {\n      videoDom.currentTime = 0\n      videoDom.pause()\n\n      miniVideoDom.currentTime = 0\n      miniVideoDom.pause()\n      setIsPlayed(false)\n    }\n  }, [ratio, visibleComponent, isPlayed])\n\n  useEffect(() => {\n    if (state?.clientType === CLIENT_TYPE.H5) {\n      return\n    }\n\n    const videoDom = videoRef.current?.getVideoElement()\n    const miniVideoDom = miniVideoRef.current?.getVideoElement()\n    if (!videoDom || !miniVideoDom) {\n      return\n    }\n\n    if (visibleComponent === \'ModelLearnMore\') {\n      miniVideoDom.currentTime = videoDom.currentTime\n      if (miniVideoDom.currentTime < miniVideoDom.duration) {\n        miniVideoDom.play()\n      }\n    } else {\n      videoDom.currentTime = miniVideoDom.currentTime\n      if (videoDom.currentTime < videoDom.duration) {\n        videoDom.play()\n      }\n    }\n  }, [visibleComponent])\n\n  let miniVideoProps = {\n    type: \'video\',\n    srcPoster: \'/public/p7/learn-more/p7-wing@mini.jpg\',\n    src: \'/public/p7/learn-more/p7-wing-origin-fast.mp4\'\n  }\n\n  if (state?.clientType === CLIENT_TYPE.PC) {\n    miniVideoProps = {\n      ...miniVideoProps,\n      loop: false,\n      autoPlay: false,\n      ref: miniVideoRef,\n      isNeedScale: true\n    }\n  }\n\n  return (\n    <div\n      ref={containerRef}\n      className={styles.container}\n    >\n      {\n        state?.clientType === CLIENT_TYPE.PC && <l.video\n          ref={videoRef}\n          loop={false}\n          autoPlay={false}\n          src=&quot;/public/p7/learn-more/p7-wing-origin-fast.mp4&quot;\n          className={classNames(styles.player, visibleComponent !== \'JsmpegPlayer\' ? styles.hidden : \'\')}\n        />\n      }\n      <ModelLearnMore\n        className={state?.clientType === CLIENT_TYPE.PC && visibleComponent !== \'ModelLearnMore\' ? styles.hidden : \'\'}\n        progress={state?.clientType === CLIENT_TYPE.PC ? modelLearnMoreProgress : 100}\n        modelCenterTextProps={{\n          topSubTitle: getValue(\'topSubTitle\'),\n          title: getValue(\'title\'),\n          subTitle: getValue(\'subTitle\'),\n          shortDesc: getValue(\'shortDesc\'),\n          buttonText: getValue(\'button\'),\n          animation: state?.clientType === CLIENT_TYPE.H5\n        }}\n        onSetVisibleComponent={setVisibleComponent}\n        displayersProps={[\n          {\n            src: \'/public/p7/learn-more/p7-p2-1.jpg\',\n            srcSet: \'/public/p7/learn-more/p7-p2-1@2x.jpg\'\n          },\n          {\n            src: \'/public/p7/learn-more/p7-p2-2.jpg\',\n            srcSet: \'/public/p7/learn-more/p7-p2-2@2x.jpg\',\n            minSrcSet: \'/public/p7/learn-more/p7-p2-2@mini.jpg\'\n          },\n          miniVideoProps\n        ]}\n        itemList={[\n          {\n            imgList: [{\n              src: \'/public/p7/d1/P7-d1-1-3.jpg\',\n              srcSet: \'/public/p7/d1/P7-d1-1-3@2x.jpg\'\n            }, {\n              src: \'/public/p7/d1/P7-d1-1-1.jpg\',\n              srcSet: \'/public/p7/d1/P7-d1-1-1@2x.jpg\'\n            }, {\n              src: \'/public/p7/d1/P7-d1-1-2.jpg\',\n              srcSet: \'/public/p7/d1/P7-d1-1-2@2x.jpg\'\n            }],\n            background: \'linear-gradient(133deg, #343538 0%, #000102 100%)\',\n            textData: {\n              topSubTitle: t(\'p7.d1.topSubTitle1\'),\n              title: t(\'p7.d1.title1\'),\n              subTitle: t(\'p7.d1.subTitle1\')\n            }\n          },\n          {\n            imgList: [{\n              src: \'/public/p7/d1/P7-d1-2-3.jpg\',\n              srcSet: \'/public/p7/d1/P7-d1-2-3@2x.jpg\'\n            }, {\n              src: \'/public/p7/d1/P7-d1-2-1.jpg\',\n              srcSet: \'/public/p7/d1/P7-d1-2-1@2x.jpg\'\n            }, {\n              src: \'/public/p7/d1/P7-d1-2-2.jpg\',\n              srcSet: \'/public/p7/d1/P7-d1-2-2@2x.jpg\'\n            }],\n            background: \'linear-gradient(133deg, #B6CBDA 0%, #7A97AF 100%)\',\n            textData: {\n              topSubTitle: t(\'p7.d1.topSubTitle2\'),\n              title: t(\'p7.d1.title2\'),\n              subTitle: t(\'p7.d1.subTitle2\')\n            }\n          },\n          {\n            imgList: [{\n              src: \'/public/p7/d1/P7-d1-3-1.mp4\'\n            }, {\n              src: \'/public/p7/d1/P7-d1-3-2.jpg\',\n              srcSet: \'/public/p7/d1/P7-d1-3-2@2x.jpg\'\n            }],\n            background: \'linear-gradient(133deg, #343538 0%, #000102 100%)\',\n            textData: {\n              topSubTitle: t(\'p7.d1.topSubTitle3\'),\n              title: t(\'p7.d1.title3\'),\n              subTitle: t(\'p7.d1.subTitle3\')\n            }\n          }\n        ]}\n      />\n    </div>\n  )\n}\n\nexport default Index`, `5718073810710811000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useTranslation <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-i18next\'</span>\n<span class="token keyword">import</span> classNames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useInViewport <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> isNumber <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> SceneProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/reactScrollMagic\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> l<span class="token punctuation">,</span> VideoRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/lazyLoader\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> getAnimateProgresses <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils/animate\'</span>\n\n<span class="token keyword">import</span> useStoreContext<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token constant">CLIENT_TYPE</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/hooks/useStoreContext\'</span>\n\n<span class="token keyword">import</span> ModelLearnMore <span class="token keyword">from</span> <span class="token string">\'../modelLearnMore\'</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span>\n\n<span class="token keyword">export</span> <span class="token keyword">type</span> VisibleComponent <span class="token operator">=</span> <span class="token string">\'JsmpegPlayer\'</span> <span class="token operator">|</span> <span class="token string">\'ModelLearnMore\'</span>\n\n<span class="token keyword">const</span> <span class="token constant">MAX_THRESHOLD</span> <span class="token operator">=</span> <span class="token number">0.99</span>\n<span class="token keyword">const</span> <span class="token constant">MIN_THRESHOLD</span> <span class="token operator">=</span> <span class="token number">0.01</span>\n<span class="token keyword">const</span> <span class="token constant">THRESHOLD</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token constant">MIN_THRESHOLD</span><span class="token punctuation">,</span> <span class="token constant">MAX_THRESHOLD</span><span class="token punctuation">]</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">Index</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>\n  sceneParams\n<span class="token punctuation">}</span><span class="token punctuation">:</span> SceneProps</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> t <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTranslation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">param<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">p7.learnMore.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>param<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">{</span>\n    progress <span class="token operator">=</span> <span class="token number">0</span>\n  <span class="token punctuation">}</span> <span class="token operator">=</span> sceneParams <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>modelLearnMoreProgress<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getAnimateProgresses</span><span class="token punctuation">(</span>progress<span class="token punctuation">,</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      start<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>\n      duration<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">2</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n  <span class="token comment">// 设置哪个组件可见</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>visibleComponent<span class="token punctuation">,</span> setVisibleComponent<span class="token punctuation">]</span> <span class="token operator">=</span> useState<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">VisibleComponent</span></span><span class="token punctuation">></span></span><span class="token plain-text">(\'JsmpegPlayer\')\n\n  const </span><span class="token punctuation">{</span> state <span class="token punctuation">}</span><span class="token plain-text"> = useStoreContext()\n\n  const videoRef = useRef</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">VideoRef</span></span><span class="token punctuation">></span></span><span class="token plain-text">(null)\n  const miniVideoRef = useRef</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">VideoRef</span></span><span class="token punctuation">></span></span><span class="token plain-text">(null)\n\n  const containerRef = useRef(null)\n  const [_, ratio] = useInViewport(containerRef, </span><span class="token punctuation">{</span>\n    threshold<span class="token punctuation">:</span> <span class="token constant">THRESHOLD</span>\n  <span class="token punctuation">}</span><span class="token plain-text">)\n\n  const [isPlayed, setIsPlayed] = useState(false)\n\n  useEffect(() => </span><span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">H5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">const</span> videoDom <span class="token operator">=</span> videoRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getVideoElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">const</span> miniVideoDom <span class="token operator">=</span> miniVideoRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getVideoElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isNumber</span><span class="token punctuation">(</span>ratio<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>videoDom <span class="token operator">||</span> <span class="token operator">!</span>miniVideoDom<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>ratio <span class="token operator">></span> <span class="token constant">MAX_THRESHOLD</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isPlayed <span class="token operator">&amp;&amp;</span> visibleComponent <span class="token operator">===</span> <span class="token string">\'JsmpegPlayer\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      videoDom<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token function">setIsPlayed</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>ratio <span class="token operator">></span> <span class="token constant">MAX_THRESHOLD</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isPlayed <span class="token operator">&amp;&amp;</span> visibleComponent <span class="token operator">===</span> <span class="token string">\'ModelLearnMore\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      miniVideoDom<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token function">setIsPlayed</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>ratio <span class="token operator">&lt;</span> <span class="token constant">MIN_THRESHOLD</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      videoDom<span class="token punctuation">.</span>currentTime <span class="token operator">=</span> <span class="token number">0</span>\n      videoDom<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n      miniVideoDom<span class="token punctuation">.</span>currentTime <span class="token operator">=</span> <span class="token number">0</span>\n      miniVideoDom<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token function">setIsPlayed</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token plain-text">, [ratio, visibleComponent, isPlayed])\n\n  useEffect(() => </span><span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">H5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">const</span> videoDom <span class="token operator">=</span> videoRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getVideoElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">const</span> miniVideoDom <span class="token operator">=</span> miniVideoRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getVideoElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>videoDom <span class="token operator">||</span> <span class="token operator">!</span>miniVideoDom<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>visibleComponent <span class="token operator">===</span> <span class="token string">\'ModelLearnMore\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      miniVideoDom<span class="token punctuation">.</span>currentTime <span class="token operator">=</span> videoDom<span class="token punctuation">.</span>currentTime\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>miniVideoDom<span class="token punctuation">.</span>currentTime <span class="token operator">&lt;</span> miniVideoDom<span class="token punctuation">.</span>duration<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        miniVideoDom<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      videoDom<span class="token punctuation">.</span>currentTime <span class="token operator">=</span> miniVideoDom<span class="token punctuation">.</span>currentTime\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>videoDom<span class="token punctuation">.</span>currentTime <span class="token operator">&lt;</span> videoDom<span class="token punctuation">.</span>duration<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        videoDom<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token plain-text">, [visibleComponent])\n\n  let miniVideoProps = </span><span class="token punctuation">{</span>\n    <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">\'video\'</span><span class="token punctuation">,</span>\n    srcPoster<span class="token punctuation">:</span> <span class="token string">\'/public/p7/learn-more/p7-wing@mini.jpg\'</span><span class="token punctuation">,</span>\n    src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/learn-more/p7-wing-origin-fast.mp4\'</span>\n  <span class="token punctuation">}</span><span class="token plain-text">\n\n  if (state?.clientType === CLIENT_TYPE.PC) </span><span class="token punctuation">{</span>\n    miniVideoProps <span class="token operator">=</span> <span class="token punctuation">{</span>\n      <span class="token operator">...</span>miniVideoProps<span class="token punctuation">,</span>\n      loop<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n      autoPlay<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n      ref<span class="token punctuation">:</span> miniVideoRef<span class="token punctuation">,</span>\n      isNeedScale<span class="token punctuation">:</span> <span class="token boolean">true</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token plain-text">\n\n  return (\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>\n      <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>containerRef<span class="token punctuation">}</span></span>\n      <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>container<span class="token punctuation">}</span></span>\n    <span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token punctuation">{</span>\n        state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">PC</span> <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>l.video</span>\n          <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>videoRef<span class="token punctuation">}</span></span>\n          <span class="token attr-name">loop</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">autoPlay</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/public/p7/learn-more/p7-wing-origin-fast.mp4<span class="token punctuation">"</span></span>\n          <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classNames</span><span class="token punctuation">(</span>styles<span class="token punctuation">.</span>player<span class="token punctuation">,</span> visibleComponent <span class="token operator">!==</span> <span class="token string">\'JsmpegPlayer\'</span> <span class="token operator">?</span> styles<span class="token punctuation">.</span>hidden <span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n        <span class="token punctuation">/></span></span>\n      <span class="token punctuation">}</span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ModelLearnMore</span></span>\n        <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">PC</span> <span class="token operator">&amp;&amp;</span> visibleComponent <span class="token operator">!==</span> <span class="token string">\'ModelLearnMore\'</span> <span class="token operator">?</span> styles<span class="token punctuation">.</span>hidden <span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token punctuation">}</span></span>\n        <span class="token attr-name">progress</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">PC</span> <span class="token operator">?</span> modelLearnMoreProgress <span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">}</span></span>\n        <span class="token attr-name">modelCenterTextProps</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n          topSubTitle<span class="token punctuation">:</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'topSubTitle\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n          title<span class="token punctuation">:</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'title\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n          subTitle<span class="token punctuation">:</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'subTitle\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n          shortDesc<span class="token punctuation">:</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'shortDesc\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n          buttonText<span class="token punctuation">:</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'button\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n          animation<span class="token punctuation">:</span> state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">H5</span>\n        <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n        <span class="token attr-name">onSetVisibleComponent</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>setVisibleComponent<span class="token punctuation">}</span></span>\n        <span class="token attr-name">displayersProps</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>\n          <span class="token punctuation">{</span>\n            src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/learn-more/p7-p2-1.jpg\'</span><span class="token punctuation">,</span>\n            srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/learn-more/p7-p2-1@2x.jpg\'</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          <span class="token punctuation">{</span>\n            src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/learn-more/p7-p2-2.jpg\'</span><span class="token punctuation">,</span>\n            srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/learn-more/p7-p2-2@2x.jpg\'</span><span class="token punctuation">,</span>\n            minSrcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/learn-more/p7-p2-2@mini.jpg\'</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          miniVideoProps\n        <span class="token punctuation">]</span><span class="token punctuation">}</span></span>\n        <span class="token attr-name">itemList</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>\n          <span class="token punctuation">{</span>\n            imgList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-1-3.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-1-3@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-1-1.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-1-1@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-1-2.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-1-2@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            background<span class="token punctuation">:</span> <span class="token string">\'linear-gradient(133deg, #343538 0%, #000102 100%)\'</span><span class="token punctuation">,</span>\n            textData<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              topSubTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.topSubTitle1\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              title<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.title1\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              subTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.subTitle1\'</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          <span class="token punctuation">{</span>\n            imgList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-2-3.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-2-3@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-2-1.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-2-1@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-2-2.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-2-2@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            background<span class="token punctuation">:</span> <span class="token string">\'linear-gradient(133deg, #B6CBDA 0%, #7A97AF 100%)\'</span><span class="token punctuation">,</span>\n            textData<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              topSubTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.topSubTitle2\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              title<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.title2\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              subTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.subTitle2\'</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          <span class="token punctuation">{</span>\n            imgList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-3-1.mp4\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-3-2.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p7/d1/P7-d1-3-2@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            background<span class="token punctuation">:</span> <span class="token string">\'linear-gradient(133deg, #343538 0%, #000102 100%)\'</span><span class="token punctuation">,</span>\n            textData<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              topSubTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.topSubTitle3\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              title<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.title3\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              subTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p7.d1.subTitle3\'</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">]</span><span class="token punctuation">}</span></span>\n      <span class="token punctuation">/></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n  )\n}\n\nexport default Index</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>web/pages/p7/components/modelLearnMore/index.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73413563154175480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { useEffect, useState, Dispatch, SetStateAction, useRef } from \'react\'\nimport classNames from \'classnames\'\nimport { Tween, PlayState, Timeline } from \'react-gsap\'\nimport { useSize } from \'ahooks\'\n\nimport { l, ImgProps, VideoProps } from \'@/components/lazyLoader\'\nimport XButton from \'@/components/xButton\'\nimport ModelCenterText, { ModelCenterTextProps } from \'@/components/modelCenterText\'\nimport AnimationBg from \'@/components/animationBg\'\n\nimport useTmpComponent, { ImgAndTextSwiperProps } from \'@/hooks/useTmpComponent\'\n\nimport { evaluateCalc, getDocument } from \'@/utils\'\n\nimport { VisibleComponent } from \'../../components/learnMore\'\n\nimport styles from \'./index.module.less\'\n\ntype Repeat<T, C extends number, U extends any[] = []> =\n  U[\'length\'] extends C ? U : Repeat<T, C, [...U, T]>\n\ntype DisplayerProps = ((ImgProps & { type?: \'img\'}) | (VideoProps & { type?: \'video\' })) & {\n  isNeedScale?: boolean\n}\n\ninterface ModelLearnMoreProps {\n  modelCenterTextProps: ModelCenterTextProps\n  displayersProps: Repeat<DisplayerProps, 3>\n  progress?: number\n  className?: string\n  onSetVisibleComponent?: Dispatch<SetStateAction<VisibleComponent>>\n}\n\nconst ModelLearnMore = ({\n  modelCenterTextProps,\n  displayersProps,\n  itemList = [],\n  progress = 0,\n  className,\n  onSetVisibleComponent\n}: ModelLearnMoreProps & ImgAndTextSwiperProps) => {\n  const { api, Slot } = useTmpComponent()\n\n  const getFromProps = () => {\n    const startBottom = \'calc((100vh - var(--top-menu-height) - 35.72916667rem) / 2 / 2)\'\n    const startRight = \'calc((100vw - 71.875rem - 0.520833rem) / 2 / 2)\'\n\n    return {\n      // 满屏高度减去顶部菜单减去外部容器高度，然后除以 2，得到下边距高度，最后还要由于外层放大，还要除以 2\n      // bottom: \'calc(0px - (100vh - var(--top-menu-height) - 35.72916667rem) / 2 / 2)\',\n      // right: \'calc(0px - (100vw - 71.875rem) / 2 / 2)\',\n      bottom: \\`-\\${evaluateCalc(startBottom)}px\\`,\n      right: \\`-\\${evaluateCalc(startRight)}px\\`,\n      width: \'calc(100vw - 0.520833rem)\',\n      height: \'100vh\',\n      scale: 0.5\n    }\n  }\n\n  const tweenRef = useRef(null)\n  const size = useSize(getDocument()?.documentElement)\n  useEffect(() => {\n    if (!tweenRef.current) {\n      return\n    }\n\n    tweenRef.current.getGSAP().vars = {\n      ...tweenRef.current.getGSAP().vars,\n      startAt: getFromProps()\n    }\n  }, [size])\n\n  const timerRef = useRef<NodeJS.Timeout>()\n  // 触发型动画，需要延迟控制组件的可见性，否则动画播放不全\n  useEffect(() => {\n    if (progress >= 0) {\n      onSetVisibleComponent && onSetVisibleComponent(\'ModelLearnMore\')\n    } else {\n      timerRef.current = setTimeout(() => {\n        onSetVisibleComponent && onSetVisibleComponent(\'JsmpegPlayer\')\n      }, 800)\n    }\n    return () => {\n      timerRef.current && clearTimeout(timerRef.current)\n    }\n  }, [progress])\n\n  const { buttonText, ...rest } = modelCenterTextProps\n  return (\n    <AnimationBg type={1} className={className}>\n      <Slot\n        itemList={itemList}\n        pageType = \'P7Wing\'\n        modelType=\'P7\'\n        buttonType=\'LearnMore\'\n      />\n      <div ref={ref} className={classNames(\'full-page-with-top-menu\', styles.container)}>\n        <Tween\n          from={{\n            scale: 2\n          }}\n          duration={0.8}\n          playState={progress > 0 ? PlayState.play : PlayState.reverse}\n        >\n          <div className={classNames(\'body\', styles.body)}>\n            <ModelCenterText\n              className={styles.titleContainer}\n              {...rest}\n            />\n            <div className={styles.displayerContainer}>\n              {\n                displayersProps.map((item, index) => {\n                  const {\n                    type = \'img\',\n                    isNeedScale,\n                    ...rest\n                  } = item\n                  const Component = l[type]\n                  if (isNeedScale) {\n                    return (\n                      <Timeline\n                        playState={progress > 0 ? PlayState.play : PlayState.reverse}\n                        target={\n                          <>\n                            <div className={styles[\\`displayerContainer\\${index + 1}\\`]}>\n                              <Component\n                                className={styles.displayer}\n                                {...rest}\n                              />\n                            </div>\n                          </>\n                        }\n                      >\n                        <Tween\n                          ref={tweenRef}\n                          from={getFromProps()}\n                          to={{\n                            width: \'23.65rem\',\n                            height: \'13.33rem\',\n                            bottom: 0,\n                            right: 0,\n                            scale: 1\n                          }}\n                          target={0}\n                        />\n                      </Timeline>\n                    )\n                  }\n                  return (<div className={styles[\\`displayerContainer\\${index + 1}\\`]}>\n                    <Component\n                      className={styles.displayer}\n                      {...rest}\n                    />\n                  </div>)\n                })\n              }\n            </div>\n            <XButton\n              type=&quot;primary&quot;\n              className={styles.button}\n              onClick={() => {\n                api.current?.open()\n              }\n              }\n            >\n              {buttonText}\n            </XButton>\n          </div>\n        </Tween>\n      </div>\n    </AnimationBg>\n  )\n}\n\nexport default ModelLearnMore`, `73413563154175480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useState<span class="token punctuation">,</span> Dispatch<span class="token punctuation">,</span> SetStateAction<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span>\n<span class="token keyword">import</span> classNames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> Tween<span class="token punctuation">,</span> PlayState<span class="token punctuation">,</span> Timeline <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-gsap\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useSize <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> l<span class="token punctuation">,</span> ImgProps<span class="token punctuation">,</span> VideoProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/lazyLoader\'</span>\n<span class="token keyword">import</span> XButton <span class="token keyword">from</span> <span class="token string">\'@/components/xButton\'</span>\n<span class="token keyword">import</span> ModelCenterText<span class="token punctuation">,</span> <span class="token punctuation">{</span> ModelCenterTextProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/modelCenterText\'</span>\n<span class="token keyword">import</span> AnimationBg <span class="token keyword">from</span> <span class="token string">\'@/components/animationBg\'</span>\n\n<span class="token keyword">import</span> useTmpComponent<span class="token punctuation">,</span> <span class="token punctuation">{</span> ImgAndTextSwiperProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/hooks/useTmpComponent\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> evaluateCalc<span class="token punctuation">,</span> getDocument <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> VisibleComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'../../components/learnMore\'</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span>\n\n<span class="token keyword">type</span> Repeat<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token constant">C</span> <span class="token keyword">extends</span> <span class="token class-name">number</span><span class="token punctuation">,</span> <span class="token constant">U</span> <span class="token keyword">extends</span> <span class="token class-name">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token operator">=</span>\n  <span class="token constant">U</span><span class="token punctuation">[</span><span class="token string">\'length\'</span><span class="token punctuation">]</span> <span class="token keyword">extends</span> <span class="token class-name">C</span> <span class="token operator">?</span> <span class="token constant">U</span> <span class="token punctuation">:</span> Repeat<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token constant">U</span><span class="token punctuation">,</span> <span class="token constant">T</span><span class="token punctuation">]</span><span class="token operator">></span>\n\n<span class="token keyword">type</span> DisplayerProps <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ImgProps <span class="token operator">&amp;</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">\'img\'</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>VideoProps <span class="token operator">&amp;</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">\'video\'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">{</span>\n  isNeedScale<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">ModelLearnMoreProps</span> <span class="token punctuation">{</span>\n  modelCenterTextProps<span class="token punctuation">:</span> ModelCenterTextProps\n  displayersProps<span class="token punctuation">:</span> Repeat<span class="token operator">&lt;</span>DisplayerProps<span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">></span>\n  progress<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span>\n  className<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span>\n  onSetVisibleComponent<span class="token operator">?</span><span class="token punctuation">:</span> Dispatch<span class="token operator">&lt;</span>SetStateAction<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">VisibleComponent</span></span><span class="token punctuation">></span></span><span class="token plain-text">>\n}\n\nconst ModelLearnMore = ({\n  modelCenterTextProps,\n  displayersProps,\n  itemList = [],\n  progress = 0,\n  className,\n  onSetVisibleComponent\n}: ModelLearnMoreProps &amp; ImgAndTextSwiperProps) => </span><span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> api<span class="token punctuation">,</span> Slot <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTmpComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token function-variable function">getFromProps</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> startBottom <span class="token operator">=</span> <span class="token string">\'calc((100vh - var(--top-menu-height) - 35.72916667rem) / 2 / 2)\'</span>\n    <span class="token keyword">const</span> startRight <span class="token operator">=</span> <span class="token string">\'calc((100vw - 71.875rem - 0.520833rem) / 2 / 2)\'</span>\n\n    <span class="token keyword">return</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 满屏高度减去顶部菜单减去外部容器高度，然后除以 2，得到下边距高度，最后还要由于外层放大，还要除以 2</span>\n      <span class="token comment">// bottom: \'calc(0px - (100vh - var(--top-menu-height) - 35.72916667rem) / 2 / 2)\',</span>\n      <span class="token comment">// right: \'calc(0px - (100vw - 71.875rem) / 2 / 2)\',</span>\n      bottom<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">evaluateCalc</span><span class="token punctuation">(</span>startBottom<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n      right<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">evaluateCalc</span><span class="token punctuation">(</span>startRight<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n      width<span class="token punctuation">:</span> <span class="token string">\'calc(100vw - 0.520833rem)\'</span><span class="token punctuation">,</span>\n      height<span class="token punctuation">:</span> <span class="token string">\'100vh\'</span><span class="token punctuation">,</span>\n      scale<span class="token punctuation">:</span> <span class="token number">0.5</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> tweenRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> size <span class="token operator">=</span> <span class="token function">useSize</span><span class="token punctuation">(</span><span class="token function">getDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>documentElement<span class="token punctuation">)</span>\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tweenRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n\n    tweenRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">getGSAP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>vars <span class="token operator">=</span> <span class="token punctuation">{</span>\n      <span class="token operator">...</span>tweenRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">getGSAP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>vars<span class="token punctuation">,</span>\n      startAt<span class="token punctuation">:</span> <span class="token function">getFromProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> timerRef <span class="token operator">=</span> useRef<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">NodeJS.Timeout</span></span><span class="token punctuation">></span></span><span class="token plain-text">()\n  // 触发型动画，需要延迟控制组件的可见性，否则动画播放不全\n  useEffect(() => </span><span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>progress <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      onSetVisibleComponent <span class="token operator">&amp;&amp;</span> <span class="token function">onSetVisibleComponent</span><span class="token punctuation">(</span><span class="token string">\'ModelLearnMore\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      timerRef<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        onSetVisibleComponent <span class="token operator">&amp;&amp;</span> <span class="token function">onSetVisibleComponent</span><span class="token punctuation">(</span><span class="token string">\'JsmpegPlayer\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      timerRef<span class="token punctuation">.</span>current <span class="token operator">&amp;&amp;</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timerRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token plain-text">, [progress])\n\n  const </span><span class="token punctuation">{</span> buttonText<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span><span class="token plain-text"> = modelCenterTextProps\n  return (\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AnimationBg</span></span> <span class="token attr-name">type</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>className<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      &lt;Slot\n        itemList=</span><span class="token punctuation">{</span>itemList<span class="token punctuation">}</span><span class="token plain-text">\n        pageType = \'P7Wing\'\n        modelType=\'P7\'\n        buttonType=\'LearnMore\'\n      />\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classNames</span><span class="token punctuation">(</span><span class="token string">\'full-page-with-top-menu\'</span><span class="token punctuation">,</span> styles<span class="token punctuation">.</span>container<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Tween</span></span>\n          <span class="token attr-name">from</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n            scale<span class="token punctuation">:</span> <span class="token number">2</span>\n          <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">duration</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">0.8</span><span class="token punctuation">}</span></span>\n          <span class="token attr-name">playState</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>progress <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> PlayState<span class="token punctuation">.</span>play <span class="token punctuation">:</span> PlayState<span class="token punctuation">.</span>reverse<span class="token punctuation">}</span></span>\n        <span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classNames</span><span class="token punctuation">(</span><span class="token string">\'body\'</span><span class="token punctuation">,</span> styles<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ModelCenterText</span></span>\n              <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>titleContainer<span class="token punctuation">}</span></span>\n              <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">rest</span><span class="token punctuation">}</span></span>\n            <span class="token punctuation">/></span></span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>displayerContainer<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n              </span><span class="token punctuation">{</span>\n                displayersProps<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                  <span class="token keyword">const</span> <span class="token punctuation">{</span>\n                    <span class="token keyword">type</span> <span class="token operator">=</span> <span class="token string">\'img\'</span><span class="token punctuation">,</span>\n                    isNeedScale<span class="token punctuation">,</span>\n                    <span class="token operator">...</span>rest\n                  <span class="token punctuation">}</span> <span class="token operator">=</span> item\n                  <span class="token keyword">const</span> Component <span class="token operator">=</span> l<span class="token punctuation">[</span><span class="token keyword">type</span><span class="token punctuation">]</span>\n                  <span class="token keyword">if</span> <span class="token punctuation">(</span>isNeedScale<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    <span class="token keyword">return</span> <span class="token punctuation">(</span>\n                      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Timeline</span></span>\n                        <span class="token attr-name">playState</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>progress <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> PlayState<span class="token punctuation">.</span>play <span class="token punctuation">:</span> PlayState<span class="token punctuation">.</span>reverse<span class="token punctuation">}</span></span>\n                        <span class="token attr-name">target</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>\n                          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n                            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">displayerContainer</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n                              </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Component</span></span>\n                                <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>displayer<span class="token punctuation">}</span></span>\n                                <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">rest</span><span class="token punctuation">}</span></span>\n                              <span class="token punctuation">/></span></span><span class="token plain-text">\n                            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n                          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>\n                        <span class="token punctuation">}</span></span>\n                      <span class="token punctuation">></span></span><span class="token plain-text">\n                        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Tween</span></span>\n                          <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>tweenRef<span class="token punctuation">}</span></span>\n                          <span class="token attr-name">from</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getFromProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n                          <span class="token attr-name">to</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n                            width<span class="token punctuation">:</span> <span class="token string">\'23.65rem\'</span><span class="token punctuation">,</span>\n                            height<span class="token punctuation">:</span> <span class="token string">\'13.33rem\'</span><span class="token punctuation">,</span>\n                            bottom<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n                            right<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n                            scale<span class="token punctuation">:</span> <span class="token number">1</span>\n                          <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n                          <span class="token attr-name">target</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span></span>\n                        <span class="token punctuation">/></span></span><span class="token plain-text">\n                      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Timeline</span></span><span class="token punctuation">></span></span>\n                    <span class="token punctuation">)</span>\n                  <span class="token punctuation">}</span>\n                  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">displayerContainer</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n                    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Component</span></span>\n                      <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>displayer<span class="token punctuation">}</span></span>\n                      <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">rest</span><span class="token punctuation">}</span></span>\n                    <span class="token punctuation">/></span></span><span class="token plain-text">\n                  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">)</span>\n                <span class="token punctuation">}</span><span class="token punctuation">)</span>\n              <span class="token punctuation">}</span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XButton</span></span>\n              <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>primary<span class="token punctuation">"</span></span>\n              <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>button<span class="token punctuation">}</span></span>\n              <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                api<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n              <span class="token punctuation">}</span>\n              <span class="token punctuation">}</span></span>\n            <span class="token punctuation">></span></span><span class="token plain-text">\n              </span><span class="token punctuation">{</span>buttonText<span class="token punctuation">}</span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">XButton</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Tween</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">AnimationBg</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n  )\n}\n\nexport default ModelLearnMore</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="优化"><a href="#%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化</h3>\n<h4 id="计算-calc-的实际-px-值"><a href="#%E8%AE%A1%E7%AE%97-calc-%E7%9A%84%E5%AE%9E%E9%99%85-px-%E5%80%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>计算 calc 的实际 px 值</h4>\n<p>web/utils/index.ts</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95890834291499530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 只支持计算值为正值\nexport const evaluateCalc = (expression: string, container = getDocument()?.body) => {\n  // 不能加以下代码，影响动效\n  // if (!container || !Object.keys(container).length) {\n  //   return 0\n  // }\n  if (!__isBrowser__) {\n    return 0\n  }\n  const el = document.createElement(\'div\')\n  el.style.position = \'absolute\'\n  el.style.visibility = \'hidden\'\n  el.innerHTML = \\`<div style=&quot;width: \\${expression}&quot;></div>\\`\n  container.insertBefore(el, container.firstChild)\n  const calcPx = el.clientWidth\n  container.removeChild(el)\n  return calcPx\n}`, `95890834291499530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token comment">// 只支持计算值为正值</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">evaluateCalc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">expression<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> container <span class="token operator">=</span> <span class="token function">getDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>body</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 不能加以下代码，影响动效</span>\n  <span class="token comment">// if (!container || !Object.keys(container).length) {</span>\n  <span class="token comment">//   return 0</span>\n  <span class="token comment">// }</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>__isBrowser__<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token number">0</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">const</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'div\'</span><span class="token punctuation">)</span>\n  el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token string">\'absolute\'</span>\n  el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>visibility <span class="token operator">=</span> <span class="token string">\'hidden\'</span>\n  el<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div style="width: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>expression<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">">&lt;/div></span><span class="token template-punctuation string">`</span></span>\n  container<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> container<span class="token punctuation">.</span>firstChild<span class="token punctuation">)</span>\n  <span class="token keyword">const</span> calcPx <span class="token operator">=</span> el<span class="token punctuation">.</span>clientWidth\n  container<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>\n  <span class="token keyword">return</span> calcPx\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="p7-resize-后动画定位不准的-bug"><a href="#p7-resize-%E5%90%8E%E5%8A%A8%E7%94%BB%E5%AE%9A%E4%BD%8D%E4%B8%8D%E5%87%86%E7%9A%84-bug" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>p7 resize 后动画定位不准的 bug</h4>\n<p>需要全部使用 rem 单位，否则 resize 后定位不准</p>\n<h3 id="运行效果-3"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<!-- <iframe data-src="https://codesandbox.io/embed/2h37rw?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/66xh38?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="序列帧滚动控制"><a href="#%E5%BA%8F%E5%88%97%E5%B8%A7%E6%BB%9A%E5%8A%A8%E6%8E%A7%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>序列帧滚动控制</h2>\n<h3 id="需求背景-5"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>实现如下所示动效，随着鼠标滚轮滚动播放视频或图片</p>\n<p><html><head></head><body><video data-src="/examples/international-official-website-technical-difficulties/video-frame-scroll-control.mp4" loop="" muted="" autoplay="" width="100%" class="lazy"></video></body></html></video></p>\n<h3 id="选型过程-4"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h3>\n<h4 id="视频方向"><a href="#%E8%A7%86%E9%A2%91%E6%96%B9%E5%90%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>视频方向</h4>\n<ol>\n<li>\n<p>video + av01、vp9、h264 编码的 mp4 视频（av01、vp9、h264 编码一一尝试，随着文件体积的增加，解码性能逐渐增加，但以 UI 给的视频素材测试 h264 在某些电脑比如苹果电脑上还是卡顿；在此过程中一旦使用 ffmpeg 压缩 UI 给的视频素材会导致卡顿，暂时未知是解码性能的原因还是使用了 currentTime 无法跳转到指定帧，只能跳转到关键帧，而关键帧之间并不是连续的流畅画面，fps 不平均的原因）</p>\n</li>\n<li>\n<p>ogv.js + vp9 编码的 webm 视频（解码速度较慢导致卡顿、随机跳转会报错且视频会卡住）</p>\n</li>\n<li>\n<p>提前将 video 的每一帧预渲染，可能效率较低，导致浏览器卡住，相关库：<a href="https://github.com/rnicholus/frame-grab.js" target="_blank" rel="nofollow noreferrer noopener">frame-grab</a>、<a href="https://github.com/wch1n/video-frame-previewer" target="_blank" rel="nofollow noreferrer noopener">video-frame-previewer</a>、<a href="https://github.com/feross/capture-frame" target="_blank" rel="nofollow noreferrer noopener">capture-frame</a></p>\n</li>\n<li>\n<p>jsmpeg + mpeg1 编码的 mpeg 视频（最新版本得不到总帧数、无法实现帧寻址、采用 ts 流导致不能立马跳转成功、实际使用 currentTime 无法跳成功等等缺点，故使用 v0.2 实现。缺点：同等画质下体积较大；颜色范围有限制 16~235，即不能纯白纯黑。优点：解码速度满足要求）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5539467434266587000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# ts 压缩\nffmpeg -i demo.mp4 -f mpegts -codec:v mpeg1video -b:v 1024k -bf 0 -r 20 -an demo@1024.ts\n\nffmpeg -i demo.mp4 -f mpeg1video -codec:v mpeg1video -b:v 1200k -bf 0 -r 20 -an demo.mpeg\n\n# mpeg 压缩\nffmpeg -i demo.mp4 -f mpeg1video -codec:v mpeg1video -b:v 2048k -bf 0 -r 30 -an demo@2048.mpeg\n\nffmpeg -i demo.mp4 -f mpeg1video -codec:v mpeg1video -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 30 -an demo@2048.mpeg\n\n# mp4 压缩\nffmpeg -i p7-p3-1.mp4 -b:v 2048k -bf 0 -r 25 -an p7-p3-1@2048.mp4\n\nffmpeg -i p7-p3-1.mp4 -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -an p7-p3-1@2048.mp4\n\nffmpeg -i p7-p3-1.mp4 -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -an -movflags faststart p7-p3-1@2048.mp4\n\n# 批量压缩\n#!/bin/bash\nfor i in *.mp4\ndo\n  echo &quot;File \\$i selected&quot;\n  # ffmpeg -i &quot;\\$i&quot; &quot;\\$i.mp3&quot;\n  ffmpeg -i &quot;\\$i&quot; -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -an -movflags faststart &quot;\\$i.mp4&quot;\ndone`, `5539467434266587000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># ts 压缩</span>\nffmpeg -i demo.mp4 -f mpegts -codec:v mpeg1video -b:v 1024k -bf <span class="token number">0</span> -r <span class="token number">20</span> -an demo@1024.ts\n\nffmpeg -i demo.mp4 -f mpeg1video -codec:v mpeg1video -b:v 1200k -bf <span class="token number">0</span> -r <span class="token number">20</span> -an demo.mpeg\n\n<span class="token comment"># mpeg 压缩</span>\nffmpeg -i demo.mp4 -f mpeg1video -codec:v mpeg1video -b:v 2048k -bf <span class="token number">0</span> -r <span class="token number">30</span> -an demo@2048.mpeg\n\nffmpeg -i demo.mp4 -f mpeg1video -codec:v mpeg1video -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r <span class="token number">30</span> -an demo@2048.mpeg\n\n<span class="token comment"># mp4 压缩</span>\nffmpeg -i p7-p3-1.mp4 -b:v 2048k -bf <span class="token number">0</span> -r <span class="token number">25</span> -an p7-p3-1@2048.mp4\n\nffmpeg -i p7-p3-1.mp4 -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r <span class="token number">25</span> -an p7-p3-1@2048.mp4\n\nffmpeg -i p7-p3-1.mp4 -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r <span class="token number">25</span> -an -movflags faststart p7-p3-1@2048.mp4\n\n<span class="token comment"># 批量压缩</span>\n<span class="token comment">#!/bin/bash</span>\n<span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> *.mp4\n<span class="token keyword">do</span>\n  <span class="token builtin class-name">echo</span> <span class="token string">"File <span class="token variable">$i</span> selected"</span>\n  <span class="token comment"># ffmpeg -i "$i" "$i.mp3"</span>\n  ffmpeg -i <span class="token string">"<span class="token variable">$i</span>"</span> -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r <span class="token number">25</span> -an -movflags faststart <span class="token string">"<span class="token variable">$i</span>.mp4"</span>\n<span class="token keyword">done</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<h4 id="图片方向"><a href="#%E5%9B%BE%E7%89%87%E6%96%B9%E5%90%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>图片方向</h4>\n<ol>\n<li>预加载所有图片 + 图片序列帧（参考张博客，体积较大）</li>\n<li>pixi-apngAndGif，使用 apng 控制播放进度（体积太大）</li>\n<li>针对方案 1，使用 avif + avif.js，暂时未知解码性能如何，猜测同样都是 av1 解码，可能解码性能不行；</li>\n<li>针对方案 1，使用 webp，解码性能同样可能不行</li>\n<li>针对方案 1，使用 jpg</li>\n</ol>\n<h3 id="核心代码-4"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<h4 id="pixi-apngandgif"><a href="#pixi-apngandgif" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pixi-apngAndGif</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68033712090898964000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { useEffect, useRef, useState } from \'react\'\nimport { InputNumber } from \'antd\'\n\nimport XButton from \'@/components/xButton\'\n\nconst Index = () => {\n  const domRef = useRef(null)\n  const [apngApi, setApngApi] = useState()\n  const [value, setValue] = useState(0)\n\n  useEffect(() => {\n    import(\'@/lib/pixi-apng\').then((pixiApng) => {\n      const PixiApng = pixiApng.default\n      const { PIXI } = pixiApng\n      const app = new PIXI.Application({\n        width: domRef.current?.width,\n        height: domRef.current?.height,\n        view: domRef.current,\n        transparent: true,\n        antialias: true\n      })\n      const loader = PIXI.Loader.shared\n      const loadOption = {\n        loadType: PIXI.LoaderResource.LOAD_TYPE.XHR,\n        xhrType: PIXI.LoaderResource.XHR_RESPONSE_TYPE.BUFFER,\n        crossOrigin: \'\'\n      }\n      const imgs = {\n        apng: \'/public/demo/demo.png\'\n      }\n      loader.add(imgs.apng, loadOption)\n\n      loader.load((progress, resources) => {\n        const apngApi = new PixiApng(imgs.apng, resources)\n        setApngApi(apngApi)\n        const apngSprite = apngApi.sprite\n\n        apngSprite.x = 0\n        apngSprite.y = 0\n\n        apngSprite.width = 1000\n        apngSprite.height = 500\n\n        app.stage.addChild(apngSprite)\n      })\n    })\n  }, [])\n\n  return (\n    <div style={{ marginTop: 100, width: 1920, height: 1080 }}>\n      <XButton onClick={() => {\n        apngApi.play()\n      }}>\n        开始\n      </XButton>\n      <XButton onClick={() => {\n        apngApi.pause()\n      }}>\n        停止\n      </XButton>\n      <XButton onClick={() => {\n        apngApi.stop()\n      }}>\n        终止\n      </XButton>\n      <InputNumber value={value} onChange={setValue} precision={0} />\n      <XButton onClick={() => {\n        apngApi.jumpToFrame(value)\n      }}>\n        停到第几帧\n      </XButton>\n      <XButton onClick={() => {\n        window.alert(apngApi.getDuration())\n      }}>\n        时长\n      </XButton>\n      <XButton onClick={() => {\n        window.alert(apngApi.getFramesLength())\n      }}>\n        帧数\n      </XButton>\n      <canvas ref={domRef} width=&quot;1920&quot; height=&quot;1080&quot;></canvas>\n    </div>\n  )\n}\n\nexport default Index`, `68033712090898964000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> InputNumber <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'antd\'</span>\n\n<span class="token keyword">import</span> XButton <span class="token keyword">from</span> <span class="token string">\'@/components/xButton\'</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">Index</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> domRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>apngApi<span class="token punctuation">,</span> setApngApi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>value<span class="token punctuation">,</span> setValue<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">\'@/lib/pixi-apng\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pixiApng</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> PixiApng <span class="token operator">=</span> pixiApng<span class="token punctuation">.</span><span class="token keyword">default</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">PIXI</span> <span class="token punctuation">}</span> <span class="token operator">=</span> pixiApng\n      <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PIXI<span class="token punctuation">.</span>Application</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n        width<span class="token punctuation">:</span> domRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span>width<span class="token punctuation">,</span>\n        height<span class="token punctuation">:</span> domRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span>height<span class="token punctuation">,</span>\n        view<span class="token punctuation">:</span> domRef<span class="token punctuation">.</span>current<span class="token punctuation">,</span>\n        transparent<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n        antialias<span class="token punctuation">:</span> <span class="token boolean">true</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token keyword">const</span> loader <span class="token operator">=</span> <span class="token constant">PIXI</span><span class="token punctuation">.</span>Loader<span class="token punctuation">.</span>shared\n      <span class="token keyword">const</span> loadOption <span class="token operator">=</span> <span class="token punctuation">{</span>\n        loadType<span class="token punctuation">:</span> <span class="token constant">PIXI</span><span class="token punctuation">.</span>LoaderResource<span class="token punctuation">.</span><span class="token constant">LOAD_TYPE</span><span class="token punctuation">.</span><span class="token constant">XHR</span><span class="token punctuation">,</span>\n        xhrType<span class="token punctuation">:</span> <span class="token constant">PIXI</span><span class="token punctuation">.</span>LoaderResource<span class="token punctuation">.</span><span class="token constant">XHR_RESPONSE_TYPE</span><span class="token punctuation">.</span><span class="token constant">BUFFER</span><span class="token punctuation">,</span>\n        crossOrigin<span class="token punctuation">:</span> <span class="token string">\'\'</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">const</span> imgs <span class="token operator">=</span> <span class="token punctuation">{</span>\n        apng<span class="token punctuation">:</span> <span class="token string">\'/public/demo/demo.png\'</span>\n      <span class="token punctuation">}</span>\n      loader<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>imgs<span class="token punctuation">.</span>apng<span class="token punctuation">,</span> loadOption<span class="token punctuation">)</span>\n\n      loader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">progress<span class="token punctuation">,</span> resources</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> apngApi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PixiApng</span><span class="token punctuation">(</span>imgs<span class="token punctuation">.</span>apng<span class="token punctuation">,</span> resources<span class="token punctuation">)</span>\n        <span class="token function">setApngApi</span><span class="token punctuation">(</span>apngApi<span class="token punctuation">)</span>\n        <span class="token keyword">const</span> apngSprite <span class="token operator">=</span> apngApi<span class="token punctuation">.</span>sprite\n\n        apngSprite<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">0</span>\n        apngSprite<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">0</span>\n\n        apngSprite<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token number">1000</span>\n        apngSprite<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token number">500</span>\n\n        app<span class="token punctuation">.</span>stage<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>apngSprite<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> marginTop<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span> width<span class="token punctuation">:</span> <span class="token number">1920</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token number">1080</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XButton</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        apngApi<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        开始\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">XButton</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XButton</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        apngApi<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        停止\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">XButton</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XButton</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        apngApi<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        终止\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">XButton</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">InputNumber</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>value<span class="token punctuation">}</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>setValue<span class="token punctuation">}</span></span> <span class="token attr-name">precision</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XButton</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        apngApi<span class="token punctuation">.</span><span class="token function">jumpToFrame</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        停到第几帧\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">XButton</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XButton</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        window<span class="token punctuation">.</span><span class="token function">alert</span><span class="token punctuation">(</span>apngApi<span class="token punctuation">.</span><span class="token function">getDuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        时长\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">XButton</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">XButton</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        window<span class="token punctuation">.</span><span class="token function">alert</span><span class="token punctuation">(</span>apngApi<span class="token punctuation">.</span><span class="token function">getFramesLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n        帧数\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">XButton</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>domRef<span class="token punctuation">}</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1920<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1080<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n  <span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> Index</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="ogvjs"><a href="#ogvjs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ogv.js</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33550432816205156000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { useRef, useEffect, useState } from \'react\';\nimport classNames from \'classnames\';\nimport { useInViewport, useAsyncEffect } from \'ahooks\';\n\nimport { loadScript } from \'@/utils\';\n\nimport styles from \'./index.module.less\';\n\ninterface JsmpegPlayerProps {\n   src: string;\n   progress?: number; // 播放进度，0~1\n   className?: string;\n   autoplay?: boolean;\n   loop?: boolean;\n   seekable?: boolean;\n   preserveDrawingBuffer?: boolean;\n}\n\n// https://github.com/phoboslab/jsmpeg/tree/v0.2\nconst JsmpegPlayer = ({ src, progress, className, ...rest }: JsmpegPlayerProps) => {\n   const [isLoad, setIsLoad] = useState(true);\n   const [isLoadJsmpeg, setIsLoadJsmpeg] = useState(true);\n   const playerRef = useRef();\n   const domRef = useRef(null);\n\n   useAsyncEffect(async () => {\n      await loadScript(\'/public/lib/ogvjs-1.8.6/ogv.js\');\n      setIsLoadJsmpeg(false);\n   }, []);\n\n   const [inViewPort] = useInViewport(domRef);\n   useEffect(() => {\n      if (!inViewPort || isLoadJsmpeg || !isLoad) {\n         return;\n      }\n      // eslint-disable-next-line new-cap\n      playerRef.current = new window.OGVPlayer({\n         wasm: true, // force,\n         simd: true // experimental\n         // threading: true\n      });\n      domRef.current.appendChild(playerRef.current);\n      playerRef.current.muted = true;\n      playerRef.current.src = src;\n      playerRef.current.addEventListener(\'loadedmetadata\', () => {\n         setIsLoad(false);\n      });\n   }, [inViewPort, isLoadJsmpeg]);\n\n   useEffect(() => {\n      if (isLoad || typeof progress !== \'number\') {\n         return;\n      }\n      const calcProgress = progress < 0 ? 0 : progress > 1 ? 1 : progress;\n      console.log(\'calcProgress\', calcProgress);\n      playerRef.current.currentTime = calcProgress * playerRef.current.duration;\n   }, [progress, isLoad]);\n\n   return <div ref={domRef}></div>;\n};\n\nexport default JsmpegPlayer;`, `33550432816205156000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useRef<span class="token punctuation">,</span> useEffect<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> classNames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useInViewport<span class="token punctuation">,</span> useAsyncEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> loadScript <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">JsmpegPlayerProps</span> <span class="token punctuation">{</span>\n   src<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n   progress<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span> <span class="token comment">// 播放进度，0~1</span>\n   className<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n   autoplay<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>\n   loop<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>\n   seekable<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>\n   preserveDrawingBuffer<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// https://github.com/phoboslab/jsmpeg/tree/v0.2</span>\n<span class="token keyword">const</span> <span class="token function-variable function">JsmpegPlayer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> src<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> className<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span><span class="token punctuation">:</span> JsmpegPlayerProps</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>isLoad<span class="token punctuation">,</span> setIsLoad<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>isLoadJsmpeg<span class="token punctuation">,</span> setIsLoadJsmpeg<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> playerRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> domRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token function">useAsyncEffect</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">await</span> <span class="token function">loadScript</span><span class="token punctuation">(</span><span class="token string">\'/public/lib/ogvjs-1.8.6/ogv.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">setIsLoadJsmpeg</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>inViewPort<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useInViewport</span><span class="token punctuation">(</span>domRef<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inViewPort <span class="token operator">||</span> isLoadJsmpeg <span class="token operator">||</span> <span class="token operator">!</span>isLoad<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// eslint-disable-next-line new-cap</span>\n      playerRef<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">window<span class="token punctuation">.</span>OGVPlayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n         wasm<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// force,</span>\n         simd<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token comment">// experimental</span>\n         <span class="token comment">// threading: true</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      domRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>playerRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      playerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>muted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n      playerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>src <span class="token operator">=</span> src<span class="token punctuation">;</span>\n      playerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'loadedmetadata\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token function">setIsLoad</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>inViewPort<span class="token punctuation">,</span> isLoadJsmpeg<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>isLoad <span class="token operator">||</span> <span class="token keyword">typeof</span> progress <span class="token operator">!==</span> <span class="token string">\'number\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">const</span> calcProgress <span class="token operator">=</span> progress <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> progress <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> progress<span class="token punctuation">;</span>\n      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'calcProgress\'</span><span class="token punctuation">,</span> calcProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      playerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>currentTime <span class="token operator">=</span> calcProgress <span class="token operator">*</span> playerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>duration<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>progress<span class="token punctuation">,</span> isLoad<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>domRef<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> JsmpegPlayer<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="video"><a href="#video" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>video</h4>\n<p>web/components/lazyLoader/components/video/components/core/hooks/useProgressControl.ts</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4306419717620091400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useEffect, useState } from \'react\';\n\nimport { CommonProps } from \'../index\';\n\nexport interface UseProgressControlProps {\n   progress?: number;\n   playStrategy?: \'progressControl\';\n}\n\nconst useProgressControl = ({\n   progress,\n   playStrategy,\n   onSetVideoProps,\n   domRef\n}: UseProgressControlProps & CommonProps) => {\n   const [isLoad, setIsLoad] = useState(true);\n   const [duration, setDuration] = useState(0);\n\n   const handleLoadedMetadata = () => {\n      const { duration } = domRef.current;\n      setDuration(duration);\n      setIsLoad(false);\n   };\n\n   useEffect(() => {\n      if (isLoad || typeof progress !== \'number\' || playStrategy !== \'progressControl\') {\n         return;\n      }\n\n      const calcProgress = progress < 0 ? 0 : progress > 1 ? 1 : progress;\n      domRef.current.currentTime = calcProgress * duration;\n   }, [progress, isLoad]);\n\n   useEffect(() => {\n      if (playStrategy === \'progressControl\') {\n         onSetVideoProps({\n            muted: true,\n            playsInline: true,\n            preload: \'metadata\'\n         });\n      }\n   }, [playStrategy]);\n\n   return {\n      handleLoadedMetadata\n   };\n};\n\nexport default useProgressControl;`, `4306419717620091400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> CommonProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'../index\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">UseProgressControlProps</span> <span class="token punctuation">{</span>\n   progress<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n   playStrategy<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">\'progressControl\'</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">useProgressControl</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>\n   progress<span class="token punctuation">,</span>\n   playStrategy<span class="token punctuation">,</span>\n   onSetVideoProps<span class="token punctuation">,</span>\n   domRef\n<span class="token punctuation">}</span><span class="token punctuation">:</span> UseProgressControlProps <span class="token operator">&amp;</span> CommonProps</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>isLoad<span class="token punctuation">,</span> setIsLoad<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>duration<span class="token punctuation">,</span> setDuration<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> <span class="token function-variable function">handleLoadedMetadata</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span> duration <span class="token punctuation">}</span> <span class="token operator">=</span> domRef<span class="token punctuation">.</span>current<span class="token punctuation">;</span>\n      <span class="token function">setDuration</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">setIsLoad</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n   <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>isLoad <span class="token operator">||</span> <span class="token keyword">typeof</span> progress <span class="token operator">!==</span> <span class="token string">\'number\'</span> <span class="token operator">||</span> playStrategy <span class="token operator">!==</span> <span class="token string">\'progressControl\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">const</span> calcProgress <span class="token operator">=</span> progress <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> progress <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> progress<span class="token punctuation">;</span>\n      domRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>currentTime <span class="token operator">=</span> calcProgress <span class="token operator">*</span> duration<span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>progress<span class="token punctuation">,</span> isLoad<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>playStrategy <span class="token operator">===</span> <span class="token string">\'progressControl\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token function">onSetVideoProps</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            muted<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            playsInline<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            preload<span class="token punctuation">:</span> <span class="token string">\'metadata\'</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>playStrategy<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">return</span> <span class="token punctuation">{</span>\n      handleLoadedMetadata\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> useProgressControl<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="jsmpeg"><a href="#jsmpeg" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>jsmpeg</h4>\n<p>现阶段采用的技术选型</p>\n<p>web/components/jsmpegPlayer/index.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59931413920463970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { useRef, useEffect, useState } from \'react\'\nimport classNames from \'classnames\'\nimport { useInViewport, useAsyncEffect } from \'ahooks\'\n\nimport { l } from \'@/components/lazyLoader\'\n\nimport { loadScript } from \'@/utils\'\n\nimport styles from \'./index.module.less\'\n\ninterface JsmpegPlayerProps {\n  src: string\n  progress?: number // 播放进度，0~1\n  className?: string\n  poster?: string\n}\n\n// https://github.com/phoboslab/jsmpeg/tree/v0.2\nconst JsmpegPlayer = ({\n  src,\n  progress,\n  className,\n  poster,\n  ...rest\n}: JsmpegPlayerProps) => {\n  const [isLoad, setIsLoad] = useState(true)\n  const [isLoadJsmpeg, setIsLoadJsmpeg] = useState(true)\n  const playerRef = useRef()\n  const domRef = useRef(null)\n\n  useAsyncEffect(async () => {\n    await loadScript(\'/public/lib/jsmpeg.min.js\')\n    setIsLoadJsmpeg(false)\n  }, [])\n\n  const [inViewPort] = useInViewport(domRef)\n  useEffect(() => {\n    if (!inViewPort || isLoadJsmpeg || !isLoad) {\n      return\n    }\n    // eslint-disable-next-line new-cap\n    playerRef.current = new window.jsmpeg(src, {\n      ...rest,\n      canvas: domRef.current?.querySelector(\'canvas\'),\n      seekable: true,\n      onload: () => {\n        setIsLoad(false)\n        // console.log(playerRef.current?.duration, playerRef.current?.frameCount)\n      }\n    })\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [inViewPort, isLoadJsmpeg])\n\n  useEffect(() => {\n    if (isLoad || typeof progress !== \'number\') {\n      return\n    }\n    const calcProgress = progress < 0 ? 0 : progress > 1 ? 1 : progress\n    const frameCount = playerRef.current?.frameCount - 1 // 最大帧需减一\n    playerRef.current?.seekToFrame(calcProgress * frameCount, true)\n  }, [progress, isLoad])\n\n  const isShowPoster = (isLoad || isLoadJsmpeg) && poster\n  return <div\n    ref={domRef}\n    className={classNames(styles.container, className)}\n  >\n    <div className={styles.body}>\n      <canvas\n        className={styles.video}\n      />\n      {\n        isShowPoster && <l.img\n          src={poster}\n          className={styles.poster}\n        />\n      }\n    </div>\n  </div>\n}\n\nexport default JsmpegPlayer`, `59931413920463970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useRef<span class="token punctuation">,</span> useEffect<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span>\n<span class="token keyword">import</span> classNames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useInViewport<span class="token punctuation">,</span> useAsyncEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> l <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/lazyLoader\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> loadScript <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils\'</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">JsmpegPlayerProps</span> <span class="token punctuation">{</span>\n  src<span class="token punctuation">:</span> <span class="token builtin">string</span>\n  progress<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span> <span class="token comment">// 播放进度，0~1</span>\n  className<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span>\n  poster<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// https://github.com/phoboslab/jsmpeg/tree/v0.2</span>\n<span class="token keyword">const</span> <span class="token function-variable function">JsmpegPlayer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>\n  src<span class="token punctuation">,</span>\n  progress<span class="token punctuation">,</span>\n  className<span class="token punctuation">,</span>\n  poster<span class="token punctuation">,</span>\n  <span class="token operator">...</span>rest\n<span class="token punctuation">}</span><span class="token punctuation">:</span> JsmpegPlayerProps</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>isLoad<span class="token punctuation">,</span> setIsLoad<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>isLoadJsmpeg<span class="token punctuation">,</span> setIsLoadJsmpeg<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> playerRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> domRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>\n\n  <span class="token function">useAsyncEffect</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">await</span> <span class="token function">loadScript</span><span class="token punctuation">(</span><span class="token string">\'/public/lib/jsmpeg.min.js\'</span><span class="token punctuation">)</span>\n    <span class="token function">setIsLoadJsmpeg</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>inViewPort<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useInViewport</span><span class="token punctuation">(</span>domRef<span class="token punctuation">)</span>\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inViewPort <span class="token operator">||</span> isLoadJsmpeg <span class="token operator">||</span> <span class="token operator">!</span>isLoad<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// eslint-disable-next-line new-cap</span>\n    playerRef<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">window<span class="token punctuation">.</span>jsmpeg</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      <span class="token operator">...</span>rest<span class="token punctuation">,</span>\n      canvas<span class="token punctuation">:</span> domRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'canvas\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      seekable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n      <span class="token function-variable function">onload</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token function">setIsLoad</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>\n        <span class="token comment">// console.log(playerRef.current?.duration, playerRef.current?.frameCount)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>inViewPort<span class="token punctuation">,</span> isLoadJsmpeg<span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>isLoad <span class="token operator">||</span> <span class="token keyword">typeof</span> progress <span class="token operator">!==</span> <span class="token string">\'number\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">const</span> calcProgress <span class="token operator">=</span> progress <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> progress <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> progress\n    <span class="token keyword">const</span> frameCount <span class="token operator">=</span> playerRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span>frameCount <span class="token operator">-</span> <span class="token number">1</span> <span class="token comment">// 最大帧需减一</span>\n    playerRef<span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">seekToFrame</span><span class="token punctuation">(</span>calcProgress <span class="token operator">*</span> frameCount<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>progress<span class="token punctuation">,</span> isLoad<span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> isShowPoster <span class="token operator">=</span> <span class="token punctuation">(</span>isLoad <span class="token operator">||</span> isLoadJsmpeg<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> poster\n  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>\n    <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>domRef<span class="token punctuation">}</span></span>\n    <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classNames</span><span class="token punctuation">(</span>styles<span class="token punctuation">.</span>container<span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n  <span class="token punctuation">></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>body<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span>\n        <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>video<span class="token punctuation">}</span></span>\n      <span class="token punctuation">/></span></span><span class="token plain-text">\n      </span><span class="token punctuation">{</span>\n        isShowPoster <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>l.img</span>\n          <span class="token attr-name">src</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>poster<span class="token punctuation">}</span></span>\n          <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>poster<span class="token punctuation">}</span></span>\n        <span class="token punctuation">/></span></span>\n      <span class="token punctuation">}</span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> JsmpegPlayer</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>web/pages/p5/components/smartSpaceInternal/index.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10165079694593792000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React from \'react\'\nimport { useTranslation } from \'react-i18next\'\nimport classNames from \'classnames\'\n\nimport ModelCenterText from \'@/components/modelCenterText\'\nimport ModelLeftText from \'@/components/modelLeftText\'\nimport { SceneProps } from \'@/components/reactScrollMagic\'\nimport JsmpegPlayer from \'@/components/jsmpegPlayer\'\nimport { l } from \'@/components/lazyLoader\'\n\nimport useTmpComponent from \'@/hooks/useTmpComponent\'\nimport useStoreContext, { CLIENT_TYPE, DATA_ANALYSIS_TYPES } from \'@/hooks/useStoreContext\'\n\nimport { getAnimateProgresses } from \'@/utils/animate\'\n\nimport styles from \'./index.module.less\'\nimport { dataAnalysisClickTrack } from \'@/utils/dataAnalysis\'\nimport XTracker from \'@/components/xTracker\'\nimport { setDataLayer } from \'@/hooks/useSetDataLayer\'\n\nconst Index = ({\n  sceneParams\n}: SceneProps) => {\n  const {\n    progress = 0\n  } = sceneParams || {}\n  const { t } = useTranslation()\n  const trackRef = XTracker.useExposureNode({\n    type: \'P5\',\n    event: \'IntelligentSpace_Show\'\n  })\n  const getValue = (param: string) => t(\\`p5.smartSpaceInternal.\\${param}\\`)\n\n  const { api, Slot } = useTmpComponent()\n\n  const { state } = useStoreContext()\n\n  const [playerProgress] = getAnimateProgresses(progress, [\n    {\n      start: 0,\n      duration: 2 / 3\n    }\n  ])\n\n  const isShowAnimationText = playerProgress > 0.47 // 窗帘收起时文字出现\n\n  return (\n    <>\n      {\n        state?.clientType === CLIENT_TYPE.PC && <JsmpegPlayer\n          className={styles.player}\n          src=&quot;/public/p5/smart-space-internal/p5-inside.mpeg&quot;\n          poster=&quot;/public/p5/smart-space-internal/p5-inside-first-frame.jpg&quot;\n          progress={playerProgress}\n        />\n      }\n      <div\n        className={classNames(\'global-full-page-with-top-menu\', styles.container)}\n      >\n        {\n          state?.clientType === CLIENT_TYPE.H5 && <l.video\n            className={styles.player}\n            src=&quot;/public/p5/smart-space-internal/p5-inside-origin.mp4&quot;\n            srcPoster=&quot;/public/p5/smart-space-internal/p5-inside@mini.jpg&quot;\n            playIconPosition=&quot;bottom&quot;\n          />\n        }\n        <Slot\n          modelType=\'P5\'\n          pageType=\'IntelligentSpace\'\n          buttonType=\'LearnMore\'\n          itemList={[{\n            imgList: [{\n              src: \'/public/p5/d3/p5-d3-1.jpg\',\n              srcSet: \'/public/p5/d3/p5-d3-1@2x.jpg\'\n            }],\n            background: \'linear-gradient(132deg, #94A1C6 0%, #7C8DB6 100%)\',\n            textData: {\n              topSubTitle: t(\'p5.d3.topSubTitle1\'),\n              title: t(\'p5.d3.title1\'),\n              subTitle: t(\'p5.d3.subTitle1\')\n            }\n          }, {\n            imgList: [{\n              src: \'/public/p5/d3/p5-d3-2.mp4\'\n            }],\n            background: \'linear-gradient(136deg, #5F729E 0%, #3B4B76 100%)\',\n            textData: {\n              topSubTitle: t(\'p5.d3.topSubTitle2\'),\n              title: t(\'p5.d3.title2\'),\n              subTitle: t(\'p5.d3.subTitle2\')\n            }\n          }, {\n            imgList: [{\n              src: \'/public/p5/d3/p5-d3-3.jpg\',\n              srcSet: \'/public/p5/d3/p5-d3-3@2x.jpg\'\n            }],\n            background: \'linear-gradient(133deg, #B6CBDA 0%, #7A97AF 100%)\',\n            textData: {\n              topSubTitle: t(\'p5.d3.topSubTitle3\'),\n              title: t(\'p5.d3.title3\'),\n              subTitle: t(\'p5.d3.subTitle3\')\n            }\n          }]}\n        />\n        <div ref={trackRef} className={classNames(\'body\', styles.body)}>\n          {\n            isShowAnimationText && state?.clientType === CLIENT_TYPE.PC && <ModelCenterText\n              topSubTitle={getValue(\'topSubTitle\')}\n              title={getValue(\'title\')}\n              subTitle={getValue(\'subTitle\')}\n              shortDesc={getValue(\'shortDesc\')}\n              buttonText={getValue(\'button\')}\n              buttonProps={{\n                onClick: () => {\n                  dataAnalysisClickTrack(\\`\\${DATA_ANALYSIS_TYPES.P5}_IntelligentSpace_LearnMoreBtn\\`)\n                  api?.current?.open()\n                  setDataLayer({\n                    event_category: \'click_button\',\n                    car_model: \'p5\',\n                    button_group: \'learn more\',\n                    click_text: getValue(\'button\')\n                  })\n                },\n                type: \'ghost\',\n                dark: true,\n                plain: true\n              }}\n              closeIcon={null}\n            />\n          }\n          {\n            state?.clientType === CLIENT_TYPE.H5 && <ModelLeftText\n              topSubTitle={getValue(\'topSubTitle\')}\n              title={getValue(\'title\')}\n              subTitle={getValue(\'subTitle\')}\n              shortDesc={getValue(\'shortDesc\')}\n              buttonProps={{\n                onClick: () => {\n                  api?.current?.open()\n                },\n                type: \'ghost\'\n              }}\n              closeIcon={null}\n            />\n          }\n        </div>\n      </div>\n    </>\n\n  )\n}\n\nexport default Index`, `10165079694593792000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> useTranslation <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-i18next\'</span>\n<span class="token keyword">import</span> classNames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span>\n\n<span class="token keyword">import</span> ModelCenterText <span class="token keyword">from</span> <span class="token string">\'@/components/modelCenterText\'</span>\n<span class="token keyword">import</span> ModelLeftText <span class="token keyword">from</span> <span class="token string">\'@/components/modelLeftText\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> SceneProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/reactScrollMagic\'</span>\n<span class="token keyword">import</span> JsmpegPlayer <span class="token keyword">from</span> <span class="token string">\'@/components/jsmpegPlayer\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> l <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/components/lazyLoader\'</span>\n\n<span class="token keyword">import</span> useTmpComponent <span class="token keyword">from</span> <span class="token string">\'@/hooks/useTmpComponent\'</span>\n<span class="token keyword">import</span> useStoreContext<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">,</span> <span class="token constant">DATA_ANALYSIS_TYPES</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/hooks/useStoreContext\'</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> getAnimateProgresses <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils/animate\'</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> dataAnalysisClickTrack <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/utils/dataAnalysis\'</span>\n<span class="token keyword">import</span> XTracker <span class="token keyword">from</span> <span class="token string">\'@/components/xTracker\'</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> setDataLayer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/hooks/useSetDataLayer\'</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">Index</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>\n  sceneParams\n<span class="token punctuation">}</span><span class="token punctuation">:</span> SceneProps</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span>\n    progress <span class="token operator">=</span> <span class="token number">0</span>\n  <span class="token punctuation">}</span> <span class="token operator">=</span> sceneParams <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> t <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTranslation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> trackRef <span class="token operator">=</span> XTracker<span class="token punctuation">.</span><span class="token function">useExposureNode</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">\'P5\'</span><span class="token punctuation">,</span>\n    event<span class="token punctuation">:</span> <span class="token string">\'IntelligentSpace_Show\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">param<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">p5.smartSpaceInternal.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>param<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> api<span class="token punctuation">,</span> Slot <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTmpComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> state <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useStoreContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>playerProgress<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getAnimateProgresses</span><span class="token punctuation">(</span>progress<span class="token punctuation">,</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      start<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n      duration<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token operator">/</span> <span class="token number">3</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> isShowAnimationText <span class="token operator">=</span> playerProgress <span class="token operator">></span> <span class="token number">0.47</span> <span class="token comment">// 窗帘收起时文字出现</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token punctuation">{</span>\n        state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">PC</span> <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">JsmpegPlayer</span></span>\n          <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>player<span class="token punctuation">}</span></span>\n          <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/public/p5/smart-space-internal/p5-inside.mpeg<span class="token punctuation">"</span></span>\n          <span class="token attr-name">poster</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/public/p5/smart-space-internal/p5-inside-first-frame.jpg<span class="token punctuation">"</span></span>\n          <span class="token attr-name">progress</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>playerProgress<span class="token punctuation">}</span></span>\n        <span class="token punctuation">/></span></span>\n      <span class="token punctuation">}</span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>\n        <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classNames</span><span class="token punctuation">(</span><span class="token string">\'global-full-page-with-top-menu\'</span><span class="token punctuation">,</span> styles<span class="token punctuation">.</span>container<span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n      <span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token punctuation">{</span>\n          state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">H5</span> <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>l.video</span>\n            <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>player<span class="token punctuation">}</span></span>\n            <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/public/p5/smart-space-internal/p5-inside-origin.mp4<span class="token punctuation">"</span></span>\n            <span class="token attr-name">srcPoster</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/public/p5/smart-space-internal/p5-inside@mini.jpg<span class="token punctuation">"</span></span>\n            <span class="token attr-name">playIconPosition</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>bottom<span class="token punctuation">"</span></span>\n          <span class="token punctuation">/></span></span>\n        <span class="token punctuation">}</span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Slot</span></span>\n          <span class="token attr-name">modelType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>P5<span class="token punctuation">\'</span></span>\n          <span class="token attr-name">pageType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>IntelligentSpace<span class="token punctuation">\'</span></span>\n          <span class="token attr-name">buttonType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>LearnMore<span class="token punctuation">\'</span></span>\n          <span class="token attr-name">itemList</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token punctuation">{</span>\n            imgList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p5/d3/p5-d3-1.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p5/d3/p5-d3-1@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            background<span class="token punctuation">:</span> <span class="token string">\'linear-gradient(132deg, #94A1C6 0%, #7C8DB6 100%)\'</span><span class="token punctuation">,</span>\n            textData<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              topSubTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.topSubTitle1\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              title<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.title1\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              subTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.subTitle1\'</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n            imgList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p5/d3/p5-d3-2.mp4\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            background<span class="token punctuation">:</span> <span class="token string">\'linear-gradient(136deg, #5F729E 0%, #3B4B76 100%)\'</span><span class="token punctuation">,</span>\n            textData<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              topSubTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.topSubTitle2\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              title<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.title2\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              subTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.subTitle2\'</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n            imgList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>\n              src<span class="token punctuation">:</span> <span class="token string">\'/public/p5/d3/p5-d3-3.jpg\'</span><span class="token punctuation">,</span>\n              srcSet<span class="token punctuation">:</span> <span class="token string">\'/public/p5/d3/p5-d3-3@2x.jpg\'</span>\n            <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            background<span class="token punctuation">:</span> <span class="token string">\'linear-gradient(133deg, #B6CBDA 0%, #7A97AF 100%)\'</span><span class="token punctuation">,</span>\n            textData<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              topSubTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.topSubTitle3\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              title<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.title3\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n              subTitle<span class="token punctuation">:</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">\'p5.d3.subTitle3\'</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>\n        <span class="token punctuation">/></span></span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>trackRef<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classNames</span><span class="token punctuation">(</span><span class="token string">\'body\'</span><span class="token punctuation">,</span> styles<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n          </span><span class="token punctuation">{</span>\n            isShowAnimationText <span class="token operator">&amp;&amp;</span> state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">PC</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>ModelCenterText\n              topSubTitle<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'topSubTitle\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n              title<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'title\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n              subTitle<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'subTitle\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n              shortDesc<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'shortDesc\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n              buttonText<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'button\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n              buttonProps<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n                <span class="token function-variable function">onClick</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                  <span class="token function">dataAnalysisClickTrack</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">DATA_ANALYSIS_TYPES</span><span class="token punctuation">.</span><span class="token constant">P5</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_IntelligentSpace_LearnMoreBtn</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n                  api<span class="token operator">?</span><span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n                  <span class="token function">setDataLayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                    event_category<span class="token punctuation">:</span> <span class="token string">\'click_button\'</span><span class="token punctuation">,</span>\n                    car_model<span class="token punctuation">:</span> <span class="token string">\'p5\'</span><span class="token punctuation">,</span>\n                    button_group<span class="token punctuation">:</span> <span class="token string">\'learn more\'</span><span class="token punctuation">,</span>\n                    click_text<span class="token punctuation">:</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'button\'</span><span class="token punctuation">)</span>\n                  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n                <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">\'ghost\'</span><span class="token punctuation">,</span>\n                dark<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n                plain<span class="token punctuation">:</span> <span class="token boolean">true</span>\n              <span class="token punctuation">}</span><span class="token punctuation">}</span>\n              closeIcon<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">null</span><span class="token punctuation">}</span>\n            <span class="token operator">/</span><span class="token operator">></span>\n          <span class="token punctuation">}</span><span class="token plain-text">\n          </span><span class="token punctuation">{</span>\n            state<span class="token operator">?</span><span class="token punctuation">.</span>clientType <span class="token operator">===</span> <span class="token constant">CLIENT_TYPE</span><span class="token punctuation">.</span><span class="token constant">H5</span> <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ModelLeftText</span></span>\n              <span class="token attr-name">topSubTitle</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'topSubTitle\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n              <span class="token attr-name">title</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'title\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n              <span class="token attr-name">subTitle</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'subTitle\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n              <span class="token attr-name">shortDesc</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">\'shortDesc\'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n              <span class="token attr-name">buttonProps</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n                <span class="token function-variable function">onClick</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n                  api<span class="token operator">?</span><span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n                <span class="token punctuation">}</span><span class="token punctuation">,</span>\n                <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">\'ghost\'</span>\n              <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n              <span class="token attr-name">closeIcon</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">null</span><span class="token punctuation">}</span></span>\n            <span class="token punctuation">/></span></span>\n          <span class="token punctuation">}</span><span class="token plain-text">\n        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>\n\n  <span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> Index</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行效果-4"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<h4 id="pixi-apngandgif-1"><a href="#pixi-apngandgif-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pixi-apngAndGif</h4>\n<!-- <iframe data-src="https://codesandbox.io/embed/fzmi7s?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/jtgkm7?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h4 id="ogvjs-1"><a href="#ogvjs-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ogv.js</h4>\n<!-- <iframe data-src="https://codesandbox.io/embed/dv2njm?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/xz72w3?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h4 id="video-1"><a href="#video-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>video</h4>\n<p>利用 <code class="language-text">懒加载</code> 功能写出的进度控制如下：</p>\n<!-- <iframe data-src="https://codesandbox.io/embed/16i1lw?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/kwrcjq?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h4 id="jsmpeg-1"><a href="#jsmpeg-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>jsmpeg</h4>\n<!-- <iframe data-src="https://codesandbox.io/embed/0ywivn?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/cgtjwk?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h3 id="优化-1"><a href="#%E4%BC%98%E5%8C%96-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化</h3>\n<h4 id="视频压缩"><a href="#%E8%A7%86%E9%A2%91%E5%8E%8B%E7%BC%A9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>视频压缩</h4>\n<p>视频批量压缩脚本、支持单个压缩（有声音、转 mpeg 单独压缩）</p>\n<p>scripts/compress.mjs</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69149396373556530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/usr/bin/env zx\nconst { get } = require(\'lodash\');\n\nconst compressConfig = require(\'../compress.config\');\nconst concurrentRun = require(\'./concurrentRun\');\n\n// 关闭日志输出\n\\$.verbose = false;\n\nconst FILE_SUFFIX = \'mp4\';\nconst TMP_FILE_SUFFIX = \'.bak.mp4\';\n\nconst delFiles = await globby(\\`public/**/*\\${TMP_FILE_SUFFIX}\\`);\n\nawait \\$\\`rm -rf \\${delFiles}\\`;\n\nlet files = [];\n\nconst params = argv._.slice(1);\nif (params.length > 0) {\n   files = params.filter((item) => /mp4\\$/.test(item));\n} else {\n   files = await globby(\\`public/**/*.\\${FILE_SUFFIX}\\`);\n}\n\nconsole.log(\\`开始压缩 \\${FILE_SUFFIX}\\`);\n\n// https://github.com/google/zx/issues/126\n\\$.noquote = async (...args) => {\n   const q = \\$.quote;\n   \\$.quote = (v) => v;\n   const p = \\$(...args);\n   await p;\n   \\$.quote = q;\n   return p;\n};\n\nconst transformToMpeg = async (bashFunc, file) => {\n   await \\$.noquote\\`\\${bashFunc(file, file.replace(/mp4\\$/, \'mpeg\'))}\\`;\n   // await \\$\\`rm -rf \\${file}\\`\n};\n\nconst transformToMp4 = async (bashFunc, file) => {\n   await \\$.noquote\\`\\${bashFunc(file, file + TMP_FILE_SUFFIX)}\\`;\n   await \\$\\`rm -rf \\${file}\\`;\n   await \\$\\`mv \\${file}\\${TMP_FILE_SUFFIX} \\${file}\\`;\n   await \\$\\`rm -rf \\${file}\\${TMP_FILE_SUFFIX}\\`;\n};\n\nconst funcArray = [\n   {\n      path: \'mpeg.4\',\n      func: transformToMpeg\n   },\n   {\n      path: \'mp4.hasAudio\',\n      func: transformToMp4\n   },\n   {\n      path: \'mp4\',\n      func: transformToMp4\n   }\n];\n\nawait concurrentRun(\n   files.map((file) => async () => {\n      for (let i = 0; i < funcArray.length; i++) {\n         const item = funcArray[i];\n         const { bashFunc, files } = get(compressConfig.mp4, item.path);\n         // files 未定义或者包含 file\n         if (!files || files.includes(file)) {\n            await item.func(bashFunc, file);\n            return Promise.resolve();\n         }\n      }\n      return Promise.resolve();\n   })\n);\n\nconsole.log(\\`共 \\${files.length} 个 \\${FILE_SUFFIX} 压缩完成\\`);`, `69149396373556530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env zx\n<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> compressConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../compress.config\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> concurrentRun <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./concurrentRun\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 关闭日志输出</span>\n$<span class="token punctuation">.</span>verbose <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">FILE_SUFFIX</span> <span class="token operator">=</span> <span class="token string">\'mp4\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token constant">TMP_FILE_SUFFIX</span> <span class="token operator">=</span> <span class="token string">\'.bak.mp4\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> delFiles <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">globby</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">public/**/*</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">TMP_FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rm -rf </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>delFiles<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> params <span class="token operator">=</span> argv<span class="token punctuation">.</span>_<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   files <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token regex">/mp4$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n   files <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">globby</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">public/**/*.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">开始压缩 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// https://github.com/google/zx/issues/126</span>\n$<span class="token punctuation">.</span><span class="token function-variable function">noquote</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> q <span class="token operator">=</span> $<span class="token punctuation">.</span>quote<span class="token punctuation">;</span>\n   $<span class="token punctuation">.</span><span class="token function-variable function">quote</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=></span> v<span class="token punctuation">;</span>\n   <span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">await</span> p<span class="token punctuation">;</span>\n   $<span class="token punctuation">.</span>quote <span class="token operator">=</span> q<span class="token punctuation">;</span>\n   <span class="token keyword">return</span> p<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">transformToMpeg</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">bashFunc<span class="token punctuation">,</span> file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">await</span> $<span class="token punctuation">.</span>noquote<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">bashFunc</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/mp4$/</span><span class="token punctuation">,</span> <span class="token string">\'mpeg\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n   <span class="token comment">// await $`rm -rf ${file}`</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">transformToMp4</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">bashFunc<span class="token punctuation">,</span> file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">await</span> $<span class="token punctuation">.</span>noquote<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">bashFunc</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> file <span class="token operator">+</span> <span class="token constant">TMP_FILE_SUFFIX</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n   <span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rm -rf </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n   <span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">mv </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">TMP_FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n   <span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rm -rf </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">TMP_FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> funcArray <span class="token operator">=</span> <span class="token punctuation">[</span>\n   <span class="token punctuation">{</span>\n      path<span class="token punctuation">:</span> <span class="token string">\'mpeg.4\'</span><span class="token punctuation">,</span>\n      func<span class="token punctuation">:</span> transformToMpeg\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token punctuation">{</span>\n      path<span class="token punctuation">:</span> <span class="token string">\'mp4.hasAudio\'</span><span class="token punctuation">,</span>\n      func<span class="token punctuation">:</span> transformToMp4\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token punctuation">{</span>\n      path<span class="token punctuation">:</span> <span class="token string">\'mp4\'</span><span class="token punctuation">,</span>\n      func<span class="token punctuation">:</span> transformToMp4\n   <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">await</span> <span class="token function">concurrentRun</span><span class="token punctuation">(</span>\n   files<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> funcArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> item <span class="token operator">=</span> funcArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n         <span class="token keyword">const</span> <span class="token punctuation">{</span> bashFunc<span class="token punctuation">,</span> files <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>compressConfig<span class="token punctuation">.</span>mp4<span class="token punctuation">,</span> item<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token comment">// files 未定义或者包含 file</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>files <span class="token operator">||</span> files<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">await</span> item<span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">(</span>bashFunc<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">共 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>files<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">FILE_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 压缩完成</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>scripts/concurrentRun.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45140917789626655000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const ProgressBar = require(\'progress\');\nconst os = require(\'os\');\nconst cpus = os.cpus();\n\n/**\n * 执行多个异步任务\n * @param {*} fnList 任务列表\n * @param {*} max 最大并发数限制，默认执行的是 CPU 密集性任务，线程数等于 CPU 核心数 + 1\n * @param {*} taskName 任务名称\n */\nmodule.exports = async function concurrentRun(fnList = [], max = cpus.length + 1, taskName = \'未命名\') {\n   if (!fnList.length) return;\n\n   console.log(\\`开始执行多个异步任务，最大并发数： \\${max}\\`);\n   const bar = new ProgressBar(\'执行中 [:bar] :rate/bps :percent :etas 第 :current 个 总共 :total 个\', {\n      total: fnList.length\n   });\n\n   const replyList = []; // 收集任务执行结果\n   // const count = fnList.length // 总任务数量\n   const startTime = new Date().getTime(); // 记录任务执行开始时间\n\n   // let current = 0\n   // 任务执行程序\n   const schedule = async (index) => {\n      // eslint-disable-next-line no-async-promise-executor\n      return new Promise(async (resolve) => {\n         try {\n            const fn = fnList[index];\n            if (!fn) return resolve();\n\n            // 执行当前异步任务\n            const reply = await fn();\n            replyList[index] = reply;\n         } catch (e) {\n            console.log(e);\n            // 报错了不管继续下一个\n            resolve();\n         }\n\n         bar.tick();\n         // current++\n         // console.log(\n         //   \\`\\${taskName} 事务进度，第 \\${current} 个，共 \\${count} 个，进度为 \\${((current / count) * 100).toFixed(2)}% \\`\n         // )\n\n         // 执行完当前任务后，继续执行任务池的剩余任务\n         await schedule(index + max);\n         resolve();\n      });\n   };\n\n   // 任务池执行程序\n   const scheduleList = new Array(max).fill(0).map((_, index) => schedule(index));\n   // 使用 Promise.all 批量执行\n   await Promise.all(scheduleList);\n\n   const cost = (new Date().getTime() - startTime) / 1000;\n   if (bar.complete) {\n      console.log(\\`执行完成，最大并发数： \\${max}，耗时：\\${cost}s\\`);\n   }\n   return replyList;\n};`, `45140917789626655000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> ProgressBar <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'progress\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> os <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'os\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> cpus <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">/**\n * 执行多个异步任务\n * @param {*} fnList 任务列表\n * @param {*} max 最大并发数限制，默认执行的是 CPU 密集性任务，线程数等于 CPU 核心数 + 1\n * @param {*} taskName 任务名称\n */</span>\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">concurrentRun</span><span class="token punctuation">(</span>fnList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> max <span class="token operator">=</span> cpus<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> taskName <span class="token operator">=</span> <span class="token string">\'未命名\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fnList<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>\n\n   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">开始执行多个异步任务，最大并发数： </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>max<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProgressBar</span><span class="token punctuation">(</span><span class="token string">\'执行中 [:bar] :rate/bps :percent :etas 第 :current 个 总共 :total 个\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      total<span class="token punctuation">:</span> fnList<span class="token punctuation">.</span>length\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> replyList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 收集任务执行结果</span>\n   <span class="token comment">// const count = fnList.length // 总任务数量</span>\n   <span class="token keyword">const</span> startTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录任务执行开始时间</span>\n\n   <span class="token comment">// let current = 0</span>\n   <span class="token comment">// 任务执行程序</span>\n   <span class="token keyword">const</span> <span class="token function-variable function">schedule</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// eslint-disable-next-line no-async-promise-executor</span>\n      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            <span class="token keyword">const</span> fn <span class="token operator">=</span> fnList<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            <span class="token comment">// 执行当前异步任务</span>\n            <span class="token keyword">const</span> reply <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            replyList<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> reply<span class="token punctuation">;</span>\n         <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">// 报错了不管继续下一个</span>\n            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n\n         bar<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token comment">// current++</span>\n         <span class="token comment">// console.log(</span>\n         <span class="token comment">//   `${taskName} 事务进度，第 ${current} 个，共 ${count} 个，进度为 ${((current / count) * 100).toFixed(2)}% `</span>\n         <span class="token comment">// )</span>\n\n         <span class="token comment">// 执行完当前任务后，继续执行任务池的剩余任务</span>\n         <span class="token keyword">await</span> <span class="token function">schedule</span><span class="token punctuation">(</span>index <span class="token operator">+</span> max<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n   <span class="token comment">// 任务池执行程序</span>\n   <span class="token keyword">const</span> scheduleList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">schedule</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 使用 Promise.all 批量执行</span>\n   <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>scheduleList<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">const</span> cost <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>bar<span class="token punctuation">.</span>complete<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">执行完成，最大并发数： </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>max<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">，耗时：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cost<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">s</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">return</span> replyList<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>compress.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97401842779992880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n   mp4: {\n      mp4: {\n         bashFunc: (input, output) =>\n            \\`ffmpeg -y -i \\${input} -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -an -movflags faststart -v fatal \\${output}\\`,\n         hasAudio: {\n            bashFunc: (input, output) =>\n               \\`ffmpeg -y -i \\${input} -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -movflags faststart -v fatal \\${output}\\`,\n            files: [\'public/p7/xmart-os/p7-p6-1.mp4\', \'public/no/p7/build-yours/p7-p1-1@long.mp4\']\n         }\n      },\n      mpeg: {\n         4: {\n            bashFunc: (input, output) =>\n               \\`ffmpeg -y -i \\${input} -f mpeg1video -codec:v mpeg1video -q 4 -bf 0 -r 25 -an -movflags faststart -v fatal \\${output}\\`,\n            files: [\n               \'public/p5/smart-space-internal/p5-inside.mp4\',\n               \'public/p7/extra-performance/p7-chassis.mp4\',\n               \'public/p7/learn-more/p7-wing.mp4\',\n               \'public/g3i/xmart-os/g3i-inside.mp4\'\n            ]\n         }\n      }\n   }\n};`, `97401842779992880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   mp4<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      mp4<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         <span class="token function-variable function">bashFunc</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">input<span class="token punctuation">,</span> output</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ffmpeg -y -i </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>input<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -an -movflags faststart -v fatal </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>output<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n         hasAudio<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token function-variable function">bashFunc</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">input<span class="token punctuation">,</span> output</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n               <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ffmpeg -y -i </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>input<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -b:v 2048k -maxrate:v 2048k -minrate:v 2048k -r 25 -movflags faststart -v fatal </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>output<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n            files<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'public/p7/xmart-os/p7-p6-1.mp4\'</span><span class="token punctuation">,</span> <span class="token string">\'public/no/p7/build-yours/p7-p1-1@long.mp4\'</span><span class="token punctuation">]</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      mpeg<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         <span class="token number">4</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            <span class="token function-variable function">bashFunc</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">input<span class="token punctuation">,</span> output</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n               <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ffmpeg -y -i </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>input<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -f mpeg1video -codec:v mpeg1video -q 4 -bf 0 -r 25 -an -movflags faststart -v fatal </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>output<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n            files<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n               <span class="token string">\'public/p5/smart-space-internal/p5-inside.mp4\'</span><span class="token punctuation">,</span>\n               <span class="token string">\'public/p7/extra-performance/p7-chassis.mp4\'</span><span class="token punctuation">,</span>\n               <span class="token string">\'public/p7/learn-more/p7-wing.mp4\'</span><span class="token punctuation">,</span>\n               <span class="token string">\'public/g3i/xmart-os/g3i-inside.mp4\'</span>\n            <span class="token punctuation">]</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="国际化"><a href="#%E5%9B%BD%E9%99%85%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>国际化</h1>\n<h2 id="语言动态加载"><a href="#%E8%AF%AD%E8%A8%80%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>语言动态加载</h2>\n<p>利用 <code class="language-text">require.context</code> 动态读取目录下的文件内容，实现动态加载语言配置、自定义前缀功能</p>\n<h3 id="目录结构"><a href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>目录结构</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52203440915742650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`.\n├── i18n.ts\n└── lang\n    ├── da-DK\n    ├── en-US\n    ├── nb-NO\n    ├── nl-NL\n    └── sv-SE`, `52203440915742650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">.\n├── i18n.ts\n└── lang\n    ├── da-DK\n    ├── en-US\n    ├── nb-NO\n    ├── nl-NL\n    └── sv-SE</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="核心代码-5"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90726299235081440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import i18n, { Resource } from \'i18next\';\nimport { initReactI18next } from \'react-i18next\';\nimport { DEFAULT_LANGUAGE } from \'@/constants\';\nimport path from \'path\';\nimport { camelCase } from \'lodash\';\n\nconst moduleFiles = require.context(\'./lang\', true, /\\.ts\\$/);\n\nconst resources: Resource = {};\n\nmoduleFiles.keys().forEach((item: string) => {\n   const dirname = path.dirname(item);\n   // 取路径里面的第一个目录\n   const keys = dirname.split(\'/\').filter((item) => item && item !== \'.\');\n   const [key, ...restKey] = keys;\n   if (key) {\n      let value = moduleFiles(item).default || moduleFiles(item);\n      const pathPrefix = [];\n      // 是否携带路径前缀\n      if (value.withPathPrefix) {\n         pathPrefix.push(...restKey);\n      }\n      // 是否携带文件前缀\n      if (value.withFilePrefix) {\n         const basename = path.basename(item, \'.ts\');\n         pathPrefix.push(basename);\n      }\n\n      if (pathPrefix.length > 0) {\n         const newValue: { [key: string]: any } = {};\n         const newPathPrefix = pathPrefix.map(camelCase).join(\'.\');\n         Object.keys(value).forEach((key2) => {\n            newValue[\\`\\${newPathPrefix}.\\${key2}\\`] = value[key2];\n         });\n         value = newValue;\n      }\n\n      if (resources[key]) {\n         resources[key].translation = {\n            ...(resources[key].translation as {}),\n            ...value\n         };\n      } else {\n         resources[key] = {\n            translation: value\n         };\n      }\n   }\n});\n\nexport const initLanguage = async function(language: string = DEFAULT_LANGUAGE) {\n   if (i18n.isInitialized) {\n      if (language !== i18n.language) {\n         await i18n.changeLanguage(language);\n      }\n      return;\n   }\n   return await i18n\n      .use(initReactI18next) // passes i18n down to react-i18next\n      .init({\n         resources,\n         debug: process.env.NODE_ENV === \'development\',\n         lng: language,\n         keySeparator: false, // we do not use keys in form messages.welcome\n         interpolation: {\n            escapeValue: false\n         }\n         // 不能使用数组或对象，因为需要用户去填字符串\n         // returnObjects: true\n      })\n      .catch((error) => {\n         console.info(\'initReactI18next error:\', error);\n      });\n};`, `90726299235081440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">import</span> i18n<span class="token punctuation">,</span> <span class="token punctuation">{</span> Resource <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'i18next\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> initReactI18next <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-i18next\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">DEFAULT_LANGUAGE</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@/constants\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">\'path\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> camelCase <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> moduleFiles <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">\'./lang\'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token regex">/\\.ts$/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> resources<span class="token punctuation">:</span> Resource <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\nmoduleFiles<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token comment">// 取路径里面的第一个目录</span>\n   <span class="token keyword">const</span> keys <span class="token operator">=</span> dirname<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item <span class="token operator">&amp;&amp;</span> item <span class="token operator">!==</span> <span class="token string">\'.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">const</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> <span class="token operator">...</span>restKey<span class="token punctuation">]</span> <span class="token operator">=</span> keys<span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token function">moduleFiles</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span> <span class="token operator">||</span> <span class="token function">moduleFiles</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> pathPrefix <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token comment">// 是否携带路径前缀</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>withPathPrefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         pathPrefix<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>restKey<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// 是否携带文件前缀</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>withFilePrefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> basename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'.ts\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         pathPrefix<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>basename<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>pathPrefix<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> newValue<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token builtin">any</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n         <span class="token keyword">const</span> newPathPrefix <span class="token operator">=</span> pathPrefix<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>camelCase<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            newValue<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>newPathPrefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key2<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">[</span>key2<span class="token punctuation">]</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         value <span class="token operator">=</span> newValue<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>resources<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         resources<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>translation <span class="token operator">=</span> <span class="token punctuation">{</span>\n            <span class="token operator">...</span><span class="token punctuation">(</span>resources<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>translation <span class="token keyword">as</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n            <span class="token operator">...</span>value\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         resources<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n            translation<span class="token punctuation">:</span> value\n         <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">initLanguage</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">language<span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token constant">DEFAULT_LANGUAGE</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>i18n<span class="token punctuation">.</span>isInitialized<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>language <span class="token operator">!==</span> i18n<span class="token punctuation">.</span>language<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">await</span> i18n<span class="token punctuation">.</span><span class="token function">changeLanguage</span><span class="token punctuation">(</span>language<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token keyword">return</span> <span class="token keyword">await</span> i18n\n      <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>initReactI18next<span class="token punctuation">)</span> <span class="token comment">// passes i18n down to react-i18next</span>\n      <span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n         resources<span class="token punctuation">,</span>\n         debug<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">\'development\'</span><span class="token punctuation">,</span>\n         lng<span class="token punctuation">:</span> language<span class="token punctuation">,</span>\n         keySeparator<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// we do not use keys in form messages.welcome</span>\n         interpolation<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            escapeValue<span class="token punctuation">:</span> <span class="token boolean">false</span>\n         <span class="token punctuation">}</span>\n         <span class="token comment">// 不能使用数组或对象，因为需要用户去填字符串</span>\n         <span class="token comment">// returnObjects: true</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">\'initReactI18next error:\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>添加所需的字段：</p>\n<p>web/locales/lang/en-US/p7/app-download.ts</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81210427678391090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export default {\n   withPathPrefix: true,\n   withFilePrefix: true,\n   title: \'123456\'\n};`, `81210427678391090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>\n   withPathPrefix<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n   withFilePrefix<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n   title<span class="token punctuation">:</span> <span class="token string">\'123456\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用时的代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39670294518183910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useTranslation } from \'react-i18next\';\nconst { t } = useTranslation();\nconst getValue = (param: string) => t(\\`p7.appDownload.\\${param}\\`);\n// console.log(getValue(\'title\'))`, `39670294518183910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> useTranslation <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-i18next\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> t <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTranslation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token function-variable function">getValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">param<span class="token punctuation">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">p7.appDownload.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>param<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// console.log(getValue(\'title\'))</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="路由复用"><a href="#%E8%B7%AF%E7%94%B1%E5%A4%8D%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>路由复用</h2>\n<h3 id="需求背景-6"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>国家站的页面和国际站大部分的页面相同，只是语言不同，可以复用路由</p>\n<h3 id="核心代码-6"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<p>见标红部分代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17241304222576615000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const { join } = require(\'path\')\nconst { getFeDir } = require(\'ssr-server-utils\')\nconst fs = require(\'fs\')\n\nconst countryList = [\'no\', \'se\', \'dk\', \'nl\'] // 挪威 NO, 瑞典 SE, 丹麦 DK, 荷兰 NL\n\n// https://github.com/zhangyuang/ssr/blob/8e9e5514d81f0db24a8c9e59bac8379f7a09a2c0/packages/server-utils/src/parse.ts#L159\nconst renderRoutes = (pageDir, pathRecord, route) => {\n  let arr = []\n  const pagesFolders = fs.readdirSync(pageDir)\n  const prefixPath = pathRecord.join(\'/\')\n  const aliasPath = \\`@/pages\\${prefixPath}\\`\n  const routeArr = []\n  const fetchExactMatch = pagesFolders.filter(p => p.includes(\'fetch\'))\n  for (const pageFiles of pagesFolders) {\n    const abFolder = join(pageDir, pageFiles)\n    const isDirectory = fs.lstatSync(abFolder).isDirectory()\n    if (isDirectory) {\n      // 如果是文件夹则递归下去, 记录路径\n      pathRecord.push(pageFiles)\n      const childArr = renderRoutes(abFolder, pathRecord, Object.assign({}, route))\n      pathRecord.pop() // 回溯\n      arr = arr.concat(childArr)\n    } else {\n      // 遍历一个文件夹下面的所有文件\n      if (!pageFiles.includes(\'render\')) {\n        continue\n      }\n      // 拿到具体的文件\n      if (pageFiles.includes(\'render\\$\')) {\n        /* /news/:id */\n        route.path = \\`\\${prefixPath}/:\\${getDynamicParam(pageFiles)}\\`\n        route.component = \\`\\${aliasPath}/\\${pageFiles}\\`\n        let webpackChunkName = pathRecord.join(\'-\')\n        if (webpackChunkName.startsWith(\'-\')) {\n          webpackChunkName = webpackChunkName.replace(\'-\', \'\')\n        }\n        route.webpackChunkName = \\`\\${webpackChunkName}-\\${getDynamicParam(pageFiles).replace(/\\/:\\??/g, \'-\').replace(\'?\', \'-optional\')}\\`\n      } else if (pageFiles.includes(\'render\')) {\n        /* /news */\n        route.path = \\`\\${prefixPath}\\`\n        route.component = \\`\\${aliasPath}/\\${pageFiles}\\`\n        let webpackChunkName = pathRecord.join(\'-\')\n        if (webpackChunkName.startsWith(\'-\')) {\n          webpackChunkName = webpackChunkName.replace(\'-\', \'\')\n        }\n        route.webpackChunkName = webpackChunkName\n      }\n\n      if (fetchExactMatch.length >= 2) {\n        // fetch 文件数量 >=2 启用完全匹配策略 render\\$id => fetch\\$id, render => fetch\n        const fetchPageFiles = \\`\\${pageFiles.replace(\'render\', \'fetch\').split(\'.\')[0]}.ts\\`\n        if (fetchExactMatch.includes(fetchPageFiles)) {\n          route.fetch = \\`\\${aliasPath}/\\${fetchPageFiles}\\`\n        }\n      } else if (fetchExactMatch.includes(\'fetch.ts\')) {\n        // 单 fetch 文件的情况 所有类型的 render 都对应该 fetch\n        route.fetch = \\`\\${aliasPath}/fetch.ts\\`\n      }\n      routeArr.push({ ...route })\n    }\n  }\n  routeArr.forEach((r) => {\n    if (r.path?.includes(\'index\')) {\n      r.path && arr.push(JSON.parse(JSON.stringify(r)))\n      // /index 映射为 /\n      if (r.path.split(\'/\').length >= 3) {\n        r.path = r.path.replace(\'/index\', \'\')\n      } else {\n        r.path = r.path.replace(\'index\', \'\')\n      }\n    }\n\n    r.path && arr.push(r)\n  })\n\n  return arr\n}\n\nconst getDynamicParam = (url) => {\n  return url.split(\'\\$\').filter(r => r !== \'render\' && r !== \'\').map(r => r.replace(/\\.[\\s\\S]+/, \'\').replace(\'#\', \'?\')).join(\'/:\')\n}\n\nconst accessFile = (file) => {\n  try {\n    fs.accessSync(file)\n  } catch (error) {\n    return false\n  }\n  return true\n}\n\nconst { dynamic = true, routerPriority, routerOptimize } = {}\nconst prefix = \'\'\n// 根据目录结构生成前端路由表\nconst pathRecord = [\'\'] // 路径记录\nconst route = {}\nlet arr = renderRoutes(join(getFeDir(), \'pages\'), pathRecord, route)\nif (routerPriority) {\n  // 路由优先级排序\n  arr.sort((a, b) => {\n    // 没有显示指定的路由优先级统一为 0\n    return (routerPriority[b.path] || 0) - (routerPriority[a.path] || 0)\n  })\n}\n\nif (routerOptimize) {\n  // 路由过滤\n  if (routerOptimize.include && routerOptimize.exclude) {\n    throw new Error(\'include and exclude cannot exist synchronal\')\n  }\n  if (routerOptimize.include) {\n    arr = arr.filter(route => routerOptimize.include.includes(route.path))\n  }\n  if (routerOptimize.exclude) {\n    arr = arr.filter(route => !routerOptimize.exclude.includes(route.path))\n  }\n}\n\nconst countryRoutes = []\ncountryList.forEach(country => {\n  arr.forEach(route => {\n    const path = \\`/\\${country}\\${route.path}\\`\n    // 注意这里需要去除掉 2 个国家的无效路径\n    if (arr.every(route => route.path !== path) && path.split(\'/\').filter((item) => countryList.includes(item)).length <= 1) {\n      countryRoutes.push({\n        ...route,\n        path\n      })\n    }\n    if (route.path === \'/\') {\n      countryRoutes.push({\n        ...route,\n        path: \\`/\\${country}\\`\n      })\n    }\n  })\n})\n\narr = arr.concat(countryRoutes)\n\nconst accessReactApp = accessFile(join(getFeDir(), \'./components/layout/App.tsx\'))\nconst layoutFetch = accessFile(join(getFeDir(), \'./components/layout/fetch.ts\'))\nconst accessStore = accessFile(join(getFeDir(), \'./store/index.ts\'))\nconst re = /&quot;webpackChunkName&quot;:(&quot;(.+?)&quot;)/g\n\nlet routes = \\`\n        // The file is provisional，don\'t depend on it\n        export const FeRoutes = \\${JSON.stringify(arr)}\n        \\${accessReactApp ? \'export { default as App } from &quot;@/components/layout/App.tsx&quot;\' : \'\'}\n        \\${layoutFetch ? \'export { default as layoutFetch } from &quot;@/components/layout/fetch.ts&quot;\' : \'\'}\n        \\${accessStore ? \'export * from &quot;@/store/index.ts&quot;\' : \'\'}\n        \\${prefix ? \\`export const PrefixRouterBase=\'\\${prefix}\'\\` : \'\'}\n      \\`\nroutes = routes.replace(/&quot;component&quot;:(&quot;(.+?)&quot;)/g, (global, m1, m2) => {\n  const currentWebpackChunkName = re.exec(routes)[2]\n  if (dynamic) {\n    return \\`&quot;component&quot;: function dynamicComponent () {\n            return import(/* webpackChunkName: &quot;\\${currentWebpackChunkName}&quot; */ \'\\${m2.replace(/\\^/g, \'&quot;\')}\')\n          }\n          \\`\n  } else {\n    return \\`&quot;component&quot;: require(\'\\${m2.replace(/\\^/g, \'&quot;\')}\').default\\`\n  }\n})\nre.lastIndex = 0\nroutes = routes.replace(/&quot;fetch&quot;:(&quot;(.+?)&quot;)/g, (global, m1, m2) => {\n  const currentWebpackChunkName = re.exec(routes)[2]\n  return \\`&quot;fetch&quot;: () => import(/* webpackChunkName: &quot;\\${currentWebpackChunkName}-fetch&quot; */ \'\\${m2.replace(/\\^/g, \'&quot;\')}\')\\`\n})\n\nfs.writeFileSync(join(getFeDir(), \'route.ts\'), routes)\n// 替换以下 console.log 内容即可在 router.json 文件找到所有的官网路径\n// console.log(arr.map((item) => item.path).join(\'\\n\'))\nfs.writeFileSync(join(__dirname, \'../src/router.json\'), JSON.stringify(arr))`, `17241304222576615000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts{120-140}"\n              >\n                <span class="gatsby-code-button-language">ts{120-140}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">const</span> <span class="token punctuation">{</span> join <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> getFeDir <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'ssr-server-utils\'</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span>\n\n<span class="token keyword">const</span> countryList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'no\'</span><span class="token punctuation">,</span> <span class="token string">\'se\'</span><span class="token punctuation">,</span> <span class="token string">\'dk\'</span><span class="token punctuation">,</span> <span class="token string">\'nl\'</span><span class="token punctuation">]</span> <span class="token comment">// 挪威 NO, 瑞典 SE, 丹麦 DK, 荷兰 NL</span>\n\n<span class="token comment">// https://github.com/zhangyuang/ssr/blob/8e9e5514d81f0db24a8c9e59bac8379f7a09a2c0/packages/server-utils/src/parse.ts#L159</span>\n<span class="token keyword">const</span> <span class="token function-variable function">renderRoutes</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">pageDir<span class="token punctuation">,</span> pathRecord<span class="token punctuation">,</span> route</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n  <span class="token keyword">const</span> pagesFolders <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>pageDir<span class="token punctuation">)</span>\n  <span class="token keyword">const</span> prefixPath <span class="token operator">=</span> pathRecord<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> aliasPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">@/pages</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefixPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n  <span class="token keyword">const</span> routeArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n  <span class="token keyword">const</span> fetchExactMatch <span class="token operator">=</span> pagesFolders<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=></span> p<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">\'fetch\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> pageFiles <span class="token keyword">of</span> pagesFolders<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> abFolder <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>pageDir<span class="token punctuation">,</span> pageFiles<span class="token punctuation">)</span>\n    <span class="token keyword">const</span> isDirectory <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">lstatSync</span><span class="token punctuation">(</span>abFolder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>isDirectory<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 如果是文件夹则递归下去, 记录路径</span>\n      pathRecord<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>pageFiles<span class="token punctuation">)</span>\n      <span class="token keyword">const</span> childArr <span class="token operator">=</span> <span class="token function">renderRoutes</span><span class="token punctuation">(</span>abFolder<span class="token punctuation">,</span> pathRecord<span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> route<span class="token punctuation">)</span><span class="token punctuation">)</span>\n      pathRecord<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 回溯</span>\n      arr <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>childArr<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 遍历一个文件夹下面的所有文件</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pageFiles<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">\'render\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">continue</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// 拿到具体的文件</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>pageFiles<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">\'render$\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">/* /news/:id */</span>\n        route<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefixPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getDynamicParam</span><span class="token punctuation">(</span>pageFiles<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n        route<span class="token punctuation">.</span>component <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>aliasPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageFiles<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n        <span class="token keyword">let</span> webpackChunkName <span class="token operator">=</span> pathRecord<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'-\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>webpackChunkName<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">\'-\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          webpackChunkName <span class="token operator">=</span> webpackChunkName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'-\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n        <span class="token punctuation">}</span>\n        route<span class="token punctuation">.</span>webpackChunkName <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>webpackChunkName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getDynamicParam</span><span class="token punctuation">(</span>pageFiles<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\/:\\??/g</span><span class="token punctuation">,</span> <span class="token string">\'-\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'?\'</span><span class="token punctuation">,</span> <span class="token string">\'-optional\'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pageFiles<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">\'render\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">/* /news */</span>\n        route<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefixPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n        route<span class="token punctuation">.</span>component <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>aliasPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageFiles<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n        <span class="token keyword">let</span> webpackChunkName <span class="token operator">=</span> pathRecord<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'-\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>webpackChunkName<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">\'-\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          webpackChunkName <span class="token operator">=</span> webpackChunkName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'-\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n        <span class="token punctuation">}</span>\n        route<span class="token punctuation">.</span>webpackChunkName <span class="token operator">=</span> webpackChunkName\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>fetchExactMatch<span class="token punctuation">.</span>length <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// fetch 文件数量 >=2 启用完全匹配策略 render$id => fetch$id, render => fetch</span>\n        <span class="token keyword">const</span> fetchPageFiles <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageFiles<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'render\'</span><span class="token punctuation">,</span> <span class="token string">\'fetch\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'.\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.ts</span><span class="token template-punctuation string">`</span></span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>fetchExactMatch<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>fetchPageFiles<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          route<span class="token punctuation">.</span>fetch <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>aliasPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fetchPageFiles<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fetchExactMatch<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">\'fetch.ts\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 单 fetch 文件的情况 所有类型的 render 都对应该 fetch</span>\n        route<span class="token punctuation">.</span>fetch <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>aliasPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/fetch.ts</span><span class="token template-punctuation string">`</span></span>\n      <span class="token punctuation">}</span>\n      routeArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>route <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  routeArr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>path<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">\'index\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      r<span class="token punctuation">.</span>path <span class="token operator">&amp;&amp;</span> arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token comment">// /index 映射为 /</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">>=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        r<span class="token punctuation">.</span>path <span class="token operator">=</span> r<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'/index\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        r<span class="token punctuation">.</span>path <span class="token operator">=</span> r<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'index\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    r<span class="token punctuation">.</span>path <span class="token operator">&amp;&amp;</span> arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">return</span> arr\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">getDynamicParam</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'$\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> r <span class="token operator">!==</span> <span class="token string">\'render\'</span> <span class="token operator">&amp;&amp;</span> r <span class="token operator">!==</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> r<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\.[\\s\\S]+/</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'#\'</span><span class="token punctuation">,</span> <span class="token string">\'?\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'/:\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">accessFile</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    fs<span class="token punctuation">.</span><span class="token function">accessSync</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token boolean">false</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> <span class="token boolean">true</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> dynamic <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> routerPriority<span class="token punctuation">,</span> routerOptimize <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token keyword">const</span> prefix <span class="token operator">=</span> <span class="token string">\'\'</span>\n<span class="token comment">// 根据目录结构生成前端路由表</span>\n<span class="token keyword">const</span> pathRecord <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span> <span class="token comment">// 路径记录</span>\n<span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token function">renderRoutes</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token function">getFeDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'pages\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pathRecord<span class="token punctuation">,</span> route<span class="token punctuation">)</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>routerPriority<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 路由优先级排序</span>\n  arr<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// 没有显示指定的路由优先级统一为 0</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span>routerPriority<span class="token punctuation">[</span>b<span class="token punctuation">.</span>path<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>routerPriority<span class="token punctuation">[</span>a<span class="token punctuation">.</span>path<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>routerOptimize<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 路由过滤</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>routerOptimize<span class="token punctuation">.</span>include <span class="token operator">&amp;&amp;</span> routerOptimize<span class="token punctuation">.</span>exclude<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'include and exclude cannot exist synchronal\'</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>routerOptimize<span class="token punctuation">.</span>include<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    arr <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=></span> routerOptimize<span class="token punctuation">.</span>include<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>routerOptimize<span class="token punctuation">.</span>exclude<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    arr <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=></span> <span class="token operator">!</span>routerOptimize<span class="token punctuation">.</span>exclude<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> countryRoutes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">countryList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">country</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  arr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>country<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>route<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span></span><span class="gatsby-highlight-code-line">    <span class="token comment">// 注意这里需要去除掉 2 个国家的无效路径</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=></span> route<span class="token punctuation">.</span>path <span class="token operator">!==</span> path<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> countryList<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      countryRoutes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        <span class="token operator">...</span>route<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        path</span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">\'/\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      countryRoutes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        <span class="token operator">...</span>route<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        path<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>country<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">arr <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>countryRoutes<span class="token punctuation">)</span></span>\n<span class="token keyword">const</span> accessReactApp <span class="token operator">=</span> <span class="token function">accessFile</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token function">getFeDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'./components/layout/App.tsx\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> layoutFetch <span class="token operator">=</span> <span class="token function">accessFile</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token function">getFeDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'./components/layout/fetch.ts\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> accessStore <span class="token operator">=</span> <span class="token function">accessFile</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token function">getFeDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'./store/index.ts\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> re <span class="token operator">=</span> <span class="token regex">/"webpackChunkName":("(.+?)")/g</span>\n\n<span class="token keyword">let</span> routes <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"></span>\n<span class="token string">        // The file is provisional，don\'t depend on it</span>\n<span class="token string">        export const FeRoutes = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"></span>\n<span class="token string">        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>accessReactApp <span class="token operator">?</span> <span class="token string">\'export { default as App } from "@/components/layout/App.tsx"\'</span> <span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"></span>\n<span class="token string">        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>layoutFetch <span class="token operator">?</span> <span class="token string">\'export { default as layoutFetch } from "@/components/layout/fetch.ts"\'</span> <span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"></span>\n<span class="token string">        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>accessStore <span class="token operator">?</span> <span class="token string">\'export * from "@/store/index.ts"\'</span> <span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"></span>\n<span class="token string">        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">export const PrefixRouterBase=\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\'</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"></span>\n<span class="token string">      </span><span class="token template-punctuation string">`</span></span>\nroutes <span class="token operator">=</span> routes<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/"component":("(.+?)")/g</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">global<span class="token punctuation">,</span> m1<span class="token punctuation">,</span> m2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> currentWebpackChunkName <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>dynamic<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">"component": function dynamicComponent () {</span>\n<span class="token string">            return import(/* webpackChunkName: "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>currentWebpackChunkName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" */ \'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>m2<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\^/g</span><span class="token punctuation">,</span> <span class="token string">\'"\'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\')</span>\n<span class="token string">          }</span>\n<span class="token string">          </span><span class="token template-punctuation string">`</span></span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">"component": require(\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>m2<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\^/g</span><span class="token punctuation">,</span> <span class="token string">\'"\'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\').default</span><span class="token template-punctuation string">`</span></span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\nre<span class="token punctuation">.</span>lastIndex <span class="token operator">=</span> <span class="token number">0</span>\nroutes <span class="token operator">=</span> routes<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/"fetch":("(.+?)")/g</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">global<span class="token punctuation">,</span> m1<span class="token punctuation">,</span> m2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> currentWebpackChunkName <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>\n  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">"fetch": () => import(/* webpackChunkName: "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>currentWebpackChunkName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-fetch" */ \'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>m2<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\^/g</span><span class="token punctuation">,</span> <span class="token string">\'"\'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\')</span><span class="token template-punctuation string">`</span></span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\nfs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token function">getFeDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'route.ts\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> routes<span class="token punctuation">)</span>\n<span class="token comment">// 替换以下 console.log 内容即可在 router.json 文件找到所有的官网路径</span>\n<span class="token comment">// console.log(arr.map((item) => item.path).join(\'\\n\'))</span>\nfs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../src/router.json\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="多平台适配"><a href="#%E5%A4%9A%E5%B9%B3%E5%8F%B0%E9%80%82%E9%85%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多平台适配</h1>\n<h2 id="需求背景-7"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h2>\n<p>需要适配 PC、H5 的样式</p>\n<h2 id="选型过程-5"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h2>\n<ol>\n<li>PC 使用 rem 单位，h5 使用 vw 单位（ipad 端适配有问题，需要全部使用 rem 单位，便于样式控制），使用 @our-patches/postcss-px-to-viewport 插件做转换</li>\n<li>h5 端 100vh 的高度展示有问题，需要实时计算高度，使用 postcss-viewport-height-correction 插件实现</li>\n</ol>\n<h2 id="核心代码-7"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h2>\n<p>postcss.config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38829429298084640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n   plugins: [\n      [\n         \'@our-patches/postcss-px-to-viewport\',\n         {\n            // https://github.com/evrone/postcss-px-to-viewport/blob/master/README_CN.md\n            unitToConvert: \'px\', // 需要转换的单位，默认为&quot;px&quot;\n            viewportWidth: 1920, // 视窗的宽度，对应设计稿的宽度\n            unitPrecision: 8, // 指定 px 转换为视窗单位值的小数后 x 位数，转换精度尽可能的大，防止出现图片比例问题\n            viewportUnit: \'rem\', // 希望使用的视口单位\n            fontViewportUnit: \'rem\', // 字体使用的视口单位,\n            minPixelValue: 1, // 最小的转换数值\n            mediaQuery: true, // 媒体查询里的单位是否需要转换单位\n            selectorBlackList: [/^html\\$/, \'hack\'],\n            exclude: /node_modules/,\n            include: [/(\\\\|\\/)web(\\\\|\\/)/]\n         }\n      ],\n      // 此插件主要修复了移动端 100vh 的高度（即减去搜索框的高度），需要配合 script 脚本实现，详见 postcss-viewport-height-correction 文档\n      // 效果：https://codepen.io/team/css-tricks/full/vapjge\n      // https://css-tricks.com/the-trick-to-viewport-units-on-mobile/\n      \'postcss-viewport-height-correction\'\n   ]\n};`, `38829429298084640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n   plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token punctuation">[</span>\n         <span class="token string">\'@our-patches/postcss-px-to-viewport\'</span><span class="token punctuation">,</span>\n         <span class="token punctuation">{</span>\n            <span class="token comment">// https://github.com/evrone/postcss-px-to-viewport/blob/master/README_CN.md</span>\n            unitToConvert<span class="token punctuation">:</span> <span class="token string">\'px\'</span><span class="token punctuation">,</span> <span class="token comment">// 需要转换的单位，默认为"px"</span>\n            viewportWidth<span class="token punctuation">:</span> <span class="token number">1920</span><span class="token punctuation">,</span> <span class="token comment">// 视窗的宽度，对应设计稿的宽度</span>\n            unitPrecision<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token comment">// 指定 px 转换为视窗单位值的小数后 x 位数，转换精度尽可能的大，防止出现图片比例问题</span>\n            viewportUnit<span class="token punctuation">:</span> <span class="token string">\'rem\'</span><span class="token punctuation">,</span> <span class="token comment">// 希望使用的视口单位</span>\n            fontViewportUnit<span class="token punctuation">:</span> <span class="token string">\'rem\'</span><span class="token punctuation">,</span> <span class="token comment">// 字体使用的视口单位,</span>\n            minPixelValue<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 最小的转换数值</span>\n            mediaQuery<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 媒体查询里的单位是否需要转换单位</span>\n            selectorBlackList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token regex">/^html$/</span><span class="token punctuation">,</span> <span class="token string">\'hack\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n            exclude<span class="token punctuation">:</span> <span class="token regex">/node_modules/</span><span class="token punctuation">,</span>\n            include<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token regex">/(\\\\|\\/)web(\\\\|\\/)/</span><span class="token punctuation">]</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">]</span><span class="token punctuation">,</span>\n      <span class="token comment">// 此插件主要修复了移动端 100vh 的高度（即减去搜索框的高度），需要配合 script 脚本实现，详见 postcss-viewport-height-correction 文档</span>\n      <span class="token comment">// 效果：https://codepen.io/team/css-tricks/full/vapjge</span>\n      <span class="token comment">// https://css-tricks.com/the-trick-to-viewport-units-on-mobile/</span>\n      <span class="token string">\'postcss-viewport-height-correction\'</span>\n   <span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="swiper"><a href="#swiper" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>swiper</h1>\n<h2 id="需求背景-8"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h2>\n<ol>\n<li>swiper 嵌套时的垂直滚动不会离开当前嵌套的容器，需要做到滚动到边缘会离开当前嵌套容器即边缘检测</li>\n<li>需要实现 swiper 延迟滚动、解决滚轮不够顺滑问题</li>\n</ol>\n<h2 id="核心代码-8"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h2>\n<h3 id="嵌套边缘检测"><a href="#%E5%B5%8C%E5%A5%97%E8%BE%B9%E7%BC%98%E6%A3%80%E6%B5%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>嵌套边缘检测</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73412078577189920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const handleContainerWheel = (element) => {\n   const scrollHeight = element.scrollHeight\n   const slideSize = element.swiperSlideSize\n   const scrollDifferenceTop = scrollHeight - slideSize\n\n   const handleWheel = (event) => {\n      const scrollDifference = scrollHeight - slideSize - element.scrollTop\n\n      // Scroll wheel browser compatibility\n      const delta = event.wheelDelta || -1 * event.deltaY\n\n      // Enable scrolling if at edges\n      const spos = delta < 0 ? 0 : scrollDifferenceTop\n      const parseScrollDifference = Number.parseInt(\\`\\${scrollDifference}\\`)\n      const parseSpos = Number.parseInt(\\`\\${spos}\\`)\n\n      console.log(scrollDifference, spos)\n      if (parseScrollDifference !== parseSpos) {\n         console.log(\'stopPropagation\')\n         event.stopPropagation()\n      } else {\n         // 边缘释放参数关闭时才生效\n         if (!swiperRef?.current?.params?.mousewheel?.releaseOnEdges) {\n            // 滑动到最后一个幻灯片的底部，继续监听事件\n            if (parseScrollDifference === 0 && parseSpos === 0 && current === swiperRef?.current?.slides?.length - 1) {\n               return\n            }\n            // 滑动到第一个幻灯片的顶部，暂不处理，暂时没有首屏有滚动条的情况\n         }\n         element.removeEventListener(\'wheel\', handleWheel)\n         element.removeEventListener(\'scroll\', handleScroll)\n      }\n   }\n\n   element.addEventListener(\'wheel\', handleWheel)\n}\n\nconst handleScrollContainerEvent = (activeSlide: ActiveSlide) => {\n   const hasVerticalScrollbar = activeSlide.scrollHeight > activeSlide.clientHeight;\n   if (!hasVerticalScrollbar) {\n      return;\n   }\n   // 进入时重置滚动条\n   activeSlide.scrollTo(0, 0);\n   activeSlide.addEventListener(\'scroll\', handleScroll);\n   handleContainerWheel(activeSlide);\n}\n\n// 监听 swiper 的 onSlideChange 事件\nreturn (\n   <Swiper\n      onSlideChange={(slide) => {\n         swiperRef.current = slide;\n         if (haveNestedScrollbar) {\n            handleScrollContainerEvent(slide.slides[slide.realIndex] as ActiveSlide);\n         }\n      }}\n   ></Swiper>\n)`, `73412078577189920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">const</span> <span class="token function-variable function">handleContainerWheel</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> scrollHeight <span class="token operator">=</span> element<span class="token punctuation">.</span>scrollHeight\n   <span class="token keyword">const</span> slideSize <span class="token operator">=</span> element<span class="token punctuation">.</span>swiperSlideSize\n   <span class="token keyword">const</span> scrollDifferenceTop <span class="token operator">=</span> scrollHeight <span class="token operator">-</span> slideSize\n\n   <span class="token keyword">const</span> <span class="token function-variable function">handleWheel</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> scrollDifference <span class="token operator">=</span> scrollHeight <span class="token operator">-</span> slideSize <span class="token operator">-</span> element<span class="token punctuation">.</span>scrollTop\n\n      <span class="token comment">// Scroll wheel browser compatibility</span>\n      <span class="token keyword">const</span> delta <span class="token operator">=</span> event<span class="token punctuation">.</span>wheelDelta <span class="token operator">||</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">*</span> event<span class="token punctuation">.</span>deltaY\n\n      <span class="token comment">// Enable scrolling if at edges</span>\n      <span class="token keyword">const</span> spos <span class="token operator">=</span> delta <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> scrollDifferenceTop\n      <span class="token keyword">const</span> parseScrollDifference <span class="token operator">=</span> Number<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>scrollDifference<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n      <span class="token keyword">const</span> parseSpos <span class="token operator">=</span> Number<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>spos<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n\n      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>scrollDifference<span class="token punctuation">,</span> spos<span class="token punctuation">)</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>parseScrollDifference <span class="token operator">!==</span> parseSpos<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'stopPropagation\'</span><span class="token punctuation">)</span>\n         event<span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n         <span class="token comment">// 边缘释放参数关闭时才生效</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>swiperRef<span class="token operator">?</span><span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span>params<span class="token operator">?</span><span class="token punctuation">.</span>mousewheel<span class="token operator">?</span><span class="token punctuation">.</span>releaseOnEdges<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 滑动到最后一个幻灯片的底部，继续监听事件</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>parseScrollDifference <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> parseSpos <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> current <span class="token operator">===</span> swiperRef<span class="token operator">?</span><span class="token punctuation">.</span>current<span class="token operator">?</span><span class="token punctuation">.</span>slides<span class="token operator">?</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n               <span class="token keyword">return</span>\n            <span class="token punctuation">}</span>\n            <span class="token comment">// 滑动到第一个幻灯片的顶部，暂不处理，暂时没有首屏有滚动条的情况</span>\n         <span class="token punctuation">}</span>\n         element<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">\'wheel\'</span><span class="token punctuation">,</span> handleWheel<span class="token punctuation">)</span>\n         element<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">\'scroll\'</span><span class="token punctuation">,</span> handleScroll<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n\n   element<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'wheel\'</span><span class="token punctuation">,</span> handleWheel<span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">handleScrollContainerEvent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">activeSlide<span class="token punctuation">:</span> ActiveSlide</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n   <span class="token keyword">const</span> hasVerticalScrollbar <span class="token operator">=</span> activeSlide<span class="token punctuation">.</span>scrollHeight <span class="token operator">></span> activeSlide<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasVerticalScrollbar<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n   <span class="token comment">// 进入时重置滚动条</span>\n   activeSlide<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   activeSlide<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'scroll\'</span><span class="token punctuation">,</span> handleScroll<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token function">handleContainerWheel</span><span class="token punctuation">(</span>activeSlide<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 监听 swiper 的 onSlideChange 事件</span>\n<span class="token keyword">return</span> <span class="token punctuation">(</span>\n   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Swiper</span></span>\n      <span class="token attr-name">onSlideChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">slide</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         swiperRef<span class="token punctuation">.</span>current <span class="token operator">=</span> slide<span class="token punctuation">;</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>haveNestedScrollbar<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token function">handleScrollContainerEvent</span><span class="token punctuation">(</span>slide<span class="token punctuation">.</span>slides<span class="token punctuation">[</span>slide<span class="token punctuation">.</span>realIndex<span class="token punctuation">]</span> <span class="token keyword">as</span> ActiveSlide<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n   <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Swiper</span></span><span class="token punctuation">></span></span>\n<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="延迟滚动"><a href="#%E5%BB%B6%E8%BF%9F%E6%BB%9A%E5%8A%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>延迟滚动</h3>\n<p>具体代码见 <a href="https://github.com/towavephone/swiper/commit/c7daf2d123e4fdda385b69c1eaa636d876562ee3" target="_blank" rel="nofollow noreferrer noopener">这里</a></p>\n<h2 id="运行效果-5"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h2>\n<h3 id="延迟滚动-1"><a href="#%E5%BB%B6%E8%BF%9F%E6%BB%9A%E5%8A%A8-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>延迟滚动</h3>\n<!-- <iframe data-src="https://codesandbox.io/embed/n67jtt?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/x34hxw?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="懒加载"><a href="#%E6%87%92%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>懒加载</h1>\n<h2 id="需求背景-9"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h2>\n<p>需要对图片、视频进行懒加载</p>\n<h2 id="选型过程-6"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h2>\n<table>\n<thead>\n<tr>\n<th align="left">选型</th>\n<th align="left">优点</th>\n<th align="left">缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left"><a href="https://github.com/tuupola/lazyload" target="_blank" rel="nofollow noreferrer noopener">lazyload</a></td>\n<td align="left">支持 img 延迟加载</td>\n<td align="left">不支持 video 延迟加载</td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/aFarkas/lazysizes" target="_blank" rel="nofollow noreferrer noopener">lazysizes</a></td>\n<td align="left">支持 img、iframe 延迟加载</td>\n<td align="left">不支持 video 延迟加载</td>\n</tr>\n<tr>\n<td align="left"><a href="https://github.com/verlok/vanilla-lazyload" target="_blank" rel="nofollow noreferrer noopener">vanilla-lazyload</a></td>\n<td align="left"><a href="https://github.com/verlok/vanilla-lazyload#vanilla-lazyload-vs-lazysizes" target="_blank" rel="nofollow noreferrer noopener">优点</a></td>\n<td align="left">需要手动通知 dom 变化</td>\n</tr>\n</tbody>\n</table>\n<h2 id="实现难点"><a href="#%E5%AE%9E%E7%8E%B0%E9%9A%BE%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现难点</h2>\n<ol>\n<li>lazyloader 循环引用导致的报错、检测</li>\n<li>lazyloader 加载不同分辨率的图片（ahooks 的 useReponsive 封装有问题，需要自己重新封装）</li>\n<li>封装使用形式类似 react-spring 的 lazyloader</li>\n<li>动态监听 src/srcSet 实现同步</li>\n<li>需要封装各种使用形式的组件，为此需要合理组织文件结构，需要实现的功能大致如下</li>\n</ol>\n<table>\n  <thead>\n    <tr>\n      <th>UI 类型</th>\n      <th>平台</th>\n      <th>策略</th>\n      <th>详细说明</th>\n      <th>传递属性</th>\n      <th>代码示例</th>\n   </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td rowspan="9">视频</td>\n      <td rowspan="8">pc</td>\n      <td>自动播放</td>\n      <td>默认自动循环静音播放</td>\n      <td>playStrategy = \'autoPlay\'，默认不用传</td>\n      <td></td>\n    </tr>\n    <tr>\n      <td>点击播放</td>\n      <td>点击循环静音播放、带自定义播放图标</td>\n      <td>playStrategy = \'clickPlay\'</td>\n      <td></td>\n    </tr>\n    <tr>\n      <td>按住播放</td>\n      <td>按住循环播放、带自定义播放图标、带播放进度条显示</td>\n      <td>playStrategy = \'pressHoldPlay\'</td>\n      <td></td>\n    </tr>\n    <tr>\n      <td>点击视频弹窗播放</td>\n      <td>短视频自动循环静音播放，点击短视频后弹窗自动播放长视频一次</td>\n      <td>\n         <ol>\n            <li>传递 playStrategy = \'clickVideoModalPlay\'</li>\n            <li>原有的 srcSet、minSrcSet、src 控制短视频，这 3 个属性加上 long 前缀控制长视频，即 longSrcSet、longMinSrcSet、longSrc，如果不传 long 前缀属性则取短视频属性</li>\n            <li>通过 ref 控制弹窗打开，调用 videoRef.current?.openModal()</li>\n         </ol>\n      </td>\n      <td>\n         import { l, ClickVideoModalPlayRef } from &#x27;@/components/lazyLoader&#x27;\n         <br/>\n         <br/>\n         const videoRef = useRef&lt;ClickVideoModalPlayRef&gt;(null)\n         <br/>\n         <br/>\n         // 调用示例\n         useEffect(() =&gt; {\n            setTimeout(() =&gt; {\n               videoRef.current?.openModal()\n            }, 6000)\n         }, [])\n         <br/>\n         <br/>\n         &lt;l.video\n            ref={videoRef}\n            playStrategy=&quot;clickVideoModalPlay&quot;\n            src=&quot;/public/p7/xmart-os/p7-p6-1@short.mp4&quot;\n            longSrc=&quot;/public/p7/xmart-os/p7-p6-1@long.mp4&quot; // 不传则取 src\n         /&gt;\n      </td>\n    </tr>\n    <tr>\n      <td>悬停播放</td>\n      <td>鼠标悬浮循环静音播放视频，离开时回到初始状态</td>\n      <td>playStrategy = \'mouseOverPlay\'</td>\n      <td></td>\n    </tr>\n    <tr>\n      <td>进度控制</td>\n      <td>控制视频进度</td>\n      <td>playStrategy = \'progressControl\'，传递 progress（百分比，以 1 为单位）控制视频进度</td>\n      <td></td>\n    </tr>\n    <tr>\n      <td>点击播放（带控制条，播放状态控制）</td>\n      <td>点击后播放一次视频、自带控制条、初始播放状态控制</td>\n      <td>playStrategy = \'clickPlayWithControl\'，传递 playing 控制初始播放状态</td>\n      <td></td>\n    </tr>\n    <tr>\n      <td>进入视口播放一次</td>\n      <td>完全 100% 看到视频从头开始播放一次（每次看到视频就会触发）</td>\n      <td>playStrategy = \'inViewportPlay\'</td>\n      <td></td>\n    </tr>\n    <tr>\n      <td>h5</td>\n      <td>点击图片弹窗播放</td>\n      <td>\n         <ol>\n            <li>\n               图片展示，带自定义播放图标，如无图片则取原视频第一帧\n            </li>\n            <li>\n               点击自定义播放图标弹窗自动播放一次视频\n            </li>\n         </ol>\n      </td>\n      <td>\n         <ol>\n            <li>\n               传 srcSetPoster, srcPoster, minSrcSetPoster 作为封面图片，可以只传 srcPoster\n            </li>\n            <li>\n               默认 h5 使用此策略，不需要传 playStrategy（playStrategy === \'clickImgModalPlay\'）\n            </li>\n            <li>\n               如需覆盖请直接传具体的 playStrategy\n            </li>\n            <li>\n               需要保证播放图标可以点击，全屏视频有可能点击不到，需要把视频样式的 z-index 去掉\n            </li>\n            <li>\n               传递 playIconPosition 代表播放按钮位置\n            </li>\n            <li>\n               showPlayIcon 代表是否展示播放图标\n            </li>\n            <li>\n               通过 ref 控制弹窗打开，调用 videoRef.current?.openModal()\n            </li>\n         </ol>\n      </td>\n      <td></td>\n    </tr>\n    <tr>\n      <td rowspan="2">图片</td>\n      <td>pc</td>\n      <td>正常展示</td>\n      <td></td>\n      <td></td>\n      <td></td>\n    </tr>\n    <tr>\n      <td>h5</td>\n      <td>弹窗展示</td>\n      <td>点击弹窗后展示，等比例放大，宽度自适应（弹窗图片的左右切换实现难度大，之后再做）</td>\n      <td></td>\n      <td></td>\n    </tr>\n  </tbody>\n</table>\n<h2 id="运行效果-6"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h2>\n<!-- <iframe data-src="https://codesandbox.io/embed/etwmhs?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/nxsy6m?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="优化方向"><a href="#%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化方向</h2>\n<ol>\n<li>编译原理相关：利用 ts-morph、ts-morpher 自动导入 lazyloader 的 lazyElement 的 div、video、img 组件</li>\n<li>img 组件没有封装，复用之前的组件</li>\n</ol>\n<h1 id="弹窗-hook-封装"><a href="#%E5%BC%B9%E7%AA%97-hook-%E5%B0%81%E8%A3%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>弹窗 hook 封装</h1>\n<h2 id="需求背景-10"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-10" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h2>\n<p>由于需要实现大量弹窗展示的功能，为了尽量减少代码行数，提高复用性，这里采用 hooks 的方式去实现弹窗</p>\n<h2 id="usemodal-封装"><a href="#usemodal-%E5%B0%81%E8%A3%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>useModal 封装</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85209268342683700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, {\n   useRef,\n   forwardRef,\n   useState,\n   useImperativeHandle,\n   useCallback,\n   ComponentType,\n   PropsWithoutRef\n} from \'react\';\nimport { ModalProps, Modal } from \'antd\';\n\ntype ModalRefType<T> =\n   | {\n        open: (initProp?: Partial<T>) => void;\n        close: () => void;\n     }\n   | undefined;\n\ninterface UseModalProps<T> {\n   component: ComponentType<T>; // 子组件\n   modalProps?: Partial<ModalProps>; // 弹窗属性\n}\n\nconst useModal = function<T>({ component: Component, modalProps }: UseModalProps<T>) {\n   const modalRef = useRef<ModalRefType<T>>();\n   const [globalVisible, setGlobalVisible] = useState(false);\n\n   const ComponentModal = forwardRef<ModalRefType<T>, T>((componetProps, componentRef) => {\n      const [visible, setVisible] = useState(false);\n      const [componentInitProp, setComponentInitProp] = useState<Partial<T>>();\n\n      const handleOk = (initProps?: Partial<T>) => {\n         if (initProps) {\n            setComponentInitProp(initProps);\n         }\n         setVisible(true);\n         setGlobalVisible(true);\n      };\n\n      const handleCancel = () => {\n         setVisible(false);\n         setGlobalVisible(false);\n      };\n\n      useImperativeHandle(componentRef, () => ({\n         open: handleOk,\n         close: handleCancel\n      }));\n\n      return (\n         <Modal onCancel={handleCancel} visible={visible} {...modalProps}>\n            <Component onCancel={handleCancel} {...componetProps} {...componentInitProp} />\n         </Modal>\n      );\n   });\n\n   return {\n      Slot: useCallback((props: PropsWithoutRef<T>) => {\n         return <ComponentModal ref={modalRef} {...props} />;\n         // eslint-disable-next-line react-hooks/exhaustive-deps\n      }, []),\n      // 这里不能传 modalRef.current，因为传递的是引用\n      // 如果传的是 modalRef.current，会导致 modelRef.current 更新时不会同步更新到外部\n      api: modalRef,\n      visible: globalVisible\n   };\n};\n\nexport default useModal;`, `85209268342683700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n   useRef<span class="token punctuation">,</span>\n   forwardRef<span class="token punctuation">,</span>\n   useState<span class="token punctuation">,</span>\n   useImperativeHandle<span class="token punctuation">,</span>\n   useCallback<span class="token punctuation">,</span>\n   ComponentType<span class="token punctuation">,</span>\n   PropsWithoutRef\n<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> ModalProps<span class="token punctuation">,</span> Modal <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'antd\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">type</span> ModalRefType<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text"> =\n   | </span><span class="token punctuation">{</span>\n        open<span class="token punctuation">:</span> <span class="token punctuation">(</span>initProp<span class="token operator">?</span><span class="token punctuation">:</span> Partial<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">) => void;\n        close: () => void;\n     }\n   | undefined;\n\ninterface UseModalProps</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text"> </span><span class="token punctuation">{</span>\n   component<span class="token punctuation">:</span> ComponentType<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">; // 子组件\n   modalProps?: Partial</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ModalProps</span></span><span class="token punctuation">></span></span><span class="token plain-text">; // 弹窗属性\n}\n\nconst useModal = function</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">(</span><span class="token punctuation">{</span> component<span class="token punctuation">:</span> Component<span class="token punctuation">,</span> modalProps <span class="token punctuation">}</span><span class="token plain-text">: UseModalProps</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">) </span><span class="token punctuation">{</span>\n   <span class="token keyword">const</span> modalRef <span class="token operator">=</span> useRef<span class="token operator">&lt;</span>ModalRefType<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">>();\n   const [globalVisible, setGlobalVisible] = useState(false);\n\n   const ComponentModal = forwardRef&lt;ModalRefType</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">, T>((componetProps, componentRef) => </span><span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token punctuation">[</span>visible<span class="token punctuation">,</span> setVisible<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> <span class="token punctuation">[</span>componentInitProp<span class="token punctuation">,</span> setComponentInitProp<span class="token punctuation">]</span> <span class="token operator">=</span> useState<span class="token operator">&lt;</span>Partial<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">>();\n\n      const handleOk = (initProps?: Partial</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">) => </span><span class="token punctuation">{</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>initProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token function">setComponentInitProp</span><span class="token punctuation">(</span>initProps<span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n         <span class="token function">setVisible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token function">setGlobalVisible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token plain-text">;\n\n      const handleCancel = () => </span><span class="token punctuation">{</span>\n         <span class="token function">setVisible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         <span class="token function">setGlobalVisible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token plain-text">;\n\n      useImperativeHandle(componentRef, () => (</span><span class="token punctuation">{</span>\n         open<span class="token punctuation">:</span> handleOk<span class="token punctuation">,</span>\n         close<span class="token punctuation">:</span> handleCancel\n      <span class="token punctuation">}</span><span class="token plain-text">));\n\n      return (\n         </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Modal</span></span> <span class="token attr-name">onCancel</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleCancel<span class="token punctuation">}</span></span> <span class="token attr-name">visible</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>visible<span class="token punctuation">}</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">modalProps</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Component</span></span> <span class="token attr-name">onCancel</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleCancel<span class="token punctuation">}</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">componetProps</span><span class="token punctuation">}</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">componentInitProp</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">\n         </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Modal</span></span><span class="token punctuation">></span></span><span class="token plain-text">\n      );\n   });\n\n   return </span><span class="token punctuation">{</span>\n      Slot<span class="token punctuation">:</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span>props<span class="token punctuation">:</span> PropsWithoutRef<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">) => </span><span class="token punctuation">{</span>\n         <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ComponentModal</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>modalRef<span class="token punctuation">}</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">props</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>\n         <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n      <span class="token punctuation">}</span><span class="token plain-text">, []),\n      // 这里不能传 modalRef.current，因为传递的是引用\n      // 如果传的是 modalRef.current，会导致 modelRef.current 更新时不会同步更新到外部\n      api: modalRef,\n      visible: globalVisible\n   };\n};\n\nexport default useModal;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="usedisplayermodal-封装"><a href="#usedisplayermodal-%E5%B0%81%E8%A3%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>useDisplayerModal 封装</h2>\n<p>弹窗有一些公用属性，需要再次分层便于复用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26949110953911992000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { ComponentType } from \'react\';\n\nimport useModal from \'@/hooks/useModal\';\n\nimport styles from \'./index.module.less\';\n\nconst useDisplayerModal = function<T>(Component: ComponentType<T>) {\n   const result = useModal({\n      component: Component,\n      modalProps: {\n         className: styles.modal,\n         wrapClassName: styles.wrapClassName,\n         closable: false,\n         footer: null,\n         // 这里 destroyOnClose 设置 true 的原因是：swiper 需要销毁，否则导致 swiper 卡住的 bug\n         destroyOnClose: true,\n         centered: false\n      }\n   });\n   return result;\n};\n\nexport default useDisplayerModal;`, `26949110953911992000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> ComponentType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> useModal <span class="token keyword">from</span> <span class="token string">\'@/hooks/useModal\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./index.module.less\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">useDisplayerModal</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">(Component: ComponentType</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">T</span></span><span class="token punctuation">></span></span><span class="token plain-text">) </span><span class="token punctuation">{</span>\n   <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">useModal</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      component<span class="token punctuation">:</span> Component<span class="token punctuation">,</span>\n      modalProps<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n         className<span class="token punctuation">:</span> styles<span class="token punctuation">.</span>modal<span class="token punctuation">,</span>\n         wrapClassName<span class="token punctuation">:</span> styles<span class="token punctuation">.</span>wrapClassName<span class="token punctuation">,</span>\n         closable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n         footer<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n         <span class="token comment">// 这里 destroyOnClose 设置 true 的原因是：swiper 需要销毁，否则导致 swiper 卡住的 bug</span>\n         destroyOnClose<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n         centered<span class="token punctuation">:</span> <span class="token boolean">false</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">return</span> result<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token plain-text">;\n\nexport default useDisplayerModal;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="运行效果-7"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h2>\n<!-- <iframe data-src="https://codesandbox.io/embed/9pxwy5?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/whshqm?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h1 id="其他"><a href="#%E5%85%B6%E4%BB%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其他</h1>\n<h2 id="loadscript-优化"><a href="#loadscript-%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>loadScript 优化</h2>\n<h3 id="需求背景-11"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-11" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>需要有一个方法来手动加载脚本，延迟脚本加载的时机</p>\n<h3 id="优化过程"><a href="#%E4%BC%98%E5%8C%96%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化过程</h3>\n<ol>\n<li>生成唯一性的 uuid 来判断这个脚本是否加载，以实现只加载一次脚本的功能</li>\n<li>由于 loadScript 方法会在同一个页面同一 src 多次调用，实际上判断脚本是否加载并不能完美实现（会导致同一脚本多次加载），考虑使用函数缓存实现</li>\n</ol>\n<h3 id="核心代码-9"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32516847763356393000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { memoize } from \'lodash\';\n\ntype loadScriptOptions = Partial<Omit<HTMLScriptElement, \'src\' | \'async\'>> & {\n   attributesMap?: {\n      [key: string]: any;\n   };\n   [key: string]: any;\n};\n\n// 异步加载单个脚本\nasync function loadSingleScript(src: string, options: loadScriptOptions = {}) {\n   return await new Promise((resolve, reject) => {\n      // 这里未考虑到同一 src 同时发起的情况，改用缓存实现\n      // if (!id) {\n      //   const NAMESPACE = \'c2b16a16-12b3-423a-879f-6b46d1a01d60\'\n      //   const PREFIX = \'script-id-\'\n      //   id = PREFIX + uuidv5(src, NAMESPACE)\n      // }\n      // if (!src || document.querySelector(\\`#\\${id}\\`)) {\n      //   return\n      // }\n      const script: any = document.createElement(\'script\');\n      const { attributesMap = {}, ...rest } = options;\n      Object.keys(rest).forEach((key) => {\n         script[key] = rest[key];\n      });\n      Object.keys(attributesMap).forEach((key) => {\n         script.setAttribute(key, attributesMap[key]);\n      });\n      script.async = true;\n      script.src = src;\n      script.onload = resolve;\n      script.onerror = reject;\n      document.getElementsByTagName(\'head\')[0].appendChild(script);\n   });\n}\n\n// 异步加载多个脚本\n// memoize 默认情况下用第一个参数作为缓存的 key，即 src\nexport const loadScript = memoize(loadSingleScript);`, `32516847763356393000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> memoize <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">type</span> loadScriptOptions <span class="token operator">=</span> Partial<span class="token operator">&lt;</span>Omit<span class="token operator">&lt;</span>HTMLScriptElement<span class="token punctuation">,</span> <span class="token string">\'src\'</span> <span class="token operator">|</span> <span class="token string">\'async\'</span><span class="token operator">>></span> <span class="token operator">&amp;</span> <span class="token punctuation">{</span>\n   attributesMap<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      <span class="token punctuation">[</span>key<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">;</span>\n   <span class="token punctuation">[</span>key<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 异步加载单个脚本</span>\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">loadSingleScript</span><span class="token punctuation">(</span><span class="token parameter">src<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> options<span class="token punctuation">:</span> loadScriptOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// 这里未考虑到同一 src 同时发起的情况，改用缓存实现</span>\n      <span class="token comment">// if (!id) {</span>\n      <span class="token comment">//   const NAMESPACE = \'c2b16a16-12b3-423a-879f-6b46d1a01d60\'</span>\n      <span class="token comment">//   const PREFIX = \'script-id-\'</span>\n      <span class="token comment">//   id = PREFIX + uuidv5(src, NAMESPACE)</span>\n      <span class="token comment">// }</span>\n      <span class="token comment">// if (!src || document.querySelector(`#${id}`)) {</span>\n      <span class="token comment">//   return</span>\n      <span class="token comment">// }</span>\n      <span class="token keyword">const</span> script<span class="token punctuation">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'script\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span> attributesMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>\n      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>rest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         script<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> rest<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>attributesMap<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n         script<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> attributesMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      script<span class="token punctuation">.</span><span class="token keyword">async</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n      script<span class="token punctuation">.</span>src <span class="token operator">=</span> src<span class="token punctuation">;</span>\n      script<span class="token punctuation">.</span>onload <span class="token operator">=</span> resolve<span class="token punctuation">;</span>\n      script<span class="token punctuation">.</span>onerror <span class="token operator">=</span> reject<span class="token punctuation">;</span>\n      document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">\'head\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 异步加载多个脚本</span>\n<span class="token comment">// memoize 默认情况下用第一个参数作为缓存的 key，即 src</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> loadScript <span class="token operator">=</span> <span class="token function">memoize</span><span class="token punctuation">(</span>loadSingleScript<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="视频播放进度控制失效"><a href="#%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E8%BF%9B%E5%BA%A6%E6%8E%A7%E5%88%B6%E5%A4%B1%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>视频播放进度控制失效</h2>\n<p>对于长视频，<code class="language-text">domRef.current.currentTime = 0</code> 方法失效，需要对服务器配置，具体见<a href="https://stackoverflow.com/questions/4360060/video-streaming-with-html-5-via-node-js#18241169" target="_blank" rel="nofollow noreferrer noopener">这里</a></p>\n<h2 id="usescrolldirection-封装"><a href="#usescrolldirection-%E5%B0%81%E8%A3%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>useScrollDirection 封装</h2>\n<h3 id="需求背景-12"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-12" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>需要知道页面的向上、向下滚动来实现特定需求</p>\n<h3 id="实现要点"><a href="#%E5%AE%9E%E7%8E%B0%E8%A6%81%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现要点</h3>\n<p>使用 ahooks 的 useScroll、usePrevious、useThrottle，来分别实现得到当前滚动信息、得到前一个滚动信息、性能优化的节流处理的功能</p>\n<h3 id="核心代码-10"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-10" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<p>web/hooks/useScrollDirection.ts</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39390949414687510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useScroll, usePrevious, useThrottle } from \'ahooks\'\nimport type { Target, ScrollListenController } from \'ahooks/lib/useScroll\'\nimport type { ThrottleOptions } from \'ahooks/lib/useThrottle/throttleOptions\'\n\ninterface UseScrollDirectionResult {\n  leftDelta: number\n  topDelta: number\n  scrollXDirection?: \'left\' | \'right\'\n  scrollYDirection?: \'up\' | \'down\'\n  left: number\n  top: number\n}\n\nconst useScrollDirection = (target: Target, shouldUpdate?: ScrollListenController, options: ThrottleOptions & { enable: boolean } = {\n  enable: false,\n  wait: 300,\n  leading: true,\n  trailing: true\n}): UseScrollDirectionResult => {\n  const position = useScroll(target, shouldUpdate)\n  const prevPosition = usePrevious(position)\n\n  const throttledPosition = useThrottle(position, options)\n  const throttledPrevPosition = useThrottle(prevPosition, options)\n\n  const newPosition = options.enable ? throttledPosition : position\n  const newPrevPosition = options.enable ? throttledPrevPosition : prevPosition\n\n  if (!newPosition || !newPrevPosition) {\n    return {\n      leftDelta: 0,\n      topDelta: 0,\n      left: 0,\n      top: 0\n    }\n  }\n\n  const leftDelta = newPosition.left - newPrevPosition.left\n  const topDelta = newPosition.top - newPrevPosition.top\n\n  const scrollXDirection = leftDelta > 0 ? \'right\' : \'left\'\n  const scrollYDirection = topDelta > 0 ? \'down\' : \'up\'\n\n  // console.log(\'throttledPosition\', newPosition, newPrevPosition)\n\n  return {\n    leftDelta,\n    topDelta,\n    scrollXDirection,\n    scrollYDirection,\n    left: newPosition.left,\n    top: newPosition.top\n  }\n}\n\nexport default useScrollDirection`, `39390949414687510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> useScroll<span class="token punctuation">,</span> usePrevious<span class="token punctuation">,</span> useThrottle <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks\'</span>\n<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> Target<span class="token punctuation">,</span> ScrollListenController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks/lib/useScroll\'</span>\n<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> ThrottleOptions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'ahooks/lib/useThrottle/throttleOptions\'</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">UseScrollDirectionResult</span> <span class="token punctuation">{</span>\n  leftDelta<span class="token punctuation">:</span> <span class="token builtin">number</span>\n  topDelta<span class="token punctuation">:</span> <span class="token builtin">number</span>\n  scrollXDirection<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">\'left\'</span> <span class="token operator">|</span> <span class="token string">\'right\'</span>\n  scrollYDirection<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">\'up\'</span> <span class="token operator">|</span> <span class="token string">\'down\'</span>\n  left<span class="token punctuation">:</span> <span class="token builtin">number</span>\n  top<span class="token punctuation">:</span> <span class="token builtin">number</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> useScrollDirection <span class="token operator">=</span> <span class="token punctuation">(</span>target<span class="token punctuation">:</span> Target<span class="token punctuation">,</span> shouldUpdate<span class="token operator">?</span><span class="token punctuation">:</span> ScrollListenController<span class="token punctuation">,</span> options<span class="token punctuation">:</span> ThrottleOptions <span class="token operator">&amp;</span> <span class="token punctuation">{</span> enable<span class="token punctuation">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n  enable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n  wait<span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>\n  leading<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  trailing<span class="token punctuation">:</span> <span class="token boolean">true</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token parameter">UseScrollDirectionResult</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> position <span class="token operator">=</span> <span class="token function">useScroll</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> shouldUpdate<span class="token punctuation">)</span>\n  <span class="token keyword">const</span> prevPosition <span class="token operator">=</span> <span class="token function">usePrevious</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> throttledPosition <span class="token operator">=</span> <span class="token function">useThrottle</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> options<span class="token punctuation">)</span>\n  <span class="token keyword">const</span> throttledPrevPosition <span class="token operator">=</span> <span class="token function">useThrottle</span><span class="token punctuation">(</span>prevPosition<span class="token punctuation">,</span> options<span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> newPosition <span class="token operator">=</span> options<span class="token punctuation">.</span>enable <span class="token operator">?</span> throttledPosition <span class="token punctuation">:</span> position\n  <span class="token keyword">const</span> newPrevPosition <span class="token operator">=</span> options<span class="token punctuation">.</span>enable <span class="token operator">?</span> throttledPrevPosition <span class="token punctuation">:</span> prevPosition\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newPosition <span class="token operator">||</span> <span class="token operator">!</span>newPrevPosition<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">{</span>\n      leftDelta<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n      topDelta<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n      left<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n      top<span class="token punctuation">:</span> <span class="token number">0</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> leftDelta <span class="token operator">=</span> newPosition<span class="token punctuation">.</span>left <span class="token operator">-</span> newPrevPosition<span class="token punctuation">.</span>left\n  <span class="token keyword">const</span> topDelta <span class="token operator">=</span> newPosition<span class="token punctuation">.</span>top <span class="token operator">-</span> newPrevPosition<span class="token punctuation">.</span>top\n\n  <span class="token keyword">const</span> scrollXDirection <span class="token operator">=</span> leftDelta <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">\'right\'</span> <span class="token punctuation">:</span> <span class="token string">\'left\'</span>\n  <span class="token keyword">const</span> scrollYDirection <span class="token operator">=</span> topDelta <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">\'down\'</span> <span class="token punctuation">:</span> <span class="token string">\'up\'</span>\n\n  <span class="token comment">// console.log(\'throttledPosition\', newPosition, newPrevPosition)</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    leftDelta<span class="token punctuation">,</span>\n    topDelta<span class="token punctuation">,</span>\n    scrollXDirection<span class="token punctuation">,</span>\n    scrollYDirection<span class="token punctuation">,</span>\n    left<span class="token punctuation">:</span> newPosition<span class="token punctuation">.</span>left<span class="token punctuation">,</span>\n    top<span class="token punctuation">:</span> newPosition<span class="token punctuation">.</span>top\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> useScrollDirection</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行效果-8"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<!-- <iframe data-src="https://codesandbox.io/embed/sb4gnr?codemirror=1&hidenavigation=1&theme=light&view=preview" class="embedded-codesandbox" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe> --><html><head></head><body></body></html>\n<p><html><head></head><body><iframe data-src="https://codesandbox.io/embed/shsntv?codemirror=1&amp;hidenavigation=1&amp;theme=light&amp;view=preview" class="embedded-codesandbox lazy" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin allow-downloads"></iframe></body></html></p>\n<h2 id="set-cookie-失效"><a href="#set-cookie-%E5%A4%B1%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>set-cookie 失效</h2>\n<p>UC 浏览器下服务器端设置 set-cookie 失效即 csrf token 设置失败，进而接口请求失败，原因未知</p>\n<p>// TODO set-cookie 失效待解决</p>\n<h2 id="子级滚动、父级不滚动"><a href="#%E5%AD%90%E7%BA%A7%E6%BB%9A%E5%8A%A8%E3%80%81%E7%88%B6%E7%BA%A7%E4%B8%8D%E6%BB%9A%E5%8A%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>子级滚动、父级不滚动</h2>\n<h3 id="需求背景-13"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-13" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>打开弹窗时此时有半透明遮罩，弹窗内是有滚动条的，此时弹窗的滚动条的滚动会牵连外面滚动条的滚动</p>\n<h3 id="解决过程"><a href="#%E8%A7%A3%E5%86%B3%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决过程</h3>\n<ol>\n<li>css：<code class="language-text">overscroll-behavior: contain</code>，但是在移动端 safari 不支持</li>\n<li>js：在不支持 css 的方法时，降级处理</li>\n</ol>\n<h3 id="核心代码-11"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-11" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22766568186429125000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export function enableBodyScroll() {\n   if (document.readyState === \'complete\') {\n      document.body.style.position = \'\';\n      document.body.style.overflowY = \'\';\n\n      if (document.body.style.marginTop) {\n         const scrollTop = -parseInt(document.body.style.marginTop, 10);\n         document.body.style.marginTop = \'\';\n         window.scrollTo({\n            left: window.pageXOffset,\n            top: scrollTop,\n            behavior: \'instant\' // 关闭动画\n         });\n      }\n   } else {\n      window.addEventListener(\'load\', enableBodyScroll);\n   }\n}\n\nexport function disableBodyScroll({ savePosition = false } = {}) {\n   if (document.readyState === \'complete\') {\n      if (document.body.scrollHeight > window.innerHeight) {\n         if (savePosition) document.body.style.marginTop = \\`-\\${window.pageYOffset}px\\`;\n         document.body.style.position = \'fixed\';\n         document.body.style.overflowY = \'scroll\';\n      }\n   } else {\n      window.addEventListener(\'load\', () => disableBodyScroll({ savePosition }));\n   }\n}`, `22766568186429125000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">enableBodyScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token string">\'complete\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>overflowY <span class="token operator">=</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>marginTop<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">const</span> scrollTop <span class="token operator">=</span> <span class="token operator">-</span><span class="token function">parseInt</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>marginTop<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n         document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>marginTop <span class="token operator">=</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n         window<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            left<span class="token punctuation">:</span> window<span class="token punctuation">.</span>pageXOffset<span class="token punctuation">,</span>\n            top<span class="token punctuation">:</span> scrollTop<span class="token punctuation">,</span>\n            behavior<span class="token punctuation">:</span> <span class="token string">\'instant\'</span> <span class="token comment">// 关闭动画</span>\n         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'load\'</span><span class="token punctuation">,</span> enableBodyScroll<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">disableBodyScroll</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> savePosition <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token string">\'complete\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollHeight <span class="token operator">></span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>savePosition<span class="token punctuation">)</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>marginTop <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>pageYOffset<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n         document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token string">\'fixed\'</span><span class="token punctuation">;</span>\n         document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>overflowY <span class="token operator">=</span> <span class="token string">\'scroll\'</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'load\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">disableBodyScroll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> savePosition <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="进度转换函数"><a href="#%E8%BF%9B%E5%BA%A6%E8%BD%AC%E6%8D%A2%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>进度转换函数</h2>\n<h3 id="需求背景-14"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-14" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<ol>\n<li>页面固定动效多次用到百分比转换，需要封装函数便于使用、理解</li>\n<li>后期可能会实现缓动函数，需要提前封装便于修改</li>\n</ol>\n<h3 id="核心代码-12"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-12" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97582921794470610000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`interface GetAnimateProgressProps {\n   progress: number;\n   start: number;\n   duration: number;\n}\n\n// 获取单个进度\nexport const getAnimateProgress = ({ progress, start, duration }: GetAnimateProgressProps) =>\n   (progress - start) / duration;\n\ntype GetAnimateProgressesOptions = Omit<GetAnimateProgressProps, \'progress\'>;\n\n// 获取多个进度\nexport const getAnimateProgresses = (progress: number, options: GetAnimateProgressesOptions[]) =>\n   options.map(({ start, duration }) =>\n      getAnimateProgress({\n         progress,\n         start,\n         duration\n      })\n   );`, `97582921794470610000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts"\n              >\n                <span class="gatsby-code-button-language">ts</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">interface</span> <span class="token class-name">GetAnimateProgressProps</span> <span class="token punctuation">{</span>\n   progress<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n   start<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n   duration<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 获取单个进度</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getAnimateProgress</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> progress<span class="token punctuation">,</span> start<span class="token punctuation">,</span> duration <span class="token punctuation">}</span><span class="token punctuation">:</span> GetAnimateProgressProps</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   <span class="token punctuation">(</span>progress <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> duration<span class="token punctuation">;</span>\n\n<span class="token keyword">type</span> GetAnimateProgressesOptions <span class="token operator">=</span> Omit<span class="token operator">&lt;</span>GetAnimateProgressProps<span class="token punctuation">,</span> <span class="token string">\'progress\'</span><span class="token operator">></span><span class="token punctuation">;</span>\n\n<span class="token comment">// 获取多个进度</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getAnimateProgresses</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">progress<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> options<span class="token punctuation">:</span> GetAnimateProgressesOptions<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   options<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> start<span class="token punctuation">,</span> duration <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span>\n      <span class="token function">getAnimateProgress</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n         progress<span class="token punctuation">,</span>\n         start<span class="token punctuation">,</span>\n         duration\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="cdn-链接替换"><a href="#cdn-%E9%93%BE%E6%8E%A5%E6%9B%BF%E6%8D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>cdn 链接替换</h2>\n<h3 id="需求背景-15"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-15" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>public 下的所有文件都需要放到 cdn，减少服务器的压力同时访问速度更快，即要对所有前缀为 /public 的资源路径做替换</p>\n<h3 id="选型过程-7"><a href="#%E9%80%89%E5%9E%8B%E8%BF%87%E7%A8%8B-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选型过程</h3>\n<ol>\n<li>动态变量：在 midway 后端设置可读变量然后注入到前端 window 变量中，但是不能解决 midway、css 的前缀问题</li>\n<li>静态替换：在 build 阶段对所有的 /public 替换，但是目前运维不支持，运维只在 dev 环境中才能 build，需要运维解决</li>\n<li>静态资源 hash 处理：需要由 webpack 接管去处理</li>\n</ol>\n<h3 id="核心代码-13"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-13" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<p>以下是 <code class="language-text">静态替换</code> 的核心代码，见标红部分的核心代码</p>\n<p>scripts/build.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78476785381596870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const shelljs = require(\'shelljs\');\nconst fsExtra = require(\'fs-extra\');\nconst path = require(\'path\');\nconst fs = require(\'fs\');\nconst packageJson = require(\'../package.json\');\nconst glob = require(\'glob\');\nconst { merge } = require(\'lodash\');\n\nlet config = require(\'../dist/config/config.default\');\nconst ENV = process.env.EGG_SERVER_ENV || \'prod\';\nconst fakeConfigParams = {\n   name: \'\',\n   appDir: \'\'\n};\nconst configPath = \\`../dist/config/config.\\${ENV}.js\\`;\n// console.log(\'ENV\', ENV)\nif (fs.existsSync(path.resolve(__dirname, configPath))) {\n   config = merge(config.default(fakeConfigParams), require(configPath).default(fakeConfigParams));\n}\n\nconsole.log(\'Start handle source...\');\n\nfsExtra.mkdirpSync(path.resolve(__dirname, \'../deploy\'), { overwrite: true });\nfsExtra.copySync(path.resolve(__dirname, \'../public\'), path.resolve(__dirname, \'../deploy/public\'), {\n   overwrite: true\n});\n\ndelete packageJson.devDependencies;\ndelete packageJson.scripts.preinstall;\n\nfs.writeFileSync(path.resolve(__dirname, \'../deploy/package.json\'), JSON.stringify(packageJson));\n\n// 暂时不需要处理异步加载的资源\n// const assetManifest = require(\'../build/client/asset-manifest.json\')\n// const runtimePagePath = path.resolve(\n//   __dirname,\n//   \'../build\' + assetManifest[\'runtime~Page.js\'].replace(\'/public\', \'\')\n// )\n\n// const runtimePage = fs.readFileSync(runtimePagePath).toString()\n\n// // 替换 webpack 打包的资源路径前缀\n// fs.writeFileSync(\n//   runtimePagePath,\n//   runtimePage.replace(/&quot;\\/public\\//g, \'window.__publicPath+&quot;/public/\')\n// )\n\nconst assetManifest = require(\'../build/client/asset-manifest.json\');\nconst runtimePagePath = assetManifest[\'runtime~Page.js\'].replace(\'/public\', \'build\');\n// console.log(\'runtimePagePath\', runtimePagePath)\n\nconst replacePrefixFiles = [\n   ...glob.sync(\'build/{client,server}/**/*.{js,css}\'),\n   ...glob.sync(\'dist/config/{menu,site}/**/*.js\')\n].filter((item) => item !== runtimePagePath);\nconst newPublicPath = config.publicPath || \'\';\nconst publicPath = newPublicPath.endsWith(\'/\') ? newPublicPath + \'public/\' : newPublicPath + \'/public/\';\n// console.log(\'publicPath\', publicPath)\nreplacePrefixFiles.forEach(function(file) {\n   const fileContent = fs.readFileSync(file).toString();\n   if (config.publicPath) {\n      fs.writeFileSync(file, fileContent.replace(/\\/public\\//g, publicPath));\n   }\n});\n\nfsExtra.moveSync(path.resolve(__dirname, \'../build\'), path.resolve(__dirname, \'../deploy/build\'), { overwrite: true });\n\nif (fs.existsSync(path.resolve(__dirname, \'../dist\'))) {\n   fsExtra.moveSync(path.resolve(__dirname, \'../dist\'), path.resolve(__dirname, \'../deploy/dist\'), { overwrite: true });\n}\n\nfsExtra.moveSync(path.resolve(__dirname, \'../deploy\'), path.resolve(__dirname, \'../dist\'), { overwrite: true });\n\nglob.sync(path.resolve(__dirname, \'../dist/**/*.map\')).forEach(function(file) {\n   fs.unlinkSync(file);\n});\n\nfsExtra.mkdirpSync(path.resolve(__dirname, \'../dist/node_modules\'), {\n   overwrite: true\n});\n\nshelljs.exec(\'cp -r node_modules/xp-react-scrollmagic dist/node_modules/xp-react-scrollmagic\');`, `78476785381596870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="ts{48-64}"\n              >\n                <span class="gatsby-code-button-language">ts{48-64}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">const</span> shelljs <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'shelljs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fsExtra <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'fs-extra\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> packageJson <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'../package.json\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> glob <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'glob\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> merge <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'../dist/config/config.default\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token constant">ENV</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">EGG_SERVER_ENV</span> <span class="token operator">||</span> <span class="token string">\'prod\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fakeConfigParams <span class="token operator">=</span> <span class="token punctuation">{</span>\n   name<span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token punctuation">,</span>\n   appDir<span class="token punctuation">:</span> <span class="token string">\'\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> configPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../dist/config/config.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">ENV</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n<span class="token comment">// console.log(\'ENV\', ENV)</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> configPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   config <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">(</span>fakeConfigParams<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">require</span><span class="token punctuation">(</span>configPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">(</span>fakeConfigParams<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'Start handle source...\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nfsExtra<span class="token punctuation">.</span><span class="token function">mkdirpSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../deploy\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> overwrite<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nfsExtra<span class="token punctuation">.</span><span class="token function">copySync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../public\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../deploy/public\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n   overwrite<span class="token punctuation">:</span> <span class="token boolean">true</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">delete</span> packageJson<span class="token punctuation">.</span>devDependencies<span class="token punctuation">;</span>\n<span class="token keyword">delete</span> packageJson<span class="token punctuation">.</span>scripts<span class="token punctuation">.</span>preinstall<span class="token punctuation">;</span>\n\nfs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../deploy/package.json\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>packageJson<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 暂时不需要处理异步加载的资源</span>\n<span class="token comment">// const assetManifest = require(\'../build/client/asset-manifest.json\')</span>\n<span class="token comment">// const runtimePagePath = path.resolve(</span>\n<span class="token comment">//   __dirname,</span>\n<span class="token comment">//   \'../build\' + assetManifest[\'runtime~Page.js\'].replace(\'/public\', \'\')</span>\n<span class="token comment">// )</span>\n\n<span class="token comment">// const runtimePage = fs.readFileSync(runtimePagePath).toString()</span>\n\n<span class="token comment">// // 替换 webpack 打包的资源路径前缀</span>\n<span class="token comment">// fs.writeFileSync(</span>\n<span class="token comment">//   runtimePagePath,</span>\n<span class="token comment">//   runtimePage.replace(/"\\/public\\//g, \'window.__publicPath+"/public/\')</span>\n<span class="token comment">// )</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> assetManifest <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">\'../build/client/asset-manifest.json\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> runtimePagePath <span class="token operator">=</span> assetManifest<span class="token punctuation">[</span><span class="token string">\'runtime~Page.js\'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'/public\'</span><span class="token punctuation">,</span> <span class="token string">\'build\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// console.log(\'runtimePagePath\', runtimePagePath)</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> replacePrefixFiles <span class="token operator">=</span> <span class="token punctuation">[</span></span><span class="gatsby-highlight-code-line">   <span class="token operator">...</span>glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">\'build/{client,server}/**/*.{js,css}\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">   <span class="token operator">...</span>glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">\'dist/config/{menu,site}/**/*.js\'</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item <span class="token operator">!==</span> runtimePagePath<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> newPublicPath <span class="token operator">=</span> config<span class="token punctuation">.</span>publicPath <span class="token operator">||</span> <span class="token string">\'\'</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> publicPath <span class="token operator">=</span> newPublicPath<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">\'/\'</span><span class="token punctuation">)</span> <span class="token operator">?</span> newPublicPath <span class="token operator">+</span> <span class="token string">\'public/\'</span> <span class="token punctuation">:</span> newPublicPath <span class="token operator">+</span> <span class="token string">\'/public/\'</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token comment">// console.log(\'publicPath\', publicPath)</span></span><span class="gatsby-highlight-code-line">replacePrefixFiles<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">   <span class="token keyword">const</span> fileContent <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">   <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>publicPath<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> fileContent<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\/public\\//g</span><span class="token punctuation">,</span> publicPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">   <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\nfsExtra<span class="token punctuation">.</span><span class="token function">moveSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../build\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../deploy/build\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> overwrite<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../dist\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   fsExtra<span class="token punctuation">.</span><span class="token function">moveSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../dist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../deploy/dist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> overwrite<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nfsExtra<span class="token punctuation">.</span><span class="token function">moveSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../deploy\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../dist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> overwrite<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nglob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../dist/**/*.map\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nfsExtra<span class="token punctuation">.</span><span class="token function">mkdirpSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">\'../dist/node_modules\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n   overwrite<span class="token punctuation">:</span> <span class="token boolean">true</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nshelljs<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">\'cp -r node_modules/xp-react-scrollmagic dist/node_modules/xp-react-scrollmagic\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="dangerouslysetinnerhtml-编译更新失效"><a href="#dangerouslysetinnerhtml-%E7%BC%96%E8%AF%91%E6%9B%B4%E6%96%B0%E5%A4%B1%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dangerouslySetInnerHTML 编译更新失效</h2>\n<h3 id="需求背景-16"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF-16" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h3>\n<p>使用了 dangerouslySetInnerHTML 渲染的富文本组件，在编译之后不生效</p>\n<h3 id="核心代码-14"><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-14" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心代码</h3>\n<p>web/components/htmlComponent/index.tsx</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60948252769545870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { ReactNode } from \'react\';\n\ninterface HtmlComponentProps {\n   children: ReactNode;\n   className?: string;\n}\n\nconst HtmlComponent = ({ children, className }: HtmlComponentProps) =>\n   typeof children === \'string\' ? (\n      // key={Math.random()} 必须设置，否则 props 不会更新，导致热更新失败\n      <div className={className} key={Math.random()} dangerouslySetInnerHTML={{ __html: children }} />\n   ) : (\n      <div className={className}>{children}</div>\n   );\n\nexport default HtmlComponent;`, `60948252769545870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="tsx"\n              >\n                <span class="gatsby-code-button-language">tsx</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> ReactNode <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">interface</span> <span class="token class-name">HtmlComponentProps</span> <span class="token punctuation">{</span>\n   children<span class="token punctuation">:</span> ReactNode<span class="token punctuation">;</span>\n   className<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">HtmlComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children<span class="token punctuation">,</span> className <span class="token punctuation">}</span><span class="token punctuation">:</span> HtmlComponentProps</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n   <span class="token keyword">typeof</span> children <span class="token operator">===</span> <span class="token string">\'string\'</span> <span class="token operator">?</span> <span class="token punctuation">(</span>\n      <span class="token comment">// key={Math.random()} 必须设置，否则 props 不会更新，导致热更新失败</span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>className<span class="token punctuation">}</span></span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token attr-name">dangerouslySetInnerHTML</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> __html<span class="token punctuation">:</span> children <span class="token punctuation">}</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>\n   <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>className<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n   <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> HtmlComponent<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>',
excerpt:"需求背景 完成官网 1.0 的上线，实现动效、国际化、多平台适配等功能 动效 逐行显示 需求背景 实现功能如下： x 旋转 -> 不同文字由下而上透明度从 0 到 1 实现要点如下： 进入视口执行一次 离开视口重置动画 实现如下所示动效： 选型过程 选型 优点 缺点 react…",frontmatter:{date:"2022-12-16 17:26:58",path:"/international-official-website-technical-difficulties/",tags:"前端, 国际官网, 预研",title:"国际官网技术难点攻关",draft:null}},prePost:{html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>接上文 <a href="/cra-project-build-speed-optimize/">CRA 项目构建速度优化</a></p>\n<p>由下图可以看出此项目的 <code class="language-text">Clone Repo</code>，<code class="language-text">Scp to build_node</code> 耗时较长，需要优化</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-12-16-19-28-35-ac103b5f8619d4f07254b7bba39ea5e1-0f56a.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 34.19047619047619%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABL0lEQVQY01WQDW+DIBCG/f8/b9lWPwoCWhCpiijyUYq7dsmSXd5c7oG7lxzFsmrCqJDD88ygfObzPN/F+dYL8xt/z/8yRHH+j8MdYhAhBrNtZjMhRvB13i96meYpPqK6333wq1lHpQowSTkba7Ux23FMi/4uy1nrbbfbvgOWdb0sWipF+ttuj55zva6DHFtKCzfNinUSozshd0pvtMHXT0Yq3iPRXVtcoearpxUldd1UrK2vzQfFF94h0aMCXpjmZRA8BJ9TYpZfthYdHUuSpqF1fWkwIBSt67Drq71FtiNRkMiLydhhXvWqQ3rAx3RuLHeKHWdZsafCTjRHjz3HXiDIjteWoeMGV6AiPhNsK5X0McD+nZcXS6AbhmkeceCVpShwGGjcy6UEdDeSRpLkD4t/hoHkVqdHAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 12 16 19 28 35" title="" data-src="/static/2022-12-16-19-28-35-ac103b5f8619d4f07254b7bba39ea5e1-fee1c.png" data-srcset="/static/2022-12-16-19-28-35-ac103b5f8619d4f07254b7bba39ea5e1-a67b7.png 200w,\n/static/2022-12-16-19-28-35-ac103b5f8619d4f07254b7bba39ea5e1-0b187.png 400w,\n/static/2022-12-16-19-28-35-ac103b5f8619d4f07254b7bba39ea5e1-fee1c.png 800w,\n/static/2022-12-16-19-28-35-ac103b5f8619d4f07254b7bba39ea5e1-0f56a.png 1050w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="方案"><a href="#%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方案</h1>\n<p>目前是全量更新，需要改成增量更新</p>\n<h1 id="实现"><a href="#%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现</h1>\n<h2 id="原始版本"><a href="#%E5%8E%9F%E5%A7%8B%E7%89%88%E6%9C%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>原始版本</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77014050561913060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gitlab_repo = &quot;\\${params.gitlab_repo}&quot;\ndef split = gitlab_repo.split(&quot;/&quot;)\ndef repo_name = split[1]\nbranch_name = &quot;\\${params.branch_name}&quot;\ndef split2 = branch_name.split(&quot;/&quot;)\ndef branch_last_name = split2[split2.length-1]\ndockerhub_repo = &quot;\\${params.dockerhub_repo}&quot;\nparameter = &quot;\\${params.parameter}&quot;\nrepo_url = &quot;仓库地址&quot;\nuse_cache = &quot;\\${params.use_cache}&quot;\ncache_version =&quot;\\${params.cache_version}&quot;\n\ndef cache_arg = &quot;&quot;\n\nif (use_cache == \'false\') {\n    cache_arg = &quot;--no-cache&quot;\n}\n\nbuild_node = &quot;\\${params.build_node}&quot;\nbuild_node_ip = \'build机器地址\'\nclone_node = \'部署机器标签\'\n\nimport java.text.SimpleDateFormat;\ndef createVersion() {\n    def dateUnix = ((new Date().time + 22800000) / 1000).intValue()\n    Date dateObj =  new Date( ((long)dateUnix) * 1000 )\n    String ymd = new SimpleDateFormat(&quot;yyMMddHHmmss&quot;).format(dateObj)\n    return &quot;\\${ymd}&quot;\n}\nymd = createVersion()\nimage_version = &quot;1.0.9.\\${ymd}&quot;\n\nwork_dir = &quot;项目名称_\\${ymd}&quot;\n\nprintln(&quot;gitlab_repo branch=\\${gitlab_repo} \\${branch_name}&quot;)\nprintln(&quot;repo_name=\\${repo_name}, image_version=\\${image_version}&quot;)\nprintln(&quot;dockerhub_repo=\\${dockerhub_repo}&quot;)\nprintln(&quot;cache_arg=\\${cache_arg}&quot;)\nprintln(&quot;cache_version=\\${cache_version}&quot;)\n\nbuild_user=&quot;&quot;\nnode{\n    wrap([\\$class: \'BuildUser\']) {\n        build_user = env.BUILD_USER\n    }\n}\nprintln(&quot;build_user=\\${build_user}&quot;)\n\ndefault_description = &quot;@\\${build_user} \\${gitlab_repo} \\${branch_name}:\\${image_version}&quot;\ncurrentBuild.description = &quot;\\${default_description}&quot;\n\npipeline {\n    agent {\n        node {\n            label &quot;\\${build_node}&quot;\n        }\n    }\n\n    environment {\n        repo_name1 = &quot;\\${repo_name}&quot;\n        branch_last_name1 = &quot;\\${branch_last_name}&quot;\n    }\n\n    stages {\n        stage(\'Clean workspace\') {\n        agent {\n            node {\n                label &quot;\\${build_node}&quot;\n            }\n        }\n         steps {\n            sh &quot;&quot;&quot;\n                rm -fr /home/jenkins/workspace/apps/项目名称/\\${work_dir} || true\n            &quot;&quot;&quot;\n        }\n      }\n\n      stage(&quot;Clone Repo&quot;){\n          agent {\n             node {\n                 label &quot;\\${clone_node}&quot; //\'部署机器标签\'\n             }\n         }\n         steps {\n            sh &quot;&quot;&quot;\n            cp /data/xmotors_ai_shared/sre/saved_repo/clone.sh .\n            bash clone.sh \\${gitlab_repo} \\${branch_name} \\${work_dir}\n            ls -la\n            cp /data/xmotors_ai_shared/sre/saved_repo/judge_has_master_commit.py ./\n            /usr/bin/python3 judge_has_master_commit.py \\${work_dir} 机器人webhook\n            &quot;&quot;&quot;\n         }\n      }\n\n      stage(&quot;Scp to build_node&quot;) {\n         agent {\n             node {\n                 label &quot;\\${clone_node}&quot; //\'部署机器标签\'\n             }\n         }\n         steps {\n            echo &quot;Scp to \\${build_node}/\\${build_node_ip}&quot;\n            sh &quot;&quot;&quot;\n                pwd\n                rsync -Lrav --relative \\${work_dir}/前端目录名称/ jenkins@\\${build_node_ip}:/home/jenkins/workspace/apps/项目名称/\n                if [ \\\\$? -ne 0 ]\n                then\n                    echo &quot;Found some error when copy the repo&quot;\n                fi\n                rm -fr \\${work_dir} || true\n            &quot;&quot;&quot;\n         }\n      }\n\n      stage(\'Build docker images\') {\n         agent {\n             node {\n                 label &quot;\\${build_node}&quot;\n             }\n         }\n         steps {\n             sh &quot;&quot;&quot;\n                if [ ! -f /home/jenkins/workspace/apps/项目名称/\\${work_dir}/前端目录名称/Dockerfile-client-buildkit ]\n                then\n                    echo &quot;No available 前端目录名称/Dockerfile-client-buildkit in workspace&quot;\n                    exit 1\n                fi\n\n                cd /home/jenkins/workspace/apps/项目名称/\\${work_dir}/前端目录名称/\n                # docker info\n                docker -v\n                DOCKER_BUILDKIT=1 docker build \\${cache_arg} --build-arg=BUILDKIT_CACHE_MOUNT_NS=\\${cache_version} -t docker远程仓库地址/\\${dockerhub_repo}:\\${image_version} -f ./Dockerfile-client-buildkit .\n                # docker build -t docker远程仓库地址/\\${dockerhub_repo}:\\${image_version} -f ./Dockerfile-client-buildkit .\n                docker push docker远程仓库地址/\\${dockerhub_repo}:\\${image_version}\n                pwd\n                ls\n                rm -fr /home/jenkins/workspace/apps/项目名称/\\${work_dir} || true\n            &quot;&quot;&quot;\n        }\n      }\n\n      stage(\'Set tag\') {\n         agent {\n             node {\n                 label &quot;\\${clone_node}&quot; //\'部署机器标签\'\n             }\n         }\n         steps {\n             dir(&quot;\\${repo_name1}_\\${branch_name}&quot;){\n                sh &quot;&quot;&quot;\n                echo \'escape git tag\'\n                    #git tag -m &quot;Build docker image \\${image_version} for \\${branch_name}/\\${image_version}&quot; \\${branch_name}/\\${image_version}\n                    #git describe\n                    #git push origin \\${branch_name}/\\${image_version}\n                rm -fr \\${work_dir}\n                &quot;&quot;&quot;\n             }\n         }\n      }\n\n    }\n    post {\n        always {\n            echo \'I have finished\'\n        }\n        success {\n            echo &quot;build \\${gitlab_repo} \\${branch_name}:\\${image_version}, succeed!&quot;\n            sh &quot;&quot;&quot;\n            curl -X POST -H &quot;Content-Type: application/json&quot; -d \'{&quot;msg_type&quot;:&quot;text&quot;,&quot;content&quot;:{&quot;text&quot;:&quot;@\\${build_user} 项目名称 notify: \\${gitlab_repo} \\${branch_name}:\\${image_version}, succeed!&quot;}}\' 机器人webhook\n            &quot;&quot;&quot;\n        }\n        failure {\n            echo &quot;build \\${gitlab_repo} \\${branch_name}:\\${image_version}, failed!&quot;\n            sh &quot;&quot;&quot;\n            curl -X POST -H &quot;Content-Type: application/json&quot; -d \'{&quot;msg_type&quot;:&quot;text&quot;,&quot;content&quot;:{&quot;text&quot;:&quot;@\\${build_user} 项目名称 notify: \\${gitlab_repo} \\${branch_name}:\\${image_version}, failed!&quot;}}\' 机器人webhook\n            &quot;&quot;&quot;\n        }\n    }\n}`, `77014050561913060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="groovy"\n              >\n                <span class="gatsby-code-button-language">groovy</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="groovy"><pre style="counter-reset: linenumber NaN" class="language-groovy line-numbers"><code class="language-groovy">gitlab_repo <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>gitlab_repo<span class="token punctuation">}</span></span>"</span>\n<span class="token keyword">def</span> split <span class="token operator">=</span> gitlab_repo<span class="token operator">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string gstring">"/"</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> repo_name <span class="token operator">=</span> split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>\nbranch_name <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>branch_name<span class="token punctuation">}</span></span>"</span>\n<span class="token keyword">def</span> split2 <span class="token operator">=</span> branch_name<span class="token operator">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string gstring">"/"</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> branch_last_name <span class="token operator">=</span> split2<span class="token punctuation">[</span>split2<span class="token operator">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>\ndockerhub_repo <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>dockerhub_repo<span class="token punctuation">}</span></span>"</span>\nparameter <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>parameter<span class="token punctuation">}</span></span>"</span>\nrepo_url <span class="token operator">=</span> <span class="token string gstring">"仓库地址"</span>\nuse_cache <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>use_cache<span class="token punctuation">}</span></span>"</span>\ncache_version <span class="token operator">=</span><span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>cache_version<span class="token punctuation">}</span></span>"</span>\n\n<span class="token keyword">def</span> cache_arg <span class="token operator">=</span> <span class="token string gstring">""</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>use_cache <span class="token operator">==</span> <span class="token string">\'false\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    cache_arg <span class="token operator">=</span> <span class="token string gstring">"--no-cache"</span>\n<span class="token punctuation">}</span>\n\nbuild_node <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>build_node<span class="token punctuation">}</span></span>"</span>\nbuild_node_ip <span class="token operator">=</span> <span class="token string">\'build机器地址\'</span>\nclone_node <span class="token operator">=</span> <span class="token string">\'部署机器标签\'</span>\n\n<span class="token keyword">import</span> java<span class="token operator">.</span>text<span class="token operator">.</span>SimpleDateFormat<span class="token punctuation">;</span>\n<span class="token keyword">def</span> <span class="token function">createVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">def</span> dateUnix <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span>time <span class="token operator">+</span> <span class="token number">22800000</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    Date dateObj <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>dateUnix<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token punctuation">)</span>\n    String ymd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string gstring">"yyMMddHHmmss"</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">format</span><span class="token punctuation">(</span>dateObj<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span>\n<span class="token punctuation">}</span>\nymd <span class="token operator">=</span> <span class="token function">createVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\nimage_version <span class="token operator">=</span> <span class="token string gstring">"1.0.9.<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span>\n\nwork_dir <span class="token operator">=</span> <span class="token string gstring">"项目名称_<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span>\n\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"gitlab_repo branch=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"repo_name=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>repo_name<span class="token punctuation">}</span></span>, image_version=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"dockerhub_repo=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"cache_arg=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_arg<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"cache_version=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_version<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n\nbuild_user<span class="token operator">=</span><span class="token string gstring">""</span>\nnode<span class="token punctuation">{</span>\n    <span class="token function">wrap</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">$</span><span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">\'BuildUser\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        build_user <span class="token operator">=</span> env<span class="token operator">.</span>BUILD_USER\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"build_user=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n\ndefault_description <span class="token operator">=</span> <span class="token string gstring">"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>"</span>\ncurrentBuild<span class="token operator">.</span>description <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>default_description<span class="token punctuation">}</span></span>"</span>\n\npipeline <span class="token punctuation">{</span>\n    agent <span class="token punctuation">{</span>\n        node <span class="token punctuation">{</span>\n            label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    environment <span class="token punctuation">{</span>\n        repo_name1 <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>repo_name<span class="token punctuation">}</span></span>"</span>\n        branch_last_name1 <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_last_name<span class="token punctuation">}</span></span>"</span>\n    <span class="token punctuation">}</span>\n\n    stages <span class="token punctuation">{</span>\n        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Clean workspace\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        agent <span class="token punctuation">{</span>\n            node <span class="token punctuation">{</span>\n                label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            sh <span class="token string gstring">"""\n                rm -fr /home/jenkins/workspace/apps/项目名称/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> || true\n            """</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string gstring">"Clone Repo"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n          agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span> <span class="token comment">//\'部署机器标签\'</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            sh <span class="token string gstring">"""\n            cp /data/xmotors_ai_shared/sre/saved_repo/clone.sh .\n            bash clone.sh <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>\n            ls -la\n            cp /data/xmotors_ai_shared/sre/saved_repo/judge_has_master_commit.py ./\n            /usr/bin/python3 judge_has_master_commit.py <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> 机器人webhook\n            """</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string gstring">"Scp to build_node"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span> <span class="token comment">//\'部署机器标签\'</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"Scp to <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node_ip<span class="token punctuation">}</span></span>"</span>\n            sh <span class="token string gstring">"""\n                pwd\n                rsync -Lrav --relative <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>/前端目录名称/ jenkins@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node_ip<span class="token punctuation">}</span></span>:/home/jenkins/workspace/apps/项目名称/\n                if [ \\$? -ne 0 ]\n                then\n                    echo "Found some error when copy the repo"\n                fi\n                rm -fr <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> || true\n            """</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Build docker images\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n             sh <span class="token string gstring">"""\n                if [ ! -f /home/jenkins/workspace/apps/项目名称/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>/前端目录名称/Dockerfile-client-buildkit ]\n                then\n                    echo "No available 前端目录名称/Dockerfile-client-buildkit in workspace"\n                    exit 1\n                fi\n\n                cd /home/jenkins/workspace/apps/项目名称/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>/前端目录名称/\n                # docker info\n                docker -v\n                DOCKER_BUILDKIT=1 docker build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_arg<span class="token punctuation">}</span></span> --build-arg=BUILDKIT_CACHE_MOUNT_NS=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_version<span class="token punctuation">}</span></span> -t docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span> -f ./Dockerfile-client-buildkit .\n                # docker build -t docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span> -f ./Dockerfile-client-buildkit .\n                docker push docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>\n                pwd\n                ls\n                rm -fr /home/jenkins/workspace/apps/项目名称/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> || true\n            """</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Set tag\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span> <span class="token comment">//\'部署机器标签\'</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n             <span class="token function">dir</span><span class="token punctuation">(</span><span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>repo_name1<span class="token punctuation">}</span></span>_<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n                sh <span class="token string gstring">"""\n                echo \'escape git tag\'\n                    #git tag -m "Build docker image <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span> for <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>" <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>\n                    #git describe\n                    #git push origin <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>\n                rm -fr <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>\n                """</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n    <span class="token punctuation">}</span>\n    post <span class="token punctuation">{</span>\n        always <span class="token punctuation">{</span>\n            echo <span class="token string">\'I have finished\'</span>\n        <span class="token punctuation">}</span>\n        success <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, succeed!"</span>\n            sh <span class="token string gstring">"""\n            curl -X POST -H "Content-Type: application/json" -d \'{"msg_type":"text","content":{"text":"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> 项目名称 notify: <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, succeed!"}}\' 机器人webhook\n            """</span>\n        <span class="token punctuation">}</span>\n        failure <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, failed!"</span>\n            sh <span class="token string gstring">"""\n            curl -X POST -H "Content-Type: application/json" -d \'{"msg_type":"text","content":{"text":"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> 项目名称 notify: <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, failed!"}}\' 机器人webhook\n            """</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="版本一"><a href="#%E7%89%88%E6%9C%AC%E4%B8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>版本一</h2>\n<ol>\n<li>固定使用一个目录为缓存目录，拉取代码和构建代码都在这个缓存目录上</li>\n<li>利用 git 和 rsync 的增量更新</li>\n<li>不使用缓存时删除固定目录的缓存</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20281262896539220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gitlab_repo = &quot;\\${params.gitlab_repo}&quot;\ndef split = gitlab_repo.split(&quot;/&quot;)\ndef repo_name = split[1]\nbranch_name = &quot;\\${params.branch_name}&quot;\ndef split2 = branch_name.split(&quot;/&quot;)\ndef branch_last_name = split2[split2.length-1]\ndockerhub_repo = &quot;\\${params.dockerhub_repo}&quot;\nparameter = &quot;\\${params.parameter}&quot;\nrepo_url = &quot;仓库地址&quot;\nuse_cache = &quot;\\${params.use_cache}&quot;\ncache_version =&quot;\\${params.cache_version}&quot;\nis_cache_project = &quot;\\${params.is_cache_project}&quot;\n\ndef cache_arg = &quot;&quot;\n\nif (use_cache == \'false\') {\n    cache_arg = &quot;--no-cache&quot;\n}\n\nbuild_node = &quot;\\${params.build_node}&quot;\nbuild_node_ip = \'build机器地址\'\nclone_node = \'部署机器标签\'\n\nimport java.text.SimpleDateFormat;\ndef createVersion() {\n    def dateUnix = ((new Date().time + 22800000) / 1000).intValue()\n    Date dateObj =  new Date( ((long)dateUnix) * 1000 )\n    String ymd = new SimpleDateFormat(&quot;yyMMddHHmmss&quot;).format(dateObj)\n    return &quot;\\${ymd}&quot;\n}\nymd = createVersion()\nimage_version = &quot;1.0.9.\\${ymd}&quot;\n\nwork_dir = &quot;项目名称&quot;\n\nprintln(&quot;gitlab_repo branch=\\${gitlab_repo} \\${branch_name}&quot;)\nprintln(&quot;repo_name=\\${repo_name}, image_version=\\${image_version}&quot;)\nprintln(&quot;dockerhub_repo=\\${dockerhub_repo}&quot;)\nprintln(&quot;cache_arg=\\${cache_arg}&quot;)\nprintln(&quot;cache_version=\\${cache_version}&quot;)\n\nbuild_user=&quot;&quot;\nnode{\n    wrap([\\$class: \'BuildUser\']) {\n        build_user = env.BUILD_USER\n    }\n}\nprintln(&quot;build_user=\\${build_user}&quot;)\n\ndefault_description = &quot;@\\${build_user} \\${gitlab_repo} \\${branch_name}:\\${image_version}&quot;\ncurrentBuild.description = &quot;\\${default_description}&quot;\n\npipeline {\n    agent {\n        node {\n            label &quot;\\${build_node}&quot;\n        }\n    }\n\n    environment {\n        repo_name1 = &quot;\\${repo_name}&quot;\n        branch_last_name1 = &quot;\\${branch_last_name}&quot;\n    }\n\n    stages {\n      stage(\'Clean workspace\') {\n        agent {\n            node {\n                label &quot;\\${build_node}&quot;\n            }\n        }\n         steps {\n            sh &quot;&quot;&quot;\n            if [ \\${is_cache_project} = \'false\' ]\n            then\n               rm -fr /home/jenkins/workspace/apps/项目名称/\\${work_dir} || true\n            fi\n            &quot;&quot;&quot;\n        }\n      }\n      stage(&quot;Clone Repo&quot;){\n          agent {\n             node {\n                 label &quot;\\${clone_node}&quot; //\'部署机器标签\'\n             }\n         }\n         steps {\n            sh &quot;&quot;&quot;\n            # ls -la\n            if [ \\${is_cache_project} = \'false\' ]\n            then\n               rm -rf \\${work_dir} || true\n            fi\n            if [ ! -d \\${work_dir} ]\n            then\n               cp /data/xmotors_ai_shared/sre/saved_repo/clone.sh .\n               bash clone.sh \\${gitlab_repo} \\${branch_name} \\${work_dir}\n            else\n               cd \\${work_dir}\n               # 1、为了让脚本检测，2、master 拉取最新\n               git checkout master\n               git pull origin master\n\n               if [ \\${branch_name} != \'master\' ]\n               then\n                  git checkout \\${branch_name}\n                  # 强制拉取远程代码到本地\n                  git pull --force origin \\${branch_name}:\\${branch_name}\n               fi\n               cd ..\n            fi\n            # ls -la\n            cp /data/xmotors_ai_shared/sre/saved_repo/judge_has_master_commit.py ./\n            /usr/bin/python3 judge_has_master_commit.py \\${work_dir} 机器人webhook\n            &quot;&quot;&quot;\n         }\n      }\n\n      stage(&quot;Scp to build_node&quot;) {\n         agent {\n             node {\n                 label &quot;\\${clone_node}&quot; //\'部署机器标签\'\n             }\n         }\n         steps {\n            echo &quot;Scp to \\${build_node}/\\${build_node_ip}&quot;\n            sh &quot;&quot;&quot;\n                # pwd\n                rsync -Lazv -R \\${work_dir}/前端目录名称/ jenkins@\\${build_node_ip}:/home/jenkins/workspace/apps/项目名称/\n                if [ \\\\$? -ne 0 ]\n                then\n                    echo &quot;Found some error when copy the repo&quot;\n                fi\n                # rm -fr \\${work_dir} || true\n            &quot;&quot;&quot;\n         }\n      }\n\n      stage(\'Build docker images\') {\n         agent {\n             node {\n                 label &quot;\\${build_node}&quot;\n             }\n         }\n         steps {\n             sh &quot;&quot;&quot;\n                if [ ! -f /home/jenkins/workspace/apps/项目名称/\\${work_dir}/前端目录名称/Dockerfile-client-buildkit ]\n                then\n                  echo &quot;No available 前端目录名称/Dockerfile-client-buildkit in workspace&quot;\n                  exit 1\n                fi\n\n                cd /home/jenkins/workspace/apps/项目名称/\\${work_dir}/前端目录名称/\n                # docker info\n                # docker -v\n                DOCKER_BUILDKIT=1 docker build \\${cache_arg} --build-arg=BUILDKIT_CACHE_MOUNT_NS=\\${cache_version} -t docker远程仓库地址/\\${dockerhub_repo}:\\${image_version} -f ./Dockerfile-client-buildkit .\n                # docker build -t docker远程仓库地址/\\${dockerhub_repo}:\\${image_version} -f ./Dockerfile-client-buildkit .\n                docker push docker远程仓库地址/\\${dockerhub_repo}:\\${image_version}\n                # pwd\n                # ls\n                # rm -fr /home/jenkins/workspace/apps/项目名称/\\${work_dir} || true\n            &quot;&quot;&quot;\n        }\n      }\n   }\n\n    post {\n        always {\n            echo \'I have finished\'\n        }\n        success {\n            echo &quot;build \\${gitlab_repo} \\${branch_name}:\\${image_version}, succeed!&quot;\n            sh &quot;&quot;&quot;\n            curl -X POST -H &quot;Content-Type: application/json&quot; -d \'{&quot;msg_type&quot;:&quot;text&quot;,&quot;content&quot;:{&quot;text&quot;:&quot;@\\${build_user} 项目名称 notify: \\${gitlab_repo} \\${branch_name}:\\${image_version}, succeed!&quot;}}\' 机器人webhook\n            &quot;&quot;&quot;\n        }\n        failure {\n            echo &quot;build \\${gitlab_repo} \\${branch_name}:\\${image_version}, failed!&quot;\n            sh &quot;&quot;&quot;\n            curl -X POST -H &quot;Content-Type: application/json&quot; -d \'{&quot;msg_type&quot;:&quot;text&quot;,&quot;content&quot;:{&quot;text&quot;:&quot;@\\${build_user} 项目名称 notify: \\${gitlab_repo} \\${branch_name}:\\${image_version}, failed!&quot;}}\' 机器人webhook\n            &quot;&quot;&quot;\n        }\n    }\n}`, `20281262896539220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="groovy{12,34,74-77,89-112,128-129,134,159-161}"\n              >\n                <span class="gatsby-code-button-language">groovy{12,34,74-77,89-112,128-129,134,159-161}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="groovy"><pre style="counter-reset: linenumber NaN" class="language-groovy line-numbers"><code class="language-groovy">gitlab_repo <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>gitlab_repo<span class="token punctuation">}</span></span>"</span>\n<span class="token keyword">def</span> split <span class="token operator">=</span> gitlab_repo<span class="token operator">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string gstring">"/"</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> repo_name <span class="token operator">=</span> split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>\nbranch_name <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>branch_name<span class="token punctuation">}</span></span>"</span>\n<span class="token keyword">def</span> split2 <span class="token operator">=</span> branch_name<span class="token operator">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string gstring">"/"</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> branch_last_name <span class="token operator">=</span> split2<span class="token punctuation">[</span>split2<span class="token operator">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>\ndockerhub_repo <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>dockerhub_repo<span class="token punctuation">}</span></span>"</span>\nparameter <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>parameter<span class="token punctuation">}</span></span>"</span>\nrepo_url <span class="token operator">=</span> <span class="token string gstring">"仓库地址"</span>\nuse_cache <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>use_cache<span class="token punctuation">}</span></span>"</span>\ncache_version <span class="token operator">=</span><span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>cache_version<span class="token punctuation">}</span></span>"</span>\n<span class="gatsby-highlight-code-line">is_cache_project <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>is_cache_project<span class="token punctuation">}</span></span>"</span></span>\n<span class="token keyword">def</span> cache_arg <span class="token operator">=</span> <span class="token string gstring">""</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>use_cache <span class="token operator">==</span> <span class="token string">\'false\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    cache_arg <span class="token operator">=</span> <span class="token string gstring">"--no-cache"</span>\n<span class="token punctuation">}</span>\n\nbuild_node <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>build_node<span class="token punctuation">}</span></span>"</span>\nbuild_node_ip <span class="token operator">=</span> <span class="token string">\'build机器地址\'</span>\nclone_node <span class="token operator">=</span> <span class="token string">\'部署机器标签\'</span>\n\n<span class="token keyword">import</span> java<span class="token operator">.</span>text<span class="token operator">.</span>SimpleDateFormat<span class="token punctuation">;</span>\n<span class="token keyword">def</span> <span class="token function">createVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">def</span> dateUnix <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span>time <span class="token operator">+</span> <span class="token number">22800000</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    Date dateObj <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>dateUnix<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token punctuation">)</span>\n    String ymd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string gstring">"yyMMddHHmmss"</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">format</span><span class="token punctuation">(</span>dateObj<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span>\n<span class="token punctuation">}</span>\nymd <span class="token operator">=</span> <span class="token function">createVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\nimage_version <span class="token operator">=</span> <span class="token string gstring">"1.0.9.<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span>\n\n<span class="gatsby-highlight-code-line">work_dir <span class="token operator">=</span> <span class="token string gstring">"项目名称"</span></span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"gitlab_repo branch=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"repo_name=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>repo_name<span class="token punctuation">}</span></span>, image_version=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"dockerhub_repo=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"cache_arg=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_arg<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"cache_version=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_version<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n\nbuild_user<span class="token operator">=</span><span class="token string gstring">""</span>\nnode<span class="token punctuation">{</span>\n    <span class="token function">wrap</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">$</span><span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">\'BuildUser\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        build_user <span class="token operator">=</span> env<span class="token operator">.</span>BUILD_USER\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"build_user=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n\ndefault_description <span class="token operator">=</span> <span class="token string gstring">"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>"</span>\ncurrentBuild<span class="token operator">.</span>description <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>default_description<span class="token punctuation">}</span></span>"</span>\n\npipeline <span class="token punctuation">{</span>\n    agent <span class="token punctuation">{</span>\n        node <span class="token punctuation">{</span>\n            label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    environment <span class="token punctuation">{</span>\n        repo_name1 <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>repo_name<span class="token punctuation">}</span></span>"</span>\n        branch_last_name1 <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_last_name<span class="token punctuation">}</span></span>"</span>\n    <span class="token punctuation">}</span>\n\n    stages <span class="token punctuation">{</span>\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Clean workspace\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        agent <span class="token punctuation">{</span>\n            node <span class="token punctuation">{</span>\n                label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            sh <span class="token string gstring">"""\n<span class="gatsby-highlight-code-line">            if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'false\' ]</span><span class="gatsby-highlight-code-line">            then</span><span class="gatsby-highlight-code-line">               rm -fr /home/jenkins/workspace/apps/项目名称/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> || true</span><span class="gatsby-highlight-code-line">            fi</span>            """</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string gstring">"Clone Repo"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n          agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span> <span class="token comment">//\'部署机器标签\'</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            sh <span class="token string gstring">"""\n<span class="gatsby-highlight-code-line">            # ls -la</span><span class="gatsby-highlight-code-line">            if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'false\' ]</span><span class="gatsby-highlight-code-line">            then</span><span class="gatsby-highlight-code-line">               rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> || true</span><span class="gatsby-highlight-code-line">            fi</span><span class="gatsby-highlight-code-line">            if [ ! -d <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> ]</span><span class="gatsby-highlight-code-line">            then</span><span class="gatsby-highlight-code-line">               cp /data/xmotors_ai_shared/sre/saved_repo/clone.sh .</span><span class="gatsby-highlight-code-line">               bash clone.sh <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">            else</span><span class="gatsby-highlight-code-line">               cd <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">               # 1、为了让脚本检测，2、master 拉取最新</span><span class="gatsby-highlight-code-line">               git checkout master</span><span class="gatsby-highlight-code-line">               git pull origin master</span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">               if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span> != \'master\' ]</span><span class="gatsby-highlight-code-line">               then</span><span class="gatsby-highlight-code-line">                  git checkout <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                  # 强制拉取远程代码到本地</span><span class="gatsby-highlight-code-line">                  git pull --force origin <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">               fi</span><span class="gatsby-highlight-code-line">               cd ..</span><span class="gatsby-highlight-code-line">            fi</span><span class="gatsby-highlight-code-line">            # ls -la</span>            cp /data/xmotors_ai_shared/sre/saved_repo/judge_has_master_commit.py ./\n            /usr/bin/python3 judge_has_master_commit.py <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> 机器人webhook\n            """</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string gstring">"Scp to build_node"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span> <span class="token comment">//\'部署机器标签\'</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"Scp to <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node_ip<span class="token punctuation">}</span></span>"</span>\n            sh <span class="token string gstring">"""\n<span class="gatsby-highlight-code-line">                # pwd</span><span class="gatsby-highlight-code-line">                rsync -Lazv -R <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>/前端目录名称/ jenkins@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node_ip<span class="token punctuation">}</span></span>:/home/jenkins/workspace/apps/项目名称/</span>                if [ \\$? -ne 0 ]\n                then\n                    echo "Found some error when copy the repo"\n                fi\n<span class="gatsby-highlight-code-line">                # rm -fr <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> || true</span>            """</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Build docker images\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n             sh <span class="token string gstring">"""\n                if [ ! -f /home/jenkins/workspace/apps/项目名称/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>/前端目录名称/Dockerfile-client-buildkit ]\n                then\n                  echo "No available 前端目录名称/Dockerfile-client-buildkit in workspace"\n                  exit 1\n                fi\n\n                cd /home/jenkins/workspace/apps/项目名称/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>/前端目录名称/\n                # docker info\n                # docker -v\n                DOCKER_BUILDKIT=1 docker build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_arg<span class="token punctuation">}</span></span> --build-arg=BUILDKIT_CACHE_MOUNT_NS=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_version<span class="token punctuation">}</span></span> -t docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span> -f ./Dockerfile-client-buildkit .\n                # docker build -t docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span> -f ./Dockerfile-client-buildkit .\n                docker push docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>\n<span class="gatsby-highlight-code-line">                # pwd</span><span class="gatsby-highlight-code-line">                # ls</span><span class="gatsby-highlight-code-line">                # rm -fr /home/jenkins/workspace/apps/项目名称/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> || true</span>            """</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n\n    post <span class="token punctuation">{</span>\n        always <span class="token punctuation">{</span>\n            echo <span class="token string">\'I have finished\'</span>\n        <span class="token punctuation">}</span>\n        success <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, succeed!"</span>\n            sh <span class="token string gstring">"""\n            curl -X POST -H "Content-Type: application/json" -d \'{"msg_type":"text","content":{"text":"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> 项目名称 notify: <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, succeed!"}}\' 机器人webhook\n            """</span>\n        <span class="token punctuation">}</span>\n        failure <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, failed!"</span>\n            sh <span class="token string gstring">"""\n            curl -X POST -H "Content-Type: application/json" -d \'{"msg_type":"text","content":{"text":"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> 项目名称 notify: <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, failed!"}}\' 机器人webhook\n            """</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="版本二"><a href="#%E7%89%88%E6%9C%AC%E4%BA%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>版本二</h2>\n<ol>\n<li>固定使用一个目录为缓存目录，拷贝到带有新后缀的目录（拉取代码和构建代码的目录），和之前逻辑一样，解决并行执行问题</li>\n<li>不使用缓存时不拷贝到对应目录</li>\n<li>独立出缓存步骤，减少并行执行时带来的文件互操作问题</li>\n<li>修复非 master 分支时拉取代码的错误逻辑，强制更新远程代码到本地代码</li>\n<li>rsync 添加 <code class="language-text">-cr</code> 选项，去掉 <code class="language-text">-a</code> 选项，即更新时只比较所有文件的校验和，不再通过文件的更新时间比较（即不需要通过 <code class="language-text">-a</code> 传递所有的文件信息）</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84908851427687090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gitlab_repo = &quot;\\${params.gitlab_repo}&quot;\ndef split = gitlab_repo.split(&quot;/&quot;)\ndef repo_name = split[1]\nbranch_name = &quot;\\${params.branch_name}&quot;\ndef split2 = branch_name.split(&quot;/&quot;)\ndef branch_last_name = split2[split2.length-1]\ndockerhub_repo = &quot;\\${params.dockerhub_repo}&quot;\nparameter = &quot;\\${params.parameter}&quot;\nrepo_url = &quot;仓库地址&quot;\nuse_cache = &quot;\\${params.use_cache}&quot;\ncache_version =&quot;\\${params.cache_version}&quot;\nis_cache_project = &quot;\\${params.is_cache_project}&quot;\n\ndef cache_arg = &quot;&quot;\n\nif (use_cache == \'false\') {\n    cache_arg = &quot;--no-cache&quot;\n}\n\nbuild_node = &quot;\\${params.build_node}&quot;\nbuild_node_ip = \'build机器地址\'\nclone_node = \'部署机器标签\'\n\nimport java.text.SimpleDateFormat;\ndef createVersion() {\n    def dateUnix = ((new Date().time + 22800000) / 1000).intValue()\n    Date dateObj =  new Date( ((long)dateUnix) * 1000 )\n    String ymd = new SimpleDateFormat(&quot;yyMMddHHmmss&quot;).format(dateObj)\n    return &quot;\\${ymd}&quot;\n}\nymd = createVersion()\nimage_version = &quot;1.0.9.\\${ymd}&quot;\n\nwork_dir = &quot;项目名称_\\${ymd}&quot;\nwork_cache_dir = &quot;项目名称_cache&quot;\n\nprintln(&quot;gitlab_repo branch=\\${gitlab_repo} \\${branch_name}&quot;)\nprintln(&quot;repo_name=\\${repo_name}, image_version=\\${image_version}&quot;)\nprintln(&quot;dockerhub_repo=\\${dockerhub_repo}&quot;)\nprintln(&quot;cache_arg=\\${cache_arg}&quot;)\nprintln(&quot;cache_version=\\${cache_version}&quot;)\n\nbuild_user=&quot;&quot;\nnode{\n    wrap([\\$class: \'BuildUser\']) {\n        build_user = env.BUILD_USER\n    }\n}\nprintln(&quot;build_user=\\${build_user}&quot;)\n\ndefault_description = &quot;@\\${build_user} \\${gitlab_repo} \\${branch_name}:\\${image_version}&quot;\ncurrentBuild.description = &quot;\\${default_description}&quot;\n\npipeline {\n    agent {\n        node {\n            label &quot;\\${build_node}&quot;\n        }\n    }\n\n    environment {\n        repo_name1 = &quot;\\${repo_name}&quot;\n        branch_last_name1 = &quot;\\${branch_last_name}&quot;\n    }\n\n    stages {\n      stage(\'Cache Workspace\') {\n        agent {\n            node {\n                label &quot;\\${build_node}&quot;\n            }\n        }\n         steps {\n            sh &quot;&quot;&quot;\n                cd /home/jenkins/workspace/apps/项目名称/\n                # rm -rf \\${work_cache_dir}\n                if [ \\${is_cache_project} = \'true\' ]\n                then\n                    if [ ! -d \\${work_cache_dir} ]\n                    then\n                        echo &quot;Cache Workspace not found&quot;\n                    else\n                        cp -r \\${work_cache_dir} \\${work_dir}\n                        cd \\${work_dir} && ls\n                        echo &quot;Cache Workspace restore successful&quot;\n                    fi\n                fi\n            &quot;&quot;&quot;\n        }\n      }\n\n      stage(\'Cache Repo\') {\n        agent {\n            node {\n                label &quot;\\${clone_node}&quot;\n            }\n        }\n         steps {\n            sh &quot;&quot;&quot;\n                # vi clone.sh\n                # rm -rf \\${work_cache_dir}\n                if [ \\${is_cache_project} = \'true\' ]\n                then\n                    if [ ! -d \\${work_cache_dir} ]\n                    then\n                        echo &quot;Cache Repo not found&quot;\n                    else\n                        cp -r \\${work_cache_dir} \\${work_dir}\n                        cd \\${work_dir} && ls\n                        echo &quot;Cache Repo restore successful&quot;\n                    fi\n                fi\n            &quot;&quot;&quot;\n        }\n      }\n\n      stage(&quot;Clone Repo&quot;){\n          agent {\n             node {\n                 label &quot;\\${clone_node}&quot; //\'部署机器标签\'\n             }\n         }\n         steps {\n            sh &quot;&quot;&quot;\n            # ls -la\n            if [ ! -d \\${work_dir} ]\n            then\n                cp /data/xmotors_ai_shared/sre/saved_repo/clone.sh .\n                bash clone.sh \\${gitlab_repo} \\${branch_name} \\${work_dir}\n            else\n                cd \\${work_dir}\n                # 1、为了让脚本检测，2、master 拉取最新\n                git checkout master\n                git pull origin master\n\n                if [ \\${branch_name} != \'master\' ]\n                then\n                    # 强制拉取远程代码到本地\n                    git fetch --force origin \\${branch_name}:\\${branch_name}\n                    git checkout origin/\\${branch_name}\n                fi\n                cd ..\n            fi\n            # ls -la\n            cp /data/xmotors_ai_shared/sre/saved_repo/judge_has_master_commit.py ./\n            /usr/bin/python3 judge_has_master_commit.py \\${work_dir} 机器人webhook\n            &quot;&quot;&quot;\n         }\n      }\n\n      stage(&quot;Scp to build_node&quot;) {\n         agent {\n             node {\n                 label &quot;\\${clone_node}&quot; //\'部署机器标签\'\n             }\n         }\n         steps {\n            echo &quot;Scp to \\${build_node}/\\${build_node_ip}&quot;\n            sh &quot;&quot;&quot;\n                # pwd\n                # 这里的 -c 选项比较重要，比较校验和\n                rsync -Lrzvc -R \\${work_dir}/前端目录名称/ jenkins@\\${build_node_ip}:/home/jenkins/workspace/apps/项目名称/\n                if [ \\\\$? -ne 0 ]\n                then\n                    echo &quot;Found some error when copy the repo&quot;\n                fi\n                # rm -fr \\${work_dir} || true\n            &quot;&quot;&quot;\n         }\n      }\n\n      stage(\'Build docker images\') {\n         agent {\n             node {\n                 label &quot;\\${build_node}&quot;\n             }\n         }\n         steps {\n             sh &quot;&quot;&quot;\n                if [ ! -f /home/jenkins/workspace/apps/项目名称/\\${work_dir}/前端目录名称/Dockerfile-client-buildkit ]\n                then\n                    echo &quot;No available 前端目录名称/Dockerfile-client-buildkit in workspace&quot;\n                    exit 1\n                fi\n\n                cd /home/jenkins/workspace/apps/项目名称/\\${work_dir}/前端目录名称/\n                # docker info\n                # docker -v\n                DOCKER_BUILDKIT=1 docker build \\${cache_arg} --build-arg=BUILDKIT_CACHE_MOUNT_NS=\\${cache_version} -t docker远程仓库地址/\\${dockerhub_repo}:\\${image_version} -f ./Dockerfile-client-buildkit .\n                # docker build -t docker远程仓库地址/\\${dockerhub_repo}:\\${image_version} -f ./Dockerfile-client-buildkit .\n                docker push docker远程仓库地址/\\${dockerhub_repo}:\\${image_version}\n                # pwd\n                # ls\n            &quot;&quot;&quot;\n        }\n      }\n\n      stage(\'Post Cache Workspace\') {\n        agent {\n            node {\n                label &quot;\\${build_node}&quot;\n            }\n        }\n         steps {\n            sh &quot;&quot;&quot;\n                cd /home/jenkins/workspace/apps/项目名称/\n                if [ \\${is_cache_project} = \'true\' ]\n                then\n                    rm -rf \\${work_cache_dir}\n                    mv \\${work_dir} \\${work_cache_dir}\n                    echo \'Post Cache Workspace\'\n                else\n                    rm -rf \\${work_dir}\n                fi\n            &quot;&quot;&quot;\n        }\n      }\n\n      stage(\'Post Cache Repo\') {\n        agent {\n            node {\n                label &quot;\\${clone_node}&quot;\n            }\n        }\n         steps {\n            sh &quot;&quot;&quot;\n                if [ \\${is_cache_project} = \'true\' ]\n                then\n                    rm -rf \\${work_cache_dir}\n                    mv \\${work_dir} \\${work_cache_dir}\n                    echo \'Post Cache Repo successful\'\n                else\n                    rm -rf \\${work_dir}\n                fi\n            &quot;&quot;&quot;\n        }\n      }\n    }\n\n    post {\n        always {\n            echo \'I have finished\'\n        }\n        success {\n            echo &quot;build \\${gitlab_repo} \\${branch_name}:\\${image_version}, succeed!&quot;\n            sh &quot;&quot;&quot;\n            curl -X POST -H &quot;Content-Type: application/json&quot; -d \'{&quot;msg_type&quot;:&quot;text&quot;,&quot;content&quot;:{&quot;text&quot;:&quot;@\\${build_user} 项目名称 notify: \\${gitlab_repo} \\${branch_name}:\\${image_version}, succeed!&quot;}}\' 机器人webhook\n            &quot;&quot;&quot;\n        }\n        failure {\n            echo &quot;build \\${gitlab_repo} \\${branch_name}:\\${image_version}, failed!&quot;\n            sh &quot;&quot;&quot;\n            curl -X POST -H &quot;Content-Type: application/json&quot; -d \'{&quot;msg_type&quot;:&quot;text&quot;,&quot;content&quot;:{&quot;text&quot;:&quot;@\\${build_user} 项目名称 notify: \\${gitlab_repo} \\${branch_name}:\\${image_version}, failed!&quot;}}\' 机器人webhook\n            &quot;&quot;&quot;\n        }\n    }\n}`, `84908851427687090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="groovy{34-35,75-87,100-112,138-140,161-162,206-214,227-234}"\n              >\n                <span class="gatsby-code-button-language">groovy{34-35,75-87,100-112,138-140,161-162,206-214,227-234}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="groovy"><pre style="counter-reset: linenumber NaN" class="language-groovy line-numbers"><code class="language-groovy">gitlab_repo <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>gitlab_repo<span class="token punctuation">}</span></span>"</span>\n<span class="token keyword">def</span> split <span class="token operator">=</span> gitlab_repo<span class="token operator">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string gstring">"/"</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> repo_name <span class="token operator">=</span> split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>\nbranch_name <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>branch_name<span class="token punctuation">}</span></span>"</span>\n<span class="token keyword">def</span> split2 <span class="token operator">=</span> branch_name<span class="token operator">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string gstring">"/"</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> branch_last_name <span class="token operator">=</span> split2<span class="token punctuation">[</span>split2<span class="token operator">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>\ndockerhub_repo <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>dockerhub_repo<span class="token punctuation">}</span></span>"</span>\nparameter <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>parameter<span class="token punctuation">}</span></span>"</span>\nrepo_url <span class="token operator">=</span> <span class="token string gstring">"仓库地址"</span>\nuse_cache <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>use_cache<span class="token punctuation">}</span></span>"</span>\ncache_version <span class="token operator">=</span><span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>cache_version<span class="token punctuation">}</span></span>"</span>\nis_cache_project <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>is_cache_project<span class="token punctuation">}</span></span>"</span>\n\n<span class="token keyword">def</span> cache_arg <span class="token operator">=</span> <span class="token string gstring">""</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>use_cache <span class="token operator">==</span> <span class="token string">\'false\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    cache_arg <span class="token operator">=</span> <span class="token string gstring">"--no-cache"</span>\n<span class="token punctuation">}</span>\n\nbuild_node <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>build_node<span class="token punctuation">}</span></span>"</span>\nbuild_node_ip <span class="token operator">=</span> <span class="token string">\'build机器地址\'</span>\nclone_node <span class="token operator">=</span> <span class="token string">\'部署机器标签\'</span>\n\n<span class="token keyword">import</span> java<span class="token operator">.</span>text<span class="token operator">.</span>SimpleDateFormat<span class="token punctuation">;</span>\n<span class="token keyword">def</span> <span class="token function">createVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">def</span> dateUnix <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span>time <span class="token operator">+</span> <span class="token number">22800000</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    Date dateObj <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>dateUnix<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token punctuation">)</span>\n    String ymd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string gstring">"yyMMddHHmmss"</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">format</span><span class="token punctuation">(</span>dateObj<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span>\n<span class="token punctuation">}</span>\nymd <span class="token operator">=</span> <span class="token function">createVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\nimage_version <span class="token operator">=</span> <span class="token string gstring">"1.0.9.<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span>\n\n<span class="gatsby-highlight-code-line">work_dir <span class="token operator">=</span> <span class="token string gstring">"项目名称_<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span></span><span class="gatsby-highlight-code-line">work_cache_dir <span class="token operator">=</span> <span class="token string gstring">"项目名称_cache"</span></span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"gitlab_repo branch=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"repo_name=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>repo_name<span class="token punctuation">}</span></span>, image_version=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"dockerhub_repo=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"cache_arg=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_arg<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"cache_version=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_version<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n\nbuild_user<span class="token operator">=</span><span class="token string gstring">""</span>\nnode<span class="token punctuation">{</span>\n    <span class="token function">wrap</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">$</span><span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">\'BuildUser\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        build_user <span class="token operator">=</span> env<span class="token operator">.</span>BUILD_USER\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"build_user=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n\ndefault_description <span class="token operator">=</span> <span class="token string gstring">"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>"</span>\ncurrentBuild<span class="token operator">.</span>description <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>default_description<span class="token punctuation">}</span></span>"</span>\n\npipeline <span class="token punctuation">{</span>\n    agent <span class="token punctuation">{</span>\n        node <span class="token punctuation">{</span>\n            label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    environment <span class="token punctuation">{</span>\n        repo_name1 <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>repo_name<span class="token punctuation">}</span></span>"</span>\n        branch_last_name1 <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_last_name<span class="token punctuation">}</span></span>"</span>\n    <span class="token punctuation">}</span>\n\n    stages <span class="token punctuation">{</span>\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Cache Workspace\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        agent <span class="token punctuation">{</span>\n            node <span class="token punctuation">{</span>\n                label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            sh <span class="token string gstring">"""\n<span class="gatsby-highlight-code-line">                cd /home/jenkins/workspace/apps/项目名称/</span><span class="gatsby-highlight-code-line">                # rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'true\' ]</span><span class="gatsby-highlight-code-line">                then</span><span class="gatsby-highlight-code-line">                    if [ ! -d <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span> ]</span><span class="gatsby-highlight-code-line">                    then</span><span class="gatsby-highlight-code-line">                        echo "Cache Workspace not found"</span><span class="gatsby-highlight-code-line">                    else</span><span class="gatsby-highlight-code-line">                        cp -r <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                        cd <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> &amp;&amp; ls</span><span class="gatsby-highlight-code-line">                        echo "Cache Workspace restore successful"</span><span class="gatsby-highlight-code-line">                    fi</span><span class="gatsby-highlight-code-line">                fi</span>            """</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Cache Repo\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        agent <span class="token punctuation">{</span>\n            node <span class="token punctuation">{</span>\n                label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            sh <span class="token string gstring">"""\n<span class="gatsby-highlight-code-line">                # vi clone.sh</span><span class="gatsby-highlight-code-line">                # rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'true\' ]</span><span class="gatsby-highlight-code-line">                then</span><span class="gatsby-highlight-code-line">                    if [ ! -d <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span> ]</span><span class="gatsby-highlight-code-line">                    then</span><span class="gatsby-highlight-code-line">                        echo "Cache Repo not found"</span><span class="gatsby-highlight-code-line">                    else</span><span class="gatsby-highlight-code-line">                        cp -r <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                        cd <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> &amp;&amp; ls</span><span class="gatsby-highlight-code-line">                        echo "Cache Repo restore successful"</span><span class="gatsby-highlight-code-line">                    fi</span><span class="gatsby-highlight-code-line">                fi</span>            """</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string gstring">"Clone Repo"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n          agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span> <span class="token comment">//\'部署机器标签\'</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            sh <span class="token string gstring">"""\n            # ls -la\n            if [ ! -d <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> ]\n            then\n                cp /data/xmotors_ai_shared/sre/saved_repo/clone.sh .\n                bash clone.sh <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>\n            else\n                cd <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>\n                # 1、为了让脚本检测，2、master 拉取最新\n                git checkout master\n                git pull origin master\n\n                if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span> != \'master\' ]\n                then\n<span class="gatsby-highlight-code-line">                    # 强制拉取远程代码到本地</span><span class="gatsby-highlight-code-line">                    git fetch --force origin <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                    git checkout origin/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span></span>                fi\n                cd ..\n            fi\n            # ls -la\n            cp /data/xmotors_ai_shared/sre/saved_repo/judge_has_master_commit.py ./\n            /usr/bin/python3 judge_has_master_commit.py <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> 机器人webhook\n            """</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string gstring">"Scp to build_node"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span> <span class="token comment">//\'部署机器标签\'</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"Scp to <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node_ip<span class="token punctuation">}</span></span>"</span>\n            sh <span class="token string gstring">"""\n                # pwd\n<span class="gatsby-highlight-code-line">                # 这里的 -c 选项比较重要，比较校验和</span><span class="gatsby-highlight-code-line">                rsync -Lrzvc -R <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>/前端目录名称/ jenkins@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node_ip<span class="token punctuation">}</span></span>:/home/jenkins/workspace/apps/项目名称/</span>                if [ \\$? -ne 0 ]\n                then\n                    echo "Found some error when copy the repo"\n                fi\n                # rm -fr <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> || true\n            """</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Build docker images\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n             sh <span class="token string gstring">"""\n                if [ ! -f /home/jenkins/workspace/apps/项目名称/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>/前端目录名称/Dockerfile-client-buildkit ]\n                then\n                    echo "No available 前端目录名称/Dockerfile-client-buildkit in workspace"\n                    exit 1\n                fi\n\n                cd /home/jenkins/workspace/apps/项目名称/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>/前端目录名称/\n                # docker info\n                # docker -v\n                DOCKER_BUILDKIT=1 docker build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_arg<span class="token punctuation">}</span></span> --build-arg=BUILDKIT_CACHE_MOUNT_NS=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_version<span class="token punctuation">}</span></span> -t docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span> -f ./Dockerfile-client-buildkit .\n                # docker build -t docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span> -f ./Dockerfile-client-buildkit .\n                docker push docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>\n                # pwd\n                # ls\n            """</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Post Cache Workspace\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        agent <span class="token punctuation">{</span>\n            node <span class="token punctuation">{</span>\n                label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            sh <span class="token string gstring">"""\n<span class="gatsby-highlight-code-line">                cd /home/jenkins/workspace/apps/项目名称/</span><span class="gatsby-highlight-code-line">                if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'true\' ]</span><span class="gatsby-highlight-code-line">                then</span><span class="gatsby-highlight-code-line">                    rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                    mv <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                    echo \'Post Cache Workspace\'</span><span class="gatsby-highlight-code-line">                else</span><span class="gatsby-highlight-code-line">                    rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                fi</span>            """</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Post Cache Repo\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        agent <span class="token punctuation">{</span>\n            node <span class="token punctuation">{</span>\n                label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            sh <span class="token string gstring">"""\n<span class="gatsby-highlight-code-line">                if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'true\' ]</span><span class="gatsby-highlight-code-line">                then</span><span class="gatsby-highlight-code-line">                    rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                    mv <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                    echo \'Post Cache Repo successful\'</span><span class="gatsby-highlight-code-line">                else</span><span class="gatsby-highlight-code-line">                    rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                fi</span>            """</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    post <span class="token punctuation">{</span>\n        always <span class="token punctuation">{</span>\n            echo <span class="token string">\'I have finished\'</span>\n        <span class="token punctuation">}</span>\n        success <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, succeed!"</span>\n            sh <span class="token string gstring">"""\n            curl -X POST -H "Content-Type: application/json" -d \'{"msg_type":"text","content":{"text":"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> 项目名称 notify: <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, succeed!"}}\' 机器人webhook\n            """</span>\n        <span class="token punctuation">}</span>\n        failure <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, failed!"</span>\n            sh <span class="token string gstring">"""\n            curl -X POST -H "Content-Type: application/json" -d \'{"msg_type":"text","content":{"text":"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> 项目名称 notify: <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, failed!"}}\' 机器人webhook\n            """</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="版本三"><a href="#%E7%89%88%E6%9C%AC%E4%B8%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>版本三</h2>\n<ol>\n<li>缓存步骤并行执行</li>\n<li>对同一机器上的缓存操作时加锁，防止缓存失效</li>\n<li>因为运维那边对应的机器在同一时间执行时会在新的目录里面操作（会生成 <code class="language-text">@2</code>，<code class="language-text">＠3</code> 这样的目录），所以为了防止读不到缓存，需要在连接到机器时强制在同一目录里面操作</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67900896341673730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gitlab_repo = &quot;\\${params.gitlab_repo}&quot;\ndef split = gitlab_repo.split(&quot;/&quot;)\ndef repo_name = split[1]\nbranch_name = &quot;\\${params.branch_name}&quot;\ndef split2 = branch_name.split(&quot;/&quot;)\ndef branch_last_name = split2[split2.length-1]\ndockerhub_repo = &quot;\\${params.dockerhub_repo}&quot;\nparameter = &quot;\\${params.parameter}&quot;\nrepo_url = &quot;仓库地址&quot;\nuse_cache = &quot;\\${params.use_cache}&quot;\ncache_version =&quot;\\${params.cache_version}&quot;\nis_cache_project = &quot;\\${params.is_cache_project}&quot;\n\ndef cache_arg = &quot;&quot;\n\nif (use_cache == \'false\') {\n    cache_arg = &quot;--no-cache&quot;\n}\n\nbuild_node = &quot;\\${params.build_node}&quot;\nbuild_node_ip = \'build机器地址\'\nclone_node = \'部署机器标签\'\n\nimport java.text.SimpleDateFormat;\ndef createVersion() {\n    def dateUnix = ((new Date().time + 22800000) / 1000).intValue()\n    Date dateObj =  new Date( ((long)dateUnix) * 1000 )\n    String ymd = new SimpleDateFormat(&quot;yyMMddHHmmss&quot;).format(dateObj)\n    return &quot;\\${ymd}&quot;\n}\nymd = createVersion()\nimage_version = &quot;1.0.9.\\${ymd}&quot;\n\nwork_dir = &quot;项目名称_\\${ymd}&quot;\nwork_cache_dir = &quot;项目名称_cache&quot;\n\nprintln(&quot;gitlab_repo branch=\\${gitlab_repo} \\${branch_name}&quot;)\nprintln(&quot;repo_name=\\${repo_name}, image_version=\\${image_version}&quot;)\nprintln(&quot;dockerhub_repo=\\${dockerhub_repo}&quot;)\nprintln(&quot;cache_arg=\\${cache_arg}&quot;)\nprintln(&quot;cache_version=\\${cache_version}&quot;)\n\nbuild_user=&quot;&quot;\nnode{\n    wrap([\\$class: \'BuildUser\']) {\n        build_user = env.BUILD_USER\n    }\n}\nprintln(&quot;build_user=\\${build_user}&quot;)\n\ndefault_description = &quot;@\\${build_user} \\${gitlab_repo} \\${branch_name}:\\${image_version}&quot;\ncurrentBuild.description = &quot;\\${default_description}&quot;\n\npipeline {\n    agent {\n        node {\n            label &quot;\\${build_node}&quot;\n        }\n    }\n\n    environment {\n        repo_name1 = &quot;\\${repo_name}&quot;\n        branch_last_name1 = &quot;\\${branch_last_name}&quot;\n    }\n\n    stages {\n      stage (\'Cache\') {\n         failFast true\n         parallel {\n            stage(\'Cache Workspace\') {\n                agent {\n                    node {\n                        label &quot;\\${build_node}&quot;\n                    }\n                }\n                steps {\n                    lock(&quot;lock-cache-workspace&quot;) {\n                    sh &quot;&quot;&quot;\n                        cd /home/jenkins/workspace/apps/项目名称/\n                        # rm -rf \\${work_cache_dir}\n                        if [ \\${is_cache_project} = \'true\' ]\n                        then\n                            if [ ! -d \\${work_cache_dir} ]\n                            then\n                                echo &quot;Cache Workspace not found&quot;\n                            else\n                                cp -r \\${work_cache_dir} \\${work_dir}\n                                cd \\${work_dir} && ls\n                                echo &quot;Cache Workspace restore successful&quot;\n                            fi\n                        fi\n                    &quot;&quot;&quot;\n                    }\n                }\n            }\n\n            stage(\'Cache Repo\') {\n                agent {\n                    node {\n                        label &quot;\\${clone_node}&quot;\n                    }\n                }\n                steps {\n                    lock(&quot;lock-cache-repo&quot;) {\n                    sh &quot;&quot;&quot;\n                        # vi clone.sh\n                        # 这里每次都要 cd 到具体路径，否则同一时间内执行默认会跑到别的目录下，比如 项目名称@2、项目名称@3 这种目录\n                        cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称\n                        # rm -rf \\${work_cache_dir}\n                        if [ \\${is_cache_project} = \'true\' ]\n                        then\n                            if [ ! -d \\${work_cache_dir} ]\n                            then\n                                echo &quot;Cache Repo not found&quot;\n                            else\n                                cp -r \\${work_cache_dir} \\${work_dir}\n                                cd \\${work_dir} && ls\n                                echo &quot;Cache Repo restore successful&quot;\n                            fi\n                        fi\n                    &quot;&quot;&quot;\n                    }\n                }\n            }\n         }\n      }\n\n      stage(&quot;Clone Repo&quot;){\n         agent {\n            node {\n                label &quot;\\${clone_node}&quot; //\'部署机器标签\'\n            }\n         }\n         steps {\n            sh &quot;&quot;&quot;\n            # ls -la\n            cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称\n            if [ ! -d \\${work_dir} ]\n            then\n                cp /data/xmotors_ai_shared/sre/saved_repo/clone.sh .\n                bash clone.sh \\${gitlab_repo} \\${branch_name} \\${work_dir}\n            else\n                cd \\${work_dir}\n                # 1、为了让脚本检测，2、master 拉取最新\n                git checkout master\n                git pull origin master\n\n                if [ \\${branch_name} != \'master\' ]\n                then\n                    # 强制拉取远程代码到本地\n                    git fetch --force origin \\${branch_name}:\\${branch_name}\n                    git checkout origin/\\${branch_name}\n                fi\n                cd ..\n            fi\n            # ls -la\n            cp /data/xmotors_ai_shared/sre/saved_repo/judge_has_master_commit.py ./\n            /usr/bin/python3 judge_has_master_commit.py \\${work_dir} 机器人webhook\n            &quot;&quot;&quot;\n         }\n      }\n\n      stage(&quot;Scp to build_node&quot;) {\n         agent {\n             node {\n                 label &quot;\\${clone_node}&quot; //\'部署机器标签\'\n             }\n         }\n         steps {\n            echo &quot;Scp to \\${build_node}/\\${build_node_ip}&quot;\n            sh &quot;&quot;&quot;\n                cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称\n                # pwd\n                # 这里的 -c 选项比较重要，比较校验和\n                rsync -Lrzvc -R \\${work_dir}/前端目录名称/ jenkins@\\${build_node_ip}:/home/jenkins/workspace/apps/项目名称/\n                if [ \\\\$? -ne 0 ]\n                then\n                    echo &quot;Found some error when copy the repo&quot;\n                fi\n                # rm -fr \\${work_dir} || true\n            &quot;&quot;&quot;\n         }\n      }\n\n      stage(\'Build docker images\') {\n         agent {\n             node {\n                 label &quot;\\${build_node}&quot;\n             }\n         }\n         steps {\n            sh &quot;&quot;&quot;\n                cd /home/jenkins/workspace/apps/项目名称/\\${work_dir}/前端目录名称/\n                if [ ! -f Dockerfile-client-buildkit ]\n                then\n                    echo &quot;No available 前端目录名称/Dockerfile-client-buildkit in workspace&quot;\n                    exit 1\n                fi\n                # docker info\n                # docker -v\n                DOCKER_BUILDKIT=1 docker build \\${cache_arg} --build-arg=BUILDKIT_CACHE_MOUNT_NS=\\${cache_version} -t docker远程仓库地址/\\${dockerhub_repo}:\\${image_version} -f ./Dockerfile-client-buildkit .\n                # docker build -t docker远程仓库地址/\\${dockerhub_repo}:\\${image_version} -f ./Dockerfile-client-buildkit .\n                docker push docker远程仓库地址/\\${dockerhub_repo}:\\${image_version}\n                # pwd\n                # ls\n             &quot;&quot;&quot;\n        }\n      }\n\n      stage (\'Post Cache\') {\n         failFast true\n         parallel {\n            stage(\'Post Cache Workspace\') {\n                agent {\n                    node {\n                        label &quot;\\${build_node}&quot;\n                    }\n                }\n                steps {\n                    lock(&quot;lock-cache-workspace&quot;) {\n                    sh &quot;&quot;&quot;\n                        cd /home/jenkins/workspace/apps/项目名称/\n                        if [ \\${is_cache_project} = \'true\' ]\n                        then\n                            rm -rf \\${work_cache_dir}\n                            mv \\${work_dir} \\${work_cache_dir}\n                            echo \'Post Cache Workspace\'\n                        else\n                            rm -rf \\${work_dir}\n                        fi\n                    &quot;&quot;&quot;\n                    }\n                }\n            }\n\n            stage(\'Post Cache Repo\') {\n                agent {\n                    node {\n                        label &quot;\\${clone_node}&quot;\n                    }\n                }\n                steps {\n                    lock(&quot;lock-cache-repo&quot;) {\n                    sh &quot;&quot;&quot;\n                        cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称\n                        if [ \\${is_cache_project} = \'true\' ]\n                        then\n                            # 加锁的原因: 1.否则 cp 读缓存时没有缓存\n                            rm -rf \\${work_cache_dir}\n                            # 这里存在竞争，后编译成功的重命名才有效，即使后编译的缓存也不太影响具体的增量更新逻辑\n                            # 加锁的原因: 2.同时如果有另一个 job 在 mv 时，这里会移动到 work_cache_dir 目录下，而不是重命名\n                            mv \\${work_dir} \\${work_cache_dir}\n                            echo \'Post Cache Repo successful\'\n                        else\n                            rm -rf \\${work_dir}\n                        fi\n                    &quot;&quot;&quot;\n                    }\n                }\n            }\n         }\n      }\n    }\n\n    post {\n        always {\n            echo \'I have finished\'\n        }\n        success {\n            echo &quot;build \\${gitlab_repo} \\${branch_name}:\\${image_version}, succeed!&quot;\n            sh &quot;&quot;&quot;\n            curl -X POST -H &quot;Content-Type: application/json&quot; -d \'{&quot;msg_type&quot;:&quot;text&quot;,&quot;content&quot;:{&quot;text&quot;:&quot;@\\${build_user} 项目名称 notify: \\${gitlab_repo} \\${branch_name}:\\${image_version}, succeed!&quot;}}\' 机器人webhook\n            &quot;&quot;&quot;\n        }\n        failure {\n            echo &quot;build \\${gitlab_repo} \\${branch_name}:\\${image_version}, failed!&quot;\n            sh &quot;&quot;&quot;\n            curl -X POST -H &quot;Content-Type: application/json&quot; -d \'{&quot;msg_type&quot;:&quot;text&quot;,&quot;content&quot;:{&quot;text&quot;:&quot;@\\${build_user} 项目名称 notify: \\${gitlab_repo} \\${branch_name}:\\${image_version}, failed!&quot;}}\' 机器人webhook\n            &quot;&quot;&quot;\n        }\n    }\n}`, `67900896341673730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="groovy{67-77,79-91,97-104,106-120,137,172,193-194,222-230,245-256}"\n              >\n                <span class="gatsby-code-button-language">groovy{67-77,79-91,97-104,106-120,137,172,193-194,222-230,245-256}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="groovy"><pre style="counter-reset: linenumber NaN" class="language-groovy line-numbers"><code class="language-groovy">gitlab_repo <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>gitlab_repo<span class="token punctuation">}</span></span>"</span>\n<span class="token keyword">def</span> split <span class="token operator">=</span> gitlab_repo<span class="token operator">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string gstring">"/"</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> repo_name <span class="token operator">=</span> split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>\nbranch_name <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>branch_name<span class="token punctuation">}</span></span>"</span>\n<span class="token keyword">def</span> split2 <span class="token operator">=</span> branch_name<span class="token operator">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string gstring">"/"</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> branch_last_name <span class="token operator">=</span> split2<span class="token punctuation">[</span>split2<span class="token operator">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>\ndockerhub_repo <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>dockerhub_repo<span class="token punctuation">}</span></span>"</span>\nparameter <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>parameter<span class="token punctuation">}</span></span>"</span>\nrepo_url <span class="token operator">=</span> <span class="token string gstring">"仓库地址"</span>\nuse_cache <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>use_cache<span class="token punctuation">}</span></span>"</span>\ncache_version <span class="token operator">=</span><span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>cache_version<span class="token punctuation">}</span></span>"</span>\nis_cache_project <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>is_cache_project<span class="token punctuation">}</span></span>"</span>\n\n<span class="token keyword">def</span> cache_arg <span class="token operator">=</span> <span class="token string gstring">""</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>use_cache <span class="token operator">==</span> <span class="token string">\'false\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    cache_arg <span class="token operator">=</span> <span class="token string gstring">"--no-cache"</span>\n<span class="token punctuation">}</span>\n\nbuild_node <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>build_node<span class="token punctuation">}</span></span>"</span>\nbuild_node_ip <span class="token operator">=</span> <span class="token string">\'build机器地址\'</span>\nclone_node <span class="token operator">=</span> <span class="token string">\'部署机器标签\'</span>\n\n<span class="token keyword">import</span> java<span class="token operator">.</span>text<span class="token operator">.</span>SimpleDateFormat<span class="token punctuation">;</span>\n<span class="token keyword">def</span> <span class="token function">createVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">def</span> dateUnix <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span>time <span class="token operator">+</span> <span class="token number">22800000</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    Date dateObj <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>dateUnix<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token punctuation">)</span>\n    String ymd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string gstring">"yyMMddHHmmss"</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">format</span><span class="token punctuation">(</span>dateObj<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span>\n<span class="token punctuation">}</span>\nymd <span class="token operator">=</span> <span class="token function">createVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\nimage_version <span class="token operator">=</span> <span class="token string gstring">"1.0.9.<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span>\n\nwork_dir <span class="token operator">=</span> <span class="token string gstring">"项目名称_<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span>\nwork_cache_dir <span class="token operator">=</span> <span class="token string gstring">"项目名称_cache"</span>\n\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"gitlab_repo branch=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"repo_name=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>repo_name<span class="token punctuation">}</span></span>, image_version=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"dockerhub_repo=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"cache_arg=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_arg<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"cache_version=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_version<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n\nbuild_user<span class="token operator">=</span><span class="token string gstring">""</span>\nnode<span class="token punctuation">{</span>\n    <span class="token function">wrap</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">$</span><span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">\'BuildUser\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        build_user <span class="token operator">=</span> env<span class="token operator">.</span>BUILD_USER\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"build_user=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n\ndefault_description <span class="token operator">=</span> <span class="token string gstring">"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>"</span>\ncurrentBuild<span class="token operator">.</span>description <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>default_description<span class="token punctuation">}</span></span>"</span>\n\npipeline <span class="token punctuation">{</span>\n    agent <span class="token punctuation">{</span>\n        node <span class="token punctuation">{</span>\n            label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    environment <span class="token punctuation">{</span>\n        repo_name1 <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>repo_name<span class="token punctuation">}</span></span>"</span>\n        branch_last_name1 <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_last_name<span class="token punctuation">}</span></span>"</span>\n    <span class="token punctuation">}</span>\n\n    stages <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">      stage <span class="token punctuation">(</span><span class="token string">\'Cache\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">         failFast <span class="token boolean">true</span></span><span class="gatsby-highlight-code-line">         parallel <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">            <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Cache Workspace\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                agent <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                    node <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                        label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span></span><span class="gatsby-highlight-code-line">                    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">                <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">                steps <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token string gstring">"lock-cache-workspace"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>                    sh <span class="token string gstring">"""\n<span class="gatsby-highlight-code-line">                        cd /home/jenkins/workspace/apps/项目名称/</span><span class="gatsby-highlight-code-line">                        # rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                        if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'true\' ]</span><span class="gatsby-highlight-code-line">                        then</span><span class="gatsby-highlight-code-line">                            if [ ! -d <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span> ]</span><span class="gatsby-highlight-code-line">                            then</span><span class="gatsby-highlight-code-line">                                echo "Cache Workspace not found"</span><span class="gatsby-highlight-code-line">                            else</span><span class="gatsby-highlight-code-line">                                cp -r <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                                cd <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> &amp;&amp; ls</span><span class="gatsby-highlight-code-line">                                echo "Cache Workspace restore successful"</span><span class="gatsby-highlight-code-line">                            fi</span><span class="gatsby-highlight-code-line">                        fi</span>                    """</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n\n<span class="gatsby-highlight-code-line">            <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Cache Repo\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                agent <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                    node <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                        label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span></span><span class="gatsby-highlight-code-line">                    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">                <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">                steps <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token string gstring">"lock-cache-repo"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>                    sh <span class="token string gstring">"""\n<span class="gatsby-highlight-code-line">                        # vi clone.sh</span><span class="gatsby-highlight-code-line">                        # 这里每次都要 cd 到具体路径，否则同一时间内执行默认会跑到别的目录下，比如 项目名称@2、项目名称@3 这种目录</span><span class="gatsby-highlight-code-line">                        cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称</span><span class="gatsby-highlight-code-line">                        # rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                        if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'true\' ]</span><span class="gatsby-highlight-code-line">                        then</span><span class="gatsby-highlight-code-line">                            if [ ! -d <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span> ]</span><span class="gatsby-highlight-code-line">                            then</span><span class="gatsby-highlight-code-line">                                echo "Cache Repo not found"</span><span class="gatsby-highlight-code-line">                            else</span><span class="gatsby-highlight-code-line">                                cp -r <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                                cd <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> &amp;&amp; ls</span><span class="gatsby-highlight-code-line">                                echo "Cache Repo restore successful"</span><span class="gatsby-highlight-code-line">                            fi</span><span class="gatsby-highlight-code-line">                        fi</span>                    """</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string gstring">"Clone Repo"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n         agent <span class="token punctuation">{</span>\n            node <span class="token punctuation">{</span>\n                label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span> <span class="token comment">//\'部署机器标签\'</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            sh <span class="token string gstring">"""\n            # ls -la\n<span class="gatsby-highlight-code-line">            cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称</span>            if [ ! -d <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> ]\n            then\n                cp /data/xmotors_ai_shared/sre/saved_repo/clone.sh .\n                bash clone.sh <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>\n            else\n                cd <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>\n                # 1、为了让脚本检测，2、master 拉取最新\n                git checkout master\n                git pull origin master\n\n                if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span> != \'master\' ]\n                then\n                    # 强制拉取远程代码到本地\n                    git fetch --force origin <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>\n                    git checkout origin/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>\n                fi\n                cd ..\n            fi\n            # ls -la\n            cp /data/xmotors_ai_shared/sre/saved_repo/judge_has_master_commit.py ./\n            /usr/bin/python3 judge_has_master_commit.py <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> 机器人webhook\n            """</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string gstring">"Scp to build_node"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span> <span class="token comment">//\'部署机器标签\'</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"Scp to <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node_ip<span class="token punctuation">}</span></span>"</span>\n            sh <span class="token string gstring">"""\n<span class="gatsby-highlight-code-line">                cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称</span>                # pwd\n                # 这里的 -c 选项比较重要，比较校验和\n                rsync -Lrzvc -R <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>/前端目录名称/ jenkins@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node_ip<span class="token punctuation">}</span></span>:/home/jenkins/workspace/apps/项目名称/\n                if [ \\$? -ne 0 ]\n                then\n                    echo "Found some error when copy the repo"\n                fi\n                # rm -fr <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> || true\n            """</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Build docker images\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            sh <span class="token string gstring">"""\n<span class="gatsby-highlight-code-line">                cd /home/jenkins/workspace/apps/项目名称/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>/前端目录名称/</span><span class="gatsby-highlight-code-line">                if [ ! -f Dockerfile-client-buildkit ]</span>                then\n                    echo "No available 前端目录名称/Dockerfile-client-buildkit in workspace"\n                    exit 1\n                fi\n                # docker info\n                # docker -v\n                DOCKER_BUILDKIT=1 docker build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_arg<span class="token punctuation">}</span></span> --build-arg=BUILDKIT_CACHE_MOUNT_NS=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_version<span class="token punctuation">}</span></span> -t docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span> -f ./Dockerfile-client-buildkit .\n                # docker build -t docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span> -f ./Dockerfile-client-buildkit .\n                docker push docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>\n                # pwd\n                # ls\n             """</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      stage <span class="token punctuation">(</span><span class="token string">\'Post Cache\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         failFast <span class="token boolean">true</span>\n         parallel <span class="token punctuation">{</span>\n            <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Post Cache Workspace\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                agent <span class="token punctuation">{</span>\n                    node <span class="token punctuation">{</span>\n                        label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n                steps <span class="token punctuation">{</span>\n                    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token string gstring">"lock-cache-workspace"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    sh <span class="token string gstring">"""\n<span class="gatsby-highlight-code-line">                        cd /home/jenkins/workspace/apps/项目名称/</span><span class="gatsby-highlight-code-line">                        if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'true\' ]</span><span class="gatsby-highlight-code-line">                        then</span><span class="gatsby-highlight-code-line">                            rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                            mv <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                            echo \'Post Cache Workspace\'</span><span class="gatsby-highlight-code-line">                        else</span><span class="gatsby-highlight-code-line">                            rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                        fi</span>                    """</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Post Cache Repo\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                agent <span class="token punctuation">{</span>\n                    node <span class="token punctuation">{</span>\n                        label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n                steps <span class="token punctuation">{</span>\n                    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token string gstring">"lock-cache-repo"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    sh <span class="token string gstring">"""\n<span class="gatsby-highlight-code-line">                        cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称</span><span class="gatsby-highlight-code-line">                        if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'true\' ]</span><span class="gatsby-highlight-code-line">                        then</span><span class="gatsby-highlight-code-line">                            # 加锁的原因: 1.否则 cp 读缓存时没有缓存</span><span class="gatsby-highlight-code-line">                            rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                            # 这里存在竞争，后编译成功的重命名才有效，即使后编译的缓存也不太影响具体的增量更新逻辑</span><span class="gatsby-highlight-code-line">                            # 加锁的原因: 2.同时如果有另一个 job 在 mv 时，这里会移动到 work_cache_dir 目录下，而不是重命名</span><span class="gatsby-highlight-code-line">                            mv <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                            echo \'Post Cache Repo successful\'</span><span class="gatsby-highlight-code-line">                        else</span><span class="gatsby-highlight-code-line">                            rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span></span><span class="gatsby-highlight-code-line">                        fi</span>                    """</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    post <span class="token punctuation">{</span>\n        always <span class="token punctuation">{</span>\n            echo <span class="token string">\'I have finished\'</span>\n        <span class="token punctuation">}</span>\n        success <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, succeed!"</span>\n            sh <span class="token string gstring">"""\n            curl -X POST -H "Content-Type: application/json" -d \'{"msg_type":"text","content":{"text":"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> 项目名称 notify: <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, succeed!"}}\' 机器人webhook\n            """</span>\n        <span class="token punctuation">}</span>\n        failure <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, failed!"</span>\n            sh <span class="token string gstring">"""\n            curl -X POST -H "Content-Type: application/json" -d \'{"msg_type":"text","content":{"text":"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> 项目名称 notify: <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, failed!"}}\' 机器人webhook\n            """</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="版本四"><a href="#%E7%89%88%E6%9C%AC%E5%9B%9B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>版本四</h2>\n<ol>\n<li>生成时间戳优化：因为现有的时间戳是精确到秒的，还是有产生冲突的概率，改成毫秒（更好的方式是生成唯一性的 id）</li>\n<li>修复增量缓存同步策略：由于增量缓存（对远程端的文件不做删除）的问题，比如在同一目录下有 test.js，<code class="language-text">test/index.js</code> 文件，此时引入代码为 <code class="language-text">import &#39;./test&#39;</code>，由于 webpack 有类似 <a href="https://juejin.cn/post/7221551421833314360" target="_blank" rel="nofollow noreferrer noopener">nodejs 路径解析优先级</a> 的问题，此时实际引入的代码为 test.js，但实际上是想用 <code class="language-text">test/index.js</code> 文件，需要修改 rsync 的同步策略</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17701392195702170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gitlab_repo = &quot;\\${params.gitlab_repo}&quot;\ndef split = gitlab_repo.split(&quot;/&quot;)\ndef repo_name = split[1]\nbranch_name = &quot;\\${params.branch_name}&quot;\ndef split2 = branch_name.split(&quot;/&quot;)\ndef branch_last_name = split2[split2.length-1]\ndockerhub_repo = &quot;\\${params.dockerhub_repo}&quot;\nparameter = &quot;\\${params.parameter}&quot;\nrepo_url = &quot;仓库地址&quot;\nuse_cache = &quot;\\${params.use_cache}&quot;\ncache_version =&quot;\\${params.cache_version}&quot;\nis_cache_project = &quot;\\${params.is_cache_project}&quot;\n\ndef cache_arg = &quot;&quot;\n\nif (use_cache == \'false\') {\n    cache_arg = &quot;--no-cache&quot;\n}\n\nbuild_node = &quot;\\${params.build_node}&quot;\nbuild_node_ip = \'build机器地址\'\nclone_node = \'部署机器标签\'\n\ndef createVersion() {\n   long ymd = System.currentTimeMillis()\n   return &quot;\\${ymd}&quot;\n}\nymd = createVersion()\nimage_version = &quot;1.0.9.\\${ymd}&quot;\n\nwork_dir = &quot;项目名称_\\${ymd}&quot;\nwork_cache_dir = &quot;项目名称_cache&quot;\n\nprintln(&quot;gitlab_repo branch=\\${gitlab_repo} \\${branch_name}&quot;)\nprintln(&quot;repo_name=\\${repo_name}, image_version=\\${image_version}&quot;)\nprintln(&quot;dockerhub_repo=\\${dockerhub_repo}&quot;)\nprintln(&quot;cache_arg=\\${cache_arg}&quot;)\nprintln(&quot;cache_version=\\${cache_version}&quot;)\n\nbuild_user=&quot;&quot;\nnode{\n    wrap([\\$class: \'BuildUser\']) {\n        build_user = env.BUILD_USER\n    }\n}\nprintln(&quot;build_user=\\${build_user}&quot;)\n\ndefault_description = &quot;@\\${build_user} \\${gitlab_repo} \\${branch_name}:\\${image_version}&quot;\ncurrentBuild.description = &quot;\\${default_description}&quot;\n\npipeline {\n    agent {\n        node {\n            label &quot;\\${build_node}&quot;\n        }\n    }\n\n    environment {\n        repo_name1 = &quot;\\${repo_name}&quot;\n        branch_last_name1 = &quot;\\${branch_last_name}&quot;\n    }\n\n    stages {\n      stage (\'Cache\') {\n         failFast true\n         parallel {\n            stage(\'Cache Workspace\') {\n                agent {\n                    node {\n                        label &quot;\\${build_node}&quot;\n                    }\n                }\n                steps {\n                    lock(&quot;lock-cache-workspace&quot;) {\n                    sh &quot;&quot;&quot;\n                        cd /home/jenkins/workspace/apps/项目名称/\n                        # rm -rf \\${work_cache_dir}\n                        if [ \\${is_cache_project} = \'true\' ]\n                        then\n                            if [ ! -d \\${work_cache_dir} ]\n                            then\n                                echo &quot;Cache Workspace not found&quot;\n                            else\n                                cp -r \\${work_cache_dir} \\${work_dir}\n                                cd \\${work_dir} && ls\n                                echo &quot;Cache Workspace restore successful&quot;\n                            fi\n                        fi\n                    &quot;&quot;&quot;\n                    }\n                }\n            }\n\n            stage(\'Cache Repo\') {\n                agent {\n                    node {\n                        label &quot;\\${clone_node}&quot;\n                    }\n                }\n                steps {\n                    lock(&quot;lock-cache-repo&quot;) {\n                    sh &quot;&quot;&quot;\n                        # vi clone.sh\n                        # 这里每次都要 cd 到具体路径，否则同一时间内执行默认会跑到别的目录下，比如 项目名称@2、项目名称@3 这种目录\n                        cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称\n                        # rm -rf \\${work_cache_dir}\n                        if [ \\${is_cache_project} = \'true\' ]\n                        then\n                            if [ ! -d \\${work_cache_dir} ]\n                            then\n                                echo &quot;Cache Repo not found&quot;\n                            else\n                                cp -r \\${work_cache_dir} \\${work_dir}\n                                cd \\${work_dir} && ls\n                                echo &quot;Cache Repo restore successful&quot;\n                            fi\n                        fi\n                    &quot;&quot;&quot;\n                    }\n                }\n            }\n         }\n      }\n\n      stage(&quot;Clone Repo&quot;){\n         agent {\n            node {\n                label &quot;\\${clone_node}&quot; //\'部署机器标签\'\n            }\n         }\n         steps {\n            sh &quot;&quot;&quot;\n            # ls -la\n            cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称\n            if [ ! -d \\${work_dir} ]\n            then\n                cp /data/xmotors_ai_shared/sre/saved_repo/clone.sh .\n                bash clone.sh \\${gitlab_repo} \\${branch_name} \\${work_dir}\n            else\n                cd \\${work_dir}\n                # 1、为了让脚本检测，2、master 拉取最新\n                git checkout master\n                git pull origin master\n\n                if [ \\${branch_name} != \'master\' ]\n                then\n                    # 强制拉取远程代码到本地\n                    git fetch --force origin \\${branch_name}:\\${branch_name}\n                    git checkout origin/\\${branch_name}\n                fi\n                cd ..\n            fi\n            # ls -la\n            cp /data/xmotors_ai_shared/sre/saved_repo/judge_has_master_commit.py ./\n            /usr/bin/python3 judge_has_master_commit.py \\${work_dir} 机器人webhook\n            &quot;&quot;&quot;\n         }\n      }\n\n      stage(&quot;Scp to build_node&quot;) {\n         agent {\n             node {\n                 label &quot;\\${clone_node}&quot; //\'部署机器标签\'\n             }\n         }\n         steps {\n            echo &quot;Scp to \\${build_node}/\\${build_node_ip}&quot;\n            sh &quot;&quot;&quot;\n                cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称\n                # pwd\n                # 这里的 -c 选项比较重要，比较校验和\n                rsync -Lrzvc --delete -R \\${work_dir}/前端目录名称/ jenkins@\\${build_node_ip}:/home/jenkins/workspace/apps/项目名称/\n                if [ \\\\$? -ne 0 ]\n                then\n                    echo &quot;Found some error when copy the repo&quot;\n                fi\n                # rm -fr \\${work_dir} || true\n            &quot;&quot;&quot;\n         }\n      }\n\n      stage(\'Build docker images\') {\n         agent {\n             node {\n                 label &quot;\\${build_node}&quot;\n             }\n         }\n         steps {\n            sh &quot;&quot;&quot;\n                cd /home/jenkins/workspace/apps/项目名称/\\${work_dir}/前端目录名称/\n                if [ ! -f Dockerfile-client-buildkit ]\n                then\n                    echo &quot;No available 前端目录名称/Dockerfile-client-buildkit in workspace&quot;\n                    exit 1\n                fi\n                # docker info\n                # docker -v\n                DOCKER_BUILDKIT=1 docker build \\${cache_arg} --build-arg=BUILDKIT_CACHE_MOUNT_NS=\\${cache_version} -t docker远程仓库地址/\\${dockerhub_repo}:\\${image_version} -f ./Dockerfile-client-buildkit .\n                # docker build -t docker远程仓库地址/\\${dockerhub_repo}:\\${image_version} -f ./Dockerfile-client-buildkit .\n                docker push docker远程仓库地址/\\${dockerhub_repo}:\\${image_version}\n                # pwd\n                # ls\n             &quot;&quot;&quot;\n        }\n      }\n\n      stage (\'Post Cache\') {\n         failFast true\n         parallel {\n            stage(\'Post Cache Workspace\') {\n                agent {\n                    node {\n                        label &quot;\\${build_node}&quot;\n                    }\n                }\n                steps {\n                    lock(&quot;lock-cache-workspace&quot;) {\n                    sh &quot;&quot;&quot;\n                        cd /home/jenkins/workspace/apps/项目名称/\n                        if [ \\${is_cache_project} = \'true\' ]\n                        then\n                            rm -rf \\${work_cache_dir}\n                            mv \\${work_dir} \\${work_cache_dir}\n                            echo \'Post Cache Workspace\'\n                        else\n                            rm -rf \\${work_dir}\n                        fi\n                    &quot;&quot;&quot;\n                    }\n                }\n            }\n\n            stage(\'Post Cache Repo\') {\n                agent {\n                    node {\n                        label &quot;\\${clone_node}&quot;\n                    }\n                }\n                steps {\n                    lock(&quot;lock-cache-repo&quot;) {\n                    sh &quot;&quot;&quot;\n                        cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称\n                        if [ \\${is_cache_project} = \'true\' ]\n                        then\n                            # 加锁的原因: 1.否则 cp 读缓存时没有缓存\n                            rm -rf \\${work_cache_dir}\n                            # 这里存在竞争，后编译成功的重命名才有效，即使后编译的缓存也不太影响具体的增量更新逻辑\n                            # 加锁的原因: 2.同时如果有另一个 job 在 mv 时，这里会移动到 work_cache_dir 目录下，而不是重命名\n                            mv \\${work_dir} \\${work_cache_dir}\n                            echo \'Post Cache Repo successful\'\n                        else\n                            rm -rf \\${work_dir}\n                        fi\n                    &quot;&quot;&quot;\n                    }\n                }\n            }\n         }\n      }\n    }\n\n    post {\n        always {\n            echo \'I have finished\'\n        }\n        success {\n            echo &quot;build \\${gitlab_repo} \\${branch_name}:\\${image_version}, succeed!&quot;\n            sh &quot;&quot;&quot;\n            curl -X POST -H &quot;Content-Type: application/json&quot; -d \'{&quot;msg_type&quot;:&quot;text&quot;,&quot;content&quot;:{&quot;text&quot;:&quot;@\\${build_user} 项目名称 notify: \\${gitlab_repo} \\${branch_name}:\\${image_version}, succeed!&quot;}}\' 机器人webhook\n            &quot;&quot;&quot;\n        }\n        failure {\n            echo &quot;build \\${gitlab_repo} \\${branch_name}:\\${image_version}, failed!&quot;\n            sh &quot;&quot;&quot;\n            curl -X POST -H &quot;Content-Type: application/json&quot; -d \'{&quot;msg_type&quot;:&quot;text&quot;,&quot;content&quot;:{&quot;text&quot;:&quot;@\\${build_user} 项目名称 notify: \\${gitlab_repo} \\${branch_name}:\\${image_version}, failed!&quot;}}\' 机器人webhook\n            &quot;&quot;&quot;\n        }\n    }\n}`, `17701392195702170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="groovy{25-26,172}"\n              >\n                <span class="gatsby-code-button-language">groovy{25-26,172}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="groovy"><pre style="counter-reset: linenumber NaN" class="language-groovy line-numbers"><code class="language-groovy">gitlab_repo <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>gitlab_repo<span class="token punctuation">}</span></span>"</span>\n<span class="token keyword">def</span> split <span class="token operator">=</span> gitlab_repo<span class="token operator">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string gstring">"/"</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> repo_name <span class="token operator">=</span> split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>\nbranch_name <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>branch_name<span class="token punctuation">}</span></span>"</span>\n<span class="token keyword">def</span> split2 <span class="token operator">=</span> branch_name<span class="token operator">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string gstring">"/"</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> branch_last_name <span class="token operator">=</span> split2<span class="token punctuation">[</span>split2<span class="token operator">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>\ndockerhub_repo <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>dockerhub_repo<span class="token punctuation">}</span></span>"</span>\nparameter <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>parameter<span class="token punctuation">}</span></span>"</span>\nrepo_url <span class="token operator">=</span> <span class="token string gstring">"仓库地址"</span>\nuse_cache <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>use_cache<span class="token punctuation">}</span></span>"</span>\ncache_version <span class="token operator">=</span><span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>cache_version<span class="token punctuation">}</span></span>"</span>\nis_cache_project <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>is_cache_project<span class="token punctuation">}</span></span>"</span>\n\n<span class="token keyword">def</span> cache_arg <span class="token operator">=</span> <span class="token string gstring">""</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>use_cache <span class="token operator">==</span> <span class="token string">\'false\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    cache_arg <span class="token operator">=</span> <span class="token string gstring">"--no-cache"</span>\n<span class="token punctuation">}</span>\n\nbuild_node <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>params<span class="token operator">.</span>build_node<span class="token punctuation">}</span></span>"</span>\nbuild_node_ip <span class="token operator">=</span> <span class="token string">\'build机器地址\'</span>\nclone_node <span class="token operator">=</span> <span class="token string">\'部署机器标签\'</span>\n\n<span class="token keyword">def</span> <span class="token function">createVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">   <span class="token keyword">long</span> ymd <span class="token operator">=</span> System<span class="token operator">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">   <span class="token keyword">return</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span></span><span class="token punctuation">}</span>\nymd <span class="token operator">=</span> <span class="token function">createVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\nimage_version <span class="token operator">=</span> <span class="token string gstring">"1.0.9.<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span>\n\nwork_dir <span class="token operator">=</span> <span class="token string gstring">"项目名称_<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>ymd<span class="token punctuation">}</span></span>"</span>\nwork_cache_dir <span class="token operator">=</span> <span class="token string gstring">"项目名称_cache"</span>\n\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"gitlab_repo branch=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"repo_name=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>repo_name<span class="token punctuation">}</span></span>, image_version=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"dockerhub_repo=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"cache_arg=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_arg<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"cache_version=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_version<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n\nbuild_user<span class="token operator">=</span><span class="token string gstring">""</span>\nnode<span class="token punctuation">{</span>\n    <span class="token function">wrap</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">$</span><span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">\'BuildUser\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        build_user <span class="token operator">=</span> env<span class="token operator">.</span>BUILD_USER\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token function">println</span><span class="token punctuation">(</span><span class="token string gstring">"build_user=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span>"</span><span class="token punctuation">)</span>\n\ndefault_description <span class="token operator">=</span> <span class="token string gstring">"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>"</span>\ncurrentBuild<span class="token operator">.</span>description <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>default_description<span class="token punctuation">}</span></span>"</span>\n\npipeline <span class="token punctuation">{</span>\n    agent <span class="token punctuation">{</span>\n        node <span class="token punctuation">{</span>\n            label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    environment <span class="token punctuation">{</span>\n        repo_name1 <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>repo_name<span class="token punctuation">}</span></span>"</span>\n        branch_last_name1 <span class="token operator">=</span> <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_last_name<span class="token punctuation">}</span></span>"</span>\n    <span class="token punctuation">}</span>\n\n    stages <span class="token punctuation">{</span>\n      stage <span class="token punctuation">(</span><span class="token string">\'Cache\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         failFast <span class="token boolean">true</span>\n         parallel <span class="token punctuation">{</span>\n            <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Cache Workspace\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                agent <span class="token punctuation">{</span>\n                    node <span class="token punctuation">{</span>\n                        label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n                steps <span class="token punctuation">{</span>\n                    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token string gstring">"lock-cache-workspace"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    sh <span class="token string gstring">"""\n                        cd /home/jenkins/workspace/apps/项目名称/\n                        # rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span>\n                        if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'true\' ]\n                        then\n                            if [ ! -d <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span> ]\n                            then\n                                echo "Cache Workspace not found"\n                            else\n                                cp -r <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>\n                                cd <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> &amp;&amp; ls\n                                echo "Cache Workspace restore successful"\n                            fi\n                        fi\n                    """</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Cache Repo\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                agent <span class="token punctuation">{</span>\n                    node <span class="token punctuation">{</span>\n                        label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n                steps <span class="token punctuation">{</span>\n                    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token string gstring">"lock-cache-repo"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    sh <span class="token string gstring">"""\n                        # vi clone.sh\n                        # 这里每次都要 cd 到具体路径，否则同一时间内执行默认会跑到别的目录下，比如 项目名称@2、项目名称@3 这种目录\n                        cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称\n                        # rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span>\n                        if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'true\' ]\n                        then\n                            if [ ! -d <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span> ]\n                            then\n                                echo "Cache Repo not found"\n                            else\n                                cp -r <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>\n                                cd <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> &amp;&amp; ls\n                                echo "Cache Repo restore successful"\n                            fi\n                        fi\n                    """</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string gstring">"Clone Repo"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n         agent <span class="token punctuation">{</span>\n            node <span class="token punctuation">{</span>\n                label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span> <span class="token comment">//\'部署机器标签\'</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            sh <span class="token string gstring">"""\n            # ls -la\n            cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称\n            if [ ! -d <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> ]\n            then\n                cp /data/xmotors_ai_shared/sre/saved_repo/clone.sh .\n                bash clone.sh <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>\n            else\n                cd <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>\n                # 1、为了让脚本检测，2、master 拉取最新\n                git checkout master\n                git pull origin master\n\n                if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span> != \'master\' ]\n                then\n                    # 强制拉取远程代码到本地\n                    git fetch --force origin <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>\n                    git checkout origin/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>\n                fi\n                cd ..\n            fi\n            # ls -la\n            cp /data/xmotors_ai_shared/sre/saved_repo/judge_has_master_commit.py ./\n            /usr/bin/python3 judge_has_master_commit.py <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> 机器人webhook\n            """</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string gstring">"Scp to build_node"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span> <span class="token comment">//\'部署机器标签\'</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"Scp to <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node_ip<span class="token punctuation">}</span></span>"</span>\n            sh <span class="token string gstring">"""\n                cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称\n                # pwd\n                # 这里的 -c 选项比较重要，比较校验和\n<span class="gatsby-highlight-code-line">                rsync -Lrzvc --delete -R <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>/前端目录名称/ jenkins@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node_ip<span class="token punctuation">}</span></span>:/home/jenkins/workspace/apps/项目名称/</span>                if [ \\$? -ne 0 ]\n                then\n                    echo "Found some error when copy the repo"\n                fi\n                # rm -fr <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> || true\n            """</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Build docker images\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         agent <span class="token punctuation">{</span>\n             node <span class="token punctuation">{</span>\n                 label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n             <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n         steps <span class="token punctuation">{</span>\n            sh <span class="token string gstring">"""\n                cd /home/jenkins/workspace/apps/项目名称/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>/前端目录名称/\n                if [ ! -f Dockerfile-client-buildkit ]\n                then\n                    echo "No available 前端目录名称/Dockerfile-client-buildkit in workspace"\n                    exit 1\n                fi\n                # docker info\n                # docker -v\n                DOCKER_BUILDKIT=1 docker build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_arg<span class="token punctuation">}</span></span> --build-arg=BUILDKIT_CACHE_MOUNT_NS=<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>cache_version<span class="token punctuation">}</span></span> -t docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span> -f ./Dockerfile-client-buildkit .\n                # docker build -t docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span> -f ./Dockerfile-client-buildkit .\n                docker push docker远程仓库地址/<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>dockerhub_repo<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>\n                # pwd\n                # ls\n             """</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      stage <span class="token punctuation">(</span><span class="token string">\'Post Cache\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n         failFast <span class="token boolean">true</span>\n         parallel <span class="token punctuation">{</span>\n            <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Post Cache Workspace\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                agent <span class="token punctuation">{</span>\n                    node <span class="token punctuation">{</span>\n                        label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_node<span class="token punctuation">}</span></span>"</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n                steps <span class="token punctuation">{</span>\n                    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token string gstring">"lock-cache-workspace"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    sh <span class="token string gstring">"""\n                        cd /home/jenkins/workspace/apps/项目名称/\n                        if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'true\' ]\n                        then\n                            rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span>\n                            mv <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span>\n                            echo \'Post Cache Workspace\'\n                        else\n                            rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>\n                        fi\n                    """</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">\'Post Cache Repo\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                agent <span class="token punctuation">{</span>\n                    node <span class="token punctuation">{</span>\n                        label <span class="token string gstring">"<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>clone_node<span class="token punctuation">}</span></span>"</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n                steps <span class="token punctuation">{</span>\n                    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token string gstring">"lock-cache-repo"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    sh <span class="token string gstring">"""\n                        cd /data/xmotors_ai_shared/sre/sre-workspace/workspace/项目名称\n                        if [ <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>is_cache_project<span class="token punctuation">}</span></span> = \'true\' ]\n                        then\n                            # 加锁的原因: 1.否则 cp 读缓存时没有缓存\n                            rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span>\n                            # 这里存在竞争，后编译成功的重命名才有效，即使后编译的缓存也不太影响具体的增量更新逻辑\n                            # 加锁的原因: 2.同时如果有另一个 job 在 mv 时，这里会移动到 work_cache_dir 目录下，而不是重命名\n                            mv <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_cache_dir<span class="token punctuation">}</span></span>\n                            echo \'Post Cache Repo successful\'\n                        else\n                            rm -rf <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>work_dir<span class="token punctuation">}</span></span>\n                        fi\n                    """</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n         <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    post <span class="token punctuation">{</span>\n        always <span class="token punctuation">{</span>\n            echo <span class="token string">\'I have finished\'</span>\n        <span class="token punctuation">}</span>\n        success <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, succeed!"</span>\n            sh <span class="token string gstring">"""\n            curl -X POST -H "Content-Type: application/json" -d \'{"msg_type":"text","content":{"text":"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> 项目名称 notify: <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, succeed!"}}\' 机器人webhook\n            """</span>\n        <span class="token punctuation">}</span>\n        failure <span class="token punctuation">{</span>\n            echo <span class="token string gstring">"build <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, failed!"</span>\n            sh <span class="token string gstring">"""\n            curl -X POST -H "Content-Type: application/json" -d \'{"msg_type":"text","content":{"text":"@<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>build_user<span class="token punctuation">}</span></span> 项目名称 notify: <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>gitlab_repo<span class="token punctuation">}</span></span> <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>branch_name<span class="token punctuation">}</span></span>:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>image_version<span class="token punctuation">}</span></span>, failed!"}}\' 机器人webhook\n            """</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="优化效果"><a href="#%E4%BC%98%E5%8C%96%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化效果</h1>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2023-02-10-12-22-15-7ac385ba83d6c0aba9a041dbf457d491-a9fd5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 32.10937499999999%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABT0lEQVQY0y2QS2+kMBCE+f8/J6e9r7Ta256SzM7wNBAG/MDYxsBgXGlQDqXurk9dajsZuDycs8e+7yDFEAJpx7ZtsJOFMxZGG+oN/OyhhIIeJ0yk09ejhlYao1TkaSTaOBjr4JyLflmgKUBwgUEJFEOFVneoeI1KNviaelSiRsEbZD0jzog/URJnssWX7pEIpf4UTf+PArGua+RKx9UvcIdH6hnY3iGdGfK1QXMMVy2WBvmPqtfJq8tvD46kl/y3kuKvtYae+YpPLqOi84VTeJd3PEyJd3HHp0qROYbPMaU+u+ZT9+mHjxlyVyMZpPjFOX+b5znuIaAbRDz/QnmND1pOXYUPWrzpHIVvcJtyZHTx6d90hoclLh/4T37pWyR5XW5lUSzGmBiOA8q4GPYAFzzyuUa9PZFZdoW1Ybhqsw+oXz2KuQHbuouXS4suCHwDg7DBGXPoU5EAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2023 02 10 12 22 15" title="" data-src="/static/2023-02-10-12-22-15-7ac385ba83d6c0aba9a041dbf457d491-fee1c.png" data-srcset="/static/2023-02-10-12-22-15-7ac385ba83d6c0aba9a041dbf457d491-a67b7.png 200w,\n/static/2023-02-10-12-22-15-7ac385ba83d6c0aba9a041dbf457d491-0b187.png 400w,\n/static/2023-02-10-12-22-15-7ac385ba83d6c0aba9a041dbf457d491-fee1c.png 800w,\n/static/2023-02-10-12-22-15-7ac385ba83d6c0aba9a041dbf457d491-b1a91.png 1200w,\n/static/2023-02-10-12-22-15-7ac385ba83d6c0aba9a041dbf457d491-a9fd5.png 1280w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h1 id="后期展望"><a href="#%E5%90%8E%E6%9C%9F%E5%B1%95%E6%9C%9B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后期展望</h1>\n<ol>\n<li>后端 jenkins 增量构建优化</li>\n<li>gitlab 发布评论触发 jenkins 等环境的一键部署</li>\n<li><a href="https://github.com/towavephone/webpack-lazy-build-demo" target="_blank" rel="nofollow noreferrer noopener">webpack 懒编译</a>，模仿 webpack5 与 vite 的懒编译思路</li>\n<li><a href="https://github.com/i5ting/learn-rust-for-fe" target="_blank" rel="nofollow noreferrer noopener">rust 相关前端工具链</a>，例如 Bun，Next.js，swc，Turbopack</li>\n</ol>',
excerpt:"需求背景 接上文  CRA 项目构建速度优化 由下图可以看出此项目的  ，  耗时较长，需要优化 方案 目前是全量更新，需要改成增量更新 实现 原始版本 版本一 固定使用一个目录为缓存目录，拉取代码和构建代码都在这个缓存目录上 利用 git 和 rsync…",frontmatter:{date:"2023-02-10 12:06:31",path:"/jenkins-build-speed-optimize/",tags:"运维, jenkins, 预研",title:"jenkins 编译速度优化",draft:null}}},pathContext:{mainPostPath:"/cra-project-build-speed-optimize/",nextPostPath:"/international-official-website-technical-difficulties/",prePostPath:"/jenkins-build-speed-optimize/"}}}});